<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>è®°äº‘å—æ¸¸</title>
      <link href="/post/1a435a1d.html"/>
      <url>/post/1a435a1d.html</url>
      
        <content type="html"><![CDATA[<h2 id="äº‘å—ä¹‹æ—…"><a href="#äº‘å—ä¹‹æ—…" class="headerlink" title="äº‘å—ä¹‹æ—…"></a>äº‘å—ä¹‹æ—…</h2><p>ç”Ÿæ´»ä¸æ­¢çœ¼å‰çš„è‹Ÿä¸”ï¼Œè¿˜æœ‰è¯—å’Œè¿œæ–¹ï¼Œæ€»è¦å»ä¸€è¶Ÿäº‘å—å§ å»æœ‰é£ï¼Œæœ‰äº‘ï¼Œæœ‰å±±ï¼Œæœ‰æ¹–ï¼Œæœ‰åŸçš„åœ°æ–¹</p><p>å»çœ‹çœ‹é‚£ç™½äº‘æœµæœµçš„å¤©ç©ºï¼Œ </p><p>å»çœ‹çœ‹é‚£å·å³¨ä¿Šç§€çš„é›ªå±±ï¼Œ</p><p>å»çœ‹çœ‹é‚£æ¾„æ¾ˆé€æ˜çš„æ¹–æ³Šï¼Œ</p><p>å»äº«å—é‚£æ‚ é—²ç¼“æ…¢çš„æ—¥å­ã€‚</p><iframe height=498 width=790 src='https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062318987.mp4' frameborder=0 'allowfullscreen'></iframe><iframe height=498 width=790 src='https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062321606.mp4' frameborder=0 'allowfullscreen'></iframe><h3 id="day-1ï¼šæ˜†æ˜æ»‡æ± "><a href="#day-1ï¼šæ˜†æ˜æ»‡æ± " class="headerlink" title="day 1ï¼šæ˜†æ˜æ»‡æ± "></a>day 1ï¼šæ˜†æ˜æ»‡æ± </h3><p>æ»‡æ± çœ‹æµ·é¸¥ï¼Œå¯ä»¥æ—©æ—©çš„åˆ°æ˜†æ˜ï¼Œç„¶åååœ°é“6å·çº¿-3å·çº¿-5å·çº¿åˆ°å¹¿ç¦è·¯æ‰“è½¦åˆ°æ»‡æ± ï¼Œæ»‡æ± æµ·åŸ‚èŠ±å›­ï¼ˆåŒ—é—¨ï¼‰æ—è¾¹æœ‰è¡Œæå¯„å­˜çš„åœ°æ–¹ ä¸‹è½½ä¸€ä¸ªé€”ç®€å•APPï¼Œå¯„å­˜è¡Œæï¼Œé€›é€›æ»‡æ± ï¼Œçœ‹çœ‹æµ·é¸¥ï¼Œå¹å¹æ»‡æ± çš„é£ï¼Œå¾ˆèˆ’ç•…ï¼Œ</p><p>ä¸‹åˆäº”ç‚¹é«˜é“åˆ°å¤§ç†- å…¥ä½å¤§ç†ï¼Œä»å¤§ç†ç«è½¦ç«™å»ºè®®è‡ªå·±æ‰“è½¦æˆ–è€…åå…¬äº¤ï¼Œ åˆ°å¤§ç†å¤åŸæ‰“è½¦å¿«è½¦ä¸€å£ä»·ä¹Ÿæ‰40å—å·¦å³ </p><h3 id="day-2ï¼šç¯æ¸¸æ´±æµ·"><a href="#day-2ï¼šç¯æ¸¸æ´±æµ·" class="headerlink" title="day 2ï¼šç¯æ¸¸æ´±æµ·"></a>day 2ï¼šç¯æ¸¸æ´±æµ·</h3><blockquote><p>å»ºè®®ï¼š å‡æœŸå……è£•çš„ å»ºè®®æ´±æµ·ä¸¤å¤©ä»¥ä¸Šæ¸¸ï¼Œæ…¢æ…¢çš„é€›ï¼Œä¸€å¤©æµ·ä¸œä¸€å¤©æµ·è¥¿ï¼Œæˆ‘æ˜¯ä¸€å¤©æ¸¸ç©ï¼Œå¥½å¤šåœ°æ–¹æ²¡æœ‰æ‰“åˆ°å¡</p></blockquote><p>ç½‘ä¸Šå¯ä»¥åŒ…è½¦ï¼ˆå°çº¢ä¹¦æˆ–è€…æŠ–éŸ³é‡Œé¢éƒ½æœ‰ åŸºæœ¬ä»·ä½éƒ½æ˜¯300åˆ°400ï¼‰æˆ–è€…ç§Ÿè½¦è‡ªé©¾æ¸¸ï¼Œå¯ä»¥é¡ºæ—¶é’ˆæ²¿æµ· æˆ–è€…é€†æ—¶é’ˆï¼Œé¡ºæ—¶é’ˆæ–¹å‘åœ¨å³ä¾§é“å¼€æ‰€ä»¥å¼€è½¦è·¯ä¸Šçœ‹æ´±æµ·æ¯”è¾ƒæ–¹ä¾¿ï¼Œä½†æ¯”è¾ƒå µè½¦ï¼Œé€†æ—¶é’ˆæ–¹å‘å¥½å¤„å°±æ˜¯ä¸æ€ä¹ˆå µè½¦ï¼Œç”±äºåªæœ‰ä¸€å¤©æ—¶é—´ï¼Œå¯ä»¥é€‰æ‹©é€†æ—¶é’ˆ</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062014985.png" alt="æ´±æµ·ç¯çº¿"></p><ul><li>é¾™é¾›ç å¤´</li></ul><p>æ—©ä¹ï¸é¾™é¾›ç å¤´  æ¸¸ç©å››ååˆ†é’Ÿå·¦å³ æ—¶é—´å……è£•å»ºè®®å¯ä»¥ç§Ÿä¸ªè‡ªè¡Œè½¦éª‘è¡Œ</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304061845099.png" alt="é¾™é¾›ç å¤´"></p><ul><li><strong>ï¸å…´ç››å¤§æ¡¥</strong></li></ul><p>å°±æ˜¯ä¸€ä¸ªç½‘çº¢æ¡¥ æœ‰æ—¶é—´å¯ä»¥æ‹ä¸ªç…§ é¢„è®¡åæ¥åˆ†é’Ÿ</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/%E5%85%B4%E7%9B%9B%E5%A4%A7%E6%A1%A5.jpg" alt="å…´ç››å¤§æ¡¥"></p><ul><li><strong>ç†æƒ³é‚¦</strong></li></ul><p>å°åœ£æ‰˜é‡Œå°¼ï¼Œå¾ˆé€‚åˆæ‹ç…§æ‰“å¡çš„åœ°æ–¹ï¼Œèƒ½å¤Ÿä¿¯ç°æ•´ä¸ªæ´±æµ· ï¼Œä¸€å®šè¦å»ä¸€ä¸‹ï¼Œ æ—¶é—´å……è£•å¯ä»¥å¤šç©ä¼š é¢„è®¡ä¸€å°æ—¶ </p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/%E7%90%86%E6%83%B3%E9%82%A6.jpg" alt="ç†æƒ³é‚¦"></p><ul><li><strong>å°æ™®é™€</strong></li></ul><p>æœ‰ä¸ªå°å²›éœ€è¦ä¹°ç¥¨åç€å°èˆ¹ä¸Šå» ä½†æ˜¯æ²¡æœ‰å¿…è¦  å¯ä»¥åœ¨å²¸è¾¹æ‹ç…§æ‰“å¡  æ¸¸ç©é¢„è®¡åäº”åˆ†é’Ÿ</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/xiaoputuo.jpg" alt="æ´±æµ·-å°æ™®é™€-1"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/xiaoputuo2.jpg" alt="æ´±æµ·-å°æ™®é™€"></p><ul><li><strong>ï¸åŒå»Šå¤é•‡</strong></li></ul><p>ä»å—é—¨è¿›å…¥å ï¼Œå¯ä»¥åé‚®è½®åˆ°å—é‚µé£æƒ…å²›ç© ä½†æ˜¯è¦æ”¶è´¹ä¹°é—¨ç¥¨ï¼Œä¹Ÿå¯ä»¥åªåœ¨åŒå»Šå¤é•‡è½¬è½¬ åœ¨åŒå»Šå¤é•‡å¹¿åœºåƒä¸€é¡¿æ­£å®—çš„è¿‡æ¡¥ç±³çº¿ï¼ˆå°±æ˜¯ä¸€ç‚¹å°è´µ ä½†æ˜¯å‘³é“ä¸é”™ï¼‰ï¼Œå…¶å®åŒå»Šå¤é•‡æŒºå¤§çš„ æœ‰æ—¶é—´å¯ä»¥å¤šç©ä¼š åŒå»Šä¹Ÿæ˜¯å•†ä¸šåŒ–å¾ˆä¸¥é‡ï¼Œéƒ½æ˜¯å•†é“º  åƒé¥­+é€› ç”¨äº†å¿«ä¸¤å°æ—¶å·¦å³  åªèµ°äº†ä¸€åŠ</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062032048.jpg" alt="æ´±æµ·-åŒå»Šå¤é•‡"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/shuanglangguzhen.jpg" alt="æ´±æµ·-åŒå»Šå¤é•‡2"></p><ul><li><strong>ï¸åŒå–œå¤é•‡</strong></li></ul><p>ç¥ä»™å°å§å§åˆ˜äº¦è²æ‹ã€Šå»æœ‰é£çš„åœ°æ–¹ã€‹å–æ™¯åœ°æ–¹ï¼Œä»æ­£é—¨è¿›å…¥åä¸€ç›´ç©å‰èµ°åˆ°è½¬è§’æ¥¼æ‹ç…§æ‰“å¡ï¼Œç„¶åç›´èµ°åˆ°å‰é¢çš„éº¦ç”° ï¼Œéº¦ç”°åœ¨æœ‰é£å¹åŠ¨ä¸‹ å½¢æˆéº¦æµªå¾ˆç¾ åœ¨éº¦ç”°é‡Œé¢æ‹ç…§</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062046966.jpg" alt="å–œæ´²å¤é•‡-è½¬è§’æ¥¼"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062049100.jpg" alt="å–œæ´²å¤é•‡-éº¦ç”°"></p><ul><li><strong>ï¸å»Šæ¡¥</strong></li></ul><p>â€œå»Šæ¡¥â€å…¶å®åˆåˆ«ç§°â€œæƒ…äººæ¡¥â€ï¼Œå¯ä»¥åœ¨æ¡¥æ´é‡Œé¢æ‹ç…§ ç„¶åæ²¿ç€æµ·è¾¹å¾€å—èµ°çœ‹çœ‹å­¤ç‹¬çš„æ ‘ï¼Œä¸€è·¯å¹ç€æµ·é£ï¼Œçœ‹ä¸åˆ°å°½å¤´çš„å‰è¡Œï¼Œäº«å—æ²¿è·¯ä¸åŒæ—¶æ®µçš„é£æ™¯</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062200182.jpg" alt="æ´±æµ·-å»Šæ¡¥"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062201884.jpg" alt="æ´±æµ·-å»Šæ¡¥-æ ‘"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062202098.jpg" alt="æ´±æµ·-å»Šæ¡¥"></p><ul><li><strong>ï¸ç£»æºªSå¼¯</strong></li></ul><p>ç½‘çº¢åœ°æ–¹è¿™é‡Œæœ‰å¾ˆå¤šæ­Œæ‰‹åœ¨è¿™é‡Œå”±æ­Œ ç§Ÿä¸ªå°æ©˜å•è½¦ï¼Œæ²¿ç€æµ·è¾¹éª‘è¡Œ å¾ˆå‡‰çˆ½ å†åˆ°ç½‘çº¢Så¼¯æ‹ç…§ç•™å¿µ </p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062204003.jpg" alt="æ´±æµ·-ï¸ç£»æºªSå¼¯"></p><p>ï¸<img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062205010.jpg" alt="æ´±æµ·-ç£»æºªSå¼¯"></p><ul><li><strong>å¤§ç†å¤åŸ</strong></li></ul><p>æ¸¸ç©ä¸€å¤©å¯èƒ½æœ‰ç‚¹ç´¯ åªåœ¨å—é—¨è½¬äº†ä¸‹ äººæ°‘è·¯ä¹Ÿæ˜¯ç½‘çº¢è·¯ æ²¿é€”æœ‰å„ç§ç¾é£Ÿå’Œé…’å§ äººæ¯”è¾ƒå¤šå¾ˆçƒ­é—¹ å¯ä»¥ç¨å¾®é€›ä¸€ä¸‹ åƒä¸ªé¥­ ç¨ä½œä¼‘æ¯ ä¸€å¤©ç»“æŸ</p><h3 id="day-3ï¼šå¤§ç†å¤åŸ"><a href="#day-3ï¼šå¤§ç†å¤åŸ" class="headerlink" title="day 3ï¼šå¤§ç†å¤åŸ"></a>day 3ï¼šå¤§ç†å¤åŸ</h3><p>æ—©èµ· åˆ°å¤§ç†å¤åŸè½¬ï¼Œä»å¤§ç†å¤åŸå—é—¨åŸæ¥¼è¿›å…¥ï¼Œå¯ä»¥ç™»é™†åŸå¢™ä¸Šä¿¯ç°æ•´ä¸ªå¤§ç†ï¼Œæ‹ç…§ç»ä½³ä½ç½®ï¼Œæ¥å¤§ç†å¤åŸæ¯”æ‰“å¡ä¹‹åœ° ï¼Œæ²¿ç€å—é—¨å¾€å‰æœ‰æ€»ç»Ÿåºœ,äº”è§’æ¥¼ ,æ´‹äººè¡— å¯ä»¥åˆ°äººæ°‘è¡—è½¬å› å¤§ç†å¤åŸä¹ŸæŒºå¤§çš„ å®Œå…¨é€›å®Œé¢„è®¡ä¹Ÿéœ€è¦ä¸‰å››ä¸ªå°æ—¶</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062212977.jpg" alt="å¤§ç†å¤åŸ-å—é—¨æ¥¼"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062213636.jpg" alt="å¤§ç†å¤åŸ"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062215650.jpg" alt="å¤§ç†å¤åŸ-æ´‹äººè¡—"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062216584.jpg" alt="å¤§ç†å¤åŸ"></p><p>å¯ä»¥ä¹°ä¸‹åˆä¸‰ç‚¹å¤šçš„ç½‘çº¢å°ç«è½¦ï¼ŒåŒå±‚ ï¼Œæ˜¯ä»å¤§ç†åˆ°ä¸½æ±Ÿçš„ä¸“åˆ—ç«è½¦æ²¿é€”å¯ä»¥çœ‹åˆ°æ´±æµ· ï¼Œè½¦ç¥¨ä¹Ÿä¾¿å®œ ï¼Œæ—¶é—´å……è£•å¯ä»¥åè¿™ä¸ª</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062221223.jpg" alt="ç«è½¦Y761"></p><p>åˆ°ä¸½æ±Ÿç«™å  ä¸½æ±Ÿè½¦ç«™æ—è¾¹ä¸“é—¨æœ‰ç½‘çº¦è½¦åœé çš„åœ°æ–¹ åœ¨é‚£é‡Œæ‰“å¿«è½¦åˆ°ä¸½æ±Ÿå¤åŸå°±å¯ä»¥  æ‰“è½¦å¾ˆä¾¿å®œ é¢„è®¡20æ¥å—é’±  å¦‚æœè¡Œæä¸å¤šä¹Ÿå¯ä»¥åœ¨å‡ºç«™å£å¯¹é¢åå…¬äº¤ å…¬äº¤é¢„è®¡å››äº”ååˆ†é’Ÿ æ‰“è½¦äºŒåæ¥åˆ†é’Ÿå°±å¯ä»¥åˆ°å¤åŸ å…¥ä½é…’åº—</p><p>ä¸½æ±Ÿé…’åº—å»ºè®®æ˜¯è®¢åœ¨ä¸½æ±Ÿå¤åŸå¤–é¢ ï¼Œï¼Œé‡Œé¢çš„è·¯å¾ˆéš¾èµ°ï¼Œå°¤å…¶æ˜¯æœ‰è¡Œæç®±ğŸ§³ ï¼Œä½å¤–é¢é…’åº—æ¯”è¾ƒå¤š éƒ½æ˜¯é…’åº—çš„æ ‡å‡†  å¦‚æœå–œæ¬¢çƒ­é—¹ä¹Ÿå¯ä»¥ä½å¤åŸé‡Œé¢  åå®¿å®¢æ ˆå¾ˆå¤š åšå¥½å¯¼èˆªğŸ§­</p><h3 id="day-4ï¼šä¸½æ±Ÿå¤åŸ"><a href="#day-4ï¼šä¸½æ±Ÿå¤åŸ" class="headerlink" title="day 4ï¼šä¸½æ±Ÿå¤åŸ"></a>day 4ï¼šä¸½æ±Ÿå¤åŸ</h3><ul><li><strong>ï¸æŸæ²³å¤é•‡</strong></li></ul><p>ç”±äºæ²¡æœ‰æŠ¢åˆ°ç‰é¾™é›ªå±±çš„ç´¢é“é—¨ç¥¨ï¼Œåˆ°ä¸½æ±Ÿçš„ç¬¬ä¸€å¤©å®‰æ’åˆ°ä¸‰å¤§å¤é•‡ç©é¦–ç«™ æ‰“è½¦åˆ°æŸæ²³å¤é•‡ ï¼ˆæ‰“è½¦20æ¥å—é’± å¾ˆè¿‘ï¼‰ä»å—é—¨ä¸€ç›´é€›åˆ°åŒ—é—¨ç„¶åå¯ä»¥æ‰“è½¦æˆ–è€…åå…¬äº¤åˆ°ç™½æ²™å¤é•‡</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062229541.jpg" alt="æŸæ²³å¤é•‡"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062230939.jpg" alt="æŸæ²³å¤é•‡"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062231321.jpg" alt="æŸæ²³å¤é•‡"></p><ul><li><strong>ï¸ç™½æ²™å¤é•‡</strong></li></ul><p>ç¦»ç‰é¾™é›ªå±±æœ€è¿‘çš„ä¸€ä¸ªé•‡ ç«™ä¸‹é¢å¯ä»¥çœ‹åˆ°é›ªå±±ğŸ”ï¸<img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062234572.jpg" alt="ç™½æ²™å¤é•‡"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062234534.jpg" alt="ç™½æ²™å¤é•‡"></p><p>æ‰“å¡ æˆ‘çš„é¦’å¤´æˆ‘çš„è¯— é¢„è®¡ä¸€å°æ—¶é€›å®Œè¿”å›æŸæ²³å¤é•‡ </p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062235874.jpg" alt="ç™½æ²™å¤é•‡-æˆ‘çš„é¦’å¤´æˆ‘çš„è¯—"><strong>ï¸</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062237593.jpg" alt="ç«ç‘°èŠ±é¦’å¤´"></p><p><strong>ä¸½æ±Ÿå¤é•‡</strong> </p><p>ä»æŸæ²³å¤é•‡æŠ˜è¿”å›æ¥ååˆ°ä¸½æ±Ÿå¤é•‡ ä»å¤§æ°´è½¦é—¨å…¥  æ‰“å¡å¤§æ°´è½¦ æ²¿ç€å³æ‰‹åˆ°æ–‡å®˜å›ä¸Šå¯ä»¥ä¿¯ç°ä¸½æ±Ÿ æ‹ç…§çš„å¥½ä½ç½® å†åˆ°å››æ–¹è¡—  æ¨±èŠ±é¤å…</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062240695.jpg" alt="ä¸½æ±Ÿå¤åŸ-å¤§é£è½¦"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062241360.jpg" alt="ä¸½æ±Ÿå¤åŸ"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062247999.jpg" alt="ä¸½æ±Ÿå¤åŸ"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062244052.jpg" alt="ä¸½æ±Ÿå¤åŸ"></p><h3 id="day-5ï¼šç‰é¾™é›ªå±±"><a href="#day-5ï¼šç‰é¾™é›ªå±±" class="headerlink" title="day 5ï¼šç‰é¾™é›ªå±±"></a>day 5ï¼šç‰é¾™é›ªå±±</h3><p>æå‰ä¸€å¤©æ™šä¸Š20:00åœ¨ç½‘ä¸Šé¢„è®¢ç‰é¾™é›ªå±±çš„å†°å·å¤§ç´¢é“ç¥¨ï¼Œå¾ˆéš¾æŠ¢è´­ï¼Œå»ºè®®æå‰å½•å¥½èµ„æ–™åï¼Œå¾…æ•´ç‚¹æ—¶å€™æŠ¢ç¥¨ï¼Œä¸ªäººå»ºè®®æ˜¯é¢„è®¢ä¸‹åˆ13:00-14:00ä¹‹é—´çš„é—¨ç¥¨ï¼Œè¿™æ ·å¯ä»¥çˆ¬å®Œé›ªå±±åæ•¢æœ€åä¸€ç­å…¬äº¤å›åˆ°ä¸½æ±Ÿå¸‚åŒºï¼Œæå‰å‡ºå‘å…ˆå»é€›è“æœˆæ¹–ï¼Œè“æœˆæ¹–å¾ˆç¾ï¼Œæ—©ç‚¹å‡ºå‘å°±å¯ä»¥å¤šç©ä¼šï¼Œç»“æŸåè¿”å›æ¸¸å®¢ä¸­å¿ƒï¼ˆåœè½¦åœº3ï¼‰ç™»å†°å·å¤§ç´¢é“</p><ul><li><strong>è“æœˆæ¹–</strong></li></ul><p>è“æœˆæ¹–åˆ†ä¸ºé•œæ½­æ¹–-è“æœˆæ¹–-ç‰æ¶²æ¹–-å¬æ¶›æ¹–</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062304762.jpg" alt="è“æœˆæ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062305419.jpg" alt="è“æœˆæ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062306041.jpg" alt="è“æœˆæ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062306689.jpg" alt="è“æœˆæ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062307931.jpg" alt="å¬æ¶›æ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062308684.jpg" alt="ç‰æ¶²æ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062308127.jpg" alt="ç‰æ¶²æ¹–"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062311468.jpg" alt="è“æœˆæ¹–"></p><p>ç‰é¾™é›ªå±±</p><p>é€›å®Œè“æœˆæ¹–åæŠ˜è¿”åˆ°å†°å·å¤§ç´¢é“ï¼ˆæå‰å‡†å¤‡å¥½æ°§æ°”+å¤§è¡£ å±±ä¸Šå¾ˆå†·ï¼‰</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062313517.jpg" alt="ç‰é¾™é›ªå±±-å†°å·å¤§ç´¢é“"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062314613.jpg" alt="ç‰é¾™é›ªå±±-å†°å·å¤§ç´¢é“"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062315824.jpg" alt="ç‰é¾™é›ªå±±-å†°å·å¤§ç´¢é“"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062315399.jpg" alt="ç‰é¾™é›ªå±±-4680çŸ³ç¢‘"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062316418.jpg" alt="ç‰é¾™é›ªå±±"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202304062317827.jpg" alt="ç‰é¾™é›ªå±±"></p><h3 id="æ‰“å¡ç¾é£Ÿ"><a href="#æ‰“å¡ç¾é£Ÿ" class="headerlink" title="æ‰“å¡ç¾é£Ÿ"></a>æ‰“å¡ç¾é£Ÿ</h3><p><strong>è¿‡æ¡¥ç±³çº¿</strong></p><p><strong>åŒ…æµ†è±†è…</strong></p><p><strong>è’¸æ±½çŸ³é”…é±¼</strong></p>]]></content>
      
      
      <categories>
          
          <category> ä¸ªäºº </category>
          
      </categories>
      
      
        <tags>
            
            <tag> æ—…æ¸¸ </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteséƒ¨ç½²rabbitmqæœåŠ¡</title>
      <link href="/post/202f1e67.html"/>
      <url>/post/202f1e67.html</url>
      
        <content type="html"><![CDATA[<p>å¾…è¡¥å……ï¼Œå…ˆä¸Šyaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq<br>  namespace: default<br>secrets:<br>- name: rabbitmq<br><br><br><br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: Role<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq-endpoint-reader<br>  namespace: default<br>rules:<br>- apiGroups:<br>  - &quot;&quot;<br>  resources:<br>  - endpoints<br>  verbs:<br>  - get<br>- apiGroups:<br>  - &quot;&quot;<br>  resources:<br>  - events<br>  verbs:<br>  - create<br><br>---<br>apiVersion: rbac.authorization.k8s.io/v1<br>kind: RoleBinding<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq-endpoint-reader<br>  namespace: default<br>roleRef:<br>  apiGroup: rbac.authorization.k8s.io<br>  kind: Role<br>  name: rabbitmq-endpoint-reader<br>subjects:<br>- kind: ServiceAccount<br>  name: rabbitmq<br><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>data:<br>  rabbitmq.conf: |-<br>    ## Username and password<br>    default_user = user<br>    default_pass = CHANGEME<br>    ## Clustering<br>    cluster_formation.peer_discovery_backend  = rabbit_peer_discovery_k8s<br>    cluster_formation.k8s.host = kubernetes.default.svc.cluster.local<br>    cluster_formation.node_cleanup.interval = 10<br>    cluster_formation.node_cleanup.only_log_warning = true<br>    cluster_partition_handling = autoheal<br>    # queue master locator<br>    queue_master_locator = min-masters<br>    # enable guest user<br>    loopback_users.guest = false<br>    #disk_free_limit.absolute = 50MB<br>    #management.load_definitions = /app/load_definition.json<br>kind: ConfigMap<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq-config<br>  namespace: default<br>  <br>---<br>apiVersion: v1<br>data:<br>  rabbitmq-erlang-cookie: b3hWVXpRQmlWWUt4VUR3bWRSbTlDRldseU01Ulg3SzM=<br>  rabbitmq-password: ZGtBU3o5ODZ2ZQ==<br>kind: Secret<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq<br>  namespace: default<br>type: Opaque<br><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq-headless<br>  namespace: default<br>spec:<br>  clusterIP: None<br>  ports:<br>  - name: epmd<br>    port: 4369<br>    targetPort: epmd<br>  - name: amqp<br>    port: 5672<br>    targetPort: amqp<br>  - name: dist<br>    port: 25672<br>    targetPort: dist<br>  - name: stats<br>    port: 15672<br>    targetPort: stats<br>  selector:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/name: rabbitmq<br><br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq<br>  namespace: default<br>spec:<br>  ports:<br>  - name: amqp<br>    nodePort: null<br>    port: 5672<br>    targetPort: amqp<br>  - name: epmd<br>    nodePort: null<br>    port: 4369<br>    targetPort: epmd<br>  - name: dist<br>    nodePort: null<br>    port: 25672<br>    targetPort: dist<br>  - name: http-stats<br>    nodePort: null<br>    port: 15672<br>    targetPort: stats<br>  selector:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/name: rabbitmq<br>  type: ClusterIP<br><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: StatefulSet<br>metadata:<br>  annotations:<br>    meta.helm.sh/release-name: rabbitmq<br>    meta.helm.sh/release-namespace: cjweichen<br>  labels:<br>    app.kubernetes.io/instance: rabbitmq<br>    app.kubernetes.io/managed-by: Helm<br>    app.kubernetes.io/name: rabbitmq<br>    helm.sh/chart: rabbitmq-7.5.7<br>  name: rabbitmq<br>  namespace: default<br>spec:<br>  podManagementPolicy: OrderedReady<br>  replicas: 3<br>  selector:<br>    matchLabels:<br>      app.kubernetes.io/instance: rabbitmq<br>      app.kubernetes.io/name: rabbitmq<br>  serviceName: rabbitmq-headless<br>  template:<br>    metadata:<br>      annotations:<br>        checksum/secret: c3d76de93266cdb4f6a35506a2a5e005e61c7074cd500d28f210e06a6043a0b7<br>      labels:<br>        app.kubernetes.io/instance: rabbitmq<br>        app.kubernetes.io/managed-by: Helm<br>        app.kubernetes.io/name: rabbitmq<br>        helm.sh/chart: rabbitmq-7.5.7<br>    spec:<br>      affinity:<br>        nodeAffinity:<br>          requiredDuringSchedulingIgnoredDuringExecution:<br>            nodeSelectorTerms:<br>            - matchExpressions:<br>              - key: kubernetes.io/hostname<br>                operator: In<br>                values:<br>                - eklet-subnet-fixt567x-ipcmleaw<br>      containers:<br>      - env:<br>        - name: BITNAMI_DEBUG<br>          value: &quot;false&quot;<br>        - name: MY_POD_IP<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: status.podIP<br>        - name: MY_POD_NAME<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.name<br>        - name: MY_POD_NAMESPACE<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.namespace<br>        - name: K8S_SERVICE_NAME<br>          value: rabbitmq-headless<br>        - name: K8S_ADDRESS_TYPE<br>          value: hostname<br>        - name: RABBITMQ_FORCE_BOOT<br>          value: &quot;no&quot;<br>        - name: RABBITMQ_NODE_NAME<br>          value: rabbit@$(MY_POD_NAME).$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.cluster.local<br>        - name: K8S_HOSTNAME_SUFFIX<br>          value: .$(K8S_SERVICE_NAME).$(MY_POD_NAMESPACE).svc.cluster.local<br>        - name: RABBITMQ_MNESIA_DIR<br>          value: /bitnami/rabbitmq/mnesia/$(RABBITMQ_NODE_NAME)<br>        - name: RABBITMQ_LDAP_ENABLE<br>          value: &quot;no&quot;<br>        - name: RABBITMQ_LOGS<br>          value: &#x27;-&#x27;<br>        - name: RABBITMQ_ULIMIT_NOFILES<br>          value: &quot;65536&quot;<br>        - name: RABBITMQ_USE_LONGNAME<br>          value: &quot;true&quot;<br>        - name: RABBITMQ_ERL_COOKIE<br>          valueFrom:<br>            secretKeyRef:<br>              key: rabbitmq-erlang-cookie<br>              name: rabbitmq<br>        - name: RABBITMQ_USERNAME<br>          value: user<br>        - name: RABBITMQ_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              key: rabbitmq-password<br>              name: rabbitmq<br>        - name: RABBITMQ_PLUGINS<br>          value: rabbitmq_management, rabbitmq_peer_discovery_k8s, rabbitmq_auth_backend_ldap<br>        image: ccr.ccs.tencentyun.com/tke-market/rabbitmq:3.8.5-debian-10-r38<br>        imagePullPolicy: IfNotPresent<br>        lifecycle:<br>          preStop:<br>            exec:<br>              command:<br>              - bash<br>              - -ec<br>              - rabbitmqctl stop_app<br>        livenessProbe:<br>          exec:<br>            command:<br>            - /bin/bash<br>            - -ec<br>            - rabbitmq-diagnostics -q check_running<br>          failureThreshold: 6<br>          initialDelaySeconds: 120<br>          periodSeconds: 30<br>          successThreshold: 1<br>          timeoutSeconds: 20<br>        name: rabbitmq<br>        ports:<br>        - containerPort: 5672<br>          name: amqp<br>          protocol: TCP<br>        - containerPort: 25672<br>          name: dist<br>          protocol: TCP<br>        - containerPort: 15672<br>          name: stats<br>          protocol: TCP<br>        - containerPort: 4369<br>          name: epmd<br>          protocol: TCP<br>        readinessProbe:<br>          exec:<br>            command:<br>            - /bin/bash<br>            - -ec<br>            - rabbitmq-diagnostics -q check_running<br>          failureThreshold: 3<br>          initialDelaySeconds: 10<br>          periodSeconds: 30<br>          successThreshold: 1<br>          timeoutSeconds: 20<br>        resources: &#123;&#125;<br>        volumeMounts:<br>        - mountPath: /bitnami/rabbitmq/conf<br>          name: configuration<br>        - mountPath: /bitnami/rabbitmq/mnesia<br>          name: data<br>      dnsPolicy: ClusterFirst<br>      restartPolicy: Always<br>      schedulerName: default-scheduler<br>      securityContext:<br>        fsGroup: 1001<br>        runAsUser: 1001<br>      serviceAccount: rabbitmq<br>      serviceAccountName: rabbitmq<br>      terminationGracePeriodSeconds: 10<br>      volumes:<br>      - configMap:<br>          defaultMode: 420<br>          items:<br>          - key: rabbitmq.conf<br>            path: rabbitmq.conf<br>          name: rabbitmq-config<br>        name: configuration<br>  updateStrategy:<br>    type: RollingUpdate<br>  volumeClaimTemplates:<br>  - apiVersion: v1<br>    kind: PersistentVolumeClaim<br>    metadata:<br>      labels:<br>        app.kubernetes.io/instance: rabbitmq<br>        app.kubernetes.io/name: rabbitmq<br>      name: data<br>    spec:<br>      accessModes:<br>      - ReadWriteOnce<br>      resources:<br>        requests:<br>          storage: 10Gi<br>      storageClassName: cbs<br>      volumeMode: Filesystem<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Rabbitmq </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesä¸­çš„å®¹å™¨æ—¥å¿—è·¯å¾„ç›®å½•</title>
      <link href="/post/c7ce75fa.html"/>
      <url>/post/c7ce75fa.html</url>
      
        <content type="html"><![CDATA[<h2 id="å®¹å™¨æ—¥å¿—æ–‡ä»¶è·¯å¾„"><a href="#å®¹å™¨æ—¥å¿—æ–‡ä»¶è·¯å¾„" class="headerlink" title="å®¹å™¨æ—¥å¿—æ–‡ä»¶è·¯å¾„"></a>å®¹å™¨æ—¥å¿—æ–‡ä»¶è·¯å¾„</h2><p>æœ¬æ–‡å¤§æ¦‚ä»‹ç»kubernetesé›†ç¾¤ä¸­PODå®¹å™¨æ—¥å¿—å­˜å‚¨ä½ç½®åŠæŠŠè¿è¡Œæ—¥å¿—è®°å½•è‡³æ–‡ä»¶ ï¼Œä¸»è¦åŒ…æ‹¬æ ‡å‡†è¾“å‡ºæ—¥å¿—ï¼Œå®¹å™¨å†…æ–‡ä»¶æ—¥å¿—ï¼Œä»¥åŠå…¶ä»–æŒä¹…å·å­˜å‚¨ä½ç½®è·¯å¾„ç­‰ï¼Œä»…ä¾›å‚è€ƒ</p><blockquote><p>ç¯å¢ƒï¼š</p><p>1ï¼ŒTKEé›†ç¾¤</p><p>2ï¼Œå®¹å™¨ç›®å½•å’Œkubeletç›®å½•éƒ½æ˜¯é»˜è®¤é…ç½®</p><p>å£°æ˜ï¼šä»¥ä¸‹ä»…ä¸ªäººç»éªŒæ€»ç»“ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹å‹¿å–·</p></blockquote><h2 id="æ ‡å‡†è¾“å‡º"><a href="#æ ‡å‡†è¾“å‡º" class="headerlink" title="æ ‡å‡†è¾“å‡º"></a>æ ‡å‡†è¾“å‡º</h2><p>å„ç§å®¹å™¨è¿è¡Œæ—¶éƒ½æä¾›äº†å¯¹å®¹å™¨æ ‡å‡†è¾“å‡ºçš„å¤„ç†ã€‚è…¾è®¯äº‘TKEç›®å‰æ”¯æŒä¸¤ç§å®¹å™¨è¿è¡Œæ—¶â€”â€”<strong>docker</strong>å’Œ<strong>containerd</strong>ã€‚</p><p>docker:</p><blockquote><p>çœŸå®è·¯å¾„ï¼š&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;$CONTAINERID<br>è½¯è¿æ¥ï¼škubeletä¼šåœ¨&#x2F;var&#x2F;log&#x2F;podså’Œ&#x2F;var&#x2F;log&#x2F;containersåˆ›å»ºè½¯è¿æ¥æŒ‡å‘&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;$CONTAINERID<br>é…ç½®æ–‡ä»¶ï¼š&#x2F;etc&#x2F;docker&#x2F;daemon.json<br>å‚æ•°ï¼š<br>â€œlog-driverâ€: â€œjson-fileâ€,<br>â€œlog-levelâ€: â€œwarnâ€,<br>â€œlog-optsâ€: {<br> â€œmax-fileâ€: â€œ10â€,<br> â€œmax-sizeâ€: â€œ100mâ€<br>},</p></blockquote><p>containerd :</p><blockquote><p>æ—¥å¿—å­˜å‚¨è·¯å¾„ï¼š<br>çœŸå®è·¯å¾„ï¼š&#x2F;var&#x2F;log&#x2F;pods&#x2F;$CONTAINER_NAMES<br>è½¯è¿æ¥ï¼šåŒæ—¶kubeletä¹Ÿä¼šåœ¨&#x2F;var&#x2F;log&#x2F;containersç›®å½•ä¸‹åˆ›å»ºè½¯é“¾æ¥æŒ‡å‘    &#x2F;var&#x2F;log&#x2F;pods&#x2F;$CONTAINER_NAMES<br>æ—¥å¿—é…ç½®å‚æ•°ï¼š<br>é…ç½®æ–‡ä»¶ï¼š&#x2F;etc&#x2F;kubernetes&#x2F;kubelet<br>kubeleté…ç½®å‚æ•°:<br>â€“container-log-max-files&#x3D;5 <br>â€“container-log-max-size&#x3D;â€œ100Miâ€ <br>â€“logging-format&#x3D;â€œjsonâ€ \</p></blockquote><h3 id="dockerè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—"><a href="#dockerè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—" class="headerlink" title="dockerè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—"></a>dockerè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—</h3><p>å¦‚æœDockerä½œä¸ºK8Så®¹å™¨è¿è¡Œæ—¶ï¼Œå®¹å™¨æ—¥å¿—çš„è½ç›˜å°†ç”±dockeræ¥å®Œæˆï¼Œå¤„ç†çš„æ–¹å¼æ˜¯logging driverï¼Œdockeræ”¯æŒå¤šç§logging driversï¼Œå¯ä»¥å°†æ—¥å¿—ä»¥ç‰¹å®šçš„æ ¼å¼è¾“å‡ºåˆ°ä¸åŒçš„ç›®æ ‡ï¼Œä¿å­˜åœ¨&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;<container-id> ç›®å½•ä¸‹ã€‚Kubelet ä¼šåœ¨ &#x2F;var&#x2F;log&#x2F;pods å’Œ &#x2F;var&#x2F;log&#x2F;containers ä¸‹é¢å»ºç«‹è½¯é“¾æ¥ï¼ŒæŒ‡å‘ &#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;<container-id> è¯¥ç›®å½•ä¸‹çš„å®¹å™¨æ—¥å¿—æ–‡ä»¶</p><p>TKE dockerèŠ‚ç‚¹ä½¿ç”¨çš„logging driveræ˜¯json-fileï¼Œä¼šå°†å®¹å™¨çš„<strong>æ ‡å‡†è¾“å‡º</strong>ä»¥ json çš„æ ¼å¼å†™åˆ°å®¿ä¸»æœºçš„æ–‡ä»¶é‡Œï¼Œæ–‡ä»¶è·¯å¾„ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/var/lib/docker/containers/&lt;container-id&gt;/&lt;container-id&gt;-json.log  <span class="hljs-comment">#å…¶ä¸­å®¹å™¨IDå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥è¯¢</span><br></code></pre></td></tr></table></figure><p>æ‰¹é‡æŸ¥ä¸‹é›†ç¾¤é‡Œé¢å®¹å™¨conatiner IDï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl get pods -o custom-columns=podName:.metadata.name,podIP:.status.podIP,podStatus:.status.phase,nodeName:.spec.nodeName,nodeIP:.status.hostIP,containerID:.status.containerStatuses[0].containerID | awk -F <span class="hljs-string">&#x27;docker://|| containerd://&#x27;</span>  <span class="hljs-string">&#x27;&#123;print $1,$2&#125;&#x27;</span><br></code></pre></td></tr></table></figure><h3 id="containerdè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—"><a href="#containerdè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—" class="headerlink" title="containerdè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—"></a>containerdè¿è¡Œæ—¶æ ‡å‡†è¾“å‡ºæ—¥å¿—</h3><p>å¦‚æœContainerdä½œä¸ºK8 å®¹å™¨è¿è¡Œæ—¶ï¼Œ å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿—çš„è½ç›˜ç”± Kubelet æ¥å®Œæˆï¼Œä¿å­˜è‡³ &#x2F;var&#x2F;log&#x2F;pods ç›®å½•ä¸‹ï¼ŒåŒæ—¶åœ¨ &#x2F;var&#x2F;log&#x2F;containers ç›®å½•ä¸‹åˆ›å»ºè½¯é“¾æ¥ï¼ŒæŒ‡å‘æ—¥å¿—æ–‡ä»¶</p><p>æ–‡ä»¶è·¯å¾„ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/var/log/pods/&lt;namespace&gt;_&lt;pod-name&gt;_&lt;pod-uid&gt;/&lt;container-name&gt;/0.log<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111839189.png" alt="1668063911037"></p><p>æ‰¹é‡æŸ¥è¯¢é›†ç¾¤PODçš„uid</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl get pods -o custom-columns=Namespace:..metadata.namespace,podName:.metadata.name,podIP:.status.podIP,podStatus:.status.phase,nodeIP:.status.hostIP,Pod_ID:.metadata.uid,ContainerName:.spec.containers[*].name<br></code></pre></td></tr></table></figure><h3 id="kubeletå¤„ç†è¿è¡Œæ—¶æ—¥å¿—"><a href="#kubeletå¤„ç†è¿è¡Œæ—¶æ—¥å¿—" class="headerlink" title="kubeletå¤„ç†è¿è¡Œæ—¶æ—¥å¿—"></a>kubeletå¤„ç†è¿è¡Œæ—¶æ—¥å¿—</h3><p>æ— è®ºä½¿ç”¨é‚£ç§å®¹å™¨è¿è¡Œæ—¶ï¼Œkubeletéƒ½ä¼šåœ¨ç›®å½•â€œ&#x2F;var&#x2F;log&#x2F;containersâ€å’Œâ€œ&#x2F;var&#x2F;log&#x2F;podsâ€ä¸‹åˆ›å»ºæŒ‡å‘å®¹å™¨æ ‡å‡†è¾“å‡ºæ—¥å¿—æ–‡ä»¶ï¼ˆç›®å½•ï¼‰çš„è½¯é“¾æ¥ï¼Œæ–‡ä»¶è·¯å¾„å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">/var/log/containers/&lt;pod_name&gt;_&lt;pod_namespace&gt;_&lt;container_name&gt;-&lt;container_id&gt;.log<br><br>/var/log/pods/&lt;namespace&gt;_&lt;pod_name&gt;_&lt;pod_uid&gt;/&lt;container_name&gt;/0.log<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111839400.png" alt="1659871831763"></p><h2 id="å®¹å™¨æ–‡ä»¶è·¯å¾„"><a href="#å®¹å™¨æ–‡ä»¶è·¯å¾„" class="headerlink" title="å®¹å™¨æ–‡ä»¶è·¯å¾„"></a>å®¹å™¨æ–‡ä»¶è·¯å¾„</h2><p>å®¹å™¨ä¸­çš„æ–‡ä»¶è·¯å¾„ï¼Œæ˜¯ç›¸å¯¹äºå®¹å™¨çš„æ–‡ä»¶ç³»ç»Ÿè€Œè¨€ã€‚å®¹å™¨ä¸­çš„æ–‡ä»¶æ—¥å¿—ä¹Ÿæ˜¯è½åœ¨å®¿ä¸»æœºnodeèŠ‚ç‚¹ä¸Šçš„ï¼Œå¯ä»¥é€šè¿‡å®¿ä¸»æœºç›®å½•æŸ¥çœ‹åˆ°å¯¹åº”æ–‡ä»¶ä¿¡æ¯</p><h3 id="æ²¡æœ‰æŒ‚è½½æ•°æ®å·çš„ç›®å½•"><a href="#æ²¡æœ‰æŒ‚è½½æ•°æ®å·çš„ç›®å½•" class="headerlink" title="æ²¡æœ‰æŒ‚è½½æ•°æ®å·çš„ç›®å½•"></a>æ²¡æœ‰æŒ‚è½½æ•°æ®å·çš„ç›®å½•</h3><p>åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå¯ä»¥æ ¹æ®storage driverï¼ˆä¾‹å¦‚ï¼šaufsã€overlay2ï¼‰ä»¥åŠå®¹å™¨è¿è¡Œæ—¶ï¼ˆdockerã€containerdï¼‰ï¼ŒæŸ¥çœ‹å®¹å™¨æ ¹ç›®å½•åœ¨å®¿ä¸»æœºä¸Šçš„æŒ‚è½½ç‚¹ï¼Œå†æ ¹æ®æ—¥å¿—æ–‡ä»¶åœ¨å®¹å™¨æ–‡ä»¶ç³»ç»Ÿä¸­çš„è·¯å¾„ï¼Œæ‰¾åˆ°æ—¥å¿—æ–‡ä»¶åœ¨å®¿ä¸»æœºä¸Šçš„ä½ç½®ã€‚ ç›®å‰TKEèŠ‚ç‚¹ä¸»è¦å®‰è£…çš„æ“ä½œç³»ç»Ÿæ˜¯ubuntuã€CentOSå’Œtlinuxï¼Œä½¿ç”¨çš„storage driverä¸º aufsæˆ–è€…overlay2ã€‚ è·å–å®¹å™¨æ ¹ç›®å½•æŒ‚è½½ç‚¹çš„æ–¹æ³•å¦‚ä¸‹ï¼š</p><h4 id="dockerè¿è¡Œæ—¶"><a href="#dockerè¿è¡Œæ—¶" class="headerlink" title="dockerè¿è¡Œæ—¶"></a>dockerè¿è¡Œæ—¶</h4><table><thead><tr><th align="left"></th><th align="left">å®¹å™¨æ ¹ç›®å½•åœ¨å®¿ä¸»æœºçš„æŒ‚è½½ç‚¹</th><th align="left">å¦‚ä½•æŸ¥çœ‹id</th></tr></thead><tbody><tr><td align="left">aufs</td><td align="left">&#x2F;var&#x2F;lib&#x2F;docker&#x2F;aufs&#x2F;mnt&#x2F;<id></td><td align="left">cat &#x2F;var&#x2F;lib&#x2F;docker&#x2F;image&#x2F;aufs&#x2F;layerdb&#x2F;mounts&#x2F;<container-id>&#x2F;mount-id</td></tr><tr><td align="left">overlay2</td><td align="left">&#x2F;var&#x2F;lib&#x2F;docker&#x2F;overlay2&#x2F;<id>&#x2F;merged</td><td align="left">cat &#x2F;var&#x2F;lib&#x2F;docker&#x2F;image&#x2F;overlay2&#x2F;layerdb&#x2F;mounts&#x2F;<container-id>&#x2F;mount-id</td></tr></tbody></table><p>æŸ¥è¯¢ç¤ºä¾‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-47-tlinux ~]<span class="hljs-comment"># kubectl get pods -o custom-columns=podName:.metadata.name,podIP:.status.podIP,podStatus:.status.phase,nodeName:.spec.nodeName,nodeIP:.status.hostIP,containerID:.status.containerStatuses[0].containerID | awk -F &#x27;docker://|| containerd://&#x27;  &#x27;&#123;print $1,$2&#125;&#x27;   | grep nginx</span><br>nginx-0                         10.200.0.10   Running     172.30.249.47   172.30.249.47    a0d96814caa6248996dcbcea552fa5f405143500f417a764160010018411f368    <span class="hljs-comment">#å®¹å™¨ID</span><br><br>[root@VM-249-47-tlinux ~]<span class="hljs-comment"># cat /var/lib/docker/image/overlay2/layerdb/mounts/a0d96814caa6248996dcbcea552fa5f405143500f417a764160010018411f368/mount-id</span><br>dfdb4b151beca3e68047e748f2832a5acd04161beb4088ca454e7bdf0bdd7aa4<br><br>[root@VM-249-47-tlinux ~]<span class="hljs-comment"># cd /var/lib/docker/overlay2/dfdb4b151beca3e68047e748f2832a5acd04161beb4088ca454e7bdf0bdd7aa4/merged</span><br>[root@VM-249-47-tlinux /var/lib/docker/overlay2/dfdb4b151beca3e68047e748f2832a5acd04161beb4088ca454e7bdf0bdd7aa4/merged]<span class="hljs-comment"># ls </span><br>bin  boot  dev  docker-entrypoint.d  docker-entrypoint.sh  etc  home  lib  lib64  media  mnt  opt  proc  root  run  sbin  srv  sys  tmp  usr  var<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111839568.png" alt="1659872541684"></p><p>å®¹å™¨çš„æ ¹ç›®å½•åœ¨å®¿ä¸»æœºä¸Šçš„æŒ‚è½½ç‚¹</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111839396.png" alt="1659873211290"></p><h4 id="å®¹å™¨çš„å­˜å‚¨IDæ‰¾åˆ°å¯¹åº”çš„å®¹å™¨IDå’Œé•œåƒID"><a href="#å®¹å™¨çš„å­˜å‚¨IDæ‰¾åˆ°å¯¹åº”çš„å®¹å™¨IDå’Œé•œåƒID" class="headerlink" title="å®¹å™¨çš„å­˜å‚¨IDæ‰¾åˆ°å¯¹åº”çš„å®¹å™¨IDå’Œé•œåƒID"></a>å®¹å™¨çš„å­˜å‚¨IDæ‰¾åˆ°å¯¹åº”çš„å®¹å™¨IDå’Œé•œåƒID</h4><p>1ï¼Œè¿›å…¥overlay2ç›®å½•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> /var/lib/docker/overlay2<br><br>å¦‚æœé‡åˆ°æ—¥å¿—å¤„ç†æ—¶å€™å¯ä»¥æŸ¥çœ‹1Gä»¥ä¸Šçš„æ–‡ä»¶å¤§å°ï¼š<span class="hljs-built_in">du</span> -sh * |grep â€˜Gâ€™ | <span class="hljs-built_in">sort</span><br></code></pre></td></tr></table></figure><p>2ï¼ŒæŸ¥çœ‹å ç”¨ç©ºé—´çš„pidï¼Œä»¥åŠå¯¹åº”çš„å®¹å™¨åç§°</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker ps -q | xargs docker inspect --format â€˜&#123;&#123;.State.Pid&#125;&#125;,&#123;&#123;.Name&#125;&#125;,&#123;&#123;.GraphDriver.Data.WorkDir&#125;&#125;â€™ | grep 4d79558c06c01e7b078cf1829676a06f615371953b15b104cb83d94d4f9c2c43<br><br>å¦‚æœè¿è¡Œçš„å®¹å™¨æ²¡æœ‰ï¼Œå¯ä»¥åœ¨é•œåƒé‡Œé¢æŸ¥ä¸‹<br>docker inspect -f $<span class="hljs-string">&#x27;&#123;&#123;.RepoTags&#125;&#125;\t&#123;&#123;.GraphDriver.Data.LowerDir&#125;&#125;&#x27;</span> $(docker images -q)  | grep 4d79558c06c01e7b078cf1829676a06f615371953b15b104cb83d94d4f9c2c43<br></code></pre></td></tr></table></figure><h4 id="containerdè¿è¡Œæ—¶"><a href="#containerdè¿è¡Œæ—¶" class="headerlink" title="containerdè¿è¡Œæ—¶"></a>containerdè¿è¡Œæ—¶</h4><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/run/containerd/io.containerd.runtime.v1.linux/k8s.io/&lt;container-id&gt;/rootfs<br><br>/run/containerd/io.containerd.runtime.v2.task/k8s.io/&lt;container-id&gt;/rootfs  <span class="hljs-comment">#æœ€æ–°containerdè¿è¡Œæ—¶ç›®å½•</span><br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼Œå®¹å™¨æ ¹ç›®å½•åœ¨å®¿ä¸»æœºçš„æŒ‚åœ¨ç‚¹å–å†³äºå®¹å™¨çš„æ ‡è¯†ï¼ˆidæˆ–è€…container-idï¼‰ã€‚</p><blockquote><p> åœ¨é»˜è®¤é…ç½®&#x2F;etc&#x2F;containerd&#x2F;config.toml ä¸­è¿˜æœ‰ä¸¤ä¸ªå…³äºå­˜å‚¨çš„é…ç½®è·¯å¾„ :</p><p> root &#x3D; â€œ&#x2F;var&#x2F;lib&#x2F;containerdâ€ state &#x3D; â€œ&#x2F;run&#x2F;containerdâ€ </p><p> å…¶ä¸­ root æ˜¯ç”¨æ¥ä¿å­˜æŒä¹…åŒ–æ•°æ®ï¼ŒåŒ…æ‹¬ Snapshots, Content, Metadata ä»¥åŠå„ç§æ’ä»¶çš„æ•°æ®ï¼Œæ¯ä¸€ä¸ªæ’ä»¶éƒ½æœ‰è‡ªå·±å•ç‹¬çš„ç›®å½•ï¼ŒContainerd æœ¬èº«ä¸å­˜å‚¨ä»»ä½•æ•°æ®ï¼Œå®ƒçš„æ‰€æœ‰åŠŸèƒ½éƒ½æ¥è‡ªäºå·²åŠ è½½çš„æ’ä»¶ã€‚</p><p> è€Œå¦å¤–çš„ state æ˜¯ç”¨æ¥ä¿å­˜è¿è¡Œæ—¶çš„ä¸´æ—¶æ•°æ®çš„ï¼ŒåŒ…æ‹¬ socketsã€pidã€æŒ‚è½½ç‚¹ã€è¿è¡Œæ—¶çŠ¶æ€ä»¥åŠä¸éœ€è¦æŒä¹…åŒ–çš„æ’ä»¶æ•°æ®ã€‚</p></blockquote><p>åˆ™å®¹å™¨é‡Œé¢çš„æ–‡ä»¶æ—¥å¿—è·¯å¾„ï¼Œå¯ä»¥é€šè¿‡å®¿ä¸»æœºçš„æŒ‚åœ¨ç‚¹è·å–åˆ°ï¼Œ</p><table><thead><tr><th align="left">å®¹å™¨ä¸­è·¯å¾„</th><th align="left">å®¿ä¸»æœºè·¯å¾„(docker + overlay2)</th></tr></thead><tbody><tr><td align="left">&#x2F;data&#x2F;logs&#x2F;nginx.log</td><td align="left">&#x2F;run&#x2F;containerd&#x2F;io.containerd.runtime.v2.task&#x2F;k8s.io&#x2F;0b895cd3a0fb017337df1796530904b0185db7469f442b9413333f4c8c878fee&#x2F;rootfs&#x2F;data&#x2F;logs&#x2F;test.log</td></tr></tbody></table><h3 id="æŒ‚è½½æ•°æ®å·çš„ç›®å½•æ—¥å¿—"><a href="#æŒ‚è½½æ•°æ®å·çš„ç›®å½•æ—¥å¿—" class="headerlink" title="æŒ‚è½½æ•°æ®å·çš„ç›®å½•æ—¥å¿—"></a>æŒ‚è½½æ•°æ®å·çš„ç›®å½•æ—¥å¿—</h3><p>TKEæ”¯æŒä»¥ä¸‹å‡ ç§æŒ‚è½½å·ç±»å‹</p><h4 id="hostpath"><a href="#hostpath" class="headerlink" title="hostpath"></a>hostpath</h4><p>hostpathçš„å¤„ç†æ¯”è¾ƒç®€å•ï¼Œç›´æ¥æŸ¥çœ‹PODæ‰€åœ¨èŠ‚ç‚¹çš„æŒ‚è½½è·¯å¾„æ—¥å¿—</p><h4 id="emptyDir"><a href="#emptyDir" class="headerlink" title="emptyDir"></a>emptyDir</h4><p>emptyDirå·åœ¨å®¿ä¸»æœºä¸Šçš„è·¯å¾„ä¸º:</p><p>kubelet root-dirçš„é»˜è®¤å€¼ï¼š&#x2F;var&#x2F;lib&#x2F;kubelet</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">&lt;kubelet root-dir&gt;/pods/&lt;pod uid&gt;/volumes/kubernetes.io~empty-dir/&lt;volume name&gt;<br></code></pre></td></tr></table></figure><h4 id="è…¾è®¯äº‘CBS-x2F-CFS"><a href="#è…¾è®¯äº‘CBS-x2F-CFS" class="headerlink" title="è…¾è®¯äº‘CBS&#x2F;CFS"></a>è…¾è®¯äº‘CBS&#x2F;CFS</h4><p>cbsæŒä¹…åŒ–å·åœ¨å®¿ä¸»æœºä¸Šçš„è·¯å¾„ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#&lt;kubelet root-dir&gt;/pods/&lt;pod uid&gt;/volumes/kubernetes.io~qcloud-cbs/&lt;volume name&gt;/mount  #qcloud-cbsç±»å‹çš„CBS</span><br><br><span class="hljs-comment">#containerèŠ‚ç‚¹å’Œdockerè¿è¡ŒèŠ‚ç‚¹ä¸€æ ·</span><br><span class="hljs-comment"># &lt;kubelet root-dir&gt;/plugins/kubernetes.io/csi/pv/&lt;pvc-name&gt;/globalmount    #cbs-csiç±»å‹çš„CBS</span><br>/var/lib/kubelet/plugins/kubernetes.io/csi/pv/pvc-a8c018b1-6e93-41e2-b620-9585d46d3619/globalmount<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111941327.png" alt="image-20221211194126209"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111951177.png" alt="image-20221211195129123"></p><p>cfsæŒä¹…åŒ–å·åœ¨å®¿ä¸»æœºä¸Šçš„è·¯å¾„ä¸ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#&lt;kubelet root-dir&gt;/pods/&lt;pod uid&gt;/volumes/kubernetes.io~csi/&lt;pv name&gt;/mount</span><br><br>/var/lib/kubelet/pods/4f65675c-ead4-4d75-b1b9-89784a332cf4/volumes/kubernetes.io~csi/pvc-24b1a5c5-f59a-4c5e-8ea8-bad84bacf9df/mount<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212112003529.png" alt="image-20221211200303472"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212112004478.png" alt="image-20221211200418423"></p><blockquote><p>éªŒè¯ï¼Œå¦‚æœæ˜¯ä¸€ä¸ªCFSç±»å‹çš„PVCæŒ‚è½½ä¸åŒçš„PODä¸Šï¼ŒèŠ‚ç‚¹ä¸Šåªæœ‰ä¸€ä¸ªæŒ‚è½½ç‚¹ï¼Œ</p></blockquote>]]></content>
      
      
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesä¸­çš„cgroup Killedé—®é¢˜</title>
      <link href="/post/dcec15df.html"/>
      <url>/post/dcec15df.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>ç¯å¢ƒï¼š</p><p>1ï¼Œè…¾è®¯äº‘TKEé›†ç¾¤</p><p>2ï¼ŒCVMèŠ‚ç‚¹ å†…æ ¸ï¼štlinux 4.14.105-19-0024</p><p>3ï¼Œå®¹å™¨ç›®å½•å’Œkubeletç›®å½•é»˜è®¤è®¾ç½®</p></blockquote><p><strong>Cgroup OOMåŸå› </strong></p><p>ä¸€èˆ¬æ˜¯ç”±äºå®¹å™¨çš„å†…å­˜å®é™…ä½¿ç”¨é‡è¶…è¿‡äº†å®¹å™¨å†…å­˜é™åˆ¶å€¼limitè€Œå¯¼è‡´çš„äº‹ä»¶ã€‚æ¯”å¦‚å®¹å™¨çš„å†…å­˜é™åˆ¶å€¼é…ç½®äº†1Giï¼Œè€Œå®¹å™¨çš„å†…å­˜éšç€å®¹å™¨å†…è¿›ç¨‹å†…å­˜ä½¿ç”¨é‡çš„å¢åŠ è¶…è¿‡äº†1Giï¼Œå°±ä¼šå¯¼è‡´å®¹å™¨è¢«æ“ä½œç³»ç»ŸCgroup Killã€‚å‘ç”Ÿå®¹å™¨è¢«Killä¹‹åï¼Œå®¹å™¨å·²ç»è¢«åœæ­¢ï¼Œæ‰€ä»¥åç»­ä¼šå‡ºç°åº”ç”¨å®ä¾‹è¢«é‡å¯çš„æƒ…å†µ</p><p><strong>è§£å†³æ–¹æ¡ˆ</strong></p><p>æ£€æŸ¥å®¹å™¨å†…è¿›ç¨‹æ˜¯å¦æœ‰å†…å­˜æ³„æ¼é—®é¢˜ï¼ŒåŒæ—¶é€‚å½“è°ƒæ•´å®¹å™¨å†…å­˜çš„é™åˆ¶å€¼limitå¤§å°ã€‚å¯ä»¥ç»“åˆåº”ç”¨ç›‘æ§æ¥çœ‹å˜åŒ–è¶‹åŠ¿ã€‚éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œå®¹å™¨å†…å­˜é™åˆ¶å€¼å¤§å°ä¸åº”è¯¥è¿‡å¤§ï¼Œå¦åˆ™å¯èƒ½å¯¼è‡´æç«¯èµ„æºäº‰æŠ¢æƒ…å†µä¸‹ï¼Œå®¹å™¨è¢«è¿«é©±é€çš„é—®é¢˜ã€‚ </p><p><strong>oom score</strong></p><p>åœ¨é‡åˆ°è¾ƒé«˜å†…å­˜ä½¿ç”¨å‹åŠ›æ—¶ï¼ŒLinux å†…æ ¸ä¼šæ€æ‰ä¸€äº›ä¸å¤ªé‡è¦çš„è¿›ç¨‹ï¼Œè…¾å‡ºç©ºé—´ä¿éšœç³»ç»Ÿæ­£å¸¸è¿è¡Œã€‚å®ƒä¼šç»™æ¯ä¸ªè¿›ç¨‹ï¼ˆ<code>/proc/$pid/oom_score</code>ï¼‰åˆ†é…ä¸€ä¸ªå¾—åˆ†ï¼ˆ<code>oom_score</code>ï¼‰ï¼Œåˆ†æ•°è¶Šé«˜ï¼Œè¢« OOM çš„æ¦‚ç‡å°±è¶Šå¤§ã€‚ <strong>è¿™ä¸ªå‚æ•°æœ¬èº«åªåæ˜ è¯¥è¿›ç¨‹çš„å¯ç”¨èµ„æºåœ¨ç³»ç»Ÿä¸­æ‰€å çš„ç™¾åˆ†æ¯”ï¼Œå¹¶æ²¡æœ‰â€œè¯¥è¿›ç¨‹æœ‰å¤šé‡è¦â€çš„æ¦‚å¿µ</strong> </p><p>åœ¨kubernetesä¸­å„ä¸ªPODä¹‹é—´èµ„æºæ˜¯é€šè¿‡cgroupè¿›è¡Œèµ„æºéš”ç¦»ï¼ŒæŸ¥çœ‹POD cgroupç›¸å…³ä¿¡æ¯ï¼Œç™»å½•PODæ‰€åœ¨èŠ‚ç‚¹ï¼Œæ‰§è¡Œ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span>  /sys/fs/cgroup/memory/kubepods/burstable/pod[podçš„uuid]    <span class="hljs-comment">#uuidå¯ä»¥é€šè¿‡ä¸‹é¢å‘½ä»¤æŸ¥è¯¢</span><br><br>ç¤ºä¾‹ï¼š<br><span class="hljs-built_in">cd</span> /sys/fs/cgroup/memory/kubepods/burstable/pod7b5d76c8-a37b-4f1c-8db9-383017063244<br></code></pre></td></tr></table></figure><p>æŸ¥ä¸‹é›†ç¾¤PODçš„uuidï¼ˆæ ¹æ®å…·ä½“æƒ…å†µå¯ä»¥æ ¹æ®å‘½åç©ºé—´æŸ¥è¯¢ï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl get pods -o custom-columns=Namespace:..metadata.namespace,podName:.metadata.name,podIP:.status.podIP,podStatus:.status.phase,nodeIP:.status.hostIP,Pod_ID:.metadata.uid,ContainerName:.spec.containers[*].name<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111709485.png" alt="1668051091904"></p><p>å½“PODå‘ç”ŸOOMæ—¶å€™ï¼Œå¯ä»¥æŸ¥çœ‹dmesgæ—¥å¿—ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">dmesg  | grep -A  20  7b5d76c8-a37b-4f1c-8db9-38301706324<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202212111710803.png" alt="1668051203724"></p><p><strong>å¦‚ä½•é€šè¿‡oom killæ—¥å¿—åæŸ¥å¯¹åº”çš„å®¹å™¨</strong></p><p>é€šè¿‡dmesgæ—¥å¿—æŸ¥åˆ° æœ‰å¦‚ä¸‹oom ä¿¡æ¯ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">dmesg  | grep -A  20 -i  killed<br></code></pre></td></tr></table></figure><p>æ—¥å¿—å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[198542.576728] Task <span class="hljs-keyword">in</span> /kubepods/burstable/pod0f5eb28f-6722-4cf5-ab0f-b62748c018d4/0dc1822caf9e150de25daa1cf572418426ce6b72757b5efdff52acef348368a3 killed as a result of <span class="hljs-built_in">limit</span> of /kubepods/burstable/pod0f5eb28f-6722-4cf5-ab0f-b62748c018d4<br>[198542.576733] memory: usage 122880kB, <span class="hljs-built_in">limit</span> 122880kB, failcnt 83<br>[198542.576734] memory+swap: usage 122880kB, <span class="hljs-built_in">limit</span> 9007199254740988kB, failcnt 0<br>[198542.576734] kmem: usage 0kB, <span class="hljs-built_in">limit</span> 9007199254740988kB, failcnt 0<br>[198542.576735] Memory cgroup stats <span class="hljs-keyword">for</span> /kubepods/burstable/pod0f5eb28f-6722-4cf5-ab0f-b62748c018d4: cache:0KB rss:0KB rss_huge:0KB shmem:0KB mapped_file:0KB dirty:0KB writeback:0KB swap:0KB inactive_anon:0KB active_anon:0KB inactive_file:0KB active_file:0KB unevictable:0KB<br></code></pre></td></tr></table></figure><p>å¯ä»¥æŸ¥åˆ°PODçš„uuidï¼š0f5eb28f-6722-4cf5-ab0f-b62748c018d4</p><p>é€šè¿‡kubelet æ—¥å¿—æˆ–è€…messageæ—¥å¿—è¿‡æ»¤è¯¥uid</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">journalctl -u kubelet | grep <span class="hljs-string">&quot;0f5eb28f-6722-4cf5-ab0f-b62748c018d4&quot;</span> <span class="hljs-comment">#POD uuid</span><br></code></pre></td></tr></table></figure><p>æ—¥å¿—å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°å…·ä½“PODä¿¡æ¯ åŒ…æ‹¬PODåç§°å’Œæ‰€åœ¨namespace</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">Dec 11 17:29:21 VM-249-96-tlinux kubelet[10264]: E1211 17:29:21.519957   10264 pod_workers.go:191] Error syncing pod 0f5eb28f-6722-4cf5-ab0f-b62748c018d4 (<span class="hljs-string">&quot;memory-request-limit-54ff657644-wm7pj_default(0f5eb28f-6722-4cf5-ab0f-b62748c018d4)&quot;</span>), skipping: failed to <span class="hljs-string">&quot;StartContainer&quot;</span> <span class="hljs-keyword">for</span> <span class="hljs-string">&quot;memory-demo-ctr&quot;</span> with CrashLoopBackOff: <span class="hljs-string">&quot;back-off 5m0s restarting failed container=memory-demo-ctr pod=memory-request-limit-54ff657644-wm7pj_default(0f5eb28f-6722-4cf5-ab0f-b62748c018d4)&quot;</span><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>é€šè¿‡ç¯å¢ƒå˜é‡å°†PODä¿¡æ¯å‘ˆç°ç»™å®¹å™¨</title>
      <link href="/post/6c58efa9.html"/>
      <url>/post/6c58efa9.html</url>
      
        <content type="html"><![CDATA[<p>æœ¬æ–‡é€šè¿‡ç¯å¢ƒå˜é‡å°† Pod ä¿¡æ¯å‘ˆç°ç»™å®¹å™¨</p><h2 id="ç”¨-Pod-å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼"><a href="#ç”¨-Pod-å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼" class="headerlink" title="ç”¨ Pod å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼"></a>ç”¨ Pod å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼</h2><p>è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°äº”ä¸ªç¯å¢ƒå˜é‡ã€‚<code>env</code> å­—æ®µæ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#envvar-v1-core">EnvVars</a>. å¯¹è±¡çš„æ•°ç»„ã€‚ æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æŒ‡å®š <code>MY_NODE_NAME</code> è¿™ä¸ªç¯å¢ƒå˜é‡ä» Pod çš„ <code>spec.nodeName</code> å­—æ®µè·å–å˜é‡å€¼ã€‚ åŒæ ·ï¼Œå…¶å®ƒç¯å¢ƒå˜é‡ä¹Ÿæ˜¯ä» Pod çš„å­—æ®µè·å–å®ƒä»¬çš„å˜é‡å€¼ã€‚</p><p><strong>è¯´æ˜ï¼š</strong> æœ¬ç¤ºä¾‹ä¸­çš„å­—æ®µæ˜¯ Pod å­—æ®µï¼Œä¸æ˜¯ Pod ä¸­ Container çš„å­—æ®µã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: dapi-envars-fieldref<br>  name: dapi-envars-fieldref<br>  namespace: default<br>spec:<br>  selector:<br>    matchLabels:<br>      k8s-app: dapi-envars-fieldref<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: dapi-envars-fieldref<br>    spec:<br>      containers:<br>      - args:<br>        - while true; do echo -en &#x27;\n&#x27;; printenv MY_NODE_NAME MY_POD_NAME MY_POD_NAMESPACE; printenv MY_POD_IP MY_POD_SERVICE_ACCOUNT; sleep 10;done;<br>        command:<br>        - sh<br>        - -c<br>        env:<br>        - name: MY_NODE_NAME<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: spec.nodeName<br>        - name: MY_POD_NAME<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.name<br>        - name: MY_POD_NAMESPACE<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.namespace<br>        - name: MY_POD_IP<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: status.podIPs<br>        - name: MY_POD_SERVICE_ACCOUNT<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: spec.serviceAccountName<br>        image: busybox<br>        imagePullPolicy: IfNotPresent<br>        name: dapi-envars-fieldref<br>        resources: &#123;&#125;<br><br></code></pre></td></tr></table></figure><h2 id="ç”¨-Container-å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼"><a href="#ç”¨-Container-å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼" class="headerlink" title="ç”¨ Container å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼"></a>ç”¨ Container å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼</h2><p>å‰é¢çš„ç»ƒä¹ ä¸­ï¼Œä½ å°† Pod å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼ã€‚ æ¥ä¸‹æ¥è¿™ä¸ªç»ƒä¹ ä¸­ï¼Œä½ å°†ç”¨ Container å­—æ®µä½œä¸ºç¯å¢ƒå˜é‡çš„å€¼ã€‚è¿™é‡Œæ˜¯åŒ…å«ä¸€ä¸ªå®¹å™¨çš„ Pod çš„é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: dapi-envars-container<br>  name: dapi-envars-container<br>  namespace: default<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      k8s-app: dapi-envars-container<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: dapi-envars-container<br>    spec:<br>      containers:<br>      - args:<br>        - while true; do  echo -en &#x27;\n&#x27;; printenv MY_CPU_REQUEST MY_CPU_LIMIT;printenv MY_MEM_REQUEST MY_MEM_LIMIT;sleep 10;done;<br>        command:<br>        - sh<br>        - -c<br>        env:<br>        - name: MY_CPU_REQUEST<br>          valueFrom:<br>            resourceFieldRef:<br>              containerName: test-container<br>              divisor: &quot;1&quot;<br>              resource: requests.cpu<br>        - name: MY_CPU_LIMIT<br>          valueFrom:<br>            resourceFieldRef:<br>              containerName: test-container<br>              divisor: &quot;1&quot;<br>              resource: limits.cpu<br>        - name: MY_MEM_REQUEST<br>          valueFrom:<br>            resourceFieldRef:<br>              containerName: test-container<br>              divisor: &quot;1&quot;<br>              resource: requests.memory<br>        - name: MY_MEM_LIMIT<br>          valueFrom:<br>            resourceFieldRef:<br>              containerName: test-container<br>              divisor: &quot;1&quot;<br>              resource: limits.memory<br>        image: busybox:1.24<br>        imagePullPolicy: IfNotPresent<br>        name: test-container<br>        resources:<br>          limits:<br>            cpu: 200m<br>            memory: 128Mi<br>          requests:<br>            cpu: 100m<br>            memory: 64Mi<br><br><br></code></pre></td></tr></table></figure><p>è¿™ä¸ªé…ç½®æ–‡ä»¶ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å››ä¸ªç¯å¢ƒå˜é‡ã€‚<code>env</code> å­—æ®µæ˜¯ä¸€ä¸ª <a href="https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.22/#envvar-v1-core">EnvVars</a>. å¯¹è±¡çš„æ•°ç»„ã€‚æ•°ç»„ä¸­ç¬¬ä¸€ä¸ªå…ƒç´ æŒ‡å®š <code>MY_CPU_REQUEST</code> è¿™ä¸ªç¯å¢ƒå˜é‡ä» Container çš„ <code>requests.cpu</code> å­—æ®µè·å–å˜é‡å€¼ã€‚åŒæ ·ï¼Œå…¶å®ƒç¯å¢ƒå˜é‡ä¹Ÿæ˜¯ä» Container çš„å­—æ®µè·å–å®ƒä»¬çš„å˜é‡å€¼ã€‚</p><p><strong>è¯´æ˜ï¼š</strong> æœ¬ä¾‹ä¸­ä½¿ç”¨çš„æ˜¯ Container çš„å­—æ®µè€Œä¸æ˜¯ Pod çš„å­—æ®µã€‚</p><h2 id="é€šè¿‡æ–‡ä»¶å°†-Pod-ä¿¡æ¯å‘ˆç°ç»™å®¹å™¨"><a href="#é€šè¿‡æ–‡ä»¶å°†-Pod-ä¿¡æ¯å‘ˆç°ç»™å®¹å™¨" class="headerlink" title="é€šè¿‡æ–‡ä»¶å°† Pod ä¿¡æ¯å‘ˆç°ç»™å®¹å™¨"></a>é€šè¿‡æ–‡ä»¶å°† Pod ä¿¡æ¯å‘ˆç°ç»™å®¹å™¨</h2><p>æ­¤é¡µé¢æè¿° Pod å¦‚ä½•ä½¿ç”¨ DownwardAPIVolumeFile æŠŠè‡ªå·±çš„ä¿¡æ¯å‘ˆç°ç»™ Pod ä¸­è¿è¡Œçš„å®¹å™¨ã€‚ DownwardAPIVolumeFile å¯ä»¥å‘ˆç° Pod çš„å­—æ®µå’Œå®¹å™¨å­—æ®µ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: kubernetes-downwardapi-volume-example<br>  name: kubernetes-downwardapi-volume-example<br>  namespace: default<br>spec:<br>  selector:<br>    matchLabels:<br>      k8s-app: kubernetes-downwardapi-volume-example<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: kubernetes-downwardapi-volume-example<br>    spec:<br>      containers:<br>      - args:<br>        - while true; do if [[ -e /etc/podinfo/labels ]]; then  echo -en &#x27;\n\n&#x27;; cat /etc/podinfo/labels; fi; if [[ -e /etc/podinfo/annotations ]]; then echo -en &#x27;\n\n&#x27;; cat /etc/podinfo/annotations; fi; sleep 5;done;<br>        command:<br>        - sh<br>        - -c<br>        image: busybox<br>        imagePullPolicy: IfNotPresent<br>        name: client-container<br>        resources: &#123;&#125;<br>        volumeMounts:<br>        - name: podinfo<br>          mountPath: /etc/podinfo<br>      volumes:<br>      - name: podinfo<br>        downwardAPI:<br>          items:<br>            - path: &quot;labels&quot;<br>              fieldRef:<br>                fieldPath: metadata.labels<br>            - path: &quot;annotations&quot;<br>              fieldRef:<br>                fieldPath: metadata.annotations<br></code></pre></td></tr></table></figure><h2 id="Downward-APIæ”¯æŒçš„å¸¸ç”¨å­—æ®µ"><a href="#Downward-APIæ”¯æŒçš„å¸¸ç”¨å­—æ®µ" class="headerlink" title="Downward APIæ”¯æŒçš„å¸¸ç”¨å­—æ®µ"></a>Downward APIæ”¯æŒçš„å¸¸ç”¨å­—æ®µ</h2><p><strong>1ï¼Œä½¿ç”¨fieldRefå¯ä»¥å£°æ˜ä½¿ç”¨:</strong></p><p>spec.nodeName - å®¿ä¸»æœºåå­—</p><p>status.hostIP - å®¿ä¸»æœºIP</p><p>metadata.name - Podçš„åå­—</p><p>metadata.namespace - Podçš„Namespace</p><p>status.podIP - Podçš„IP</p><p>spec.serviceAccountName - Podçš„Service Accountçš„åå­—</p><p>metadata.uid - Podçš„UID</p><p>metadata.labels[â€˜<KEY>â€˜] - æŒ‡å®š<KEY>çš„Labelå€¼</p><p>metadata.annotations[â€˜<KEY>â€˜] - æŒ‡å®š<KEY>çš„Annotationå€¼</p><p>metadata.labels - Podçš„æ‰€æœ‰Label</p><p>metadata.annotations - Podçš„æ‰€æœ‰Annotation</p><p><strong>2ï¼Œä½¿ç”¨resourceFieldRefå¯ä»¥å£°æ˜ä½¿ç”¨:</strong></p><p>limits.cpu-å®¹å™¨çš„CPU limit </p><p>requests.cpu-å®¹å™¨çš„CPU request</p><p>limits.memory-å®¹å™¨çš„memory limit</p><p>requests.memoryå®¹å™¨çš„memory request</p><p>å®Œæ•´ç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: centos-env<br>    qcloud-app: centos-env<br>  name: centos-env<br>spec:<br>  selector:<br>    matchLabels:<br>      k8s-app: centos-env<br>  template:<br>    metadata:<br>      annotations:<br>        description: ddd<br>      labels:<br>        k8s-app: centos-env<br>        qcloud-app: centos-env<br>    spec:<br>      containers:<br>      - env:<br>        - name: pod-name<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.name<br>        - name: pod-namespacce<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.namespace<br>        - name: pod-labels<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.labels[&#x27;k8s-app&#x27;]<br>        - name: pod-annotations<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.annotations[&#x27;description&#x27;]<br>        - name: pod-uid<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: metadata.uid<br>        - name: pod-nodename<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: spec.nodeName<br>        - name: pod-hostIP<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: status.hostIP<br>        - name: pod-podIP<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: status.podIP<br>        - name: pod-serviceAccountName<br>          valueFrom:<br>            fieldRef:<br>              apiVersion: v1<br>              fieldPath: spec.serviceAccountName<br>        image: ccr.ccs.tencentyun.com/chenjingwei/centos:latest<br>        imagePullPolicy: IfNotPresent<br>        name: centos-1<br>        resources:<br>          limits:<br>            cpu: 25m<br>            memory: 64Mi<br>          requests:<br>            cpu: 25m<br>            memory: 64Mi<br>        volumeMounts:<br>        - mountPath: /etc/podinfo<br>          name: podinfo<br>          readOnly: false<br>      imagePullSecrets:<br>      - name: qcloudregistrykey<br>      volumes:<br>      - name: podinfo<br>        projected:<br>          sources:<br>          - downwardAPI:<br>              items:<br>                - path: &quot;labels&quot;<br>                  fieldRef:<br>                    fieldPath: metadata.labels<br>                - path: &quot;annotations&quot;<br>                  fieldRef:<br>                    fieldPath: metadata.annotations<br><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> TKE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> TKE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Nginx-Ingresså®ç°gRPCæœåŠ¡è®¿é—®</title>
      <link href="/post/450ae69a.html"/>
      <url>/post/450ae69a.html</url>
      
        <content type="html"><![CDATA[<p>è¿™é‡ŒéªŒè¯ä¸‹å¦‚ä½•é€šè¿‡Ingress-NGINXæ§åˆ¶å™¨å°†æµé‡è·¯ç”±åˆ°gRPCæœåŠ¡</p><blockquote><p>å‰ææ¡ä»¶ï¼š</p><p>1ï¼Œå·²åˆ›å»ºæˆ–è€…è‡ªå»ºkubernetesé›†ç¾¤</p><p>2ï¼Œå·²ç»ç”³è¯·å¯¹åº”åŸŸå</p><p>3ï¼Œå·²å®‰è£…äº†ingress-nginx-controller</p><p>4ï¼ŒGRPCæœåŠ¡ å¯ä»¥ä½¿ç”¨<a href="https://github.com/grpc/grpc-go/blob/91e0aeb192456225adf27966d04ada4cf8599915/examples/features/reflection/server/main.go">go-grpc-greeter-server</a>ä½œä¸ºç¤ºä¾‹</p><p>5ï¼Œå’ŒåŸŸåå¯¹åº”çš„SSLè¯ä¹¦</p></blockquote><h2 id="éƒ¨ç½²gRPCåº”ç”¨"><a href="#éƒ¨ç½²gRPCåº”ç”¨" class="headerlink" title="éƒ¨ç½²gRPCåº”ç”¨"></a>éƒ¨ç½²gRPCåº”ç”¨</h2><p>ç¡®ä¿gRPCåº”ç”¨ç¨‹åºæ­£åœ¨è¿è¡Œå¹¶ç›‘å¬è¿æ¥ï¼Œæœ¬ç¤ºä¾‹ä½¿ç”¨é•œåƒ<code>ccr.ccs.tencentyun.com/v_cjweichen/grpc-server:latest</code>åˆ›å»ºgRPCæœåŠ¡</p><p>å¤åˆ¶ä»¥ä¸‹YAMLå†…å®¹åˆ›å»ºgrpc.yamlæ–‡ä»¶</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grpc-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">run:</span> <span class="hljs-string">grpc-service</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">run:</span> <span class="hljs-string">grpc-service</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">ccr.ccs.tencentyun.com/chenjingwei/grpc-server:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">Always</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">grpc-service</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">50051</span><br>          <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>      <span class="hljs-attr">imagePullSecrets:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">qcloudregistrykey</span> <br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br></code></pre></td></tr></table></figure><h2 id="ä¸ºgRPCåº”ç”¨åˆ›å»ºService"><a href="#ä¸ºgRPCåº”ç”¨åˆ›å»ºService" class="headerlink" title="ä¸ºgRPCåº”ç”¨åˆ›å»ºService"></a>ä¸ºgRPCåº”ç”¨åˆ›å»ºService</h2><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">grpc-service</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">grpc-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">50051</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">50051</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">run:</span> <span class="hljs-string">grpc-service</span><br>  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤æŸ¥çœ‹Pod</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-16-tlinux ~/grpc]<span class="hljs-comment"># kubectl  get pods,svc -o wide</span><br>NAME                                READY   STATUS    RESTARTS   AGE     IP           NODE        NOMINATED NODE   READINESS GATES<br>pod/grpc-service-5d48b78787-hcfhf   1/1     Running   0          3m57s   172.16.0.5   10.0.0.16   &lt;none&gt;           &lt;none&gt;<br><br>NAME                   TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)     AGE     SELECTOR<br>service/grpc-service   ClusterIP   172.16.255.180   &lt;none&gt;        50051/TCP   2m41s   run=grpc-service<br></code></pre></td></tr></table></figure><h2 id="ä¸ºgRPCåº”ç”¨åˆ›å»ºingressè·¯ç”±"><a href="#ä¸ºgRPCåº”ç”¨åˆ›å»ºingressè·¯ç”±" class="headerlink" title="ä¸ºgRPCåº”ç”¨åˆ›å»ºingressè·¯ç”±"></a>ä¸ºgRPCåº”ç”¨åˆ›å»ºingressè·¯ç”±</h2><p>å¤åˆ¶ä»¥ä¸‹YAMLå†…å®¹åˆ›å»ºgrpc-ingress.yamlæ–‡ä»¶ã€‚</p><blockquote><p><strong>æ³¨æ„</strong></p><ul><li>éƒ¨ç½²gRPCæœåŠ¡æ‰€ä½¿ç”¨çš„Ingresséœ€è¦åœ¨<strong>annotation</strong>ä¸­åŠ å…¥<code>nginx.ingress.kubernetes.io/backend-protocol</code>ï¼Œå€¼ä¸º<strong>GRPC</strong>ã€‚</li><li>æœ¬ç¤ºä¾‹ä½¿ç”¨çš„åŸŸåä¸º<code>grpc.example.com</code>ï¼Œè¯·æ ¹æ®å®é™…æƒ…å†µä¿®æ”¹ã€‚</li></ul></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>    nginx.ingress.kubernetes.io/backend-protocol: GRPC   # æ³¨æ„è¿™é‡Œï¼šå¿…é¡»è¦é…ç½®ä»¥æŒ‡æ˜åç«¯æœåŠ¡ä¸ºgRPCæœåŠ¡<br>  name: grpc-ingress<br>  namespace: default<br>spec:<br>  rules:<br>  - host: grpc.chen1900s.cn<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: grpc-service<br>          servicePort: 50051<br>        path: /<br>        pathType: ImplementationSpecific<br>  tls:<br>  - hosts:<br>    - grpc.chen1900s.cn<br>    secretName: grpc-secret<br><br></code></pre></td></tr></table></figure><h2 id="æµ‹è¯•è¿æ¥"><a href="#æµ‹è¯•è¿æ¥" class="headerlink" title="æµ‹è¯•è¿æ¥"></a>æµ‹è¯•è¿æ¥</h2><p>ä¸€æ—¦æˆ‘ä»¬å°†é…ç½®åº”ç”¨åˆ°Kubernetesä¸Šï¼Œå°±è¯¥æµ‹è¯•æˆ‘ä»¬æ˜¯å¦å¯ä»¥å®é™…ä¸åç«¯é€šä¿¡äº†ã€‚ä¸ºæ­¤ï¼Œæˆ‘ä»¬å°†ä½¿ç”¨grpcurlå®ç”¨æµ‹è¯•ç¨‹åº:</p><p>éœ€è¦æå‰å®‰è£…grpcurlå·¥å…·ï¼Œgrpcurlæ˜¯Goè¯­è¨€å¼€æºç¤¾åŒºå¼€å‘çš„å·¥å…·ï¼Œéœ€è¦æ‰‹å·¥å®‰è£…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">wget https://github.com/fullstorydev/grpcurl/releases/download/v1.7.0/grpcurl_1.7.0_linux_x86_64.tar.gz<br>tar -xvf grpcurl_1.7.0_linux_x86_64.tar.gz<br>chmod +x grpcurl<br>./grpcurl -help<br></code></pre></td></tr></table></figure><p>æœ¬ç¤ºä¾‹ä¸­ä½¿ç”¨åŸŸå<code>grpc.chen1900s.cn</code>ä»¥åŠè‡ªç­¾è¯ä¹¦ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤éªŒè¯è¯·æ±‚æ˜¯å¦æˆåŠŸè½¬å‘åˆ°åç«¯æœåŠ¡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">##grpcurl -insecure -authority grpc.example.com &lt;ip_address&gt;:443 list<br>##ip_addressä¸ºNginx Ingress Controllerçš„Serviceå¤–éƒ¨IP<br><br><br>[root@VM-0-16-tlinux ~/grpc]# ./grpcurl -insecure -authority grpc.chen1900s.cn  170.106.134.2:443 list<br>greet.GrpcService<br>grpc.reflection.v1alpha.ServerReflection<br></code></pre></td></tr></table></figure><p>ä»é¢„æœŸè¾“å‡ºå¯å¾—ï¼Œæµé‡è¢«IngressæˆåŠŸè½¬å‘åˆ°åç«¯gRPCæœåŠ¡</p><p>æ³¨æ„ç‚¹ï¼šç”±äºNginx grpc_passçš„é™åˆ¶ï¼Œç›®å‰å¯¹äºgRPCæœåŠ¡ï¼Œæš‚ä¸æ”¯æŒservice-weightçš„é…ç½®</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Nginx-ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>éƒ¨ç½²kubernetes-dashboardæœåŠ¡</title>
      <link href="/post/1814e34b.html"/>
      <url>/post/1814e34b.html</url>
      
        <content type="html"><![CDATA[<h2 id="åœ¨TKEé›†ç¾¤éƒ¨ç½²kubernetes-dashboardæœåŠ¡"><a href="#åœ¨TKEé›†ç¾¤éƒ¨ç½²kubernetes-dashboardæœåŠ¡" class="headerlink" title="åœ¨TKEé›†ç¾¤éƒ¨ç½²kubernetes-dashboardæœåŠ¡"></a>åœ¨TKEé›†ç¾¤éƒ¨ç½²kubernetes-dashboardæœåŠ¡</h2><p><a href="https://github.com/kubernetes/dashboard">å…·ä½“å‚è€ƒ</a></p><blockquote><p>åŸºäºå·²ç»åˆ›å»ºå¥½çš„Kubernetesé›†ç¾¤è¿›è¡Œéƒ¨ç½²Kubernetes-dashboard</p></blockquote><h3 id="ä¸‹è½½éƒ¨ç½²yamlæ–‡ä»¶"><a href="#ä¸‹è½½éƒ¨ç½²yamlæ–‡ä»¶" class="headerlink" title="ä¸‹è½½éƒ¨ç½²yamlæ–‡ä»¶"></a>ä¸‹è½½éƒ¨ç½²yamlæ–‡ä»¶</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">wget https://raw.githubusercontent.com/kubernetes/dashboard/v2.0.4/aio/deploy/recommended.yaml<br></code></pre></td></tr></table></figure><h3 id="ä¸‹è½½é•œåƒ"><a href="#ä¸‹è½½é•œåƒ" class="headerlink" title="ä¸‹è½½é•œåƒ"></a>ä¸‹è½½é•œåƒ</h3><p>ç”±äºé•œåƒæ˜¯å›½å¤–é•œåƒï¼Œå›½å†…é›†ç¾¤éƒ¨ç½²æœ‰å¯èƒ½ä¼šæ‹‰å–é•œåƒå¤±è´¥ï¼Œå¯ä»¥å…ˆæ‰‹åŠ¨æ‹‰å–ä¸‹æ¥ï¼Œç„¶åä¿®æ”¹å¯¹åº”çš„yamlæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">docker pull kubernetesui/dashboard:v2.0.4<br>docker pull kubernetesui/metrics-scraper:v1.0.4<br><br>docker tag 46d0a29c3f61 ccr.ccs.tencentyun.com/chenjingwei/dashboard:v2.0.4  <span class="hljs-comment">#é‡æ–°æ‰“tag, å¯¹åº”åˆ°è‡ªå·±è´¦å·ä¸‹ä¸ªäººé•œåƒå‚è€ƒï¼Œæˆ‘è¿™é‡Œä¸Šä¼ åˆ°æˆ‘è‡ªå·±çš„é•œåƒä»“åº“ï¼Œå¦‚æœæœ‰éœ€è¦ ä¹Ÿå¯ä»¥ä»è¿™ä¸ªåœ°å€ä¸‹è½½</span><br>docker tag 86262685d9ab  ccr.ccs.tencentyun.com/chenjingwei/metrics-scraper:v1.0.4<br><br>docker push ccr.ccs.tencentyun.com/chenjingwei/dashboard:v2.0.4<br>docker push ccr.ccs.tencentyun.com/chenjingwei/metrics-scraper:v1.0.4<br></code></pre></td></tr></table></figure><h3 id="è®¿é—®æ–¹å¼é…ç½®ï¼ˆå¯é€‰ï¼‰"><a href="#è®¿é—®æ–¹å¼é…ç½®ï¼ˆå¯é€‰ï¼‰" class="headerlink" title="è®¿é—®æ–¹å¼é…ç½®ï¼ˆå¯é€‰ï¼‰"></a>è®¿é—®æ–¹å¼é…ç½®ï¼ˆå¯é€‰ï¼‰</h3><p>å¯¹åº”çš„service é»˜è®¤æ˜¯clusterIPæ–¹å¼ï¼Œå¦‚æœéœ€è¦CLBå»è®¿é—® æˆ–è€…nodePortæ–¹å¼å»è®¿é—®ï¼Œå¯ä»¥ä¿®æ”¹å¯¹åº”çš„yamlæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥éƒ¨ç½²å®Œåä¿®æ”¹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-number">8443</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">NodePort</span>   <span class="hljs-comment">#æ·»åŠ è¿™ä¸ª serviceç±»å‹  å¦‚æœéœ€è¦æ˜¯CLBç±»å‹ åˆ™ä¿®æ”¹æˆ  LoadBalancer</span><br></code></pre></td></tr></table></figure><h3 id="éƒ¨ç½²kubernetes-dashboard"><a href="#éƒ¨ç½²kubernetes-dashboard" class="headerlink" title="éƒ¨ç½²kubernetes-dashboard"></a>éƒ¨ç½²kubernetes-dashboard</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl apply -f recommended.yaml<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦éƒ¨ç½²æˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-41-tlinux ~]<span class="hljs-comment"># kubectl  -n kubernetes-dashboard get pod,svc</span><br>NAME                                            READY   STATUS    RESTARTS   AGE<br>pod/dashboard-metrics-scraper-7748f84fc-8ldkn   1/1     Running   0          92m<br>pod/kubernetes-dashboard-6fbb5497cf-qscnk       2/2     Running   1          29m<br><br>NAME                                TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)         AGE<br>service/dashboard-metrics-scraper   ClusterIP   172.16.253.139   &lt;none&gt;        8000/TCP        92m<br>service/kubernetes-dashboard        NodePort    172.16.252.218   &lt;none&gt;        443:31778/TCP   92m<br></code></pre></td></tr></table></figure><h3 id="è®¿é—®kubernetes-dashboard"><a href="#è®¿é—®kubernetes-dashboard" class="headerlink" title="è®¿é—®kubernetes-dashboard"></a>è®¿é—®kubernetes-dashboard</h3><p>ç”±äºä¸Šé¢serviceä½¿ç”¨çš„æ˜¯NodePortç±»å‹ï¼Œå¯ä»¥é€šè¿‡nodeIP+NodePortç«¯å£å»è®¿é—®ï¼Œkubernetes-dashboardåç«¯æœåŠ¡æ˜¯httpsåè®®çš„ï¼Œåˆ™éœ€è¦é€šè¿‡https:&#x2F;&#x2F;èŠ‚ç‚¹IP:NodePort</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180021047.png" alt="image-20221018002131961"></p><p>éªŒè¯æ–¹å¼é€‰æ‹©token</p><h3 id="TKEé›†ç¾¤è·å–Tokenè®¤è¯æ–¹å¼"><a href="#TKEé›†ç¾¤è·å–Tokenè®¤è¯æ–¹å¼" class="headerlink" title="TKEé›†ç¾¤è·å–Tokenè®¤è¯æ–¹å¼"></a>TKEé›†ç¾¤è·å–Tokenè®¤è¯æ–¹å¼</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># åˆ›å»ºserviceaccount<br>kubectl create serviceaccount dashboard-serviceaccount -n kubernetes-dashboard<br># åˆ›å»ºclusterrolebinding<br>kubectl create clusterrolebinding dashboard-cluster-admin --clusterrole=cluster-admin --serviceaccount=kubernetes-dashboard:dashboard-serviceaccount<br></code></pre></td></tr></table></figure><p>è·å–token</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-41-tlinux ~]# kubectl get secret -n kubernetes-dashboard | grep dashboard-serviceaccount-token<br>dashboard-serviceaccount-token-pddv4   kubernetes.io/service-account-token   3      98m<br>[root@VM-249-41-tlinux ~]# kubectl describe secret dashboard-serviceaccount-token-pddv4 -n kubernetes-dashboard<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180024730.png" alt="image-20221018002432661"></p><p>å¤åˆ¶token åˆ°æ§åˆ¶å°</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180025468.png" alt="image-20221018002536365"></p><h2 id="åŸºäºIstioçš„è®¿é—®kubernetes-dashboardé…ç½®"><a href="#åŸºäºIstioçš„è®¿é—®kubernetes-dashboardé…ç½®" class="headerlink" title="åŸºäºIstioçš„è®¿é—®kubernetes-dashboardé…ç½®"></a>åŸºäºIstioçš„è®¿é—®kubernetes-dashboardé…ç½®</h2><p>å‚è€ƒ<a href="https://preliminary.istio.io/latest/docs/tasks/traffic-management/ingress/ingress-sni-passthrough/">istioå®˜æ–¹æ–‡æ¡£</a></p><blockquote><p>å‰ææ¡ä»¶ï¼š</p><p>1ï¼ŒæœåŠ¡ç½‘æ ¼å·²ç»å…³è”é›†ç¾¤</p><p>2ï¼Œå·²ç»åˆ›å»ºè¾¹ç¼˜ä»£ç†ç½‘å…³<strong>istio-ingressgateway</strong></p></blockquote><p>é¦–å…ˆéœ€è¦å¼€å¯ Sidecar è‡ªåŠ¨æ³¨å…¥é…ç½®ï¼Œå‘½åç©ºé—´é€‰æ‹©kubernetes-dashboardï¼Œç„¶åé”€æ¯é‡å»ºkubernetes-dashboardçš„POD</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#è¿™è¾¹æ˜¯åŸºäºTKEçš„å®¹å™¨æœåŠ¡ç½‘æ ¼1.12.5ç‰ˆæœ¬çš„ï¼Œå…¶ä»–ç‰ˆæœ¬éœ€è¦ä¿®æ”¹æˆå¯¹åº”ç‰ˆæœ¬</span><br><br>kubectl label namespace kubernetes-dashboard istio.io/rev=1-12-5<br><br><span class="hljs-comment">#å¦‚æœæ˜¯ä½¿ç”¨çš„æ˜¯è‡ªå»ºsidecar åˆ™éœ€è¦ä½¿ç”¨ä¸‹é¢è¿™ä¸ªå‘½ä»¤å¼€å¯è‡ªåŠ¨æ³¨å…¥</span><br><span class="hljs-comment">#kubectl label namespace xxx istio-injection=enalbed ä¸ºæŸä¸ª namespace å¼€å¯ sidecar è‡ªåŠ¨æ³¨å…¥</span><br></code></pre></td></tr></table></figure><h3 id="æ–°å»ºGateway"><a href="#æ–°å»ºGateway" class="headerlink" title="æ–°å»ºGateway"></a>æ–°å»ºGateway</h3><p>è¿™é‡Œä½¿ç”¨è‡ªå®šä¹‰çš„åŸŸåkubernetes-dashboard.chen1900s.com</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180038668.png" alt="image-20221018003822597"></p><p>å¯¹åº”yaml:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.istio.io/v1alpha3<br>kind: Gateway<br>metadata:<br>  name: kubernetes-dashboard-gateway<br>  namespace: kubernetes-dashboard<br>spec:<br>  servers:<br>    - port:<br>        number: 443<br>        name: HTTPS-1-m00g<br>        protocol: HTTPS<br>      hosts:<br>        - kubernetes-dashboard.chen1900s.com<br>      tls:<br>        mode: PASSTHROUGH<br>  selector:<br>    app: istio-ingressgateway<br>    istio: ingressgateway<br></code></pre></td></tr></table></figure><h3 id="åˆ›å»ºVirtual-Service"><a href="#åˆ›å»ºVirtual-Service" class="headerlink" title="åˆ›å»ºVirtual Service"></a>åˆ›å»ºVirtual Service</h3><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180041789.png" alt="image-20221018004125714"></p><p>yamlæ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.istio.io/v1alpha3<br>kind: VirtualService<br>metadata:<br>  name: kubernetes-dashboard-vs<br>  namespace: kubernetes-dashboard<br>spec:<br>  hosts:<br>    - kubernetes-dashboard.chen1900s.com<br>  gateways:<br>    - kubernetes-dashboard/kubernetes-dashboard-gateway<br>  tls:<br>    - match:<br>        - sniHosts:<br>            - kubernetes-dashboard.chen1900s.com<br>      route:<br>        - destination:<br>            host: kubernetes-dashboard.kubernetes-dashboard.svc.cluster.local<br>            port:<br>              number: 443<br>          weight: 100<br></code></pre></td></tr></table></figure><p>è®¾ç½®å®Œæˆåï¼Œé…ç½®å¦‚ä¸‹æœ¬åœ°hostæ˜ å°„ï¼Œå³å¯é€šè¿‡åŸŸå <a href="https://kubernetes-dashboard.chen1900s.com/">https://kubernetes-dashboard.chen1900s.com</a> è®¿é—®ï¼Œæ•ˆæœä¸ä¹‹å‰çš„NodePortä¸€è‡´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-41-tlinux ~]# kubectl  -n istio-system get svc  istio-ingressgateway <br>NAME                   TYPE           CLUSTER-IP      EXTERNAL-IP      PORT(S)         AGE<br>istio-ingressgateway   LoadBalancer   172.16.255.54   114.117.219.33   443:32430/TCP   3h47m<br><br>#114.117.219.33 kubernetes-dashboard.chen1900s.com<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180045224.png" alt="image-20221018004522135"></p><p>è¾“å…¥ä¸Šé¢æŸ¥è¯¢åˆ°çš„token å¯ä»¥æ­£å¸¸ç™»é™†</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180046871.png" alt="image-20221018004606746"></p><p>Istioä¸­åŸºäºSecure Ingressçš„è®¿é—®æ–¹å¼è¿˜æœ‰å¤šç§</p><h2 id="åŸºäºnginx-ingressæ–¹å¼è®¿é—®kubernetes-dashboard"><a href="#åŸºäºnginx-ingressæ–¹å¼è®¿é—®kubernetes-dashboard" class="headerlink" title="åŸºäºnginx-ingressæ–¹å¼è®¿é—®kubernetes-dashboard"></a>åŸºäºnginx-ingressæ–¹å¼è®¿é—®kubernetes-dashboard</h2><p>Nginx Ingress Controlleré»˜è®¤ä½¿ç”¨HTTPåè®®è½¬å‘è¯·æ±‚åˆ°åç«¯ä¸šåŠ¡å®¹å™¨ã€‚å½“åç«¯ä¸šåŠ¡å®¹å™¨ä¸ºHTTPSåè®®æ—¶ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨æ³¨è§£<code>nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</code>æ¥ä½¿å¾—Nginx Ingress Controllerä½¿ç”¨HTTPåè®®è½¬å‘è¯·æ±‚åˆ°åç«¯ä¸šåŠ¡å®¹å™¨</p><p>kubernetes-dashboardæœåŠ¡æ­£æ˜¯HTTPSåè®®æœåŠ¡ï¼Œåˆ™éœ€è¦ä½¿ç”¨è¿™ä¸ªannotations</p><blockquote><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><p>1ï¼Œå·²ç»åˆ›å»ºnginx-ingress-controller å®ä¾‹</p><p>2ï¼Œå·²ç»åˆ›å»ºTLSè¯ä¹¦</p></blockquote><p>é¦–å…ˆæ˜¯å¦‚æœä¸æ·»åŠ è¿™ä¸ªannotations è®¿é—®ä¼šæŠ¥ Client sent an HTTP request to an HTTPS server.</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180102998.png" alt="image-20221018010208941"></p><p>æ·»åŠ nginx.ingress.kubernetes.io&#x2F;backend-protocol: â€œHTTPSâ€ åè®¿é—®æ­£å¸¸</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180103610.png" alt="image-20221018010345523"></p><p>yamlæ–‡ä»¶ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">kubernetes.io/ingress.rule-mix:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/backend-protocol:</span> <span class="hljs-string">HTTPS</span>    <span class="hljs-comment">#é‡ç‚¹è¿™ä¸ªannotations</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span>     <span class="hljs-comment">#åŸŸåæ›¿æ¢æˆè‡ªå·±çš„åŸŸå</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">kubernetes-dashboard</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">443</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span><br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">chen1900s</span>                          <span class="hljs-comment">#æ›¿æ¢æˆè‡ªå·±çš„è¯ä¹¦secret</span><br></code></pre></td></tr></table></figure><h2 id="åŸºäºCLBç±»å‹ingressæ–¹å¼è®¿é—®kubernetes-dashboardé…ç½®"><a href="#åŸºäºCLBç±»å‹ingressæ–¹å¼è®¿é—®kubernetes-dashboardé…ç½®" class="headerlink" title="åŸºäºCLBç±»å‹ingressæ–¹å¼è®¿é—®kubernetes-dashboardé…ç½®"></a>åŸºäºCLBç±»å‹ingressæ–¹å¼è®¿é—®kubernetes-dashboardé…ç½®</h2><p>CLBç±»å‹ingressï¼Œå¯¹åº”åç«¯æœåŠ¡åè®®æ˜¯é»˜è®¤HTTPçš„ï¼Œåç«¯åè®®æ˜¯æŒ‡ CLB ä¸åç«¯æœåŠ¡ä¹‹é—´åè®®ï¼Œåç«¯åè®®é€‰æ‹© HTTP æ—¶ï¼Œåç«¯æœåŠ¡éœ€éƒ¨ç½² HTTP æœåŠ¡ã€‚åç«¯åè®®é€‰ä¸­ HTTPS æ—¶ï¼Œåç«¯æœåŠ¡éœ€éƒ¨ç½² HTTPS æœåŠ¡ï¼ŒHTTPS æœåŠ¡çš„åŠ è§£å¯†ä¼šè®©åç«¯æœåŠ¡æ¶ˆè€—æ›´å¤šèµ„æº</p><p>å¦‚æœéœ€è¦åç«¯åè®®ä¸ºHTTPS åˆ™éœ€è¦ä½¿ç”¨TkeServiceConfigæ¥é…ç½®ingressè‡ªåŠ¨åˆ›å»ºçš„CLB</p><p>å¦‚æœä¸é€šè¿‡TkeServiceConfigé…ç½®åç«¯æ˜¯HTTPSæœåŠ¡æ—¶å€™ï¼Œè®¿é—®ä¼šå¼‚å¸¸ï¼Œå¦‚ä¸‹ï¼š</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180117469.png" alt="image-20221018011724396"></p><h3 id="ä½¿ç”¨-TkeServiceConfig-é…ç½®-CLB"><a href="#ä½¿ç”¨-TkeServiceConfig-é…ç½®-CLB" class="headerlink" title="ä½¿ç”¨ TkeServiceConfig é…ç½® CLB"></a>ä½¿ç”¨ TkeServiceConfig é…ç½® CLB</h3><p>åˆ›å»º Ingress æ—¶ï¼Œè®¾ç½® <strong>ingress.cloud.tencent.com&#x2F;tke-service-config-auto:<true></strong> ï¼Œå°†è‡ªåŠ¨åˆ›å»º <IngressName>-auto-ingress-config</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">ingress.cloud.tencent.com/tke-service-config-auto:</span> <span class="hljs-string">&quot;true&quot;</span>   <span class="hljs-comment">#è‡ªåŠ¨åˆ›å»ºTkeServiceConfig</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">qcloud</span><br>    <span class="hljs-attr">kubernetes.io/ingress.rule-mix:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">kubernetes-dashboard</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">443</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span><br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">chen1900s-ye4ubdzo</span><br><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹TkeServiceConfigé…ç½®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-41-tlinux ~]<span class="hljs-comment"># kubectl  -n  kubernetes-dashboard  get TkeServiceConfig   kubernetes-dashboard-auto-ingress-config </span><br>NAME                                       AGE<br>kubernetes-dashboard-auto-ingress-config   66s<br></code></pre></td></tr></table></figure><p>ç¼–è¾‘è¿™ä¸ªé…ç½®æ–‡ä»¶ï¼Œä¿®æ”¹åç«¯åè®® <code>spec.loadBalancer.l7listeners.protocol.domain.rules.url.forwardType</code>: æŒ‡å®šåç«¯åè®®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl  -n  kubernetes-dashboard  edit  TkeServiceConfig   kubernetes-dashboard-auto-ingress-config <br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180123467.png" alt="image-20221018012329401"></p><p>ç„¶åä½¿ç”¨è¿™ä¸ªCLBå¯¹åº”çš„åŸŸåè¿›è¡Œè®¿é—®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180124832.png" alt="image-20221018012426758"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202210180125382.png" alt="image-20221018012544266"></p><p>é™„ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">cloud.tencent.com/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">TkeServiceConfig</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kubernetes-dashboard-auto-ingress-config</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kubernetes-dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">loadBalancer:</span><br>    <span class="hljs-attr">l7Listeners:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">defaultServer:</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span><br>      <span class="hljs-attr">domains:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">domain:</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span><br>        <span class="hljs-attr">rules:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">forwardType:</span> <span class="hljs-string">HTTPS</span>                  <span class="hljs-comment">#ä¸»è¦ä¿®æ”¹è¿™ä¸ª   æŒ‡å®šåç«¯åè®®</span><br>          <span class="hljs-attr">healthCheck:</span><br>            <span class="hljs-attr">enable:</span> <span class="hljs-literal">true</span><br>            <span class="hljs-attr">healthNum:</span> <span class="hljs-number">3</span><br>            <span class="hljs-attr">httpCheckDomain:</span> <span class="hljs-string">kubernetes-dashboard.chen1900s.cn</span><br>            <span class="hljs-attr">httpCheckMethod:</span> <span class="hljs-string">HEAD</span><br>            <span class="hljs-attr">httpCheckPath:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">httpCode:</span> <span class="hljs-number">31</span><br>            <span class="hljs-attr">intervalTime:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">sourceIpType:</span> <span class="hljs-number">0</span><br>            <span class="hljs-attr">timeout:</span> <span class="hljs-number">5</span><br>            <span class="hljs-attr">unHealthNum:</span> <span class="hljs-number">3</span><br>          <span class="hljs-attr">scheduler:</span> <span class="hljs-string">WRR</span><br>          <span class="hljs-attr">session:</span><br>            <span class="hljs-attr">enable:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">url:</span> <span class="hljs-string">/</span><br>      <span class="hljs-attr">keepaliveEnable:</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">443</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">HTTPS</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">keepaliveEnable:</span> <span class="hljs-number">0</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">protocol:</span> <span class="hljs-string">HTTP</span><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> TKE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> TKE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteså¸¸è§é©±é€Evictioné—®é¢˜</title>
      <link href="/post/d0686bc1.html"/>
      <url>/post/d0686bc1.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨é«˜å¯ç”¨çš„k8sé›†ç¾¤ä¸­ï¼Œå½“NodeèŠ‚ç‚¹æŒ‚æ‰ï¼Œkubeletæ— æ³•æä¾›å·¥ä½œçš„æ—¶å€™ï¼Œpodå°†ä¼šé©±é€å¹¶è‡ªåŠ¨è°ƒåº¦åˆ°å…¶ä»–çš„èŠ‚ç‚¹ä¸Šå»ï¼Œæˆ–è€…åœ¨nodeèŠ‚ç‚¹çš„èµ„æºç´§ç¼ºçš„æ¡ä»¶ä¸‹ï¼Œkubeletä¸ºäº†ä¿è¯nodeèŠ‚ç‚¹çš„ç¨³å®šæ€§ï¼Œä¹Ÿå›è§¦å‘ä¸»åŠ¨é©±é€podçš„æœºåˆ¶</p></blockquote><h2 id="PODé©±é€"><a href="#PODé©±é€" class="headerlink" title="PODé©±é€"></a>PODé©±é€</h2><p>EvictionçŠ¶æ€ä»‹ç»ï¼š</p><ul><li>Evictionï¼Œå³é©±é€çš„æ„æ€ï¼Œæ„æ€æ˜¯å½“èŠ‚ç‚¹å‡ºç°å¼‚å¸¸æ—¶ï¼Œä¸ºäº†ä¿è¯å·¥ä½œè´Ÿè½½çš„å¯ç”¨æ€§ï¼Œkuberneteså°†æœ‰ç›¸åº”çš„æœºåˆ¶é©±é€è¯¥èŠ‚ç‚¹ä¸Šçš„Podã€‚<br>ç›®å‰kubernetesä¸­å­˜åœ¨ä¸¤ç§evictionæœºåˆ¶ï¼Œåˆ†åˆ«ç”±kube-controller-managerå’Œkubeletå®ç°ã€‚</li><li>kube-controller-managerçš„evictionæœºåˆ¶æ˜¯ç²—ç²’åº¦çš„ï¼Œå³é©±èµ¶ä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„æ‰€æœ‰podï¼Œè€Œkubeletåˆ™æ˜¯ç»†ç²’åº¦çš„ï¼Œå®ƒé©±èµ¶çš„æ˜¯èŠ‚ç‚¹ä¸Šçš„æŸäº›Podï¼Œé©±èµ¶å“ªäº›Podä¸Podçš„Qosæœºåˆ¶æœ‰å…³ã€‚è¯¥Evictionä¼šå‘¨æœŸæ€§æ£€æŸ¥æœ¬èŠ‚ç‚¹å†…å­˜ã€ç£ç›˜ç­‰èµ„æºï¼Œå½“èµ„æºä¸è¶³æ—¶ï¼ŒæŒ‰ç…§ä¼˜å…ˆçº§é©±é€éƒ¨åˆ†pod</li></ul><h3 id="kube-controller-managerå®ç°çš„eviction"><a href="#kube-controller-managerå®ç°çš„eviction" class="headerlink" title="kube-controller-managerå®ç°çš„eviction"></a>kube-controller-managerå®ç°çš„eviction</h3><p>kube-controller-managerä¸»è¦ç”±å¤šä¸ªæ§åˆ¶å™¨æ„æˆï¼Œè€Œevictionçš„åŠŸèƒ½ä¸»è¦ç”±node controllerè¿™ä¸ªæ§åˆ¶å™¨å®ç°ã€‚è¯¥Evictionä¼šå‘¨æœŸæ€§æ£€æŸ¥æ‰€æœ‰èŠ‚ç‚¹çŠ¶æ€ï¼Œå½“èŠ‚ç‚¹å¤„äº<strong>NotReady</strong>çŠ¶æ€è¶…è¿‡ä¸€æ®µæ—¶é—´åï¼Œé©±é€è¯¥èŠ‚ç‚¹ä¸Šæ‰€æœ‰pod</p><p>Kubelet çŠ¶æ€æ›´æ–°çš„åŸºæœ¬æµç¨‹ï¼š</p><ul><li>kubelet è‡ªèº«ä¼šå®šæœŸæ›´æ–°çŠ¶æ€åˆ° apiserverï¼Œé€šè¿‡å‚æ•°â€“node-status-update-frequencyæŒ‡å®šä¸ŠæŠ¥é¢‘ç‡ï¼Œé»˜è®¤æ˜¯ 10s ä¸ŠæŠ¥ä¸€æ¬¡ã€‚</li><li>kube-controller-manager ä¼šæ¯éš”â€“node-monitor-periodæ—¶é—´å»æ£€æŸ¥ kubelet çš„çŠ¶æ€ï¼Œé»˜è®¤æ˜¯ 5sã€‚</li><li>å½“ node å¤±è”ä¸€æ®µæ—¶é—´åï¼Œkubernetes åˆ¤å®š node ä¸º notready çŠ¶æ€ï¼Œè¿™æ®µæ—¶é•¿é€šè¿‡â€“node-monitor-grace-periodå‚æ•°é…ç½®ï¼Œé»˜è®¤ 40sã€‚</li><li>å½“ node å¤±è”ä¸€æ®µæ—¶é—´åï¼Œkubernetes åˆ¤å®š node ä¸º unhealthy çŠ¶æ€ï¼Œè¿™æ®µæ—¶é•¿é€šè¿‡â€“node-startup-grace-periodå‚æ•°é…ç½®ï¼Œé»˜è®¤ 1m0sã€‚</li><li>å½“ node å¤±è”ä¸€æ®µæ—¶é—´åï¼Œkubernetes å¼€å§‹åˆ é™¤åŸ node ä¸Šçš„ podï¼Œè¿™æ®µæ—¶é•¿æ˜¯é€šè¿‡â€“pod-eviction-timeoutå‚æ•°é…ç½®ï¼Œé»˜è®¤ 5m0sã€‚</li></ul><blockquote><p>kube-controller-manager å’Œ kubelet æ˜¯å¼‚æ­¥å·¥ä½œçš„ï¼Œè¿™æ„å‘³ç€å»¶è¿Ÿå¯èƒ½åŒ…æ‹¬ä»»ä½•çš„ç½‘ç»œå»¶è¿Ÿã€apiserver çš„å»¶è¿Ÿã€etcd å»¶è¿Ÿï¼Œä¸€ä¸ªèŠ‚ç‚¹ä¸Šçš„è´Ÿè½½å¼•èµ·çš„å»¶è¿Ÿç­‰ç­‰ã€‚å› æ­¤ï¼Œå¦‚æœâ€“node-status-update-frequencyè®¾ç½®ä¸º5sï¼Œé‚£ä¹ˆå®é™…ä¸Š etcd ä¸­çš„æ•°æ®å˜åŒ–ä¼šéœ€è¦ 6-7sï¼Œç”šè‡³æ›´é•¿æ—¶é—´ã€‚</p></blockquote><p>å¯åŠ¨å‚æ•°æ§åˆ¶evictionï¼š</p><ul><li><strong>pod-eviction-timeoutï¼š</strong>å³å½“èŠ‚ç‚¹å®•æœºè¯¥æ—¶é—´é—´éš”åï¼Œå¼€å§‹evictionæœºåˆ¶ï¼Œé©±èµ¶å®•æœºèŠ‚ç‚¹ä¸Šçš„Podï¼Œé»˜è®¤ä¸º5minã€‚</li><li><strong>node-eviction-rateï¼š</strong>é©±èµ¶é€Ÿç‡ï¼Œå³é©±èµ¶Nodeçš„é€Ÿç‡ï¼Œç”±ä»¤ç‰Œæ¡¶æµæ§ç®—æ³•å®ç°ï¼Œé»˜è®¤ä¸º0.1ï¼Œå³æ¯ç§’é©±èµ¶0.1ä¸ªèŠ‚ç‚¹ï¼Œæ³¨æ„è¿™é‡Œä¸æ˜¯é©±èµ¶Podçš„é€Ÿç‡ï¼Œè€Œæ˜¯é©±èµ¶èŠ‚ç‚¹çš„é€Ÿç‡ã€‚ç›¸å½“äºæ¯éš”10sï¼Œæ¸…ç©ºä¸€ä¸ªèŠ‚ç‚¹ã€‚</li><li><strong>secondary-node-eviction-rateï¼š</strong>äºŒçº§é©±èµ¶é€Ÿç‡ï¼Œå½“é›†ç¾¤ä¸­å®•æœºèŠ‚ç‚¹è¿‡å¤šæ—¶ï¼Œç›¸åº”çš„é©±èµ¶é€Ÿç‡ä¹Ÿé™ä½ï¼Œé»˜è®¤ä¸º0.01ã€‚</li><li><strong>unhealthy-zone-thresholdï¼š</strong>ä¸å¥åº·zoneé˜ˆå€¼ï¼Œä¼šå½±å“ä»€ä¹ˆæ—¶å€™å¼€å¯äºŒçº§é©±èµ¶é€Ÿç‡ï¼Œé»˜è®¤ä¸º0.55ï¼Œå³å½“è¯¥zoneä¸­èŠ‚ç‚¹å®•æœºæ•°ç›®è¶…è¿‡55%ï¼Œè€Œè®¤ä¸ºè¯¥zoneä¸å¥åº·ã€‚</li><li><strong>large-cluster-size-thresholdï¼š</strong>å¤§é›†ç¾¤é˜ˆå€¼ï¼Œå½“è¯¥zoneçš„èŠ‚ç‚¹å¤šä½™è¯¥é˜ˆå€¼æ—¶ï¼Œåˆ™è®¤ä¸ºè¯¥zoneæ˜¯ä¸€ä¸ªå¤§é›†ç¾¤ã€‚å¤§é›†ç¾¤èŠ‚ç‚¹å®•æœºæ•°ç›®è¶…è¿‡55%æ—¶ï¼Œåˆ™å°†é©±èµ¶é€Ÿç‡é™ä¸º0.01ï¼Œå‡å¦‚æ˜¯å°é›†ç¾¤ï¼Œåˆ™å°†é€Ÿç‡ç›´æ¥é™ä¸º0ã€‚</li></ul><p>ç¤¾åŒºé»˜è®¤çš„é…ç½®ï¼š</p><table><thead><tr><th>å‚æ•°</th><th>å€¼</th></tr></thead><tbody><tr><td>â€“node-status-update-frequency</td><td>10s</td></tr><tr><td>â€“node-monitor-period</td><td>5s</td></tr><tr><td>â€“node-monitor-grace-period</td><td>40s</td></tr><tr><td>â€“pod-eviction-timeout</td><td>5m</td></tr></tbody></table><h3 id="kubeletåŸºäºèŠ‚ç‚¹å‹åŠ›evictionæœºåˆ¶"><a href="#kubeletåŸºäºèŠ‚ç‚¹å‹åŠ›evictionæœºåˆ¶" class="headerlink" title="kubeletåŸºäºèŠ‚ç‚¹å‹åŠ›evictionæœºåˆ¶"></a>kubeletåŸºäºèŠ‚ç‚¹å‹åŠ›evictionæœºåˆ¶</h3><p>å¦‚æœèŠ‚ç‚¹å¤„äºèµ„æºå‹åŠ›ï¼Œé‚£ä¹ˆkubeletå°±ä¼šæ‰§è¡Œé©±é€ç­–ç•¥ã€‚é©±é€ä¼šè€ƒè™‘Podçš„ä¼˜å…ˆçº§ï¼Œèµ„æºä½¿ç”¨å’Œèµ„æºç”³è¯·ã€‚å½“ä¼˜å…ˆçº§ç›¸åŒæ—¶ï¼Œèµ„æºä½¿ç”¨&#x2F;èµ„æºç”³è¯·æœ€å¤§çš„Podä¼šè¢«é¦–å…ˆé©±é€ï¼Œæ›´å¤šè¯¦æƒ…å¯ä»¥å‚è€ƒ<a href="https://kubernetes.io/docs/concepts/scheduling-eviction/node-pressure-eviction/">å®˜æ–¹æ–‡æ¡£</a></p><p>kubeletæä¾›äº†ä»¥ä¸‹å‚æ•°æ§åˆ¶evictionï¼š</p><ul><li><strong>eviction-softï¼š</strong>è½¯é©±é€é˜ˆå€¼è®¾ç½®ï¼Œå…·æœ‰ä¸€ç³»åˆ—é˜ˆå€¼ï¼Œæ¯”å¦‚memory.available&lt;1.5Giæ—¶ï¼Œå®ƒä¸ä¼šç«‹å³æ‰§è¡Œpod evictionï¼Œè€Œä¼šç­‰å¾…eviction-soft-grace-periodæ—¶é—´ï¼Œå‡å¦‚è¯¥æ—¶é—´è¿‡åï¼Œä¾ç„¶è¿˜æ˜¯è¾¾åˆ°äº†eviction-softï¼Œåˆ™è§¦å‘ä¸€æ¬¡pod evictionã€‚</li><li><strong>eviction-soft-grace-periodï¼š</strong>é»˜è®¤ä¸º90ç§’ï¼Œå½“eviction-softæ—¶ï¼Œç»ˆæ­¢Podçš„graceçš„æ—¶é—´ï¼Œå³è½¯é©±é€å®½é™æœŸï¼Œè½¯é©±é€ä¿¡å·ä¸é©±é€å¤„ç†ä¹‹é—´çš„æ—¶é—´å·®ã€‚</li><li><strong>eviction-max-pod-grace-periodï¼š</strong>æœ€å¤§é©±é€podå®½é™æœŸï¼Œåœæ­¢ä¿¡å·ä¸killä¹‹é—´çš„æ—¶é—´å·®ã€‚</li><li><strong>eviction-pressure-transition-periodï¼š</strong>é»˜è®¤ä¸º5åˆ†é’Ÿï¼Œè„±ç¦»pressure conditionçš„æ—¶é—´ï¼Œè¶…è¿‡é˜ˆå€¼æ—¶ï¼ŒèŠ‚ç‚¹ä¼šè¢«è®¾ç½®ä¸ºmemory pressureæˆ–è€…disk pressureï¼Œç„¶åå¼€å¯pod evictionã€‚</li><li><strong>eviction-minimum-reclaimï¼š</strong>è¡¨ç¤ºæ¯ä¸€æ¬¡evictionå¿…é¡»è‡³å°‘å›æ”¶å¤šå°‘èµ„æºã€‚</li><li><strong>eviction-hard****ï¼š</strong>å¼ºåˆ¶é©±é€è®¾ç½®ï¼Œä¹Ÿå…·æœ‰ä¸€ç³»åˆ—çš„é˜ˆå€¼ï¼Œæ¯”å¦‚memory.available&lt;1Giï¼Œå³å½“èŠ‚ç‚¹å¯ç”¨å†…å­˜ä½äº1Giæ—¶ï¼Œä¼šç«‹å³è§¦å‘ä¸€æ¬¡pod evictionã€‚</li></ul><h3 id="é©±é€é—®é¢˜å¤„ç†"><a href="#é©±é€é—®é¢˜å¤„ç†" class="headerlink" title="é©±é€é—®é¢˜å¤„ç†"></a>é©±é€é—®é¢˜å¤„ç†</h3><p>1ï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å‘ç°å¾ˆå¤špodçš„çŠ¶æ€ä¸ºEvictedï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl get pods   -o wide --all-namespaces | grep -i Evicted<br></code></pre></td></tr></table></figure><p>2ï¼Œåœ¨èŠ‚ç‚¹çš„kubeletæ—¥å¿—ä¸­ä¼šè®°å½•Evictedç›¸å…³å†…å®¹ï¼Œæœç´¢æ–¹æ³•å¯å‚è€ƒå¦‚ä¸‹å‘½ä»¤ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">journalctl  -u kubelet | grep -i Evicted -C3<br></code></pre></td></tr></table></figure><p>3ï¼ŒæŸ¥çœ‹èŠ‚ç‚¹ç›‘æ§æ˜¯å¦æœ‰å†…å­˜æ‰“æ»¡æˆ–è€… èŠ‚ç‚¹ç£ç›˜</p><p>4ï¼Œæ¸…ç†å¼‚å¸¸çŠ¶æ€Evictedçš„POD</p><blockquote><p><namespace>  ä¸ºå‘½åç©ºé—´åç§°ï¼Œè¯·æ ¹æ®éœ€è¦æŒ‡å®šã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl get pods &lt;namespace&gt; | grep Evicted | awk <span class="hljs-string">&#x27;&#123;print $1&#125;&#x27;</span> | xargs kubectl delete pod &lt;namespace&gt; <br></code></pre></td></tr></table></figure><p>æˆ–è€…ä½¿ç”¨è¿™ä¸ªå‘½ä»¤æ¸…ç†æ‰€æœ‰å‘½åç©ºé—´é©±é€çŠ¶æ€çš„POD</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl get pod -o wide --all-namespaces | awk <span class="hljs-string">&#x27;&#123;if($4==&quot;Evicted&quot;)&#123;cmd=&quot;kubectl -n &quot;$1&quot; delete pod &quot;$2; system(cmd)&#125;&#125;&#x27;</span><br></code></pre></td></tr></table></figure><p>5ï¼Œpodé©±é€åï¼Œå¦‚æœæ–°è°ƒåº¦åˆ°çš„èŠ‚ç‚¹ä¹Ÿæœ‰é©±é€æƒ…å†µï¼Œå°±ä¼šå†æ¬¡è¢«é©±é€ï¼›ç”šè‡³å‡ºç°podä¸æ–­è¢«é©±é€çš„æƒ…å†µ,ï¼Œéœ€è¦ç¡®ä¿é›†ç¾¤èµ„æºå……è¶³</p><p>6ï¼Œå¦‚æœæ˜¯ç”±kube-controller-managerè§¦å‘çš„é©±é€ï¼Œä¼šç•™ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸ºTerminatingçš„podï¼›ç›´åˆ°å®¹å™¨æ‰€åœ¨èŠ‚ç‚¹çŠ¶æ€æ¢å¤åï¼Œpodæ‰ä¼šè‡ªåŠ¨åˆ é™¤ã€‚å¦‚æœèŠ‚ç‚¹å·²ç»åˆ é™¤æˆ–è€…å…¶ä»–åŸå› å¯¼è‡´çš„æ— æ³•æ¢å¤ï¼Œå¯ä»¥ä½¿ç”¨â€œå¼ºåˆ¶åˆ é™¤â€åˆ é™¤podï¼Œ</p><p>7ï¼Œå¦‚æœæ˜¯ç”±kubeletè§¦å‘çš„é©±é€ï¼Œä¼šç•™ä¸‹ä¸€ä¸ªçŠ¶æ€ä¸ºEvictedçš„podï¼Œæ­¤podåªæ˜¯æ–¹ä¾¿åæœŸå®šä½çš„è®°å½•ï¼Œå¯ä»¥ç›´æ¥åˆ é™¤ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesä¸­èŠ‚ç‚¹å‹åŠ›é©±é€æœºåˆ¶</title>
      <link href="/post/3d95a7a0.html"/>
      <url>/post/3d95a7a0.html</url>
      
        <content type="html"><![CDATA[<h2 id="K8SèŠ‚ç‚¹å‹åŠ›é©±é€åŸç†"><a href="#K8SèŠ‚ç‚¹å‹åŠ›é©±é€åŸç†" class="headerlink" title="K8SèŠ‚ç‚¹å‹åŠ›é©±é€åŸç†"></a>K8SèŠ‚ç‚¹å‹åŠ›é©±é€åŸç†</h2><p>èŠ‚ç‚¹å‹åŠ›é©±é€æ˜¯ <a href="https://kubernetes.io/docs/reference/generated/kubelet">kubelet</a> ä¸»åŠ¨ç»ˆæ­¢ Pod ä»¥å›æ”¶èŠ‚ç‚¹ä¸Šèµ„æºçš„è¿‡ç¨‹ã€‚<br><a href="https://kubernetes.io/docs/reference/generated/kubelet">kubelet</a> ç›‘æ§é›†ç¾¤èŠ‚ç‚¹çš„ CPUã€å†…å­˜ã€ç£ç›˜ç©ºé—´å’Œæ–‡ä»¶ç³»ç»Ÿçš„ inode ç­‰èµ„æºã€‚ å½“è¿™äº›èµ„æºä¸­çš„ä¸€ä¸ªæˆ–è€…å¤šä¸ªè¾¾åˆ°ç‰¹å®šçš„æ¶ˆè€—æ°´å¹³ï¼Œ kubelet å¯ä»¥ä¸»åŠ¨åœ°ä½¿èŠ‚ç‚¹ä¸Šä¸€ä¸ªæˆ–è€…å¤šä¸ª Pod å¤±æ•ˆï¼Œä»¥å›æ”¶èµ„æºé˜²æ­¢èŠ‚ç‚¹å´©æºƒã€‚<br>åœ¨èŠ‚ç‚¹å‹åŠ›é©±é€æœŸé—´ï¼Œkubelet å°†æ‰€é€‰ Pod çš„ PodPhase è®¾ç½®ä¸º FailedçŠ¶æ€ã€‚è¿™å°†ç»ˆæ­¢ Podï¼ŒèŠ‚ç‚¹å‹åŠ›é©±é€ä¸åŒäº <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/api-eviction/">API å‘èµ·çš„é©±é€</a>ã€‚<br>kubelet å¹¶ä¸ç†ä¼šä½ é…ç½®çš„ PodDisruptionBudget æˆ–è€…æ˜¯ Pod çš„ terminationGracePeriodSecondsã€‚ å¦‚æœä½ ä½¿ç”¨äº†<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/#soft-eviction-thresholds">è½¯é©±é€æ¡ä»¶</a>ï¼Œkubelet ä¼šè€ƒè™‘ä½ æ‰€é…ç½®çš„ eviction-max-pod-grace-periodã€‚ å¦‚æœä½ ä½¿ç”¨äº†<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/#hard-eviction-thresholds">ç¡¬é©±é€æ¡ä»¶</a>ï¼Œå®ƒä½¿ç”¨ 0s å®½é™æœŸæ¥ç»ˆæ­¢ Podã€‚<br>å¦‚æœ Pod æ˜¯é«˜çº§èµ„æºå¯¹è±¡ç®¡ç†çš„POD ï¼ˆä¾‹å¦‚ <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/statefulset/">StatefulSet</a> æˆ–è€… <a href="https://kubernetes.io/zh-cn/docs/concepts/workloads/controllers/deployment/">Deployment</a>ï¼‰ç®¡ç†ï¼Œ åˆ™æ§åˆ¶å¹³é¢æˆ– kube-controller-manager ä¼šåœ¨å…¶ä»–èŠ‚ç‚¹ä¸Šåˆ›å»ºæ–°çš„ Pod æ¥ä»£æ›¿è¢«é©±é€çš„ Podã€‚</p><blockquote><p>è¯´æ˜ï¼škubelet åœ¨é©±é€Pod ä¹‹å‰ä¼šå°è¯•<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/#reclaim-node-resources">å›æ”¶èŠ‚ç‚¹çº§èµ„æº</a>ã€‚ ä¾‹å¦‚ï¼Œå®ƒä¼šåœ¨ç£ç›˜èµ„æºä¸è¶³æ—¶åˆ é™¤æœªä½¿ç”¨çš„å®¹å™¨é•œåƒã€‚</p></blockquote><p>kubelet ä½¿ç”¨å„ç§å‚æ•°æ¥åšå‡ºé©±é€å†³å®šï¼Œå¦‚ä¸‹æ‰€ç¤ºï¼š</p><ul><li>é©±é€ä¿¡å·</li><li>é©±é€æ¡ä»¶</li><li>ç›‘æ§é—´éš”</li></ul><h3 id="é©±é€ä¿¡å·"><a href="#é©±é€ä¿¡å·" class="headerlink" title="é©±é€ä¿¡å·"></a>é©±é€ä¿¡å·</h3><p>é©±é€ä¿¡å·æ˜¯ç‰¹å®šèµ„æºåœ¨ç‰¹å®šæ—¶é—´ç‚¹çš„å½“å‰çŠ¶æ€ã€‚ kubelet ä½¿ç”¨é©±é€ä¿¡å·ï¼Œé€šè¿‡å°†ä¿¡å·ä¸é©±é€æ¡ä»¶è¿›è¡Œæ¯”è¾ƒæ¥åšå‡ºé©±é€å†³å®šï¼Œ é©±é€æ¡ä»¶æ˜¯èŠ‚ç‚¹ä¸Šåº”è¯¥å¯ç”¨èµ„æºçš„æœ€å°é‡ã€‚</p><p>kubelet ä½¿ç”¨ä»¥ä¸‹é©±é€ä¿¡å·ï¼š</p><table><thead><tr><th>é©±é€ä¿¡å·</th><th>æè¿°</th></tr></thead><tbody><tr><td>memory.available</td><td>memory.available :&#x3D; node.status.capacity[memory] - node.stats.memory.workingSet</td></tr><tr><td>nodefs.available</td><td>nodefs.available :&#x3D; node.stats.fs.available</td></tr><tr><td>nodefs.inodesFree</td><td>nodefs.inodesFree :&#x3D; node.stats.fs.inodesFree</td></tr><tr><td>imagefs.available</td><td>imagefs.available :&#x3D; node.stats.runtime.imagefs.available</td></tr><tr><td>imagefs.inodesFree</td><td>imagefs.inodesFree :&#x3D; node.stats.runtime.imagefs.inodesFree</td></tr><tr><td>pid.available</td><td>pid.available :&#x3D; node.stats.rlimit.maxpid - node.stats.rlimit.curproc</td></tr></tbody></table><p>åœ¨ä¸Šè¡¨ä¸­ï¼Œæè¿°åˆ—æ˜¾ç¤ºäº† kubelet å¦‚ä½•è·å–ä¿¡å·çš„å€¼ã€‚æ¯ä¸ªä¿¡å·æ”¯æŒç™¾åˆ†æ¯”å€¼æˆ–è€…æ˜¯å­—é¢å€¼ã€‚ kubelet è®¡ç®—ç›¸å¯¹äºä¸ä¿¡å·æœ‰å…³çš„æ€»é‡çš„ç™¾åˆ†æ¯”å€¼ã€‚</p><p><strong>memory.available çš„å€¼æ¥è‡ª cgroupfsï¼Œè€Œä¸æ˜¯å–è‡ª free -m è¿™æ ·çš„å·¥å…·ï¼Œè¿™å¾ˆé‡è¦</strong>ï¼Œå› ä¸º free -m åœ¨å®¹å™¨ä¸­ä¸èµ·ä½œç”¨ï¼Œå¦‚æœç”¨æˆ·ä½¿ç”¨ <a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/reserve-compute-resources/#node-allocatable">èŠ‚ç‚¹å¯åˆ†é…èµ„æº</a> è¿™ä¸€åŠŸèƒ½ç‰¹æ€§ï¼Œèµ„æºä¸è¶³çš„åˆ¤å®šæ˜¯åŸºäº cgroup å±‚æ¬¡ç»“æ„ä¸­çš„ç”¨æˆ· Pod æ‰€å¤„çš„å±€éƒ¨åŠ cgroup æ ¹èŠ‚ç‚¹ä½œå‡ºçš„ã€‚ è¿™ä¸ª<a href="https://kubernetes.io/zh-cn/examples/admin/resource/memory-available.sh">è„šæœ¬</a> é‡ç°äº† kubelet ä¸ºè®¡ç®— memory.available è€Œæ‰§è¡Œçš„ç›¸åŒæ­¥éª¤ã€‚ kubelet åœ¨å…¶è®¡ç®—ä¸­æ’é™¤äº† inactive_fileï¼ˆå³éæ´»åŠ¨ LRU åˆ—è¡¨ä¸ŠåŸºäºæ–‡ä»¶æ¥è™šæ‹Ÿçš„å†…å­˜çš„å­—èŠ‚æ•°ï¼‰ï¼Œ å› ä¸ºå®ƒå‡å®šåœ¨å‹åŠ›ä¸‹å†…å­˜æ˜¯å¯å›æ”¶çš„ã€‚</p><p>kubelet æ”¯æŒä»¥ä¸‹æ–‡ä»¶ç³»ç»Ÿåˆ†åŒºï¼š</p><ol><li>nodefsï¼šèŠ‚ç‚¹çš„ä¸»è¦æ–‡ä»¶ç³»ç»Ÿï¼Œç”¨äºæœ¬åœ°ç£ç›˜å·ã€emptyDirã€æ—¥å¿—å­˜å‚¨ç­‰ã€‚ ä¾‹å¦‚ï¼Œnodefs åŒ…å« &#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;ã€‚</li><li>imagefsï¼šå¯é€‰æ–‡ä»¶ç³»ç»Ÿï¼Œä¾›å®¹å™¨è¿è¡Œæ—¶å­˜å‚¨å®¹å™¨é•œåƒå’Œå®¹å™¨å¯å†™å±‚ã€‚</li></ol><p>å½“ nodefs ç”¨é‡åˆ°è¾¾é˜ˆå€¼ï¼ŒKubelet ä¼šé€‰æ‹©æ€§çš„é©±é€ Podï¼ˆåŠå…¶å®¹å™¨ï¼‰æ¥é‡Šæ”¾ç©ºé—´ã€‚</p><p>å½“ imagefs ç”¨é‡åˆ°è¾¾é©±é€é˜ˆå€¼ï¼ŒKubelet ä¼šåˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼Œé‡Šæ”¾ç©ºé—´ã€‚</p><h3 id="é©±é€æ¡ä»¶"><a href="#é©±é€æ¡ä»¶" class="headerlink" title="é©±é€æ¡ä»¶"></a>é©±é€æ¡ä»¶</h3><p>ä½ å¯ä»¥ä¸º kubelet æŒ‡å®šè‡ªå®šä¹‰é©±é€æ¡ä»¶ï¼Œä»¥ä¾¿åœ¨ä½œå‡ºé©±é€å†³å®šæ—¶ä½¿ç”¨ã€‚</p><p>é©±é€æ¡ä»¶çš„å½¢å¼ä¸º [eviction-signal][operator][quantity]ï¼Œå…¶ä¸­ï¼š</p><ul><li>eviction-signal æ˜¯è¦ä½¿ç”¨çš„<a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/node-pressure-eviction/#eviction-signals">é©±é€ä¿¡å·</a>ã€‚</li><li>operator æ˜¯ä½ æƒ³è¦çš„<a href="https://en.wikipedia.org/wiki/Relational_operator#Standard_relational_operators">å…³ç³»è¿ç®—ç¬¦</a>ï¼Œ æ¯”å¦‚ &lt;ï¼ˆå°äºï¼‰ã€‚</li><li>quantity æ˜¯é©±é€æ¡ä»¶æ•°é‡ï¼Œä¾‹å¦‚ 1Giã€‚ quantity çš„å€¼å¿…é¡»ä¸ Kubernetes ä½¿ç”¨çš„æ•°é‡è¡¨ç¤ºç›¸åŒ¹é…ã€‚ ä½ å¯ä»¥ä½¿ç”¨æ–‡å­—å€¼æˆ–ç™¾åˆ†æ¯”ï¼ˆ%ï¼‰ã€‚</li></ul><p>ä¾‹å¦‚ï¼Œå¦‚æœä¸€ä¸ªèŠ‚ç‚¹çš„æ€»å†…å­˜ä¸º 10Gi å¹¶ä¸”ä½ å¸Œæœ›åœ¨å¯ç”¨å†…å­˜ä½äº 1Gi æ—¶è§¦å‘é©±é€ï¼Œ åˆ™å¯ä»¥å°†é©±é€æ¡ä»¶å®šä¹‰ä¸º memory.available&lt;10% æˆ– memory.available&lt; 1Gã€‚ ä½ ä¸èƒ½åŒæ—¶ä½¿ç”¨äºŒè€…ã€‚</p><p>ä½ å¯ä»¥é…ç½®è½¯å’Œç¡¬é©±é€æ¡ä»¶ã€‚</p><h4 id="è½¯é©±é€æ¡ä»¶"><a href="#è½¯é©±é€æ¡ä»¶" class="headerlink" title="è½¯é©±é€æ¡ä»¶"></a>è½¯é©±é€æ¡ä»¶</h4><p>è½¯é©±é€æ¡ä»¶å°†é©±é€æ¡ä»¶ä¸ç”¨æˆ·æ‰€å¿…é¡»æŒ‡å®šçš„å®½é™æœŸé…å¯¹ã€‚ åœ¨è¶…è¿‡å®½é™æœŸä¹‹å‰ï¼Œkubelet ä¸ä¼šé©±é€ Podã€‚ å¦‚æœæ²¡æœ‰æŒ‡å®šçš„å®½é™æœŸï¼Œkubelet ä¼šåœ¨å¯åŠ¨æ—¶è¿”å›é”™è¯¯ã€‚ä½ å¯ä»¥æ—¢æŒ‡å®šè½¯é©±é€æ¡ä»¶å®½é™æœŸï¼ŒåˆæŒ‡å®š Pod ç»ˆæ­¢å®½é™æœŸçš„ä¸Šé™ï¼Œç»™ kubelet åœ¨é©±é€æœŸé—´ä½¿ç”¨ã€‚ å¦‚æœä½ æŒ‡å®šäº†å®½é™æœŸçš„ä¸Šé™å¹¶ä¸” Pod æ»¡è¶³è½¯é©±é€é˜ˆæ¡ä»¶ï¼Œåˆ™ kubelet å°†ä½¿ç”¨ä¸¤ä¸ªå®½é™æœŸä¸­çš„è¾ƒå°è€…ã€‚ å¦‚æœä½ æ²¡æœ‰æŒ‡å®šå®½é™æœŸä¸Šé™ï¼Œkubelet ä¼šç«‹å³æ€æ­»è¢«é©±é€çš„ Podï¼Œä¸å…è®¸å…¶ä½“é¢ç»ˆæ­¢ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ä»¥ä¸‹æ ‡å¿—æ¥é…ç½®è½¯é©±é€æ¡ä»¶ï¼š</p><ul><li>eviction-softï¼šä¸€ç»„é©±é€æ¡ä»¶ï¼Œå¦‚ memory.available&lt;1.5Giï¼Œ å¦‚æœé©±é€æ¡ä»¶æŒç»­æ—¶é•¿è¶…è¿‡æŒ‡å®šçš„å®½é™æœŸï¼Œå¯ä»¥è§¦å‘ Pod é©±é€ã€‚</li><li>eviction-soft-grace-periodï¼šä¸€ç»„é©±é€å®½é™æœŸï¼Œ å¦‚ memory.available&#x3D;1m30sï¼Œå®šä¹‰è½¯é©±é€æ¡ä»¶åœ¨è§¦å‘ Pod é©±é€ä¹‹å‰å¿…é¡»ä¿æŒå¤šé•¿æ—¶é—´ã€‚</li><li>eviction-max-pod-grace-periodï¼šåœ¨æ»¡è¶³è½¯é©±é€æ¡ä»¶è€Œç»ˆæ­¢ Pod æ—¶ä½¿ç”¨çš„æœ€å¤§å…è®¸å®½é™æœŸï¼ˆä»¥ç§’ä¸ºå•ä½ï¼‰ã€‚</li></ul><h4 id="ç¡¬é©±é€æ¡ä»¶"><a href="#ç¡¬é©±é€æ¡ä»¶" class="headerlink" title="ç¡¬é©±é€æ¡ä»¶"></a>ç¡¬é©±é€æ¡ä»¶</h4><p>ç¡¬é©±é€æ¡ä»¶æ²¡æœ‰å®½é™æœŸã€‚å½“è¾¾åˆ°ç¡¬é©±é€æ¡ä»¶æ—¶ï¼Œ kubelet ä¼šç«‹å³æ€æ­» podï¼Œè€Œä¸ä¼šæ­£å¸¸ç»ˆæ­¢ä»¥å›æ”¶ç´§ç¼ºçš„èµ„æºã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ eviction-hard æ ‡å¿—æ¥é…ç½®ä¸€ç»„ç¡¬é©±é€æ¡ä»¶ï¼Œ ä¾‹å¦‚ memory.available&lt;1Giã€‚</p><p>kubelet å…·æœ‰ä»¥ä¸‹é»˜è®¤ç¡¬é©±é€æ¡ä»¶ï¼š</p><ul><li>memory.available&lt;100Mi</li><li>nodefs.available&lt;10%</li><li>imagefs.available&lt;15%</li><li>nodefs.inodesFree&lt;5%ï¼ˆLinux èŠ‚ç‚¹ï¼‰</li></ul><blockquote><p>é©±é€ç›‘æµ‹é—´éš”ï¼š kubelet æ ¹æ®å…¶é…ç½®çš„ housekeeping-intervalï¼ˆé»˜è®¤ä¸º 10sï¼‰è¯„ä¼°é©±é€æ¡ä»¶ã€‚</p></blockquote><h4 id="èŠ‚ç‚¹æ¡ä»¶"><a href="#èŠ‚ç‚¹æ¡ä»¶" class="headerlink" title="èŠ‚ç‚¹æ¡ä»¶"></a>èŠ‚ç‚¹æ¡ä»¶</h4><p>kubelet æŠ¥å‘ŠèŠ‚ç‚¹çŠ¶å†µä»¥åæ˜ èŠ‚ç‚¹å¤„äºå‹åŠ›ä¹‹ä¸‹ï¼Œå› ä¸ºæ»¡è¶³ç¡¬æˆ–è½¯é©±é€æ¡ä»¶ï¼Œä¸é…ç½®çš„å®½é™æœŸæ— å…³ã€‚</p><p>kubelet æ ¹æ®ä¸‹è¡¨å°†é©±é€ä¿¡å·æ˜ å°„ä¸ºèŠ‚ç‚¹çŠ¶å†µï¼š</p><table><thead><tr><th>èŠ‚ç‚¹æ¡ä»¶</th><th>é©±é€ä¿¡å·</th><th>æè¿°</th></tr></thead><tbody><tr><td>MemoryPressure</td><td>memory.available</td><td>èŠ‚ç‚¹ä¸Šçš„å¯ç”¨å†…å­˜å·²æ»¡è¶³é©±é€æ¡ä»¶</td></tr><tr><td>DiskPressure</td><td>nodefs.availableã€nodefs.inodesFreeã€imagefs.available æˆ– imagefs.inodesFree</td><td>èŠ‚ç‚¹çš„æ ¹æ–‡ä»¶ç³»ç»Ÿæˆ–é•œåƒæ–‡ä»¶ç³»ç»Ÿä¸Šçš„å¯ç”¨ç£ç›˜ç©ºé—´å’Œ inode å·²æ»¡è¶³é©±é€æ¡ä»¶</td></tr><tr><td>PIDPressure</td><td>pid.available</td><td>(Linux) èŠ‚ç‚¹ä¸Šçš„å¯ç”¨è¿›ç¨‹æ ‡è¯†ç¬¦å·²ä½äºé©±é€æ¡ä»¶</td></tr></tbody></table><p>kubelet æ ¹æ®é…ç½®çš„ â€“node-status-update-frequency æ›´æ–°èŠ‚ç‚¹æ¡ä»¶ï¼Œé»˜è®¤ä¸º 10sã€‚</p><blockquote><p>èŠ‚ç‚¹æ¡ä»¶æŒ¯è¡</p><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼ŒèŠ‚ç‚¹åœ¨è½¯é©±é€æ¡ä»¶ä¸Šä¸‹æŒ¯è¡ï¼Œè€Œæ²¡æœ‰ä¿æŒå®šä¹‰çš„å®½é™æœŸã€‚ è¿™ä¼šå¯¼è‡´æŠ¥å‘Šçš„èŠ‚ç‚¹æ¡ä»¶åœ¨ true å’Œ false ä¹‹é—´ä¸æ–­åˆ‡æ¢ï¼Œä»è€Œå¯¼è‡´é”™è¯¯çš„é©±é€å†³ç­–ã€‚</p><p>ä¸ºäº†é˜²æ­¢æŒ¯è¡ï¼Œä½ å¯ä»¥ä½¿ç”¨ eviction-pressure-transition-period æ ‡å¿—ï¼Œ è¯¥æ ‡å¿—æ§åˆ¶ kubelet åœ¨å°†èŠ‚ç‚¹æ¡ä»¶è½¬æ¢ä¸ºä¸åŒçŠ¶æ€ä¹‹å‰å¿…é¡»ç­‰å¾…çš„æ—¶é—´ã€‚ è¿‡æ¸¡æœŸçš„é»˜è®¤å€¼ä¸º 5mã€‚</p></blockquote><h3 id="å›æ”¶èŠ‚ç‚¹çº§èµ„æº"><a href="#å›æ”¶èŠ‚ç‚¹çº§èµ„æº" class="headerlink" title="å›æ”¶èŠ‚ç‚¹çº§èµ„æº"></a>å›æ”¶èŠ‚ç‚¹çº§èµ„æº</h3><p>kubelet åœ¨é©±é€æœ€ç»ˆç”¨æˆ· Pod ä¹‹å‰ä¼šå…ˆå°è¯•å›æ”¶èŠ‚ç‚¹çº§èµ„æºã€‚</p><p>å½“æŠ¥å‘Š DiskPressure èŠ‚ç‚¹çŠ¶å†µæ—¶ï¼Œkubelet ä¼šæ ¹æ®èŠ‚ç‚¹ä¸Šçš„æ–‡ä»¶ç³»ç»Ÿå›æ”¶èŠ‚ç‚¹çº§èµ„æºã€‚</p><ul><li><strong>æœ‰ imagefs</strong></li></ul><p>å¦‚æœèŠ‚ç‚¹æœ‰ä¸€ä¸ªä¸“ç”¨çš„ imagefs æ–‡ä»¶ç³»ç»Ÿä¾›å®¹å™¨è¿è¡Œæ—¶ä½¿ç”¨ï¼Œkubelet ä¼šæ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><ul><li><p>å¦‚æœ nodefs æ–‡ä»¶ç³»ç»Ÿæ»¡è¶³é©±é€æ¡ä»¶ï¼Œkubelet åƒåœ¾æ”¶é›†æ­»äº¡ Pod å’Œå®¹å™¨ã€‚</p></li><li><p>å¦‚æœ imagefs æ–‡ä»¶ç³»ç»Ÿæ»¡è¶³é©±é€æ¡ä»¶ï¼Œkubelet å°†åˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒã€‚</p></li><li><p><strong>æ²¡æœ‰ imagefs</strong></p></li></ul><p>å¦‚æœèŠ‚ç‚¹åªæœ‰ä¸€ä¸ªæ»¡è¶³é©±é€æ¡ä»¶çš„ nodefs æ–‡ä»¶ç³»ç»Ÿï¼Œ kubelet æŒ‰ä»¥ä¸‹é¡ºåºé‡Šæ”¾ç£ç›˜ç©ºé—´ï¼š</p><ol><li>å¯¹æ­»äº¡çš„ Pod å’Œå®¹å™¨è¿›è¡Œåƒåœ¾æ”¶é›†</li><li>åˆ é™¤æœªä½¿ç”¨çš„é•œåƒ</li></ol><h3 id="kubelet-é©±é€æ—¶-Pod-çš„é€‰æ‹©"><a href="#kubelet-é©±é€æ—¶-Pod-çš„é€‰æ‹©" class="headerlink" title="kubelet é©±é€æ—¶ Pod çš„é€‰æ‹©"></a>kubelet é©±é€æ—¶ Pod çš„é€‰æ‹©</h3><p>å¦‚æœ kubelet å›æ”¶èŠ‚ç‚¹çº§èµ„æºçš„å°è¯•æ²¡æœ‰ä½¿é©±é€ä¿¡å·ä½äºæ¡ä»¶ï¼Œ åˆ™ kubelet å¼€å§‹é©±é€æœ€ç»ˆç”¨æˆ· Podã€‚</p><p>kubelet ä½¿ç”¨ä»¥ä¸‹å‚æ•°æ¥ç¡®å®š Pod é©±é€é¡ºåºï¼š</p><ol><li>Pod çš„èµ„æºä½¿ç”¨æ˜¯å¦è¶…è¿‡å…¶è¯·æ±‚</li><li><a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/pod-priority-preemption/">Pod ä¼˜å…ˆçº§</a></li><li>Pod ç›¸å¯¹äºè¯·æ±‚çš„èµ„æºä½¿ç”¨æƒ…å†µ</li></ol><p>å› æ­¤ï¼Œkubelet æŒ‰ä»¥ä¸‹é¡ºåºæ’åˆ—å’Œé©±é€ Podï¼š</p><ol><li>é¦–å…ˆè€ƒè™‘èµ„æºä½¿ç”¨é‡è¶…è¿‡å…¶è¯·æ±‚çš„ BestEffort æˆ– Burstable Podã€‚ è¿™äº› Pod ä¼šæ ¹æ®å®ƒä»¬çš„ä¼˜å…ˆçº§ä»¥åŠå®ƒä»¬çš„èµ„æºä½¿ç”¨çº§åˆ«è¶…è¿‡å…¶è¯·æ±‚çš„ç¨‹åº¦è¢«é€å‡ºã€‚</li><li>èµ„æºä½¿ç”¨é‡å°‘äºè¯·æ±‚é‡çš„ Guaranteed Pod å’Œ Burstable Pod æ ¹æ®å…¶ä¼˜å…ˆçº§è¢«æœ€åé©±é€ã€‚</li></ol><blockquote><p>è¯´æ˜ï¼škubelet ä¸ä½¿ç”¨ Pod çš„ QoS ç±»æ¥ç¡®å®šé©±é€é¡ºåºã€‚ åœ¨å›æ”¶å†…å­˜ç­‰èµ„æºæ—¶ï¼Œä½ å¯ä»¥ä½¿ç”¨ QoS ç±»æ¥ä¼°è®¡æœ€å¯èƒ½çš„ Pod é©±é€é¡ºåºã€‚ QoS ä¸é€‚ç”¨äºä¸´æ—¶å­˜å‚¨ï¼ˆEphemeralStorageï¼‰è¯·æ±‚ï¼Œ å› æ­¤å¦‚æœèŠ‚ç‚¹åœ¨ DiskPressure ä¸‹ï¼Œåˆ™ä¸Šè¿°åœºæ™¯å°†ä¸é€‚ç”¨ã€‚</p></blockquote><p>ä»…å½“ Guaranteed Pod ä¸­æ‰€æœ‰å®¹å™¨éƒ½è¢«æŒ‡å®šäº†è¯·æ±‚å’Œé™åˆ¶å¹¶ä¸”äºŒè€…ç›¸ç­‰æ—¶ï¼Œæ‰ä¿è¯ Pod ä¸è¢«é©±é€ã€‚ è¿™äº› Pod æ°¸è¿œä¸ä¼šå› ä¸ºå¦ä¸€ä¸ª Pod çš„èµ„æºæ¶ˆè€—è€Œè¢«é©±é€ã€‚ å¦‚æœç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ï¼ˆä¾‹å¦‚ kubelet å’Œ journaldï¼‰ æ¶ˆè€—çš„èµ„æºæ¯”é€šè¿‡ system-reserved æˆ– kube-reserved åˆ†é…ä¿ç•™çš„èµ„æºå¤šï¼Œ å¹¶ä¸”è¯¥èŠ‚ç‚¹åªæœ‰ Guaranteed æˆ– Burstable Pod ä½¿ç”¨çš„èµ„æºå°‘äºå…¶ä¸Šå‰©ä½™çš„è¯·æ±‚ï¼Œ é‚£ä¹ˆ kubelet å¿…é¡»é€‰æ‹©é©±é€è¿™äº› Pod ä¸­çš„ä¸€ä¸ªä»¥ä¿æŒèŠ‚ç‚¹ç¨³å®šæ€§å¹¶å‡å°‘èµ„æºåŒ®ä¹å¯¹å…¶ä»– Pod çš„å½±å“ã€‚ åœ¨è¿™ç§æƒ…å†µä¸‹ï¼Œå®ƒä¼šé€‰æ‹©é¦–å…ˆé©±é€æœ€ä½ä¼˜å…ˆçº§çš„ Podã€‚</p><p>å½“ kubelet å›  inode æˆ– PID ä¸è¶³è€Œé©±é€ Pod æ—¶ï¼Œ å®ƒä½¿ç”¨ä¼˜å…ˆçº§æ¥ç¡®å®šé©±é€é¡ºåºï¼Œå› ä¸º inode å’Œ PID æ²¡æœ‰è¯·æ±‚ã€‚</p><p>kubelet æ ¹æ®èŠ‚ç‚¹æ˜¯å¦å…·æœ‰ä¸“ç”¨çš„ imagefs æ–‡ä»¶ç³»ç»Ÿå¯¹ Pod è¿›è¡Œä¸åŒçš„æ’åºï¼š</p><ul><li><strong>æœ‰ imagefs</strong></li></ul><p>å¦‚æœ nodefs è§¦å‘é©±é€ï¼Œ kubelet ä¼šæ ¹æ® nodefs ä½¿ç”¨æƒ…å†µï¼ˆæœ¬åœ°å· + æ‰€æœ‰å®¹å™¨çš„æ—¥å¿—ï¼‰å¯¹ Pod è¿›è¡Œæ’åºã€‚</p><p>å¦‚æœ imagefs è§¦å‘é©±é€ï¼Œkubelet ä¼šæ ¹æ®æ‰€æœ‰å®¹å™¨çš„å¯å†™å±‚ä½¿ç”¨æƒ…å†µå¯¹ Pod è¿›è¡Œæ’åºã€‚</p><ul><li><strong>æ²¡æœ‰ imagefs</strong></li></ul><p>å¦‚æœ nodefs è§¦å‘é©±é€ï¼Œ kubelet ä¼šæ ¹æ®ç£ç›˜æ€»ç”¨é‡ï¼ˆæœ¬åœ°å· + æ—¥å¿—å’Œæ‰€æœ‰å®¹å™¨çš„å¯å†™å±‚ï¼‰å¯¹ Pod è¿›è¡Œæ’åºã€‚</p><h3 id="æœ€å°é©±é€å›æ”¶"><a href="#æœ€å°é©±é€å›æ”¶" class="headerlink" title="æœ€å°é©±é€å›æ”¶"></a>æœ€å°é©±é€å›æ”¶</h3><p>åœ¨æŸäº›æƒ…å†µä¸‹ï¼Œé©±é€ Pod åªä¼šå›æ”¶å°‘é‡çš„ç´§ä¿èµ„æºã€‚ è¿™å¯èƒ½å¯¼è‡´ kubelet åå¤è¾¾åˆ°é…ç½®çš„é©±é€æ¡ä»¶å¹¶è§¦å‘å¤šæ¬¡é©±é€ã€‚</p><p>ä½ å¯ä»¥ä½¿ç”¨ â€“eviction-minimum-reclaim æ ‡å¿—æˆ– <a href="https://kubernetes.io/zh-cn/docs/tasks/administer-cluster/kubelet-config-file/">kubelet é…ç½®æ–‡ä»¶</a> ä¸ºæ¯ä¸ªèµ„æºé…ç½®æœ€å°å›æ”¶é‡ã€‚ å½“ kubelet æ³¨æ„åˆ°æŸä¸ªèµ„æºè€—å°½æ—¶ï¼Œå®ƒä¼šç»§ç»­å›æ”¶è¯¥èµ„æºï¼Œç›´åˆ°å›æ”¶åˆ°ä½ æ‰€æŒ‡å®šçš„æ•°é‡ä¸ºæ­¢ã€‚</p><p>ä¾‹å¦‚ï¼Œä»¥ä¸‹é…ç½®è®¾ç½®æœ€å°å›æ”¶é‡ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">kubelet.config.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">KubeletConfiguration</span><br><span class="hljs-attr">evictionHard:</span><br>  <span class="hljs-attr">memory.available:</span> <span class="hljs-string">&quot;500Mi&quot;</span><br>  <span class="hljs-attr">nodefs.available:</span> <span class="hljs-string">&quot;1Gi&quot;</span><br>  <span class="hljs-attr">imagefs.available:</span> <span class="hljs-string">&quot;100Gi&quot;</span><br><span class="hljs-attr">evictionMinimumReclaim:</span><br>  <span class="hljs-attr">memory.available:</span> <span class="hljs-string">&quot;0Mi&quot;</span><br>  <span class="hljs-attr">nodefs.available:</span> <span class="hljs-string">&quot;500Mi&quot;</span><br>  <span class="hljs-attr">imagefs.available:</span> <span class="hljs-string">&quot;2Gi&quot;</span><br></code></pre></td></tr></table></figure><p>åœ¨è¿™ä¸ªä¾‹å­ä¸­ï¼Œå¦‚æœ nodefs.available ä¿¡å·æ»¡è¶³é©±é€æ¡ä»¶ï¼Œ kubelet ä¼šå›æ”¶èµ„æºï¼Œç›´åˆ°ä¿¡å·è¾¾åˆ° 1Gi çš„æ¡ä»¶ï¼Œ ç„¶åç»§ç»­å›æ”¶è‡³å°‘ 500Mi ç›´åˆ°ä¿¡å·è¾¾åˆ° 1.5Giã€‚</p><p>ç±»ä¼¼åœ°ï¼Œkubelet ä¼šå›æ”¶ imagefs èµ„æºï¼Œç›´åˆ° imagefs.available ä¿¡å·è¾¾åˆ° 102Giã€‚</p><p>å¯¹äºæ‰€æœ‰èµ„æºï¼Œé»˜è®¤çš„ eviction-minimum-reclaim ä¸º 0ã€‚</p><h3 id="èŠ‚ç‚¹å†…å­˜ä¸è¶³è§¦å‘çš„é©±é€"><a href="#èŠ‚ç‚¹å†…å­˜ä¸è¶³è§¦å‘çš„é©±é€" class="headerlink" title="èŠ‚ç‚¹å†…å­˜ä¸è¶³è§¦å‘çš„é©±é€"></a>èŠ‚ç‚¹å†…å­˜ä¸è¶³è§¦å‘çš„é©±é€</h3><p>å¦‚æœèŠ‚ç‚¹åœ¨ kubelet èƒ½å¤Ÿå›æ”¶å†…å­˜ä¹‹å‰é‡åˆ°å†…å­˜ä¸è¶³ï¼ˆOOMï¼‰äº‹ä»¶ï¼Œ åˆ™èŠ‚ç‚¹ä¾èµ– <a href="https://lwn.net/Articles/391222/">oom_killer</a> æ¥å“åº”ã€‚</p><p>kubelet æ ¹æ® Pod çš„æœåŠ¡è´¨é‡ï¼ˆQoSï¼‰ä¸ºæ¯ä¸ªå®¹å™¨è®¾ç½®ä¸€ä¸ª oom_score_adj å€¼ã€‚</p><table><thead><tr><th>æœåŠ¡è´¨é‡</th><th>oom_score_adj</th></tr></thead><tbody><tr><td>Guaranteed</td><td>-997</td></tr><tr><td>BestEffort</td><td>1000</td></tr><tr><td>Burstable</td><td>min(max(2, 1000 - (1000 * memoryRequestBytes) &#x2F; machineMemoryCapacityBytes), 999)</td></tr></tbody></table><blockquote><p>è¯´æ˜ï¼škubelet è¿˜å°†å…·æœ‰ system-node-critical <a href="https://kubernetes.io/zh-cn/docs/concepts/scheduling-eviction/pod-priority-preemption/#pod-priority">ä¼˜å…ˆçº§</a> çš„ Pod ä¸­çš„å®¹å™¨ oom_score_adj å€¼è®¾ä¸º -997ã€‚</p></blockquote><p>å¦‚æœ kubelet åœ¨èŠ‚ç‚¹é‡åˆ° OOM ä¹‹å‰æ— æ³•å›æ”¶å†…å­˜ï¼Œ åˆ™ oom_killer æ ¹æ®å®ƒåœ¨èŠ‚ç‚¹ä¸Šä½¿ç”¨çš„å†…å­˜ç™¾åˆ†æ¯”è®¡ç®— oom_scoreï¼Œ ç„¶ååŠ ä¸Š oom_score_adj å¾—åˆ°æ¯ä¸ªå®¹å™¨æœ‰æ•ˆçš„ oom_scoreã€‚ ç„¶åå®ƒä¼šæ€æ­»å¾—åˆ†æœ€é«˜çš„å®¹å™¨ã€‚</p><p>è¿™æ„å‘³ç€ä½ QoS Pod ä¸­ç›¸å¯¹äºå…¶è°ƒåº¦è¯·æ±‚æ¶ˆè€—å†…å­˜è¾ƒå¤šçš„å®¹å™¨ï¼Œå°†é¦–å…ˆè¢«æ€æ­»ã€‚</p><p>ä¸ Pod é©±é€ä¸åŒï¼Œå¦‚æœå®¹å™¨è¢« OOM æ€æ­»ï¼Œ kubelet å¯ä»¥æ ¹æ®å…¶ RestartPolicy é‡æ–°å¯åŠ¨å®ƒã€‚</p><h3 id="ç£ç›˜å®¹é‡ä¸è¶³è§¦å‘çš„é©±é€"><a href="#ç£ç›˜å®¹é‡ä¸è¶³è§¦å‘çš„é©±é€" class="headerlink" title="ç£ç›˜å®¹é‡ä¸è¶³è§¦å‘çš„é©±é€"></a>ç£ç›˜å®¹é‡ä¸è¶³è§¦å‘çš„é©±é€</h3><p>â€‹      å½“ä¸å¯å‹ç¼©èµ„æºï¼ˆå†…å­˜ã€ç£ç›˜ï¼‰ä¸è¶³æ—¶ï¼ŒèŠ‚ç‚¹ä¸Šçš„ Kubelet ä¼šå°è¯•é©±é€æ‰æŸäº› Podï¼Œä»¥é‡Šæ”¾èµ„æºï¼Œé˜²æ­¢æ•´ä¸ªç³»ç»Ÿå—åˆ°å½±å“ã€‚</p><p>å…¶ä¸­ï¼Œç£ç›˜èµ„æºä¸è¶³çš„ä¿¡å·æ¥æºæœ‰ä¸¤ä¸ªï¼š</p><ul><li>imagefsï¼šå®¹å™¨è¿è¡Œæ—¶ç”¨ä½œå­˜å‚¨é•œåƒã€å¯å†™å±‚çš„æ–‡ä»¶ç³»ç»Ÿ</li><li>nodefsï¼šKubelet ç”¨ä½œå·ã€å®ˆæŠ¤è¿›ç¨‹æ—¥å¿—çš„æ–‡ä»¶ç³»ç»Ÿ</li></ul><p>å½“ imagefs ç”¨é‡åˆ°è¾¾é©±é€é˜ˆå€¼ï¼ŒKubelet ä¼šåˆ é™¤æ‰€æœ‰æœªä½¿ç”¨çš„é•œåƒï¼Œé‡Šæ”¾ç©ºé—´ã€‚</p><p>å½“ nodefs ç”¨é‡åˆ°è¾¾é˜ˆå€¼ï¼ŒKubelet ä¼šé€‰æ‹©æ€§çš„é©±é€ Podï¼ˆåŠå…¶å®¹å™¨ï¼‰æ¥é‡Šæ”¾ç©ºé—´ã€‚</p><p>æœ¬åœ°ä¸´æ—¶å­˜å‚¨è§¦å‘çš„é©±é€</p><p>K8S æ”¯æŒè®¾ç½®æ¯ä¸ª Pod å¯ä»¥ä½¿ç”¨çš„ä¸´æ—¶å­˜å‚¨çš„ request&#x2F;limitï¼Œé©±é€è¡Œä¸ºå¯ä»¥æ›´å…·æœ‰é’ˆå¯¹æ€§ã€‚å¦‚æœ Pod ä½¿ç”¨äº†è¶…è¿‡é™åˆ¶çš„æœ¬åœ°ä¸´æ—¶å­˜å‚¨ï¼ŒKubelet å°†è®¾ç½®é©±é€ä¿¡å·ï¼Œè§¦å‘ Pod é©±é€æµç¨‹ï¼š</p><ol><li>å¯¹äºå®¹å™¨çº§åˆ«çš„éš”ç¦»ï¼Œå¦‚æœä¸€ä¸ªå®¹å™¨çš„å¯å†™å±‚ã€æ—¥å¿—å ç”¨ç£ç›˜è¶…è¿‡é™åˆ¶ï¼Œåˆ™ Kubelet æ ‡è®° Pod ä¸ºå¾…é©±é€</li><li>å¯¹äº Pod çº§åˆ«çš„éš”ç¦»ï¼ŒPod æ€»ç”¨é‡é™åˆ¶ï¼Œæ˜¯æ¯ä¸ªå®¹å™¨é™åˆ¶ä¹‹å’Œã€‚å¦‚æœå„å®¹å™¨ç”¨é‡ä¹‹å’Œ+Pod çš„ emptyDir å·è¶…è¿‡ Pod æ€»ç”¨é‡é™åˆ¶ï¼Œæ ‡è®° Pod ä¸ºå¾…é©±é€</li></ol><h2 id="é©±é€é—®é¢˜æœ€ä½³å®è·µ"><a href="#é©±é€é—®é¢˜æœ€ä½³å®è·µ" class="headerlink" title="é©±é€é—®é¢˜æœ€ä½³å®è·µ"></a>é©±é€é—®é¢˜æœ€ä½³å®è·µ</h2><p>ä»¥ä¸‹éƒ¨åˆ†æè¿°äº†é©±é€é…ç½®çš„æœ€ä½³å®è·µã€‚</p><h3 id="å¯è°ƒåº¦çš„èµ„æºå’Œé©±é€ç­–ç•¥"><a href="#å¯è°ƒåº¦çš„èµ„æºå’Œé©±é€ç­–ç•¥" class="headerlink" title="å¯è°ƒåº¦çš„èµ„æºå’Œé©±é€ç­–ç•¥"></a>å¯è°ƒåº¦çš„èµ„æºå’Œé©±é€ç­–ç•¥</h3><p>å½“ä½ ä¸º kubelet é…ç½®é©±é€ç­–ç•¥æ—¶ï¼Œ ä½ åº”è¯¥ç¡®ä¿è°ƒåº¦ç¨‹åºä¸ä¼šåœ¨ Pod è§¦å‘é©±é€æ—¶å¯¹å…¶è¿›è¡Œè°ƒåº¦ï¼Œå› ä¸ºè¿™ç±» Pod ä¼šç«‹å³å¼•èµ·å†…å­˜å‹åŠ›ã€‚</p><p>è€ƒè™‘ä»¥ä¸‹åœºæ™¯ï¼š</p><ul><li>èŠ‚ç‚¹å†…å­˜å®¹é‡ï¼š10Gi</li><li>æ“ä½œå‘˜å¸Œæœ›ä¸ºç³»ç»Ÿå®ˆæŠ¤è¿›ç¨‹ï¼ˆå†…æ ¸ã€kubelet ç­‰ï¼‰ä¿ç•™ 10% çš„å†…å­˜å®¹é‡</li><li>æ“ä½œå‘˜å¸Œæœ›åœ¨èŠ‚ç‚¹å†…å­˜åˆ©ç”¨ç‡è¾¾åˆ° 95% ä»¥ä¸Šæ—¶é©±é€ Podï¼Œä»¥å‡å°‘ç³»ç»Ÿ OOM çš„æ¦‚ç‡ã€‚</li></ul><p>ä¸ºæ­¤ï¼Œkubelet å¯åŠ¨è®¾ç½®å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">--eviction-hard=memory.available&lt;500Mi<br>--system-reserved=memory=1.5Gi<br></code></pre></td></tr></table></figure><p>åœ¨æ­¤é…ç½®ä¸­ï¼Œâ€“system-reserved æ ‡å¿—ä¸ºç³»ç»Ÿé¢„ç•™äº† 1.5Gi çš„å†…å­˜ï¼Œ å³ æ€»å†…å­˜çš„ 10% + é©±é€æ¡ä»¶é‡ã€‚</p><p>å¦‚æœ Pod ä½¿ç”¨çš„å†…å­˜è¶…è¿‡å…¶è¯·æ±‚å€¼æˆ–è€…ç³»ç»Ÿä½¿ç”¨çš„å†…å­˜è¶…è¿‡ 1Giï¼Œ åˆ™èŠ‚ç‚¹å¯ä»¥è¾¾åˆ°é©±é€æ¡ä»¶ï¼Œè¿™ä½¿å¾— memory.available ä¿¡å·ä½äº 500Mi å¹¶è§¦å‘æ¡ä»¶ã€‚</p><h3 id="DaemonSeté©±é€"><a href="#DaemonSeté©±é€" class="headerlink" title="DaemonSeté©±é€"></a>DaemonSeté©±é€</h3><p>Pod ä¼˜å…ˆçº§æ˜¯åšå‡ºé©±é€å†³å®šçš„ä¸»è¦å› ç´ ã€‚ å¦‚æœä½ ä¸å¸Œæœ› kubelet é©±é€å±äº DaemonSet çš„ Podï¼Œ è¯·åœ¨ Pod è§„çº¦ä¸­ä¸ºè¿™äº› Pod æä¾›è¶³å¤Ÿé«˜çš„ priorityClassã€‚ ä½ è¿˜å¯ä»¥ä½¿ç”¨ä¼˜å…ˆçº§è¾ƒä½çš„ priorityClass æˆ–é»˜è®¤é…ç½®ï¼Œ ä»…åœ¨æœ‰è¶³å¤Ÿèµ„æºæ—¶æ‰è¿è¡Œ DaemonSet Podã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TKEé›†ç¾¤ä¸­Nginx-ingresså¸¸ç”¨æ¡ˆä¾‹</title>
      <link href="/post/26d138ca.html"/>
      <url>/post/26d138ca.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä¸€ã€Ingressç®€ä»‹"><a href="#ä¸€ã€Ingressç®€ä»‹" class="headerlink" title="ä¸€ã€Ingressç®€ä»‹"></a>ä¸€ã€Ingressç®€ä»‹</h2><blockquote><p><a href="https://kubernetes.github.io/ingress-nginx/">nginx-ingresså®˜æ–¹æ–‡æ¡£ä»‹ç»</a></p></blockquote><p>åœ¨Kubernetesä¸­ï¼ŒæœåŠ¡å’ŒPodçš„IPåœ°å€ä»…å¯ä»¥åœ¨é›†ç¾¤ç½‘ç»œå†…éƒ¨ä½¿ç”¨ï¼Œå¯¹äºé›†ç¾¤å¤–çš„åº”ç”¨æ˜¯ä¸å¯è§çš„ã€‚ä¸ºäº†ä½¿å¤–éƒ¨çš„åº”ç”¨èƒ½å¤Ÿè®¿é—®é›†ç¾¤å†…çš„æœåŠ¡ï¼Œåœ¨Kubernetes ç›®å‰ æä¾›äº†ä»¥ä¸‹å‡ ç§æ–¹æ¡ˆï¼š</p><ul><li>NodePortç±»å‹</li><li>LoadBalancerç±»å‹</li><li>Ingress</li></ul><p><strong>1ï¼ŒIngressç»„æˆ</strong></p><ul><li>ingress controllerï¼šå®é™… Nginx è´Ÿè½½ï¼Œä¼š watch kubernetes ingress å¯¹è±¡çš„å˜åŒ–æ›´æ–°åœ¨é›†ç¾¤ä¸­ï¼Œå°†æ–°åŠ å…¥çš„Ingressè½¬åŒ–æˆNginxçš„é…ç½®æ–‡ä»¶å¹¶ä½¿ä¹‹ç”Ÿæ•ˆ</li><li>ingressæœåŠ¡ï¼šå°†Nginxçš„é…ç½®æŠ½è±¡æˆä¸€ä¸ªIngresså¯¹è±¡ï¼Œæ¯æ·»åŠ ä¸€ä¸ªæ–°çš„æœåŠ¡åªéœ€å†™ä¸€ä¸ªæ–°çš„Ingressçš„yamlæ–‡ä»¶å³å¯</li></ul><p><strong>2ï¼ŒIngresså·¥ä½œåŸç†</strong></p><ol><li>ingress controlleré€šè¿‡å’Œkubernetes apiäº¤äº’ï¼ŒåŠ¨æ€çš„å»æ„ŸçŸ¥é›†ç¾¤ä¸­ingressè§„åˆ™å˜åŒ–ï¼Œ</li><li>ç„¶åè¯»å–å®ƒï¼ŒæŒ‰ç…§è‡ªå®šä¹‰çš„è§„åˆ™ï¼Œè§„åˆ™å°±æ˜¯å†™æ˜äº†å“ªä¸ªåŸŸåå¯¹åº”å“ªä¸ªserviceï¼Œç”Ÿæˆä¸€æ®µnginxé…ç½®ï¼Œ</li><li>å†å†™åˆ°nginx-ingress-controlçš„podé‡Œï¼Œè¿™ä¸ªIngress controllerçš„podé‡Œè¿è¡Œç€ä¸€ä¸ªNginxæœåŠ¡ï¼Œæ§åˆ¶å™¨ä¼šæŠŠç”Ÿæˆçš„nginxé…ç½®å†™å…¥&#x2F;etc&#x2F;nginx.confæ–‡ä»¶ä¸­ï¼Œ</li><li>ç„¶åreloadä¸€ä¸‹ä½¿é…ç½®ç”Ÿæ•ˆï¼Œä»¥æ­¤è¾¾åˆ°åŸŸååˆ†é…ç½®å’ŒåŠ¨æ€æ›´æ–°çš„é—®é¢˜ã€‚</li></ol><p><strong>3ï¼ŒIngress å¯ä»¥è§£å†³ä»€ä¹ˆé—®é¢˜</strong></p><ul><li>åŠ¨æ€é…ç½®æœåŠ¡</li></ul><p>å¦‚æœæŒ‰ç…§ä¼ ç»Ÿæ–¹å¼ï¼Œ å½“æ–°å¢åŠ ä¸€ä¸ªæœåŠ¡æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦åœ¨æµé‡å…¥å£åŠ ä¸€ä¸ªåå‘ä»£ç†æŒ‡å‘æˆ‘ä»¬æ–°çš„k8sæœåŠ¡. è€Œå¦‚æœç”¨äº†Ingress, åªéœ€è¦é…ç½®å¥½è¿™ä¸ªæœåŠ¡, å½“æœåŠ¡å¯åŠ¨æ—¶ï¼Œè‡ªåŠ¨æ³¨å†Œåˆ°Ingressçš„ä¸­, ä¸éœ€è¦é¢å¤–çš„æ“ä½œ.</p><ul><li>å‡å°‘ä¸å¿…è¦çš„ç«¯å£æš´éœ²</li></ul><p>é…ç½®è¿‡k8sçš„éƒ½æ¸…æ¥šï¼Œç¬¬ä¸€æ­¥æ˜¯è¦å…³é—­é˜²ç«å¢™çš„, ä¸»è¦åŸå› æ˜¯k8sçš„å¾ˆå¤šæœåŠ¡ä¼šä»¥NodePortæ–¹å¼æ˜ å°„å‡ºå»ï¼Œè¿™æ ·å°±ç›¸å½“äºç»™å®¿ä¸»æœºæ‰“äº†å¾ˆç«¯å£ï¼Œ æ—¢ä¸å®‰å…¨ä¹Ÿä¸ä¼˜é›…. è€ŒIngresså¯ä»¥é¿å…è¿™ä¸ªé—®é¢˜, é™¤äº†Ingressè‡ªèº«æœåŠ¡å¯èƒ½éœ€è¦æ˜ å°„å‡ºå»ï¼Œå…¶ä»–æœåŠ¡éƒ½ä¸è¦ç”¨NodePortæ–¹å¼ </p><h2 id="äºŒã€éƒ¨ç½²å®‰è£…"><a href="#äºŒã€éƒ¨ç½²å®‰è£…" class="headerlink" title="äºŒã€éƒ¨ç½²å®‰è£…"></a>äºŒã€éƒ¨ç½²å®‰è£…</h2><p>è§ç»„ä»¶ç®¡ç†</p><h2 id="ä¸‰ã€ç›¸å…³æ¡ˆä¾‹"><a href="#ä¸‰ã€ç›¸å…³æ¡ˆä¾‹" class="headerlink" title="ä¸‰ã€ç›¸å…³æ¡ˆä¾‹"></a>ä¸‰ã€ç›¸å…³æ¡ˆä¾‹</h2><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><ul><li>åˆ›å»ºTKEé›†ç¾¤</li><li>å®‰è£…nginx-ingressç»„ä»¶</li><li>åŸŸåå’Œè¯ä¹¦</li></ul><p>éƒ¨ç½²nginxæœåŠ¡ç”¨äºæµ‹è¯•å’ŒéªŒè¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-130-tlinux ~]# kubectl -n  nginx-ingress get svc -o wide<br>NAME       TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)   AGE     SELECTOR<br>nginx-v1   ClusterIP   172.16.252.224   &lt;none&gt;        80/TCP    13m     app=nginx,version=v1<br>nginx-v2   ClusterIP   172.16.252.208   &lt;none&gt;        80/TCP    13m     app=nginx,version=v2<br>nginx-v3   ClusterIP   172.16.254.220   &lt;none&gt;        80/TCP    7m40s   app=nginx,version=v3<br>nginx-v4   ClusterIP   172.16.255.165   &lt;none&gt;        80/TCP    6m13s   app=nginx,version=v4<br>[root@VM-249-130-tlinux ~]# curl http://172.16.252.224:80<br>nginx-v1<br>[root@VM-249-130-tlinux ~]# curl http://172.16.252.208:80<br>nginx-v2<br>[root@VM-249-130-tlinux ~]# curl http://172.16.254.220:80<br>nginx-v3<br>[root@VM-249-130-tlinux ~]# curl http://172.16.255.165:80<br>nginx-v4<br></code></pre></td></tr></table></figure><p>è¡¨ç¤ºè®¿é—®å¯¹åº”çš„service æˆåŠŸçš„</p><h3 id="æ¡ˆä¾‹1-æœ€ç®€å•åŸºç¡€é…ç½®"><a href="#æ¡ˆä¾‹1-æœ€ç®€å•åŸºç¡€é…ç½®" class="headerlink" title="æ¡ˆä¾‹1 æœ€ç®€å•åŸºç¡€é…ç½®"></a>æ¡ˆä¾‹1 æœ€ç®€å•åŸºç¡€é…ç½®</h3><p>yamlç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span>      <span class="hljs-comment">#ç›¸å½“äºå®šä¹‰äº†nginxçš„ä¸€ä¸ªserver_name</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v1</span>  <span class="hljs-comment">#å®šä¹‰åç«¯çš„service</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span>                 <span class="hljs-comment">#ä¸€ä¸ªpathå°±ç›¸å½“äºä¸€ä¸ªlocationï¼Œpathçš„å€¼å¿…é¡»ä¸ºâ€œ/â€ã€‚è¿™é‡Œä¸ºåŒ¹é…çš„è§„åˆ™ï¼Œæ ¹è¡¨ç¤ºé»˜è®¤è¯·æ±‚è½¬å‘è§„åˆ™</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v2</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/.*.(txt|css|doc)</span>  <span class="hljs-comment">#å¯ä»¥è¿›å…¥åˆ°ingress controlleræŸ¥çœ‹nginxçš„é…ç½®,è¿™é‡Œç›¸å½“äºæŠŠç»“å°¾ä¸ºtxt,css,docçš„urlè¯·æ±‚è½¬å‘åˆ°nginx-v2 service</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v3</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/(api|app)/</span>       <span class="hljs-comment">#è¿™é‡Œç›¸å½“äºå°†apiå’Œappå¼€å¤´çš„ç›®å½•è¯­æ³•è½¬å‘è‡³nginx-v3 service</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v4</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/api</span>           <span class="hljs-comment">#è¿™é‡Œç›¸å½“äºå°†apiå¼€å¤´çš„urlï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç›®å½•ï¼‰çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°nginx-4</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br><span class="hljs-comment">#å¦‚æœä¸Šé¢çš„éƒ½æ²¡åŒ¹é…åˆ°ï¼Œåˆ™é»˜è®¤è½¬åˆ°â€œ/â€  ä¹Ÿå°±æ˜¯nginx-v1</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®¿é—®NginxæœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl nginx.chen1900s.cn    #é»˜è®¤è½¬å‘è§„åˆ™</span><br>nginx-v1<br><span class="hljs-comment"># curl nginx.chen1900s.cn/nginx.txt  #ç»“å°¾ä¸ºtxt,css,docçš„urlè¯·æ±‚è½¬å‘åˆ°nginx-v2 service</span><br>nginx-v2<br><span class="hljs-comment"># curl nginx.chen1900s.cn/nginx.css  #ç»“å°¾ä¸ºtxt,css,docçš„urlè¯·æ±‚è½¬å‘åˆ°nginx-v2 service</span><br>nginx-v2<br><span class="hljs-comment"># curl nginx.chen1900s.cn/nginx.doc  #ç»“å°¾ä¸ºtxt,css,docçš„urlè¯·æ±‚è½¬å‘åˆ°nginx-v2 service</span><br>nginx-v2<br><span class="hljs-comment"># curl nginx.chen1900s.cn/api/       #å°†apiå’Œappå¼€å¤´çš„ç›®å½•è¯­æ³•è½¬å‘è‡³nginx-v3 service</span><br>nginx-v3<br><span class="hljs-comment"># curl nginx.chen1900s.cn/api/hello  #å°†apiå’Œappå¼€å¤´çš„ç›®å½•è¯­æ³•è½¬å‘è‡³nginx-v3 service</span><br>nginx-v3<br><span class="hljs-comment"># curl nginx.chen1900s.cn/app/       #å°†apiå’Œappå¼€å¤´çš„ç›®å½•è¯­æ³•è½¬å‘è‡³nginx-v3 service</span><br>nginx-v3<br><span class="hljs-comment"># curl nginx.chen1900s.cn/api        å°†apiå¼€å¤´çš„urlï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç›®å½•ï¼‰çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°nginx-4</span><br>nginx-v4<br><span class="hljs-comment"># curl nginx.chen1900s.cn/api111      å°†apiå¼€å¤´çš„urlï¼ˆå¯ä»¥æ˜¯ä¸€ä¸ªæ–‡ä»¶ï¼Œä¹Ÿå¯ä»¥æ˜¯ä¸€ä¸ªç›®å½•ï¼‰çš„è¯·æ±‚ï¼Œè½¬å‘åˆ°nginx-4</span><br>nginx-v4<br><span class="hljs-comment"># curl nginx.chen1900s.cn/app        #é»˜è®¤è½¬å‘åˆ°/ nginx-v1ä¸Šé¢</span><br>nginx-v1<br></code></pre></td></tr></table></figure><p> annotationsé…ç½®ä½œç”¨äºserver </p><blockquote><p>æŒ‡å®šäº†æˆ‘ä»¬ä½¿ç”¨åç«¯ingress controllerçš„ç±»åˆ«ï¼Œå¦‚æœåç«¯æœ‰å¤šä¸ªingress controllerçš„æ—¶å€™å¾ˆé‡è¦<br>kubernetes.io&#x2F;ingress.class: â€œnginxâ€<br>æŒ‡å®šæˆ‘ä»¬çš„rulesçš„pathå¯ä»¥ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œå¦‚æœæˆ‘ä»¬æ²¡æœ‰ä½¿ç”¨æ­£åˆ™è¡¨è¾¾å¼ï¼Œæ­¤é¡¹åˆ™å¯ä¸ä½¿ç”¨<br>nginx.ingress.kubernetes.io&#x2F;use-regex: â€œtrueâ€</p></blockquote><p> è¯´æ˜ï¼š</p><blockquote><p>ä¸Šé¢å®šä¹‰çš„æ‰€æœ‰pathåˆ°ingress controlleréƒ½å°†ä¼šè½¬æ¢æˆnginx locationè§„åˆ™ï¼Œé‚£ä¹ˆå…³äºlocationçš„ä¼˜å…ˆçº§ä¸nginxä¸€æ ·ï¼Œpathè½¬æ¢åˆ°nginxåï¼Œä¼šå°†pathè§„åˆ™æœ€é•¿çš„æ’åœ¨æœ€å‰é¢ï¼Œæœ€çŸ­çš„æ’åœ¨æœ€åé¢ã€‚ </p></blockquote><h3 id="æ¡ˆä¾‹2-ä¸ªæ€§åŒ–é…ç½®"><a href="#æ¡ˆä¾‹2-ä¸ªæ€§åŒ–é…ç½®" class="headerlink" title="æ¡ˆä¾‹2 ä¸ªæ€§åŒ–é…ç½®"></a>æ¡ˆä¾‹2 ä¸ªæ€§åŒ–é…ç½®</h3><p> åœ¨æ¡ˆä¾‹1çš„åŸºç¡€ä¸Šé¢æˆ‘ä»¬å¯ä»¥å¢åŠ äº†annotationsçš„ä¸€äº›é…ç½® </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubernetes.io/ingress.class: &quot;nginx&quot;<br>nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;<br><br>#è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º5s<br>nginx.ingress.kubernetes.io/proxy-connect-timeout: &quot;600&quot;<br><br>#åç«¯æœåŠ¡å™¨å›è½¬æ•°æ®è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60s<br>nginx.ingress.kubernetes.io/proxy-send-timeout: &quot;600&quot;<br><br>#åç«¯æœåŠ¡å™¨å“åº”è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60s<br>nginx.ingress.kubernetes.io/proxy-read-timeout: &quot;600&quot;<br><br>#å®¢æˆ·ç«¯ä¸Šä¼ æ–‡ä»¶ï¼Œæœ€å¤§å¤§å°ï¼Œé»˜è®¤ä¸º20m<br>nginx.ingress.kubernetes.io/proxy-body-size: &quot;10m&quot;<br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹3-é…ç½®URLé‡å®šå‘rewrite-target"><a href="#æ¡ˆä¾‹3-é…ç½®URLé‡å®šå‘rewrite-target" class="headerlink" title="æ¡ˆä¾‹3 é…ç½®URLé‡å®šå‘rewrite-target"></a>æ¡ˆä¾‹3 é…ç½®URLé‡å®šå‘rewrite-target</h3><p>ä½¿ç”¨Nginx Ingress Controllerçš„æ—¶å€™ï¼ŒNginxä¼šå°†è·¯å¾„å®Œæ•´è½¬å‘åˆ°åç«¯ï¼ˆå¦‚ï¼Œä»Ingressè®¿é—®çš„&#x2F;service1&#x2F;apiè·¯å¾„ä¼šç›´æ¥è½¬å‘åˆ°åç«¯Podçš„&#x2F;service1&#x2F;api&#x2F;è·¯å¾„ï¼‰ã€‚å¦‚æœæ‚¨åç«¯çš„æœåŠ¡è·¯å¾„ä¸º&#x2F;apiï¼Œåˆ™ä¼šå‡ºç°è·¯å¾„é”™è¯¯ï¼Œå¯¼è‡´404çš„æƒ…å†µã€‚è¯¥æƒ…å†µä¸‹ï¼Œæ‚¨å¯ä»¥é€šè¿‡é…ç½®<code>rewrite-target</code>çš„æ–¹å¼ï¼Œæ¥å°†è·¯å¾„é‡å†™è‡³éœ€è¦çš„ç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">nginx.ingress.kubernetes.io/rewrite-target: /$2<br></code></pre></td></tr></table></figure><p>å®Œæ•´é…ç½®å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/$2</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v1</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/svc(/|$)(.*)</span><br>        <span class="hljs-attr">pathType:</span> <span class="hljs-string">ImplementationSpecific</span><br><br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹4-rewriteé…ç½®äºŒ"><a href="#æ¡ˆä¾‹4-rewriteé…ç½®äºŒ" class="headerlink" title="æ¡ˆä¾‹4 rewriteé…ç½®äºŒ"></a>æ¡ˆä¾‹4 rewriteé…ç½®äºŒ</h3><p>åŒ¹é…è¯·æ±‚å¤´ï¼Œä¸»è¦ç”¨äºæ ¹æ®è¯·æ±‚å¤´ä¿¡æ¯å°†ç”¨æˆ·è¯·æ±‚è½¬å‘åˆ°ä¸åŒçš„åº”ç”¨ï¼Œæ¯”å¦‚æ ¹æ®ä¸åŒçš„å®¢æˆ·ç«¯è½¬å‘è¯·æ±‚</p><ul><li><code>nginx.ingress.kubernetes.io/server-snippet</code>ï¼šæ‰©å±•é…ç½®åˆ°Serverç« èŠ‚ã€‚</li><li><code>nginx.ingress.kubernetes.io/configuration-snippet</code>ï¼šæ‰©å±•é…ç½®åˆ°Locationç« èŠ‚ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">annotations:<br>     nginx.ingress.kubernetes.io/server-snippet: |<br>         rewrite ^/v4/(.*)/card/query http://www.chen1900s.cn/v5/#!/card/query permanent;<br>     nginx.ingress.kubernetes.io/configuration-snippet: |<br>         rewrite ^/v6/(.*)/card/query http://www.chen1900s.cn/v7/#!/card/query permanent;<br></code></pre></td></tr></table></figure><p>ç¤ºä¾‹é…ç½®ç”Ÿæˆçš„nginx.confå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">## start server www.chen1900s.cn<br>    server &#123;<br>        server_name www.chen1900s.cn ;<br>        listen 80;<br>        listen [::]:80;<br>        set $proxy_upstream_name &quot;-&quot;;<br>    ### server-snippeté…ç½®ã€‚<br>        rewrite ^/v4/(.*)/card/query http://www.chen1900s.cn/v5/#!/card/query permanent;<br>        ...<br>    ### configuration-snippeté…ç½®ã€‚<br>      rewrite ^/v6/(.*)/card/query http://www.chen1900s.cn/v7/#!/card/query permanent;<br>      ...<br>    &#125;<br>    ## end server www.chen1900s.cn<br></code></pre></td></tr></table></figure><p>è¿™é‡Œç›´æ¥ä½¿ç”¨äº†â€œnginx.ingress.kubernetes.io&#x2F;server-snippetâ€æ¥æŒ‡å®šé…ç½®ï¼Œè¿™é‡Œå¯ä»¥ç›´æ¥å†™nginxçš„é…ç½®ï¼Œé€šè¿‡è¿™é‡Œå¯ä»¥ä¸æ­¢æ˜¯å®ç°rewriteé‡å†™ï¼Œè¿˜å¯ä»¥å®ç°æ›´å¤šçš„åŠŸèƒ½éœ€æ±‚ï¼Œåªè¦æ˜¯ä½œç”¨äºserverçš„éƒ½å¯ä»¥ </p><h3 id="æ¡ˆä¾‹5-åŸŸåç™»å½•è®¤è¯"><a href="#æ¡ˆä¾‹5-åŸŸåç™»å½•è®¤è¯" class="headerlink" title="æ¡ˆä¾‹5 åŸŸåç™»å½•è®¤è¯"></a>æ¡ˆä¾‹5 åŸŸåç™»å½•è®¤è¯</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬çš„æœåŠ¡æ²¡æœ‰æä¾›ç™»å½•è®¤è¯ï¼Œä½†æ˜¯æœ‰ä¸å¸Œæœ›å°†æœåŠ¡æä¾›ç»™æ‰€æœ‰çš„äººéƒ½èƒ½è®¿é—®ï¼Œé‚£ä¹ˆå¯ä»¥é€šè¿‡ingressä¸Šçš„è®¤è¯æ§åˆ¶è®¿é—®ï¼Œå¸¸ç”¨çš„2ç§è®¤è¯æ–¹å¼ã€‚ </p><p><strong>1ï¼ŒåŸºæœ¬èº«ä»½è®¤è¯</strong></p><p>åˆ›å»ºsecret ç”¨äºè®¿é—®å‡­è¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/nginx-ingress]<span class="hljs-comment"># htpasswd -c auth admin</span><br>New password: <br>Re-<span class="hljs-built_in">type</span> new password: <br>Adding password <span class="hljs-keyword">for</span> user admin<br><span class="hljs-comment">#åˆ›å»ºsecret</span><br>[root@VM-0-17-tlinux ~/nginx-ingress]<span class="hljs-comment">#  kubectl create secret generic basic-auth --from-file=auth -n nginx-ingress</span><br>secret/basic-auth created<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>    kubernetes.io/ingress.rule-mix: &quot;true&quot;<br>    nginx.ingress.kubernetes.io/auth-realm: Authentication Required - admin #è¯·æ±‚ç”¨æˆ·å<br>    nginx.ingress.kubernetes.io/auth-secret: basic-auth  #å¯¹åº”çš„secret<br>    nginx.ingress.kubernetes.io/auth-type: basic  #è®¤è¯æ–¹å¼<br>    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;<br>  name: nginx-basic-auth<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: nginx.chen1900s.cn<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-v1<br>          servicePort: 80<br>        path: /<br><br></code></pre></td></tr></table></figure><p>éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#å†ä¸è¾“å…¥è®¤çœŸæƒ…å†µä¸‹ï¼Œè®¿é—®ä¼šå‡ºç° 401 Unauthorized</span><br>[root@VM-249-130-tlinux ~/nginx-ingress]<span class="hljs-comment"># curl -kI https://nginx.chen1900s.cn/ </span><br>HTTP/1.1 401 Unauthorized<br>Date: Sun, 18 Sep 2022 07:10:24 GMT<br>Content-Type: text/html<br>Content-Length: 172<br>Connection: keep-alive<br>WWW-Authenticate: Basic realm=<span class="hljs-string">&quot;Authentication Required - admin&quot;</span><br>Strict-Transport-Security: max-age=15724800; includeSubDomains<br><br><span class="hljs-comment">#æºå¸¦è®¿é—®å‡­è¯è®¿é—®</span><br>[root@VM-249-130-tlinux ~/nginx-ingress]<span class="hljs-comment"># curl -kI https://nginx.chen1900s.cn/   -u &#x27;admin:admin123&#x27;</span><br>HTTP/1.1 200 OK<br>Date: Sun, 18 Sep 2022 07:11:32 GMT<br>Content-Type: text/plain<br>Connection: keep-alive<br>Strict-Transport-Security: max-age=15724800; includeSubDomains<br></code></pre></td></tr></table></figure><p><strong>2.2 å¤–éƒ¨èº«ä»½éªŒè¯</strong></p><p>æœ‰æ—¶å€™æˆ‘ä»¬æœ‰è‡ªå·±çš„é‰´æƒä¸­å¿ƒï¼Œä¹Ÿæ˜¯å¯ä»¥ä½¿ç”¨å¤–éƒ¨èº«ä»½è¿›è¡Œè®¤è¯çš„ï¼Œè¿™é‡Œæˆ‘ä»¬é‡‡ç”¨<a href="https://httpbin.org/basic-auth/user/passwd%E8%BF%99%E4%B8%AA%E4%BD%9C%E4%B8%BA%E5%A4%96%E9%83%A8%E8%BA%AB%E4%BB%BD%EF%BC%8C%E8%BF%99%E4%B8%AA%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7%E5%92%8C%E5%AF%86%E7%A0%81user/passwd">https://httpbin.org/basic-auth/user/passwdè¿™ä¸ªä½œä¸ºå¤–éƒ¨èº«ä»½ï¼Œè¿™ä¸ªé»˜è®¤è´¦å·å’Œå¯†ç user/passwd</a></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>    kubernetes.io/ingress.rule-mix: &quot;true&quot;<br>    nginx.ingress.kubernetes.io/auth-url: https://httpbin.org/basic-auth/user/passwd<br>    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;<br>  name: nginx-basic-auth-out<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: nginx.chen1900s.cn<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-v1<br>          servicePort: 80<br>        path: /<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># curl -k https://nginx.chen1900s.cn/  -v -H &#x27;Host: nginx.chen1900s.cn&#x27;  -u &#x27;user:passwd&#x27;<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181519636.png" alt="image-20220918151952442"></p><h3 id="æ¡ˆä¾‹6-è®¿é—®ç™½åå•"><a href="#æ¡ˆä¾‹6-è®¿é—®ç™½åå•" class="headerlink" title="æ¡ˆä¾‹6 è®¿é—®ç™½åå•"></a>æ¡ˆä¾‹6 è®¿é—®ç™½åå•</h3><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦ç»™åŸŸåé…ç½®ä¸‹è®¿é—®ç™½åå•ï¼Œåªå¸Œæœ›éƒ¨åˆ†ipå¯ä»¥è®¿é—®æˆ‘çš„æœåŠ¡ï¼Œè¿™æ—¶å€™éœ€è¦ç”¨åˆ°ingressçš„whitelist-source-rangeï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡è¿™ä¸ªæ³¨è§£æ¥é…ç½®æˆ‘ä»¬å¸Œæœ›æ”¾é€šè®¿é—®çš„ipã€‚ä¸‹é¢æˆ‘ä»¬åªæ”¾é€š81.69.221.19 ä¹Ÿå¯ä»¥æŒ‡å®šæŸä¸€ç½‘æ®µ å¯ä»¥è®¿é—® </p><blockquote><p>è¯¥æ¡ˆä¾‹éœ€è¦nginx-ingressèƒ½å¤Ÿæ­£å¸¸è·å–åˆ°å®¢æˆ·ç«¯æºIPï¼Œnginx-ingress-controller å¯¹åº”çš„serviceéœ€è¦æ˜¯localæ¨¡å¼ æˆ–è€…ç›´è¿PODæ¨¡å¼</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">kubernetes.io/ingress.rule-mix:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/whitelist-source-range:</span> <span class="hljs-number">81.69</span><span class="hljs-number">.221</span><span class="hljs-number">.19</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/use-regex:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">nginx-whitelist-ip</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v2</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br></code></pre></td></tr></table></figure><p>æºIPæœª81.69.221.19æ­£å¸¸è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-33-tlinux ~]<span class="hljs-comment"># curl myip.ipip.net</span><br>å½“å‰ IPï¼š81.69.221.19  æ¥è‡ªäºï¼šä¸­å›½ ä¸Šæµ· ä¸Šæµ·  ç”µä¿¡<br>[root@VM-0-33-tlinux ~]<span class="hljs-comment"># curl http://nginx.chen1900s.cn</span><br>nginx-v2<br></code></pre></td></tr></table></figure><p>å…¶ä»–å®¢æˆ·ç«¯ç¦æ­¢è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@172-16-155-8 ~]<span class="hljs-comment"># curl myip.ipip.net</span><br>å½“å‰ IPï¼š121.5.26.195  æ¥è‡ªäºï¼šä¸­å›½ ä¸Šæµ· ä¸Šæµ·  ç”µä¿¡<br>[root@172-16-155-8 ~]<span class="hljs-comment"># curl http://nginx.chen1900s.cn</span><br>&lt;html&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;&lt;title&gt;403 Forbidden&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;403 Forbidden&lt;/h1&gt;&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181531107.png" alt="image-20220918153106012"></p><h3 id="æ¡ˆä¾‹7-æ°¸ä¹…é‡å®šå‘é…ç½®é‡å®šå‘é”™è¯¯ç "><a href="#æ¡ˆä¾‹7-æ°¸ä¹…é‡å®šå‘é…ç½®é‡å®šå‘é”™è¯¯ç " class="headerlink" title="æ¡ˆä¾‹7  æ°¸ä¹…é‡å®šå‘é…ç½®é‡å®šå‘é”™è¯¯ç "></a>æ¡ˆä¾‹7  æ°¸ä¹…é‡å®šå‘é…ç½®é‡å®šå‘é”™è¯¯ç </h3><p> redirectä¸»è¦ç”¨äºåŸŸåé‡å®šå‘ï¼Œæ¯”å¦‚è®¿é—®a.comè¢«é‡å®šå‘åˆ°b.comã€‚ </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">nginx.ingress.kubernetes.io/permanent-redirect: https://www.baidu.com<br>nginx.ingress.kubernetes.io/permanent-redirect-code: &quot;308&quot;<br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹8-å®¢æˆ·ç«¯è¯·æ±‚bodyçš„å¤§å°"><a href="#æ¡ˆä¾‹8-å®¢æˆ·ç«¯è¯·æ±‚bodyçš„å¤§å°" class="headerlink" title="æ¡ˆä¾‹8 å®¢æˆ·ç«¯è¯·æ±‚bodyçš„å¤§å°"></a>æ¡ˆä¾‹8 å®¢æˆ·ç«¯è¯·æ±‚bodyçš„å¤§å°</h3><p>å¦‚æœé‡åˆ°è¯·æ±‚æŠ¥é”™æ˜¯ 413 Request Entity Too Large </p><p>å¯ä»¥é…ç½®å®¢æˆ·ç«¯è¯·æ±‚bodyçš„å¤§å°ï¼Œåˆ›å»º ingress æ—¶æ·»åŠ  annotationsï¼ˆæ³¨é‡Šï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">metadata:<br>  annotations:<br>    nginx.ingress.kubernetes.io/proxy-body-size: 1024m<br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹9-414-Request-URI-too-largeæˆ–400-bad-requesté”™"><a href="#æ¡ˆä¾‹9-414-Request-URI-too-largeæˆ–400-bad-requesté”™" class="headerlink" title="æ¡ˆä¾‹9  414 Request URI too largeæˆ–400 bad requesté”™"></a>æ¡ˆä¾‹9  414 Request URI too largeæˆ–400 bad requesté”™</h3><p>å¦‚é‡åˆ°è°ƒç”¨åç«¯æ¥å£æ—¶å€™ï¼Œéœ€è¦åœ¨headerä¸­ä¼ ä¸€æ®µå¾ˆé•¿çš„tokenï¼Œä¼šæŠ¥â€414 Request URI too largeâ€ï¼Œå¯ä»¥ç™»é™†nginx-ingress-controller podé‡ŒæŸ¥çœ‹é…ç½®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181553609.png" alt="image-20220918155331525"></p><p>è§£å†³æ–¹æ³•æ˜¯ä¿®æ”¹ä¸¤ä¸ªå‚æ•°</p><p>å‚æ•°ä¸€ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#client_header_buffer_sizeï¼šå®¢æˆ·ç«¯è¯·æ±‚å¤´ç¼“å†²åŒºå¤§å°ï¼Œ</span><br>client_header_buffer_size 128k;<span class="hljs-comment">#å¦‚æœè¯·æ±‚å¤´æ€»é•¿åº¦å¤§äºå°äº128kï¼Œåˆ™ä½¿ç”¨æ­¤ç¼“å†²åŒº</span><br></code></pre></td></tr></table></figure><p>å‚æ•°äºŒï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#large_client_header_buffersï¼šè¯·æ±‚å¤´æ€»é•¿åº¦å¤§äº128kæ—¶ä½¿ç”¨large_client_header_buffersè®¾ç½®çš„ç¼“å­˜åŒº</span><br>large_client_header_buffers 4 128k;<br><span class="hljs-comment">#large_client_header_buffers æŒ‡ä»¤å‚æ•°4ä¸ºä¸ªæ•°ï¼Œ128kä¸ºå¤§å°ï¼Œé»˜è®¤æ˜¯8kã€‚ç”³è¯·4ä¸ª128kã€‚</span><br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">data:</span><br>  <span class="hljs-attr">client-header-buffer-size:</span> <span class="hljs-string">128k</span>      <span class="hljs-comment">#æ³¨æ„å‚æ•°æ˜¯ä¸­æ¨ªçº¿</span><br>  <span class="hljs-attr">large-client-header-buffers:</span> <span class="hljs-number">4</span> <span class="hljs-string">128k</span>   <span class="hljs-comment">#æ³¨æ„å‚æ•°æ˜¯ä¸­æ¨ªçº¿</span><br>  <span class="hljs-attr">allow-backend-server-header:</span> <span class="hljs-string">&quot;true&quot;</span><br>  <span class="hljs-attr">enable-underscores-in-headers:</span> <span class="hljs-string">&quot;true&quot;</span><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181557022.png" alt="image-20220918155742919"></p><h3 id="æ¡ˆä¾‹10-ä¸Šä¼ è¶…æ—¶-504ï¼šGateway-Timeout"><a href="#æ¡ˆä¾‹10-ä¸Šä¼ è¶…æ—¶-504ï¼šGateway-Timeout" class="headerlink" title="æ¡ˆä¾‹10 ä¸Šä¼ è¶…æ—¶ 504ï¼šGateway Timeout"></a>æ¡ˆä¾‹10 ä¸Šä¼ è¶…æ—¶ 504ï¼šGateway Timeout</h3><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>ã€€ã€€ <span class="hljs-string">nginx.ingress.kubernetes.io/proxy-connect-timeoutï¼š&quot;300&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="hljs-string">&quot;300&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="hljs-string">&quot;300&quot;</span><br>    <br>    <br><span class="hljs-comment">#è¿æ¥è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º5s</span><br><span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-connect-timeout:</span> <span class="hljs-string">&quot;300&quot;</span><br><span class="hljs-comment">#åç«¯æœåŠ¡å™¨å›è½¬æ•°æ®è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60s</span><br><span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-send-timeout:</span> <span class="hljs-string">&quot;300&quot;</span><br><span class="hljs-comment">#åç«¯æœåŠ¡å™¨å“åº”è¶…æ—¶æ—¶é—´ï¼Œé»˜è®¤ä¸º60s</span><br><span class="hljs-attr">nginx.ingress.kubernetes.io/proxy-read-timeout:</span> <span class="hljs-string">&quot;300&quot;</span><br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹11-ç™½åå•åŠè¯·æ±‚é€Ÿç‡é™åˆ¶"><a href="#æ¡ˆä¾‹11-ç™½åå•åŠè¯·æ±‚é€Ÿç‡é™åˆ¶" class="headerlink" title="æ¡ˆä¾‹11  ç™½åå•åŠè¯·æ±‚é€Ÿç‡é™åˆ¶"></a>æ¡ˆä¾‹11  ç™½åå•åŠè¯·æ±‚é€Ÿç‡é™åˆ¶</h3><p> å¯ä»¥é™åˆ¶é€Ÿç‡æ¥é™ä½åç«¯å‹åŠ›ï¼Œæ¯”å¦‚å¦‚ä¸‹é…ç½®ï¼š </p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">ingress-nginx</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">&quot;nginx&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/limit-rate:</span> <span class="hljs-string">&quot;100K&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/limit-whitelist:</span> <span class="hljs-number">81.69</span><span class="hljs-number">.221</span><span class="hljs-number">.19</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/limit-rps:</span> <span class="hljs-string">&quot;1&quot;</span>  <span class="hljs-comment">#ä¸ºæ¯ç§’1ä¸ªè¿æ¥æ•°</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/limit-rpm:</span> <span class="hljs-string">&quot;5&quot;</span>  <span class="hljs-comment">#å•ä¸ªIPæ¯åˆ†é’Ÿçš„è¿æ¥æ•°</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">nginx.chen1900s.cn</span> <br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <br>        <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v4</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p>ç”¨ä»¥è®¾ç½®åŸºäºæµé‡ã€è¯·æ±‚è¿æ¥æ•°ã€è¯·æ±‚é¢‘ç‡çš„è®¿é—®æ§åˆ¶ã€‚è®¿é—®æ§åˆ¶é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚ </p><table><thead><tr><th align="center">æ³¨è§£</th><th align="center">ç±»å‹&#x2F;é€‰é¡¹</th><th align="center">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;limit-rate</td><td align="center">number</td><td align="center">è®¿é—®æµé‡é€Ÿåº¦é™åˆ¶ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ limit_rate</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;limit-rate-after</td><td align="center">number</td><td align="center">å¯ç”¨è®¿é—®æµé‡é€Ÿåº¦é™åˆ¶çš„æœ€å¤§å€¼ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ limit_rate_after</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;limit-connections</td><td align="center">number</td><td align="center">èŠ‚å¹¶å‘è¿æ¥æ•°é™åˆ¶ï¼ŒåŒ Nginx é…ç½®æŒ‡ä»¤ limit_conn</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;limit-rps</td><td align="center">number</td><td align="center">æ¯ç§’è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œburst å‚æ•°ä¸ºç»™å®šå€¼çš„ 5 å€ï¼Œå“åº”çŠ¶æ€ç ç”± ConfigMap çš„ limit-req-status-code è®¾å®š</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;limit-rpm</td><td align="center">number</td><td align="center">æ¯åˆ†é’Ÿè¯·æ±‚é¢‘ç‡é™åˆ¶ï¼Œburst å‚æ•°ä¸ºç»™å®šå€¼çš„ 5 å€ï¼Œå“åº”çŠ¶æ€ç ç”± ConfigMap çš„ limit-req-status-code è®¾å®š</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;limit-whitelist</td><td align="center">CIDR</td><td align="center">å¯¹ä»¥ä¸Šé™åˆ¶è®¾ç½®åŸºäº IP çš„ç™½åå•</td></tr></tbody></table><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181622635.png" alt="image-20220918162246526"></p><h3 id="æ¡ˆä¾‹12-é…ç½®URLé‡å®šå‘çš„è·¯ç”±æœ"><a href="#æ¡ˆä¾‹12-é…ç½®URLé‡å®šå‘çš„è·¯ç”±æœ" class="headerlink" title="æ¡ˆä¾‹12 é…ç½®URLé‡å®šå‘çš„è·¯ç”±æœ"></a>æ¡ˆä¾‹12 é…ç½®URLé‡å®šå‘çš„è·¯ç”±æœ</h3><p>é€šè¿‡ä»¥ä¸‹å‘½ä»¤åˆ›å»ºä¸€ä¸ªç®€å•çš„Ingressï¼Œæ‰€æœ‰å¯¹&#x2F;svcè·¯å¾„çš„è®¿é—®éƒ½ä¼šé‡æ–°å®šå‘åˆ°åç«¯æœåŠ¡èƒ½å¤Ÿè¯†åˆ«çš„&#x2F;è·¯å¾„ä¸Šé¢ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/rewrite-target:</span> <span class="hljs-string">/$1</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">rewrite-nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">rewrite-nginx-ingress.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v1</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/svc/(.*)</span><br><br><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè®¿é—®NginxæœåŠ¡ï¼Œæ›¿æ¢<strong>IP_ADDRESS</strong>ä¸ºIngresså¯¹åº”çš„I</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#curl -k -H &quot;Host: rewrite-test-ingress.com&quot;  http://&lt;IP_ADDRESS&gt;/svc/foo</span><br><br><span class="hljs-comment"># curl -k -H &quot;Host: rewrite-nginx-ingress.com&quot;  http://118.24.224.221/svc/foo</span><br>nginx-v1<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181626193.png" alt="image-20220918162633115"></p><h3 id="æ¡ˆä¾‹13-é…ç½®å®‰å…¨çš„è·¯ç”±æœåŠ¡"><a href="#æ¡ˆä¾‹13-é…ç½®å®‰å…¨çš„è·¯ç”±æœåŠ¡" class="headerlink" title="æ¡ˆä¾‹13 é…ç½®å®‰å…¨çš„è·¯ç”±æœåŠ¡"></a>æ¡ˆä¾‹13 é…ç½®å®‰å…¨çš„è·¯ç”±æœåŠ¡</h3><p>æ”¯æŒå¤šè¯ä¹¦ç®¡ç†ï¼Œä¸ºæ‚¨çš„æœåŠ¡æä¾›å®‰å…¨é˜²æŠ¤ã€‚</p><p>1ï¼Œå‡†å¤‡æ‚¨çš„æœåŠ¡è¯ä¹¦ã€‚å¦‚æœæ²¡æœ‰è¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•ç”Ÿæˆæµ‹è¯•è¯ä¹¦ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">è¯´æ˜** åŸŸåéœ€è¦ä¸æ‚¨çš„Ingressé…ç½®ä¿æŒä¸€è‡´ã€‚ **<br></code></pre></td></tr></table></figure><ul><li>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”Ÿæˆä¸€ä¸ªè¯ä¹¦æ–‡ä»¶tls.crtå’Œä¸€ä¸ªç§é’¥æ–‡ä»¶tls.key</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj <span class="hljs-string">&quot;/CN=tls-nginx-ingress.com/O=tls-nginx-ingress.com&quot;</span><br></code></pre></td></tr></table></figure><ul><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºå¯†é’¥ã€‚</p><p>é€šè¿‡è¯¥è¯ä¹¦å’Œç§é’¥åˆ›å»ºä¸€ä¸ªåä¸ºtls-nginx-ingressçš„Kubernetes Secretã€‚åˆ›å»ºIngressæ—¶éœ€è¦å¼•ç”¨è¿™ä¸ªSecretã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl create secret tls tls-nginx-ingress --key tls.key --cert tls.crt  -n nginx-ingress<br></code></pre></td></tr></table></figure></li></ul><p>2ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªå®‰å…¨çš„IngressæœåŠ¡ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">tls-nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">tls-nginx-ingress.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v2</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">tls-nginx-ingress.com</span><br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">tls-nginx-ingress</span><br></code></pre></td></tr></table></figure><p>3ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥è¯¢Ingressä¿¡æ¯ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl  get ingress -n nginx-ingress | grep tls</span><br>tls-nginx-ingress       &lt;none&gt;   tls-nginx-ingress.com       114.117.219.97   80, 443   4m3s<br></code></pre></td></tr></table></figure><p>4ï¼Œé…ç½®<code>hosts</code>æ–‡ä»¶æˆ–è€…è®¾ç½®åŸŸåæ¥è®¿é—®è¯¥TLSæœåŠ¡</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130053.png" alt="image-20211021151855901"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130095.png" alt="image-20211125174832750"></p><h3 id="æ¡ˆä¾‹14-é…ç½®HTTPSåŒå‘è®¤è¯"><a href="#æ¡ˆä¾‹14-é…ç½®HTTPSåŒå‘è®¤è¯" class="headerlink" title="æ¡ˆä¾‹14 é…ç½®HTTPSåŒå‘è®¤è¯"></a>æ¡ˆä¾‹14 é…ç½®HTTPSåŒå‘è®¤è¯</h3><p>æŸäº›ä¸šåŠ¡åœºæ™¯éœ€è¦å¯ç”¨HTTPSåŒå‘éªŒè¯ï¼ŒIngress-Nginxæ”¯æŒè¯¥ç‰¹æ€§ï¼Œé…ç½®æ­¥éª¤å‚è€ƒä»¥ä¸‹ç¤ºä¾‹ã€‚</p><p>1ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºè‡ªç­¾çš„CAè¯ä¹¦ã€‚ </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl req -x509 -sha256 -newkey rsa:4096 -keyout ca.key -out ca.crt -days 356 -nodes -subj <span class="hljs-string">&#x27;/CN=Fern Cert Authority&#x27;</span><br></code></pre></td></tr></table></figure><p>2ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºServerç«¯è¯ä¹¦ã€‚</p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”ŸæˆServerç«¯è¯ä¹¦çš„è¯·æ±‚æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl req -new -newkey rsa:4096 -keyout server.key -out server.csr -nodes -subj <span class="hljs-string">&#x27;/CN=test.nginx.ingress.com&#x27;</span><br></code></pre></td></tr></table></figure><p> æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä½¿ç”¨æ ¹è¯ä¹¦ç­¾å‘Serverç«¯è¯·æ±‚æ–‡ä»¶ï¼Œç”ŸæˆServerç«¯è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl x509 -req -sha256 -days 365 -<span class="hljs-keyword">in</span> server.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out server.crt<br></code></pre></td></tr></table></figure><p>3ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºClientç«¯è¯ä¹¦ã€‚</p><p>  ç”ŸæˆClientç«¯è¯ä¹¦çš„è¯·æ±‚æ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl req -new -newkey rsa:4096 -keyout client.key -out client.csr -nodes -subj <span class="hljs-string">&#x27;/CN=Fern&#x27;</span><br></code></pre></td></tr></table></figure><p> æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œä½¿ç”¨æ ¹è¯ä¹¦ç­¾å‘Clientç«¯è¯·æ±‚æ–‡ä»¶ï¼Œç”ŸæˆClientç«¯è¯ä¹¦ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">openssl x509 -req -sha256 -days 365 -<span class="hljs-keyword">in</span> client.csr -CA ca.crt -CAkey ca.key -set_serial 02 -out client.crt<br></code></pre></td></tr></table></figure><p>4ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ£€æŸ¥åˆ›å»ºçš„è¯ä¹¦</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># ls</span><br>ca.crt  ca.key  client.crt  client.csr  client.key  server.crt  server.csr  server.key<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130150.png" alt="image-20211021160303691"></p><p>5ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºCAè¯ä¹¦çš„Secretã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl create secret generic ca-secret --from-file=ca.crt=ca.crt  -n nginx-ingress<br></code></pre></td></tr></table></figure><p>6ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºServerè¯ä¹¦çš„Secretã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl create secret tls  tls-secret --cert server.crt --key server.key  -n nginx-ingress<br><br></code></pre></td></tr></table></figure><p>7ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºæµ‹è¯•ç”¨çš„Ingressç”¨ä¾‹ã€‚</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">description:</span> <span class="hljs-string">é…ç½®HTTPSåŒå‘è®¤è¯</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx</span><br>    <span class="hljs-attr">kubernetes.io/ingress.rule-mix:</span> <span class="hljs-string">&quot;false&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/auth-tls-pass-certificate-to-upstream:</span> <span class="hljs-string">&quot;true&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/auth-tls-secret:</span> <span class="hljs-string">nginx-ingress/ca-secret</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/auth-tls-verify-client:</span> <span class="hljs-string">&quot;on&quot;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/auth-tls-verify-depth:</span> <span class="hljs-string">&quot;1&quot;</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">test-nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">test.nginx.ingress.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-a</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br><br></code></pre></td></tr></table></figure><p>8ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹Ingressçš„IPåœ°å€</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl  get ingress -n nginx-ingress | grep test</span><br>test-nginx-ingress      &lt;none&gt;   test.nginx.ingress.com      114.117.219.97   80        3m34s<br></code></pre></td></tr></table></figure><p>9ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ›´æ–°Hostsæ–‡ä»¶ï¼Œæ›¿æ¢ä¸‹é¢çš„IPåœ°å€ä¸ºçœŸå®è·å–çš„Ingressçš„IPåœ°å€ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">echo</span> <span class="hljs-string">&quot;114.117.219.97 test.nginx.ingress.com&quot;</span> &gt;&gt; /etc/hosts<br></code></pre></td></tr></table></figure><p><strong>ç»“æœéªŒè¯</strong></p><p>å®¢æˆ·ç«¯ä¸ä¼ è¯ä¹¦è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl --cacert ./ca.crt  https://test.nginx.ingress.com<br><span class="hljs-comment">#é¢„æœŸè¾“å‡º</span><br>[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl --cacert ./ca.crt  https://test.nginx.ingress.com</span><br>&lt;html&gt;<br>&lt;<span class="hljs-built_in">head</span>&gt;&lt;title&gt;400 No required SSL certificate was sent&lt;/title&gt;&lt;/head&gt;<br>&lt;body&gt;<br>&lt;center&gt;&lt;h1&gt;400 Bad Request&lt;/h1&gt;&lt;/center&gt;<br>&lt;center&gt;No required SSL certificate was sent&lt;/center&gt;<br>&lt;hr&gt;&lt;center&gt;nginx&lt;/center&gt;<br>&lt;/body&gt;<br>&lt;/html&gt;<br></code></pre></td></tr></table></figure><p>å®¢æˆ·ç«¯ä¼ è¯ä¹¦è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">curl --cacert ./ca.crt --cert ./client.crt --key ./client.key https://test.nginx.ingress.com<br><span class="hljs-comment">#é¢„æœŸè¾“å‡º</span><br>[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl --cacert ./ca.crt --cert ./client.crt --key ./client.key https://test.nginx.ingress.com</span><br>nginx-a hello world<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130187.png" alt="image-20211021163648495"></p><h3 id="æ¡ˆä¾‹15-é…ç½®åŸŸåæ”¯æŒæ­£åˆ™åŒ–"><a href="#æ¡ˆä¾‹15-é…ç½®åŸŸåæ”¯æŒæ­£åˆ™åŒ–" class="headerlink" title="æ¡ˆä¾‹15 é…ç½®åŸŸåæ”¯æŒæ­£åˆ™åŒ–"></a>æ¡ˆä¾‹15 é…ç½®åŸŸåæ”¯æŒæ­£åˆ™åŒ–</h3><p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼ŒIngressèµ„æºä¸æ”¯æŒå¯¹åŸŸåé…ç½®æ­£åˆ™è¡¨è¾¾å¼ï¼Œä½†æ˜¯å¯ä»¥é€šè¿‡<code>nginx.ingress.kubernetes.io/server-alias</code>æ³¨è§£æ¥å®ç°</p><p>1ï¼Œåˆ›å»ºIngressï¼Œä»¥æ­£åˆ™è¡¨è¾¾å¼<code>~^www\.\d+\.example\.com</code>ä¸ºä¾‹ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    description: é…ç½®åŸŸåæ”¯æŒæ­£åˆ™åŒ–<br>    kubernetes.io/ingress.class: nginx<br>    nginx.ingress.kubernetes.io/server-alias: ~^www\.\d+\.example\.com$, abc.example.com<br>  name: regex-nginx-ingress<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: regex-nginx-ingress.com<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-b<br>          servicePort: 80<br>        path: /<br></code></pre></td></tr></table></figure><p>2ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å¯¹åº”Nginx Ingress Controllerçš„é…ç½®ã€‚</p><p>â€‹      æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹éƒ¨ç½²Nginx Ingress ControlleræœåŠ¡çš„Podã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl  get pods -n kube-system  | grep nginx-ingress-nginxnginx-ingress-nginx-controller-5ddf7ccc4f-vss4f                   1/1     Running   0          5h13m</span><br></code></pre></td></tr></table></figure><p>â€‹    æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å¯¹åº”Nginx Ingress Controllerçš„é…ç½®ï¼Œå¯ä»¥å‘ç°ç”Ÿæ•ˆçš„é…ç½®ï¼ˆServer_Nameå­—æ®µï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl  -n kube-system exec nginx-ingress-ingress-nginx-controller-7dc5fd97f-t9l9l cat /etc/nginx/nginx.conf | grep -C3  &quot;regex-nginx-ingress.com&quot;</span><br>kubectl <span class="hljs-built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="hljs-keyword">in</span> a future version. Use kubectl kubectl <span class="hljs-built_in">exec</span> [POD] -- [COMMAND] instead.<br>        &#125;<br>        <span class="hljs-comment">## end server _</span><br><br>        <span class="hljs-comment">## start server regex-nginx-ingress.com</span><br>        server &#123;<br>                server_name regex-nginx-ingress.com abc.example.com ~^www\.\d+\.example\.com$ ;<br><br>                listen 80  ;<br>                listen 443  ssl ;<br>--<br>                &#125;<br><br>        &#125;<br>        <span class="hljs-comment">## end server regex-nginx-ingress.com</span><br><br>        <span class="hljs-comment">## start server rewrite-nginx-ingress.com</span><br>        server &#123;<br></code></pre></td></tr></table></figure><p>3ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å–Ingresså¯¹åº”çš„IPã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl get ingress -n nginx-ingress  | grep regex</span><br>regex-nginx-ingress     &lt;none&gt;   regex-nginx-ingress.com     114.117.219.97   80        12m<br></code></pre></td></tr></table></figure><p>4ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¿›è¡Œä¸åŒè§„åˆ™ä¸‹çš„æœåŠ¡è®¿é—®æµ‹è¯•ï¼Œé…ç½®ä»¥ä¸‹<strong>IP_ADDRESS</strong>ä¸ºä¸Šä¸€æ­¥è·å–çš„IPåœ°å€ã€‚</p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡<code>Host: regex-nginx-ingress.com </code>è®¿é—®æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl -H &quot;Host: regex-nginx-ingress.com&quot;  114.117.219.97/</span><br><br>nginx-b<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡<code>Host: www.123.example.com</code>è®¿é—®æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl -H &quot;Host: www.123.example.com&quot;  114.117.219.97/</span><br>nginx-b<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡<code>Host: www.321.example.com</code>è®¿é—®æœåŠ¡</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl -H &quot;Host:  www.321.example.com&quot;  114.117.219.97/</span><br>nginx-b<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130222.png" alt="image-20211021170658628"></p><h3 id="æ¡ˆä¾‹16-é…ç½®åŸŸåæ”¯æŒæ³›åŒ–"><a href="#æ¡ˆä¾‹16-é…ç½®åŸŸåæ”¯æŒæ³›åŒ–" class="headerlink" title="æ¡ˆä¾‹16 é…ç½®åŸŸåæ”¯æŒæ³›åŒ–"></a>æ¡ˆä¾‹16 é…ç½®åŸŸåæ”¯æŒæ³›åŒ–</h3><p>åœ¨Kubernetesé›†ç¾¤ä¸­ï¼ŒIngressèµ„æºæ”¯æŒå¯¹åŸŸåé…ç½®æ³›åŸŸåï¼Œä¾‹å¦‚ï¼Œå¯é…ç½®<code>*.ingress-regex.com</code>æ³›åŸŸåã€‚</p><p>1ï¼Œéƒ¨ç½²ä»¥ä¸‹æ¨¡æ¿ï¼Œåˆ›å»ºIngress</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>  name: regex-ingress<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: <span class="hljs-string">&#x27;*.regex-ingress.com&#x27;</span><br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-c<br>          servicePort: 80<br>        path: /<br><br></code></pre></td></tr></table></figure><p>2ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼ŒæŸ¥çœ‹å¯¹åº”Nginx Ingress Controllerçš„é…ç½®ï¼Œå¯ä»¥å‘ç°ç”Ÿæ•ˆçš„é…ç½®ï¼ˆServer_Nameå­—æ®µï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl <span class="hljs-built_in">exec</span> -n kube-system &lt;ningx-ingress-pod-name&gt; <span class="hljs-built_in">cat</span> /etc/nginx/nginx.conf | grep -C3 <span class="hljs-string">&quot;regex-ingress.com&quot;</span><br><br>[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl  -n kube-system exec nginx-ingress-ingress-nginx-controller-7dc5fd97f-t9l9l cat /etc/nginx/nginx.conf | grep -C3  &quot;regex-ingress.com&quot;</span><br>kubectl <span class="hljs-built_in">exec</span> [POD] [COMMAND] is DEPRECATED and will be removed <span class="hljs-keyword">in</span> a future version. Use kubectl kubectl <span class="hljs-built_in">exec</span> [POD] -- [COMMAND] instead.<br><br>        <span class="hljs-comment"># Global filters</span><br><br>        <span class="hljs-comment">## start server *.regex-ingress.com</span><br>        server &#123;<br>                server_name ~^(?&lt;subdomain&gt;[\w-]+)\.regex-ingress\.com$ ;<br><br>--<br>                &#125;<br><br>        &#125;<br>        <span class="hljs-comment">## end server *.regex-ingress.com</span><br><br>        <span class="hljs-comment">## start server _</span><br>        server &#123;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å–Ingresså¯¹åº”çš„IP</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># kubectl  get ingress -nnginx-ingress | grep regex-ingress.com</span><br><br>regex-ingress           &lt;none&gt;   *.regex-ingress.com         114.117.219.97   80        10m<br></code></pre></td></tr></table></figure><p>4ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¿›è¡Œä¸åŒè§„åˆ™ä¸‹çš„æœåŠ¡è®¿é—®æµ‹è¯•ï¼Œé…ç½®ä»¥ä¸‹<strong>IP_ADDRESS</strong>ä¸ºä¸Šä¸€æ­¥è·å–çš„IPåœ°å€ã€‚</p><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡Host: abc.regex-ingress.com </p><p>è®¿é—®æœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># curl -H &quot;Host: abc.regex-ingress.com&quot; &lt;IP_ADDRESS&gt;/</span><br><br>[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl -H &quot;Host: abc.regex-ingress.com&quot;  114.117.219.97/</span><br>nginx-c<br></code></pre></td></tr></table></figure><p>é¢„æœŸè¾“å‡ºï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">nginx-c<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡<code>Host: 123.regex-ingress.com </code>è®¿é—®æœåŠ¡ã€‚ </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl -H &quot;Host: 123.regex-ingress.com&quot;  114.117.219.97/</span><br>nginx-c<br></code></pre></td></tr></table></figure><p> æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œé€šè¿‡<code>Host: a1b1.regex-ingress.com</code>è®¿é—®æœåŠ¡ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/tls/nginx-ingress]<span class="hljs-comment"># curl -H &quot;Host: ab1.regex-ingress.com&quot;  114.117.219.97/</span><br>nginx-c<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130279.png" alt="image-20211021173344117"></p><h3 id="æ¡ˆä¾‹17-cookieä¼šè¯ä¿æŒ"><a href="#æ¡ˆä¾‹17-cookieä¼šè¯ä¿æŒ" class="headerlink" title="æ¡ˆä¾‹17 cookieä¼šè¯ä¿æŒ"></a>æ¡ˆä¾‹17 cookieä¼šè¯ä¿æŒ</h3><p>nginx.ingress.kubernetes.io&#x2F;session-cookie-name</p><p>é»˜è®¤ä¸ºround-robinï¼Œåœ¨å…·ä½“ingressèµ„æºä¸­é€šè¿‡ingress metadata.annotationså­—æ®µå¯å…·ä½“è®¾ç½®</p><p>é€šè¿‡ä¼šè¯cookieè¿›è¡Œä¸€è‡´æ€§hashå‡è¡¡ç®—æ³•</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">ingress.kubernetes.io/affinity:</span> <span class="hljs-string">&quot;cookie&quot;</span><br><span class="hljs-attr">ingress.kubernetes.io/session-cookie-name:</span> <span class="hljs-string">&quot;route&quot;</span><br><span class="hljs-attr">ingress.kubernetes.io/session-cookie-hash:</span> <span class="hljs-string">&quot;sha1&quot;</span><br></code></pre></td></tr></table></figure><p>é€šè¿‡å®¢æˆ·ç«¯ipè¿›è¡Œä¸€è‡´æ€§hashçš„å‡è¡¡ç®—æ³•</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">nginx.ingress.kubernetes.io/upstream-hash-by:</span> <span class="hljs-string">&quot;$&#123;remote_addr&#125;&quot;</span><br></code></pre></td></tr></table></figure><p> é€šè¿‡è¯·æ±‚uriè¿›è¡Œä¸€è‡´æ€§hashçš„å‡è¡¡ç®—æ³•</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">nginx.ingress.kubernetes.io/upstream-hash-by:</span> <span class="hljs-string">&quot;$&#123;request_uri&#125;&quot;</span><br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹18-nginx-ingress-å¼€å¯è·¨åŸŸ-CORS"><a href="#æ¡ˆä¾‹18-nginx-ingress-å¼€å¯è·¨åŸŸ-CORS" class="headerlink" title="æ¡ˆä¾‹18 nginx-ingress å¼€å¯è·¨åŸŸ(CORS)"></a>æ¡ˆä¾‹18 nginx-ingress å¼€å¯è·¨åŸŸ(CORS)</h3><blockquote><p><a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/annotations/#enable-cors">å‚è€ƒå®˜æ–¹æ–‡æ¡£</a></p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">annotations:</span><br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">nginx-ingress</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/cors-allow-headers:</span> <span class="hljs-string">&gt;-</span><br><span class="hljs-string">      DNT,X-CustomHeader,Keep-Alive,User-Agent,X-Requested-With,If-Modified-Since,Cache-Control,Content-Type,Authorization</span><br><span class="hljs-string"></span>    <span class="hljs-attr">nginx.ingress.kubernetes.io/cors-allow-methods:</span> <span class="hljs-string">&#x27;PUT, GET, POST, OPTIONS&#x27;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/cors-allow-origin:</span> <span class="hljs-string">&#x27;*&#x27;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/enable-cors:</span> <span class="hljs-string">&#x27;true&#x27;</span><br>    <span class="hljs-attr">nginx.ingress.kubernetes.io/service-weight:</span> <span class="hljs-string">&#x27;&#x27;</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">cors-nginx-ingress</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">nginx-ingress</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">cors-nginx-ingress.com</span><br>    <span class="hljs-attr">http:</span><br>      <span class="hljs-attr">paths:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">backend:</span><br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">nginx-v2</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br>        <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>  <span class="hljs-attr">tls:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">hosts:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">tls-nginx-ingress.com</span><br>    <span class="hljs-attr">secretName:</span> <span class="hljs-string">tls-nginx-ingress</span><br></code></pre></td></tr></table></figure><p>è·¨åŸŸè®¿é—®åŠŸèƒ½é…ç½®è¯´æ˜å¦‚ä¸‹è¡¨æ‰€ç¤ºã€‚</p><table><thead><tr><th align="center">æ³¨è§£</th><th align="center">ç±»å‹</th><th align="center">åŠŸèƒ½æè¿°</th></tr></thead><tbody><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;enable-cors</td><td align="center">true æˆ– false</td><td align="center">æ˜¯å¦å¯ç”¨è·¨åŸŸè®¿é—®æ”¯æŒï¼Œé»˜è®¤ä¸º false</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;cors-allow-origin</td><td align="center">string</td><td align="center">å…è®¸è·¨åŸŸè®¿é—®çš„åŸŸåï¼Œé»˜è®¤ä¸º *ï¼Œè¡¨ç¤ºæ¥å—ä»»æ„åŸŸåçš„è®¿é—®</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;cors-allow-methods</td><td align="center">string</td><td align="center">å…è®¸è·¨åŸŸè®¿é—®æ–¹æ³•ï¼Œé»˜è®¤ä¸º GETã€PUTã€POSTã€DELETEã€PATCHã€OPTIONS</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;cors-allow-headers</td><td align="center">string</td><td align="center">å…è®¸è·¨åŸŸè®¿é—®çš„è¯·æ±‚å¤´ï¼Œé»˜è®¤ä¸º DNTï¼ŒX-CustomHeaderã€Keep-Aliveã€User-Agentã€X-Requested-Withã€If-Modified-Sinceã€Cache-Controlã€Content-Typeã€Authorization</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;cors-allow-credentials</td><td align="center">true æˆ– false</td><td align="center">è®¾ç½®åœ¨å“åº”å¤´ä¸­ Access-Control-Allow-Credentials çš„å€¼ï¼Œè®¾ç½®æ˜¯å¦å…è®¸å®¢æˆ·ç«¯æºå¸¦éªŒè¯ä¿¡æ¯ï¼Œå¦‚ cookie ç­‰ï¼Œé»˜è®¤ä¸º true</td></tr><tr><td align="center">nginx.ingress.kubernetes.io&#x2F;cors-max-age</td><td align="center">number</td><td align="center">è®¾ç½®å“åº”å¤´ä¸­ Access-Control-Max-Age çš„å€¼ï¼Œè®¾ç½®è¿”å›ç»“æœå¯ä»¥ç”¨äºç¼“å­˜çš„æœ€é•¿æ—¶é—´ï¼Œé»˜è®¤ä¸º 1728000 ç§’</td></tr></tbody></table><h3 id="æ¡ˆä¾‹19-nginx-ingresså…³é—­80å¼ºåˆ¶è·³è½¬443"><a href="#æ¡ˆä¾‹19-nginx-ingresså…³é—­80å¼ºåˆ¶è·³è½¬443" class="headerlink" title="æ¡ˆä¾‹19 nginx-ingresså…³é—­80å¼ºåˆ¶è·³è½¬443"></a>æ¡ˆä¾‹19 nginx-ingresså…³é—­80å¼ºåˆ¶è·³è½¬443</h3><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœingresså¯¹è±¡å…¥å£å¯ç”¨äº†TLSï¼Œåˆ™ingress-controllerå°†ä½¿ç”¨308æ°¸ä¹…é‡å®šå‘å“åº”å°†HTTPå®¢æˆ·ç«¯é‡å®šå‘åˆ°HTTPSç«¯å£443</p><p>1ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªå®‰å…¨çš„IngressæœåŠ¡(<strong>å¸¦TLSè¯ä¹¦</strong> )</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx-ingress<br>  name: tls-nginx-ingress<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: tls-nginx-ingress.com<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-v2<br>          servicePort: 80<br>        path: /<br>  tls:<br>  - hosts:<br>    - tls-nginx-ingress.com<br>    secretName: tls-nginx-ingress<br></code></pre></td></tr></table></figure><p>2ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè¿”å›çš„æ˜¯308ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~/tls/nginx-ingress]# curl -I  http://tls-nginx-ingress.com<br>HTTP/1.1 308 Permanent Redirect<br>Date: Thu, 25 Nov 2021 10:07:30 GMT<br>Content-Type: text/html<br>Content-Length: 164<br>Connection: keep-alive<br>Location: https://tls-nginx-ingress.com<br></code></pre></td></tr></table></figure><p>3ï¼Œå¯ä»¥åœ¨ç‰¹å®šingressèµ„æºçš„metadata.annotationsä¸­é€šè¿‡é…ç½®nginx.ingress.<a href="https://so.csdn.net/so/search?from=pc_blog_highlight&q=kubernetes">kubernetes</a>.io&#x2F;ssl-redirect: â€œfalseâ€ ä½¿ç”¨æ³¨é‡Šç¦ç”¨æ­¤åŠŸèƒ½ï¼Œå…³é—­80å¼ºåˆ¶è·³è½¬443</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx-ingress<br>    nginx.ingress.kubernetes.io/ssl-redirect: &#x27;false&#x27;   #å°±å¯ä»¥ç¦æ­¢httpå¼ºåˆ¶è·³è½¬è‡³https<br>  name: tls-nginx-ingress<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: tls-nginx-ingress.com<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-v2<br>          servicePort: 80<br>        path: /<br>  tls:<br>  - hosts:<br>    - tls-nginx-ingress.com<br>    secretName: tls-nginx-ingress<br></code></pre></td></tr></table></figure><p>4ï¼Œæ·»åŠ annotationsåå†å»è®¿é—®ï¼Œå°±å¯ä»¥æ­£å¸¸è®¿é—®80ç«¯å£</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# curl -I  http://tls-nginx-ingress.com<br>HTTP/1.1 200 OK<br>Date: Thu, 25 Nov 2021 10:12:47 GMT<br>Content-Type: text/plain<br>Connection: keep-alive<br><br>[root@VM-0-17-tlinux ~]# curl   http://tls-nginx-ingress.com<br>nginx-v2<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130320.png" alt="image-20211125181623891"></p><h3 id="æ¡ˆä¾‹20-nginx-ingressä¸­ingressåŒ¹é…ä¼˜å…ˆçº§"><a href="#æ¡ˆä¾‹20-nginx-ingressä¸­ingressåŒ¹é…ä¼˜å…ˆçº§" class="headerlink" title="æ¡ˆä¾‹20 nginx-ingressä¸­ingressåŒ¹é…ä¼˜å…ˆçº§"></a>æ¡ˆä¾‹20 nginx-ingressä¸­ingressåŒ¹é…ä¼˜å…ˆçº§</h3><p>é¦–å…ˆåœ¨nginxä¸­locationçš„åŒ¹é…ä¼˜å…ˆçº§å¤§è‡´ä¸ºï¼šç²¾å‡†åŒ¹é… &gt; å‰ç¼€åŒ¹é… &gt; æ­£åˆ™åŒ¹é…&gt; &#x2F;</p><p>å…¶ä¸­ï¼Œå‰ç¼€åŒ¹é…ï¼š^~ï¼Œç²¾å‡†åŒ¹é… &#x3D;ï¼Œæ­£åˆ™åŒ¹é…ç»†åˆ†ä¸ºï¼š</p><p>~ åŒºåˆ†å¤§å°å†™ï¼ˆå¤§å°å†™æ•æ„Ÿï¼‰åŒ¹é…æˆåŠŸï¼›<del>* ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…æˆåŠŸï¼›!</del> åŒºåˆ†å¤§å°å†™åŒ¹é…å¤±è´¥ï¼›!~*  ä¸åŒºåˆ†å¤§å°å†™åŒ¹é…å¤±è´¥</p><p>è€Œingressèµ„æºå¯¹è±¡ä¸­ï¼Œspec.rules.http.paths.pathå­—æ®µé»˜è®¤åªæ”¯æŒä¸åŒºåˆ†å¤§å°å†™çš„æ­£åˆ™åŒ¹é…ï¼Œä½†å‰æéœ€è¦è®¾ç½®nginx.ingress.kubernetes.io&#x2F;use-regexæ³¨é‡Šè®¾ç½®</p><p>ä¸ºtrue(é»˜è®¤å€¼ä¸ºfalse)æ¥å¯ç”¨æ­¤åŠŸèƒ½</p><p>1ï¼Œæ ¹æ®å¦‚ä¸‹yamlæ–‡ä»¶åˆ›å»ºingressèµ„æº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: extensions/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: &quot;nginx-ingress&quot;<br>    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;<br>  namespace: nginx-ingress<br>  name: use-regex-nginx-ingress<br>spec:<br>  rules:<br>    - host: use-regex-nginx-ingress.com<br>      http:<br>        paths:<br>          - path: /<br>            backend:<br>              serviceName: nginx-v1<br>              servicePort: 80<br>          - path: /wifi<br>            backend:<br>              serviceName: nginx-v2<br>              servicePort: 80<br><br></code></pre></td></tr></table></figure><p>2ï¼Œè¿›å…¥åˆ°ingress-controllerçš„podä¸­ï¼Œè§‚å¯Ÿnginxé…ç½®æ–‡ä»¶ï¼Œå‘ç°locationçš„<strong>æ­£åˆ™åŒ¹é…å·²ç”Ÿæ•ˆ</strong>  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">root@VM-0-17-tlinux ~]# kubectl  exec -it  nginx-ingress-ingress-nginx-controller-7dc5fd97f-t9l9l  -n  kube-system  /bin/bash<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130362.png" alt="image-20211125184440501"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130393.png" alt="image-20211125184457459"></p><p>3ï¼Œå¦‚æœåˆ›å»ºæ—¶å€™nginx.ingress.kubernetes.io&#x2F;use-regex: â€œfalseâ€  æˆ–è€…ä¸è®¾ç½®éªŒè¯ä¸‹æ•ˆæœ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# kubectl  exec -it  nginx-ingress-ingress-nginx-controller-7dc5fd97f-t9l9l  -n  kube-system  /bin/bash<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130429.png" alt="image-20211125185055225"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130470.png" alt="image-20211125185129326"></p><h3 id="æ¡ˆä¾‹21-æ”¯æŒwebsocketé…ç½®"><a href="#æ¡ˆä¾‹21-æ”¯æŒwebsocketé…ç½®" class="headerlink" title="æ¡ˆä¾‹21 æ”¯æŒwebsocketé…ç½®"></a>æ¡ˆä¾‹21 <strong>æ”¯æŒwebsocketé…ç½®</strong></h3><p>1ï¼Œå‡†å¤‡æœåŠ¡è¯ä¹¦ã€‚å¦‚æœæ²¡æœ‰è¯ä¹¦ï¼Œå¯ä»¥é€šè¿‡ä¸‹é¢çš„æ–¹æ³•ç”Ÿæˆæµ‹è¯•è¯ä¹¦ã€‚</p><pre><code>  è¯´æ˜** åŸŸåéœ€è¦ä¸æ‚¨çš„Ingressé…ç½®ä¿æŒä¸€è‡´ã€‚ **</code></pre><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œç”Ÿæˆä¸€ä¸ªè¯ä¹¦æ–‡ä»¶tls.crtå’Œä¸€ä¸ªç§é’¥æ–‡ä»¶tls.key</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">openssl req -x509 -nodes -days 1000 -newkey rsa:2048 -keyout tls.key -out tls.crt -subj &quot;/CN=websocket-nginx-ingress.com/O=websocket-nginx-ingress.com&quot;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºå¯†é’¥ã€‚</p><p>é€šè¿‡è¯¥è¯ä¹¦å’Œç§é’¥åˆ›å»ºä¸€ä¸ªåä¸ºtls-nginx-ingressçš„Kubernetes Secretã€‚åˆ›å»ºIngressæ—¶éœ€è¦å¼•ç”¨è¿™ä¸ªSecretã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl create secret tls websocket-nginx-ingress --key tls.key --cert tls.crt  -n nginx-ingress<br></code></pre></td></tr></table></figure><p>2ï¼Œæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ªå®‰å…¨çš„IngressæœåŠ¡ (ç”±äºæ²¡æœ‰websocketï¼Œæš‚æ—¶æ²¡æœ‰åšéªŒè¯)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx-ingress<br>    nginx.ingress.kubernetes.io/configuration-snippet:  &gt;-<br>    nginx.ingress.kubernetes.io/proxy-read-timeout 3600;<br>    nginx.ingress.kubernetes.io/proxy-send-timeout 3600;<br>  name: websocket-nginx-ingress<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: websocket-nginx-ingress.com<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nginx-v2<br>          servicePort: 80<br>        path: /<br>  tls:<br>  - hosts:<br>    - websocket-nginx-ingress.com<br>    secretName: websocket-nginx-ingress<br><br></code></pre></td></tr></table></figure><h3 id="æ¡ˆä¾‹22-é€šè¿‡configmap-å®šä¹‰å…¨å±€å¸¸è§„å‚æ•°"><a href="#æ¡ˆä¾‹22-é€šè¿‡configmap-å®šä¹‰å…¨å±€å¸¸è§„å‚æ•°" class="headerlink" title="æ¡ˆä¾‹22 é€šè¿‡configmap å®šä¹‰å…¨å±€å¸¸è§„å‚æ•°"></a>æ¡ˆä¾‹22 é€šè¿‡configmap å®šä¹‰å…¨å±€å¸¸è§„å‚æ•°</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">data:<br>  multi_accept: on;<br>  use: epoll;<br>  user: www;<br>  worker_connections: 65535;<br>  worker_cpu_affinity: auto;<br>  worker_processes: auto;<br>  worker_rlimit_nofile: 300000;<br>  <br>  # æŠŠçœŸå®IPåœ°å€ä¼ ç»™åç«¯<br>  compute-full-forwarded-for: &quot;true&quot;<br>  forwarded-for-header: &quot;X-Forwarded-For&quot;<br>  use-forwarded-headers: &quot;true&quot;<br>  <br>  # å…³é—­ç‰ˆæœ¬æ˜¾ç¤º<br>  server-tokens: &quot;false&quot;<br>  <br>  # å®¢æˆ·ç«¯è¯·æ±‚å¤´çš„ç¼“å†²åŒºå¤§å° <br>  client-header-buffer-size: &quot;512k&quot;<br>  # è®¾ç½®ç”¨äºè¯»å–å¤§å‹å®¢æˆ·ç«¯è¯·æ±‚æ ‡å¤´çš„æœ€å¤§å€¼numberå’Œsizeç¼“å†²åŒº<br>  large-client-header-buffers: &quot;16 512k&quot;<br>  <br>  # è¯»å–å®¢æˆ·ç«¯è¯·æ±‚bodyçš„ç¼“å†²åŒºå¤§å°<br>  client-body-buffer-size: &quot;968k&quot;<br>  # ä»£ç†ç¼“å†²åŒºå¤§å°<br>  proxy-buffer-size: &quot;1024k&quot;<br>  # ä»£ç†bodyå¤§å°<br>  proxy-body-size: &quot;50m&quot;<br>  # æœåŠ¡å™¨åç§°å“ˆå¸Œå¤§å°<br>  server-name-hash-bucket-size: &quot;128&quot;<br>  # mapå“ˆå¸Œå¤§å°<br>  map-hash-bucket-size: &quot;128&quot;<br>  # SSLåŠ å¯†å¥—ä»¶<br>  ssl-ciphers: &quot;ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES256-GCM-SHA384:ECDHE-ECDSA-AES256-GCM-SHA384:DHE-RSA-AES128-GCM-SHA256:DHE-DSS-AES128-GCM-SHA256:kEDH+AESGCM:ECDHE-RSA-AES128-SHA256:ECDHE-ECDSA-AES128-SHA256:ECDHE-RSA-AES128-SHA:ECDHE-ECDSA-AES128-SHA:ECDHE-RSA-AES256-SHA384:ECDHE-ECDSA-AES256-SHA384:ECDHE-RSA-AES256-SHA:ECDHE-ECDSA-AES256-SHA:DHE-RSA-AES128-SHA256:DHE-RSA-AES128-SHA:DHE-DSS-AES128-SHA256:DHE-RSA-AES256-SHA256:DHE-DSS-AES256-SHA:DHE-RSA-AES256-SHA:AES128-GCM-SHA256:AES256-GCM-SHA384:AES128-SHA256:AES256-SHA256:AES128-SHA:AES256-SHA:AES:CAMELLIA:DES-CBC3-SHA:!aNULL:!eNULL:!EXPORT:!DES:!RC4:!MD5:!PSK:!aECDH:!EDH-DSS-DES-CBC3-SHA:!EDH-RSA-DES-CBC3-SHA:!KRB5-DES-CBC3-SHA&quot;<br>  # ssl åè®®<br>  ssl-protocols: &quot;TLSv1 TLSv1.1 TLSv1.2&quot;<br>#å®šä¹‰json è®¿é—®æ—¥å¿—æ ¼å¼<br>log-format-upstream: &#x27;&#123;&quot;time&quot;: &quot;$time_iso8601&quot;, &quot;remote_addr&quot;: &quot;$proxy_protocol_addr&quot;, &quot;x-forward-for&quot;: &quot;$proxy_add_x_forwarded_for&quot;, &quot;request_id&quot;: &quot;$req_id&quot;, &quot;remote_user&quot;: &quot;$remote_user&quot;, &quot;bytes_sent&quot;: $bytes_sent, &quot;request_time&quot;: $request_time, &quot;status&quot;:$status, &quot;vhost&quot;: &quot;$host&quot;, &quot;request_proto&quot;: &quot;$server_protocol&quot;, &quot;path&quot;: &quot;$uri&quot;, &quot;request_query&quot;: &quot;$args&quot;, &quot;request_length&quot;: $request_length, &quot;duration&quot;: $request_time,&quot;method&quot;: &quot;$request_method&quot;, &quot;http_referrer&quot;: &quot;$http_referer&quot;, &quot;http_user_agent&quot;: &quot;$http_user_agent&quot;&#125;&#x27;<br><br></code></pre></td></tr></table></figure><p>æ›´å¤šé…ç½®å¯ä»¥å‚è€ƒ<a href="https://kubernetes.github.io/ingress-nginx/user-guide/nginx-configuration/configmap/">æ–‡æ¡£</a></p><h3 id="æ¡ˆä¾‹23-è·å–çœŸå®IPåœ°å€é…ç½®"><a href="#æ¡ˆä¾‹23-è·å–çœŸå®IPåœ°å€é…ç½®" class="headerlink" title="æ¡ˆä¾‹23 è·å–çœŸå®IPåœ°å€é…ç½®"></a>æ¡ˆä¾‹23 <strong>è·å–çœŸå®IPåœ°å€é…ç½®</strong></h3><p>nginx-ingresså®˜æ–¹æ˜¯é€šè¿‡ä¿®æ”¹å®¹å™¨çš„é…ç½®æ–‡ä»¶æ¥é…ç½®ï¼Œé…ç½®æ–‡ä»¶ï¼šingress-nginx&#x2F;ingress-nginx-controller</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl  edit   cm  -n kube-system nginx-ingress-nginx-controller -o yaml<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">compute-full-forwarded-for: &quot;true&quot;<br>forwarded-for-header: &quot;X-Forwarded-For&quot;<br>use-forwarded-headers: &quot;true&quot;<br></code></pre></td></tr></table></figure><blockquote><p>compute-full-forwarded-for: â€œtrueâ€  &#x2F;&#x2F;å¦‚æœä¸ºçœŸï¼ŒNGINX å°†ä¼ å…¥çš„X-Forwarded-*æ ‡å¤´ä¼ é€’ç»™ä¸Šæ¸¸ã€‚å½“ NGINX åœ¨è®¾ç½®è¿™äº›æ ‡å¤´çš„å¦ä¸€ä¸ª L7 ä»£ç†&#x2F;è´Ÿè½½å‡è¡¡å™¨ä¹‹åä½¿ç”¨æ­¤é€‰é¡¹</p><p>forwarded-for-header: X-Forwarded-For &#x2F;&#x2F;è®¾ç½®ç”¨äºæ ‡è¯†å®¢æˆ·ç«¯çš„åŸå§‹ IP åœ°å€çš„æ ‡å¤´å­—æ®µã€‚åç«¯ç¨‹åºå°±å¯ä»¥åœ¨http åŒ…çš„headeré‡Œçš„X-Forwarded-Forè·å–çœŸå®ip</p><p>use-forwarded-headers: â€œtrueâ€   &#x2F;&#x2F;å°†è¿œç¨‹åœ°å€é™„åŠ åˆ° X-Forwarded-For æ ‡å¤´ï¼Œè€Œä¸æ˜¯ç”¨podæˆ–è€…å…¶å®ƒcookieä¿¡æ¯æ›¿æ¢å®ƒã€‚å¯ç”¨æ­¤é€‰é¡¹åï¼Œåº”ç”¨ç¨‹åºè´Ÿè´£æ ¹æ®è‡ªå·±çš„å—ä¿¡ä»»ä»£ç†åˆ—è¡¨æ¥æå–å®¢æˆ·ç«¯ IP</p></blockquote><p>ä¿å­˜åç«‹å³ç”Ÿæ•ˆã€‚éšåingressçš„æ·»åŠ çœŸå®çš„IPè¡Œä¸ºä¼šä¸RFCä¸€æ ·éƒ½ä¾æ¬¡æ·»åŠ åˆ°X-Forwarded-Forä¸­äº†</p><blockquote><p>åœ¨TKEé›†ç¾¤ç¯å¢ƒä¸­ï¼Œæƒ³è·å–å®¢æˆ·ç«¯æºIPï¼Œéœ€è¦nginx-ingress-controller æ˜¯localæ¨¡å¼æˆ–è€…PODç›´è¿æ¨¡å¼æ‰å¯ä»¥ï¼Œä¸éœ€è¦ä¿®æ”¹é…ç½®æ–‡ä»¶</p></blockquote><p><strong>localæ¨¡å¼</strong></p><p>nginx-ingress-controller-service é…ç½®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181701765.png" alt="image-20220918170155658"></p><p>éªŒè¯ ingressç¤ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>    kubernetes.io/ingress.rule-mix: &quot;false&quot;<br>    nginx.ingress.kubernetes.io/use-regex: &quot;true&quot;<br>  name: whoami<br>  namespace: nginx-ingress<br>spec:<br>  rules:<br>  - host: whoami.chen1900s.cn<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: whoami<br>          servicePort: 80<br>        path: /<br>        pathType: ImplementationSpecific<br><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181658981.png" alt="image-20220918165856854"></p><p>ç›´è¿PODæ¨¡å¼å‚è€ƒ<a href="https://cloud.tencent.com/document/product/457/48949">TKEå®˜æ–¹æ–‡æ¡£</a></p><h3 id="æ¡ˆä¾‹24-nginx-ingressåštcp-x2F-udp4å±‚ç½‘ç»œè½¬å‘"><a href="#æ¡ˆä¾‹24-nginx-ingressåštcp-x2F-udp4å±‚ç½‘ç»œè½¬å‘" class="headerlink" title="æ¡ˆä¾‹24  nginx-ingressåštcp&#x2F;udp4å±‚ç½‘ç»œè½¬å‘"></a>æ¡ˆä¾‹24  nginx-ingressåštcp&#x2F;udp4å±‚ç½‘ç»œè½¬å‘</h3><p>k8sé›†ç¾¤é€šè¿‡nginx-ingressåštcp\udp 4å±‚ç½‘ç»œè½¬å‘</p><p>1ï¼Œæ£€æŸ¥nginx-ingressæ˜¯å¦å¼€å¯tcp\udpè½¬å‘</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">- args:<br>  - --tcp-services-configmap=kube-system/nginx-ingress-nginx-tcp<br>  - --udp-services-configmap=kube-system/nginx-ingress-nginx-udp<br></code></pre></td></tr></table></figure><p>2ï¼Œç¤ºä¾‹ kuard-demo.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: kuard<br>  namespace: nginx-ingress<br>spec:<br>  selector:<br>    matchLabels:<br>      app: kuard<br>  replicas: 1<br>  template:<br>    metadata:<br>      labels:<br>        app: kuard<br>    spec:<br>      containers:<br>      - image: ccr.ccs.tencentyun.com/chenjingwei/kuard-amd64:v1<br>        imagePullPolicy: Always<br>        name: kuard<br>        ports:<br>        - containerPort: 8080<br>        <br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: kuard<br>  namespace: nginx-ingress<br>spec:<br>  ports:<br>  - port: 9527<br>    targetPort: 8080<br>    protocol: TCP<br>  selector:<br>    app: kuard<br></code></pre></td></tr></table></figure><p>3ï¼Œéœ€è¦ä¿®æ”¹ä¸‹configmap</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># kubectl  -n kube-system get cm  | grep nginx-ingress-nginx<br>nginx-ingress-nginx-controller                      9      133d<br>nginx-ingress-nginx-tcp                             0      133d<br>nginx-ingress-nginx-udp                             0      133d<br><br># kubectl  -n kube-system edit  cm nginx-ingress-nginx-tcp<br><br>[root@VM-0-17-tlinux ~]# kubectl  -n kube-system get  cm nginx-ingress-nginx-tcp -o yaml<br>apiVersion: v1<br>data:                                   #TKEé»˜è®¤ä¹ˆæœ‰data<br>  &quot;9527&quot;: nginx-ingress/kuard:9527      #æ·»åŠ è¿™ä¸ªé…ç½®<br>kind: ConfigMap<br>metadata:<br>  labels:<br>    k8s-app: nginx-ingress-nginx-tcp<br>    qcloud-app: nginx-ingress-nginx-tcp<br>  name: nginx-ingress-nginx-tcp<br>  namespace: kube-system<br><br></code></pre></td></tr></table></figure><p>4ï¼Œè¿›å…¥nginx-ingresså®¹å™¨æŸ¥çœ‹TCP serviceså¤„ä¼šå‡ºç°å¯¹åº”çš„è´Ÿè½½é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># kubectl  -n kube-system  exec -it nginx-ingress-nginx-controller-5ddf7ccc4f-v4pzp -- /bin/sh<br><br>vi  nginx.conf  é•œåƒè¿‡æ»¤<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"><br><br># TCP services            <br>                                 <br>       server &#123;<br>               preread_by_lua_block &#123;<br>                       ngx.var.proxy_upstream_name=&quot;tcp-nginx-ingress-kuard-9527&quot;;<br>               &#125;                                 <br><br>               listen                  9527;<br>                                                         <br>               listen                  [::]:9527;<br>                                            <br>               proxy_timeout           600s;  <br>               proxy_pass              upstream_balancer;<br>                                              <br>       &#125;<br></code></pre></td></tr></table></figure><p>5ï¼Œç¼–è¾‘nginx-ingress-nginx-controller  svc æ·»åŠ å¯¹åº”ç«¯å£</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130616.png" alt="image-20220303172655193"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    service.cloud.tencent.com/direct-access: &quot;false&quot;<br>  labels:<br>    k8s-app: nginx-ingress-nginx-controller<br>    qcloud-app: nginx-ingress-nginx-controller<br>  name: nginx-ingress-nginx-controller<br>  namespace: kube-system<br>spec:<br>  clusterIP: 172.18.248.35<br>  externalTrafficPolicy: Cluster<br>  ports:<br>  - name: 80-80-tcp<br>    nodePort: 31899<br>    port: 80<br>    protocol: TCP<br>    targetPort: 80<br>  - name: 443-443-tcp<br>    nodePort: 32534<br>    port: 443<br>    protocol: TCP<br>    targetPort: 443<br>  - name: 9527-9527-tcp-5q8prs0zx68<br>    nodePort: 32677<br>    port: 9527<br>    protocol: TCP<br>    targetPort: 9527<br>  selector:<br>    k8s-app: nginx-ingress-nginx-controller<br>    qcloud-app: nginx-ingress-nginx-controller<br>  sessionAffinity: None<br>  type: LoadBalancer<br>,<br></code></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡nginx-ingress-nginx-controller   çš„svc  clbè®¿é—®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# kubectl  -n kube-system  get svc   | grep  nginx-ingress-nginx-controller<br>nginx-ingress-nginx-controller                     LoadBalancer   172.18.248.35    118.24.224.251   80:31899/TCP,443:32534/TCP     3m3s<br>nginx-ingress-nginx-controller-admission           ClusterIP      172.18.251.207   &lt;none&gt;           443/TCP                        133d<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209181130653.png" alt="image-20220303173434838"></p><h3 id="æ¡ˆä¾‹25-Nginx-Ingress-å®ç°grpcè½¬å‘"><a href="#æ¡ˆä¾‹25-Nginx-Ingress-å®ç°grpcè½¬å‘" class="headerlink" title="æ¡ˆä¾‹25   Nginx-Ingress å®ç°grpcè½¬å‘"></a>æ¡ˆä¾‹25   Nginx-Ingress å®ç°grpcè½¬å‘</h3><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://cloud.tencent.com/developer/article/1730604">https://cloud.tencent.com/developer/article/1730604</a></p><h3 id="æ¡ˆä¾‹26-é…ç½®HTTPSæœåŠ¡è½¬å‘åˆ°åç«¯å®¹å™¨ä¸ºHTTPSåè®®"><a href="#æ¡ˆä¾‹26-é…ç½®HTTPSæœåŠ¡è½¬å‘åˆ°åç«¯å®¹å™¨ä¸ºHTTPSåè®®" class="headerlink" title="æ¡ˆä¾‹26 é…ç½®HTTPSæœåŠ¡è½¬å‘åˆ°åç«¯å®¹å™¨ä¸ºHTTPSåè®®"></a>æ¡ˆä¾‹26 é…ç½®HTTPSæœåŠ¡è½¬å‘åˆ°åç«¯å®¹å™¨ä¸ºHTTPSåè®®</h3><p>Nginx Ingress Controlleré»˜è®¤ä½¿ç”¨HTTPåè®®è½¬å‘è¯·æ±‚åˆ°åç«¯ä¸šåŠ¡å®¹å™¨ã€‚å½“æ‚¨çš„ä¸šåŠ¡å®¹å™¨ä¸ºHTTPSåè®®æ—¶ï¼Œå¯ä»¥é€šè¿‡ä½¿ç”¨æ³¨è§£<code>nginx.ingress.kubernetes.io/backend-protocol: &quot;HTTPS&quot;</code>æ¥ä½¿å¾—Nginx Ingress Controllerä½¿ç”¨HTTPåè®®è½¬å‘è¯·æ±‚åˆ°åç«¯ä¸šåŠ¡å®¹å™¨ã€‚</p><p>Nginx Ingressé…ç½®ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    kubernetes.io/ingress.class: nginx<br>    nginx.ingress.kubernetes.io/backend-protocol: HTTPS<br>  name: backend-protocol-https-ingress<br>  namespace: default<br>spec:<br>  rules:<br>  - host: example.chen1900s.cn<br>    http:<br>      paths:<br>      - backend:<br>          service:<br>            name: nginx<br>            port:<br>              number: 443<br>        path: /<br>        pathType: ImplementationSpecific<br>  tls:<br>  - hosts:<br>    - example.chen1900s.cn<br>    secretName: chen1900s<br><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Nginx-ingress </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨TKEå®¹å™¨é›†ç¾¤ä¸­ä½¿ç”¨sysctl</title>
      <link href="/post/b81d5734.html"/>
      <url>/post/b81d5734.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>åœ¨æ—¥å¸¸ä½¿ç”¨K8Séƒ¨ç½²ä¸šåŠ¡æ—¶å€™ï¼Œéœ€è¦ä¿®æ”¹å®¹å™¨éƒ¨åˆ†å†…æ ¸å‚æ•°æ¥åšä¼˜åŒ–</p></blockquote><h2 id="åœ¨-Kubernetes-é›†ç¾¤ä¸­ä½¿ç”¨-sysctl"><a href="#åœ¨-Kubernetes-é›†ç¾¤ä¸­ä½¿ç”¨-sysctl" class="headerlink" title="åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ sysctl"></a>åœ¨ Kubernetes é›†ç¾¤ä¸­ä½¿ç”¨ sysctl</h2><h3 id="ç¯å¢ƒå‡†å¤‡"><a href="#ç¯å¢ƒå‡†å¤‡" class="headerlink" title="ç¯å¢ƒå‡†å¤‡"></a>ç¯å¢ƒå‡†å¤‡</h3><blockquote><p>èŠ‚ç‚¹æ“ä½œç³»ç»Ÿé•œåƒåç§°ï¼štlinux2.4x86_64 </p><p>èŠ‚ç‚¹å†…æ ¸ç‰ˆæœ¬ï¼š4.14+</p><p>TKEé›†ç¾¤ï¼š1.18ç‰ˆæœ¬</p></blockquote><ul><li><p>å¦‚æœé•œåƒæ˜¯tlinux å®¿ä¸»æœºå†…æ ¸è·Ÿå®¹å™¨å†…æ ¸æ˜¯ç›¸äº’çš„ç‹¬ç«‹çš„ï¼Œ tlinux åšäº†ç‰¹æ®Šçš„å¤„ç† å®¹å™¨è¿è¡Œæ—¶ ä¸linux å¯ä»¥ç›¸äº’ç‹¬ç«‹ä¸€éƒ¨åˆ†å†…æ ¸å‚æ•°ï¼ŒæŒ‰ç†æ¥è¯´åŸç”Ÿçš„linux ä¸docker æ˜¯å…±äº«å†…æ ¸</p></li><li><p>kubelet é…ç½®çš„ç›®çš„æ˜¯ä¸ºäº†å¼€å¯ä¿®æ”¹å®¹å™¨å†…æ ¸çš„æƒé™ ï¼Œ</p></li></ul><h3 id="è·å–-Sysctl-çš„å‚æ•°åˆ—è¡¨"><a href="#è·å–-Sysctl-çš„å‚æ•°åˆ—è¡¨" class="headerlink" title="è·å– Sysctl çš„å‚æ•°åˆ—è¡¨"></a>è·å– Sysctl çš„å‚æ•°åˆ—è¡¨</h3><p>åœ¨ Linuxç³»ç»Ÿ ä¸­ï¼Œç”¨æˆ·å¯ä»¥é€šè¿‡ sysctl æ¥å£ä¿®æ”¹å†…æ ¸è¿è¡Œæ—¶çš„å‚æ•°ã€‚åœ¨ <code>/proc/sys/</code> è™šæ‹Ÿæ–‡ä»¶ç³»ç»Ÿä¸‹å­˜æ”¾è®¸å¤šå†…æ ¸å‚æ•°ã€‚è¿™äº›å‚æ•°æ¶‰åŠäº†å¤šä¸ªå†…æ ¸å­ç³»ç»Ÿï¼Œå¦‚ï¼š</p><ul><li>å†…æ ¸å­ç³»ç»Ÿï¼ˆé€šå¸¸å‰ç¼€ä¸º: <code>kernel.</code>ï¼‰</li><li>ç½‘ç»œå­ç³»ç»Ÿï¼ˆé€šå¸¸å‰ç¼€ä¸º: <code>net.</code>ï¼‰</li><li>è™šæ‹Ÿå†…å­˜å­ç³»ç»Ÿï¼ˆé€šå¸¸å‰ç¼€ä¸º: <code>vm.</code>ï¼‰</li><li>MDADM å­ç³»ç»Ÿï¼ˆé€šå¸¸å‰ç¼€ä¸º: <code>dev.</code>ï¼‰</li></ul><h3 id="å¯ç”¨éå®‰å…¨çš„-Sysctl-å‚æ•°"><a href="#å¯ç”¨éå®‰å…¨çš„-Sysctl-å‚æ•°" class="headerlink" title="å¯ç”¨éå®‰å…¨çš„ Sysctl å‚æ•°"></a>å¯ç”¨éå®‰å…¨çš„ Sysctl å‚æ•°</h3><p>sysctl å‚æ•°åˆ†ä¸º <em>å®‰å…¨</em> å’Œ <em>éå®‰å…¨çš„</em>ã€‚ <em>å®‰å…¨</em> sysctl å‚æ•°é™¤äº†éœ€è¦è®¾ç½®æ°å½“çš„å‘½åç©ºé—´å¤–ï¼Œåœ¨åŒä¸€ node ä¸Šçš„ä¸åŒ Pod ä¹‹é—´ä¹Ÿå¿…é¡»æ˜¯ <em>ç›¸äº’éš”ç¦»çš„</em>ã€‚è¿™æ„å‘³ç€åœ¨ Pod ä¸Šè®¾ç½® <em>å®‰å…¨</em> sysctl å‚æ•°</p><ul><li>å¿…é¡»ä¸èƒ½å½±å“åˆ°èŠ‚ç‚¹ä¸Šçš„å…¶ä»– Pod</li><li>å¿…é¡»ä¸èƒ½æŸå®³èŠ‚ç‚¹çš„å¥åº·</li><li>å¿…é¡»ä¸å…è®¸ä½¿ç”¨è¶…å‡º Pod çš„èµ„æºé™åˆ¶çš„ CPU æˆ–å†…å­˜èµ„æºã€‚</li></ul><p>è‡³ä»Šä¸ºæ­¢ï¼Œå¤§å¤šæ•° <em>æœ‰å‘½åç©ºé—´çš„</em> sysctl å‚æ•°ä¸ä¸€å®šè¢«è®¤ä¸ºæ˜¯ <em>å®‰å…¨</em> çš„ã€‚ ä»¥ä¸‹å‡ ç§ sysctl å‚æ•°æ˜¯ <em>å®‰å…¨çš„</em>ï¼š</p><ul><li>kernel.shm_rmid_forced</li><li>net.ipv4.ip_local_port_range</li><li>net.ipv4.tcp_syncookies</li><li>net.ipv4.ping_group_range ï¼ˆä» Kubernetes 1.18 å¼€å§‹ï¼‰</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-1-17-tlinux /proc/sys]# sysctl -a | grep -E &#x27;net.ipv4.ip_local_port_range|kernel.shm_rmid_forced|net.ipv4.tcp_syncookies|net.ipv4.pin<br>g_group_range&#x27; <br><br>kernel.shm_rmid_forced = 0<br>net.ipv4.ip_local_port_range = 32768    60999<br>net.ipv4.ping_group_range = 1   0<br>net.ipv4.tcp_syncookies = 1<br></code></pre></td></tr></table></figure><p>åœ¨æœªæ¥çš„ Kubernetes ç‰ˆæœ¬ä¸­ï¼Œè‹¥ kubelet æ”¯æŒæ›´å¥½çš„éš”ç¦»æœºåˆ¶ï¼Œåˆ™ä¸Šè¿°åˆ—è¡¨ä¸­å°†ä¼š åˆ—å‡ºæ›´å¤š <em>å®‰å…¨çš„</em> sysctl å‚æ•°ã€‚</p><p>æ‰€æœ‰ <em>å®‰å…¨çš„</em> sysctl å‚æ•°éƒ½é»˜è®¤å¯ç”¨ã€‚</p><p>æ‰€æœ‰ <em>éå®‰å…¨çš„</em> sysctl å‚æ•°éƒ½é»˜è®¤ç¦ç”¨ï¼Œä¸”å¿…é¡»ç”±é›†ç¾¤ç®¡ç†å‘˜åœ¨æ¯ä¸ªèŠ‚ç‚¹ä¸Šæ‰‹åŠ¨å¼€å¯ã€‚ é‚£äº›è®¾ç½®äº†ä¸å®‰å…¨ sysctl å‚æ•°çš„ Pod ä»ä¼šè¢«è°ƒåº¦ï¼Œä½†æ— æ³•æ­£å¸¸å¯åŠ¨ã€‚</p><p>å‚è€ƒä¸Šè¿°è­¦å‘Šï¼Œé›†ç¾¤ç®¡ç†å‘˜åªæœ‰åœ¨ä¸€äº›éå¸¸ç‰¹æ®Šçš„æƒ…å†µä¸‹ï¼ˆå¦‚ï¼šé«˜å¯ç”¨æˆ–å®æ—¶åº”ç”¨è°ƒæ•´ï¼‰ï¼Œ æ‰å¯ä»¥å¯ç”¨ç‰¹å®šçš„ <em>éå®‰å…¨çš„</em> sysctl å‚æ•°ã€‚ å¦‚éœ€å¯ç”¨ <em>éå®‰å…¨çš„</em> sysctl å‚æ•°ï¼Œéœ€è¦æ¯ä¸ªèŠ‚ç‚¹ä¸Šåˆ†åˆ«è®¾ç½® kubelet å‚æ•°ï¼Œä¾‹å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">--allowed-unsafe-sysctls=&#x27;kernel.msg*,kernel.shm*,net.*&#x27; <br></code></pre></td></tr></table></figure><h3 id="è®¾ç½®-Pod-çš„-Sysctl-å‚æ•°"><a href="#è®¾ç½®-Pod-çš„-Sysctl-å‚æ•°" class="headerlink" title="è®¾ç½® Pod çš„ Sysctl å‚æ•°"></a>è®¾ç½® Pod çš„ Sysctl å‚æ•°</h3><p>ç›®å‰ï¼Œåœ¨ Linux å†…æ ¸ä¸­ï¼Œæœ‰è®¸å¤šçš„ sysctl å‚æ•°éƒ½æ˜¯ <em>æœ‰å‘½åç©ºé—´çš„</em> ã€‚ è¿™å°±æ„å‘³ç€å¯ä»¥ä¸ºèŠ‚ç‚¹ä¸Šçš„æ¯ä¸ª Pod åˆ†åˆ«å»è®¾ç½®å®ƒä»¬çš„ sysctl å‚æ•°ã€‚ åœ¨ Kubernetes ä¸­ï¼Œåªæœ‰é‚£äº›æœ‰å‘½åç©ºé—´çš„ sysctl å‚æ•°å¯ä»¥é€šè¿‡ Pod çš„ securityContext å¯¹å…¶è¿›è¡Œé…ç½®ã€‚</p><p>ä»¥ä¸‹åˆ—å‡ºæœ‰å‘½åç©ºé—´çš„ sysctl å‚æ•°ï¼Œåœ¨æœªæ¥çš„ Linux å†…æ ¸ç‰ˆæœ¬ä¸­ï¼Œæ­¤åˆ—è¡¨å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–ã€‚</p><ul><li><code>kernel.shm*</code>,</li><li><code>kernel.msg*</code>,</li><li><code>kernel.sem</code>,</li><li><code>fs.mqueue.*</code>,</li><li><code>net.*</code>ï¼ˆå†…æ ¸ä¸­å¯ä»¥åœ¨å®¹å™¨å‘½åç©ºé—´é‡Œè¢«æ›´æ”¹çš„ç½‘ç»œé…ç½®é¡¹ç›¸å…³å‚æ•°ï¼‰ã€‚ç„¶è€Œä¹Ÿæœ‰ä¸€äº›ç‰¹ä¾‹ ï¼ˆä¾‹å¦‚ï¼Œ<code>net.netfilter.nf_conntrack_max</code> å’Œ <code>net.netfilter.nf_conntrack_expect_max</code> å¯ä»¥åœ¨å®¹å™¨å‘½åç©ºé—´é‡Œè¢«æ›´æ”¹ï¼Œä½†å®ƒä»¬æ˜¯éå‘½åç©ºé—´çš„ï¼‰ã€‚</li></ul><p>æ²¡æœ‰å‘½åç©ºé—´çš„ sysctl å‚æ•°ç§°ä¸º <em>èŠ‚ç‚¹çº§åˆ«çš„</em> sysctl å‚æ•°ã€‚ å¦‚æœéœ€è¦å¯¹å…¶è¿›è¡Œè®¾ç½®ï¼Œåˆ™å¿…é¡»åœ¨æ¯ä¸ªèŠ‚ç‚¹çš„æ“ä½œç³»ç»Ÿä¸Šæ‰‹åŠ¨åœ°å»é…ç½®å®ƒä»¬ï¼Œ æˆ–è€…é€šè¿‡åœ¨ DaemonSet ä¸­è¿è¡Œç‰¹æƒæ¨¡å¼å®¹å™¨æ¥é…ç½®ã€‚</p><p>å¯ä½¿ç”¨ Pod çš„ securityContext æ¥é…ç½®æœ‰å‘½åç©ºé—´çš„ sysctl å‚æ•°ï¼Œ securityContext åº”ç”¨äºåŒä¸€ä¸ª Pod ä¸­çš„æ‰€æœ‰å®¹å™¨ã€‚</p><p>æ­¤ç¤ºä¾‹ä¸­ï¼Œä½¿ç”¨ Pod SecurityContext æ¥å¯¹ä¸€ä¸ªå®‰å…¨çš„ sysctl å‚æ•° <code>kernel.shm_rmid_forced</code> ä»¥åŠä¸¤ä¸ªéå®‰å…¨çš„ sysctl å‚æ•° <code>net.core.somaxconn</code> å’Œ <code>kernel.msgmax</code> è¿›è¡Œè®¾ç½®ã€‚ åœ¨ Pod è§„çº¦ä¸­å¯¹ <em>å®‰å…¨çš„</em> å’Œ <em>éå®‰å…¨çš„</em> sysctl å‚æ•°ä¸åšåŒºåˆ†ã€‚</p><p>ä¸ä¿®æ”¹å‰èŠ‚ç‚¹å’ŒPODé‡Œé¢å‚æ•°é…ç½®å¦‚ä¸‹ï¼š</p><ul><li>CVMèŠ‚ç‚¹ä¸Šçš„å‚æ•°é…ç½®</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-1-17-tlinux /proc/sys]# sysctl -a | grep -E &#x27;kernel.shm_rmid_forced|net.core.somaxconn|kernel.msgmax&#x27;<br><br>kernel.msgmax = 65536<br>kernel.shm_rmid_forced = 0<br>net.core.somaxconn = 32768<br></code></pre></td></tr></table></figure><ul><li>å®¹å™¨é•œåƒæ˜¯centoså¯åŠ¨PODå‚æ•°</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@centos-sysctl-7445b79c9f-fchxn /]# sysctl -a | grep -E &#x27;kernel.shm_rmid_forced|net.core.somaxconn|kernel.msgmax&#x27;<br><br>kernel.msgmax = 65536<br>kernel.shm_rmid_forced = 0<br>net.core.somaxconn = 4096<br></code></pre></td></tr></table></figure><h4 id="ä½¿ç”¨initContainerså®¹å™¨ä¿®æ”¹å†…æ ¸å‚æ•°"><a href="#ä½¿ç”¨initContainerså®¹å™¨ä¿®æ”¹å†…æ ¸å‚æ•°" class="headerlink" title="ä½¿ç”¨initContainerså®¹å™¨ä¿®æ”¹å†…æ ¸å‚æ•°"></a>ä½¿ç”¨initContainerså®¹å™¨ä¿®æ”¹å†…æ ¸å‚æ•°</h4><blockquote><p>åœ¨ä¸é…ç½®kubeletå‚æ•°allowed-unsafe-sysctls ä¹‹å‰</p></blockquote><p><strong>1ï¼Œå…ˆä¿®æ”¹å®‰å…¨å‚æ•° kernel.shm_rmid_forced &#x3D;1</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436514.png" alt="1627548971447"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171455727.png" alt="image-20220917145559626"></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#ç™»é™†å®¹å™¨é‡Œé¢æŸ¥çœ‹å‚æ•°<br>[root@centos-sysctl-5c6686499c-lhbdv /]# sysctl -a | grep -E &#x27;kernel.shm_rmid_forced&#x27;<br>kernel.shm_rmid_forced = 1<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436630.png" alt="1627549087889"></p><p>ä»¥ä¸Šæµ‹è¯•è¡¨ç¤ºå®‰å…¨å‚æ•°æ˜¯ä¸éœ€è¦å¯åŠ¨kubelet çš„allowed-unsafe-sysctlsé…ç½®å°±å¯ä»¥ä¿®æ”¹æˆåŠŸçš„</p><p><strong>2ï¼ŒåŒæ—¶ä¿®æ”¹éå®‰å…¨å‚æ•°net.core.somaxconn&#x3D;1024ï¼Œ kernel.msgmax&#x3D;60000</strong></p><p>yamlå®ä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: centos-sysctl<br>    qcloud-app: centos-sysctl<br>  name: centos-sysctl<br>  namespace: default<br>spec:<br>  selector:<br>    matchLabels:<br>      k8s-app: centos-sysctl<br>      qcloud-app: centos-sysctl<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: centos-sysctl<br>        qcloud-app: centos-sysctl<br>    spec:<br>      containers:<br>      - args:<br>        - -c<br>        - sleep 300000<br>        command:<br>        - /bin/sh<br>        image: centos:latest<br>        imagePullPolicy: IfNotPresent<br>        name: centos<br>        resources:<br>          limits:<br>            cpu: 200m<br>            memory: 128Mi<br>          requests:<br>            cpu: 100m<br>            memory: 64Mi<br>      dnsPolicy: ClusterFirst<br>      imagePullSecrets:<br>      - name: qcloudregistrykey<br>      initContainers:<br>      - args:<br>        - -c<br>        - sysctl  -w  kernel.shm_rmid_forced=1 &amp;&amp; sysctl  -w  net.core.somaxconn=1024 &amp;&amp; sysctl -w kernel.msgmax=60000<br>        command:<br>        - /bin/sh<br>        image: busybox:latest<br>        imagePullPolicy: Always<br>        name: initc<br>        securityContext:<br>          privileged: true<br><br></code></pre></td></tr></table></figure><p>é…ç½®æˆªå›¾å¦‚ä¸‹</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436668.png" alt="1627549559535"></p><p>å®¹å™¨å†…ä¹Ÿæ˜¯ç”Ÿæ•ˆçš„</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436702.png" alt="1627549596942"></p><p>èŠ‚ç‚¹ä¸Šç³»ç»Ÿå‚æ•°ä¾æ®æ˜¯</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436729.png" alt="1627549700468"></p><p>ä»¥ä¸Šæµ‹è¯•è¡¨ç¤ºå®‰å…¨å‚æ•° å’Œéƒ¨åˆ†éå®‰å…¨å‚æ•°ä¹Ÿå¯ä»¥ç›´æ¥ä¿®æ”¹</p><p><strong>3ï¼Œä¿®æ”¹å…¶ä»–å†…æ ¸éå®‰å…¨å‚æ•°</strong></p><p>ç¤ºä¾‹ä¿®æ”¹å¦‚ä¸‹å‚æ•°ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">net.ipv4.tcp_synack_retries=1<br>net.ipv4.tcp_syn_retries=1<br>net.ipv4.tcp_tw_recycle=1<br>net.ipv4.tcp_tw_reuse=1<br>net.ipv4.tcp_fin_timeout=1<br>net.ipv4.tcp_keepalive_time=30<br>net.ipv4.ip_local_port_range=&quot;1024 65000&quot;<br></code></pre></td></tr></table></figure><p>CVMåˆå§‹å€¼ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-1-17-tlinux ~]# sysctl  -a| grep -E &#x27;net.ipv4.tcp_synack_retries|net.ipv4.tcp_syn_retries|net.ipv4.tcp_tw_recycle|net.ipv4.tcp_tw_reuse|net.ipv4.tcp_fin_timeout|net.ipv4.tcp_keepalive_time|net.ipv4.ip_local_port_range&#x27;<br><br>net.ipv4.ip_local_port_range = 32768    60999<br>net.ipv4.tcp_fin_timeout = 60<br>net.ipv4.tcp_keepalive_time = 7200<br>net.ipv4.tcp_syn_retries = 6<br>net.ipv4.tcp_synack_retries = 5<br>net.ipv4.tcp_tw_reuse = 0<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436768.png" alt="1627549985182"></p><p>PODæœªä¿®æ”¹å‰å’Œæ“ä½œç³»ç»Ÿä¿æŒé»˜è®¤çš„</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@centos-sysctl-5c4d8dc5b-rc8gv /]# sysctl  -a| grep -E &#x27;net.ipv4.tcp_synack_retries|net.ipv4.tcp_syn_retries|net.ipv4.tcp_tw_recycle|net.ipv4.tcp_tw_reuse|net.ipv4.tcp_fin_timeout|net.ipv4.tcp_keepalive_time|net.ipv4.ip_local_port_range&#x27;<br>net.ipv4.ip_local_port_range = 32768    60999<br>net.ipv4.tcp_fin_timeout = 60<br>net.ipv4.tcp_keepalive_time = 7200<br>net.ipv4.tcp_syn_retries = 6<br>net.ipv4.tcp_synack_retries = 5<br>net.ipv4.tcp_tw_reuse = 0<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436801.png" alt="1627550034823"></p><p>ç„¶åä½¿ç”¨initContainerå»ä¿®æ”¹è¿™äº›å‚æ•°ï¼Œå‘ç°ä¼šæŠ¥é”™ï¼Œä¸è®©ä¿®æ”¹ï¼Œä¿®æ”¹å¤±è´¥</p><p><strong>4ï¼Œkubelet å¼€å¯éå®‰å…¨å‚æ•°  (éœ€è¦å°†èŠ‚ç‚¹ç§»é™¤é‡æ–°)</strong></p><blockquote><p>*åœ¨TKEé›†ç¾¤èŠ‚ç‚¹é»˜è®¤æƒ…å†µä¸‹æ˜¯æ²¡æœ‰å¼€å¯è¿™ä¸ªå‚æ•°çš„ï¼Œå°±éœ€è¦ç”¨æˆ·æäº¤å·¥å•ç”³è¯·å¼€é€šè‡ªå®šä¹‰kuberneteså‚æ•°ï¼Œåœ¨åˆ›å»ºèŠ‚ç‚¹æ—¶å€™å¯ä»¥è®¾ç½®ï¼Œæ–‡ç« ç»“å°¾ä¼šé™„ä¸Šè®¾ç½®ç›¸å…³æˆªå›¾</p></blockquote><p>â€“allowed-unsafe-sysctls&#x3D;kernel.shm*,kernel.msg*,net.*</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436828.png" alt="1627550973864"></p><p>ç„¶åå†å»ä½¿ç”¨initContainerä¿®æ”¹ï¼ŒæŸ¥çœ‹ä¿®æ”¹æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@centos-sysctl-5d6d89c66d-z4mxr /]# sysctl  -a| grep -E &#x27;net.ipv4.tcp_synack_retries|net.ipv4.tcp_syn_retries|net.ipv4.tcp_tw_recycle|net.ipv4.tcp_tw_reuse|net.ipv4.tcp_fin_timeout|net.ipv4.tcp_keepalive_time|net.ipv4.ip_local_port_range&#x27;<br><br>net.ipv4.ip_local_port_range = 1024     65000<br>net.ipv4.tcp_fin_timeout = 1<br>net.ipv4.tcp_keepalive_time = 30<br>net.ipv4.tcp_syn_retries = 1<br>net.ipv4.tcp_synack_retries = 1<br>net.ipv4.tcp_tw_reuse = 1<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171436812.png" alt="1627551531024"></p><p>å®Œæ•´yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: centos-sysctl<br>    qcloud-app: centos-sysctl<br>  name: centos-sysctl<br>  namespace: default<br>spec:<br>  replicas: 1<br>  revisionHistoryLimit: 5<br>  selector:<br>    matchLabels:<br>      k8s-app: centos-sysctl<br>      qcloud-app: centos-sysctl<br>  template:<br>    metadata:<br>      creationTimestamp: null<br>      labels:<br>        k8s-app: centos-sysctl<br>        qcloud-app: centos-sysctl<br>    spec:<br>      containers:<br>      - args:<br>        - -c<br>        - sleep 300000<br>        command:<br>        - /bin/sh<br>        image: centos:latest<br>        imagePullPolicy: IfNotPresent<br>        name: centos<br>        resources:<br>          limits:<br>            cpu: 200m<br>            memory: 128Mi<br>          requests:<br>            cpu: 100m<br>            memory: 64Mi<br>        securityContext: &#123;&#125;<br>      dnsPolicy: ClusterFirst<br>      imagePullSecrets:<br>      - name: qcloudregistrykey<br>      initContainers:<br>      - args:<br>        - -c<br>        - sysctl -w  net.ipv4.tcp_synack_retries=1 | sysctl -w  net.ipv4.tcp_syn_retries=1 | sysctl -w  net.ipv4.tcp_tw_recycle=1 | sysctl -w  net.ipv4.tcp_tw_reuse=1 | sysctl -w  net.ipv4.tcp_fin_timeout=1 |  sysctl -w  net.ipv4.tcp_keepalive_time=30 | sysctl -w  net.ipv4.ip_local_port_range=&quot;1024 65000&quot;<br>        command:<br>        - /bin/sh<br>        image: busybox:latest<br>        imagePullPolicy: Always<br>        name: initc<br>        securityContext:<br>          privileged: true<br><br></code></pre></td></tr></table></figure><h4 id="åœ¨TKEé‡Œé¢è®¾ç½®kubeletå‚æ•°"><a href="#åœ¨TKEé‡Œé¢è®¾ç½®kubeletå‚æ•°" class="headerlink" title="åœ¨TKEé‡Œé¢è®¾ç½®kubeletå‚æ•°"></a>åœ¨TKEé‡Œé¢è®¾ç½®kubeletå‚æ•°</h4><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://cloud.tencent.com/document/product/457/47775">https://cloud.tencent.com/document/product/457/47775</a></p><p>1ï¼Œéœ€è¦æäº¤å·¥å•ç”³è¯·åŠ ç™½åå•ï¼ˆæä¾›APPIDï¼Œä¸»è´¦å·UINï¼Œéœ€è¦ä¿®æ”¹çš„å‚æ•°åç§°ï¼Œç»„ä»¶ï¼Œé›†ç¾¤ç‰ˆæœ¬ï¼‰</p><p>2ï¼Œé›†ç¾¤ç°å­˜èŠ‚ç‚¹ï¼Œéœ€è¦å…ˆå°é”èŠ‚ç‚¹ï¼Œé©±é€èŠ‚ç‚¹PODï¼Œç„¶åå°†èŠ‚ç‚¹ç§»å‡ºç§»å…¥ï¼ˆç§»å‡ºç§»å…¥ä¼šé‡è£…æ“ä½œç³»ç»Ÿï¼Œè®°å¾—åšå¥½å¤‡ä»½ï¼Œå¦å¤–å°±æ˜¯ç§»å‡ºæ—¶å€™ä¸è¦å‹¾é€‰é”€æ¯æŒ‰é‡è®¡è´¹çš„èŠ‚ç‚¹ï¼ŒåŒ…å¹´åŒ…æœˆçš„èŠ‚ç‚¹ä¸å½±å“ï¼‰ï¼Œæ·»åŠ å·²æœ‰èŠ‚ç‚¹åŠ å…¥æ—¶å€™è®¾ç½®å‚æ•°ï¼Œæ–°å¢èŠ‚ç‚¹ç›´æ¥è®¾ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">allowed-unsafe-sysctls=&#x27;kernel.msg*,kernel.shm*,net.*&#x27;<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171524529.png" alt="image-20220917152451453"></p><p>æ›´å¤šå‚è€ƒK8Så®˜æ–¹æ–‡æ¡£ï¼š<a href="https://kubernetes.io/zh/docs/tasks/administer-cluster/sysctl-cluster/">https://kubernetes.io/zh/docs/tasks/administer-cluster/sysctl-cluster/</a></p>]]></content>
      
      
      <categories>
          
          <category> TKE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> TKE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TKEé›†ç¾¤NFSåŠ¨æ€åˆ›å»ºå­ç›®å½•æŒ‚è½½</title>
      <link href="/post/45e67b0c.html"/>
      <url>/post/45e67b0c.html</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p><a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">NFS subdir external provisioner</a>ç»„ä»¶æ˜¯ä½¿ç”¨ç°æœ‰çš„å’Œå·²é…ç½®çš„NFSæœåŠ¡å™¨æ¥æ”¯æŒé€šè¿‡æŒä¹…å·å£°æ˜åŠ¨æ€åˆ†å‘KubernetesæŒä¹…å·ã€‚æŒä¹…åŒ–å·æŒ‰ä»¥ä¸‹æ–¹å¼å‘½å${namespace}-${pvcName}-${pvName}ï¼Œåœ¨Kubernetes ç¯å¢ƒä¸­æˆ‘ä»¬ç»å¸¸é‡åˆ°æ˜¯ä¸€ä¸ªPVå¯¹åº”ä¸€ä¸ªNFSå®ä¾‹åœºæ™¯ï¼Œé’ˆå¯¹è¿™ç§åœºæ™¯å¦‚æœéœ€è¦å¤šä¸ªPVC&amp;PVä½¿ç”¨ä¸€ä¸ªNFSå®ä¾‹ï¼Œå°±éœ€è¦æå‰æ ¹æ®NFSä¸åŒå­ç›®å½•åˆ›å»ºå¤§é‡çš„PVç­‰å¾…PVCå»ç»‘å®šï¼Œä¸å¤ªå¥½ç»´æŠ¤ï¼Œå¯ä»¥ä½¿ç”¨<a href="https://github.com/kubernetes-sigs/nfs-subdir-external-provisioner">nfs-subdir-external-provisioner</a>æ’ä»¶æ¥å®ç°åŠ¨æ€åˆ›å»ºå­ç›®å½•çš„éœ€æ±‚ï¼Œä¸‹é¢ä¸»è¦æ¥ä»‹ç»ä¸‹</p><h2 id="éƒ¨ç½²å®‰è£…"><a href="#éƒ¨ç½²å®‰è£…" class="headerlink" title="éƒ¨ç½²å®‰è£…"></a>éƒ¨ç½²å®‰è£…</h2><p>ç¯å¢ƒå‡†å¤‡ï¼š</p><ul><li>kubernetesé›†ç¾¤ä¸€ä¸ªï¼Œæˆ‘è¿™é‡Œæ˜¯ä½¿ç”¨çš„æ˜¯è…¾è®¯äº‘TKEé›†ç¾¤</li><li>NFSæœåŠ¡å™¨å®ä¾‹ï¼Œæˆ–è€…ä½¿ç”¨äº‘å‚å•†æä¾›çš„NFSäº§å“</li><li>helmå®¢æˆ·ç«¯ï¼Œå¹¶ä¸”èƒ½å¤Ÿæ­£å¸¸é“¾æ¥åˆ°é›†ç¾¤</li></ul><h3 id="Helmæ–¹å¼å®‰è£…"><a href="#Helmæ–¹å¼å®‰è£…" class="headerlink" title="Helmæ–¹å¼å®‰è£…"></a>Helmæ–¹å¼å®‰è£…</h3><p>å¯ä»¥æ ¹æ®éœ€æ±‚ä¿®æ”¹æŒ‡å®šå‚æ•°åéƒ¨ç½²</p><blockquote><p>ç¡®ä¿æ‚¨çš„NFSæœåŠ¡å™¨å¯ä»¥ä»æ‚¨çš„Kubernetesé›†ç¾¤è®¿é—®ï¼Œå¹¶è·å–è¿æ¥åˆ°å®ƒæ‰€éœ€çš„ä¿¡æ¯ã€‚è‡³å°‘éœ€è¦å®ƒçš„ä¸»æœºåå’Œå…±äº«è·¯å¾„ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">$ helm repo add nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/<br><br><span class="hljs-comment"># helm repo list  #æŸ¥çœ‹æ·»åŠ helm repoä»“åº“æƒ…å†µ</span><br>NAME                            URL                                                               <br>tcr-chen-helm                   https://tcr-chen.tencentcloudcr.com/chartrepo/helm                <br>nfs-subdir-external-provisioner https://kubernetes-sigs.github.io/nfs-subdir-external-provisioner/<br><br><span class="hljs-comment"># ã€å¯é€‰æ­¥éª¤ï¼Œå¯ä»¥å°†helm chart åŒ…ä¸‹è½½ä¸‹æ¥ ä¸Šä¼ åˆ°è‡ªå·±çš„é•œåƒä»“åº“ï¼Œæ–¹ä¾¿åç»­å…¶ä»–é›†ç¾¤å®‰è£…ã€‘</span><br><span class="hljs-comment"># ä¸‹è½½ helm chart æ–‡ä»¶è‡³æœ¬åœ°ç›®å½•ï¼ŒæŸ¥çœ‹å¯ä»¥æŒ‡å®šçš„ values é€‰é¡¹ï¼ˆå¯é€‰ï¼‰</span><br>$ helm pull nfs-subdir-external-provisioner/nfs-subdir-external-provisioner --untar<br>$ tar  zcvf nfs-subdir-external-provisioner-1.0.0.tgz nfs-subdir-external-provisioner/<br>$ helm cm-push nfs-subdir-external-provisioner-1.0.0.tgz  tcr-chen-helm<br><span class="hljs-comment"># é»˜è®¤é•œåƒæ˜¯å›½å¤–é•œåƒï¼Œå¯ä»¥ä¸‹è½½ä¸‹æ¥ä¸Šä¼ åˆ°è‡ªå·±çš„é•œåƒä»“åº“é‡Œé¢</span><br>$ docker pull k8s.gcr.io/sig-storage/nfs-subdir-external-provisioner:v4.0.2<br>$ docker tag 932b0bface75 ccr.ccs.tencentyun.com/chenjingwei/nfs-subdir-external-provisioner:v4.0.2<br>$ docker push ccr.ccs.tencentyun.com/chenjingwei/nfs-subdir-external-provisioner:v4.0.2<br><br><br><br><span class="hljs-comment"># ä½¿ç”¨ç±»ä¼¼ä¸‹é¢å‘½ä»¤å®‰è£… nfs-subdir-external-provisioner èµ„æº</span><br><span class="hljs-comment">#  helm install nfs-subdir-external-provisioner nfs-subdir-external-provisioner/nfs-subdir-external-provisioner  \</span><br>--<span class="hljs-built_in">set</span> nfs.server=172.16.0.33  \<br>--<span class="hljs-built_in">set</span> nfs.path=/nfs  \<br>--<span class="hljs-built_in">set</span> image.repository=ccr.ccs.tencentyun.com/chenjingwei/nfs-subdir-external-provisioner \<br>--<span class="hljs-built_in">set</span> image.tag=v4.0.2<br><br><span class="hljs-comment">#å‡ºç°å¦‚ä¸‹æç¤º è¡¨ç¤ºå®‰è£…æˆåŠŸ</span><br>NAME: nfs-subdir-external-provisioner<br>LAST DEPLOYED: Tue Feb 15 13:22:03 2022<br>NAMESPACE: default<br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: Non<br></code></pre></td></tr></table></figure><h3 id="æ‰‹åŠ¨YAMLå®‰è£…"><a href="#æ‰‹åŠ¨YAMLå®‰è£…" class="headerlink" title="æ‰‹åŠ¨YAMLå®‰è£…"></a>æ‰‹åŠ¨YAMLå®‰è£…</h3><p>1ï¼Œåˆ›å»ºè´¦å·ServiceAccount</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: ServiceAccount<br>metadata:<br>  name: nfs-client-provisioner<br>  # replace with namespace where provisioner is deployed<br>  namespace: default<br>---<br>kind: ClusterRole<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: nfs-client-provisioner-runner<br>rules:<br>  - apiGroups: [&quot;&quot;]<br>    resources: [&quot;nodes&quot;]<br>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]<br>  - apiGroups: [&quot;&quot;]<br>    resources: [&quot;persistentvolumes&quot;]<br>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;delete&quot;]<br>  - apiGroups: [&quot;&quot;]<br>    resources: [&quot;persistentvolumeclaims&quot;]<br>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;update&quot;]<br>  - apiGroups: [&quot;storage.k8s.io&quot;]<br>    resources: [&quot;storageclasses&quot;]<br>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;]<br>  - apiGroups: [&quot;&quot;]<br>    resources: [&quot;events&quot;]<br>    verbs: [&quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]<br>---<br>kind: ClusterRoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: run-nfs-client-provisioner<br>subjects:<br>  - kind: ServiceAccount<br>    name: nfs-client-provisioner<br>    # replace with namespace where provisioner is deployed<br>    namespace: default<br>roleRef:<br>  kind: ClusterRole<br>  name: nfs-client-provisioner-runner<br>  apiGroup: rbac.authorization.k8s.io<br>---<br>kind: Role<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: leader-locking-nfs-client-provisioner<br>  # replace with namespace where provisioner is deployed<br>  namespace: default<br>rules:<br>  - apiGroups: [&quot;&quot;]<br>    resources: [&quot;endpoints&quot;]<br>    verbs: [&quot;get&quot;, &quot;list&quot;, &quot;watch&quot;, &quot;create&quot;, &quot;update&quot;, &quot;patch&quot;]<br>---<br>kind: RoleBinding<br>apiVersion: rbac.authorization.k8s.io/v1<br>metadata:<br>  name: leader-locking-nfs-client-provisioner<br>  # replace with namespace where provisioner is deployed<br>  namespace: default<br>subjects:<br>  - kind: ServiceAccount<br>    name: nfs-client-provisioner<br>    # replace with namespace where provisioner is deployed<br>    namespace: default<br>roleRef:<br>  kind: Role<br>  name: leader-locking-nfs-client-provisioner<br>  apiGroup: rbac.authorization.k8s.io<br></code></pre></td></tr></table></figure><p>2ï¼Œéƒ¨ç½²åº”ç”¨</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  name: nfs-client-provisioner<br>  labels:<br>    app: nfs-client-provisioner<br>  # replace with namespace where provisioner is deployed<br>  namespace: default<br>spec:<br>  replicas: 1<br>  strategy:<br>    type: Recreate<br>  selector:<br>    matchLabels:<br>      app: nfs-client-provisioner<br>  template:<br>    metadata:<br>      labels:<br>        app: nfs-client-provisioner<br>    spec:<br>      serviceAccountName: nfs-client-provisioner<br>      containers:<br>        - name: nfs-client-provisioner<br>          image: ccr.ccs.tencentyun.com/chenjingwei/nfs-subdir-external-provisioner:v4.0.2<br>          volumeMounts:<br>            - name: nfs-client-root<br>              mountPath: /persistentvolumes<br>          env:<br>            - name: PROVISIONER_NAME<br>              value: cluster.local/nfs-subdir-external-provisioner<br>            - name: NFS_SERVER<br>              value: 172.16.0.33              #æ›¿æ¢æˆè‡ªå·±çš„NFSæœåŠ¡å™¨åœ°å€<br>            - name: NFS_PATH<br>              value: /nfs                     #NFSä¸Šé¢çš„ç›®å½•<br>      volumes:<br>        - name: nfs-client-root<br>          nfs:<br>            server: 172.16.0.33<br>            path: /nfs<br></code></pre></td></tr></table></figure><p>3ï¼Œåˆ›å»ºstorageClass</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: storage.k8s.io/v1<br>kind: StorageClass<br>metadata:<br>  name: nfs-client<br>provisioner: cluster.local/nfs-subdir-external-provisioner # or choose another name, must match deployment&#x27;s env PROVISIONER_NAME&#x27;<br>parameters:<br>  archiveOnDelete: &quot;false&quot;<br></code></pre></td></tr></table></figure><h2 id="åŸºæœ¬ä½¿ç”¨"><a href="#åŸºæœ¬ä½¿ç”¨" class="headerlink" title="åŸºæœ¬ä½¿ç”¨"></a>åŸºæœ¬ä½¿ç”¨</h2><blockquote><p>å‰ææ˜¯nfs-subdir-external-provisionerç»„ä»¶å·²ç»æ­£å¸¸è¿è¡Œ</p></blockquote><p>1ï¼Œé…ç½®ä½¿ç”¨ CFS æ–‡ä»¶ç³»ç»Ÿå­ç›®å½•çš„ PVC </p><p>ä½¿ç”¨ä¸Šä¸€æ­¥éƒ¨ç½²çš„<code>nfs-subdir-external-provisioner</code>åŠ¨æ€åˆ›å»ºå­˜å‚¨å·ã€‚</p><p>éƒ¨ç½²åä¼šé»˜è®¤ç”Ÿæˆä¸€ä¸ª<strong>StorageClass</strong>ï¼Œé»˜è®¤å­˜å‚¨ç±»åæ˜¯â€nfs-clientâ€(ä¹Ÿå¯ä»¥åœ¨éƒ¨ç½²æ—¶è‡ªå®šä¹‰æŒ‡å®š)ï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># kubectl  get StorageClass | grep nfs-client<br>nfs-client          cluster.local/nfs-subdir-external-provisioner   4m8s<br></code></pre></td></tr></table></figure><p>2ï¼Œä½¿ç”¨ä¸Šé¢çš„<strong>StorageClass</strong>åˆ›å»ºPVC</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kind: PersistentVolumeClaim<br>apiVersion: v1<br>metadata:<br>  name: nfs-subdir-pvc<br>  namespace: cjweichen<br>spec:<br>  storageClassName: nfs-client<br>  accessModes:<br>    - ReadWriteMany<br>  resources:<br>    requests:<br>      storage: 10Gi<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># kubectl  get pvc<br>NAME              STATUS   VOLUME                                   CAPACITY   ACCESS MODES   STORAGECLASS    AGE<br>nfs-subdir-pvc    Bound    pvc-5fdb9f45-6e98-4a9b-b6e0-920a6c7a6edc   10Gi       RWX           nfs-client    76s<br></code></pre></td></tr></table></figure><p>ä¼šè‡ªåŠ¨åˆ›å»ºå‘½ä»¤ï¼Œå‘½ä»¤å‘½åæ–¹å¼æ˜¯${namespace}-${pvcName}-${pvName}</p><p>3ï¼ŒæŸ¥çœ‹è‡ªåŠ¨åˆ›å»ºçš„PVé…ç½®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209191352233.png" alt="image-20220919135239146"></p><p>4ï¼Œåˆ›å»ºworkload æŒ‚è½½å¯¹åº”PVC</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">cjweichen</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span> <span class="hljs-number">360000</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">centos:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">centos</span><br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/mnt</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>        <span class="hljs-attr">persistentVolumeClaim:</span><br>          <span class="hljs-attr">claimName:</span> <span class="hljs-string">nfs-subdir-pvc</span><br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># pwd</span><br>/nfs/cjweichen-nfs-subdir-pvc-pvc-5fdb9f45-6e98-4a9b-b6e0-920a6c7a6edc<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209191359304.png" alt="image-20220919135928232"></p>]]></content>
      
      
      <categories>
          
          <category> TKE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> NFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>TKEé›†ç¾¤ä½¿ç”¨è‡ªå»ºNFSæŒ‚è½½</title>
      <link href="/post/4588d79d.html"/>
      <url>/post/4588d79d.html</url>
      
        <content type="html"><![CDATA[<p><code>NFS</code>æ˜¯<code>Network File System</code>çš„ç¼©å†™ï¼Œå³<strong>ç½‘ç»œæ–‡ä»¶ç³»ç»Ÿ</strong>ï¼Œæ˜¯ä¸€ç§ä½¿ç”¨äºåˆ†æ•£å¼æ–‡ä»¶ç³»ç»Ÿçš„åå®šã€‚ä¸»è¦æ˜¯é€šè¿‡ç½‘ç»œè®©ä¸åŒçš„æœºå™¨ã€ä¸åŒçš„æ“ä½œç³»ç»Ÿèƒ½å¤Ÿå½¼æ­¤åˆ†äº«ä¸ªåˆ«çš„æ•°æ®ï¼Œè®©åº”ç”¨ç¨‹åºåœ¨å®¢æˆ·ç«¯é€šè¿‡ç½‘ç»œè®¿é—®ä½äºæœåŠ¡å™¨ç£ç›˜ä¸­çš„æ•°æ®ï¼Œæ˜¯åœ¨ç±»<code>Unix</code>ç³»ç»Ÿé—´å®ç°ç£ç›˜æ–‡ä»¶å…±äº«çš„ä¸€ç§æ–¹æ³•ã€‚è¿™ä¸ª<code>NFS</code>æœåŠ¡å™¨å¯ä»¥è®©ä½ çš„<code>PC</code>æ¥å°†ç½‘ç»œè¿œç¨‹çš„<code>NFS</code>æœåŠ¡å™¨åˆ†äº«çš„ç›®å½•ï¼ŒæŒ‚è½½åˆ°æœ¬åœ°ç«¯çš„æœºå™¨å½“ä¸­ï¼Œ åœ¨æœ¬åœ°ç«¯çš„æœºå™¨çœ‹èµ·æ¥ï¼Œé‚£ä¸ªè¿œç¨‹ä¸»æœºçš„ç›®å½•å°±å¥½åƒæ˜¯è‡ªå·±çš„ä¸€ä¸ªç£ç›˜åˆ†åŒºæ§½ä¸€æ ·ã€‚</p><p>æ›´å¤šNFSç›¸å…³åŸç†ç½‘ä¸Šæœ‰å¾ˆå¤šï¼Œè¿™é‡Œå°±ä¸åšå¤šä»‹ç»ï¼Œè¿™é‡Œæˆ‘ä»¬ä¸»è¦è¯´ä¸‹NFSå®‰è£…å’Œè…¾è®¯äº‘TKEé‡Œé¢å¦‚ä½•ä½¿ç”¨è‡ªå»ºNFSè¿›è¡ŒPODçš„æŒä¹…åŒ–å­˜å‚¨</p><h2 id="NFS-æœåŠ¡æ­å»º"><a href="#NFS-æœåŠ¡æ­å»º" class="headerlink" title="NFS æœåŠ¡æ­å»º"></a>NFS æœåŠ¡æ­å»º</h2><p>ç¯å¢ƒå‡†å¤‡</p><blockquote><p><code>CentOS7</code>ä»¥<code>NFSv4</code>ä½œä¸ºé»˜è®¤ç‰ˆæœ¬ï¼Œ<code>NFSv4</code>ä½¿ç”¨<code>TCP</code>åè®®ï¼ˆç«¯å£å·æ˜¯<code>2049</code>ï¼‰å’Œ<code>NFS</code>æœåŠ¡å™¨å»ºç«‹è¿æ¥ã€‚</p></blockquote><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># ç³»ç»Ÿç¯å¢ƒ</span><br>ç³»ç»Ÿå¹³å°ï¼šCentOS Linux release 7.9 (Final)<br>NFS Server IPï¼š192.168.0.17<br><br>é˜²ç«å¢™å·²å…³é—­/iptables: Firewall is not running.<br>SELINUX=disabled<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…-NFS-æœåŠ¡"><a href="#å®‰è£…-NFS-æœåŠ¡" class="headerlink" title="å®‰è£… NFS æœåŠ¡"></a>å®‰è£… NFS æœåŠ¡</h3><ul><li><p>NFSæœåŠ¡ç«¯</p><p>æœåŠ¡ç«¯ï¼Œç¨‹åºåŒ…å<code>nfs-utils</code>ã€<code>rpcbind</code>ï¼Œé»˜è®¤éƒ½å·²ç»å®‰è£…äº†</p><p>å¯ä»¥é€šè¿‡<code>rpm -ql nfs-utils</code>æŸ¥çœ‹å¸®åŠ©æ–‡æ¡£ç­‰ä¿¡æ¯</p></li><li><p>NFSå®¢æˆ·ç«¯</p><p>å®¢æˆ·ç«¯ï¼Œéœ€è¦å®‰è£…ç¨‹åºåŒ…å<code>nfs-utils</code>ï¼Œæä¾›åŸºæœ¬çš„å®¢æˆ·ç«¯å‘½ä»¤å·¥å…·</p></li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/nfs]<span class="hljs-comment"># yum install nfs-utils -y</span><br></code></pre></td></tr></table></figure><ul><li><p>æŸ¥çœ‹<code>NFS</code>æœåŠ¡ç«¯å£</p><p><code>NFS</code>å¯åŠ¨æ—¶ä¼šéšæœºå¯åŠ¨å¤šä¸ªç«¯å£å¹¶å‘<code>RPC</code>æ³¨å†Œï¼Œä¸ºäº†æ–¹ä¾¿é…ç½®é˜²ç«å¢™ï¼Œéœ€è¦å›ºå®š<code>NFS</code>æœåŠ¡ç«¯å£ã€‚</p><p>è¿™æ ·å¦‚æœä½¿ç”¨<code>iptables</code>å¯¹<code>NFS</code>ç«¯å£è¿›è¡Œé™åˆ¶å°±ä¼šæœ‰ç‚¹éº»çƒ¦ï¼Œå¯ä»¥æ›´æ”¹é…ç½®æ–‡ä»¶å›ºå®š<code>NFS</code>æœåŠ¡ç›¸å…³ç«¯å£</p><p>åˆ†é…ç«¯å£ï¼Œç¼–è¾‘é…ç½®æ–‡ä»¶<code>/etc/sysconfig/nfs</code></p></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># ä½¿ç”¨rpcinfo -Pä¼šå‘ç°rpcå¯åŠ¨äº†å¾ˆå¤šç›‘å¬ç«¯å£<br><br>[root@VM-0-17-tlinux ~/nfs]#  vim /etc/sysconfig/nfs<br>RQUOTAD_PORT=30001<br>LOCKD_TCPPORT=30002<br>LOCKD_UDPPORT=30002<br>MOUNTD_PORT=30003<br>STATD_PORT=30004<br></code></pre></td></tr></table></figure><p>å¯åŠ¨NFSæœåŠ¡ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~/nfs]# systemctl start nfs.service<br></code></pre></td></tr></table></figure><h3 id="NFSé…ç½®"><a href="#NFSé…ç½®" class="headerlink" title="NFSé…ç½®"></a>NFSé…ç½®</h3><p>ç›¸å…³æ–‡ä»¶å’Œå‘½ä»¤</p><table><thead><tr><th align="left">æ–‡ä»¶å</th><th align="left">è¯´æ˜</th></tr></thead><tbody><tr><td align="left"><strong><code>/etc/exports</code></strong></td><td align="left">NFS æœåŠ¡å™¨ç«¯éœ€è¦è®¾å®šçš„å†…å®¹ï¼Œå…¶ä½œç”¨æ˜¯è®¾å®šè°æ‹¥æœ‰ä»€ä¹ˆæ ·çš„æƒé™å»è®¿é—®æ­¤æœºå™¨çš„å“ªä¸ªç›®å½•</td></tr><tr><td align="left"><code>/var/lib/nfs/etab</code></td><td align="left">æ— éœ€è®¾å®šï¼Œç”¨äºçºªå½• NFS æœåŠ¡å™¨å®Œæ•´çš„æƒé™è®¾å®šï¼Œexports ä¸­æ²¡æœ‰è®¾å®šçš„ç¼ºçœå€¼ä¹Ÿä¼šè¢«åˆ—å‡º</td></tr><tr><td align="left"><code>/var/lib/nfs/xtab</code></td><td align="left">çºªå½• NFS è¿æ¥çš„ç›¸å…³ä¿¡æ¯</td></tr><tr><td align="left"><code>/usr/sbin/exportfs</code></td><td align="left">NFS è®¾å®šç®¡ç†å‘½ä»¤ï¼Œç”¨äº Server ä¾§è®¾å®šï¼Œé€šè¿‡æ­¤æ¡å‘½ä»¤ä½¿å¾— exports çš„è®¾å®šå˜å¾—æœ‰æ•ˆæˆ–è€…æ— æ•ˆ</td></tr><tr><td align="left"><code>/usr/sbin/showmount</code></td><td align="left">ç”¨äºæ˜¾ç¤º NFS è®¾å®šçš„ç›¸å…³ä¿¡æ¯ï¼ŒServer ç«¯å’Œ Client ç«¯å‡å¯</td></tr></tbody></table><p><strong>é…ç½®æ–‡ä»¶<code>/etc/exports</code></strong></p><p>æˆ‘ä»¬å¯ä»¥æŒ‰ç…§<strong>â€œå…±äº«ç›®å½•çš„è·¯å¾„ å…è®¸è®¿é—®çš„ NFS å®¢æˆ·ç«¯(å…±äº«æƒé™å‚æ•°)â€</strong>çš„æ ¼å¼ï¼Œå®šä¹‰è¦å…±äº«çš„ç›®å½•ä¸ç›¸åº”çš„æƒé™</p><table><thead><tr><th align="left">å¸¸ç”¨å‚æ•°</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left"><code>ro</code></td><td align="left">åªè¯»</td></tr><tr><td align="left"><code>rw</code></td><td align="left">è¯»å†™</td></tr><tr><td align="left"><code>sync</code></td><td align="left">åŒæ—¶å°†æ•°æ®å†™å…¥åˆ°å†…å­˜ä¸ç¡¬ç›˜ä¸­ï¼Œä¿è¯ä¸ä¸¢å¤±æ•°æ®</td></tr><tr><td align="left"><code>async</code></td><td align="left">ä¼˜å…ˆå°†æ•°æ®ä¿å­˜åˆ°å†…å­˜ï¼Œç„¶åå†å†™å…¥ç¡¬ç›˜ï¼›è¿™æ ·æ•ˆç‡æ›´é«˜ï¼Œä½†å¯èƒ½ä¼šä¸¢å¤±æ•°æ®</td></tr><tr><td align="left"><code>root_squash</code></td><td align="left">å½“ NFS å®¢æˆ·ç«¯ä»¥ root ç®¡ç†å‘˜è®¿é—®æ—¶ï¼Œæ˜ å°„ä¸º NFS æœåŠ¡å™¨çš„åŒ¿åç”¨æˆ·</td></tr><tr><td align="left"><code>all_squash</code></td><td align="left">æ— è®º NFS å®¢æˆ·ç«¯ä½¿ç”¨ä»€ä¹ˆè´¦æˆ·è®¿é—®ï¼Œå‡æ˜ å°„ä¸º NFS æœåŠ¡å™¨çš„åŒ¿åç”¨æˆ·</td></tr><tr><td align="left"><code>no_root_squash</code></td><td align="left">å½“ NFS å®¢æˆ·ç«¯ä»¥ root ç®¡ç†å‘˜è®¿é—®æ—¶ï¼Œæ˜ å°„ä¸º NFS æœåŠ¡å™¨çš„ root ç®¡ç†å‘˜</td></tr><tr><td align="left"><code>secure</code></td><td align="left">è¿™ä¸ªé€‰é¡¹æ˜¯ç¼ºçœé€‰é¡¹ï¼Œå®ƒä½¿ç”¨äº† 1024 ä»¥ä¸‹çš„ TCP&#x2F;IP ç«¯å£å®ç° NFS çš„è¿æ¥</td></tr><tr><td align="left"><code>insecure</code></td><td align="left">ç¦æ­¢ä½¿ç”¨äº† 1024 ä»¥ä¸‹çš„ TCP&#x2F;IP ç«¯å£å®ç° NFS çš„è¿æ¥</td></tr><tr><td align="left"><code>no_wdelay</code></td><td align="left">è¿™ä¸ªé€‰é¡¹å…³é—­å†™å»¶æ—¶ï¼Œå¦‚æœè®¾ç½®äº† asyncï¼Œé‚£ä¹ˆ NFS å°±ä¼šå¿½ç•¥è¿™ä¸ªé€‰é¡¹</td></tr><tr><td align="left"><code>nohide</code></td><td align="left">å¦‚æœå°†ä¸€ä¸ªç›®å½•æŒ‚è½½åˆ°å¦å¤–ä¸€ä¸ªç›®å½•ä¹‹ä¸Šï¼Œé‚£ä¹ˆåŸæ¥çš„ç›®å½•é€šå¸¸å°±è¢«éšè—èµ·æ¥æˆ–çœ‹èµ·æ¥åƒç©ºçš„ä¸€æ ·ã€‚è¦ç¦ç”¨è¿™ç§è¡Œä¸ºï¼Œéœ€å¯ç”¨ hide é€‰é¡¹</td></tr><tr><td align="left"><code>no_subtree_check</code></td><td align="left">è¿™ä¸ªé€‰é¡¹å…³é—­å­æ ‘æ£€æŸ¥ï¼Œå­æ ‘æ£€æŸ¥ä¼šæ‰§è¡Œä¸€äº›ä¸æƒ³å¿½ç•¥çš„å®‰å…¨æ€§æ£€æŸ¥ï¼Œç¼ºçœé€‰é¡¹æ˜¯å¯ç”¨å­æ ‘æ£€æŸ¥</td></tr><tr><td align="left"><code>no_auth_nlm</code></td><td align="left">è¿™ä¸ªé€‰é¡¹ä¹Ÿå¯ä»¥ä½œä¸º<code>insecure_locks</code>æŒ‡å®šï¼Œå®ƒå‘Šè¯‰ NFS å®ˆæŠ¤è¿›ç¨‹ä¸è¦å¯¹åŠ é”è¯·æ±‚è¿›è¡Œè®¤è¯ã€‚å¦‚æœå…³å¿ƒå®‰å…¨æ€§é—®é¢˜ï¼Œå°±è¦é¿å…ä½¿ç”¨è¿™ä¸ªé€‰é¡¹ã€‚ç¼ºçœé€‰é¡¹æ˜¯<code>auth_nlm</code>æˆ–<code>secure_locks</code>ã€‚</td></tr><tr><td align="left"><code>mp(mountpoint=path)</code></td><td align="left">é€šè¿‡æ˜¾å¼åœ°å£°æ˜è¿™ä¸ªé€‰é¡¹ï¼ŒNFS è¦æ±‚æŒ‚è½½æ‰€å¯¼å‡ºçš„ç›®å½•</td></tr><tr><td align="left"><code>fsid=num</code></td><td align="left">è¿™ä¸ªé€‰é¡¹é€šå¸¸éƒ½åœ¨ NFS æ•…éšœæ¢å¤çš„æƒ…å†µä¸­ä½¿ç”¨ï¼Œå¦‚æœå¸Œæœ›å®ç° NFS çš„æ•…éšœæ¢å¤ï¼Œè¯·å‚è€ƒ NFS æ–‡</td></tr></tbody></table><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/nfs]<span class="hljs-comment"># cat /etc/exports</span><br>/nfs 192.168.*.*(rw,<span class="hljs-built_in">sync</span>,root_squash)<br><br><span class="hljs-comment">#ä¿®æ”¹å®Œé…ç½®å é‡æ–°å¯åŠ¨nfsæœåŠ¡</span><br>[root@VM-0-17-tlinux ~/nfs]<span class="hljs-comment"># systemctl   restart nfs</span><br>[root@VM-0-17-tlinux ~/nfs]<span class="hljs-comment"># systemctl   status  nfs</span><br></code></pre></td></tr></table></figure><hr><h2 id="TKEä½¿ç”¨NFSæŒä¹…åŒ–æŒ‚è½½"><a href="#TKEä½¿ç”¨NFSæŒä¹…åŒ–æŒ‚è½½" class="headerlink" title="TKEä½¿ç”¨NFSæŒä¹…åŒ–æŒ‚è½½"></a>TKEä½¿ç”¨NFSæŒä¹…åŒ–æŒ‚è½½</h2><blockquote><p>å°†NFSæŒ‚åœ¨åˆ°K8Så®¹å™¨æœåŠ¡çš„PODé‡Œé¢</p></blockquote><h3 id="ç¤ºä¾‹ä¸€-inlineæ–¹å¼æŒ‚è½½"><a href="#ç¤ºä¾‹ä¸€-inlineæ–¹å¼æŒ‚è½½" class="headerlink" title="ç¤ºä¾‹ä¸€ inlineæ–¹å¼æŒ‚è½½"></a>ç¤ºä¾‹ä¸€ inlineæ–¹å¼æŒ‚è½½</h3><p>å®Œæ•´yamlï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: centos<br>  name: centos<br>  namespace: default<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      k8s-app: centos<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: centos<br>    spec:<br>      containers:<br>      - args:<br>        - -c<br>        - <span class="hljs-built_in">sleep</span> 360000<br>        <span class="hljs-built_in">command</span>:<br>        - /bin/sh<br>        image: centos:latest<br>        imagePullPolicy: IfNotPresent<br>        name: centos<br>        resources: &#123;&#125;<br>        volumeMounts:<br>        - mountPath: /mnt           <span class="hljs-comment">#PODé‡Œé¢çš„æŒ‚è½½è·¯å¾„</span><br>          name: nfs<br>      volumes:<br>      - name: nfs<br>        nfs:<br>          path: /nfs                       <span class="hljs-comment">#nfsæ–‡ä»¶é‡Œé¢ç›®å½•</span><br>          server: 192.168.0.17             <span class="hljs-comment">#NFSæœåŠ¡å™¨IP</span><br></code></pre></td></tr></table></figure><p>ç™»é™†NFSæœåŠ¡ åˆ›å»ºä¸ªä¸´æ—¶æ–‡ä»¶ï¼Œç„¶åç™»é™†PODé‡ŒæŸ¥çœ‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux ~/nfs]<span class="hljs-comment"># cd /nfs/</span><br>[root@VM-0-17-tlinux /nfs]<span class="hljs-comment"># echo  hello worload &gt; hello.txt</span><br>[root@VM-0-17-tlinux /nfs]<span class="hljs-comment"># cat hello.txt </span><br>hello worload<br><br><span class="hljs-comment">#ç™»å½•å®¹å™¨æŸ¥çœ‹æŒ‚ç€æƒ…å†µ</span><br>[root@VM-0-17-tlinux /nfs]<span class="hljs-comment"># kubectl  exec -it centos-54db87ccc9-nkx86 -- /bin/bash</span><br>[root@centos-54db87ccc9-nkx86 /]<span class="hljs-comment"># </span><br>[root@centos-54db87ccc9-nkx86 /]<span class="hljs-comment"># df -h</span><br>Filesystem         Size  Used Avail Use% Mounted on<br>overlay             50G   11G   37G  23% /<br>tmpfs               64M     0   64M   0% /dev<br>tmpfs              3.9G     0  3.9G   0% /sys/fs/cgroup<br>192.168.0.17:/nfs   50G   32G   16G  67% /mnt                        <span class="hljs-comment">#æŒ‚è½½ç‚¹ï¼Œå¯ä»¥çœ‹åˆ°å·²ç»æŒ‚è½½æˆåŠŸçš„</span><br>/dev/vda1           50G   11G   37G  23% /etc/hosts<br>shm                 64M     0   64M   0% /dev/shm<br>tmpfs              3.9G   12K  3.9G   1% /run/secrets/kubernetes.io/serviceaccount<br>tmpfs              3.9G     0  3.9G   0% /proc/acpi<br>tmpfs              3.9G     0  3.9G   0% /proc/scsi<br>tmpfs              3.9G     0  3.9G   0% /sys/firmware<br>[root@centos-54db87ccc9-nkx86 /]<span class="hljs-comment"># cd /mnt/</span><br>[root@centos-54db87ccc9-nkx86 mnt]<span class="hljs-comment"># cat hello.txt </span><br>hello worload<br>[root@centos-54db87ccc9-nkx86 mnt]<span class="hljs-comment"># echo 1111&gt;&gt; hello.txt         #åœ¨PODå¾€æ–‡ä»¶ç³»ç»Ÿé‡Œé¢å†™æ–‡ä»¶</span><br>bash: hello.txt: Permission denied                                <span class="hljs-comment">#æ²¡æœ‰æƒé™</span><br>[root@centos-54db87ccc9-nkx86 mnt]<span class="hljs-built_in">ls</span> -lrt<br>total 4<br>-rw-r--r-- 1 root root 14 Oct 17 13:14 hello.txt<br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ° ä¸Šé¢æˆ‘ä»¬çš„ NFSé…ç½®çš„æ˜¯root_squash</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/etc/exports<br>/nfs 192.168.*.*(rw,<span class="hljs-built_in">sync</span>,root_squash)<br><span class="hljs-comment">#æ˜¯æ²¡æœ‰æƒé™ä¿®æ”¹æ–‡ä»¶</span><br></code></pre></td></tr></table></figure><p>ä¸‹é¢æˆ‘ä»¬å°†é…ç½®æ–‡ä»¶ä¿®æ”¹æˆå¦‚ä¸‹é…ç½®è¿›è¡Œæµ‹è¯•</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-17-tlinux /nfs]<span class="hljs-comment"># cat /etc/exports</span><br>/nfs 192.168.*.*(rw,<span class="hljs-built_in">sync</span>,no_root_squash)<br><br><span class="hljs-comment">#é‡å¯NFS æœåŠ¡</span><br>[root@VM-0-17-tlinux /nfs]<span class="hljs-comment"># systemctl  restart nfs</span><br>[root@VM-0-17-tlinux /nfs]<span class="hljs-comment"># systemctl status nfs</span><br></code></pre></td></tr></table></figure><p>å°†PODé”€æ¯é‡å»ºåç™»å½•PODé‡Œæµ‹è¯•ã€‚å¯ä»¥ä¿®æ”¹æ–‡ä»¶ å¹¶ä¸”å¯ä»¥åˆ›å»ºæ–‡ä»¶</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@centos-54db87ccc9-rgnk8 mnt]<span class="hljs-comment"># touch 222</span><br>[root@centos-54db87ccc9-rgnk8 mnt]<span class="hljs-comment"># ls</span><br>222  hello.txt<br>[root@centos-54db87ccc9-rgnk8 mnt]<span class="hljs-comment"># echo &quot;1111&quot;&gt;&gt; hello.txt </span><br>[root@centos-54db87ccc9-rgnk8 mnt]<span class="hljs-comment"># cat hello.txt </span><br>hello worloada<br>1111<br>[root@centos-54db87ccc9-rgnk8 mnt]<span class="hljs-comment"># ls -lrt</span><br>total 4<br>-rw-r--r-- 1 root root  0 Oct 17 13:24 222<br>-rw-r--r-- 1 root root 20 Oct 17 13:28 hello.txt<br></code></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹äºŒ-PVC-amp-PVæ–¹å¼æŒ‚è½½"><a href="#ç¤ºä¾‹äºŒ-PVC-amp-PVæ–¹å¼æŒ‚è½½" class="headerlink" title="ç¤ºä¾‹äºŒ PVC&amp;PVæ–¹å¼æŒ‚è½½"></a>ç¤ºä¾‹äºŒ PVC&amp;PVæ–¹å¼æŒ‚è½½</h3><p>ä½¿ç”¨PVCå’ŒPVæ–¹å¼åˆ›å»ºå¹¶æŒ‚è½½ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolume</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pv-operationdata</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>     <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">capacity:</span><br>     <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span>                    <span class="hljs-comment">#é’ˆå¯¹NFSç±»æ–‡ä»¶å­˜å‚¨ï¼Œstorageå¤§å°æ²¡æœ‰å®é™…æ„ä¹‰</span><br>  <span class="hljs-attr">csi:</span><br>    <span class="hljs-attr">driver:</span> <span class="hljs-string">com.tencent.cloud.csi.cfs</span><br>    <span class="hljs-attr">volumeAttributes:</span><br>       <span class="hljs-attr">host:</span> <span class="hljs-number">192.168</span><span class="hljs-number">.0</span><span class="hljs-number">.17</span>                <span class="hljs-comment">#æ›¿æ¢æˆè‡ªå·±çš„NFS</span><br>       <span class="hljs-attr">path:</span> <span class="hljs-string">/nfs</span>                         <span class="hljs-comment">#æ›¿æ¢æˆè‡ªå·±çš„ç›®å½•</span><br>    <span class="hljs-attr">volumeHandle:</span> <span class="hljs-string">pv-operationdata</span><br>  <span class="hljs-attr">persistentVolumeReclaimPolicy:</span> <span class="hljs-string">Retain</span><br>  <span class="hljs-attr">volumeMode:</span> <span class="hljs-string">Filesystem</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">PersistentVolumeClaim</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">pvc-operationdata</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">accessModes:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">ReadWriteMany</span><br>  <span class="hljs-attr">resources:</span><br>    <span class="hljs-attr">requests:</span><br>      <span class="hljs-attr">storage:</span> <span class="hljs-string">10Gi</span><br>  <span class="hljs-attr">storageClassName:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">volumeMode:</span> <span class="hljs-string">Filesystem</span><br>  <span class="hljs-attr">volumeName:</span> <span class="hljs-string">pv-operationdata</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span> <span class="hljs-number">360000</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">centos:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">centos</span><br>        <span class="hljs-attr">resources:</span> &#123;&#125;<br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/mnt</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>        <span class="hljs-attr">persistentVolumeClaim:</span><br>          <span class="hljs-attr">claimName:</span> <span class="hljs-string">pvc-operationdata</span><br><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209191031509.png" alt="1634478174556"></p><h3 id="ç¤ºä¾‹ä¸‰-CVMæœåŠ¡å™¨ç«¯æŒ‚è½½"><a href="#ç¤ºä¾‹ä¸‰-CVMæœåŠ¡å™¨ç«¯æŒ‚è½½" class="headerlink" title="ç¤ºä¾‹ä¸‰  CVMæœåŠ¡å™¨ç«¯æŒ‚è½½"></a>ç¤ºä¾‹ä¸‰  CVMæœåŠ¡å™¨ç«¯æŒ‚è½½</h3><ul><li>ä½¿ç”¨<code>showmount</code>å‘½ä»¤æŸ¥è¯¢<code>NFS</code>æœåŠ¡å™¨çš„è¿œç¨‹å…±äº«ä¿¡æ¯</li><li><code>showmount</code>å‘½ä»¤è¾“å‡ºæ ¼å¼ä¸º<strong>â€œå…±äº«çš„ç›®å½•åç§° å…è®¸ä½¿ç”¨å®¢æˆ·ç«¯åœ°å€â€</strong></li></ul><p>showmount&#96;å‘½ä»¤**</p><table><thead><tr><th align="left">å‚æ•°</th><th align="left">ä½œç”¨</th></tr></thead><tbody><tr><td align="left"><code>-e</code></td><td align="left">æ˜¾ç¤º NFS æœåŠ¡å™¨çš„å…±äº«åˆ—è¡¨</td></tr><tr><td align="left"><code>-a</code></td><td align="left">æ˜¾ç¤ºæœ¬æœºæŒ‚è½½çš„æ–‡ä»¶èµ„æºçš„æƒ…å†µ NFS èµ„æºçš„æƒ…å†µ</td></tr><tr><td align="left"><code>-v</code></td><td align="left">æ˜¾ç¤ºç‰ˆæœ¬å·</td></tr></tbody></table><p><strong><code>exportfs</code>å‘½ä»¤</strong></p><ul><li>ç»´æŠ¤<code>exports</code>æ–‡ä»¶å¯¼å‡ºçš„æ–‡ä»¶ç³»ç»Ÿè¡¨çš„ä¸“ç”¨å·¥å…·ï¼Œå¯ä»¥ä¿®æ”¹é…ç½®ä¹‹åä¸é‡å¯<code>NFS</code>æœåŠ¡</li><li><code>export -ar</code>ï¼šé‡æ–°å¯¼å‡ºæ‰€æœ‰çš„æ–‡ä»¶ç³»ç»Ÿ</li><li><code>export -au</code>ï¼šå…³é—­å¯¼å‡ºçš„æ‰€æœ‰æ–‡ä»¶ç³»ç»Ÿ</li><li><code>export -u FS</code>:ï¼šå…³é—­æŒ‡å®šçš„å¯¼å‡ºçš„æ–‡ä»¶ç³»ç»Ÿ</li></ul><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŸ¥çœ‹NFSæœåŠ¡å™¨ç«¯å…±äº«çš„æ–‡ä»¶ç³»ç»Ÿ</span><br><span class="hljs-comment"># showmount -e NFSSERVER_IP</span><br>[root@VM-0-17-tlinux ~/nfs]<span class="hljs-comment">#  showmount -e 192.168.0.17</span><br>Export list <span class="hljs-keyword">for</span> 192.168.0.17:<br>/nfs 192.168.*.*<br><br><span class="hljs-comment"># NFSå®¢æˆ·ç«¯åˆ›å»ºä¸€ä¸ªæŒ‚è½½ç›®å½•ï¼ŒæŒ‚è½½æœåŠ¡ç«¯NFSæ–‡ä»¶ç³»ç»Ÿåˆ°æœ¬åœ°</span><br><span class="hljs-comment"># mount -t nfs SERVER:/path/to/sharedfs  /path/to/mount_point</span><br>[root@VM-0-11-tlinux ~]<span class="hljs-comment"># mkdir /nfsfile</span><br>[root@VM-0-11-tlinux ~]<span class="hljs-comment"># mount -t nfs 192.168.0.17:/nfs /nfsfile</span><br>[root@VM-0-11-tlinux ~]<span class="hljs-comment"># df -h | grep nfsfile</span><br>192.168.0.17:/nfs    50G   32G   16G  67% /nfsfile<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># æŒ‚è½½æˆåŠŸåå°±åº”è¯¥èƒ½å¤Ÿé¡ºåˆ©åœ°çœ‹åˆ°åœ¨æ‰§è¡Œå‰é¢çš„æ“ä½œæ—¶å†™å…¥çš„æ–‡ä»¶å†…å®¹äº†</span><br>[root@VM-0-11-tlinux ~]<span class="hljs-comment"># cat /nfsfile/hello.txt </span><br>hello worloada<br>1111<br><br><span class="hljs-comment"># å¦‚æœå¸Œæœ›NFSæ–‡ä»¶å…±äº«æœåŠ¡èƒ½ä¸€ç›´æœ‰æ•ˆï¼Œåˆ™éœ€è¦å°†å…¶å†™å…¥åˆ°fstabæ–‡ä»¶ä¸­</span><br><span class="hljs-comment"># SERVER:/PATH/TO/EXPORTED_FS  /mount_point  nfs  defaults,_netdev  0  0</span><br>[root@VM-0-11-tlinux ~]<span class="hljs-comment">#  vim /etc/fstab</span><br>192.168.0.17:/nfs  /nfsfile nfs defaults 0 0<br></code></pre></td></tr></table></figure><h3 id="ç¤ºä¾‹å››-TKEéƒ¨ç½²mysqlæŒ‚è½½"><a href="#ç¤ºä¾‹å››-TKEéƒ¨ç½²mysqlæŒ‚è½½" class="headerlink" title="ç¤ºä¾‹å››  TKEéƒ¨ç½²mysqlæŒ‚è½½"></a>ç¤ºä¾‹å››  TKEéƒ¨ç½²mysqlæŒ‚è½½</h3><blockquote><p>ä»¥ä¸‹ç¤ºä¾‹ä½¿ç”¨çš„æ˜¯å¦å¤–æ­å»ºçš„NFSå®ä¾‹</p></blockquote><p>éƒ¨ç½²mysqlæœåŠ¡æŒ‚è½½è‡ªå»ºNFSï¼Œè¿™é‡Œæ˜¯åœ¨NFSé‡Œé¢åˆ›å»ºäº†å­ç›®å½•ï¼Œé€šè¿‡å­ç›®å½•æŒ‚è½½åˆ°mysqlçš„æ•°æ®ç›®å½•é‡Œé¢</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">mysql</span><br>      <span class="hljs-attr">qcloud-app:</span> <span class="hljs-string">mysql</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">mysql</span><br>        <span class="hljs-attr">qcloud-app:</span> <span class="hljs-string">mysql</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;123456&quot;</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span><br>        <span class="hljs-attr">resources:</span> &#123;&#125;<br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/mysql</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>          <span class="hljs-attr">subPath:</span> <span class="hljs-string">mysql_docker/data</span>   <span class="hljs-comment">#æŒ‚è½½çš„æ˜¯NFSå­ç›®å½•</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>        <span class="hljs-attr">nfs:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/nfs</span>           <br>          <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.33</span>           <span class="hljs-comment">#NFSæœåŠ¡å™¨</span><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209191200093.png" alt="image-20220919120020874"></p><h3 id="ç¤ºä¾‹äº”-è¶…çº§èŠ‚ç‚¹PODæŒ‚è½½"><a href="#ç¤ºä¾‹äº”-è¶…çº§èŠ‚ç‚¹PODæŒ‚è½½" class="headerlink" title="ç¤ºä¾‹äº” è¶…çº§èŠ‚ç‚¹PODæŒ‚è½½"></a>ç¤ºä¾‹äº” è¶…çº§èŠ‚ç‚¹PODæŒ‚è½½</h3><p>æŒ‚è½½è‡ªå»ºçš„ nfs æ—¶ï¼Œäº‹ä»¶å¯èƒ½ä¼šæŠ¥ Operation not permitted</p><p>å¦‚æœä½¿ç”¨è‡ªå»ºçš„ nfs å®ç°æŒä¹…åŒ–å­˜å‚¨æ—¶ï¼Œè¿æ¥æ—¶äº‹ä»¶æŠ¥ Operation not permittedã€‚éœ€è¦ä¿®æ”¹è‡ªå»º nfs çš„ &#x2F;etc&#x2F;exports æ–‡ä»¶ï¼Œæ·»åŠ  &#x2F;<path><ip-range>(rw,insecure) å‚æ•°ï¼Œç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">/nfs  172.16.*.*(rw,insecure)<br></code></pre></td></tr></table></figure><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">cjweichen</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">centos</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">affinity:</span><br>        <span class="hljs-attr">nodeAffinity:</span><br>          <span class="hljs-attr">requiredDuringSchedulingIgnoredDuringExecution:</span><br>            <span class="hljs-attr">nodeSelectorTerms:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">matchExpressions:</span><br>              <span class="hljs-bullet">-</span> <span class="hljs-attr">key:</span> <span class="hljs-string">kubernetes.io/hostname</span><br>                <span class="hljs-attr">operator:</span> <span class="hljs-string">In</span><br>                <span class="hljs-attr">values:</span><br>                <span class="hljs-bullet">-</span> <span class="hljs-string">eklet-subnet-myqjfu7t</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">args:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">-c</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">sleep</span> <span class="hljs-number">360000</span><br>        <span class="hljs-attr">command:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-string">/bin/sh</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">centos:latest</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">centos</span><br>        <span class="hljs-attr">resources:</span> &#123;&#125;<br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/mnt</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>      <span class="hljs-attr">restartPolicy:</span> <span class="hljs-string">Always</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs</span><br>        <span class="hljs-attr">persistentVolumeClaim:</span><br>          <span class="hljs-attr">claimName:</span> <span class="hljs-string">pvc-operationdata</span><br></code></pre></td></tr></table></figure><p>mysqlæŒ‚è½½è‡ªå»ºNFS ä½¿ç”¨inlineæ–¹å¼</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">StatefulSet</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">mysql-nfs-eks</span><br>    <span class="hljs-attr">qcloud-app:</span> <span class="hljs-string">mysql-nfs-eks</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">mysql-nfs-eks</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">mysql-nfs-eks</span><br>      <span class="hljs-attr">qcloud-app:</span> <span class="hljs-string">mysql-nfs-eks</span><br>  <span class="hljs-attr">serviceName:</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">k8s-app:</span> <span class="hljs-string">mysql-nfs-eks</span><br>        <span class="hljs-attr">qcloud-app:</span> <span class="hljs-string">mysql-nfs-eks</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">env:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">MYSQL_ROOT_PASSWORD</span><br>          <span class="hljs-attr">value:</span> <span class="hljs-string">&quot;12345&quot;</span><br>        <span class="hljs-attr">image:</span> <span class="hljs-string">mysql:5.7</span><br>        <span class="hljs-attr">imagePullPolicy:</span> <span class="hljs-string">IfNotPresent</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">mysql</span><br>        <span class="hljs-attr">resources:</span> &#123;&#125;<br>        <span class="hljs-attr">volumeMounts:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">mountPath:</span> <span class="hljs-string">/var/lib/mysql</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-vol</span><br>          <span class="hljs-attr">subPath:</span> <span class="hljs-string">mysql_docker/data</span><br>      <span class="hljs-attr">dnsPolicy:</span> <span class="hljs-string">ClusterFirst</span><br>      <span class="hljs-attr">volumes:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">nfs-vol</span><br>        <span class="hljs-attr">nfs:</span><br>          <span class="hljs-attr">path:</span> <span class="hljs-string">/nfs</span><br>          <span class="hljs-attr">server:</span> <span class="hljs-number">172.16</span><span class="hljs-number">.0</span><span class="hljs-number">.33</span><br><br><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209191240338.png" alt="image-20220919124024264"></p><p>TKEé‡Œé¢ä½¿ç”¨NFSä»‹ç»å°±åˆ°è¿™é‡Œï¼Œä¸‹ä¸€ç¯‡ä»‹ç»ä¸‹å¦‚ä½•ä¸ºNFS åŠ¨æ€åˆ›å»ºä¸åŒå­ç›®å½•çš„ PVCç”¨äºPODæŒ‚è½½</p><p>æ„Ÿè°¢ï¼</p>]]></content>
      
      
      <categories>
          
          <category> TKE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> NFS </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kube-state-metricséƒ¨ç½²å®‰è£…</title>
      <link href="/post/b9437839.html"/>
      <url>/post/b9437839.html</url>
      
        <content type="html"><![CDATA[<h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>åœ¨kubernetesé›†ç¾¤ä¸­å·²ç»æœ‰äº† cadvisorã€heapsterã€metric-serverï¼ŒåŸºæœ¬ä¸Šå®¹å™¨è¿è¡Œçš„æ‰€æœ‰æŒ‡æ ‡éƒ½èƒ½æ‹¿åˆ°ï¼Œä½†æ˜¯é’ˆå¯¹ä¸‹é¢è¿™ç§æƒ…å†µè·å–ä¸åˆ°ï¼š</p><ul><li>æ¯”å¦‚è°ƒåº¦äº†å¤šå°‘ä¸ª replicasset ï¼Œç°åœ¨å¯ç”¨çš„æœ‰å‡ ä¸ªï¼Ÿ</li><li>å¤šå°‘ä¸ª Pod æ˜¯ running&#x2F;stopped&#x2F;terminated çŠ¶æ€ï¼Ÿ</li><li>Pod é‡å¯äº†å¤šå°‘æ¬¡ï¼Ÿ</li><li>æœ‰å¤šå°‘ job åœ¨è¿è¡Œä¸­</li></ul><p>è€Œè¿™äº›æŒ‡æ ‡é‡‡é›†åˆ™éœ€è¦ kube-state-metrics è¿›è¡Œé‡‡é›†ï¼Œå®ƒåŸºäº client-go å¼€å‘ï¼Œè´Ÿè´£ç›‘å¬ K8s apiserver ä»è€Œç”Ÿæˆmetricsæ•°æ®ï¼ŒæŒ‡æ ‡æ•°æ®é€šè¿‡ <code>/metrics</code> Endpoint æš´éœ²ï¼Œä¸»è¦æ˜¯é€‚é… Prometheus</p><h2 id="éƒ¨ç½²å®‰è£…"><a href="#éƒ¨ç½²å®‰è£…" class="headerlink" title="éƒ¨ç½²å®‰è£…"></a>éƒ¨ç½²å®‰è£…</h2><p><strong>1ï¼Œä¸‹è½½å°† <a href="https://github.com/kubernetes/kube-state-metrics/blob/master/examples/standard">kube-state-metrics examples</a> å‡ ä¸ªæ–‡ä»¶ï¼Œåˆ†åˆ«ä¸º</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kube-state-metrics/    <br>â”œâ”€â”€ cluster-role-binding.yaml  <br>â”œâ”€â”€ cluster-role-binding.yaml   <br>â”œâ”€â”€ deployment.yaml    <br>â”œâ”€â”€ service-account.yaml   <br>â”œâ”€â”€ service.yaml    <br></code></pre></td></tr></table></figure><p><strong>2ï¼Œä¿®æ”¹é•œåƒåœ°å€</strong>ï¼ˆé»˜è®¤é•œåƒåœ°å€k8s.gcr.io åœ¨å›½å¤–ã€‚å¯ä»¥æ‰¾ä¸ªæµ·å¤–æœºå™¨æ‹‰å–ä¸‹æ¥ä¸Šä¼ åˆ°å›½å†…é•œåƒä»“åº“è¿›è¡Œæ‹‰å–ä¸Šä¼ åˆ°è‡ªå·±çš„é•œåƒä»“åº“é‡Œé¢ï¼‰</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">- image: registry.k8s.io/kube-state-metrics/kube-state-metrics:v2.6.0<br><br><span class="hljs-comment">#æœ¬äººå·²ç»æ‹‰å–åˆ°è‡ªå·±é•œåƒä»“åº“ å¯ä»¥ä¿®æ”¹æˆ</span><br>- image: ccr.ccs.tencentyun.com/chenjingwei/kube-state-metrics:v2.6.0<br></code></pre></td></tr></table></figure><p><strong>3ï¼Œå®‰è£…kube-state-metrics</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">kubectl apply -f ./<br></code></pre></td></tr></table></figure><p><strong>4ï¼ŒæŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸ</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># kubectl get pods -n kube-system -o wide | grep kube-state-metrics</span><br>kube-state-metrics-57768576b6-mh5d8   1/1     Running   0   2m19s   172.16.0.12      172.30.249.130   &lt;none&gt;      &lt;none&gt;<br><br><span class="hljs-comment">#é€šè¿‡ /healthz å¥åº·æ£€æŸ¥ç«¯å£æŸ¥çœ‹PodçŠ¶æ€ã€‚</span><br><span class="hljs-comment"># curl  172.16.0.12:8080/healthz</span><br>OK<br><br><br><span class="hljs-comment">#é€šè¿‡ /metrics æ¥å£å¯æŸ¥çœ‹å…¶é‡‡é›†çš„å…¨é‡æ•°æ®</span><br><span class="hljs-comment"># curl 172.16.0.12:8080/metrics</span><br><br><span class="hljs-comment">#ç™»é™†å¯åŠ¨PODé‡Œé¢è®¿é—®æµ‹è¯•</span><br>[root@centos-777bdddd57-zv7bv /]<span class="hljs-comment"># curl kube-state-metrics.kube-system.svc.cluster.local:8080</span><br>&lt;html&gt;<br>             &lt;<span class="hljs-built_in">head</span>&gt;&lt;title&gt;Kube Metrics Server&lt;/title&gt;&lt;/head&gt;<br>             &lt;body&gt;<br>             &lt;h1&gt;Kube Metrics&lt;/h1&gt;<br>                         &lt;ul&gt;<br>             &lt;li&gt;&lt;a href=<span class="hljs-string">&#x27;/metrics&#x27;</span>&gt;metrics&lt;/a&gt;&lt;/li&gt;<br>             &lt;li&gt;&lt;a href=<span class="hljs-string">&#x27;/healthz&#x27;</span>&gt;healthz&lt;/a&gt;&lt;/li&gt;<br>                         &lt;/ul&gt;<br>             &lt;/body&gt;<br>&lt;/html&gt;<br><span class="hljs-comment">#è¡¨ç¤ºå®‰è£…æˆåŠŸ</span><br></code></pre></td></tr></table></figure><blockquote><p>å¯åŠ¨æ—¶å€™æœ‰å¯èƒ½ç«¯å£å†²çª å¯ä»¥æŒ‰ç…§å¦‚ä¸‹æ–‡æ¡£ æ·»åŠ å¯åŠ¨å‚æ•°ï¼Œ<a href="https://github.com/bitnami/bitnami-docker-kube-state-metrics/blob/2.1.0-debian-10-r15/2/debian-10/Dockerfile">å‚è€ƒæ–‡æ¡£</a></p></blockquote><h2 id="ä¸prometheusé›†æˆ"><a href="#ä¸prometheusé›†æˆ" class="headerlink" title="ä¸prometheusé›†æˆ"></a>ä¸prometheusé›†æˆ</h2><p>ä¿®æ”¹prometheusé…ç½®æ–‡ä»¶ï¼Œæ·»åŠ job_name</p><blockquote><p>kube-state-metricsæ˜¯éƒ¨ç½²åœ¨kube-systemå‘½åç©ºé—´ä¸‹çš„ï¼Œå› æ­¤åœ¨æ­£åˆ™åŒ¹é…ä¸Šï¼Œå‘½åç©ºé—´ä¸ºkube-systemï¼Œsvcåç§°ä¸ºkube-state-metricsï¼Œå¦åˆ™å°±ä¸è¿›è¡Œç›‘æ§ï¼Œk8s kube-state-metricsç›‘æ§ä»»åŠ¡</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml">  <span class="hljs-attr">job_name:</span> <span class="hljs-string">&quot;kube-state-metrics&quot;</span><br>  <span class="hljs-attr">kubernetes_sd_configs:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">endpoints</span><br>  <span class="hljs-attr">relabel_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__meta_kubernetes_namespace</span>, <span class="hljs-string">__meta_kubernetes_endpoints_name</span>]<br>    <span class="hljs-attr">regex:</span> <span class="hljs-string">kube-system;kube-state-metrics</span><br>    <span class="hljs-attr">action:</span> <span class="hljs-string">keep</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">bearer_token_file:</span> <span class="hljs-string">/var/run/secrets/kubernetes.io/serviceaccount/token</span><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172207163.png" alt="image-20220917220729053"></p><p><strong>6ï¼ŒæŸ¥çœ‹prometheusçš„targets</strong></p><p>éƒ¨ç½²æˆåŠŸåï¼Œprometheusçš„targetä¼šå‡ºç°å¦‚ä¸‹æ ‡å¿—</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172153353.png" alt="image-20220917215311281"></p><p>å¯ä»¥çœ‹åˆ°kube-state-metricsç›‘æ§ä»»åŠ¡ä¸‹å·²ç»æœ‰ä¸¤ä¸ªTargetså®ä¾‹äº†ã€‚æˆ‘ä»¬å¯ä»¥åˆ°grupç•Œé¢é€šè¿‡PromQLè¯­å¥æŸ¥è¯¢ç›¸å…³ç›‘æ§æ•°æ®ã€‚</p><p>ç¤ºä¾‹ï¼š æŸ¥çœ‹å½“å‰K8sé›†ç¾¤æœ‰å¤šå°‘configmapèµ„æºå¯¹è±¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">count(kube_configmap_created)<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172156719.png" alt="image-20220917215648632"></p><p>ä½¿ç”¨ kube-state-metrics åçš„å¸¸ç”¨åœºæ™¯æœ‰ï¼š</p><ul><li><p>å­˜åœ¨æ‰§è¡Œå¤±è´¥çš„ Job</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kube_job_status_failed&#123;job=&quot;kubernetes-service-endpoints&quot;,k8s_app=&quot;kube-state-metrics&quot;&#125;==1</span><br></code></pre></td></tr></table></figure></li><li><p>é›†ç¾¤èŠ‚ç‚¹çŠ¶æ€é”™è¯¯</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kube_node_status_condition&#123;condition=&quot;Ready&quot;,status!=&quot;true&quot;&#125;==1</span><br></code></pre></td></tr></table></figure></li><li><p>é›†ç¾¤ä¸­å­˜åœ¨å¯åŠ¨å¤±è´¥çš„ Pod</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">kube_pod_status_phase&#123;phase=~&quot;Failed|Unknown|Pending&quot;&#125;==1</span><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172218318.png" alt="image-20220917221857125"></p></li><li><p>æœ€è¿‘30åˆ†é’Ÿå†…æœ‰ Pod å®¹å™¨é‡å¯</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-string">changes(kube_pod_container_status_restarts[30m])&gt;0</span><br></code></pre></td></tr></table></figure></li><li><p>æŸ¥çœ‹å½“å‰é›†ç¾¤æœ‰å¤šå°‘ä¸ªPodæ­£åœ¨è¿è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">count (kube_pod_container_state_started)<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172202253.png" alt="image-20220917220259158"></p></li></ul><p>é…åˆæŠ¥è­¦alertmanagerå¯ä»¥æ›´å¥½åœ°ç›‘æ§é›†ç¾¤çš„è¿è¡Œ</p><h2 id="ä¸metric-serverçš„å¯¹æ¯”"><a href="#ä¸metric-serverçš„å¯¹æ¯”" class="headerlink" title="ä¸metric-serverçš„å¯¹æ¯”"></a>ä¸metric-serverçš„å¯¹æ¯”</h2><ul><li>metric-serverï¼ˆæˆ–heapsterï¼‰æ˜¯ä» api-server ä¸­è·å– cpuã€å†…å­˜ä½¿ç”¨ç‡è¿™ç§ç›‘æ§æŒ‡æ ‡ï¼Œå¹¶æŠŠä»–ä»¬å‘é€ç»™å­˜å‚¨åç«¯ï¼Œå¦‚ influxdb æˆ–äº‘å‚å•†ï¼Œä»–å½“å‰çš„æ ¸å¿ƒä½œç”¨æ˜¯ï¼šä¸º HPA ç­‰ç»„ä»¶æä¾›å†³ç­–æŒ‡æ ‡æ”¯æŒã€‚</li><li>kube-state-metrics å…³æ³¨äºè·å– k8s å„ç§èµ„æºçš„æœ€æ–°çŠ¶æ€ï¼Œå¦‚ deployment æˆ–è€… daemonsetï¼Œä¹‹æ‰€ä»¥æ²¡æœ‰æŠŠkube-state-metrics çº³å…¥åˆ° metric-server çš„èƒ½åŠ›ä¸­ï¼Œæ˜¯å› ä¸ºä»–ä»¬çš„å…³æ³¨ç‚¹æœ¬è´¨ä¸Šæ˜¯ä¸ä¸€æ ·çš„ã€‚metric-serverä»…ä»…æ˜¯è·å–ã€æ ¼å¼åŒ–ç°æœ‰æ•°æ®ï¼Œå†™å…¥ç‰¹å®šçš„å­˜å‚¨ï¼Œå®è´¨ä¸Šæ˜¯ä¸€ä¸ªç›‘æ§ç³»ç»Ÿã€‚è€Œ kube-state-metrics æ˜¯å°† k8s çš„è¿è¡ŒçŠ¶å†µåœ¨å†…å­˜ä¸­åšäº†ä¸ªå¿«ç…§ï¼Œå¹¶ä¸”è·å–æ–°çš„æŒ‡æ ‡ï¼Œä½†ä»–æ²¡æœ‰èƒ½åŠ›å¯¼å‡ºè¿™äº›æŒ‡æ ‡</li><li>æ¢ä¸ªè§’åº¦è®²ï¼Œkube-state-metrics æœ¬èº«æ˜¯ metric-server çš„ä¸€ç§æ•°æ®æ¥æºï¼Œè™½ç„¶ç°åœ¨æ²¡æœ‰è¿™ä¹ˆåšã€‚</li><li>å¦å¤–ï¼Œåƒ Prometheus è¿™ç§ç›‘æ§ç³»ç»Ÿï¼Œå¹¶ä¸ä¼šå»ç”¨ metric-server ä¸­çš„æ•°æ®ï¼Œä»–éƒ½æ˜¯è‡ªå·±åšæŒ‡æ ‡æ”¶é›†ã€é›†æˆçš„ï¼ˆPrometheusåŒ…å«äº†metric-serverçš„èƒ½åŠ›ï¼‰ï¼Œä½† Prometheus å¯ä»¥ç›‘æ§ metric-server æœ¬èº«ç»„ä»¶çš„ç›‘æ§çŠ¶æ€å¹¶é€‚æ—¶æŠ¥è­¦ï¼Œè¿™é‡Œçš„ç›‘æ§å°±å¯ä»¥é€šè¿‡ kube-state-metrics æ¥å®ç°ï¼Œå¦‚ metric-server pod çš„è¿è¡ŒçŠ¶æ€ã€‚</li></ul><h2 id="ä¼˜åŒ–ç‚¹å’Œé—®é¢˜"><a href="#ä¼˜åŒ–ç‚¹å’Œé—®é¢˜" class="headerlink" title="ä¼˜åŒ–ç‚¹å’Œé—®é¢˜"></a>ä¼˜åŒ–ç‚¹å’Œé—®é¢˜</h2><ul><li>å› ä¸º kube-state-metrics æ˜¯ç›‘å¬èµ„æºçš„ addã€deleteã€update äº‹ä»¶ï¼Œé‚£ä¹ˆåœ¨ kube-state-metrics éƒ¨ç½²ä¹‹å‰å·²ç»è¿è¡Œçš„èµ„æºï¼Œå²‚ä¸æ˜¯æ‹¿ä¸åˆ°æ•°æ®ï¼Ÿkube-state-metric åˆ©ç”¨ client-go å¯ä»¥åˆå§‹åŒ–æ‰€æœ‰å·²ç»å­˜åœ¨çš„èµ„æºå¯¹è±¡ï¼Œç¡®ä¿æ²¡æœ‰ä»»ä½•é—æ¼</li><li>kube-state-metrics å½“å‰ä¸ä¼šè¾“å‡º metadata ä¿¡æ¯(å¦‚ help å’Œ descriptionï¼‰</li><li>ç¼“å­˜å®ç°æ˜¯åŸºäº golang çš„ mapï¼Œè§£å†³å¹¶å‘è¯»é—®é¢˜å½“æœŸæ˜¯ç”¨äº†ä¸€ä¸ªç®€å•çš„äº’æ–¥é”ï¼Œå¯ä»¥è§£å†³é—®é¢˜ï¼Œåç»­ä¼šè€ƒè™‘golang çš„ sync.Map å®‰å…¨ mapã€‚</li><li>kube-state-metrics é€šè¿‡æ¯”è¾ƒ resource version æ¥ä¿è¯ event çš„é¡ºåº</li><li>kube-state-metrics å¹¶ä¸ä¿è¯åŒ…å«æ‰€æœ‰èµ„æº</li></ul><h2 id="ç›¸å…³yamlæ–‡ä»¶"><a href="#ç›¸å…³yamlæ–‡ä»¶" class="headerlink" title="ç›¸å…³yamlæ–‡ä»¶"></a>ç›¸å…³yamlæ–‡ä»¶</h2><p>é™„ä¸Šéƒ¨ç½²çš„yamlï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">false</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">exporter</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">app.kubernetes.io/version:</span> <span class="hljs-number">2.6</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">exporter</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">app.kubernetes.io/version:</span> <span class="hljs-number">2.6</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">rules:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">configmaps</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">nodes</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">pods</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">serviceaccounts</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">resourcequotas</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">replicationcontrollers</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">limitranges</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">persistentvolumeclaims</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">persistentvolumes</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">namespaces</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">apps</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">statefulsets</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">daemonsets</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">deployments</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">replicasets</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">batch</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">cronjobs</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">jobs</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">autoscaling</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">horizontalpodautoscalers</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">authentication.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">tokenreviews</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">authorization.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">subjectaccessreviews</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">create</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">policy</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">poddisruptionbudgets</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">certificates.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">certificatesigningrequests</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">storage.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">storageclasses</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">volumeattachments</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">admissionregistration.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">mutatingwebhookconfigurations</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">validatingwebhookconfigurations</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">networking.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">networkpolicies</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">coordination.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">leases</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">resources:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">clusterrolebindings</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">clusterroles</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">rolebindings</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">roles</span><br>  <span class="hljs-attr">verbs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">exporter</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">app.kubernetes.io/version:</span> <span class="hljs-number">2.6</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br><span class="hljs-attr">subjects:</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br> <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">exporter</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">app.kubernetes.io/version:</span> <span class="hljs-number">2.6</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">exporter</span><br>        <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>        <span class="hljs-attr">app.kubernetes.io/version:</span> <span class="hljs-number">2.6</span><span class="hljs-number">.0</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">automountServiceAccountToken:</span> <span class="hljs-literal">true</span><br>      <span class="hljs-attr">containers:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">image:</span> <span class="hljs-string">ccr.ccs.tencentyun.com/chenjingwei/kube-state-metrics:v2.6.0</span><br>        <span class="hljs-attr">livenessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/healthz</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>        <span class="hljs-attr">ports:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">http-metrics</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8081</span><br>          <span class="hljs-attr">name:</span> <span class="hljs-string">telemetry</span><br>        <span class="hljs-attr">readinessProbe:</span><br>          <span class="hljs-attr">httpGet:</span><br>            <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>            <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>          <span class="hljs-attr">initialDelaySeconds:</span> <span class="hljs-number">5</span><br>          <span class="hljs-attr">timeoutSeconds:</span> <span class="hljs-number">5</span><br>        <span class="hljs-attr">securityContext:</span><br>          <span class="hljs-attr">allowPrivilegeEscalation:</span> <span class="hljs-literal">false</span><br>          <span class="hljs-attr">capabilities:</span><br>            <span class="hljs-attr">drop:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">ALL</span><br>          <span class="hljs-attr">readOnlyRootFilesystem:</span> <span class="hljs-literal">true</span><br>          <span class="hljs-attr">runAsUser:</span> <span class="hljs-number">65534</span><br>      <span class="hljs-attr">nodeSelector:</span><br>        <span class="hljs-attr">kubernetes.io/os:</span> <span class="hljs-string">linux</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">kube-state-metrics</span><br>      <br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app.kubernetes.io/component:</span> <span class="hljs-string">exporter</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br>    <span class="hljs-attr">app.kubernetes.io/version:</span> <span class="hljs-number">2.6</span><span class="hljs-number">.0</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">kube-state-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">clusterIP:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">http-metrics</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-string">http-metrics</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">telemetry</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">8081</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-string">telemetry</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">kube-state-metrics</span><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>missing-container-metricséƒ¨ç½²å®‰è£…å’Œä½¿ç”¨</title>
      <link href="/post/1ed7eb83.html"/>
      <url>/post/1ed7eb83.html</url>
      
        <content type="html"><![CDATA[<blockquote><p>æœ¬æ–‡ä¸»è¦ä»‹ç»missing-container-metricsç›‘æ§pod OOMKilled</p></blockquote><h2 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h2><p>Kubernetes é»˜è®¤æƒ…å†µä¸‹ä½¿ç”¨ cAdvisor ä»¥åŠ kube-state-metrics æ¥æ”¶é›†å®¹å™¨çš„å„é¡¹æŒ‡æ ‡ï¼Œç»å¤§å¤šæ•°åœºæ™¯ä¸‹èƒ½å¤Ÿæ»¡è¶³ä¸šåŠ¡çš„åŸºæœ¬çš„éœ€æ±‚ï¼Œä½†è¿˜æ˜¯æœ‰æ‰€æ¬ ç¼ºï¼Œæ¯”å¦‚ç¼ºå°‘å¯¹ä»¥ä¸‹å‡ ä¸ªæŒ‡æ ‡çš„æ”¶é›† </p><ul><li>OOM kill</li><li>å®¹å™¨é‡å¯çš„æ¬¡æ•°</li><li>å®¹å™¨çš„é€€å‡ºç </li></ul><p>missing-container-metrics è¿™ä¸ªmetrics å¼¥è¡¥äº† cAdvisor çš„ç¼ºé™·ï¼Œæ–°å¢äº†ä»¥ä¸Šå‡ ä¸ªæŒ‡æ ‡ï¼Œç”¨æˆ·å¯ä»¥åˆ©ç”¨è¿™äº›æŒ‡æ ‡è¿…é€Ÿå®šä½æŸäº›æ•…éšœã€‚ä¾‹å¦‚ï¼Œå‡è®¾æŸä¸ªå®¹å™¨æœ‰å¤šä¸ªå­è¿›ç¨‹ï¼Œå…¶ä¸­æŸä¸ªå­è¿›ç¨‹è¢« OOM killï¼Œä½†å®¹å™¨è¿˜åœ¨è¿è¡Œï¼Œå¦‚æœä¸å¯¹ OOM kill è¿›è¡Œç›‘æ§ï¼Œç”¨æˆ·å¾ˆéš¾å¯¹æ•…éšœè¿›è¡Œå®šä½ </p><h2 id="å®‰è£…éƒ¨ç½²"><a href="#å®‰è£…éƒ¨ç½²" class="headerlink" title="å®‰è£…éƒ¨ç½²"></a>å®‰è£…éƒ¨ç½²</h2><blockquote><p><a href="https://artifacthub.io/packages/helm/missing-container-metrics/missing-container-metrics">missing-container-metricsé¡¹ç›®ä»‹ç»</a></p></blockquote><p><strong>1ï¼Œæ·»åŠ helmä»“åº“</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm repo add missing-container-metrics https://draganm.github.io/missing-container-metrics<br></code></pre></td></tr></table></figure><p><strong>2ï¼Œ ä¸‹è½½helmåˆ°æœ¬åœ°ï¼Œå¯ä»¥ä¿®æ”¹å¯¹åº”çš„ value.yaml</strong> </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm pull missing-container-metrics/missing-container-metrics<br>tar xvf missing-container-metrics-0.1.1.tgz<br>cd  missing-container-metrics <br>ls <br>Chart.yaml  README.md  templates  values.yaml<br></code></pre></td></tr></table></figure><p><strong>3ï¼Œ å¯é…ç½®é¡¹</strong> </p><table><thead><tr><th align="left">å˜é‡</th><th align="left">æè¿°è¯´æ˜</th><th align="left">é»˜è®¤å€¼</th></tr></thead><tbody><tr><td align="left">image.repository</td><td align="left">é•œåƒåç§°</td><td align="left"><code>dmilhdef/missing-container-metrics</code></td></tr><tr><td align="left">image.pullPolicy</td><td align="left">é•œåƒæ‹‰å–ç­–ç•¥</td><td align="left"><code>IfNotPresent</code></td></tr><tr><td align="left">image.tag</td><td align="left">é•œåƒtag</td><td align="left"><code>v0.21.0</code></td></tr><tr><td align="left">imagePullSecrets</td><td align="left">æ‹‰å–é•œåƒçš„secret</td><td align="left"><code>[]</code></td></tr><tr><td align="left">nameOverride</td><td align="left">è¦†ç›–ç”Ÿæˆçš„å›¾è¡¨åç§°ã€‚é»˜è®¤ä¸º .Chart.Nameã€‚</td><td align="left"></td></tr><tr><td align="left">fullnameOverride</td><td align="left">è¦†ç›–ç”Ÿæˆçš„ç‰ˆæœ¬åç§°ã€‚é»˜è®¤ä¸º .Release.Nameã€‚</td><td align="left"></td></tr><tr><td align="left">podAnnotations</td><td align="left">Pod çš„Annotations</td><td align="left"><code>&#123;&quot;prometheus.io/scrape&quot;: &quot;true&quot;, &quot;prometheus.io/port&quot;: &quot;3001&quot;&#125;</code></td></tr><tr><td align="left">podSecurityContext</td><td align="left">ä¸º pod è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡</td><td align="left"></td></tr><tr><td align="left">securityContext</td><td align="left">ä¸º pod ä¸­çš„å®¹å™¨è®¾ç½®å®‰å…¨ä¸Šä¸‹æ–‡</td><td align="left"></td></tr><tr><td align="left">resources</td><td align="left">PU&#x2F;å†…å­˜èµ„æºè¯·æ±‚&#x2F;é™åˆ¶</td><td align="left"><code>&#123;&#125;</code></td></tr><tr><td align="left">useDocker</td><td align="left">ä» Docker è·å–å®¹å™¨ä¿¡æ¯,å¦‚æœå®¹å™¨è¿è¡Œæ—¶ä¸ºdocker ,è®¾ç½®ä¸ºtrue</td><td align="left"><code>false</code></td></tr><tr><td align="left">useContainerd</td><td align="left">ä» Containerd è·å–å®¹å™¨ä¿¡æ¯,å¦‚æœå®¹å™¨è¿è¡Œæ—¶ä¸ºcontainers ,è®¾ç½®ä¸ºtrue</td><td align="left"><code>true</code></td></tr></tbody></table><p>ç”±äºæˆ‘ä»¬é›†ç¾¤çš„è¿è¡Œæ—¶æ˜¯dockerçš„ æ‰€ä»¥éœ€è¦ä¿®æ”¹<code>missing-container-metrics/values.yaml</code>  ä¸­&#96;&#96;useDocker<code>ä¸º</code><br>true&#96;ï¼Œç„¶åå®‰è£…</p><p><strong>4ï¼Œæ‰§è¡Œå®‰è£…</strong> </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># kubectl create namespace missing-container-metrics</span><br><span class="hljs-comment"># helm install missing-container-metrics  missing-container-metrics -n missing-container-metrics</span><br>NAME: missing-container-metrics<br>LAST DEPLOYED: Sun Jun 26 13:32:43 2022<br>NAMESPACE: missing-container-metrics<br>STATUS: deployed<br>REVISION: 1<br>TEST SUITE: None<br><br><br><span class="hljs-comment">#helm  -n missing-container-metrics list</span><br>NAME     NAMESPACE       REVISION        UPDATED     STATUS          CHART                           APP VERSION<br>missing-container-metrics       missing-container-metrics     1               2022-09-17 22:43:56.998806908 +0800 CST deployed        missing-container-metrics-0.1.1 0.21.0     <br><br><br>[root@VM-249-130-tlinux ~]<span class="hljs-comment"># kubectl  -n missing-container-metrics  get  pods | grep missing-container-metrics</span><br>missing-container-metrics-bf7gq       1/1     Running   0          60s<br></code></pre></td></tr></table></figure><p> å¯ä»¥é€šè¿‡è®¿é—®æœåŠ¡çš„3001ç«¯å£æŸ¥çœ‹metrics,ä¾‹å¦‚ </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#curl 172.16.0.29:3001/metrics   | grep memory-request-limit</span><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172250764.png" alt="image-20220917225037666"></p><p>æœåŠ¡å…¬å¼€äº†å¦‚ä¸‹çš„æŒ‡æ ‡ï¼š</p><table><thead><tr><th>æŒ‡æ ‡</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>container_restarts</td><td>å®¹å™¨çš„é‡å¯æ¬¡æ•°</td></tr><tr><td>container_ooms</td><td>å®¹å™¨çš„ OOM æ€æ­»æ•°ã€‚è¿™æ¶µç›–äº†å®¹å™¨ cgroup ä¸­ä»»ä½•è¿›ç¨‹çš„ OOM ç»ˆæ­¢</td></tr><tr><td>container_last_exit_code</td><td>å®¹å™¨çš„æœ€åé€€å‡ºä»£ç </td></tr></tbody></table><p>æ¯ä¸€ä¸ªæŒ‡æ ‡åŒ…å«å¦‚ä¸‹æ ‡ç­¾ï¼š</p><table><thead><tr><th>æŒ‡æ ‡ID</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>docker_container_id</td><td>å®¹å™¨çš„å®Œæ•´ ID</td></tr><tr><td>container_short_id</td><td>Docker å®¹å™¨ ID çš„å‰ 6 ä¸ªå­—èŠ‚</td></tr><tr><td>docker_container_id</td><td>å®¹å™¨ id ä»¥ä¸ kubernetes pod æŒ‡æ ‡ç›¸åŒçš„æ ¼å¼è¡¨ç¤º - ä»¥å®¹å™¨è¿è¡Œæ—¶ä¸ºå‰ç¼€<code>docker://</code><br />å¹¶<code>containerd://å–å†³äºå®¹å™¨è¿è¡Œæ—¶ã€‚è¿™ä½¿å¾— Prometheus ä¸­çš„</code>kube_pod_container_info&#96;&#96;</td></tr><tr><td>name</td><td>å®¹å™¨çš„åç§°</td></tr><tr><td>image_id</td><td>é•œåƒid ä»¥ä¸ k8s pod çš„æŒ‡æ ‡ç›¸åŒçš„æ ¼å¼è¡¨ç¤ºã€‚è¿™ä½¿å¾— Prometheus ä¸­çš„<code>kube_pod_container_info</code></td></tr><tr><td>pod</td><td>å¦‚æœ<code>io.kubernetes.pod.name</code>åœ¨å®¹å™¨ä¸Šè®¾ç½®äº†<code>pod </code>æ ‡ç­¾ï¼Œåˆ™å…¶å€¼å°†è®¾ç½®ä¸ºæŒ‡æ ‡ä¸­çš„æ ‡ç­¾</td></tr><tr><td>namespace</td><td>å¦‚æœ<code>io.kubernetes.pod.namespaceå®¹å™¨ä¸Šè®¾ç½®äº†</code>namespace&#96;æ ‡ç­¾ï¼Œåˆ™å…¶å€¼å°†è®¾ç½®ä¸ºæŒ‡æ ‡çš„æ ‡ç­¾</td></tr></tbody></table><h2 id="ä¸è‡ªå»ºprometheusé›†æˆ"><a href="#ä¸è‡ªå»ºprometheusé›†æˆ" class="headerlink" title="ä¸è‡ªå»ºprometheusé›†æˆ"></a>ä¸è‡ªå»ºprometheusé›†æˆ</h2><p>1ï¼Œä¿®æ”¹prometheusé…ç½®æ–‡ä»¶</p><blockquote><p>kube-state-metricsæ˜¯éƒ¨ç½²åœ¨kube-systemå‘½åç©ºé—´ä¸‹çš„ï¼Œå› æ­¤åœ¨æ­£åˆ™åŒ¹é…ä¸Šï¼Œå‘½åç©ºé—´ä¸ºkube-systemï¼Œsvcåç§°ä¸ºmissing-container-metricsï¼Œå¦åˆ™å°±ä¸è¿›è¡Œç›‘æ§</p></blockquote><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml">  <span class="hljs-attr">job_name:</span> <span class="hljs-string">&quot;missing-container-metrics&quot;</span><br>  <span class="hljs-attr">kubernetes_sd_configs:</span><br>   <span class="hljs-bullet">-</span> <span class="hljs-attr">role:</span> <span class="hljs-string">endpoints</span><br>  <span class="hljs-attr">relabel_configs:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">source_labels:</span> [<span class="hljs-string">__meta_kubernetes_namespace</span>, <span class="hljs-string">__meta_kubernetes_endpoints_name</span>]<br>    <span class="hljs-attr">regex:</span> <span class="hljs-string">missing-container-metrics;missing-container-metrics</span><br>    <span class="hljs-attr">action:</span> <span class="hljs-string">keep</span><br><span class="hljs-bullet">-</span> <span class="hljs-attr">bearer_token_file:</span> <span class="hljs-string">/var/run/secrets/kubernetes.io/serviceaccount/token</span><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172307683.png" alt="image-20220917230740611"></p><p>ç”±äºhelméƒ¨ç½²åªéƒ¨ç½²äº†<strong>DaemonSet</strong> ï¼Œå¯ä»¥æ‰‹åŠ¨åˆ›å»ºä¸€ä¸ªsvc</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">missing-container-metrics</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">missing-container-metrics</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-number">3001</span><span class="hljs-number">-3001</span><span class="hljs-string">-tcp-2tsffjchpoi</span><br>    <span class="hljs-attr">port:</span> <span class="hljs-number">3001</span><br>    <span class="hljs-attr">protocol:</span> <span class="hljs-string">TCP</span><br>    <span class="hljs-attr">targetPort:</span> <span class="hljs-number">3001</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app.kubernetes.io/instance:</span> <span class="hljs-string">missing-container-metrics</span><br>    <span class="hljs-attr">app.kubernetes.io/name:</span> <span class="hljs-string">missing-container-metrics</span><br>  <span class="hljs-attr">sessionAffinity:</span> <span class="hljs-string">None</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">ClusterIP</span><br><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹prometheusçš„targets</p><p>éƒ¨ç½²æˆåŠŸåï¼Œprometheusçš„targetä¼šå‡ºç°å¦‚ä¸‹æ ‡å¿—</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172310497.png" alt="image-20220917231019436"></p><p>åˆ›å»ºå‘Šè­¦è§„åˆ™</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">###æ·»åŠ <br>prometheusOperator:<br>  podMonitor:<br>    # Create a Prometheus Operator PodMonitor resource<br>    enabled: true<br>    # Namespace defaults to the Release namespace but can be overridden<br>    namespace: &quot;&quot;<br>    # Additional labels to add to the PodMonitor so it matches the Operator&#x27;s podMonitorSelector<br>    selector:<br>      app.kubernetes.io/name: missing-container-metrics<br><br>  prometheusRule:<br>    # Create a Prometheus Operator PrometheusRule resource<br>    enabled: true<br>    # Namespace defaults to the Release namespace but can be overridden<br>    namespace: &quot;&quot;<br>    # Additional labels to add to the PrometheusRule so it matches the Operator&#x27;s ruleSelector<br>    selector:<br>      prometheus: k8s<br>      role: alert-rules<br>    # The rules can be set here. An example is defined here but can be overridden.<br>    rules:<br>    - alert: ContainerOOMObserved<br>      annotations:<br>        message: A process in this Pod has been OOMKilled due to exceeding the Kubernetes memory limit at least twice in the last 15 minutes. Look at the metrics to determine if a memory limit increase is required.<br>      expr: sum(increase(container_ooms[15m])) by (exported_namespace, exported_pod) &gt; 2<br>      labels:<br>        severity: warning<br>    - alert: ContainerOOMObserved<br>      annotations:<br>        message: A process in this Pod has been OOMKilled due to exceeding the Kubernetes memory limit at least ten times in the last 15 minutes. Look at the metrics to determine if a memory limit increase is required.<br>      expr: sum(increase(container_ooms[15m])) by (exported_namespace, exported_pod) &gt; 10<br>      labels:<br>        severity: critical<br></code></pre></td></tr></table></figure><p>2ï¼Œæ¨¡æ‹ŸOOM</p><p>åˆ›å»ºä¸€ä¸ª Podï¼Œå°è¯•åˆ†é…è¶…å‡ºå…¶é™åˆ¶çš„å†…å­˜ã€‚ è¿™æ˜¯ä¸€ä¸ª Pod çš„é…ç½®æ–‡ä»¶ï¼Œå…¶æ‹¥æœ‰ä¸€ä¸ªå®¹å™¨ï¼Œè¯¥å®¹å™¨çš„å†…å­˜è¯·æ±‚ä¸º 50 MiBï¼Œå†…å­˜é™åˆ¶ä¸º 100 MiBï¼š<br>åœ¨é…ç½®æ–‡ä»¶çš„ <code>args</code> éƒ¨åˆ†ä¸­ï¼Œä½ å¯ä»¥çœ‹åˆ°å®¹å™¨ä¼šå°è¯•åˆ†é… 250 MiB å†…å­˜ï¼Œè¿™è¿œé«˜äº 100 MiB çš„é™åˆ¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  labels:<br>    k8s-app: memory-request-limit<br>    qcloud-app: memory-request-limit<br>  name: memory-request-limit<br>  namespace: default<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      k8s-app: memory-request-limit<br>      qcloud-app: memory-request-limit<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: memory-request-limit<br>        qcloud-app: memory-request-limit<br>    spec:<br>      containers:<br>      - args:<br>        - --vm<br>        - &quot;1&quot;<br>        - --vm-bytes<br>        - 250M<br>        - --vm-hang<br>        - &quot;1&quot;<br>        command:<br>        - stress<br>        image: polinux/stress:latest<br>        imagePullPolicy: IfNotPresent<br>        name: memory-demo-ctr<br>        resources:<br>          limits:<br>            memory: 100Mi<br>          requests:<br>            memory: 50Mi<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209180008639.png" alt="image-20220918000817592"></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">sum</span>(increase(container_ooms[15m])) by (exported_namespace, exported_pod) &gt; 3<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172323238.png" alt="image-20220917232300114"></p><h2 id="äº‘åŸç”Ÿç›‘æ§TMPä½¿ç”¨missing-container-metrics"><a href="#äº‘åŸç”Ÿç›‘æ§TMPä½¿ç”¨missing-container-metrics" class="headerlink" title="äº‘åŸç”Ÿç›‘æ§TMPä½¿ç”¨missing-container-metrics"></a>äº‘åŸç”Ÿç›‘æ§TMPä½¿ç”¨missing-container-metrics</h2><p>1ï¼Œæ·»åŠ æ•°æ®é‡‡é›†é…ç½®  </p><p>ç™»é™†Promtheus ç›‘æ§æ§åˆ¶å°ï¼Œé€‰æ‹©é›†ç¾¤ç›‘æ§&gt; æ•°æ®é‡‡é›†é…ç½®&gt;è‡ªå®šä¹‰ç›‘æ§&gt; æ–°å¢æ•°æ®é‡‡é›†é…ç½®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172332533.png" alt="image-20220917233213424"></p><p>2ï¼ŒæŸ¥çœ‹å½“å‰é‡‡é›†ï¼Œå¦‚ä¸‹å›¾æ‰€ç¤ºï¼Œè¡¨ç¤ºå·²ç»é‡‡é›†åˆ°ç›‘æ§æ•°æ®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172335898.png" alt="image-20220917233503809"></p><p>3ï¼Œ é…ç½®å‘Šè­¦è§„åˆ™prometheusRule </p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209172345261.png" alt="image-20220917234532164"></p><p>æŸ¥çœ‹å‘Šè­¦å†å²</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209180036206.png" alt="image-20220918003616097"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209180050304.png" alt="image-20220918005055241"></p><p>å‚è€ƒæ–‡æ¡£ï¼š<a href="https://github.com/draganm/missing-container-metrics">https://github.com/draganm/missing-container-metrics</a></p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Prometheus </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>åœ¨TKEé‡Œå®‰è£…å’Œä½¿ç”¨Traefik Ingress</title>
      <link href="/post/94ad787b.html"/>
      <url>/post/94ad787b.html</url>
      
        <content type="html"><![CDATA[<h2 id="åœ¨TKEé‡Œå®‰è£…å’Œä½¿ç”¨Traefik-Ingress"><a href="#åœ¨TKEé‡Œå®‰è£…å’Œä½¿ç”¨Traefik-Ingress" class="headerlink" title="åœ¨TKEé‡Œå®‰è£…å’Œä½¿ç”¨Traefik Ingress"></a>åœ¨TKEé‡Œå®‰è£…å’Œä½¿ç”¨Traefik Ingress</h2><blockquote><p><a href="https://doc.traefik.io/traefik/">Traefik å®˜æ–¹æ–‡æ¡£</a></p></blockquote><p>Traefik æ˜¯ä¸€ä¸ªä¸ºäº†è®©éƒ¨ç½²å¾®æœåŠ¡æ›´åŠ ä¾¿æ·è€Œè¯ç”Ÿçš„ç°ä»£HTTPåå‘ä»£ç†ã€è´Ÿè½½å‡è¡¡å·¥å…·</p><ul><li><p>Traefikçš„ä¸ä¼—ä¸åŒä¹‹å¤„åœ¨äºï¼Œé™¤äº†å®ƒçš„è®¸å¤šç‰¹æ€§ä¹‹å¤–ï¼Œå®ƒè¿˜èƒ½è‡ªåŠ¨å‘ç°æœåŠ¡çš„æ­£ç¡®é…ç½®ã€‚å½“Traefikæ£€æŸ¥æ‚¨çš„åŸºç¡€è®¾æ–½æ—¶ï¼Œå®ƒä¼šå‘ç°ç›¸å…³ä¿¡æ¯å¹¶å‘ç°å“ªä¸ªæœåŠ¡æœåŠ¡äºå“ªä¸ªè¯·æ±‚ã€‚</p></li><li><p>Traefikä»æ ¹æœ¬ä¸Šå…¼å®¹æ‰€æœ‰ä¸»è¦çš„é›†ç¾¤æŠ€æœ¯ï¼Œå¦‚Kubernetesã€Dockerã€Docker Swarmã€AWSã€Mesosã€Marathonç­‰ï¼Œå¹¶ä¸”å¯ä»¥åŒæ—¶å¤„ç†å¾ˆå¤šé—®é¢˜ã€‚</p></li><li><p>ä½¿ç”¨Traefikï¼Œä¸éœ€è¦ç»´æŠ¤å’ŒåŒæ­¥å•ç‹¬çš„é…ç½®æ–‡ä»¶ï¼Œæ‰€æœ‰äº‹æƒ…éƒ½æ˜¯è‡ªåŠ¨å®æ—¶å‘ç”Ÿçš„(æ²¡æœ‰é‡å¯ï¼Œæ²¡æœ‰è¿æ¥ä¸­æ–­)ã€‚ä½¿ç”¨Traefikï¼Œç”¨æˆ·å¯ä»¥å°†æ—¶é—´èŠ±åœ¨å¼€å‘å’Œéƒ¨ç½²ç³»ç»Ÿæ–°åŠŸèƒ½ä¸Šï¼Œè€Œä¸æ˜¯é…ç½®å’Œç»´æŠ¤ç³»ç»Ÿçš„å·¥ä½œçŠ¶æ€ä¸Šã€‚</p></li></ul><p><strong>ç¯å¢ƒå‡†å¤‡</strong></p><ul><li>TKEé›†ç¾¤ï¼Œç‰ˆæœ¬1.18</li></ul><h3 id="å®‰è£…Traefikæ–¹å¼ä¸€-YAML"><a href="#å®‰è£…Traefikæ–¹å¼ä¸€-YAML" class="headerlink" title="å®‰è£…Traefikæ–¹å¼ä¸€ YAML"></a>å®‰è£…Traefikæ–¹å¼ä¸€ YAML</h3><blockquote><p>æœ¬æ–‡ä»‹ç»ä¸¤ç§å®‰è£…æ–¹å¼ï¼Œyamlå’Œhelm chartæ–¹å¼ï¼Œæ ¹æ®è‡ªå·±æƒ…å†µ åªéœ€è¦é€‰ä¸€ç§å³å¯</p></blockquote><p>æœ¬æ–‡ä»‹ç»å¦‚ä½•åœ¨ TKE ç¯å¢ƒä¸­ä½¿ç”¨Traefik Ingressï¼Œç›®æ ‡æ˜¯å­¦ä¹ å¦‚ä½•åœ¨Kubernetesä¸­è¿è¡ŒTraefikåå‘ä»£ç†åçš„åº”ç”¨ç¨‹åºã€‚å®ƒä»‹ç»å¹¶è§£é‡Šäº†å¼€å§‹ä½¿ç”¨Traefikæ‰€éœ€çš„åŸºæœ¬å—ï¼Œå¦‚å…¥å£æ§åˆ¶å™¨ã€å…¥å£ã€éƒ¨ç½²ã€é™æ€å’ŒåŠ¨æ€é…ç½®ã€‚</p><p>Traefikä½¿ç”¨Kubernetes APIæ¥å‘ç°æ­£åœ¨è¿è¡Œçš„æœåŠ¡ï¼Œä¸ºäº†ä½¿ç”¨Kubernetes API, Traefikéœ€è¦ä¸€äº›æƒé™ã€‚æ­¤æƒé™æœºåˆ¶åŸºäºé›†ç¾¤ç®¡ç†å‘˜å®šä¹‰çš„è§’è‰²ã€‚ç„¶åå°†è§’è‰²ç»‘å®šåˆ°åº”ç”¨ç¨‹åºä½¿ç”¨çš„å¸æˆ·</p><p><strong>åˆ›å»ºè§’è‰²</strong> </p><p>traefik-role.yamlç¤ºä¾‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-role</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">rules:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">&quot;&quot;</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">services</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">endpoints</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">secrets</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">networking.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingressclasses</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">networking.k8s.io</span><br>    <span class="hljs-attr">resources:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">ingresses/status</span><br>    <span class="hljs-attr">verbs:</span><br>      <span class="hljs-bullet">-</span> <span class="hljs-string">update</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºæœåŠ¡è´¦å·ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-account</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºClusterRoleBinding</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-role-binding</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">roleRef:</span><br>  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span><br>  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-role</span><br><span class="hljs-attr">subjects:</span><br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span><br>    <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-account</span><br>    <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span>  <span class="hljs-comment"># Using &quot;default&quot; because we did not specify a namespace when creating the ClusterAccount.</span><br></code></pre></td></tr></table></figure><p><strong>éƒ¨ç½² ingress controller</strong></p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">traefik</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">traefik</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">traefik</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">serviceAccountName:</span> <span class="hljs-string">traefik-account</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">traefik</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">traefik:v2.8</span><br>          <span class="hljs-attr">args:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--api.insecure</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--providers.kubernetesingress.ingressclass=traefik</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-string">--log.level=DEBUG</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">8080</span><br></code></pre></td></tr></table></figure><p>ä¸€ä¸ªworkloadå¯ä»¥è¿è¡Œå¤šä¸ªTraefikä»£ç†Podsï¼Œéœ€è¦ä¸€ä¸ªç‰‡æ®µå°†æµé‡è½¬å‘åˆ°ä»»ä½•å®ä¾‹ï¼š å³ä¸€ä¸ªæœåŠ¡ã€‚åˆ›å»ºåä¸ºtraefik-ingress-controller-servicesçš„æ–‡ä»¶ã€‚yamlå¹¶æ’å…¥ä¸¤ä¸ªServiceèµ„æº:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-dashboard-service</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">port:</span> <span class="hljs-number">8080</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">dashboard</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">traefik</span><br><span class="hljs-meta">---</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">traefik-ingress-controller-services</span><br>  <span class="hljs-attr">namespace:</span> <span class="hljs-string">kube-system</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">type:</span> <span class="hljs-string">LoadBalancer</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">targetPort:</span> <span class="hljs-string">web</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">traefik</span><br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤å°† Traefik å®‰è£…åˆ° TKE é›†ç¾¤</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-130-tlinux ~/traefik]<span class="hljs-comment"># kubectl  apply -f .</span><br>serviceaccount/traefik-account created<br>service/traefik-dashboard-service created<br>service/traefik-ingress-controller-services created<br>deployment.apps/traefik-ingress-controller created<br>clusterrolebinding.rbac.authorization.k8s.io/traefik-role-binding created<br>clusterrole.rbac.authorization.k8s.io/traefik-role created<br></code></pre></td></tr></table></figure><p>è·å–æµé‡å…¥å£çš„ IP åœ°å€ï¼ˆå¦‚ä¸‹ä¸º EXTERNAL-IP å­—æ®µï¼‰ï¼Œä»¥åŠDashboard,ç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-130-tlinux ~/traefik]<span class="hljs-comment"># kubectl -n kube-system get pods,svc  | grep traefik</span><br>pod/traefik-ingress-controller-5b6dd45cfb-pvddr   1/1     Running            0          3m29s<br>service/traefik-dashboard-service             LoadBalancer   172.16.255.160   118.24.226.193    8080:30299/TCP   3m29s<br>service/traefik-ingress-controller-services   LoadBalancer   172.16.253.56    114.117.220.253   80:31292/TCP     3m29s<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Traefikæ–¹å¼äºŒ-Helm"><a href="#å®‰è£…Traefikæ–¹å¼äºŒ-Helm" class="headerlink" title="å®‰è£…Traefikæ–¹å¼äºŒ Helm"></a>å®‰è£…Traefikæ–¹å¼äºŒ Helm</h3><blockquote><p>Traefikå¯ä»¥å®‰è£…åœ¨Kubernetesä½¿ç”¨Helm ä»“åº“ä»<a href="https://github.com/traefik/traefik-helm-chart%E3%80%82">https://github.com/traefik/traefik-helm-chartã€‚</a></p></blockquote><p>ç¡®ä¿æ»¡è¶³ä»¥ä¸‹è¦æ±‚:</p><ul><li><p>å·²åˆ›å»ºTKEé›†ç¾¤ Kubernetes 1.14 +</p></li><li><p>å·²å®‰è£…helmå®¢æˆ·ç«¯  ç‰ˆæœ¬3.xä»¥ä¸Š ï¼Œ<a href="https://blog.chen1900s.cn/post/e3ad72ca.html">helmå®‰è£…å‚è€ƒ</a></p></li></ul><p>æ·»åŠ Traefikçš„helm chart ä»“åº“</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">helm repo add traefik https://helm.traefik.io/traefik<br></code></pre></td></tr></table></figure><p>å‡†å¤‡é…ç½®æ–‡ä»¶values.yamlï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">providers:</span> <br>  <span class="hljs-attr">kubernetesIngress:</span> <br>    <span class="hljs-attr">publishedService:</span> <br>      <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span>   <span class="hljs-comment">#è®© Ingressçš„å¤–éƒ¨ IP åœ°å€çŠ¶æ€æ˜¾ç¤ºä¸º Traefik çš„ LB IP åœ°å€</span><br><span class="hljs-attr">additionalArguments:</span> <br><span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--providers.kubernetesingress.ingressclass=traefik&quot;</span> <span class="hljs-comment"># æŒ‡å®š ingress class åç§° </span><br><span class="hljs-bullet">-</span> <span class="hljs-string">&quot;--log.level=DEBUG&quot;</span> <br><span class="hljs-attr">ports:</span> <br>  <span class="hljs-attr">web:</span> <br>    <span class="hljs-attr">expose:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">exposedPort:</span> <span class="hljs-number">80</span> <span class="hljs-comment"># å¯¹å¤–çš„ HTTP ç«¯å£å·ï¼Œä½¿ç”¨æ ‡å‡†ç«¯å£å·åœ¨å›½å†…éœ€å¤‡æ¡ˆ</span><br>  <span class="hljs-attr">websecure:</span> <br>    <span class="hljs-attr">expose:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">exposedPort:</span> <span class="hljs-number">443</span> <span class="hljs-comment"># å¯¹å¤–çš„ HTTPS ç«¯å£å·ï¼Œä½¿ç”¨æ ‡å‡†ç«¯å£å·åœ¨å›½å†…éœ€å¤‡æ¡ˆ</span><br>  <span class="hljs-attr">traefik:</span><br>    <span class="hljs-attr">expose:</span> <span class="hljs-literal">true</span><br>    <span class="hljs-attr">exposedPort:</span> <span class="hljs-number">9000</span><br><span class="hljs-attr">deployment:</span> <br>  <span class="hljs-attr">enabled:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br></code></pre></td></tr></table></figure><blockquote><p>å®Œæ•´çš„é»˜è®¤é…ç½®å¯æ‰§è¡Œ <code>helm show values traefik/traefik</code> å‘½ä»¤æŸ¥çœ‹</p></blockquote><p>ç”¨helmå‘½ä»¤è¡Œå®‰è£…ï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">helm install traefik -f values.yaml traefik/traefik  <span class="hljs-comment">#é»˜è®¤æ˜¯å®‰è£…åœ¨defaultå‘½åç©ºé—´ä¸‹çš„</span><br><br><span class="hljs-comment">#å¯ä»¥æŒ‡å®šå‘½åå‘½åç©ºé—´è¿›è¡Œå®‰è£…</span><br>kubectl create ns traefik-v2<br><span class="hljs-comment"># Install in the namespace &quot;traefik-v2&quot;</span><br>helm install --namespace=traefik-v2 -f values.yaml    traefik traefik/traefik<br><br><span class="hljs-comment">#åç»­å¦‚æœä¿®æ”¹é…ç½®ä½¿ç”¨å¦‚ä¸‹å‘½ä»¤è¿›è¡Œæ›´æ–°</span><br>helm upgrade --install traefik -f values.yaml traefik/traefik<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹éƒ¨ç½²çš„èµ„æº</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-130-tlinux ~]<span class="hljs-comment"># kubectl   get pods,svc</span><br>NAME                           READY   STATUS    RESTARTS   AGE<br>pod/traefik-7bb76c56fb-skzvq   1/1     Running   0          5m22s<br><br>NAME                 TYPE           CLUSTER-IP       EXTERNAL-IP     PORT(S)                      AGE<br>service/kubernetes   ClusterIP      172.16.252.1     &lt;none&gt;          443/TCP                      95m<br>service/traefik      LoadBalancer   172.16.252.238   118.24.225.19   80:32467/TCP,443:30353/TCP   5m22s<br></code></pre></td></tr></table></figure><h3 id="ä½¿ç”¨-Ingress"><a href="#ä½¿ç”¨-Ingress" class="headerlink" title="ä½¿ç”¨ Ingress"></a>ä½¿ç”¨ Ingress</h3><p>æˆ‘ä»¬ä½¿ç”¨ç¤ºä¾‹åº”ç”¨ç¨‹åºtraefik&#x2F;whoamiï¼Œä½†å…¶åŸåˆ™é€‚ç”¨äºä»»ä½•å…¶ä»–åº”ç”¨ç¨‹åºã€‚</p><p>whoamiåº”ç”¨ç¨‹åºæ˜¯ä¸€ä¸ªç®€å•çš„HTTPæœåŠ¡å™¨ï¼Œè¿è¡Œåœ¨ç«¯å£80ä¸Šï¼Œå®ƒå‘ä¼ å…¥çš„è¯·æ±‚åº”ç­”ä¸ä¸»æœºç›¸å…³çš„ä¿¡æ¯ã€‚å’Œå¾€å¸¸ä¸€æ ·ï¼Œé¦–å…ˆåˆ›å»ºä¸€ä¸ªåä¸ºwhoamiçš„æ–‡ä»¶ã€‚ymlå¹¶ç²˜è´´ä»¥ä¸‹éƒ¨ç½²èµ„æº:</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">kind:</span> <span class="hljs-string">Deployment</span><br><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">apps/v1</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">whoami</span><br>  <span class="hljs-attr">labels:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">whoami</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">replicas:</span> <span class="hljs-number">1</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">matchLabels:</span><br>      <span class="hljs-attr">app:</span> <span class="hljs-string">whoami</span><br>  <span class="hljs-attr">template:</span><br>    <span class="hljs-attr">metadata:</span><br>      <span class="hljs-attr">labels:</span><br>        <span class="hljs-attr">app:</span> <span class="hljs-string">whoami</span><br>    <span class="hljs-attr">spec:</span><br>      <span class="hljs-attr">containers:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">whoami</span><br>          <span class="hljs-attr">image:</span> <span class="hljs-string">traefik/whoami</span><br>          <span class="hljs-attr">ports:</span><br>            <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>              <span class="hljs-attr">containerPort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºservice</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Service</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">whoami</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">ports:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">web</span><br>      <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br>      <span class="hljs-attr">targetPort:</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">selector:</span><br>    <span class="hljs-attr">app:</span> <span class="hljs-string">whoami</span><br></code></pre></td></tr></table></figure><p>Traefik æ”¯æŒä½¿ç”¨ Kubernetes çš„ Ingress èµ„æºä½œä¸ºåŠ¨æ€é…ç½®ï¼Œå¯ç›´æ¥åœ¨é›†ç¾¤ä¸­åˆ›å»º Ingress èµ„æºç”¨äºå¯¹å¤–æš´éœ²é›†ç¾¤ï¼Œéœ€è¦åŠ ä¸ŠæŒ‡å®šçš„ Ingress classï¼ˆå®‰è£… Traefik æ—¶å®šä¹‰ï¼‰ã€‚ç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">networking.k8s.io/v1beta1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">Ingress</span><br><span class="hljs-attr">metadata:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">whoami-ingress</span><br>  <span class="hljs-attr">annotations:</span> <br>    <span class="hljs-attr">kubernetes.io/ingress.class:</span> <span class="hljs-string">traefik</span> <span class="hljs-comment"># è¿™é‡ŒæŒ‡å®š ingress class åç§°</span><br><span class="hljs-attr">spec:</span> <br>  <span class="hljs-attr">rules:</span> <br>  <span class="hljs-bullet">-</span> <span class="hljs-attr">host:</span> <span class="hljs-string">traefik.chen1900s.cn</span><br>    <span class="hljs-attr">http:</span> <br>      <span class="hljs-attr">paths:</span> <br>      <span class="hljs-bullet">-</span> <span class="hljs-attr">path:</span> <span class="hljs-string">/</span><br>        <span class="hljs-attr">backend:</span> <br>          <span class="hljs-attr">serviceName:</span> <span class="hljs-string">whoami</span><br>          <span class="hljs-attr">servicePort:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><blockquote><p>TKE æš‚æœªå°† Traefik äº§å“åŒ–ï¼Œæ— æ³•ç›´æ¥åœ¨ TKE æ§åˆ¶å°è¿›è¡Œå¯è§†åŒ–åˆ›å»º Ingressï¼Œéœ€è¦ä½¿ç”¨ YAML è¿›è¡Œåˆ›å»ºã€‚</p></blockquote><p><strong>ä½¿ç”¨å®‰è£…æ–¹å¼ä¸€ éƒ¨ç½²åè®¿é—®æµ‹è¯•å¦‚ä¸‹</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-130-tlinux ~/traefik]<span class="hljs-comment"># nslookup traefik.chen1900s.cn  #è§£æåˆ°traefik-ingress-controllerçš„service VIPä¸Š</span><br>Server:         183.60.82.98<br>Address:        183.60.82.98<span class="hljs-comment">#53</span><br><br>Non-authoritative answer:<br>Name:   traefik.chen1900s.cn<br>Address: 114.117.220.253<br><br>[root@VM-249-130-tlinux ~/traefik]<span class="hljs-comment"># curl http://traefik.chen1900s.cn/</span><br>Hostname: whoami-5db58df676-vwvzv<br>IP: 127.0.0.1<br>IP: 172.16.0.5<br>RemoteAddr: 172.16.0.7:49846<br>GET / HTTP/1.1<br>Host: traefik.chen1900s.cn<br>User-Agent: curl/7.29.0<br>Accept: */*<br>Accept-Encoding: gzip<br>X-Forwarded-For: 172.16.0.1<br>X-Forwarded-Host: traefik.chen1900s.cn<br>X-Forwarded-Port: 80<br>X-Forwarded-Proto: http<br>X-Forwarded-Server: traefik-ingress-controller-745b557778-jrjzn<br>X-Real-Ip: 172.16.0.1<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨å®‰è£…æ–¹å¼äºŒ  éƒ¨ç½²åè®¿é—®æµ‹è¯•å¦‚ä¸‹ï¼š</strong></p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-0-33-tlinux ~]<span class="hljs-comment"># curl http://traefik.chen1900s.cn/</span><br>Hostname: whoami-5db58df676-856ss<br>IP: 127.0.0.1<br>IP: 172.16.0.10<br>RemoteAddr: 172.16.0.9:58498<br>GET / HTTP/1.1<br>Host: traefik.chen1900s.cn<br>User-Agent: curl/7.29.0<br>Accept: */*<br>Accept-Encoding: gzip<br>X-Forwarded-For: 172.16.0.1<br>X-Forwarded-Host: traefik.chen1900s.cn<br>X-Forwarded-Port: 80<br>X-Forwarded-Proto: http<br>X-Forwarded-Server: traefik-7bb76c56fb-skzvq<br>X-Real-Ip: 172.16.0.1<br><br>[root@VM-0-33-tlinux ~]<span class="hljs-comment"># nslookup traefik.chen1900s.cn   #æ­£å¸¸è§£æåˆ° æ–¹å¼äºŒ å¯¹åº”çš„service VIPä¸Š</span><br>Server:         183.60.83.19<br>Address:        183.60.83.19<span class="hljs-comment">#53</span><br><br>Non-authoritative answer:<br>Name:   traefik.chen1900s.cn<br>Address: 118.24.225.19<br></code></pre></td></tr></table></figure><h3 id="ä½¿ç”¨Traefik-Dashboard"><a href="#ä½¿ç”¨Traefik-Dashboard" class="headerlink" title="ä½¿ç”¨Traefik Dashboard"></a>ä½¿ç”¨Traefik Dashboard</h3><p>ä½¿ç”¨ç¬¬ä¸€ç§æ–¹å¼å®‰è£…æ—¶å€™é»˜è®¤å®‰è£…äº†Traefik Dashboardï¼Œä½¿ç”¨æ–¹å¼äºŒHelm chart æ–¹å¼å®‰è£…ï¼Œå‡ºäºå®‰å…¨è€ƒè™‘ï¼Œè¿™ä¸ªHelm Charté»˜è®¤æƒ…å†µä¸‹ä¸å…¬å¼€Traefik Dashboardã€‚å› æ­¤ï¼Œå¦‚æœéœ€è¦æš´éœ²Dashboardç«¯å£ï¼Œéœ€è¦åœ¨values.yamlé‡Œé¢æ·»åŠ </p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">traefik:</span><br>  <span class="hljs-attr">expose:</span> <span class="hljs-literal">true</span><br>  <span class="hljs-attr">exposedPort:</span> <span class="hljs-number">9000</span><br></code></pre></td></tr></table></figure><blockquote><p>è¿˜æœ‰æ›´å¤šå‚æ•°å¯ä»¥é€šè¿‡<code>helm show values traefik/traefik</code> å‘½ä»¤æŸ¥çœ‹ï¼Œ æ¯”å¦‚æš´éœ²metricsç«¯å£ç­‰ç­‰</p></blockquote><p>æˆ–è€…ä½¿ç”¨IngressRoute CRD</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">traefik.containo.us/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">IngressRoute</span><br><span class="hljs-attr">metadata:</span><br>  <span class="hljs-attr">name:</span> <span class="hljs-string">dashboard</span><br><span class="hljs-attr">spec:</span><br>  <span class="hljs-attr">entryPoints:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">routes:</span><br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">Host(`traefikdashboard.chen1900s.cn`)</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">(PathPrefix(`/dashboard`)</span> <span class="hljs-string">||</span> <span class="hljs-string">PathPrefix(`/api`))</span><br>      <span class="hljs-attr">kind:</span> <span class="hljs-string">Rule</span><br>      <span class="hljs-attr">services:</span><br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">api@internal</span><br>          <span class="hljs-attr">kind:</span> <span class="hljs-string">TraefikService</span><br></code></pre></td></tr></table></figure><p>æ–¹å¼ä¸€å®‰è£…é»˜è®¤æ˜¯8080ç«¯å£</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171716193.png" alt="image-20220917171631043"></p><p>æ–¹å¼äºŒhelmæ–¹å¼å®‰è£…ï¼Œç«¯å£è®¾ç½®çš„æ˜¯9000</p><p><a href="http://external-ip:9000/dashboard/#/">http://EXTERNAL-IP:9000/dashboard/#/</a></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209171804625.png" alt="image-20220917180436515"></p><h3 id="ä½¿ç”¨-IngressRoute"><a href="#ä½¿ç”¨-IngressRoute" class="headerlink" title="ä½¿ç”¨ IngressRoute"></a>ä½¿ç”¨ IngressRoute</h3><p>Traefik ä¸ä»…æ”¯æŒæ ‡å‡†çš„ Kubernetes Ingress èµ„æºï¼Œä¹Ÿæ”¯æŒ Traefik ç‰¹æœ‰çš„ CRD èµ„æºï¼Œä¾‹å¦‚ IngressRouteï¼Œå¯ä»¥æ”¯æŒæ›´å¤š Ingress ä¸å…·å¤‡çš„é«˜çº§åŠŸèƒ½ã€‚IngressRoute ä½¿ç”¨ç¤ºä¾‹å¦‚ä¸‹ï¼š</p><figure class="highlight yaml"><table><tr><td class="code"><pre><code class="hljs yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">traefik.containo.us/v1alpha1</span><br><span class="hljs-attr">kind:</span> <span class="hljs-string">IngressRoute</span><br><span class="hljs-attr">metadata:</span> <br>  <span class="hljs-attr">name:</span> <span class="hljs-string">whoami-ingressroute</span><br><span class="hljs-attr">spec:</span> <br>  <span class="hljs-attr">entryPoints:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-string">web</span><br>  <span class="hljs-attr">routes:</span> <br>    <span class="hljs-bullet">-</span> <span class="hljs-attr">match:</span> <span class="hljs-string">Host(`traefikroute.chen1900s.cn`)</span> <span class="hljs-string">&amp;&amp;</span> <span class="hljs-string">PathPrefix(`/`)</span><br>      <span class="hljs-attr">kind:</span> <span class="hljs-string">Rule</span><br>      <span class="hljs-attr">services:</span> <br>        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">whoami</span><br>          <span class="hljs-attr">port:</span> <span class="hljs-number">80</span><br></code></pre></td></tr></table></figure><p>åˆ›å»ºingressroute</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#kubectl  apply -f whoami-ingressroute.yaml </span><br>ingressroute.traefik.containo.us/whoami-ingressroute created<br><br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦åˆ›å»ºæˆåŠŸ</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment"># kubectl   get ingressroute</span><br>NAME                  AGE<br>whoami-ingressroute   48s<br></code></pre></td></tr></table></figure><p>è®¿é—®éªŒè¯</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@VM-249-130-tlinux ~]<span class="hljs-comment"># curl  http://traefikroute.chen1900s.cn</span><br>Hostname: whoami-5db58df676-856ss<br>IP: 127.0.0.1<br>IP: 172.16.0.10<br>RemoteAddr: 172.16.0.9:57430<br>GET / HTTP/1.1<br>Host: traefikroute.chen1900s.cn<br>User-Agent: curl/7.29.0<br>Accept: */*<br>Accept-Encoding: gzip<br>X-Forwarded-For: 172.16.0.1<br>X-Forwarded-Host: traefikroute.chen1900s.cn<br>X-Forwarded-Port: 80<br>X-Forwarded-Proto: http<br>X-Forwarded-Server: traefik-7bb76c56fb-skzvq<br>X-Real-Ip: 172.16.0.1<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> TKE </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> TKE </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>è‡ªå»ºHarboré•œåƒä»“åº“</title>
      <link href="/post/6763f77d.html"/>
      <url>/post/6763f77d.html</url>
      
        <content type="html"><![CDATA[<h2 id="ä»€ä¹ˆæ˜¯Harbor"><a href="#ä»€ä¹ˆæ˜¯Harbor" class="headerlink" title="ä»€ä¹ˆæ˜¯Harbor"></a>ä»€ä¹ˆæ˜¯Harbor</h2><p>Harbor æ˜¯ç”± VMware å…¬å¸ä¸­å›½å›¢é˜Ÿä¸ºä¼ä¸šç”¨æˆ·è®¾è®¡çš„ Registry server å¼€æºé¡¹ç›®ï¼ŒåŒ…æ‹¬äº†æƒé™ç®¡ç†(RBAC)ã€LDAPã€å®¡è®¡ã€ç®¡ç†ç•Œé¢ã€è‡ªæˆ‘æ³¨å†Œã€HA ç­‰ä¼ä¸šå¿…éœ€çš„åŠŸèƒ½ï¼ŒåŒæ—¶é’ˆå¯¹ä¸­å›½ç”¨æˆ·çš„ç‰¹ç‚¹ï¼Œè®¾è®¡é•œåƒå¤åˆ¶å’Œä¸­æ–‡æ”¯æŒç­‰åŠŸèƒ½</p><blockquote><p><a href="https://goharbor.io/">Harborå®˜æ–¹æ–‡æ¡£</a></p></blockquote><blockquote><p><a href="https://github.com/goharbor/harbor">Harbor Githubé¡¹ç›®</a></p></blockquote><h2 id="éƒ¨ç½²å®‰è£…"><a href="#éƒ¨ç½²å®‰è£…" class="headerlink" title="éƒ¨ç½²å®‰è£…"></a>éƒ¨ç½²å®‰è£…</h2><ol><li>CentOS Linux release 7.8.2003 (Core)</li><li>Docker version 19.03.13</li><li>docker-compose version 1.24.1</li></ol><h3 id="dockerå®‰è£…"><a href="#dockerå®‰è£…" class="headerlink" title="dockerå®‰è£…"></a>dockerå®‰è£…</h3><h4 id="äºŒè¿›åˆ¶æ–¹å¼å®‰è£…"><a href="#äºŒè¿›åˆ¶æ–¹å¼å®‰è£…" class="headerlink" title="äºŒè¿›åˆ¶æ–¹å¼å®‰è£…"></a>äºŒè¿›åˆ¶æ–¹å¼å®‰è£…</h4><blockquote><p><a href="https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz">äºŒè¿›åˆ¶å®‰è£…åŒ…ä¸‹è½½åœ°å€</a></p></blockquote><p><strong>1ï¼Œä¸‹è½½å®‰è£…åŒ…</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">wget https://download.docker.com/linux/static/stable/x86_64/docker-19.03.9.tgz<br>tar zxvf docker-19.03.9.tgz<br>mv docker/* /usr/bin<br></code></pre></td></tr></table></figure><p><strong>2ï¼Œsystemdç®¡ç†docker</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cat &gt; /usr/lib/systemd/system/docker.service &lt;&lt; EOF<br>[Unit]<br>Description=Docker Application Container Engine<br>Documentation=https://docs.docker.com<br>After=network-online.target firewalld.service<br>Wants=network-online.target<br><br>[Service]<br>Type=notify<br>ExecStart=/usr/bin/dockerd<br>ExecReload=/bin/kill -s HUP $MAINPID<br>LimitNOFILE=infinity<br>LimitNPROC=infinity<br>LimitCORE=infinity<br>TimeoutStartSec=0<br>Delegate=yes<br>KillMode=process<br>Restart=on-failure<br>StartLimitBurst=3<br>StartLimitInterval=60s<br><br>[Install]<br>WantedBy=multi-user.target<br>EOF<br><br></code></pre></td></tr></table></figure><h4 id="yumæ–¹å¼å®‰è£…"><a href="#yumæ–¹å¼å®‰è£…" class="headerlink" title="yumæ–¹å¼å®‰è£…"></a><strong>yumæ–¹å¼å®‰è£…</strong></h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#å¸è½½æ—§ç‰ˆæœ¬<br>yum remove docker docker-common docker-selinux docker-engine -y<br><br># å®‰è£…éœ€è¦çš„è½¯ä»¶åŒ…<br>sudo yum install -y yum-utils device-mapper-persistent-data lvm2<br><br># è®¾ç½®yumæºä¸ºé˜¿é‡Œäº‘<br>sudo yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo<br><br>#æˆ–è€…è®¾ç½®å®˜æ–¹æº<br>#sudo yum-config-manager \--add-repo \https://download.docker.com/linux/centos/docker-ce.repo<br><br><br># å®‰è£…docker<br>sudo yum install docker-ce -y<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šä¸¤ç§æ–¹å¼ä»»é€‰ä¸€ç§å®‰è£…å³å¯</p><h4 id="åˆ›å»ºé…ç½®æ–‡ä»¶"><a href="#åˆ›å»ºé…ç½®æ–‡ä»¶" class="headerlink" title="åˆ›å»ºé…ç½®æ–‡ä»¶"></a>åˆ›å»ºé…ç½®æ–‡ä»¶</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mkdir -p /etc/docker<br>cat &gt; /etc/docker/daemon.json &lt;&lt; EOF<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://mirror.ccs.tencentyun.com&quot;]<br>&#125;<br>EOF<br><br><br>#é˜¿é‡Œäº‘é•œåƒåŠ é€Ÿå™¨ ä¹Ÿå¯ä»¥æ›¿æ¢æˆè…¾è®¯äº‘çš„é•œåƒåŠ é€Ÿ<br></code></pre></td></tr></table></figure><h4 id="å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨"><a href="#å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨" class="headerlink" title="å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨"></a>å¯åŠ¨å¹¶è®¾ç½®å¼€æœºå¯åŠ¨</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">systemctl daemon-reload<br>systemctl start docker<br>systemctl enable docker<br>systemctl status docker<br><br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209042225199.png" alt="image-20210417194150567"></p><h3 id="docker-composeå®‰è£…"><a href="#docker-composeå®‰è£…" class="headerlink" title="docker-composeå®‰è£…"></a>docker-composeå®‰è£…</h3><blockquote><p><a href="https://docs.docker.com/compose/install/">docker-composeå®˜ç½‘æ–‡æ¡£ä»‹ç»</a></p></blockquote><h4 id="äºŒè¿›åˆ¶å®‰è£…"><a href="#äºŒè¿›åˆ¶å®‰è£…" class="headerlink" title="äºŒè¿›åˆ¶å®‰è£…"></a>äºŒè¿›åˆ¶å®‰è£…</h4><p>1ï¼Œä¸‹è½½å®‰è£…åŒ…</p><p>æˆ–è€…ç¦»çº¿ä¸‹è½½å®‰è£…åŒ…æˆ‘ä»¬å¯ä»¥ä» Github ä¸Šä¸‹è½½å®ƒçš„äºŒè¿›åˆ¶åŒ…æ¥ä½¿ç”¨ï¼Œ<a href="https://github.com/docker/compose/releases">æœ€æ–°å‘è¡Œçš„ç‰ˆæœ¬åœ°å€</a></p><p>æˆ–é€šè¿‡å‘½ä»¤è¡Œä¸‹è½½</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sudo curl -L &quot;https://github.com/docker/compose/releases/download/1.24.1/docker-compose-(uname -s)âˆ’(uname -m)&quot; -o /usr/local/bin/docker-compose<br></code></pre></td></tr></table></figure><p>2ï¼Œå®‰è£…docker-compose</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sudo chmod +x  /usr/local/bin/docker-compose<br>sudo ln -s /usr/local/bin/docker-compose /usr/bin/docker-compose<br><br>#docker-compose -v<br>Docker Compose version v2.10.2  #è¡¨ç¤ºå®‰è£…æˆåŠŸ<br><br></code></pre></td></tr></table></figure><h4 id="yumæºå®‰è£…"><a href="#yumæºå®‰è£…" class="headerlink" title="yumæºå®‰è£…"></a>yumæºå®‰è£…</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">docker-compose version<br><br>[root@VM-249-124-tlinux ~]# docker-compose version<br>docker-compose version 1.18.0, build 8dd22a9<br>docker-py version: 2.6.1<br>CPython version: 3.6.8<br>OpenSSL version: OpenSSL 1.0.2k-fips  26 Jan 2017  #è¡¨ç¤ºå®‰è£…æˆåŠŸ<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Harbor"><a href="#å®‰è£…Harbor" class="headerlink" title="å®‰è£…Harbor"></a>å®‰è£…Harbor</h3><p>é€šè¿‡å‘½ä»¤è¡Œä¸‹è½½ æˆ–è€…ç›´æ¥åœ¨GIthubä¸Šé‡Œé¢ä¸‹è½½å¥½çš„ç¦»çº¿å®‰è£…åŒ…ï¼Œ<a href="https://github.com/goharbor/harbor">ä¸‹è½½åœ°å€</a></p><p>ä¸‹è½½å®Œæ¯•åï¼Œä¸Šä¼ åˆ°éœ€è¦å®‰è£…harborçš„æœåŠ¡å™¨ä¸Šï¼Œè¿›è¡Œè§£å‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">wget https://github.com/goharbor/harbor/releases/download/v2.1.4/harbor-offline-installer-v2.1.4.tgz<br><br>tar xvf harbor-offline-installer-v2.1.4.tgz<br></code></pre></td></tr></table></figure><p>è¿›å…¥harbor ç›®å½•ï¼Œæ ¹æ®éœ€è¦ä¿®æ”¹ç›¸å…³å‚æ•°</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cd harbor<br>cp harbor.yml.tmpl harbor.yml  #é»˜è®¤æ˜¯harbor.yml.tmpléœ€è¦å°†è¿™ä¸ªæ–‡ä»¶é‡å‘½åä¸€ä¸‹<br>vi harbor.yml<br></code></pre></td></tr></table></figure><p> å¦‚æœæ²¡æœ‰åŸŸåï¼Œä½¿ç”¨IPå»è®¿é—®ï¼Œéœ€è¦ä¿®æ”¹ä»¥ä¸‹å‡ é¡¹å†…å®¹</p><blockquote><p>hostname:  ä¿®æ”¹æˆè‡ªå»ºæœåŠ¡å™¨IP</p><p>http.</p><p>   port: ç«¯å£</p><p>æ³¨é‡Šæ‰httpsç›¸å…³é…ç½®é¡¹</p><p>harbor_admin_password:  harborç™»é™†å¯†ç </p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Configuration file of Harbor<br><br># The IP address or hostname to access admin UI and registry service.<br># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.<br>hostname: 94.191.122.37                         #éœ€è¦ä¿®æ”¹æˆè‡ªå·±çš„åŸŸåï¼Œå¦‚æœæ²¡æœ‰åŸŸåç›´æ¥å¡«å†™è‡ªå·±çš„ IP<br><br># http related config<br>http:<br>  # port for http, default is 80. If https enabled, this port will redirect to https port<br>  port: 80                                      #é»˜è®¤ç«¯å£æ˜¯80ï¼Œå¦‚æœæƒ³ä¿®æ”¹ä¹Ÿå¯ä»¥ä¿®æ”¹æˆå¯åŠ¨ç«¯å£<br><br># https related config<br>#https:                                         #å¯ç”¨https, å¦‚æœä¸æƒ³è¦ï¼Œéœ€è¦æ³¨é‡Šæ‰<br>  # https port for harbor, default is 443<br>  #port: 443                                    #httpsçš„ç«¯å£ï¼Œé»˜è®¤æ˜¯443<br>  #The path of cert and key files for nginx<br>  #certificate: /your/certificate/path            #éœ€è¦å°†è¯ä¹¦ä¸Šä¼ åˆ°å¯¹åº”è·¯å¾„ä¸‹ï¼Œæ ¹æ®æƒ…å†µå¯è‡ªè¡Œä¿®æ”¹<br>  #private_key: /your/private/key/path            #éœ€è¦å°†è¯ä¹¦ä¸Šä¼ åˆ°å¯¹åº”è·¯å¾„ä¸‹ï¼Œæ ¹æ®æƒ…å†µå¯è‡ªè¡Œä¿®æ”¹<br><br># # Uncomment following will enable tls communication between all harbor components<br># internal_tls:<br>#   # set enabled to true means internal tls is enabled<br>#   enabled: true<br>#   # put your cert and key files on dir<br>#   dir: /etc/harbor/tls/internal<br><br># Uncomment external_url if you want to enable external proxy<br># And when it enabled the hostname will no longer used<br># external_url: https://reg.mydomain.com:8433<br><br># The initial password of Harbor admin<br># It only works in first time to install harbor<br># Remember Change the admin password from UI after launching Harbor.<br>harbor_admin_password: xxxxxxå¯†ç                           #ç™»é™†é•œåƒä»“åº“çš„åˆå§‹åŒ–å¯†ç ï¼Œæ ¹æ®æƒ…å†µå¯è‡ªè¡Œä¿®æ”¹<br><br># Harbor DB configuration<br>database:<br>  # The password for the root user of Harbor DB. Change this before any production use.<br>  password: xxxxxxxå¯†ç <br>  # The maximum number of connections in the idle connection pool. If it &lt;=0, no idle connections are retained.<br>  max_idle_conns: 50<br>  # The maximum number of open connections to the database. If it &lt;= 0, then there is no limit on the number of open connections.<br>  # Note: the default number of connections is 1024 for postgres of harbor.<br>  max_open_conns: 1000<br><br># The default data volume<br>data_volume: /data                          #é»˜è®¤æ˜¯/data æ ¹æ®æƒ…å†µè‡ªè¡Œä¿®æ”¹ï¼Œå¦‚æœæ˜¯ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ï¼Œå»ºè®®æ˜¯ä¿®æ”¹ä¸‹é•œåƒå­˜å‚¨çš„è·¯å¾„<br><br>###################ä¸‹é¢å…¶ä»–å†…å®¹ä¿æŒé»˜è®¤å°±å¯ä»¥ï¼Œè¿™é‡Œå°±ä¸ç´¯èµ˜ä»‹ç»äº†<br><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œé…ç½®åï¼Œç¡®è®¤æ— è¯¯æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤è¿›è¡Œå®‰è£…</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">./install.sh<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[Step 5]: starting Harbor ...<br>[+] Running 10/10<br> â ¿ Network harbor_harbor        Created     0.0s<br> â ¿ Container harbor-log         Started     0.9s<br> â ¿ Container redis              Started     1.7s<br> â ¿ Container harbor-portal      Started     1.8s<br> â ¿ Container registryctl        Started     1.5s<br> â ¿ Container harbor-db          Started     1.6s<br> â ¿ Container registry           Started     1.8s<br> â ¿ Container harbor-core        Started     2.2s<br> â ¿ Container nginx              Started     2.9s<br> â ¿ Container harbor-jobservice  Started     2.9s<br>âœ” ----Harbor has been installed and started successfully.----<br></code></pre></td></tr></table></figure><p>æœ‰å¦‚ä¸Šæç¤ºè¡¨ç¤ºå®‰è£…æˆåŠŸ</p><h2 id="harboråŸºæœ¬ä½¿ç”¨"><a href="#harboråŸºæœ¬ä½¿ç”¨" class="headerlink" title="harboråŸºæœ¬ä½¿ç”¨"></a>harboråŸºæœ¬ä½¿ç”¨</h2><p>ç„¶åæˆ‘ä»¬è®¿é—®ä¸€ä¸‹è¿™ä¸ªåœ°å€ï¼Œå¦‚æœæ˜¯httpçš„åˆ™å¯ä»¥ç›´æ¥ä½¿ç”¨IPåœ°å€+ç«¯å£è®¿é—®ï¼Œç”¨æˆ·åé»˜è®¤æ˜¯ï¼šadminï¼Œå¯†ç å°±æ˜¯é…ç½®æ–‡ä»¶é‡Œé¢é‚£ä¸ªharbor.ymlæ–‡ä»¶é‡Œé¢harbor_admin_passwordå€¼</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209042225339.png" alt="image-20210510155124472"></p><h3 id="ä»“åº“ç®¡ç†"><a href="#ä»“åº“ç®¡ç†" class="headerlink" title="ä»“åº“ç®¡ç†"></a>ä»“åº“ç®¡ç†</h3><p>å¯ä»¥æ·»åŠ å…¶ä»–ä»“ç®¡ï¼Œä»¥è…¾è®¯äº‘TCRé•œåƒä»“åº“ä¸ºä¾‹</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209042225383.png" alt="image-20210510155336022"></p><h3 id="å¤åˆ¶ç®¡ç†"><a href="#å¤åˆ¶ç®¡ç†" class="headerlink" title="å¤åˆ¶ç®¡ç†"></a>å¤åˆ¶ç®¡ç†</h3><p>å¤åˆ¶ç®¡ç† å¯ä»¥å°†æœ¬åœ°é•œåƒå¤åˆ¶åˆ°å…¶ä»–é•œåƒä»“åº“ï¼Œä¹Ÿå¯ä»¥å°†å…¶ä»–é•œåƒä»“åº“å¤åˆ¶åˆ°æœ¬åœ°</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209042225424.png" alt="image-20210510155605740"></p><h3 id="é¡¹ç›®ç®¡ç†"><a href="#é¡¹ç›®ç®¡ç†" class="headerlink" title="é¡¹ç›®ç®¡ç†"></a>é¡¹ç›®ç®¡ç†</h3><p>æ‚¨å¯ä»¥ä¸ºä¸åŒç±»è¢«é•œåƒåˆ›å»ºé¡¹ç›® æˆ–è€…ä¸ºä¸åŒçš„é¡¹ç›®ç»„åˆ›å»ºé¡¹ç›®</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209042225472.png" alt="image-20210510155930055"></p><h3 id="ä»“åº“ç®¡ç†-1"><a href="#ä»“åº“ç®¡ç†-1" class="headerlink" title="ä»“åº“ç®¡ç†"></a>ä»“åº“ç®¡ç†</h3><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209042225508.png" alt="image-20210510160003817"></p><h3 id="é•œåƒä¸Šä¼ ä¸‹è½½"><a href="#é•œåƒä¸Šä¼ ä¸‹è½½" class="headerlink" title="é•œåƒä¸Šä¼ ä¸‹è½½"></a>é•œåƒä¸Šä¼ ä¸‹è½½</h3><p>ç™»é™†é•œåƒä»“åº“</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#docker login  94.191.122.37:ç«¯å£  ï¼ˆå¦‚æœä½¿ç”¨çš„æ˜¯é»˜è®¤80ç«¯å£ï¼Œåˆ™å¯ä»¥ä¸æŒ‡å®šç«¯å£ï¼‰<br><br></code></pre></td></tr></table></figure><p>å¦‚æœé»˜è®¤dockeré…ç½®ç™»é™†ä¼šæŠ¥å¦‚ä¸‹é”™è¯¯ï¼Œä¸ç”¨æ‹…å¿ƒï¼Œå› ä¸ºdockeré»˜è®¤æ˜¯ä½¿ç”¨httpsï¼Œè€Œä¸”è¦å¿…é¡»ä½¿ç”¨åŸŸåï¼Œåªæ˜¯ç”¨ipè®¿é—®æ˜¯ä¸è¡Œçš„ï¼Œå¯ä»¥é€šè¿‡æ·»åŠ ä¿¡ä»»åˆ—è¡¨è§£å†³</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-124-tlinux ~/harbor]# docker login 94.191.122.37<br>Username: admin<br>Password: <br>Error response from daemon: Get https://94.191.122.37/v2/: dial tcp 94.191.122.37:443: connect: connection refused<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹dockerçš„é…ç½®æ–‡ä»¶&#x2F;etc&#x2F;docker&#x2F;daemon.jsonï¼Œæ·»åŠ  insecure-registriesé…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cat /etc/docker/daemon.json<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://mirror.ccs.tencentyun.com&quot;],<br>  &quot;insecure-registries&quot;: [&quot;94.191.122.37&quot;]    #æ·»åŠ è¿™ä¸ªé…ç½®ï¼Œå¦‚æœç«¯å£ä¸æ˜¯é»˜è®¤80è®°å¾—è¦åŠ ä¸‹ç«¯å£å™¢<br>&#125;<br></code></pre></td></tr></table></figure><p>ç„¶åé‡å¯docker è¿›ç¨‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">systemctl restart docker<br>systemctl status docker<br></code></pre></td></tr></table></figure><p>é‡å¯harboræœåŠ¡ï¼ˆéœ€è¦è¿›å…¥æœ‰harbor.yamlæ–‡ä»¶çš„ç›®å½•æ‰§è¡Œï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-124-tlinux ~/harbor]# docker-compose  restart<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#1ï¼Œç™»é™†<br>[root@VM-249-124-tlinux ~/harbor]# docker login  94.191.122.37<br>Username: admin<br>Password: <br>WARNING! Your password will be stored unencrypted in /root/.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https://docs.docker.com/engine/reference/commandline/login/#credentials-store<br><br>Login Succeeded,<br>#2ï¼Œä»dockerhubä¸‹è½½ä¸€ä¸ªæµ‹è¯•é•œåƒ<br>[root@VM-249-124-tlinux ~/harbor]# docker pull busybox<br>Using default tag: latest<br>latest: Pulling from library/busybox<br>2c39bef88607: Pull complete <br>Digest: sha256:20142e89dab967c01765b0aea3be4cec3a5957cc330f061e5503ef6168ae6613<br>Status: Downloaded newer image for busybox:latest<br>docker.io/library/busybox:latest<br>[root@VM-249-124-tlinux ~/harbor]# docker  images | grep busy<br>busybox                                               latest              c98db043bed9        3 days ago          1.24MB<br>#3ï¼Œé‡æ–°æ‰“tag <br>[root@VM-249-124-tlinux ~/harbor]# docker tag  c98db043bed9  94.191.122.37/docker/busybox:harbor<br><br>#4ï¼Œæ¨é€åˆ°è‡ªå»ºçš„é•œåƒä»“åº“ï¼Œéœ€è¦ä¸»è¦çš„æ˜¯é¡¹ç›®éœ€è¦æ·»åŠ åˆ›å»ºå¥½ï¼Œæˆ‘è¿™é‡Œåˆ›å»ºçš„æ˜¯dockeré¡¹ç›®<br>[root@VM-249-124-tlinux ~/harbor]# docker push 94.191.122.37/docker/busybox:harbor<br>The push refers to repository [94.191.122.37/docker/busybox]<br>c1cf1676e7d0: Pushed <br>harbor: digest: sha256:15a3c8a1b44b5ef66f9b4b2e1875b50302d100e116f1d4d5ede71d5ac63177c3 size: 527<br><br>#5ï¼Œåœ¨æœ¬åœ°åˆ é™¤è¿™ä¸ªé•œåƒï¼Œç„¶åæµ‹è¯•æ‹‰å–<br>root@VM-249-124-tlinux ~/harbor]# docker rmi  94.191.122.37/docker/busybox:harbor<br>Untagged: 94.191.122.37/docker/busybox:harbor<br>Untagged: 94.191.122.37/docker/busybox@sha256:15a3c8a1b44b5ef66f9b4b2e1875b50302d100e116f1d4d5ede71d5ac63177c3<br>[root@VM-249-124-tlinux ~/harbor]# docker rmi busybox<br>Untagged: busybox:latest<br>Untagged: busybox@sha256:20142e89dab967c01765b0aea3be4cec3a5957cc330f061e5503ef6168ae6613<br>Deleted: sha256:c98db043bed913c5a7b59534cbf8d976122f98b75cb00baabf8af888041e4f9d<br>Deleted: sha256:c1cf1676e7d071645e67257fbb18db931a091c73a211f87bf4559c86e75bcdd3<br><br>#5ï¼Œæµ‹è¯•ä»è‡ªå»ºé•œåƒä»“åº“æ‹‰å–é•œåƒ<br>[root@VM-249-124-tlinux ~/harbor]# docker pull 94.191.122.37/docker/busybox:harbor<br>harbor: Pulling from docker/busybox<br>2c39bef88607: Pull complete <br>Digest: sha256:15a3c8a1b44b5ef66f9b4b2e1875b50302d100e116f1d4d5ede71d5ac63177c3<br>Status: Downloaded newer image for 94.191.122.37/docker/busybox:harbor<br>94.191.122.37/docker/busybox:harbor<br>[root@VM-249-124-tlinux ~/harbor]# docker images | grep busybox<br>94.191.122.37/docker/busybox                          harbor              c98db043bed9        3 days ago          1.24MB<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209052257175.png" alt="image-20220905225703981"></p><h2 id="è‡ªç­¾åè¯ä¹¦å®ç°https"><a href="#è‡ªç­¾åè¯ä¹¦å®ç°https" class="headerlink" title="è‡ªç­¾åè¯ä¹¦å®ç°https"></a>è‡ªç­¾åè¯ä¹¦å®ç°https</h2><p>ä¸€èˆ¬æƒ…å†µä¸‹ï¼ŒHarboræ˜¯å¯ä»¥ä¸ç”¨å¸¦CAè¯ä¹¦è®¤è¯çš„ï¼Œç›´æ¥é€šè¿‡httpæ–¹å¼è®¿é—®ï¼Œå»ºè®®æ˜¯åœ¨æµ‹è¯•ç¯å¢ƒï¼Œå¯¹åº”ç”Ÿäº§ç¯å¢ƒï¼Œä¸ºäº†å®‰å…¨èµ·è§ï¼Œæ›´æ¨èä½¿ç”¨HTTPSï¼Œä½¿ç”¨HTTPSï¼Œéœ€è¦å¯¹åº”SSLè¯ä¹¦ã€‚å¯ä»¥ä½¿ç”¨ç”±å—ä¿¡ä»»çš„ç¬¬ä¸‰æ–¹CAç­¾åçš„è¯ä¹¦ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨opensslè¿›è¡Œè‡ªç­¾åè¯ï¼Œä¸‹é¢ä¸»è¦ä»‹ç»å¦‚ä½•ä½¿ç”¨ opensllåˆ›å»ºCAï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨CAç­¾ç½²æœåŠ¡å™¨è¯ä¹¦å’Œå®¢æˆ·ç«¯è¯ä¹¦ï¼Œæ­å»ºhttpsæ–¹å¼è®¿é—®çš„harboré•œåƒä»“åº“</p><blockquote><p>é¢„å®šä¹‰è‡ªå»ºçš„é•œåƒä»“åº“åŸŸåæ˜¯ harbor.chen1900s.cn</p></blockquote><h3 id="è‡ªç­¾è¯ä¹¦"><a href="#è‡ªç­¾è¯ä¹¦" class="headerlink" title="è‡ªç­¾è¯ä¹¦"></a>è‡ªç­¾è¯ä¹¦</h3><p>1ï¼Œåˆ›å»ºå­˜æ”¾è¯ä¹¦ç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mkdir  -p /root/ssl<br>cd  /root/ssl<br></code></pre></td></tr></table></figure><p>2ï¼Œåˆ›å»º CA æ ¹è¯ä¹¦</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">openssl req  -newkey rsa:4096 -nodes -sha256 -keyout ca.key -x509 -days 365 -out ca.crt -subj &quot;/C=CN/L=beijing/O=lisea/CN=harbor-registry&quot;<br></code></pre></td></tr></table></figure><p>3ï¼Œç”Ÿæˆä¸€ä¸ªè¯ä¹¦ç­¾å, è®¾ç½®è®¿é—®åŸŸåä¸º   harbor.chen1900s.com</p><blockquote><p>éœ€è¦æŠŠé‡Œé¢çš„åŸŸå æ›¿æ¢æˆæ‚¨æƒ³è¦ä½¿ç”¨çš„åŸŸåï¼Œæ—¶é—´å¯ä»¥è‡ªå®šä¹‰</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">openssl req -newkey rsa:4096 -nodes -sha256 -keyout harbor.chen1900s.com.key -out server.csr -subj &quot;/C=CN/L=beijing/O=lisea/CN=harbor.chen1900s.com&quot;<br><br></code></pre></td></tr></table></figure><p>4ï¼Œç”Ÿæˆä¸»æœºçš„è¯ä¹¦</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">openssl x509 -req -days 365 -in server.csr -CA ca.crt -CAkey ca.key -CAcreateserial -out harbor.chen1900s.com.crt<br></code></pre></td></tr></table></figure><p>5ï¼ŒæŸ¥çœ‹å½“å‰è¯ä¹¦æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-124-tlinux ~/ssl]# ls -lrt<br>total 24<br>-rw-r--r-- 1 root root 3272 Sep  6 21:08 ca.key<br>-rw-r--r-- 1 root root 1931 Sep  6 21:08 ca.crt<br>-rw-r--r-- 1 root root 1663 Sep  6 21:08 server.csr<br>-rw-r--r-- 1 root root 3272 Sep  6 21:08 harbor.chen1900s.com.key<br>-rw-r--r-- 1 root root   17 Sep  6 21:10 ca.srl<br>-rw-r--r-- 1 root root 1822 Sep  6 21:10 harbor.chen1900s.com.crt<br></code></pre></td></tr></table></figure><p>6ï¼Œå¦‚æœå·²ç»å®‰è£…httpçš„harborï¼Œéœ€è¦å…ˆåˆ é™¤ï¼Œå†æ‰§è¡Œå®‰è£…å‘½ä»¤ï¼ˆå¦‚æœæ²¡æœ‰å®‰è£…è¿‡ è¿™æ­¥å¿½ç•¥ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#1ï¼ŒåœæœåŠ¡<br>docker-compose  stop<br>#2ï¼Œåˆ é™¤å®¹å™¨<br>docker rm -f $(docker ps -aq)<br>#3ï¼Œå°†é•œåƒå…¨éƒ¨åˆ é™¤<br>docker rmi `docker images -q`<br><br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Harbor-1"><a href="#å®‰è£…Harbor-1" class="headerlink" title="å®‰è£…Harbor"></a>å®‰è£…Harbor</h3><p>1ï¼Œä¿®æ”¹é…ç½®æ–‡ä»¶harbor.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cp ./harbor.yml.tmpl   ./harbor.yml<br><br>vi harbor.yml<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Configuration file of Harbor<br><br># The IP address or hostname to access admin UI and registry service.<br># DO NOT use localhost or 127.0.0.1, because Harbor needs to be accessed by external clients.<br>hostname: harbor.chen1900s.com<br><br># http related config<br>http:<br>  # port for http, default is 80. If https enabled, this port will redirect to https port<br>  port: 80<br><br># https related config<br>https:<br>  # https port for harbor, default is 443<br>  port: 443<br>  # The path of cert and key files for nginx<br>  certificate: /root/ssl/harbor.chen1900s.com.crt<br>  private_key: /root/ssl/harbor.chen1900s.com.key<br><br># # Uncomment following will enable tls communication between all harbor components<br># internal_tls:<br>#   # set enabled to true means internal tls is enabled<br>#   enabled: true<br>#   # put your cert and key files on dir<br>#   dir: /etc/harbor/tls/internal<br>  #######å…¶ä»–é…ç½®ä¿æŒä¸å˜<br>  <br></code></pre></td></tr></table></figure><p>2ï¼Œæ‰§è¡Œå®‰è£…å‘½ä»¤</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">./prepare<br><br>./install.sh<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[Step 5]: starting Harbor ...<br>[+] Running 9/9<br> â ¿ Container harbor-log         Started            0.7s<br> â ¿ Container harbor-portal      Started            1.7s<br> â ¿ Container harbor-db          Started            1.5s<br> â ¿ Container registry           Started            1.6s<br> â ¿ Container redis              Started            1.7s<br> â ¿ Container registryctl        Started            1.5s<br> â ¿ Container harbor-core        Started            2.0s<br> â ¿ Container nginx              Started            2.6s<br> â ¿ Container harbor-jobservice  Started            2.6s<br> âœ” ----Harbor has been installed and started successfully.----<br></code></pre></td></tr></table></figure><p>ä»¥ä¸Šæç¤ºè¡¨ç¤ºå®‰è£…æˆåŠŸ</p><p>å¦‚æœæ˜¯è‡ªç­¾çš„åŸŸå éœ€è¦åŠ ä¸‹hostsé…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">94.191.122.37    harbor.chen1900s.com<br></code></pre></td></tr></table></figure><p>æµè§ˆå™¨ç™»é™†æç¤ºä¸å®‰å…¨çš„è¯ä¹¦ï¼ŒåŸå› æ˜¯æˆ‘ä»¬æ˜¯è‡ªå·±å½“CAæœºæ„ï¼Œæ‰€ä»¥æµè§ˆå™¨ä¼šä¸ä¿¡ä»»ã€‚æ·»åŠ ä¿¡ä»»å°±å¥½</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209062147398.png" alt="image-20220906214758292"></p><p>å…¶ä»–æœºå™¨å¦‚æœè¦æ‹‰å–é•œåƒç™»é™†é•œåƒä»“åº“ï¼Œéœ€è¦é…ç½®</p><ol><li>åˆ›å»ºç›®å½•&#x2F;etc&#x2F;docker&#x2F;certs.d&#x2F;harbor.chen1900s.comï¼ˆåé¢çš„ç›®å½•æ˜¯è‡ªå·±å®šä¹‰çš„åŸŸåï¼‰</li><li>å°†harborçš„è¯ä¹¦æ‹·è´åˆ°åˆ›å»ºçš„ç›®å½•ä¸­</li><li>ä¿®æ”¹&#x2F;etc&#x2F;docker&#x2F;daemon.jsonï¼Œæ·»åŠ insecure-registriesé…ç½®ï¼Œå¡«å†™è‡ªå·±çš„åŸŸå</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cat /etc/docker/daemon.json<br>&#123;<br>  &quot;registry-mirrors&quot;: [&quot;https://mirror.ccs.tencentyun.com&quot;],<br>  &quot;insecure-registries&quot;: [&quot;harbor.chen1900s.com&quot;]   <br>&#125;<br></code></pre></td></tr></table></figure><p>   4ï¼Œé…ç½®hostsï¼š94.191.122.37    harbor.chen1900s.com</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">echo  â€œ94.191.122.37    harbor.chen1900s.comâ€ &gt;&gt; /etc/hosts<br></code></pre></td></tr></table></figure><p>â€‹    5ï¼Œç„¶åé‡å¯dockerå®¹å™¨å’ŒharboræœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">systemctl daemon-reload   é‡æ–°åŠ è½½daemon<br>systemctl restart docker  #é‡å¯dockeræœåŠ¡<br>systemctl status docker<br><br>docker-compose  restart  #ç™»é™†harboré…ç½®ç›®å½•æ‰§è¡Œ<br></code></pre></td></tr></table></figure><h3 id="ç™»é™†å’Œä¸Šä¼ æ‹‰å–é•œåƒ"><a href="#ç™»é™†å’Œä¸Šä¼ æ‹‰å–é•œåƒ" class="headerlink" title="ç™»é™†å’Œä¸Šä¼ æ‹‰å–é•œåƒ"></a>ç™»é™†å’Œä¸Šä¼ æ‹‰å–é•œåƒ</h3><p>ç™»é™†ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">root@VM-249-124-tlinux ~/harbor]# docker login harbor.chen1900s.com<br>Username: admin<br>Password: <br>WARNING! Your password will be stored unencrypted in /root/.docker/config.json.<br>Configure a credential helper to remove this warning. See<br>https://docs.docker.com/engine/reference/commandline/login/#credentials-store<br><br>Login Succeeded<br></code></pre></td></tr></table></figure><p>ä¸Šä¼ é•œåƒï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">docker tag 80d28bedfe5d harbor.chen1900s.com/library/pause:latest  #å°†é•œåƒé‡æ–°æ‰“tag<br>docker push harbor.chen1900s.com/library/pause:latest        #æ¨é€é•œåƒ<br>The push refers to repository [harbor.chen1900s.com/library/pause]<br>ba0dae6243cc: Pushed <br>latest: digest: sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108 size: 52<br></code></pre></td></tr></table></figure><p>ç™»é™†å…¶ä»–èŠ‚ç‚¹æ‹‰å–é•œåƒ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-33-tlinux ~]# docker pull harbor.chen1900s.com/library/pause:latest<br>latest: Pulling from library/pause<br>Digest: sha256:4a1c4b21597c1b4415bdbecb28a3296c6b5e23ca4f9feeb599860a1dac6a0108<br>Status: Downloaded newer image for harbor.chen1900s.com/library/pause:latest<br>harbor.chen1900s.com/library/pause:latest<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Helmå®‰è£…å’Œä½¿ç”¨</title>
      <link href="/post/e3ad72ca.html"/>
      <url>/post/e3ad72ca.html</url>
      
        <content type="html"><![CDATA[<h3 id="ä¸€-å®‰è£…Helmå®¢æˆ·ç«¯"><a href="#ä¸€-å®‰è£…Helmå®¢æˆ·ç«¯" class="headerlink" title="ä¸€  å®‰è£…Helmå®¢æˆ·ç«¯"></a>ä¸€  å®‰è£…Helmå®¢æˆ·ç«¯</h3><blockquote><p>æœ¬æ–‡æ˜¯é€šè¿‡äºŒè¿›åˆ¶æ–¹å¼å®‰è£…ï¼Œå¦‚éœ€å…¶ä»–æ–¹å¼å¯ä»¥å‚è€ƒå®˜ç½‘æ–‡æ¡£</p><p>helmå®˜æ–¹æ–‡æ¡£ï¼š <a href="https://helm.sh/zh/docs/intro/install/">https://helm.sh/zh/docs/intro/install/</a></p></blockquote><p>æ¯ä¸ªHelm <a href="https://github.com/helm/helm/releases">ç‰ˆæœ¬</a>éƒ½æä¾›äº†å„ç§æ“ä½œç³»ç»Ÿçš„äºŒè¿›åˆ¶ç‰ˆæœ¬ï¼Œä¸åŒçš„ç‰ˆæœ¬å¯ä»¥æ‰‹åŠ¨ä¸‹è½½å’Œå®‰è£…ã€‚</p><ol><li>ä¸‹è½½ <a href="https://github.com/helm/helm/releases">éœ€è¦çš„ç‰ˆæœ¬</a></li><li>è§£å‹(<code>tar -zxvf helm-v3.0.0-linux-amd64.tar.gz</code>)</li><li>åœ¨è§£å‹ç›®ä¸­æ‰¾åˆ°<code>helm</code>ç¨‹åºï¼Œç§»åŠ¨åˆ°éœ€è¦çš„ç›®å½•ä¸­(<code>mv linux-amd64/helm /usr/local/bin/helm</code>)</li></ol><h3 id="äºŒ-æ·»åŠ helmä»“åº“"><a href="#äºŒ-æ·»åŠ helmä»“åº“" class="headerlink" title="äºŒ  æ·»åŠ helmä»“åº“"></a>äºŒ  æ·»åŠ helmä»“åº“</h3><p>ä»¥è…¾è®¯äº‘TCRé•œåƒä»“åº“ä¸ºä¾‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#å‘½ä»¤ç¤ºä¾‹<br>#helm repo add $instance-$namespace https://$instance.tencentcloudcr.com/chartrepo/$namespace --username $username --password $instance-token<br><br>#å®é™…æ“ä½œç¤ºä¾‹ï¼Œæ ¹æ®è‡ªå·±çš„å‚è€ƒä¿®æ”¹å¯¹åº”çš„ä¿¡æ¯<br>#å…¶ä¸­ç”¨æˆ·å’Œå¯†ç  å¯ä»¥åœ¨æ§åˆ¶å°åˆ›å»º<br>#helm repo add  tke-pass-helm   https://tke-pass.tencentcloudcr.com/chartrepo/helm --username xxxxxxxx   --password  xxxxxx<br></code></pre></td></tr></table></figure><ul><li><p><code>$instance-$namespace</code>ï¼šä¸º helm repo åç§°ï¼Œå»ºè®®ä½¿ç”¨<strong>å®ä¾‹åç§°+å‘½åç©ºé—´åç§°</strong>ç»„åˆçš„æ–¹å¼å‘½åï¼Œä»¥ä¾¿äºåŒºåˆ†å„ä¸ªå®ä¾‹åŠå‘½åç©ºé—´ã€‚</p></li><li><p>https:&#x2F;&#x2F;$instance.tencentcloudcr.com&#x2F;chartrepo&#x2F;$namespaceï¼šä¸º helm repo çš„è¿œç«¯åœ°å€ã€‚</p></li><li><p><code>$username</code>ï¼šå·²è·å–çš„ç”¨æˆ·åã€‚</p></li><li><p><code>$instance-token</code>ï¼šå·²è·å–çš„ç™»å½•å¯†ç ã€‚</p><p>å¦‚æ·»åŠ æˆåŠŸå°†æç¤ºä»¥ä¸‹ä¿¡æ¯ã€‚</p></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&quot;tcr-chen-helm&quot; has been added to your repositories<br></code></pre></td></tr></table></figure><p>ä½¿ç”¨è¯¥å‘½ä»¤å¯ä»¥æŸ¥çœ‹å½“å‰çš„helm ä»“åº“ä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># helm repo list<br>NAME                            URL                                                                                         <br>tcr-chen-helm                   https://tcr-chen.tencentcloudcr.com/chartrepo/helm<br></code></pre></td></tr></table></figure><h3 id="ä¸‰-æ¨é€-Helm-Chart"><a href="#ä¸‰-æ¨é€-Helm-Chart" class="headerlink" title="ä¸‰ æ¨é€ Helm Chart"></a>ä¸‰ æ¨é€ Helm Chart</h3><ol><li><p>å®‰è£… Helm Push æ’ä»¶</p><blockquote><p>æ³¨æ„ï¼šè¯·å®‰è£… 0.9.0 åŠä»¥ä¸Šç‰ˆæœ¬çš„ helm-push æ’ä»¶ï¼Œé¿å…å› ç‰ˆæœ¬ä¸å…¼å®¹ç­‰é—®é¢˜é€ æˆæ— æ³•æ­£å¸¸æ¨é€ helm chartã€‚</p></blockquote><p>ä½¿ç”¨ Helm CLI ä¸Šä¼  Chart åŒ…éœ€è¦å®‰è£… helm-push æ’ä»¶ï¼Œè¯¥æ’ä»¶æ”¯æŒä½¿ç”¨helm push æŒ‡ä»¤æ¨é€ helm chart è‡³æŒ‡å®š repoï¼ŒåŒæ—¶æ”¯æŒä¸Šä¼ ç›®å½•åŠå‹ç¼©åŒ…ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm plugin install https://github.com/chartmuseum/helm-push<br></code></pre></td></tr></table></figure></li><li><p>åœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œåˆ›å»ºä¸€ä¸ª Chartã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm create  chart-demo<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯ç›´æ¥æ¨é€æŒ‡å®šç›®å½•è‡³ Chart ä»“åº“ï¼ˆå¯é€‰ï¼‰ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm push  chart-demo $instance-$namespace<br>#æ¸©é¦¨æç¤ºé«˜çº§ç‰ˆæœ¬ä½¿ç”¨çš„æ˜¯cm-pushå‘½ä»¤<br>#helm cm-push chart-demo $instance-$namespace<br></code></pre></td></tr></table></figure><p>å…¶ä¸­   $instance-$namespace  ä¸ºå·²æ·»åŠ çš„æœ¬åœ°ä»“åº“åç§°ã€‚</p></li><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œå¯å‹ç¼©æŒ‡å®šç›®å½•ï¼Œå¹¶æ¨é€è‡³ Chart ä»“åº“ã€‚</p><figure class="highlight shell"><table><tr><td class="code"><pre><code class="hljs shell">tar zcvf  chart-demo-1.0.0.tgz chart-demo/<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm push  chart-demo-1.0.0.tgz $instance-$namespace<br></code></pre></td></tr></table></figure><p>å…¶ä¸­$instance-$namespaceä¸ºå·²æ·»åŠ çš„æœ¬åœ°ä»“åº“åç§°ã€‚</p></li></ol><h3 id="å››-æ‹‰å–-Helm-Chart"><a href="#å››-æ‹‰å–-Helm-Chart" class="headerlink" title="å›› æ‹‰å– Helm Chart"></a>å›› æ‹‰å– Helm Chart</h3><ol><li><p>åœ¨èŠ‚ç‚¹ä¸Šæ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œè·å–æœ€æ–°çš„ Chart ä¿¡æ¯ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm repo update<br></code></pre></td></tr></table></figure></li><li><p>æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼Œæ‹‰å–æŒ‡å®šç‰ˆæœ¬ Helm Chartã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm fetch &lt;æœ¬åœ°ä»“åº“åç§°&gt;/&lt;Chart åç§°&gt; --version &lt;Chart ç‰ˆæœ¬&gt;<br></code></pre></td></tr></table></figure><p>ä»¥ä»ä¼ä¸šç‰ˆå®ä¾‹ tcr-demo ä¸­æ‹‰å–å‘½åç©ºé—´ project-a å†… tcr-chart-demo 1.0.0 ç‰ˆæœ¬ä¸ºä¾‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm fetch tcr-chen-helm/chart-demo --version 1.0.0<br></code></pre></td></tr></table></figure></li></ol><h3 id="äº”-è‡ªå»ºHarborå¯ç”¨helmchartæœåŠ¡"><a href="#äº”-è‡ªå»ºHarborå¯ç”¨helmchartæœåŠ¡" class="headerlink" title="äº” è‡ªå»ºHarborå¯ç”¨helmchartæœåŠ¡"></a>äº” è‡ªå»ºHarborå¯ç”¨helmchartæœåŠ¡</h3><h4 id="1ï¼Œå®‰è£…-harbor-çš„-helmchart-repository"><a href="#1ï¼Œå®‰è£…-harbor-çš„-helmchart-repository" class="headerlink" title="1ï¼Œå®‰è£… harbor çš„ helmchart repository"></a><strong>1ï¼Œå®‰è£… harbor çš„ helmchart repository</strong></h4><p>é»˜è®¤æ–°ç‰ˆ harbor ä¸ä¼šå¯ç”¨ chart repository serviceï¼Œå¦‚æœéœ€è¦è‡ªå»ºçš„harborç®¡ç† helmåº”ç”¨çš„è¯ï¼Œéœ€è¦åœ¨å®‰è£…æ—¶æ·»åŠ é¢å¤–çš„å‚æ•°ï¼Œä¾‹å¦‚ï¼šå¯ç”¨ chart repository service æœåŠ¡çš„å®‰è£…æ–¹å¼è¦æ·»åŠ ä¸€ä¸ªå‚æ•° â€“with-chartmuseum</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-55-9-tlinux ~/docker-compose/harbor]# ./install.sh --with-chartmuseum<br></code></pre></td></tr></table></figure><p>å®‰è£…å®Œæˆåï¼Œä¼šæœ‰è¿™ä¸ªæç¤º è¯´æ˜æ˜¯å®‰è£…æˆåŠŸï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">â ¿ Container chartmuseum              Started <br></code></pre></td></tr></table></figure><h4 id="2ï¼Œå‘å¸ƒ-helm-charts"><a href="#2ï¼Œå‘å¸ƒ-helm-charts" class="headerlink" title="2ï¼Œå‘å¸ƒ helm charts"></a>2ï¼Œå‘å¸ƒ helm charts</h4><p><strong>æ–¹å¼ä¸€ã€åŸºäºdashboard çš„å¯è§†åŒ–ä¸Šä¼ </strong></p><p>ç”¨æˆ·ä½¿ç”¨æµè§ˆå™¨ç™»å½• harboré•œåƒä»“åº“åï¼Œåœ¨å¯¹åº”çš„ç®¡ç†ç•Œé¢æ“ä½œå³å¯ï¼Œå¦‚ä¸‹å›¾ï¼š</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/1652931750847.png" alt="1652931750847"></p><p><strong>æ–¹å¼äºŒã€åŸºäºå‘½ä»¤è¡Œçš„ CLI æ¨é€</strong></p><p>ä½œä¸ºä¸€ä¸ªè¿ç»´äººå‘˜æˆ–è€…å¼€å‘äººå‘˜ï¼Œæ›´å–œæ¬¢é€šè¿‡å‘½ä»¤è¡Œæ–¹å¼æ¨é€å’Œæ‹‰å–helmï¼Œå¦‚ä¸‹æ“ä½œ</p><p>1ã€å®‰è£…æ’ä»¶</p><p>ä¸ºäº†èƒ½ä½¿ç”¨å‘½ä»¤æ¨é€ï¼Œæˆ‘ä»¬éœ€è¦å®‰è£…å¹¶ä½¿ç”¨ helm push æ’ä»¶åŒ…ï¼Œåœ°å€ï¼š <a href="https://github.com/chartmuseum/helm-push/releases">https://github.com/chartmuseum/helm-push/releases</a></p><p>a) åœ¨çº¿å®‰è£…æ’ä»¶ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">helm plugin install https://github.com/chartmuseum/helm-pus<br></code></pre></td></tr></table></figure><p>b) ç¦»çº¿å®‰è£…æ’ä»¶ï¼š</p><p>ä¸‹è½½å®‰è£…åŒ… helm-push_0.10.1_linux_amd64.tar.gzï¼Œå†ä½¿ç”¨å‘½ä»¤ helm env è·å– HELM_PLUGINS è·¯å¾„ï¼Œç„¶åæ”¾ç½®å’Œè§£å‹å®‰è£…åŒ…ï¼Œæœ€åä½¿ç”¨ helm plugin list æŸ¥çœ‹ç»“æœï¼Œå¦‚ä¸‹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-55-9-tlinux ~/harbor]# helm env | grep HELM_PLUGINS<br>HELM_PLUGINS=&quot;/root/.local/share/helm/plugins<br>[root@VM-55-9-tlinux ~/harbor]# mkdir -p /root/.local/share/helm/plugins/helm-push<br>[root@VM-55-9-tlinux ~/harbor]# mv helm-push_0.10.1_linux_amd64.tar.gz /root/.local/share/helm/plugins/helm-push/<br>[root@VM-55-9-tlinux ~/harbor]# cd /root/.local/share/helm/plugins/helm-push/<br>[root@VM-55-9-tlinux helm-push]# tar -xzvf helm-push_0.10.1_linux_amd64.tar.gz <br>[root@VM-55-9-tlinux helm-push]# helm plugin list<br>NAME    VERSION DESCRIPTION                  <br>cm-push 0.10.1  Push chart package to ChartMuseum<br><br></code></pre></td></tr></table></figure><p>2ã€æ·»åŠ  harbor ä»“åº“åˆ°æœ¬åœ° helm ä»“åº“åˆ—è¡¨</p><p>æŸ¥çœ‹æœ¬åœ°ä»“åº“åˆ—è¡¨(åˆ—å‡ºçš„æ˜¯æˆ‘å·²ç»æ·»åŠ å…¶ä»–ä»“åº“)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-55-9-tlinux ~/helm]# helm repo list<br>NAME            URL                                           <br>tke-pass-helm   https://tke-pass.tencentcloudcr.com/chartrepo/helm<br><br># æ·»åŠ ä»“åº“åœ°å€åˆ°æœ¬åœ°åˆ—è¡¨(å…¶ä¸­ myharbor-helm ä¸ºè¿™ä¸ªä»“åº“åœ°å€åœ¨ helm æœ¬åœ°çš„åç§°ï¼Œè¿æ¥æ˜¯ä»“åº“URLï¼Œåé¢æ˜¯ç™»å½• harbor çš„ç”¨æˆ·åå’Œå¯†ç )<br># URLæ ¼å¼ï¼šhttp(s)://&#123;harboråŸŸåæˆ–iP:ç«¯å£(å¦‚æœé»˜è®¤443æˆ–80å¯ä¸åŠ )&#125;/chartrepo/&#123;yourHarborProjectName&#125;<br><br>[root@VM-55-9-tlinux ~/helm]# helm repo add myharbor-helm http://101.35.6.116:88/chartrepo/charts --username admin  --password xxxxxx<br><br>#æœ‰å¦‚ä¸‹æç¤ºè¡¨ç¤ºæ·»åŠ æˆåŠŸ<br>&quot;myharbor-helm&quot; has been added to your repositories<br><br># å†æŸ¥çœ‹(å‘ç°å·²æ·»åŠ æˆåŠŸ)<br>[root@VM-55-9-tlinux ~/helm]# helm repo list<br>NAME            URL                                           <br>tke-pass-helm   https://tke-pass.tencentcloudcr.com/chartrepo/helm<br>myharbor-helm   http://101.35.6.116:88/chartrepo/charts<br><br>##æ›´æ–°æœ¬åœ°ä»“åº“ç¼“å­˜å†…å®¹<br>[root@VM-55-9-tlinux ~/helm]# helm repo update<br>Hang tight while we grab the latest from your chart repositories...<br>...Successfully got an update from the &quot;myharbor-helm&quot; chart repository<br>...Successfully got an update from the &quot;tke-pass-helm&quot; chart repository<br>Update Complete. âˆHappy Helming!âˆ<br></code></pre></td></tr></table></figure><blockquote><p>æ¸©é¦¨æç¤ºï¼š</p><p>1ï¼Œharbor ä»“åº“ URL ä¸­çš„ chartrepo æ˜¯å›ºå®šå€¼ã€‚</p><p>2ï¼Œåœ¨æ“ä½œä¹‹å‰ï¼Œè¯·åŠ¡å¿…å…ˆåœ¨ harbor ä¸­åˆ›å»ºå¥½é¡¹ç›®ï¼Œä¾‹å¦‚ chartså³ä¸ºå…ˆåˆ›å»ºå¥½çš„é¡¹ç›®åç§°ã€‚</p><p>3ï¼Œå¦‚æœä½ è¿˜æ˜¯æä¸æ¸…è¿™ä¸ªURLï¼Œå¯ä»¥åœ¨harborç•Œé¢ä¸­ä¸Šä¼ ä¸€ä¸ªå¤–é¢ä¸‹ç€çš„ chart åŒ…ï¼Œä¸Šæ¬¡æˆåŠŸåè¿›å…¥è¿™ä¸ª chart è¯¦ç»†é¡µé¢ï¼Œåœ¨ â€œæ¦‚è¦è¿™ä¸ªTabâ€ çš„æœ€åº•éƒ¨åŒºåŸŸï¼Œharborä¼šå‘Šè¯‰ä½ åœ¨æœ¬åœ°æ·»åŠ ä»“åº“çš„URLå’Œå‘½ä»¤ã€‚</p></blockquote><p>3ã€æ¨é€ chart ä»¥åŠ chart çš„æ›´å¤šæ“ä½œ</p><p>æ¨é€ chart ç¤ºä¾‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># æ¨é€chartæ–‡ä»¶å¤¹æ–¹å¼<br>helm push mychartdemo myharbor-helm<br><br># æ¨é€chartå‹ç¼©åŒ…æ–¹å¼<br>helm push mychartdemo-1.0.1.tgz myharbor-helm<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Helm </tag>
            
            <tag> Kubernetes </tag>
            
            <tag> Harbor </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteså®¹å™¨èµ„æºé™åˆ¶å’Œlxcfsé—®é¢˜</title>
      <link href="/post/e0d4c727.html"/>
      <url>/post/e0d4c727.html</url>
      
        <content type="html"><![CDATA[<h2 id="Dockerå®¹å™¨èµ„æºé™åˆ¶é—®é¢˜"><a href="#Dockerå®¹å™¨èµ„æºé™åˆ¶é—®é¢˜" class="headerlink" title="Dockerå®¹å™¨èµ„æºé™åˆ¶é—®é¢˜"></a>Dockerå®¹å™¨èµ„æºé™åˆ¶é—®é¢˜</h2><blockquote><p>ä»¥ä¸‹æ˜¯åŸºäºè…¾è®¯äº‘TKEå®¹å™¨æœåŠ¡æµ‹è¯•éªŒè¯</p></blockquote><h3 id="èƒŒæ™¯"><a href="#èƒŒæ™¯" class="headerlink" title="èƒŒæ™¯"></a>èƒŒæ™¯</h3><p>Linuxåˆ©ç”¨CGroupå®ç°äº†å¯¹å®¹å™¨èµ„æºçš„é™åˆ¶ï¼Œä½†æ˜¯åœ¨å®¹å™¨å†…éƒ¨è¿˜æ˜¯é»˜è®¤æŒ‚è½½å®¿ä¸»æœº &#x2F;proc ç›®å½•ä¸‹çš„èµ„æºä¿¡æ¯æ–‡ä»¶ï¼Œå¦‚ï¼šmeminfo,cpuinfo,stat,uptiemï¼Œç­‰ã€‚å½“è¿›å…¥Containersæ‰§è¡Œfreeï¼Œdfï¼Œtopç­‰å‘½ä»¤çš„æ—¶å€™ï¼Œè¿™æ—¶å€™é»˜è®¤è¯»å–çš„æ˜¯ &#x2F;proc ç›®å½•å†…çš„èµ„æºä¿¡æ¯æ–‡ä»¶å†…å®¹ï¼Œè€Œè¿™äº›èµ„æºä¿¡æ¯æ–‡ä»¶ä½¿ç”¨çš„æ˜¯å®¿ä¸»æœºçš„ï¼Œæ‰€ä»¥æˆ‘ä»¬çœ‹åˆ°çš„æ˜¯å®¿ä¸»æœºçš„ä½¿ç”¨ä¿¡æ¯ã€‚</p><h3 id="å…³äºLXCFS"><a href="#å…³äºLXCFS" class="headerlink" title="å…³äºLXCFS"></a>å…³äºLXCFS</h3><p>LXCFSæ˜¯ä¸€ä¸ªå¼€æºçš„FUSEï¼ˆç”¨æˆ·æ€æ–‡ä»¶ç³»ç»Ÿï¼‰ï¼Œç”¨æ¥æ”¯æŒLXCå®¹å™¨ï¼Œä¹Ÿæ”¯æŒDockerå®¹å™¨ï¼Œç¤¾åŒºä¸­å¸¸ç”¨æ­¤å·¥å…·æ¥å®ç°å®¹å™¨ä¸­çš„èµ„æºå¯è§æ€§ã€‚</p><p><strong>LXCFSåŸç†ï¼š</strong></p><p>ä»¥å†…å­˜èµ„æºä¸ºåˆ—ï¼šé€šè¿‡å°†å®¿ä¸»æœºçš„ &#x2F;var&#x2F;lib&#x2F;lxcfs&#x2F;meminfo æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨å†…çš„&#x2F;proc&#x2F;meminfoï¼Œç„¶åLXCFSä¼šä»å®¹å™¨çš„CGroupä¸­è¯»å–æ­£ç¡®çš„å†…å­˜é™åˆ¶ï¼Œç„¶ååº”ç”¨åˆ° &#x2F;var&#x2F;lib&#x2F;lxcfs&#x2F;meminfo ï¼Œè¿™æ—¶å€™å®¹å™¨å†…éƒ¨ä»è€Œå°±å¾—åˆ°äº†æ­£ç¡®çš„å†…å­˜ä¿¡æ¯ã€‚</p><blockquote><p>è¯´æ˜ï¼š&#x2F;var&#x2F;lib&#x2F;lxcfs&#x2F;meminfo æ˜¯æœåŠ¡å¯åŠ¨çš„æ—¶å€™é»˜è®¤æŒ‡å®šçš„ç›®å½•ã€‚ </p></blockquote><h3 id="æ“ä½œæ­¥éª¤"><a href="#æ“ä½œæ­¥éª¤" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h3><p>ç›®å‰è…¾è®¯äº‘TKEé‡Œé¢æƒ³å®ç°å¯¹å®¹å™¨èµ„æºçš„é™åˆ¶ï¼Œåœ¨å®¹å™¨é‡Œé¢æ‰§è¡Œfreeï¼Œdfï¼Œtopç­‰å‘½ä»¤çš„æ—¶å€™çœ‹åˆ°å®¹å™¨çœŸæ­£çš„èµ„æºï¼Œæœ‰ä¸¤ç§æ–¹æ¡ˆ</p><h4 id="æ–¹æ¡ˆä¸€ï¼šç›®å‰-TencentOS-Server-ç‰¹æ€§å·²æ”¯æŒå®¹å™¨èµ„æºå±•ç¤ºéš”ç¦»"><a href="#æ–¹æ¡ˆä¸€ï¼šç›®å‰-TencentOS-Server-ç‰¹æ€§å·²æ”¯æŒå®¹å™¨èµ„æºå±•ç¤ºéš”ç¦»" class="headerlink" title="æ–¹æ¡ˆä¸€ï¼šç›®å‰ TencentOS Server ç‰¹æ€§å·²æ”¯æŒå®¹å™¨èµ„æºå±•ç¤ºéš”ç¦»"></a>æ–¹æ¡ˆä¸€ï¼š<strong>ç›®å‰ <a href="https://github.com/Tencent/TencentOS-kernel/wiki/container-resource-view-isolation">TencentOS Server</a> ç‰¹æ€§å·²æ”¯æŒå®¹å™¨èµ„æºå±•ç¤ºéš”ç¦»</strong></h4><ul><li>å¢åŠ ä¸»æœºçº§å¼€å…³ï¼šå†…æ ¸å·²å®ç°äº†ç±»ä¼¼ LXCFS ç‰¹æ€§ã€‚ç”¨æˆ·æ— éœ€åœ¨èŠ‚ç‚¹éƒ¨ç½² LXCFS æ–‡ä»¶ç³»ç»ŸåŠä¿®æ”¹ POD specï¼Œä»…éœ€åœ¨èŠ‚ç‚¹å¼€å¯å…¨å±€å¼€å…³ï¼ˆ<code>sysctl -w kernel.stats_isolated=1</code>ï¼‰ï¼Œ<code>/proc/cpuinfo</code> åŠ <code>/proc/meminfo</code> ç­‰æ–‡ä»¶è·å–å³å¯æŒ‰å®¹å™¨éš”ç¦» </li><li>å¢åŠ å®¹å™¨çº§å¼€å…³ï¼šé’ˆå¯¹ç±»ä¼¼èŠ‚ç‚¹ç›‘æ§ç»„ä»¶ç­‰ç‰¹æ®Šå®¹å™¨ï¼Œå¢åŠ äº†å®¹å™¨çº§å¼€å…³ kernel.container_stats_isolatedã€‚åœ¨ä¸»æœºçº§å¼€å…³å¼€å¯æ—¶ï¼Œä»…éœ€åœ¨å®¹å™¨å¯åŠ¨è„šæœ¬ä¸­å…³é—­å®¹å™¨çº§å¼€å…³ï¼ˆsysctl -w kernel.container_stats_isolated&#x3D;0ï¼‰ï¼Œå³å¯åœ¨å®¹å™¨ä¸­è¯»å– &#x2F;proc&#x2F;cpuinfo åŠ &#x2F;proc&#x2F;meminfo æ–‡ä»¶æ—¶è·å–åˆ°ä¸»æœºä¿¡æ¯ã€‚</li></ul><p><strong>1ï¼Œç¯å¢ƒå‡†å¤‡</strong></p><p>å·²åˆ›å»ºé›†ç¾¤å¹¶æ·»åŠ èŠ‚ç‚¹ï¼Œä½¿ç”¨æ“ä½œç³»ç»Ÿtlinux 2.4ï¼ŒèŠ‚ç‚¹è§„æ ¼4C8G</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~/lxcfs]# uname -r<br>4.14.105-19-0020.1<br>[root@VM-0-17-tlinux ~/lxcfs]# sysctl  -a| grep kernel.stats_isolated<br>kernel.stats_isolated = 0<br><br>#é»˜è®¤æ˜¯0<br></code></pre></td></tr></table></figure><p><strong>2ï¼ŒæŸ¥çœ‹å½“å‰ä¸»æœºèŠ‚ç‚¹ä¸Šèµ„æºæƒ…å†µ</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~/lxcfs]# cat /proc/meminfo | grep MemTotal<br>MemTotal:        8035132 kB<br>[root@VM-0-17-tlinux ~/lxcfs]# cat /proc/cpuinfo  | grep processor | wc -l<br>4<br>[root@VM-0-17-tlinux ~/lxcfs]# free -m<br>              total        used        free      shared  buff/cache   available<br>Mem:           7846        2394        2571           2        2880        5299<br>Swap:             0           0           0<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041912729.png" alt="1627827269129"></p><p><strong>3ï¼Œæœªä¿®æ”¹å‰ç™»å½•å®¹å™¨æŸ¥çœ‹èµ„æºï¼Œçœ‹åˆ°çš„æ˜¯å®¿ä¸»æœºçš„ä½¿ç”¨ä¿¡æ¯ã€‚</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~/lxcfs]# kubectl  exec -it centos-5ccb64bbdb-h7nb9  -- /bin/bash<br>[root@centos-5ccb64bbdb-h7nb9 /]# cat /proc/meminfo | grep MemTotal<br>MemTotal:        8035132 kB<br>[root@centos-5ccb64bbdb-h7nb9 /]# cat /proc/cpuinfo  | grep processor | wc -l<br>4<br>[root@centos-5ccb64bbdb-h7nb9 /]# free -m<br>              total        used        free      shared  buff/cache   available<br>Mem:           7846        2409        2555           2        2881        5285<br>Swap:             0           0           0<br></code></pre></td></tr></table></figure><p><strong>4ï¼Œ å¼€å¯å…¨å±€å¼€å…³  ï¼ˆ<code>sysctl -w kernel.stats_isolated=1</code>ï¼‰</strong> </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# sysctl -w kernel.stats_isolated=1<br>kernel.stats_isolated = 1<br>[root@VM-0-17-tlinux ~]# sysctl  -p<br></code></pre></td></tr></table></figure><p><strong>5ï¼Œè¿›ä¸€æ­¥æŸ¥çœ‹å®¹å™¨èµ„æºæƒ…å†µ</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@centos-5ccb64bbdb-h7nb9 /]# cat /proc/meminfo | grep MemTotal<br>MemTotal:        1048576 kB<br>[root@centos-5ccb64bbdb-h7nb9 /]# cat /proc/cpuinfo  | grep processor | wc -l<br>1<br>[root@centos-5ccb64bbdb-h7nb9 /]# free -m<br>              total        used        free      shared  buff/cache   available<br>Mem:           1024           4        1014           0           4         934<br>Swap:          1024           0        1024<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041912725.png" alt="1627827658184"></p><p><strong>5ï¼Œä½å†…æ ¸ç‰ˆæœ¬ä¸æ”¯æŒè¯¥å‚æ•°</strong></p><blockquote><p>å¦å¤–ä¸€ä¸ªèŠ‚ç‚¹   æ“ä½œç³»ç»Ÿæ˜¯centos å†…æ ¸ç‰ˆæœ¬æ˜¯ 3.10</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-2-46-centos ~]# sysctl -w kernel.stats_isolated=1<br>sysctl: cannot stat /proc/sys/kernel/stats_isolated: No such file or directory<br>[root@VM-2-46-centos ~]# uname -a<br>Linux VM-2-46-centos 3.10.0-1160.11.1.el7.x86_64 #1 SMP Fri Dec 18 16:34:56 UTC 2020 x86_64 x86_64 x86_64 GNU/Linux<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913987.png" alt="1627828366685"></p><h4 id="æ–¹æ¡ˆäºŒ-ä½¿ç”¨LXCFS"><a href="#æ–¹æ¡ˆäºŒ-ä½¿ç”¨LXCFS" class="headerlink" title="æ–¹æ¡ˆäºŒ:ä½¿ç”¨LXCFS"></a>æ–¹æ¡ˆäºŒ:ä½¿ç”¨LXCFS</h4><blockquote><p><a href="https://github.com/denverdino/lxcfs-admission-webhook">lxcfså®˜æ–¹ä»‹ç»</a></p></blockquote><p>åœ¨èŠ‚ç‚¹ä¸Šå®‰è£…LXCFS ï¼Œ é€šè¿‡å°†å®¿ä¸»æœºçš„ &#x2F;var&#x2F;lib&#x2F;lxcfs&#x2F;meminfo æ–‡ä»¶æŒ‚è½½åˆ°å®¹å™¨å†…çš„&#x2F;proc&#x2F;meminfoï¼Œç„¶åLXCFSä¼šä»å®¹å™¨çš„CGroupä¸­è¯»å–æ­£ç¡®çš„å†…å­˜é™åˆ¶ï¼Œç„¶ååº”ç”¨åˆ° &#x2F;var&#x2F;lib&#x2F;lxcfs&#x2F;meminfo ï¼Œè¿™æ—¶å€™å®¹å™¨å†…éƒ¨ä»è€Œå°±å¾—åˆ°äº†æ­£ç¡®çš„å†…å­˜ä¿¡æ¯ </p><p><strong>1ï¼Œç¯å¢ƒå‡†å¤‡ ï¼ˆ nodeèŠ‚ç‚¹OSï¼šcentos 7.6 ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#å®‰è£…ä¾èµ–<br>yum install -y fuse-libs<br>git  clone https://github.com/denverdino/lxcfs-admission-webhook.git<br>cd  lxcfs-admission-webhook<br></code></pre></td></tr></table></figure><p><strong>2ï¼Œéƒ¨ç½²å®‰è£…</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#éƒ¨ç½²lxcfs daemonset<br>kubectl  apply -f deployment/lxcfs-daemonset.yaml<br>#éƒ¨ç½²lxcfs admission webhook<br>#sh  deployment/install.sh  #åˆ é™¤çš„è¯ä½¿ç”¨sh  deployment/uninstall.sh <br>#æ‰§è¡Œkubectl get po ï¼Œç¡®è®¤æ‰€æœ‰podéƒ½å¤„äºRunningçŠ¶æ€<br>[root@VM-2-46-centos lxcfs-admission-webhook]# kubectl  get pods  | grep lxcfs<br>lxcfs-4bjxh                                           1/1     Running   0          8m44s<br>lxcfs-56225                                           1/1     Running   0          8m44s<br>lxcfs-admission-webhook-deployment-58d6fdcf49-jmxd9   1/1     Running   0          8m3s<br>lxcfs-f2gt5                                           1/1     Running   0          8m44s<br>lxcfs-h6smp                                           1/1     Running   0          8m44s<br></code></pre></td></tr></table></figure><p><strong>3ï¼ŒéªŒè¯æ•ˆæœï¼Œå¯åŠ¨lxcfs</strong></p><p> å¯¹äºè¦ä½¿ç”¨ lxcfs çš„namespaceï¼Œä½¿ç”¨å¦‚ä¸‹å‘½ä»¤å¯ç”¨lxcfs admission webhookçš„è‡ªåŠ¨æ³¨å…¥ï¼ˆä»¥lxcfä¸ºä¾‹ï¼‰ï¼š </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl label namespace lxcfs  lxcfs-admission-webhook=enabled<br>kubectl  get ns --show-labels<br>kubectl  get pods -n lxcfs<br><br>#éƒ¨ç½²PODåˆ°centos 7.6 èŠ‚ç‚¹ä¸Š<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913268.png" alt="1627830668749"></p><p>ç¡®è®¤å†…å­˜ä¿¡æ¯</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913663.png" alt="1627830753483"></p><p>ç¡®è®¤CPUä¿¡æ¯</p><blockquote><p>å¦‚æœpodè®¾ç½®äº†cpu limitï¼Œçœ‹åˆ°cpuæ•°é‡ä¸ºcpu limitå€¼å‘ä¸Šå–æ•´</p></blockquote><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913204.png" alt="1627830843444"></p><p><strong>4ï¼Œå¸è½½æ¸…ç†lxcfs</strong></p><p> æ¸…ç† lxcfs-admission-webhook </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">deployment/uninstall.sh<br></code></pre></td></tr></table></figure><p> æ¸…ç† lxcfs </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl delete -f deployment/lxcfs-daemonset.yaml<br></code></pre></td></tr></table></figure><p>lxcfs æ”¯æŒå®¹å™¨é•œåƒ Centosç³»ç»Ÿã€Ubuntuç³»ç»Ÿã€Debianç³»ç»Ÿï¼Œä½†æ˜¯ä¸æ”¯æŒå®¹å™¨é•œåƒ Alpineç³»ç»Ÿã€‚å› ä¸º Alpine ä¸æ˜¯ä½¿ç”¨ Gnu libcï¼Œè€Œæ˜¯ä½¿ç”¨ musl libc</p><h4 id="é™„æ³¨ï¼š1-12-TKEé›†ç¾¤ç‰ˆæœ¬é›†ç¾¤éªŒè¯"><a href="#é™„æ³¨ï¼š1-12-TKEé›†ç¾¤ç‰ˆæœ¬é›†ç¾¤éªŒè¯" class="headerlink" title="é™„æ³¨ï¼š1.12 TKEé›†ç¾¤ç‰ˆæœ¬é›†ç¾¤éªŒè¯"></a>é™„æ³¨ï¼š1.12 TKEé›†ç¾¤ç‰ˆæœ¬é›†ç¾¤éªŒè¯</h4><blockquote><p>åœ¨ä¸€æ¬¡å¤„ç†å®¢æˆ·é—®é¢˜æ—¶å€™ï¼Œå®¢æˆ·å’¨è¯¢1.12ç‰ˆæœ¬æ˜¯å¦æ”¯æŒlxcfs ï¼Œæ‰€åšä»¥ä¸‹éªŒè¯ï¼Œä»…ä½œä¸ºè®°å½•</p></blockquote><p><strong>1ï¼Œç¯å¢ƒå‡†å¤‡</strong></p><ul><li><p>centos7.6.0_x64 </p></li><li><p>é›†ç¾¤ç‰ˆæœ¬1.12</p></li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-2-2-centos ~]# cat /etc/redhat-release <br>CentOS Linux release 7.6.1810 (Core) <br>[root@VM-2-2-centos ~]# kubectl  get nodes -o wide<br>NAME       STATUS   ROLES    AGE   VERSION          INTERNAL-IP   EXTERNAL-IP       OS-IMAGE                KERNEL-VERSION                CONTAINER-RUNTIME<br>10.1.2.2   Ready    &lt;none&gt;   18m   v1.12.4-tke.29   10.1.2.2      114.117.211.163   CentOS Linux 7 (Core)   3.10.0-1160.11.1.el7.x86_64   docker://19.3.9<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913476.png" alt="1628694819462"></p><p><strong>2ï¼ŒæŸ¥çœ‹å½“å‰ä¸»æœºèµ„æºæƒ…å†µ</strong>**</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913463.png" alt="1628694227083"></p><p><strong>3ï¼Œæœªå®‰è£…lxcfsä¹‹å‰éƒ¨ç½²POD</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">resources:<br>  limits:<br>    cpu: 800m<br>    memory: 1Gi<br>  requests:<br>    cpu: 200m<br>    memory: 256Mi<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041913087.png" alt="1628694282800"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914606.png" alt="1628694413673"></p><p><strong>4ï¼Œå®‰è£…lxcfsç»„ä»¶ å¹¶æŸ¥çœ‹æ˜¯å¦æˆåŠŸ</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914350.png" alt="1628694556172"></p><p><strong>45ï¼Œæµ‹è¯•ï¼Œé”€æ¯åˆšæ‰åˆ›å»ºçš„å·¥ä½œè´Ÿè½½</strong></p><p><strong>5ï¼Œç™»å½•PODé‡Œé¢æŸ¥çœ‹èµ„æº</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914545.png" alt="1628695298213"></p><p><strong>6 ï¼ŒCPU 1:2  å†…å­˜1:1</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914300.png" alt="1628695390761"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914669.png" alt="1628695575243"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914339.png" alt="1628695524786"></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041914326.png" alt="1628695619794"></p><p>å‚è€ƒé“¾æ¥ï¼š</p><ul><li><a href="https://github.com/denverdino/lxcfs-admission-webhook">https://github.com/denverdino/lxcfs-admission-webhook</a></li></ul>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteséƒ¨ç½²ä¸»ä»æ¶æ„Mysqlé›†ç¾¤</title>
      <link href="/post/24ba3d3c.html"/>
      <url>/post/24ba3d3c.html</url>
      
        <content type="html"><![CDATA[<h2 id="æ¦‚è¿°"><a href="#æ¦‚è¿°" class="headerlink" title="æ¦‚è¿°"></a>æ¦‚è¿°</h2><blockquote><p>éšç€kuberneteså‘å±•ï¼Œè¶Šæ¥è¶Šå¤šçš„äººå¼€å§‹ä½¿ç”¨kuberneteséƒ¨ç½²è‡ªå·±åº”ç”¨ï¼Œå®ƒæ˜¯å®¹å™¨é›†ç¾¤ç®¡ç†ç³»ç»Ÿï¼Œæ˜¯ä¸€ä¸ªå¼€æºçš„å¹³å°ï¼Œå¯ä»¥å®ç°å®¹å™¨é›†ç¾¤çš„è‡ªåŠ¨åŒ–éƒ¨ç½²ã€è‡ªåŠ¨æ‰©ç¼©å®¹ã€ç»´æŠ¤ç­‰åŠŸèƒ½ï¼Œç„¶è€Œå¾ˆå¤šåº”ç”¨ä¹Ÿä½¿ç”¨åˆ°æ•°æ®åº“ï¼Œä¸‹é¢é€šè¿‡kubernetesä¸Šéƒ¨ç½²ä¸ªä¸»ä»æ¶æ„çš„Mysqlé›†ç¾¤ä¾›åº”ç”¨ä½¿ç”¨</p></blockquote><h2 id="å‡†å¤‡ç¯å¢ƒ"><a href="#å‡†å¤‡ç¯å¢ƒ" class="headerlink" title="å‡†å¤‡ç¯å¢ƒ"></a>å‡†å¤‡ç¯å¢ƒ</h2><p>kubernetesé›†ç¾¤ï¼ˆæœ¬æ¬¡å®éªŒä½¿ç”¨çš„æ˜¯è…¾è®¯äº‘TKEé›†ç¾¤ï¼Œç‰ˆæœ¬1.18ï¼‰</p><h2 id="æ“ä½œæ­¥éª¤"><a href="#æ“ä½œæ­¥éª¤" class="headerlink" title="æ“ä½œæ­¥éª¤"></a>æ“ä½œæ­¥éª¤</h2><p>ä¸»è¦é€šè¿‡ä¸€ä¸‹å‡ ä¸ªæ­¥éª¤å®Œæ•´çš„æ­å»ºä¸€ä¸ªMySQLé›†ç¾¤</p><ol><li>æ­å»ºä¸€ä¸ª<code>ä¸»ä»å¤åˆ¶</code>ï¼ˆMaster-Slaveï¼‰çš„MySQLé›†ç¾¤</li><li>ä»èŠ‚ç‚¹å¯ä»¥è¿›è¡Œæ°´å¹³æ‰©å±•ï¼Œæ‰©å®¹å¤šä¸ªèŠ‚ç‚¹</li><li>æ‰€æœ‰çš„<code>å†™</code>æ“ä½œåªèƒ½åœ¨MySQLä¸»èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</li><li>è¯»æ“ä½œå¯ä»¥åœ¨MySQLä¸»ä»èŠ‚ç‚¹ä¸Šæ‰§è¡Œ</li><li>ä»èŠ‚ç‚¹èƒ½è‡ªåŠ¨åŒæ­¥ä¸»èŠ‚ç‚¹çš„æ•°æ®</li></ol><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209041753863.png" alt="image-20211125204741527"></p><h3 id="æœåŠ¡éƒ¨ç½²"><a href="#æœåŠ¡éƒ¨ç½²" class="headerlink" title="æœåŠ¡éƒ¨ç½²"></a>æœåŠ¡éƒ¨ç½²</h3><p>1ï¼Œåˆ›å»ºmysqlä½¿ç”¨çš„Namespaceï¼ˆå¦‚æœä¸åˆ›å»ºå¯ä»¥ä½¿ç”¨é»˜è®¤å‘½åç©ºé—´ï¼Œä¸€èˆ¬å»ºè®®å•ç‹¬ç»™æ•°æ®åˆ›å»ºä¸ªå‘½åç©ºé—´ä½¿ç”¨ï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Namespace<br>metadata:<br>  name: mysql<br>  labels:<br>    app: mysql<br></code></pre></td></tr></table></figure><p>2ï¼Œåˆ›å»ºæ•°æ®åº“çš„é…ç½®æ–‡ä»¶configmap</p><p>ä½¿ç”¨ConfigMapä¸ºMaster&#x2F;SlaveèŠ‚ç‚¹åˆ†é…ä¸åŒçš„é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: mysql<br>  namespace: mysql<br>  labels:<br>    app: mysql<br>data:<br>  master.cnf: |<br>    # Masterä¸»èŠ‚ç‚¹é…ç½®<br>    [mysqld]<br>    log-bin=mysqllog<br>    skip-name-resolve<br>  slave.cnf: |<br>    # Slaveä»èŠ‚ç‚¹é…ç½®<br>    [mysqld]<br>    super-read-only<br>    skip-name-resolve<br>    log-bin=mysql-bin<br>    replicate-ignore-db=mysql<br></code></pre></td></tr></table></figure><p>3ï¼Œåˆ›å»ºMySQLå¯†ç Secret</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Secret<br>metadata:<br>  name: mysql-secret<br>  namespace: mysql<br>  labels:<br>    app: mysql<br>type: Opaque<br>data:<br>  password: MTIzNDU2   # echo -n &quot;123456&quot; | base64<br></code></pre></td></tr></table></figure><p>4ï¼Œä½¿ç”¨Serviceä¸ºMySQLæä¾›è¯»å†™åˆ†ç¦»</p><ul><li>ç”¨æˆ·æ‰€æœ‰å†™è¯·æ±‚ï¼Œå¿…é¡»ä»¥DNSè®°å½•çš„æ–¹å¼ç›´æ¥è®¿é—®åˆ°MasterèŠ‚ç‚¹ï¼Œä¹Ÿå°±æ˜¯mysql-0.mysqlè¿™æ¡DNSè®°å½•ã€‚</li><li>ç”¨æˆ·æ‰€æœ‰è¯»è¯·æ±‚ï¼Œå¿…é¡»è®¿é—®è‡ªåŠ¨åˆ†é…çš„DNSè®°å½•å¯ä»¥è¢«è½¬å‘åˆ°ä»»æ„ä¸€ä¸ªMasteræˆ–SlaveèŠ‚ç‚¹ä¸Šï¼Œä¹Ÿå°±æ˜¯mysql-readè¿™æ¡DNSè®°å½•ã€‚</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: mysql<br>  namespace: mysql<br>  labels:<br>    app: mysql<br>spec:<br>  ports:<br>  - name: mysql<br>    port: 3306<br>  clusterIP: None<br>  selector:<br>    app: mysql<br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: mysql-read<br>  namespace: mysql<br>  labels:<br>    app: mysql<br>spec:<br>  ports:<br>  - name: mysql<br>    port: 3306<br>  selector:<br>    app: mysql<br></code></pre></td></tr></table></figure><p>5ï¼Œåˆ›å»ºMySQLé›†ç¾¤å®ä¾‹</p><p>ä½¿ç”¨StatefulSetæ­å»ºMySQLä¸»ä»é›†ç¾¤</p><p>æ•´ä½“çš„StatefulSetæœ‰ä¸¤ä¸ªReplicasï¼Œä¸€ä¸ªMasterï¼Œä¸€ä¸ªSlaveï¼Œç„¶åä½¿ç”¨<code>init-mysql</code>è¿™ä¸ª<code>initContainers</code>è¿›è¡Œ<code>é…ç½®æ–‡ä»¶çš„åˆå§‹åŒ–</code>ã€‚æ¥ç€ä½¿ç”¨<code>clone-mysql</code>è¿™ä¸ª<code>initContainers</code>è¿›è¡Œ<code>æ•°æ®çš„ä¼ è¾“</code>ï¼›åŒæ—¶ä½¿ç”¨<code>xtrabackup</code>è¿™ä¸ª**<code>sidecar</code>å®¹å™¨**è¿›è¡Œ<code>SQLåˆå§‹åŒ–å’Œæ•°æ®ä¼ è¾“åŠŸèƒ½</code>ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: StatefulSet<br>metadata:<br>  name: mysql<br>  namespace: mysql<br>  labels:<br>    app: mysql<br>spec:<br>  selector:<br>    matchLabels:<br>      app: mysql<br>  serviceName: mysql    #æ³¨æ„è¿™ä¸ªåƒä¸‡åˆ«å°‘äº›<br>  replicas: 2<br>  template:<br>    metadata:<br>      labels:<br>        app: mysql<br>    spec:<br>      initContainers:<br>      - name: init-mysql<br>        image: mysql:5.7<br>        env:<br>        - name: MYSQL_ROOT_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              name: mysql-secret<br>              key: password<br>        command:<br>        - bash<br>        - &quot;-c&quot;<br>        - |<br>          set -ex<br>          # ä»Podçš„åºå·ï¼Œç”Ÿæˆserver-id<br>          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1<br>          ordinal=$&#123;BASH_REMATCH[1]&#125;<br>          echo [mysqld] &gt; /mnt/conf.d/server-id.cnf<br>          # ç”±äºserver-idä¸èƒ½ä¸º0ï¼Œå› æ­¤ç»™IDåŠ 100æ¥é¿å¼€å®ƒ<br>          echo server-id=$((100 + $ordinal)) &gt;&gt; /mnt/conf.d/server-id.cnf<br>          # å¦‚æœPodçš„åºå·ä¸º0ï¼Œè¯´æ˜å®ƒæ˜¯MasterèŠ‚ç‚¹ï¼Œä»ConfigMapé‡ŒæŠŠMasterçš„é…ç½®æ–‡ä»¶æ‹·è´åˆ°/mnt/conf.dç›®å½•ä¸‹<br>          # å¦åˆ™ï¼Œæ‹·è´ConfigMapé‡Œçš„Slaveçš„é…ç½®æ–‡ä»¶<br>          if [[ $&#123;ordinal&#125; -eq 0 ]]; then<br>            cp /mnt/config-map/master.cnf /mnt/conf.d<br>          else<br>            cp /mnt/config-map/slave.cnf /mnt/conf.d<br>          fi<br>        volumeMounts:<br>        - name: conf<br>          mountPath: /mnt/conf.d<br>        - name: config-map<br>          mountPath: /mnt/config-map<br>      - name: clone-mysql<br>        image: gcr.tencentcloudcr.com/google-samples/xtrabackup:1.0   #ä½¿ç”¨è…¾è®¯é•œåƒåŠ é€Ÿ<br>        env:<br>        - name: MYSQL_ROOT_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              name: mysql-secret<br>              key: password<br>        command:<br>        - bash<br>        - &quot;-c&quot;<br>        - |<br>          set -ex<br>          # æ‹·è´æ“ä½œåªéœ€è¦åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶è¿›è¡Œï¼Œæ‰€ä»¥æ•°æ®å·²ç»å­˜åœ¨åˆ™è·³è¿‡<br>          [[ -d /var/lib/mysql/mysql ]] &amp;&amp; exit 0<br>          # Master èŠ‚ç‚¹ï¼ˆåºå·ä¸º 0ï¼‰ä¸éœ€è¦è¿™ä¸ªæ“ä½œ<br>          [[ $(hostname) =~ -([0-9]+)$ ]] || exit 1<br>          ordinal=$&#123;BASH_REMATCH[1]&#125;<br>          [[ $ordinal == 0 ]] &amp;&amp; exit 0<br>          # ä½¿ç”¨ncatæŒ‡ä»¤ï¼Œè¿œç¨‹åœ°ä»å‰ä¸€ä¸ªèŠ‚ç‚¹æ‹·è´æ•°æ®åˆ°æœ¬åœ°<br>          ncat --recv-only mysql-$(($ordinal-1)).mysql 3307 | xbstream -x -C /var/lib/mysql<br>          # æ‰§è¡Œ --prepareï¼Œè¿™æ ·æ‹·è´æ¥çš„æ•°æ®å°±å¯ä»¥ç”¨ä½œæ¢å¤äº†<br>          xtrabackup --prepare --target-dir=/var/lib/mysql<br>        volumeMounts:<br>        - name: data<br>          mountPath: /var/lib/mysql<br>          subPath: mysql<br>        - name: conf<br>          mountPath: /etc/mysql/conf.d<br>      containers:<br>      - name: mysql<br>        image: mysql:5.7<br>        env:<br> #        - name: MYSQL_ALLOW_EMPTY_PASSWORD<br> #          value: &quot;1&quot;<br>        - name: MYSQL_ROOT_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              name: mysql-secret<br>              key: password<br>        ports:<br>        - name: mysql<br>          containerPort: 3306<br>        volumeMounts:<br>        - name: data<br>          mountPath: /var/lib/mysql<br>          subPath: mysql<br>        - name: conf<br>          mountPath: /etc/mysql/conf.d<br>        resources:<br>          requests:<br>            cpu: 500m<br>            memory: 1Gi<br>        livenessProbe:<br>          exec:<br>            command: [&quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-uroot&quot;, &quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;]<br>          initialDelaySeconds: 30<br>          periodSeconds: 10<br>          timeoutSeconds: 5<br>        readinessProbe:<br>          exec:<br>            command: [&quot;mysqladmin&quot;, &quot;ping&quot;, &quot;-uroot&quot;, &quot;-p$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;]<br>          initialDelaySeconds: 5<br>          periodSeconds: 2<br>          timeoutSeconds: 1<br>      - name: xtrabackup<br>        image: gcr.tencentcloudcr.com/google-samples/xtrabackup:1.0<br>        ports:<br>        - name: xtrabackup<br>          containerPort: 3307<br>        env:<br>        - name: MYSQL_ROOT_PASSWORD<br>          valueFrom:<br>            secretKeyRef:<br>              name: mysql-secret<br>              key: password<br>        command:<br>        - bash<br>        - &quot;-c&quot;<br>        - |<br>          set -ex<br>          cd /var/lib/mysql<br>          # ä»å¤‡ä»½ä¿¡æ¯æ–‡ä»¶é‡Œè¯»å–MASTER_LOG_FILEå’ŒMASTER_LOG_POSè¿™2ä¸ªå­—æ®µçš„å€¼ï¼Œç”¨æ¥æ‹¼è£…é›†ç¾¤åˆå§‹åŒ–SQL<br>          if [[ -f xtrabackup_slave_info ]]; then<br>            # å¦‚æœxtrabackup_slave_infoæ–‡ä»¶å­˜åœ¨ï¼Œè¯´æ˜è¿™ä¸ªå¤‡ä»½æ•°æ®æ¥è‡ªäºå¦ä¸€ä¸ªSlaveèŠ‚ç‚¹<br>            # è¿™ç§æƒ…å†µä¸‹ï¼ŒXtraBackupå·¥å…·åœ¨å¤‡ä»½çš„æ—¶å€™ï¼Œå°±å·²ç»åœ¨è¿™ä¸ªæ–‡ä»¶é‡Œè‡ªåŠ¨ç”Ÿæˆäº†â€œCHANGE MASTER TOâ€SQLè¯­å¥<br>            # æ‰€ä»¥ï¼Œåªéœ€è¦æŠŠè¿™ä¸ªæ–‡ä»¶é‡å‘½åä¸ºchange_master_to.sql.inï¼Œåé¢ç›´æ¥ä½¿ç”¨å³å¯<br>            mv xtrabackup_slave_info change_master_to.sql.in<br>            # æ‰€ä»¥ï¼Œä¹Ÿå°±ç”¨ä¸ç€xtrabackup_binlog_infoäº†<br>            rm -f xtrabackup_binlog_info<br>          elif [[ -f xtrabackup_binlog_info ]]; then<br>            # å¦‚æœåªæ˜¯å­˜åœ¨xtrabackup_binlog_infoæ–‡ä»¶ï¼Œè¯´æ˜å¤‡ä»½æ¥è‡ªäºMasterèŠ‚ç‚¹ï¼Œå°±éœ€è¦è§£æè¿™ä¸ªå¤‡ä»½ä¿¡æ¯æ–‡ä»¶ï¼Œè¯»å–æ‰€éœ€çš„ä¸¤ä¸ªå­—æ®µçš„å€¼<br>            [[ $(cat xtrabackup_binlog_info) =~ ^(.*?)[[:space:]]+(.*?)$ ]] || exit 1<br>            rm xtrabackup_binlog_info<br>            # æŠŠä¸¤ä¸ªå­—æ®µçš„å€¼æ‹¼è£…æˆSQLï¼Œå†™å…¥change_master_to.sql.inæ–‡ä»¶<br>            echo &quot;CHANGE MASTER TO MASTER_LOG_FILE=&#x27;$&#123;BASH_REMATCH[1]&#125;&#x27;,\<br>                  MASTER_LOG_POS=$&#123;BASH_REMATCH[2]&#125;&quot; &gt; change_master_to.sql.in<br>          fi<br>          # å¦‚æœå­˜åœ¨change_master_to.sql.inï¼Œå°±æ„å‘³ç€éœ€è¦åšé›†ç¾¤åˆå§‹åŒ–å·¥ä½œ<br>          if [[ -f change_master_to.sql.in ]]; then<br>            # ä½†ä¸€å®šè¦å…ˆç­‰MySQLå®¹å™¨å¯åŠ¨ä¹‹åæ‰èƒ½è¿›è¡Œä¸‹ä¸€æ­¥è¿æ¥MySQLçš„æ“ä½œ<br>            echo &quot;Waiting for mysqld to be readyï¼ˆaccepting connectionsï¼‰&quot;<br>            until mysql -h 127.0.0.1 -uroot -p$&#123;MYSQL_ROOT_PASSWORD&#125; -e &quot;SELECT 1&quot;; do sleep 1; done<br>            echo &quot;Initializing replication from clone position&quot;<br>            # å°†æ–‡ä»¶change_master_to.sql.inæ”¹ä¸ªåå­—<br>            # é˜²æ­¢è¿™ä¸ªContaineré‡å¯çš„æ—¶å€™ï¼Œå› ä¸ºåˆæ‰¾åˆ°äº†change_master_to.sql.inï¼Œä»è€Œé‡å¤æ‰§è¡Œä¸€éåˆå§‹åŒ–æµç¨‹<br>            mv change_master_to.sql.in change_master_to.sql.orig<br>            # ä½¿ç”¨change_master_to.sql.origçš„å†…å®¹ï¼Œä¹Ÿå°±æ˜¯å‰é¢æ‹¼è£…çš„SQLï¼Œç»„æˆä¸€ä¸ªå®Œæ•´çš„åˆå§‹åŒ–å’Œå¯åŠ¨Slaveçš„SQLè¯­å¥<br>            mysql -h 127.0.0.1 -uroot -p$&#123;MYSQL_ROOT_PASSWORD&#125; &lt;&lt; EOF<br>          $(&lt; change_master_to.sql.orig),<br>            MASTER_HOST=&#x27;mysql-0.mysql.mysql&#x27;,<br>            MASTER_USER=&#x27;root&#x27;,<br>            MASTER_PASSWORD=&#x27;$&#123;MYSQL_ROOT_PASSWORD&#125;&#x27;,<br>            MASTER_CONNECT_RETRY=10;<br>          START SLAVE;<br>          EOF<br>          fi<br>          # ä½¿ç”¨ncatç›‘å¬3307ç«¯å£ã€‚<br>          # å®ƒçš„ä½œç”¨æ˜¯ï¼Œåœ¨æ”¶åˆ°ä¼ è¾“è¯·æ±‚çš„æ—¶å€™ï¼Œç›´æ¥æ‰§è¡Œxtrabackup --backupå‘½ä»¤ï¼Œå¤‡ä»½MySQLçš„æ•°æ®å¹¶å‘é€ç»™è¯·æ±‚è€…<br>          exec ncat --listen --keep-open --send-only --max-conns=1 3307 -c \<br>            &quot;xtrabackup --backup --slave-info --stream=xbstream --host=127.0.0.1 --user=root --password=$&#123;MYSQL_ROOT_PASSWORD&#125;&quot;<br>        volumeMounts:<br>        - name: data<br>          mountPath: /var/lib/mysql<br>          subPath: mysql<br>        - name: conf<br>          mountPath: /etc/mysql/conf.d<br>      volumes:<br>      - name: conf<br>        emptyDir: &#123;&#125;<br>      - name: config-map<br>        configMap:<br>          name: mysql<br>  volumeClaimTemplates:<br>  - metadata:<br>      name: data<br>    spec:<br>      accessModes:<br>      - &quot;ReadWriteOnce&quot;<br>      storageClassName: cbs<br>      resources:<br>        requests:<br>          storage: 10Gi            #æ•°æ®ç›˜å¤§å°æ ¹æ®ä¸šåŠ¡æƒ…å†µé•œåƒä¿®æ”¹ï¼Œè¿™ä¸ªåªåšæµ‹è¯•ï¼Œåªå†™äº†10Gi <br></code></pre></td></tr></table></figure><p>å¯ä»¥çœ‹åˆ°ï¼ŒStatefulSetå¯åŠ¨æˆåŠŸåï¼Œä¼šæœ‰ä¸¤ä¸ªPodè¿è¡Œã€‚æ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•å‘è¿™ä¸ªMySQLé›†ç¾¤å‘èµ·è¯·æ±‚ï¼Œæ‰§è¡Œä¸€äº›SQLæ“ä½œæ¥éªŒè¯å®ƒæ˜¯å¦æ­£å¸¸ã€‚æ•´ä¸ªè¿‡ç¨‹å› ä¸ºæ‹‰å–mysqlå’Œä¸€ä¸ª<code>gcr.io/google-samples/xtrabackup:1.0</code>ï¼ˆä½¿ç”¨è…¾è®¯äº‘åŠ é€Ÿé•œåƒåœ°å€gcr.tencentcloudcr.comï¼‰å›½å¤–çš„é•œåƒä¼šå¾ˆæ…¢,ä½†æ˜¯åœ¨åˆ›å»ºmysql-0æ‹‰å–ä¸€æ¬¡ä¹‹åï¼Œåç»­åˆ›å»ºmysql-1å°±ç›¸å¯¹å¾ˆå¿«äº†ã€‚</p><p>æœ€åï¼Œå®¹å™¨æ£€æŸ¥podçš„è¿è¡ŒçŠ¶æ€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# kubectl  get all -n mysql  -o wide<br>NAME          READY   STATUS    RESTARTS   AGE    IP           NODE           NOMINATED NODE   READINESS GATES<br>pod/mysql-0   2/2     Running   0          108s   172.18.1.4   192.168.2.40   &lt;none&gt;           &lt;none&gt;<br>pod/mysql-1   2/2     Running   0          76s    172.18.1.5   192.168.2.40   &lt;none&gt;           &lt;none&gt;<br><br>NAME                 TYPE        CLUSTER-IP       EXTERNAL-IP   PORT(S)    AGE     SELECTOR<br>service/mysql        ClusterIP   None             &lt;none&gt;        3306/TCP   2m24s   app=mysql<br>service/mysql-read   ClusterIP   172.18.253.108   &lt;none&gt;        3306/TCP   2m24s   app=mysql<br><br>NAME                     READY   AGE    CONTAINERS         IMAGES<br>statefulset.apps/mysql   2/2     108s   mysql,xtrabackup   mysql:5.7,gcr.tencentcloudcr.com/google-samples/xtrabackup:1.0<br></code></pre></td></tr></table></figure><h3 id="æœåŠ¡éªŒè¯"><a href="#æœåŠ¡éªŒè¯" class="headerlink" title="æœåŠ¡éªŒè¯"></a>æœåŠ¡éªŒè¯</h3><p>1ï¼ŒéªŒè¯ä¸»ä»å…³ç³»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# kubectl -n mysql exec mysql-1 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;show slave status \G&#x27;&quot;<br>mysql: [Warning] Using a password on the command line interface can be insecure.<br>*************************** 1. row ***************************<br>               Slave_IO_State: Waiting for master to send event<br>                  Master_Host: mysql-0.mysql.mysql<br>                  Master_User: root<br>                  Master_Port: 3306<br>                Connect_Retry: 10<br>              Master_Log_File: mysqllog.000003<br>          Read_Master_Log_Pos: 154<br>               Relay_Log_File: mysql-1-relay-bin.000002<br>                Relay_Log_Pos: 319<br>        Relay_Master_Log_File: mysqllog.000003<br>             Slave_IO_Running: Yes<br>            Slave_SQL_Running: Yes<br>              Replicate_Do_DB: <br>          Replicate_Ignore_DB: mysql<br>           Replicate_Do_Table: <br>       Replicate_Ignore_Table: <br>      Replicate_Wild_Do_Table: <br>  Replicate_Wild_Ignore_Table: <br>                   Last_Errno: 0<br>                   Last_Error: <br>                 Skip_Counter: 0<br>          Exec_Master_Log_Pos: 154<br>              Relay_Log_Space: 528<br>              Until_Condition: None<br>               Until_Log_File: <br>                Until_Log_Pos: 0<br>           Master_SSL_Allowed: No<br>           Master_SSL_CA_File: <br>           Master_SSL_CA_Path: <br>              Master_SSL_Cert: <br>            Master_SSL_Cipher: <br>               Master_SSL_Key: <br>        Seconds_Behind_Master: 0<br>Master_SSL_Verify_Server_Cert: No<br>                Last_IO_Errno: 0<br>                Last_IO_Error: <br>               Last_SQL_Errno: 0<br>               Last_SQL_Error: <br>  Replicate_Ignore_Server_Ids: <br>             Master_Server_Id: 100<br>                  Master_UUID: f8d3bd9a-4df4-11ec-9930-52d15f478b07<br>             Master_Info_File: /var/lib/mysql/master.info<br>                    SQL_Delay: 0<br>          SQL_Remaining_Delay: NULL<br>      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates<br>           Master_Retry_Count: 86400<br>                  Master_Bind: <br>      Last_IO_Error_Timestamp: <br>     Last_SQL_Error_Timestamp: <br>               Master_SSL_Crl: <br>           Master_SSL_Crlpath: <br>           Retrieved_Gtid_Set: <br>            Executed_Gtid_Set: <br>                Auto_Position: 0<br>         Replicate_Rewrite_DB: <br>                 Channel_Name: <br>           Master_TLS_Version: <br></code></pre></td></tr></table></figure><p>2ï¼Œæ¥ä¸‹æ¥ï¼Œæˆ‘ä»¬é€šè¿‡Masterå®¹å™¨åˆ›å»ºæ•°æ®åº“å’Œè¡¨ã€æ’å…¥æ•°æ®åº“ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl -n mysql exec mysql-0 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;create database test&#x27;&quot;<br>kubectl -n mysql exec mysql-0 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;use test;create table counter(c int);&#x27;&quot;<br>kubectl -n mysql exec mysql-0 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;use test;insert into counter values(123)&#x27;&quot;<br></code></pre></td></tr></table></figure><p>3ï¼Œç„¶åï¼Œæˆ‘ä»¬è§‚å¯ŸSlaveèŠ‚ç‚¹æ˜¯å¦éƒ½åŒæ­¥åˆ°æ•°æ®äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl -n mysql exec mysql-1 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter&#x27;&quot;  <br></code></pre></td></tr></table></figure><p>æ‰§è¡Œè¿”å›ç»“æœæ˜¯ï¼Œå½“çœ‹åˆ°è¾“å‡ºç»“æœï¼Œä¸»ä»åŒæ­¥æ­£å¸¸äº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~]# kubectl -n mysql exec mysql-1 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter&#x27;&quot; <br>c<br>123<br></code></pre></td></tr></table></figure><h3 id="æ‰©å±•ä»èŠ‚ç‚¹"><a href="#æ‰©å±•ä»èŠ‚ç‚¹" class="headerlink" title="æ‰©å±•ä»èŠ‚ç‚¹"></a>æ‰©å±•ä»èŠ‚ç‚¹</h3><p>åœ¨æœ‰äº†StatefulSetä»¥åï¼Œä½ å°±å¯ä»¥åƒDeploymenté‚£æ ·ï¼Œéå¸¸æ–¹ä¾¿åœ°æ‰©å±•è¿™ä¸ªMySQLé›†ç¾¤ï¼Œæ¯”å¦‚ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl -n mysql scale statefulset mysql  --replicas=3<br>statefulset.apps/mysql scaled<br>[root@VM-0-17-tlinux ~]# kubectl  get pods -n mysql<br>NAME      READY   STATUS     RESTARTS   AGE<br>mysql-0   2/2     Running    0          10m<br>mysql-1   2/2     Running    0          10m<br>mysql-2   0/2     Init:1/2   0          24s<br></code></pre></td></tr></table></figure><p>è¿™æ—¶å€™ï¼Œä¸€ä¸ªæ–°çš„mysql-2å°±åˆ›å»ºå‡ºæ¥äº†ï¼Œæˆ‘ä»¬ç»§ç»­éªŒè¯æ–°æ‰©å®¹çš„èŠ‚ç‚¹æ˜¯å¦éƒ½åŒæ­¥åˆ°ä¸»èŠ‚ç‚¹çš„æ•°æ®ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">kubectl -n mysql exec mysql-2 -c mysql -- bash -c &quot;mysql -uroot -p123456 -e &#x27;use test;select * from counter&#x27;&quot;  <br></code></pre></td></tr></table></figure><p>å½“çœ‹åˆ°è¾“å‡ºç»“æœï¼Œä¸»ä»åŒæ­¥æ­£å¸¸äº†ã€‚ä¹Ÿå°±æ˜¯è¯´ä»StatefulSetä¸ºæˆ‘ä»¬æ–°åˆ›å»ºçš„mysql-2ä¸Šï¼ŒåŒæ ·å¯ä»¥è¯»å–åˆ°ä¹‹å‰æ’å…¥çš„è®°å½•ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œæˆ‘ä»¬çš„æ•°æ®å¤‡ä»½å’Œæ¢å¤ï¼Œéƒ½æ˜¯æœ‰æ•ˆçš„</p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kuberneteséƒ¨ç½²nacosæœåŠ¡</title>
      <link href="/post/7af4624e.html"/>
      <url>/post/7af4624e.html</url>
      
        <content type="html"><![CDATA[<h1 id="Kubernetes-éƒ¨ç½²-Nacos-é›†ç¾¤"><a href="#Kubernetes-éƒ¨ç½²-Nacos-é›†ç¾¤" class="headerlink" title="Kubernetes éƒ¨ç½² Nacos é›†ç¾¤"></a>Kubernetes éƒ¨ç½² Nacos é›†ç¾¤</h1><blockquote><p>å®˜ç½‘æ–‡æ¡£ï¼š<a href="https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html">https://nacos.io/zh-cn/docs/use-nacos-with-kubernetes.html</a></p></blockquote><p>æœ¬æ–‡æ˜¯åŸºäºè…¾è®¯äº‘TKEå®¹å™¨æœåŠ¡é›†ç¾¤æ­å»º</p><h2 id="éƒ¨ç½²æ•°æ®åº“"><a href="#éƒ¨ç½²æ•°æ®åº“" class="headerlink" title="éƒ¨ç½²æ•°æ®åº“"></a>éƒ¨ç½²æ•°æ®åº“</h2><p><strong>1ï¼Œæ•°æ®åº“æ˜¯NFSåšæ•°æ®åŒ–å­˜å‚¨</strong>ï¼ˆæˆ–è€…CBSéƒ½å¯ä»¥ï¼‰</p><p>éœ€è¦æ³¨æ„ï¼š é•œåƒè¦ä½¿ç”¨nacosæä¾›çš„æ•°æ®åº“nacos&#x2F;nacos-mysql:5.7ï¼Œè‡ªå¸¦çš„æ•°æ®åº“åˆ›å»ºå®Œæˆåç›¸å…³åº“å’Œæ•°æ®éƒ½å·²ç»å¯¼å…¥ï¼Œå…¶ä¸­NFSæ›¿æ¢æˆè‡ªå·±NFSå®ä¾‹ï¼Œè‡ªå»ºæˆ–è€…äº‘ä¸ŠCFS</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: Deployment<br>metadata:<br>  generation: 1<br>  labels:<br>    k8s-app: nacos-mysql<br>    qcloud-app: nacos-mysql<br>  name: nacos-mysql<br>  namespace: default<br>spec:<br>  replicas: 1<br>  selector:<br>    matchLabels:<br>      k8s-app: nacos-mysql<br>      qcloud-app: nacos-mysql<br>  template:<br>    metadata:<br>      labels:<br>        k8s-app: nacos-mysql<br>        qcloud-app: nacos-mysql<br>    spec:<br>      containers:<br>      - env:<br>        - name: MYSQL_ROOT_PASSWORD<br>          value: root<br>        - name: MYSQL_DATABASE<br>          value: nacos<br>        - name: MYSQL_USER<br>          value: nacos<br>        - name: MYSQL_PASSWORD<br>          value: nacos<br>        image: nacos/nacos-mysql:5.7<br>        imagePullPolicy: IfNotPresent<br>        name: mysql<br>        resources:<br>          limits:<br>            cpu: 500m<br>            memory: 1Gi<br>          requests:<br>            cpu: 250m<br>            memory: 256Mi<br>        securityContext:<br>          privileged: false<br>        volumeMounts:<br>        - mountPath: /var/lib/mysql<br>          name: mysql-data<br>      dnsPolicy: ClusterFirst<br>      imagePullSecrets:<br>      - name: qcloudregistrykey<br>      restartPolicy: Always<br>      volumes:<br>      - name: mysql-data<br>        nfs:<br>          path: /nacos<br>          server: 192.168.1.6<br><br>---<br>apiVersion: v1<br>kind: Service<br>metadata:<br>  name: nacos-mysql<br>  namespace: default<br>  labels:<br>    name: nacos-mysql<br>spec:<br>  ports:<br>  - port: 3306<br>    targetPort: 3306<br>  selector:<br>    k8s-app: nacos-mysql<br>    qcloud-app: nacos-mysql<br></code></pre></td></tr></table></figure><p>éªŒè¯æ•°æ®åº“å¯ç”¨æ€§ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-0-17-tlinux ~/nacos]# mysql -h172.18.250.54 -unacos -pnacos<br>MySQL [(none)]&gt; show databases;<br>+--------------------+<br>| Database           |<br>+--------------------+<br>| information_schema |<br>| nacos              |<br>+--------------------+<br>2 rows in set (0.01 sec)<br><br>MySQL [(none)]&gt; use nacos<br>Reading table information for completion of table and column names<br>You can turn off this feature to get a quicker startup with -A<br><br>Database changed<br>MySQL [nacos]&gt; show tables;<br>+----------------------+<br>| Tables_in_nacos      |<br>+----------------------+<br>| config_info          |<br>| config_info_aggr     |<br>| config_info_beta     |<br>| config_info_tag      |<br>| config_tags_relation |<br>| group_capacity       |<br>| his_config_info      |<br>| permissions          |<br>| roles                |<br>| tenant_capacity      |<br>| tenant_info          |<br>| users                |<br>+----------------------+<br>12 rows in set (0.00 sec)<br></code></pre></td></tr></table></figure><h2 id="éƒ¨ç½²nacos"><a href="#éƒ¨ç½²nacos" class="headerlink" title="éƒ¨ç½²nacos"></a>éƒ¨ç½²nacos</h2><p><strong>1ï¼Œåˆ›å»ºé“¾æ¥mysqlçš„é…ç½®æ–‡ä»¶</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: ConfigMap<br>metadata:<br>  name: nacos-cm<br>  namespace: nacos<br>data:<br>  mysql.host: &quot;172.18.253.36&quot;  #å¦‚æœæ˜¯K8Sé›†ç¾¤å†…æ•°æ®åº“ï¼Œå¯ä»¥ä½¿ç”¨æœåŠ¡åç§°<br>  mysql.db.name: &quot;nacos&quot;      #ä¸Šé¢åˆ›å»ºæ•°æ®åº“æ˜¯æŒ‡çš„çš„åº“åç§°<br>  mysql.port: &quot;3306&quot;           #ç«¯å£<br>  mysql.user: &quot;nacos&quot;          #ç”¨æˆ·<br>  mysql.password: &quot;nacos&quot;      #ç”¨æˆ·å¯†ç <br></code></pre></td></tr></table></figure><p><strong>2ï¼Œåˆ›å»ºnacos-headless ç”¨äºé›†ç¾¤ä¹‹é—´çš„é“¾æ¥</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Service<br>metadata:<br>  name: nacos-headless<br>  namespace: nacos<br>  labels:<br>    app: nacos<br>  annotations:<br>    service.alpha.kubernetes.io/tolerate-unready-endpoints: &quot;true&quot;<br>spec:<br>  ports:<br>    - port: 8848<br>      name: server<br>      targetPort: 8848<br>  clusterIP: None<br>  selector:<br>    app: nacos<br>    <br>   <br></code></pre></td></tr></table></figure><p><strong>3ï¼Œéƒ¨ç½²nacosæœåŠ¡</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: StatefulSet<br>metadata:<br>  name: nacos<br>  namespace: nacos<br>spec:<br>  serviceName: nacos-headless<br>  replicas: 3<br>  template:<br>    metadata:<br>      labels:<br>        app: nacos<br>      annotations:<br>        pod.alpha.kubernetes.io/initialized: &quot;true&quot;<br>    spec:<br>      affinity:<br>        podAntiAffinity:<br>          requiredDuringSchedulingIgnoredDuringExecution:<br>            - labelSelector:<br>                matchExpressions:<br>                  - key: &quot;app&quot;<br>                    operator: In<br>                    values:<br>                      - nacos<br>              topologyKey: &quot;kubernetes.io/hostname&quot;<br>      containers:<br>        - name: k8snacos<br>          imagePullPolicy: Always<br>          image: nacos/nacos-server:latest<br>          resources:<br>            requests:<br>              memory: &quot;2Gi&quot;<br>              cpu: &quot;500m&quot;<br>          ports:<br>            - containerPort: 8848<br>              name: client<br>          env:<br>            - name: NACOS_REPLICAS<br>              value: &quot;3&quot;<br>            - name: MYSQL_SERVICE_HOST<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.host<br>            - name: MYSQL_SERVICE_DB_NAME<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.db.name<br>            - name: MYSQL_SERVICE_PORT<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.port<br>            - name: MYSQL_SERVICE_USER<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.user<br>            - name: MYSQL_SERVICE_PASSWORD<br>              valueFrom:<br>                configMapKeyRef:<br>                  name: nacos-cm<br>                  key: mysql.password<br>            - name: MODE<br>              value: &quot;cluster&quot;<br>            - name: NACOS_SERVER_PORT<br>              value: &quot;8848&quot;<br>            - name: PREFER_HOST_MODE<br>              value: &quot;hostname&quot;<br>            - name: NACOS_SERVERS<br>              value: &quot;nacos-0.nacos-headless.nacos.svc.cluster.local:8848 nacos-1.nacos-headless.nacos.svc.cluster.local:8848 nacos-2.nacos-headless.nacos.svc.cluster.local:8848&quot;<br>  selector:<br>    matchLabels:<br>      app: nacos<br>      <br>      <br></code></pre></td></tr></table></figure><p><strong>4ï¼Œåˆ›å»ºå…¬ç½‘ç±»å‹CLBçš„serviceï¼ˆå¯é€‰ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: v1<br>kind: Service<br>metadata:<br>  annotations:<br>    service.kubernetes.io/service.extensiveParameters: &#x27;&#123;&quot;AddressIPVersion&quot;:&quot;IPV4&quot;,&quot;ZoneId&quot;:&quot;ap-chongqing-1&quot;&#125;&#x27;<br>  name: nacos<br>  namespace: nacos<br>spec:<br>  externalTrafficPolicy: Cluster<br>  ports:<br>  - name: 8848-8848-tcp<br>    port: 8848<br>    protocol: TCP<br>    targetPort: 8848<br>  selector:<br>    app: nacos<br>  sessionAffinity: None<br>  type: LoadBalancer<br><br></code></pre></td></tr></table></figure><p><strong>5ï¼Œåˆ›å»ºå…¬ç½‘è®¿é—®çš„ingressï¼ˆå¯é€‰ï¼‰</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: networking.k8s.io/v1beta1<br>kind: Ingress<br>metadata:<br>  annotations:<br>    ingress.cloud.tencent.com/direct-access: &quot;false&quot;<br>  name: nacos-ingress<br>  namespace: nacos<br>spec:<br>  rules:<br>  - host: nacos.dev.cc<br>    http:<br>      paths:<br>      - backend:<br>          serviceName: nacos<br>          servicePort: 8848<br>        path: /nacos<br></code></pre></td></tr></table></figure><h2 id="nacosä½¿ç”¨"><a href="#nacosä½¿ç”¨" class="headerlink" title="nacosä½¿ç”¨"></a>nacosä½¿ç”¨</h2><p><strong>1ï¼Œä½¿ç”¨serviceè®¿é—® æˆ–è€…ingressè¿›è¡Œè®¿é—®</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220826004712494.png" alt="image-20220826004712494"></p><h2 id="ã€é™„å½•äº‹é¡¹ã€‘ï¼š"><a href="#ã€é™„å½•äº‹é¡¹ã€‘ï¼š" class="headerlink" title="ã€é™„å½•äº‹é¡¹ã€‘ï¼š"></a>ã€é™„å½•äº‹é¡¹ã€‘ï¼š</h2><p>é™„1ï¼Œå¦‚æœå¯¹åº”æ•°æ®åº“é…ç½®æ²¡æœ‰é—®é¢˜ï¼Œä½†æ˜¯nacoså¯åŠ¨ä¸€ç›´æŠ¥å¦‚ä¸‹é”™ï¼Œæ‰¾ä¸åˆ°æ•°æ®æº</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">nacos server did not start because dumpservice bean construction failure. errMsg:102, dataSource or tableName is null<br></code></pre></td></tr></table></figure><p>å¯¼è‡´çš„åŸå› æ˜¯ï¼Œéœ€è¦é¢å¤–åŠ ä¸€ä¸‹è¿™ä¸ªç¯å¢ƒå˜é‡</p><p>SPRING_DATASOURCE_PLATFORM</p><p>å€¼ä¸ºï¼šmysql</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">- name: SPRING_DATASOURCE_PLATFORM  #æœ€æ–°çš„ç‰ˆæœ¬ä¸€å®šè¦è¿™ä¸ªï¼Œnacoså®˜æ–¹çš„yamlæ¼äº†è¿™ä¸ªï¼ˆ2.2ç‰ˆæœ¬ï¼Œ2.0ç‰ˆæœ¬æ˜¯ä¸éœ€è¦åŠ è¿™ä¸ªï¼‰<br>  value: &quot;mysql&quot;<br></code></pre></td></tr></table></figure><p>é™„2ï¼Œä½¿ç”¨CBSåšæ•°æ®åº“çš„æŒä¹…åŒ–å­˜å‚¨ï¼Œå®ä¾‹yaml: ä»…å‚è€ƒ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">apiVersion: apps/v1<br>kind: StatefulSet<br>metadata:<br>  labels:<br>    k8s-app: nacos-mysql<br>    qcloud-app: nacos-mysql<br>  name: nacos-mysql<br>  namespace: default<br>spec:<br>  podManagementPolicy: OrderedReady<br>  replicas: 1<br>  revisionHistoryLimit: 10<br>  selector:<br>    matchLabels:<br>      k8s-app: nacos-mysql<br>      qcloud-app: nacos-mysql<br>  serviceName: &quot;&quot;<br>  template:<br>    metadata:<br>      annotations:<br>        eks.tke.cloud.tencent.com/retain-ip: &quot;true&quot; #EKSé›†ç¾¤éœ€è¦ï¼ŒTKEé›†ç¾¤ä¸éœ€è¦è¿™ä¸ª<br>        eks.tke.cloud.tencent.com/root-cbs-size: &quot;20&quot;  #EKSé›†ç¾¤éœ€è¦ï¼ŒTKEé›†ç¾¤ä¸éœ€è¦è¿™ä¸ª<br>      labels:<br>        k8s-app: nacos-mysql<br>        qcloud-app: nacos-mysql<br>    spec:<br>      containers:<br>      - env:<br>        - name: MYSQL_ROOT_PASSWORD<br>          value: root<br>        - name: MYSQL_DATABASE<br>          value: nacos<br>        - name: MYSQL_USER<br>          value: nacos<br>        - name: MYSQL_PASSWORD<br>          value: nacos<br>        image: nacos/nacos-mysql:5.7<br>        imagePullPolicy: IfNotPresent<br>        name: nacos-mysql<br>        resources:<br>          limits:<br>            cpu: 500m<br>            memory: 1Gi<br>          requests:<br>            cpu: 250m<br>            memory: 256Mi<br>        securityContext:<br>          privileged: false<br>        volumeMounts:<br>        - mountPath: /var/lib/mysql<br>          name: nacos-mysql<br>          subPath: mysql<br>      dnsPolicy: ClusterFirst<br>      imagePullSecrets:<br>      - name: qcloudregistrykey<br>      restartPolicy: Always<br>  updateStrategy:<br>    rollingUpdate:<br>      partition: 0<br>    type: RollingUpdate<br>  volumeClaimTemplates:<br>  - apiVersion: v1<br>    kind: PersistentVolumeClaim<br>    metadata:<br>      name: nacos-mysql<br>    spec:<br>      accessModes:<br>      - ReadWriteOnce<br>      resources:<br>        requests:<br>          storage: 10Gi<br>      storageClassName: cbs<br>      volumeMode: Filesystem<br><br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> Nacos </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Kubernetesä¸­podæ•°æ®å­˜å‚¨</title>
      <link href="/post/76f3febd.html"/>
      <url>/post/76f3febd.html</url>
      
        <content type="html"><![CDATA[<h2 id="PODå¦‚ä½•ä½¿ç”¨èŠ‚ç‚¹ç£ç›˜"><a href="#PODå¦‚ä½•ä½¿ç”¨èŠ‚ç‚¹ç£ç›˜" class="headerlink" title="PODå¦‚ä½•ä½¿ç”¨èŠ‚ç‚¹ç£ç›˜"></a>PODå¦‚ä½•ä½¿ç”¨èŠ‚ç‚¹ç£ç›˜</h2><p>K8Sä¸­ï¼Œå®¹å™¨containeråœ¨è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œä¼šäº§ç”Ÿä¸€äº›æ—¥å¿—ï¼Œä¸´æ—¶æ–‡ä»¶ï¼Œå¦‚æœæ²¡æœ‰ä»»ä½•é™åˆ¶çš„è¯ï¼Œä¼šå†™æ»¡PODæ‰€åœ¨èŠ‚ç‚¹ç£ç›˜ç©ºé—´ï¼Œä»è€Œä¼šå½±å“å¯¹åº”èŠ‚ç‚¹ å·²ç»èŠ‚ç‚¹ä¸Šå…¶ä»–PODåº”ç”¨ï¼Œ</p><p> å®¹å™¨çš„<strong>ä¸´æ—¶å­˜å‚¨ï¼Œä¾‹å¦‚ emptyDir</strong>ï¼Œä½äºç›®å½•&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods ä¸‹ </p><blockquote><p>é€šè¿‡å¦‚ä¸‹å‘½ä»¤å¯ä»¥æŸ¥è¯¢åˆ°é›†ç¾¤PODæ‰€å¯¹åº”çš„POD_ID</p><p>kubectl get pods -o custom-columns&#x3D;podName:.metadata.name,podIP:.status.podIP,podStatus:.status.phase,nodeIP:.status.hostIP,Pod_ID:.metadata.uid</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-47-tlinux /var/lib/kubelet/pods]# kubectl get pods -o custom-columns=podName:.metadata.name,podIP:.status.podIP,podStatus:.status.phase,nodeIP:.status.hostIP,Pod_ID:.metadata.uid<br>podName                   podIP        podStatus   nodeIP          Pod_ID<br>centos-74cd685986-rcfqk   10.200.0.5   Running     172.30.249.47   9ad30306-f6cd-49eb-a279-cd58201be8c3<br><br>[root@VM-249-47-tlinux /var/lib/kubelet/pods]# <br>[root@VM-249-47-tlinux /var/lib/kubelet/pods]# tree  9ad30306-f6cd-49eb-a279-cd58201be8c3<br>9ad30306-f6cd-49eb-a279-cd58201be8c3   #podçš„ uid<br>â”œâ”€â”€ containers                         # pod é‡Œé¢çš„container å®¹å™¨<br>â”‚   â”œâ”€â”€ busybox                        #å®¹å™¨1<br>â”‚   â”‚   â””â”€â”€ 21efdec2<br>â”‚   â””â”€â”€ centos                         #å®¹å™¨2<br>â”‚       â””â”€â”€ 64bbf490<br>â”œâ”€â”€ etc-hosts                          # å‘½åç©ºé—´çš„Hostæ–‡ä»¶<br>â”œâ”€â”€ plugins<br>â”‚   â””â”€â”€ kubernetes.io~empty-dir<br>â”‚       â”œâ”€â”€ wrapped_cm<br>â”‚       â”‚   â””â”€â”€ ready<br>â”‚       â”œâ”€â”€ wrapped_default-token-7llnd<br>â”‚       â”‚   â””â”€â”€ ready<br>â”‚       â””â”€â”€ wrapped_secret<br>â”‚           â””â”€â”€ ready<br>â””â”€â”€ volumes                                           # Podçš„å·<br>    â”œâ”€â”€ kubernetes.io~configmap                       # ConfigMapç±»å‹çš„å·<br>    â”‚   â””â”€â”€ cm<br>    â”‚       â””â”€â”€ app -&gt; ..data/app<br>    â”œâ”€â”€ kubernetes.io~qcloud-cbs                      #CBSç±»å‹çš„æ•°æ®å·<br>    â”‚   â””â”€â”€ pvc-137607ae-974d-4c25-90dc-efc3c2a6c5a8  #PVåç§°ï¼Œå¯¹åº”PODé‡Œé¢æŒ‚è½½ç‚¹<br>    â”‚       â””â”€â”€ lost+found<br>    â””â”€â”€ kubernetes.io~secret                          #Secretç±»å‹çš„å·<br>        â”œâ”€â”€ default-token-7llnd<br>        â”‚   â”œâ”€â”€ ca.crt -&gt; ..data/ca.crt<br>        â”‚   â”œâ”€â”€ namespace -&gt; ..data/namespace<br>        â”‚   â””â”€â”€ token -&gt; ..data/token<br>        â””â”€â”€ secret<br>            â””â”€â”€ password -&gt; ..data/password<br><br>17 directories, 11 files<br></code></pre></td></tr></table></figure><p><strong>æŒä¹…å·çš„æŒ‚è½½ç‚¹</strong>ä¹Ÿä½äº&#x2F;var&#x2F;lib&#x2F;kubelet&#x2F;pods ä¸‹ï¼Œä½†æ˜¯<strong>ä¸ä¼šå¯¼è‡´å­˜å‚¨ç©ºé—´çš„æ¶ˆè€—</strong>ã€‚</p><p>å®¹å™¨çš„æ—¥å¿—ï¼Œå­˜æ”¾åœ¨&#x2F;var&#x2F;log&#x2F;pods ç›®å½•ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@VM-249-47-tlinux /var/log/pods]# ls -lrt  | grep centos<br>drwxr-xr-x 4 root root 4096 Aug  7 18:23 default_centos-74cd685986-rcfqk_9ad30306-f6cd-49eb-a279-cd58201be8c3<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209031845790.png" alt="1659868302215"></p><blockquote><p>ç›®å½•å‘½åæ–¹å¼æ˜¯ï¼šå‘½åç©ºé—´_PODåç§°_POD-UID</p><p>9ad30306-f6cd-49eb-a279-cd58201be8c3 è¿™ä¸ªæŒ‡çš„å°±æ˜¯PODçš„uid</p></blockquote><p>æ—¥å¿—æ˜¯è½¯é“¾æ¥åˆ°&#x2F;var&#x2F;lib&#x2F;docker&#x2F;containers&#x2F;å®¹å™¨ID&#x2F;å®¹å™¨ID-json.log</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209031846679.png" alt="1659868600279"></p><p> ä½¿ç”¨ Docker æ—¶ï¼Œ<strong>å®¹å™¨çš„ rootfs</strong>ä½äº&#x2F;var&#x2F;lib&#x2F;docker ä¸‹ï¼Œå…·ä½“ä½ç½®å–å†³äºå­˜å‚¨é©±åŠ¨ã€‚ </p>]]></content>
      
      
      <categories>
          
          <category> Kubernetes </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Kubernetes </tag>
            
            <tag> docker </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Mysqlå­¦ä¹ ç¬”è®°-åŸºç¡€</title>
      <link href="/post/6a93064d.html"/>
      <url>/post/6a93064d.html</url>
      
        <content type="html"><![CDATA[<h2 id="MySQLæ¦‚è¿°"><a href="#MySQLæ¦‚è¿°" class="headerlink" title="MySQLæ¦‚è¿°"></a>MySQLæ¦‚è¿°</h2><h3 id="æ•°æ®åº“ç›¸å…³æ¦‚å¿µ"><a href="#æ•°æ®åº“ç›¸å…³æ¦‚å¿µ" class="headerlink" title="æ•°æ®åº“ç›¸å…³æ¦‚å¿µ"></a>æ•°æ®åº“ç›¸å…³æ¦‚å¿µ</h3><p>ä¸‰ä¸ªæ¦‚å¿µï¼šæ•°æ®åº“ã€æ•°æ®åº“ç®¡ç†ç³»ç»Ÿã€SQL  </p><table><thead><tr><th>åç§°</th><th>å…¨ç§°</th><th>ç®€ç§°</th></tr></thead><tbody><tr><td>æ•°æ®åº“</td><td>å­˜å‚¨æ•°æ®çš„ä»“åº“ï¼Œæ•°æ®æ˜¯æœ‰ç»„ç»‡çš„è¿›è¡Œå­˜å‚¨</td><td>DataBaseï¼ˆDBï¼‰</td></tr><tr><td>æ•°æ®åº“ç®¡ç†ç³»ç»Ÿ</td><td>æ“çºµå’Œç®¡ç†æ•°æ®åº“çš„å¤§å‹è½¯ä»¶</td><td>DataBase Management System (DBMS)</td></tr><tr><td>SQL</td><td>æ“ä½œå…³ç³»å‹æ•°æ®åº“çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®šä¹‰äº†ä¸€å¥—æ“ä½œ å…³ç³»å‹æ•°æ®åº“ç»Ÿä¸€æ ‡å‡†</td><td>Structured Query Language (SQL)</td></tr></tbody></table><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221549659.png" alt="image-20230322154924573"></p><h3 id="MySQLæ•°æ®åº“"><a href="#MySQLæ•°æ®åº“" class="headerlink" title="MySQLæ•°æ®åº“"></a>MySQLæ•°æ®åº“</h3><h4 id="ç‰ˆæœ¬"><a href="#ç‰ˆæœ¬" class="headerlink" title="ç‰ˆæœ¬"></a>ç‰ˆæœ¬</h4><ul><li>ç¤¾åŒºç‰ˆæœ¬</li><li>å•†ä¸šç‰ˆæœ¬</li></ul><h4 id="ä¸‹è½½"><a href="#ä¸‹è½½" class="headerlink" title="ä¸‹è½½"></a>ä¸‹è½½</h4><p><a href="https://dev.mysql.com/downloads/repo/yum/">ä¸‹è½½åœ°å€</a></p><h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p>å‚è€ƒå¦å¤–ä¸€ç¯‡æ–‡æ¡£  <a href="https://blog.chen1900s.cn/post/3b301983.html">Linuxå®‰è£…mysqlæ•°æ®åº“</a></p><h4 id="å¯åŠ¨å’Œåœæ­¢"><a href="#å¯åŠ¨å’Œåœæ­¢" class="headerlink" title="å¯åŠ¨å’Œåœæ­¢"></a>å¯åŠ¨å’Œåœæ­¢</h4><p><strong>windowsç‰ˆæœ¬</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#å¯åŠ¨<br>net start mysql80<br>#åœæ­¢<br>net stop   mysql80<br></code></pre></td></tr></table></figure><p><strong>Linuxç‰ˆæœ¬</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#å¯åŠ¨<br>systemctl start mysqld<br>#é‡å¯<br>systemctl restart mysqld<br>#åœæ­¢<br>systemctl stop mysqld<br><br></code></pre></td></tr></table></figure><h4 id="å®¢æˆ·ç«¯é“¾æ¥"><a href="#å®¢æˆ·ç«¯é“¾æ¥" class="headerlink" title="å®¢æˆ·ç«¯é“¾æ¥"></a>å®¢æˆ·ç«¯é“¾æ¥</h4><p>1ï¼Œå‘½ä»¤è¡Œå®¢æˆ·ç«¯</p><p>2ï¼Œdatagripå·¥å…·</p><p>3ï¼ŒNavicat</p><h4 id="æ•°æ®æ¨¡å‹"><a href="#æ•°æ®æ¨¡å‹" class="headerlink" title="æ•°æ®æ¨¡å‹"></a>æ•°æ®æ¨¡å‹</h4><p>1). å…³ç³»å‹æ•°æ®åº“ï¼ˆRDBMSï¼‰<br>æ¦‚å¿µï¼šå»ºç«‹åœ¨å…³ç³»æ¨¡å‹åŸºç¡€ä¸Šï¼Œç”±å¤šå¼ ç›¸äº’è¿æ¥çš„äºŒç»´è¡¨ç»„æˆçš„æ•°æ®åº“ã€‚è€Œæ‰€è°“äºŒç»´è¡¨ï¼ŒæŒ‡çš„æ˜¯ç”±è¡Œå’Œåˆ—ç»„æˆçš„è¡¨ï¼Œå¦‚ä¸‹å›¾ï¼ˆå°±ç±»ä¼¼äºExcelè¡¨æ ¼æ•°æ®ï¼Œæœ‰è¡¨å¤´ã€æœ‰åˆ—ã€æœ‰è¡Œï¼Œè¿˜å¯ä»¥é€šè¿‡ä¸€åˆ—å…³è”å¦å¤–ä¸€ä¸ªè¡¨æ ¼ä¸­çš„æŸä¸€åˆ—æ•°æ®ï¼‰ã€‚æˆ‘ä»¬ä¹‹å‰æåˆ°çš„MySQLã€Oracleã€DB2ã€SQLServerè¿™äº›éƒ½æ˜¯å±äºå…³ç³»å‹æ•°æ®åº“ï¼Œé‡Œé¢éƒ½æ˜¯åŸºäºäºŒç»´è¡¨å­˜å‚¨æ•°æ®çš„ã€‚ç®€å•è¯´ï¼ŒåŸºäºäºŒç»´è¡¨å­˜å‚¨æ•°æ®çš„æ•°æ®åº“å°±æˆä¸ºå…³ç³»å‹æ•°æ®åº“ï¼Œä¸æ˜¯åŸºäºäºŒç»´è¡¨å­˜å‚¨æ•°æ®çš„æ•°æ®åº“ï¼Œå°±æ˜¯éå…³ç³»å‹æ•°æ®åº“ã€‚  </p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221616225.png" alt="image-20230322161647158"></p><p>ç‰¹ç‚¹ï¼š<br>A. ä½¿ç”¨è¡¨å­˜å‚¨æ•°æ®ï¼Œæ ¼å¼ç»Ÿä¸€ï¼Œä¾¿äºç»´æŠ¤ã€‚<br>B. ä½¿ç”¨SQLè¯­è¨€æ“ä½œï¼Œæ ‡å‡†ç»Ÿä¸€ï¼Œä½¿ç”¨æ–¹ä¾¿ã€‚<br>2). æ•°æ®æ¨¡å‹<br>MySQLæ˜¯å…³ç³»å‹æ•°æ®åº“ï¼Œæ˜¯åŸºäºäºŒç»´è¡¨è¿›è¡Œæ•°æ®å­˜å‚¨çš„ï¼Œå…·ä½“çš„ç»“æ„å›¾ä¸‹:  </p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221617244.png" alt="image-20230322161737097"></p><h3 id="SQLè¯­å¥"><a href="#SQLè¯­å¥" class="headerlink" title="SQLè¯­å¥"></a>SQLè¯­å¥</h3><p>å…¨ç§° Structured Query Languageï¼Œç»“æ„åŒ–æŸ¥è¯¢è¯­è¨€ã€‚æ“ä½œå…³ç³»å‹æ•°æ®åº“çš„ç¼–ç¨‹è¯­è¨€ï¼Œå®šä¹‰äº†ä¸€å¥—æ“ä½œå…³ç³»å‹æ•°æ®åº“ç»Ÿä¸€æ ‡å‡† ã€‚  </p><h4 id="SQLé€šç”¨è¯­æ³•"><a href="#SQLé€šç”¨è¯­æ³•" class="headerlink" title="SQLé€šç”¨è¯­æ³•"></a>SQLé€šç”¨è¯­æ³•</h4><ol><li>SQLè¯­å¥å¯ä»¥å•è¡Œæˆ–å¤šè¡Œä¹¦å†™ï¼Œä»¥åˆ†å·ç»“å°¾ã€‚</li><li>SQLè¯­å¥å¯ä»¥ä½¿ç”¨ç©ºæ ¼&#x2F;ç¼©è¿›æ¥å¢å¼ºè¯­å¥çš„å¯è¯»æ€§ã€‚</li><li>MySQLæ•°æ®åº“çš„SQLè¯­å¥ä¸åŒºåˆ†å¤§å°å†™ï¼Œå…³é”®å­—å»ºè®®ä½¿ç”¨å¤§å†™ã€‚</li><li>æ³¨é‡Šï¼š</li></ol><p>â€‹å•è¡Œæ³¨é‡Šï¼šâ€“ æ³¨é‡Šå†…å®¹ æˆ– # æ³¨é‡Šå†…å®¹<br>â€‹å¤šè¡Œæ³¨é‡Šï¼š&#x2F;* æ³¨é‡Šå†…å®¹ *&#x2F;  </p><h4 id="SQLè¯­å¥åˆ†ç±»"><a href="#SQLè¯­å¥åˆ†ç±»" class="headerlink" title="SQLè¯­å¥åˆ†ç±»"></a>SQLè¯­å¥åˆ†ç±»</h4><p>SQLè¯­å¥ï¼Œæ ¹æ®å…¶åŠŸèƒ½ï¼Œä¸»è¦åˆ†ä¸ºå››ç±»ï¼šDDLã€DMLã€DQLã€DCLã€‚  </p><table><thead><tr><th>åˆ† ç±»</th><th>å…¨ç§°</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>DDL</td><td>Data Definition Language</td><td>æ•°æ®å®šä¹‰è¯­è¨€ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡(æ•°æ®åº“ï¼Œè¡¨ï¼Œ å­—æ®µ)</td></tr><tr><td>DML</td><td>Data Manipulation Language</td><td>æ•°æ®æ“ä½œè¯­è¨€ï¼Œç”¨æ¥å¯¹æ•°æ®åº“è¡¨ä¸­çš„æ•°æ®è¿›è¡Œå¢åˆ æ”¹</td></tr><tr><td>DQL</td><td>Data Query Language</td><td>æ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•</td></tr><tr><td>DCL</td><td>Data Control Language</td><td>æ•°æ®æ§åˆ¶è¯­è¨€ï¼Œç”¨æ¥åˆ›å»ºæ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„ è®¿é—®æƒé™</td></tr></tbody></table><h4 id="DDLè¯­å¥"><a href="#DDLè¯­å¥" class="headerlink" title="DDLè¯­å¥"></a>DDLè¯­å¥</h4><p>æ•°æ®å®šä¹‰è¯­è¨€ï¼Œç”¨æ¥å®šä¹‰æ•°æ®åº“å¯¹è±¡(æ•°æ®åº“ï¼Œè¡¨ï¼Œ å­—æ®µ)</p><h5 id="DDL-æ•°æ®åº“æ“ä½œ"><a href="#DDL-æ•°æ®åº“æ“ä½œ" class="headerlink" title="DDL-æ•°æ®åº“æ“ä½œ"></a>DDL-æ•°æ®åº“æ“ä½œ</h5><p><strong>æŸ¥è¯¢</strong></p><p>â€‹æŸ¥è¯¢æ‰€æœ‰æ•°æ®åº“</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> databases;<br></code></pre></td></tr></table></figure><p>â€‹æŸ¥è¯¢å½“å‰æ•°æ®åº“</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> database();<br></code></pre></td></tr></table></figure><p><strong>åˆ›å»º</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> database [ if <span class="hljs-keyword">not</span> <span class="hljs-keyword">exists</span> ] æ•°æ®åº“å [ <span class="hljs-keyword">default</span> charset å­—ç¬¦é›† ] [ <span class="hljs-keyword">collate</span> æ’åºè§„åˆ™ ] ;<br><br><span class="hljs-keyword">create</span> database itcast;<br>#æ˜¯å¦å­˜åœ¨ï¼Œä¸å­˜åœ¨åˆ›å»º<br><span class="hljs-keyword">create</span> database if <span class="hljs-keyword">not</span> <span class="hljs-keyword">exists</span> itcast;<br>#æŒ‡çš„å­—ç¬¦é›†<br><span class="hljs-keyword">create</span> database itheima  <span class="hljs-keyword">default</span> charset utf8mb4;<br></code></pre></td></tr></table></figure><p><strong>åˆ é™¤</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span> database itcast;<br><br><span class="hljs-keyword">drop</span> database if <span class="hljs-keyword">exists</span> itheima;<br></code></pre></td></tr></table></figure><p><strong>ä½¿ç”¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">use  æ•°æ®åº“å;<br></code></pre></td></tr></table></figure><h5 id="DDL-è¡¨æ“ä½œ-æŸ¥è¯¢"><a href="#DDL-è¡¨æ“ä½œ-æŸ¥è¯¢" class="headerlink" title="DDL-è¡¨æ“ä½œ-æŸ¥è¯¢"></a>DDL-è¡¨æ“ä½œ-æŸ¥è¯¢</h5><p><strong>æŸ¥è¯¢å½“å‰æ•°æ®åº“æ‰€æœ‰è¡¨</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">show</span> tables;<br></code></pre></td></tr></table></figure><p><strong>æŸ¥è¯¢è¡¨ç»“æ„</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">DESC è¡¨å;<br></code></pre></td></tr></table></figure><p><strong>æŸ¥è¯¢æŒ‡å®šè¡¨çš„å»ºè¡¨è¯­å¥</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">show create tables è¡¨å;<br></code></pre></td></tr></table></figure><h5 id="DDL-è¡¨æ“ä½œ-åˆ›å»º"><a href="#DDL-è¡¨æ“ä½œ-åˆ›å»º" class="headerlink" title="DDL-è¡¨æ“ä½œ-åˆ›å»º"></a>DDL-è¡¨æ“ä½œ-åˆ›å»º</h5><p><strong>è¡¨ç»“æ„</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> è¡¨å(<br>å­—æ®µ<span class="hljs-number">1</span> å­—æ®µ<span class="hljs-number">1</span>ç±»å‹ [ COMMENT å­—æ®µ<span class="hljs-number">1</span>æ³¨é‡Š ],<br>å­—æ®µ<span class="hljs-number">2</span> å­—æ®µ<span class="hljs-number">2</span>ç±»å‹ [COMMENT å­—æ®µ<span class="hljs-number">2</span>æ³¨é‡Š ],<br>å­—æ®µ<span class="hljs-number">3</span> å­—æ®µ<span class="hljs-number">3</span>ç±»å‹ [COMMENT å­—æ®µ<span class="hljs-number">3</span>æ³¨é‡Š ],<br>......<br>å­—æ®µn å­—æ®µnç±»å‹ [COMMENT å­—æ®µnæ³¨é‡Š ]<br>) [ COMMENT è¡¨æ³¨é‡Š ] ;<br></code></pre></td></tr></table></figure><p><strong>åˆ›å»ºä¸€ä¸ªç”¨æˆ·è¡¨</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_user(<br>name  <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>age <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>gender <span class="hljs-type">varchar</span>(<span class="hljs-number">1</span>) comment <span class="hljs-string">&#x27;æ€§åˆ«&#x27;</span><br>) comment <span class="hljs-string">&#x27;ç”¨æˆ·è¡¨&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221702366.png" alt="image-20230322170232270"></p><h5 id="DDL-è¡¨æ“ä½œ-æ•°æ®ç±»å‹"><a href="#DDL-è¡¨æ“ä½œ-æ•°æ®ç±»å‹" class="headerlink" title="DDL-è¡¨æ“ä½œ-æ•°æ®ç±»å‹"></a>DDL-è¡¨æ“ä½œ-æ•°æ®ç±»å‹</h5><p><strong>æ•°å€¼ç±»å‹</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221710864.png" alt="image-20230322171000776"></p><p><strong>å­—ç¬¦ä¸²ç±»å‹</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221716857.png" alt="image-20230322171602773"></p><p><strong>æ—¥æœŸæ—¶é—´ç±»å‹</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221719208.png" alt="image-20230322171928123"></p><p><strong>æ¡ˆä¾‹ä¸€</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> emp(<br>id <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;ç¼–å·&#x27;</span>,<br>workno <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>)  comment <span class="hljs-string">&#x27;å·¥å·&#x27;</span>,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>gender  <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) comment <span class="hljs-string">&#x27;æ€§åˆ«&#x27;</span>,<br>age   tinyint unsigned comment <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>idcard  <span class="hljs-type">char</span>(<span class="hljs-number">18</span>) comment <span class="hljs-string">&#x27;èº«ä»½è¯å·&#x27;</span>,<br>entrydate  <span class="hljs-type">date</span> comment <span class="hljs-string">&#x27;å…¥èŒæ—¶é—´&#x27;</span><br>)  comment <span class="hljs-string">&#x27;å‘˜å·¥è¡¨&#x27;</span>;<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221736219.png" alt="image-20230322173607082"></p><h5 id="DDL-è¡¨æ“ä½œ-ä¿®æ”¹"><a href="#DDL-è¡¨æ“ä½œ-ä¿®æ”¹" class="headerlink" title="DDL-è¡¨æ“ä½œ-ä¿®æ”¹"></a>DDL-è¡¨æ“ä½œ-ä¿®æ”¹</h5><p><strong>æ·»åŠ å­—æ®µ</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span>  è¡¨å <span class="hljs-keyword">ADD</span> å­—æ®µå ç±»å‹ï¼ˆé•¿åº¦ï¼‰ [comment æ³¨é‡Š] [çº¦æŸ];<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">#ç¤ºä¾‹<br><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp <span class="hljs-keyword">add</span>  nickname <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) comment <span class="hljs-string">&#x27;æ˜µç§°&#x27;</span>;<br></code></pre></td></tr></table></figure><p><strong>ä¿®æ”¹æ•°æ®ç±»å‹</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å MODIFY å­—æ®µå æ–°æ•°æ®ç±»å‹ (é•¿åº¦);<br></code></pre></td></tr></table></figure><p><strong>ä¿®æ”¹å­—æ®µåå’Œå­—æ®µç±»å‹</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å CHANGE æ—§å­—æ®µå æ–°å­—æ®µå ç±»å‹ (é•¿åº¦) [ COMMENT æ³¨é‡Š ] [ çº¦æŸ ];<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">alter table emp  change nickname username  varchar(30) comment &#x27;ç”¨æˆ·å&#x27;;<br></code></pre></td></tr></table></figure><p><strong>åˆ é™¤å­—æ®µ</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ALTER TABLE è¡¨å DROP å­—æ®µå;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp <span class="hljs-keyword">drop</span> username;<br></code></pre></td></tr></table></figure><p><strong>ä¿®æ”¹è¡¨å</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ALTER TABLE è¡¨å RENAME TO æ–°è¡¨å;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp rename <span class="hljs-keyword">to</span> employee;<br></code></pre></td></tr></table></figure><h5 id="DDL-è¡¨æ“ä½œ-åˆ é™¤"><a href="#DDL-è¡¨æ“ä½œ-åˆ é™¤" class="headerlink" title="DDL-è¡¨æ“ä½œ-åˆ é™¤"></a>DDL-è¡¨æ“ä½œ-åˆ é™¤</h5><p><strong>åˆ é™¤è¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">DROP TABLE [ IF EXISTS ] è¡¨å;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span> <span class="hljs-keyword">table</span> if <span class="hljs-keyword">exists</span> tb_user;<br></code></pre></td></tr></table></figure><p><strong>åˆ é™¤æŒ‡å®šè¡¨ï¼Œå¹¶é‡æ–°åˆ›å»ºæ–°è¡¨</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">TRUNCATE TABLE è¡¨å;<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">truncate table employee;<br></code></pre></td></tr></table></figure><h4 id="DMLè¯­å¥"><a href="#DMLè¯­å¥" class="headerlink" title="DMLè¯­å¥"></a>DMLè¯­å¥</h4><p>DMLè‹±æ–‡å…¨ç§°æ˜¯Data Manipulation Language(æ•°æ®æ“ä½œè¯­è¨€)ï¼Œç”¨æ¥å¯¹æ•°æ®åº“ä¸­è¡¨çš„æ•°æ®è®°å½•è¿›è¡Œå¢ã€åˆ ã€æ”¹æ“ä½œã€‚</p><ul><li>æ·»åŠ æ•°æ®ï¼ˆINSERTï¼‰</li><li>ä¿®æ”¹æ•°æ®ï¼ˆUPDATEï¼‰</li><li>åˆ é™¤æ•°æ®ï¼ˆDELETEï¼‰</li></ul><h5 id="DML-æ·»åŠ æ•°æ®"><a href="#DML-æ·»åŠ æ•°æ®" class="headerlink" title="DML-æ·»åŠ æ•°æ®"></a>DML-æ·»åŠ æ•°æ®</h5><p><strong>ç»™æŒ‡å®šå­—æ®µæ·»åŠ æ•°æ®</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">INSERT INTO è¡¨å (å­—æ®µå1, å­—æ®µå2, ...) VALUES (å€¼1, å€¼2, ...);  <br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> employee(id, workno, name, gender, age, idcard, entrydate) <span class="hljs-keyword">values</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;ITcast&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;123456781234567891&#x27;</span>,<span class="hljs-string">&#x27;2000-01-01&#x27;</span>);<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303221826758.png" alt="image-20230322182655632"></p><p><strong>ç»™å…¨éƒ¨å­—æ®µæ·»åŠ æ•°æ®</strong>  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> è¡¨å <span class="hljs-keyword">VALUES</span> (å€¼<span class="hljs-number">1</span>, å€¼<span class="hljs-number">2</span>, ...);<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> employee <span class="hljs-keyword">values</span> (<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;å¼ æ— å¿Œ&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-string">&#x27;123456781234567891&#x27;</span>,<span class="hljs-string">&#x27;2005-01-02&#x27;</span>);<br></code></pre></td></tr></table></figure><p><strong>æ‰¹é‡æ·»åŠ æ•°æ®</strong>  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">INSERT INTO è¡¨å (å­—æ®µå1, å­—æ®µå2, ...) VALUES (å€¼1, å€¼2, ...), (å€¼1, å€¼2, ...), (å€¼1, å€¼2, ...) ;<br><br>INSERT INTO è¡¨å VALUES (å€¼1, å€¼2, ...), (å€¼1, å€¼2, ...), (å€¼1, å€¼2, ...) ;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> employee <span class="hljs-keyword">values</span> (<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;éŸ¦ä¸€ç¬‘&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">38</span>,<span class="hljs-string">&#x27;123456781234567821&#x27;</span>,<span class="hljs-string">&#x27;2005-02-02&#x27;</span>),(<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;æ•&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">18</span>,<span class="hljs-string">&#x27;123456781234567331&#x27;</span>,<span class="hljs-string">&#x27;2023-01-02&#x27;</span>);<br></code></pre></td></tr></table></figure><h5 id="DML-ä¿®æ”¹æ•°æ®"><a href="#DML-ä¿®æ”¹æ•°æ®" class="headerlink" title="DML-ä¿®æ”¹æ•°æ®"></a>DML-ä¿®æ”¹æ•°æ®</h5><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">UPDATE</span> è¡¨å <span class="hljs-keyword">SET</span> å­—æ®µå<span class="hljs-number">1</span> <span class="hljs-operator">=</span> å€¼<span class="hljs-number">1</span> , å­—æ®µå<span class="hljs-number">2</span> <span class="hljs-operator">=</span> å€¼<span class="hljs-number">2</span> , .... [ <span class="hljs-keyword">WHERE</span> æ¡ä»¶ ] ;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> employee <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;itheima&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">#ä¿®æ”¹å¤šä¸ªå­—æ®µä¹‹é—´ç”¨é€—å· éš”å¼€<br><br><span class="hljs-keyword">update</span> employee <span class="hljs-keyword">set</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å°æ˜­&#x27;</span>,gender <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¥³&#x27;</span> <span class="hljs-keyword">where</span> id <span class="hljs-operator">=</span><span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure><p>å°†æ‰€æœ‰å‘˜å·¥å…¥èŒæ—¶é—´ä¿®æ”¹ä¸º 2008-01-01</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> employee <span class="hljs-keyword">set</span> entrydate <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;2008-01-01&#x27;</span>;<br></code></pre></td></tr></table></figure><h5 id="DDL-åˆ é™¤æ•°æ®"><a href="#DDL-åˆ é™¤æ•°æ®" class="headerlink" title="DDL-åˆ é™¤æ•°æ®"></a>DDL-åˆ é™¤æ•°æ®</h5><p>è¯­æ³•</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DELETE</span> <span class="hljs-keyword">FROM</span> è¡¨å [ <span class="hljs-keyword">WHERE</span> æ¡ä»¶ ] ;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„äº‹é¡¹:<br>â€¢ DELETE è¯­å¥çš„æ¡ä»¶å¯ä»¥æœ‰ï¼Œä¹Ÿå¯ä»¥æ²¡æœ‰ï¼Œå¦‚æœæ²¡æœ‰æ¡ä»¶ï¼Œåˆ™ä¼šåˆ é™¤æ•´å¼ è¡¨çš„æ‰€æœ‰æ•°æ®ã€‚<br>â€¢ DELETE è¯­å¥ä¸èƒ½åˆ é™¤æŸä¸€ä¸ªå­—æ®µçš„å€¼(å¯ä»¥ä½¿ç”¨UPDATEï¼Œå°†è¯¥å­—æ®µå€¼ç½®ä¸ºNULLå³å¯)ã€‚<br>â€¢ å½“è¿›è¡Œåˆ é™¤å…¨éƒ¨æ•°æ®æ“ä½œæ—¶ï¼Œdatagripä¼šæç¤ºæˆ‘ä»¬ï¼Œè¯¢é—®æ˜¯å¦ç¡®è®¤åˆ é™¤ï¼Œæˆ‘ä»¬ç›´æ¥ç‚¹å‡»Executeå³å¯  </p></blockquote><p>åˆ é™¤gender ä¸ºå¥³çš„å‘˜å·¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> employee <span class="hljs-keyword">where</span> gender <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¥³&#x27;</span>;<br></code></pre></td></tr></table></figure><p>åˆ é™¤æ‰€æœ‰å‘˜å·¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">delete</span> <span class="hljs-keyword">from</span> employee;<br></code></pre></td></tr></table></figure><h4 id="DQLè¯­å¥"><a href="#DQLè¯­å¥" class="headerlink" title="DQLè¯­å¥"></a>DQLè¯­å¥</h4><p>DQLè‹±æ–‡å…¨ç§°æ˜¯Data Query Language(æ•°æ®æŸ¥è¯¢è¯­è¨€)ï¼Œæ•°æ®æŸ¥è¯¢è¯­è¨€ï¼Œç”¨æ¥æŸ¥è¯¢æ•°æ®åº“ä¸­è¡¨çš„è®°å½•ã€‚</p><p>æŸ¥è¯¢å…³é”®å­—: SELECT  </p><p>DQL-è¯­æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs sqlite">SELECT<br>å­—æ®µåˆ—è¡¨<br>FROM<br>è¡¨ååˆ—è¡¨<br>WHERE<br>æ¡ä»¶åˆ—è¡¨<br>GROUP BY<br>åˆ†ç»„å­—æ®µåˆ—è¡¨<br>HAVING<br>åˆ†ç»„åæ¡ä»¶åˆ—è¡¨<br>ORDER BY<br>æ’åºå­—æ®µåˆ—è¡¨<br>LIMIT<br>åˆ†é¡µå‚æ•°<br></code></pre></td></tr></table></figure><p>æ•°æ®å‡†å¤‡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> emp(<br>    id       <span class="hljs-type">int</span>           comment <span class="hljs-string">&#x27;ç¼–å·&#x27;</span>,<br>    workno   <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>)   comment <span class="hljs-string">&#x27;å·¥å·&#x27;</span>,<br>    name     <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>)   comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>    gender   <span class="hljs-type">char</span>(<span class="hljs-number">1</span>)       comment <span class="hljs-string">&#x27;æ€§åˆ«&#x27;</span>,<br>    age      tinyint unsigned  comment <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>    idcard   <span class="hljs-type">char</span>(<span class="hljs-number">18</span>)      comment <span class="hljs-string">&#x27;èº«ä»½è¯å·&#x27;</span>,<br>    workaddress <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>)  comment <span class="hljs-string">&#x27;å·¥ä½œåœ°å€&#x27;</span>,<br>    entrydata    <span class="hljs-type">date</span>        comment <span class="hljs-string">&#x27;å…¥èŒæ—¶é—´&#x27;</span><br>) comment  <span class="hljs-string">&#x27;å‘˜å·¥è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> emp (id, workno, name, gender, age, idcard, workaddress, entrydata)<br><span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;æŸ³å²©&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">20</span>, <span class="hljs-string">&#x27;123456781234567891&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2000-01-01&#x27;</span>),<br>       (<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;å¼ æ— å¿Œ&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">18</span>, <span class="hljs-string">&#x27;123456781234567892&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2000-09-01&#x27;</span>),<br>       (<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;3&#x27;</span>,<span class="hljs-string">&#x27;éŸ¦ä¸€ç¬‘&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">38</span>, <span class="hljs-string">&#x27;123456781234567893&#x27;</span>,<span class="hljs-string">&#x27;ä¸Šæµ·&#x27;</span>,<span class="hljs-string">&#x27;2000-08-01&#x27;</span>),<br>       (<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;4&#x27;</span>,<span class="hljs-string">&#x27;èµµæ•&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">18</span>, <span class="hljs-string">&#x27;123456781234567894&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2000-01-01&#x27;</span>),<br>       (<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;5&#x27;</span>,<span class="hljs-string">&#x27;å°æ˜­&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">16</span>, <span class="hljs-string">&#x27;123456781234567895&#x27;</span>,<span class="hljs-string">&#x27;ä¸Šæµ·&#x27;</span>,<span class="hljs-string">&#x27;2000-07-01&#x27;</span>),<br>       (<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;6&#x27;</span>,<span class="hljs-string">&#x27;æ¨é€&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">28</span>, <span class="hljs-string">&#x27;12345678123456789X&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2000-01-01&#x27;</span>),<br>       (<span class="hljs-number">7</span>,<span class="hljs-string">&#x27;7&#x27;</span>,<span class="hljs-string">&#x27;èŒƒç‘¶&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">40</span>, <span class="hljs-string">&#x27;123456781234567897&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2000-05-01&#x27;</span>);<br><br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> emp (id, workno, name, gender, age, idcard, workaddress, entrydata)<br><span class="hljs-keyword">VALUES</span> (<span class="hljs-number">8</span>,<span class="hljs-string">&#x27;8&#x27;</span>,<span class="hljs-string">&#x27;é»›ç»®ä¸&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">38</span>, <span class="hljs-string">&#x27;123456781234567898&#x27;</span>,<span class="hljs-string">&#x27;å¤©æ´¥&#x27;</span>,<span class="hljs-string">&#x27;2015-05-01&#x27;</span>),<br>       (<span class="hljs-number">9</span>,<span class="hljs-string">&#x27;9&#x27;</span>,<span class="hljs-string">&#x27;èŒƒå‡‰å‡‰&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">45</span>, <span class="hljs-string">&#x27;123456781234567899&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2010-04-01&#x27;</span>),<br>       (<span class="hljs-number">10</span>,<span class="hljs-string">&#x27;10&#x27;</span>,<span class="hljs-string">&#x27;é™ˆå‹è°…&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">53</span>, <span class="hljs-string">&#x27;123456781234567810&#x27;</span>,<span class="hljs-string">&#x27;ä¸Šæµ·&#x27;</span>,<span class="hljs-string">&#x27;2011-01-01&#x27;</span>),<br>       (<span class="hljs-number">11</span>,<span class="hljs-string">&#x27;11&#x27;</span>,<span class="hljs-string">&#x27;å¼ å£«è¯š&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">55</span>, <span class="hljs-string">&#x27;123456781234567811&#x27;</span>,<span class="hljs-string">&#x27;æ±Ÿè‹&#x27;</span>,<span class="hljs-string">&#x27;2015-05-01&#x27;</span>),<br>       (<span class="hljs-number">12</span>,<span class="hljs-string">&#x27;12&#x27;</span>,<span class="hljs-string">&#x27;å¸¸é‡æ˜¥&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">32</span>, <span class="hljs-string">&#x27;123456781234567812&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2004-02-01&#x27;</span>),<br>       (<span class="hljs-number">13</span>,<span class="hljs-string">&#x27;13&#x27;</span>,<span class="hljs-string">&#x27;å¼ ä¸‰ä¸°&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">88</span>, <span class="hljs-string">&#x27;123456781234567813&#x27;</span>,<span class="hljs-string">&#x27;æ±Ÿè‹&#x27;</span>,<span class="hljs-string">&#x27;2020-01-01&#x27;</span>),<br>       (<span class="hljs-number">14</span>,<span class="hljs-string">&#x27;14&#x27;</span>,<span class="hljs-string">&#x27;ç­ç»&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">65</span>, <span class="hljs-string">&#x27;123456781234567814&#x27;</span>,<span class="hljs-string">&#x27;è¥¿å®‰&#x27;</span>,<span class="hljs-string">&#x27;2019-05-01&#x27;</span>),<br>       (<span class="hljs-number">15</span>,<span class="hljs-string">&#x27;15&#x27;</span>,<span class="hljs-string">&#x27;èƒ¡é’ç‰›&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>,<span class="hljs-number">70</span>, <span class="hljs-string">&#x27;12345678123456781X&#x27;</span>,<span class="hljs-string">&#x27;è¥¿å®‰&#x27;</span>,<span class="hljs-string">&#x27;2019-05-01&#x27;</span>),<br>       (<span class="hljs-number">16</span>,<span class="hljs-string">&#x27;16&#x27;</span>,<span class="hljs-string">&#x27;å‘¨èŠ·è‹¥&#x27;</span>,<span class="hljs-string">&#x27;å¥³&#x27;</span>,<span class="hljs-number">18</span>, <span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span>,<span class="hljs-string">&#x27;2012-05-01&#x27;</span>);<br></code></pre></td></tr></table></figure><h5 id="DQL-åŸºæœ¬æŸ¥è¯¢"><a href="#DQL-åŸºæœ¬æŸ¥è¯¢" class="headerlink" title="DQL-åŸºæœ¬æŸ¥è¯¢"></a>DQL-åŸºæœ¬æŸ¥è¯¢</h5><p>åœ¨åŸºæœ¬æŸ¥è¯¢çš„DQLè¯­å¥ä¸­ï¼Œä¸å¸¦ä»»ä½•çš„æŸ¥è¯¢æ¡ä»¶ï¼ŒæŸ¥è¯¢çš„è¯­æ³•å¦‚ä¸‹ï¼š  </p><p><strong>æŸ¥è¯¢å¤šä¸ªå­—æ®µ</strong>  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µ<span class="hljs-number">1</span>, å­—æ®µ<span class="hljs-number">2</span>, å­—æ®µ<span class="hljs-number">3</span> ... <span class="hljs-keyword">FROM</span> è¡¨å ;<br><br><span class="hljs-keyword">SELECT</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">FROM</span> è¡¨å ;<br></code></pre></td></tr></table></figure><p>1ï¼ŒæŸ¥è¯¢æŒ‡çš„å­—æ®µnameï¼Œworknoï¼Œageè¿”å›</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> name,workno,age <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p>2ï¼ŒæŸ¥è¯¢è¿”å›æ‰€æœ‰å­—æ®µ</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id,workno,name,gender,age,idcard,workaddress,entrydata <span class="hljs-keyword">from</span> emp;<br><br><span class="hljs-keyword">select</span>  <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p><strong>è®¾ç½®åˆ«å</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µ<span class="hljs-number">1</span> [ <span class="hljs-keyword">AS</span> åˆ«å<span class="hljs-number">1</span> ] , å­—æ®µ<span class="hljs-number">2</span> [ <span class="hljs-keyword">AS</span> åˆ«å<span class="hljs-number">2</span> ] ... <span class="hljs-keyword">FROM</span> è¡¨å;<br><span class="hljs-keyword">SELECT</span> å­—æ®µ<span class="hljs-number">1</span> [ åˆ«å<span class="hljs-number">1</span> ] , å­—æ®µ<span class="hljs-number">2</span> [ åˆ«å<span class="hljs-number">2</span> ] ... <span class="hljs-keyword">FROM</span> è¡¨å;<br></code></pre></td></tr></table></figure><p>3ï¼ŒæŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å·¥ä½œåœ°å€ï¼Œèµ·åˆ«å</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> workaddress <span class="hljs-keyword">as</span> <span class="hljs-string">&#x27;å·¥ä½œåœ°å€&#x27;</span> <span class="hljs-keyword">from</span> emp;   #<span class="hljs-keyword">as</span>å¯ä»¥çœç•¥<br></code></pre></td></tr></table></figure><p><strong>å»é™¤é‡å¤è®°å½•</strong> </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SELECT DISTINCT å­—æ®µåˆ—è¡¨ FROM è¡¨å<br></code></pre></td></tr></table></figure><p>4ï¼ŒæŸ¥è¯¢å…¬å¸å‘˜å·¥çš„ä¸Šç­åœ°å€ ä¸è¦é‡å¤</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-keyword">distinct</span> workaddress  <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><h5 id="DQL-æ¡ä»¶æŸ¥è¯¢"><a href="#DQL-æ¡ä»¶æŸ¥è¯¢" class="headerlink" title="DQL-æ¡ä»¶æŸ¥è¯¢"></a>DQL-æ¡ä»¶æŸ¥è¯¢</h5><p>è¯­æ³•</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨å <span class="hljs-keyword">WHERE</span> æ¡ä»¶åˆ—è¡¨ ;<br></code></pre></td></tr></table></figure><p>å¸¸ç”¨çš„æ¯”è¾ƒè¿ç®—ç¬¦å¦‚ä¸‹:  </p><table><thead><tr><th>æ¯”è¾ƒè¿ç®—ç¬¦</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>&gt;</td><td>å¤§äº</td></tr><tr><td>&gt;&#x3D;</td><td>å¤§äºç­‰äº</td></tr><tr><td>&lt;</td><td>å°äº</td></tr><tr><td>&lt;&#x3D;</td><td>å°äºç­‰äº</td></tr><tr><td>&#x3D;</td><td>ç­‰äº</td></tr><tr><td>&lt;&gt; æˆ– !&#x3D;</td><td>ä¸ç­‰äº</td></tr><tr><td>BETWEEN â€¦ AND â€¦</td><td>åœ¨æŸä¸ªèŒƒå›´ä¹‹å†…(</td></tr><tr><td>IN(â€¦)</td><td>åœ¨inä¹‹åçš„åˆ—è¡¨</td></tr><tr><td>LIKE å ä½ç¬¦</td><td>æ¨¡ç³ŠåŒ¹é…(_åŒ¹é…</td></tr><tr><td>IS NULL</td><td>æ˜¯NULL</td></tr></tbody></table><p>å¸¸ç”¨çš„é€»è¾‘è¿ç®—ç¬¦å¦‚ä¸‹:  </p><table><thead><tr><th>é€»è¾‘è¿ç®—ç¬¦</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>AND æˆ– &amp;&amp;</td><td>å¹¶ä¸” (å¤šä¸ªæ¡ä»¶åŒæ—¶æˆç«‹)</td></tr><tr><td>OR æˆ– ||</td><td>æˆ–è€… (å¤šä¸ªæ¡ä»¶ä»»æ„ä¸€ä¸ªæˆ</td></tr><tr><td>NOT æˆ– !</td><td>é , ä¸æ˜¯</td></tr></tbody></table><p>1ï¼ŒæŸ¥è¯¢å¹´é¾„ç­‰äº88çš„å‘˜å·¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">=</span> <span class="hljs-number">88</span>;<br></code></pre></td></tr></table></figure><p>2ï¼ŒæŸ¥è¯¢å¹´é¾„å°äº20çš„å‘˜å·¥ä¿¡æ¯</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;</span> <span class="hljs-number">20</span>;<br></code></pre></td></tr></table></figure><p>3ï¼ŒæŸ¥è¯¢å¹´é¾„å°äºç­‰äº 20 çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;=</span> <span class="hljs-number">20</span>;<br></code></pre></td></tr></table></figure><p>4ï¼ŒæŸ¥è¯¢æ²¡æœ‰èº«ä»½è¯å·çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> idcard <span class="hljs-keyword">is</span> <span class="hljs-keyword">null</span>;<br></code></pre></td></tr></table></figure><p>5ï¼ŒæŸ¥è¯¢æœ‰èº«ä»½è¯å·çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> idcard <span class="hljs-keyword">is</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>;<br></code></pre></td></tr></table></figure><p>6ï¼ŒæŸ¥è¯¢å¹´é¾„ä¸ç­‰äº 88 çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">!=</span> <span class="hljs-number">88</span>;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;&gt;</span> <span class="hljs-number">88</span> ;<br></code></pre></td></tr></table></figure><p>7ï¼ŒæŸ¥è¯¢å¹´é¾„åœ¨15å²(åŒ…å«) åˆ° 20å²(åŒ…å«)ä¹‹é—´çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&gt;=</span><span class="hljs-number">15</span> <span class="hljs-keyword">and</span> age <span class="hljs-operator">&lt;=</span><span class="hljs-number">20</span>;<br><br><span class="hljs-keyword">select</span>  <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-keyword">between</span>  <span class="hljs-number">15</span> <span class="hljs-keyword">and</span> <span class="hljs-number">20</span>;<br><br></code></pre></td></tr></table></figure><p>8ï¼ŒæŸ¥è¯¢æ€§åˆ«ä¸º å¥³ ä¸”å¹´é¾„å°äº 25å²çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp  <span class="hljs-keyword">where</span>   gender <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¥³&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-operator">&lt;</span> <span class="hljs-number">25</span>;<br></code></pre></td></tr></table></figure><p>9ï¼ŒæŸ¥è¯¢å¹´é¾„ç­‰äº18 æˆ– 20 æˆ– 40 çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span>  age <span class="hljs-operator">=</span> <span class="hljs-number">18</span>  <span class="hljs-keyword">or</span> age <span class="hljs-operator">=</span> <span class="hljs-number">20</span> <span class="hljs-keyword">or</span> age <span class="hljs-operator">=</span> <span class="hljs-number">40</span>;<br><br><span class="hljs-keyword">select</span>  <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-keyword">in</span>(<span class="hljs-number">18</span>,<span class="hljs-number">20</span>,<span class="hljs-number">40</span>);<br></code></pre></td></tr></table></figure><p>10ï¼ŒæŸ¥è¯¢å§“åä¸ºä¸¤ä¸ªå­—çš„å‘˜å·¥ä¿¡æ¯ _ %  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span>   name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;__&#x27;</span>;<br></code></pre></td></tr></table></figure><p>11ï¼ŒæŸ¥è¯¢èº«ä»½è¯å·æœ€åä¸€ä½æ˜¯Xçš„å‘˜å·¥ä¿¡æ¯ </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> idcard <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;%X&#x27;</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> idcard <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;_________________X&#x27;</span>;<br></code></pre></td></tr></table></figure><h5 id="DQL-èšåˆå‡½æ•°"><a href="#DQL-èšåˆå‡½æ•°" class="headerlink" title="DQL-èšåˆå‡½æ•°"></a>DQL-èšåˆå‡½æ•°</h5><p>å°†ä¸€åˆ—æ•°æ®ä½œä¸ºä¸€ä¸ªæ•´ä½“ï¼Œè¿›è¡Œçºµå‘è®¡ç®—  </p><p>å¸¸è§çš„èšåˆå‡½æ•°  </p><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>count</td><td>ç»Ÿè®¡æ•°é‡</td></tr><tr><td>max</td><td>æœ€å¤§å€¼</td></tr><tr><td>min</td><td>æœ€å°å€¼</td></tr><tr><td>avg</td><td>å¹³å‡å€¼</td></tr><tr><td>sum</td><td>æ±‚å’Œ</td></tr></tbody></table><p>è¯­æ³•</p><blockquote><p>æ³¨æ„ : NULLå€¼æ˜¯ä¸å‚ä¸æ‰€æœ‰èšåˆå‡½æ•°è¿ç®—çš„ã€‚  </p></blockquote><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> èšåˆå‡½æ•°(å­—æ®µåˆ—è¡¨) <span class="hljs-keyword">FROM</span> è¡¨å ;<br></code></pre></td></tr></table></figure><p>1ï¼Œç»Ÿè®¡è¯¥ä¼ä¸šå‘˜å·¥æ•°é‡  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p>2ï¼Œç»Ÿè®¡è¯¥ä¼ä¸šå‘˜å·¥çš„å¹³å‡å¹´é¾„</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">avg</span>(age)  <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p>3ï¼Œç»Ÿè®¡è¯¥ä¼ä¸šå‘˜å·¥çš„æœ€å¤§å¹´é¾„</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">avg</span>(age)  <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p>4ï¼Œç»Ÿè®¡è¯¥ä¼ä¸šå‘˜å·¥çš„æœ€å°å¹´é¾„</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">min</span>(age)  <span class="hljs-keyword">from</span> emp;<br></code></pre></td></tr></table></figure><p>5ï¼Œç»Ÿè®¡è¥¿å®‰çš„å‘˜å·¥å¹´é¾„ä¹‹å’Œ</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">sum</span>(age)  <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> workaddress <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;è¥¿å®‰&#x27;</span><br></code></pre></td></tr></table></figure><h5 id="DQL-åˆ†ç»„æŸ¥è¯¢"><a href="#DQL-åˆ†ç»„æŸ¥è¯¢" class="headerlink" title="DQL-åˆ†ç»„æŸ¥è¯¢"></a>DQL-åˆ†ç»„æŸ¥è¯¢</h5><p>è¯­å¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å [ WHERE æ¡ä»¶ ] GROUP BY åˆ†ç»„å­—æ®µå [ HAVING åˆ†ç»„åè¿‡æ»¤æ¡ä»¶ ];<br></code></pre></td></tr></table></figure><p>whereä¸havingåŒºåˆ«</p><ul><li>æ‰§è¡Œæ—¶æœºä¸åŒï¼šwhereæ˜¯åˆ†ç»„ä¹‹å‰è¿›è¡Œè¿‡æ»¤ï¼Œä¸æ»¡è¶³whereæ¡ä»¶ï¼Œä¸å‚ä¸åˆ†ç»„ï¼›è€Œhavingæ˜¯åˆ†ç»„ä¹‹åå¯¹ç»“æœè¿›è¡Œè¿‡æ»¤ã€‚</li><li>åˆ¤æ–­æ¡ä»¶ä¸åŒï¼šwhereä¸èƒ½å¯¹èšåˆå‡½æ•°è¿›è¡Œåˆ¤æ–­ï¼Œè€Œhavingå¯ä»¥ã€‚</li></ul><blockquote><p>æ³¨æ„äº‹é¡¹:<br>â€¢ åˆ†ç»„ä¹‹åï¼ŒæŸ¥è¯¢çš„å­—æ®µä¸€èˆ¬ä¸ºèšåˆå‡½æ•°å’Œåˆ†ç»„å­—æ®µï¼ŒæŸ¥è¯¢å…¶ä»–å­—æ®µæ— ä»»ä½•æ„ä¹‰ã€‚<br>â€¢ æ‰§è¡Œé¡ºåº: where &gt; èšåˆå‡½æ•° &gt; having ã€‚<br>â€¢ æ”¯æŒå¤šå­—æ®µåˆ†ç»„, å…·ä½“è¯­æ³•ä¸º : group by columnA,columnB   </p></blockquote><p>æ¡ˆä¾‹</p><p>1ï¼Œæ ¹æ®æ€§åˆ«åˆ†ç»„ , ç»Ÿè®¡ç”·æ€§å‘˜å·¥ å’Œ å¥³æ€§å‘˜å·¥çš„æ•°é‡  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  gender, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>  gender<br></code></pre></td></tr></table></figure><p>2ï¼Œæ ¹æ®æ€§åˆ«åˆ†ç»„ , ç»Ÿè®¡ç”·æ€§å‘˜å·¥ å’Œ å¥³æ€§å‘˜å·¥çš„å¹³å‡å¹´é¾„  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>   gender,<span class="hljs-built_in">avg</span>(age) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>  gender;<br></code></pre></td></tr></table></figure><p>3ï¼ŒæŸ¥è¯¢å¹´é¾„å°äº45çš„å‘˜å·¥ , å¹¶æ ¹æ®å·¥ä½œåœ°å€åˆ†ç»„ , è·å–å‘˜å·¥æ•°é‡å¤§äºç­‰äº3çš„å·¥ä½œåœ°å€  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> workaddress, <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;</span> <span class="hljs-number">45</span>  <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>  workaddress <span class="hljs-keyword">having</span>  <span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-operator">&gt;=</span><span class="hljs-number">3</span> ;<br></code></pre></td></tr></table></figure><p>4ï¼Œç»Ÿè®¡å„ä¸ªå·¥ä½œåœ°å€ä¸Šç­çš„ç”·æ€§åŠå¥³æ€§å‘˜å·¥çš„æ•°é‡  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select workaddress, gender, count(*) &#x27;æ•°é‡&#x27; from emp group by gender , workaddress;<br></code></pre></td></tr></table></figure><h5 id="DQL-æ’åºæŸ¥è¯¢"><a href="#DQL-æ’åºæŸ¥è¯¢" class="headerlink" title="DQL-æ’åºæŸ¥è¯¢"></a>DQL-æ’åºæŸ¥è¯¢</h5><p>è¯­æ³•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SELECT å­—æ®µåˆ—è¡¨ FROM è¡¨å ORDER BY å­—æ®µ1 æ’åºæ–¹å¼1 , å­—æ®µ2 æ’åºæ–¹å¼2 ;<br></code></pre></td></tr></table></figure><p>æ’åºæ–¹å¼  </p><ul><li>ASC : å‡åº(é»˜è®¤å€¼)</li><li>DESC: é™åº</li></ul><p>1ï¼Œæ ¹æ®å¹´é¾„å¯¹å…¬å¸çš„å‘˜å·¥è¿›è¡Œå‡åºæ’åº  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">asc</span>;<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure><p>2ï¼Œæ ¹æ®å…¥èŒæ—¶é—´, å¯¹å‘˜å·¥è¿›è¡Œé™åºæ’åº  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>  entrydata <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure><p>3ï¼Œæ ¹æ®å¹´é¾„å¯¹å…¬å¸å‘˜å·¥è¿›è¡Œå‡åºæ’åºï¼Œå¹´é¾„ç›¸åŒçš„ï¼Œå†æŒ‰ç…§è¿™ä¸ªå…¥èŒæ—¶é—´è¿›è¡Œæ’åº</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">asc</span>,entrydata <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure><h5 id="DQL-åˆ†é¡µæŸ¥è¯¢"><a href="#DQL-åˆ†é¡µæŸ¥è¯¢" class="headerlink" title="DQL-åˆ†é¡µæŸ¥è¯¢"></a>DQL-åˆ†é¡µæŸ¥è¯¢</h5><p>è¯­æ³•</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨å LIMIT èµ·å§‹ç´¢å¼•, æŸ¥è¯¢è®°å½•æ•°<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„äº‹é¡¹:<br>â€¢ èµ·å§‹ç´¢å¼•ä»0å¼€å§‹ï¼Œèµ·å§‹ç´¢å¼• &#x3D; ï¼ˆæŸ¥è¯¢é¡µç  - 1ï¼‰* æ¯é¡µæ˜¾ç¤ºè®°å½•æ•°ã€‚<br>â€¢ åˆ†é¡µæŸ¥è¯¢æ˜¯æ•°æ®åº“çš„æ–¹è¨€ï¼Œä¸åŒçš„æ•°æ®åº“æœ‰ä¸åŒçš„å®ç°ï¼ŒMySQLä¸­æ˜¯LIMITã€‚<br>â€¢ å¦‚æœæŸ¥è¯¢çš„æ˜¯ç¬¬ä¸€é¡µæ•°æ®ï¼Œèµ·å§‹ç´¢å¼•å¯ä»¥çœç•¥ï¼Œç›´æ¥ç®€å†™ä¸º limit 10ã€‚  </p></blockquote><p>æ¡ˆä¾‹</p><p>1ï¼ŒæŸ¥è¯¢ç¬¬ä¸€é¡µå‘˜å·¥ä¿¡æ¯ï¼Œæ¯é¡µå±•ç¤º10æ¡è®°å½•</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp limit <span class="hljs-number">0</span>,<span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><p>2ï¼ŒæŸ¥è¯¢ç¬¬äºŒé¡µå‘˜å·¥æ•°æ®ï¼Œæ¯é¡µå±•ç¤º10æ¡æ•°æ®</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp limit  <span class="hljs-number">10</span>,<span class="hljs-number">10</span>;<br></code></pre></td></tr></table></figure><h5 id="DQL-ç»ƒä¹ "><a href="#DQL-ç»ƒä¹ " class="headerlink" title="DQL-ç»ƒä¹ "></a>DQL-ç»ƒä¹ </h5><p>1ï¼ŒæŸ¥è¯¢å¹´é¾„ä¸º20,21,22,23å²çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp  <span class="hljs-keyword">where</span> gender <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¥³&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-keyword">in</span>(<span class="hljs-number">20</span>,<span class="hljs-number">21</span>,<span class="hljs-number">22</span>,<span class="hljs-number">23</span>);<br></code></pre></td></tr></table></figure><p>2ï¼ŒæŸ¥è¯¢æ€§åˆ«ä¸º ç”· ï¼Œå¹¶ä¸”å¹´é¾„åœ¨ 20-40 å²(å«)ä»¥å†…çš„å§“åä¸ºä¸‰ä¸ªå­—çš„å‘˜å·¥ã€‚  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp  <span class="hljs-keyword">where</span> gender <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ç”·&#x27;</span> <span class="hljs-keyword">and</span>   age <span class="hljs-keyword">between</span> <span class="hljs-number">20</span> <span class="hljs-keyword">and</span> <span class="hljs-number">40</span> <span class="hljs-keyword">and</span> name <span class="hljs-keyword">like</span> <span class="hljs-string">&#x27;___&#x27;</span>;<br></code></pre></td></tr></table></figure><p>3ï¼Œç»Ÿè®¡å‘˜å·¥è¡¨ä¸­, å¹´é¾„å°äº60å²çš„ , ç”·æ€§å‘˜å·¥å’Œå¥³æ€§å‘˜å·¥çš„äººæ•°  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>   gender,<span class="hljs-built_in">count</span>(<span class="hljs-operator">*</span>) <span class="hljs-keyword">from</span>  emp  <span class="hljs-keyword">where</span>  age <span class="hljs-operator">&lt;</span> <span class="hljs-number">60</span> <span class="hljs-keyword">group</span> <span class="hljs-keyword">by</span>  gender;<br></code></pre></td></tr></table></figure><p>4ï¼ŒæŸ¥è¯¢æ‰€æœ‰å¹´é¾„å°äºç­‰äº35å²å‘˜å·¥çš„å§“åå’Œå¹´é¾„ï¼Œå¹¶å¯¹æŸ¥è¯¢ç»“æœæŒ‰å¹´é¾„å‡åºæ’åºï¼Œå¦‚æœå¹´é¾„ç›¸åŒæŒ‰å…¥èŒæ—¶é—´é™åºæ’åºã€‚ </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> name,age <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&lt;=</span><span class="hljs-number">35</span>   <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>  age <span class="hljs-keyword">asc</span>,entrydata <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure><p>5ï¼ŒæŸ¥è¯¢æ€§åˆ«ä¸ºç”·ï¼Œä¸”å¹´é¾„åœ¨20-40 å²(å«)ä»¥å†…çš„å‰5ä¸ªå‘˜å·¥ä¿¡æ¯ï¼Œå¯¹æŸ¥è¯¢çš„ç»“æœæŒ‰å¹´é¾„å‡åºæ’åºï¼Œå¹´é¾„ç›¸åŒæŒ‰å…¥èŒæ—¶é—´å‡åºæ’åº  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> gender <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;ç”·&#x27;</span> <span class="hljs-keyword">and</span> age <span class="hljs-keyword">between</span> <span class="hljs-number">20</span> <span class="hljs-keyword">and</span> <span class="hljs-number">40</span>  <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span>  age <span class="hljs-keyword">asc</span>,entrydata <span class="hljs-keyword">asc</span> limit <span class="hljs-number">5</span> ;<br></code></pre></td></tr></table></figure><h5 id="DQL-æ‰§è¡Œé¡ºåº"><a href="#DQL-æ‰§è¡Œé¡ºåº" class="headerlink" title="DQL-æ‰§è¡Œé¡ºåº"></a>DQL-æ‰§è¡Œé¡ºåº</h5><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303222339631.png" alt="image-20230322233936503"></p><p>æ¡ˆä¾‹</p><p>1ï¼ŒæŸ¥è¯¢å¹´é¾„å¤§äº15çš„å‘˜å·¥å§“åã€å¹´é¾„ï¼Œå¹¶æ ¹æ®å¹´é¾„è¿›è¡Œå‡åºæ’åº  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> name,age <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&gt;</span><span class="hljs-number">15</span>  <span class="hljs-keyword">order</span> <span class="hljs-keyword">by</span> age <span class="hljs-keyword">asc</span>;<br></code></pre></td></tr></table></figure><p>ç»¼ä¸Šæ‰€è¿°ï¼Œæˆ‘ä»¬å¯ä»¥çœ‹åˆ°DQLè¯­å¥çš„æ‰§è¡Œé¡ºåºä¸ºï¼š from â€¦ where â€¦ group by â€¦having â€¦ select â€¦ order by â€¦ limit â€¦  </p><h4 id="DCLè¯­å¥"><a href="#DCLè¯­å¥" class="headerlink" title="DCLè¯­å¥"></a>DCLè¯­å¥</h4><p>DCLè‹±æ–‡å…¨ç§°æ˜¯Data Control Language(æ•°æ®æ§åˆ¶è¯­è¨€)ï¼Œç”¨æ¥ç®¡ç†æ•°æ®åº“ç”¨æˆ·ã€æ§åˆ¶æ•°æ®åº“çš„è®¿é—®æƒé™ã€‚  </p><h5 id="DCL-ç®¡ç†ç”¨æˆ·"><a href="#DCL-ç®¡ç†ç”¨æˆ·" class="headerlink" title="DCL-ç®¡ç†ç”¨æˆ·"></a>DCL-ç®¡ç†ç”¨æˆ·</h5><p>æŸ¥è¯¢ç”¨æˆ·</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">use mysql<br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> <span class="hljs-keyword">user</span>;<br></code></pre></td></tr></table></figure><p>åˆ›å»ºç”¨æˆ·</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;ç”¨æˆ·å&#x27;</span>@<span class="hljs-string">&#x27;ä¸»æœºå&#x27;</span> IDENTIFIED <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;å¯†ç &#x27;</span>;<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ç”¨æˆ·å¯†ç   </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;ç”¨æˆ·å&#x27;</span>@<span class="hljs-string">&#x27;ä¸»æœºå&#x27;</span> IDENTIFIED <span class="hljs-keyword">WITH</span> mysql_native_password <span class="hljs-keyword">BY</span> <span class="hljs-string">&#x27;æ–°å¯†ç &#x27;</span> ;<br></code></pre></td></tr></table></figure><p>åˆ é™¤ç”¨æˆ·  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">DROP</span> <span class="hljs-keyword">USER</span> <span class="hljs-string">&#x27;ç”¨æˆ·å&#x27;</span>@<span class="hljs-string">&#x27;ä¸»æœºå&#x27;</span> ;<br></code></pre></td></tr></table></figure><p>1ï¼Œåˆ›å»ºç”¨æˆ·itcast, åªèƒ½å¤Ÿåœ¨å½“å‰ä¸»æœºlocalhostè®¿é—®, å¯†ç 123456;</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span>  <span class="hljs-string">&#x27;itcast&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>  identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure><p>2ï¼Œ åˆ›å»ºç”¨æˆ·user, å¯ä»¥åœ¨ä»»æ„ä¸»æœºè®¿é—®è¯¥æ•°æ®åº“, å¯†ç 123456;</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">user</span>  <span class="hljs-string">&#x27;mysquser&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>  identified <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;123456&#x27;</span>;<br></code></pre></td></tr></table></figure><p>3ï¼Œä¿®æ”¹ç”¨æˆ·mysquserçš„è®¿é—®å¯†ç ä¸º1234;</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span>  <span class="hljs-keyword">user</span> <span class="hljs-string">&#x27;mysquser&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> identified <span class="hljs-keyword">with</span> mysql_native_password <span class="hljs-keyword">by</span> <span class="hljs-string">&#x27;1234&#x27;</span>;<br></code></pre></td></tr></table></figure><p>4ï¼Œåˆ é™¤ itcast@localhost ç”¨æˆ·</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">drop</span>  <span class="hljs-keyword">user</span> <span class="hljs-string">&#x27;itcast&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„äº‹é¡¹:<br>â€¢ åœ¨MySQLä¸­éœ€è¦é€šè¿‡ç”¨æˆ·å@ä¸»æœºåçš„æ–¹å¼ï¼Œæ¥å”¯ä¸€æ ‡è¯†ä¸€ä¸ªç”¨æˆ·  </p><p>â€¢ ä¸»æœºåå¯ä»¥ä½¿ç”¨ % é€šé…ã€‚<br>â€¢ è¿™ç±»SQLå¼€å‘äººå‘˜æ“ä½œçš„æ¯”è¾ƒå°‘ï¼Œä¸»è¦æ˜¯DBAï¼ˆ Database Administrator æ•°æ®åº“<br>ç®¡ç†å‘˜ï¼‰ä½¿ç”¨ã€‚  </p></blockquote><h5 id="DCL-æƒé™æ§åˆ¶"><a href="#DCL-æƒé™æ§åˆ¶" class="headerlink" title="DCL-æƒé™æ§åˆ¶"></a>DCL-æƒé™æ§åˆ¶</h5><table><thead><tr><th>æƒé™</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>ALL, ALL PRIVILEGES</td><td>æ‰€æœ‰æƒé™</td></tr><tr><td>SELECT</td><td>æŸ¥è¯¢æ•°æ®</td></tr><tr><td>INSERT</td><td>æ’å…¥æ•°æ®</td></tr><tr><td>UPDATE</td><td>ä¿®æ”¹æ•°æ®</td></tr><tr><td>DELETE</td><td>åˆ é™¤æ•°æ®</td></tr><tr><td>ALTER</td><td>ä¿®æ”¹è¡¨</td></tr><tr><td>DROP</td><td>åˆ é™¤æ•°æ®åº“&#x2F;è¡¨&#x2F;è§†å›¾</td></tr><tr><td>CREATE</td><td>åˆ›å»ºæ•°æ®åº“&#x2F;è¡¨</td></tr></tbody></table><p>æŸ¥è¯¢æƒé™</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">sqlSHOW GRANTS <span class="hljs-keyword">FOR</span> <span class="hljs-string">&#x27;ç”¨æˆ·å&#x27;</span>@â€˜ä¸»æœºåâ€™;<br></code></pre></td></tr></table></figure><p>æˆäºˆæƒé™</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">GRANT</span> æƒé™åˆ—è¡¨ <span class="hljs-keyword">ON</span> æ•°æ®åº“å.è¡¨å <span class="hljs-keyword">TO</span> <span class="hljs-string">&#x27;ç”¨æˆ·å&#x27;</span>@<span class="hljs-string">&#x27;ä¸»æœºå&#x27;</span>;<br></code></pre></td></tr></table></figure><p>æ’¤é”€æƒé™</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">REVOKE</span> æƒé™åˆ—è¡¨ <span class="hljs-keyword">ON</span> æ•°æ®åº“å.è¡¨å <span class="hljs-keyword">FROM</span> <span class="hljs-string">&#x27;ç”¨æˆ·å&#x27;</span>@<span class="hljs-string">&#x27;ä¸»æœºå&#x27;</span>;<br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">show grants  for &#x27;mysquser&#x27;@&#x27;%&#x27;;<br><br>grant   all on itcast.* to &#x27;mysquser&#x27;@&#x27;%&#x27;;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„äº‹é¡¹ï¼š<br>â€¢ å¤šä¸ªæƒé™ä¹‹é—´ï¼Œä½¿ç”¨é€—å·åˆ†éš”<br>â€¢ æˆæƒæ—¶ï¼Œ æ•°æ®åº“  </p></blockquote><h3 id="å‡½æ•°"><a href="#å‡½æ•°" class="headerlink" title="å‡½æ•°"></a>å‡½æ•°</h3><p>å‡½æ•° æ˜¯æŒ‡ä¸€æ®µå¯ä»¥ç›´æ¥è¢«å¦ä¸€æ®µç¨‹åºè°ƒç”¨çš„ç¨‹åºæˆ–ä»£ç ã€‚ ä¹Ÿå°±æ„å‘³ç€ï¼Œè¿™ä¸€æ®µç¨‹åºæˆ–ä»£ç åœ¨MySQLä¸­å·²ç»ç»™æˆ‘ä»¬æä¾›äº†ï¼Œæˆ‘ä»¬è¦åšçš„å°±æ˜¯åœ¨åˆé€‚çš„ä¸šåŠ¡åœºæ™¯è°ƒç”¨å¯¹åº”çš„å‡½æ•°å®Œæˆå¯¹åº”çš„ä¸šåŠ¡éœ€æ±‚å³å¯  </p><h4 id="å­—ç¬¦ä¸²å‡½æ•°"><a href="#å­—ç¬¦ä¸²å‡½æ•°" class="headerlink" title="å­—ç¬¦ä¸²å‡½æ•°"></a>å­—ç¬¦ä¸²å‡½æ•°</h4><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>CONCAT(S1,S2,â€¦Sn)</td><td>å­—ç¬¦ä¸²æ‹¼æ¥ï¼Œå°†S1ï¼ŒS2ï¼Œâ€¦ Snæ‹¼æ¥æˆä¸€ä¸ªå­—ç¬¦ä¸²</td></tr><tr><td>LOWER(str)</td><td>å°†å­—ç¬¦ä¸²strå…¨éƒ¨è½¬ä¸ºå°å†™</td></tr><tr><td>UPPER(str)</td><td>å°†å­—ç¬¦ä¸²strå…¨éƒ¨è½¬ä¸ºå¤§å†™</td></tr><tr><td>LPAD(str,n,pad)</td><td>å·¦å¡«å……ï¼Œç”¨å­—ç¬¦ä¸²padå¯¹strçš„å·¦è¾¹è¿›è¡Œå¡«å……ï¼Œè¾¾åˆ°nä¸ªå­—ç¬¦ ä¸²é•¿åº¦</td></tr><tr><td>RPAD(str,n,pad)</td><td>å³å¡«å……ï¼Œç”¨å­—ç¬¦ä¸²padå¯¹strçš„å³è¾¹è¿›è¡Œå¡«å……ï¼Œè¾¾åˆ°nä¸ªå­—ç¬¦ ä¸²é•¿åº¦</td></tr><tr><td>TRIM(str)</td><td>å»æ‰å­—ç¬¦ä¸²å¤´éƒ¨å’Œå°¾éƒ¨çš„ç©ºæ ¼</td></tr><tr><td>SUBSTRING(str,start,len)</td><td>è¿”å›ä»å­—ç¬¦ä¸²strä»startä½ç½®èµ·çš„lenä¸ªé•¿åº¦çš„å­—ç¬¦ä¸²</td></tr></tbody></table><p>æ¡ˆä¾‹æ¼”ç¤º</p><p>concat : å­—ç¬¦ä¸²æ‹¼æ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">select</span> concat(<span class="hljs-string">&#x27;Hello&#x27;</span>,<span class="hljs-string">&#x27;MySQL&#x27;</span>);<br></code></pre></td></tr></table></figure><p>lower : å…¨éƒ¨è½¬å°å†™  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">SELECT</span>  <span class="hljs-built_in">LOWER</span>(<span class="hljs-string">&#x27;Hello&#x27;</span>)<br></code></pre></td></tr></table></figure><p>upper : å…¨éƒ¨è½¬å¤§å†™  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>  <span class="hljs-built_in">upper</span>(<span class="hljs-string">&#x27;Hello&#x27;</span>)<br></code></pre></td></tr></table></figure><p>lpad : å·¦å¡«å……  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> lpad(<span class="hljs-string">&#x27;01&#x27;</span>,<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;-&#x27;</span>)<br></code></pre></td></tr></table></figure><p>rpad : å³å¡«å……  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> rpad(<span class="hljs-string">&#x27;01&#x27;</span>,<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;-&#x27;</span>)<br></code></pre></td></tr></table></figure><p>trim : å»é™¤ç©ºæ ¼  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">trim</span>(<span class="hljs-string">&#x27; Hello MySQL  &#x27;</span>);<br></code></pre></td></tr></table></figure><p>substring : æˆªå–å­å­—ç¬¦ä¸²  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">substring</span>(<span class="hljs-string">&#x27;Hello MySQL&#x27;</span>,<span class="hljs-number">1</span>,<span class="hljs-number">5</span>);<br></code></pre></td></tr></table></figure><p>ç”±äºä¸šåŠ¡éœ€æ±‚å˜æ›´ï¼Œä¼ä¸šå‘˜å·¥çš„å·¥å·ï¼Œç»Ÿä¸€ä¸º5ä½æ•°ï¼Œç›®å‰ä¸è¶³5ä½æ•°çš„å…¨éƒ¨åœ¨å‰é¢è¡¥0ã€‚æ¯”å¦‚ï¼š 1å·å‘˜å·¥çš„å·¥å·åº”è¯¥ä¸º00001ã€‚  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">update</span> emp <span class="hljs-keyword">set</span> workno <span class="hljs-operator">=</span> lpad(workno,<span class="hljs-number">5</span>,<span class="hljs-string">&#x27;0&#x27;</span>);<br></code></pre></td></tr></table></figure><h4 id="æ•°å€¼å‡½æ•°"><a href="#æ•°å€¼å‡½æ•°" class="headerlink" title="æ•°å€¼å‡½æ•°"></a>æ•°å€¼å‡½æ•°</h4><p>å¸¸è§çš„æ•°å€¼å‡½æ•°å¦‚ä¸‹ï¼š  </p><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>CEIL(x)</td><td>å‘ä¸Šå–æ•´</td></tr><tr><td>FLOOR(x)</td><td>å‘ä¸‹å–æ•´</td></tr><tr><td>MOD(x,y)</td><td>è¿”å›x&#x2F;yçš„æ¨¡</td></tr><tr><td>RAND()</td><td>è¿”å›0~1å†…çš„éšæœºæ•°</td></tr><tr><td>ROUND(x,y)</td><td>æ±‚å‚æ•°xçš„å››èˆäº”å…¥çš„å€¼ï¼Œä¿ç•™yä½å°æ•°</td></tr></tbody></table><p>æ¡ˆä¾‹æ¼”ç¤º</p><p>1ï¼Œceilï¼šå‘ä¸Šå–æ•´</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-built_in">ceil</span>(<span class="hljs-number">1.5</span>);<br></code></pre></td></tr></table></figure><p>2ï¼Œfloorï¼šå‘ä¸‹å–æ•´</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  <span class="hljs-built_in">floor</span>(<span class="hljs-number">1.1</span>);<br></code></pre></td></tr></table></figure><p>3ï¼Œ modï¼šå–æ¨¡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  <span class="hljs-built_in">mod</span>(<span class="hljs-number">5</span>,<span class="hljs-number">4</span>);<br></code></pre></td></tr></table></figure><p>4ï¼Œ randï¼šè·å–éšæœºæ•°</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  rand();<br></code></pre></td></tr></table></figure><p>5ï¼Œroundï¼šå››èˆäº”å…¥</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  round(<span class="hljs-number">2.345</span>,<span class="hljs-number">2</span>)<br></code></pre></td></tr></table></figure><p>é€šè¿‡æ•°æ®åº“çš„å‡½æ•°ï¼Œç”Ÿæˆä¸€ä¸ªå…­ä½æ•°çš„éšæœºéªŒè¯ç   </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> lpad(round(rand()<span class="hljs-operator">*</span><span class="hljs-number">1000000</span>,<span class="hljs-number">0</span>),<span class="hljs-number">6</span>,<span class="hljs-string">&#x27;0&#x27;</span>);<br></code></pre></td></tr></table></figure><h4 id="æ—¥æœŸå‡½æ•°"><a href="#æ—¥æœŸå‡½æ•°" class="headerlink" title="æ—¥æœŸå‡½æ•°"></a>æ—¥æœŸå‡½æ•°</h4><p>å¸¸è§çš„æ—¥æœŸå‡½æ•°å¦‚ä¸‹ï¼š  </p><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>CURDATE()</td><td>è¿”å›å½“å‰æ—¥æœŸ</td></tr><tr><td>CURTIME()</td><td>è¿”å›å½“å‰æ—¶é—´</td></tr><tr><td>NOW()</td><td>è¿”å›å½“å‰æ—¥æœŸå’Œæ—¶é—´</td></tr><tr><td>YEAR(date)</td><td>è·å–æŒ‡å®šdateçš„å¹´ä»½</td></tr><tr><td>MONTH(date)</td><td>è·å–æŒ‡å®šdateçš„æœˆä»½</td></tr><tr><td>DAY(date)</td><td>è·å–æŒ‡å®šdateçš„æ—¥æœŸ</td></tr><tr><td>DATE_ADD(date, INTERVAL expr type)</td><td>è¿”å›ä¸€ä¸ªæ—¥æœŸ&#x2F;æ—¶é—´å€¼åŠ ä¸Šä¸€ä¸ªæ—¶é—´é—´éš”expråçš„ æ—¶é—´å€¼</td></tr><tr><td>DATEDIFF(date1,date2)</td><td>è¿”å›èµ·å§‹æ—¶é—´date1 å’Œ ç»“æŸæ—¶é—´date2ä¹‹é—´çš„ æ•°</td></tr></tbody></table><p>1ï¼Œcurdateï¼šå½“å‰æ—¥æœŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select  curdate();<br></code></pre></td></tr></table></figure><p>2ï¼Œcurtimeï¼šå½“å‰æ—¶é—´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select  curdate();<br></code></pre></td></tr></table></figure><p>3ï¼Œnowï¼šå½“å‰æ—¥æœŸå’Œæ—¶é—´</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select  curdate();<br></code></pre></td></tr></table></figure><p>4ï¼Œ YEAR , MONTH , DAYï¼šå½“å‰å¹´ã€æœˆã€æ—¥,</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select YEAR(NOW());<br><br>select MONTH(NOW());<br><br>SELECT DAY(NOW());<br></code></pre></td></tr></table></figure><p>5ï¼Œdate_addï¼šå¢åŠ æŒ‡å®šçš„æ—¶é—´é—´éš”</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">SELECT</span>  DATE_ADD(NOW(),<span class="hljs-type">INTERVAL</span> <span class="hljs-number">70</span> <span class="hljs-keyword">DAY</span> );<br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹ï¼š</p><p>æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥çš„å…¥èŒå¤©æ•°ï¼Œå¹¶æ ¹æ®å…¥èŒå¤©æ•°å€’åºæ’åºã€‚</p><blockquote><p>æ€è·¯ï¼š å…¥èŒå¤©æ•°ï¼Œå°±æ˜¯é€šè¿‡å½“å‰æ—¥æœŸ - å…¥èŒæ—¥æœŸï¼Œæ‰€ä»¥éœ€è¦ä½¿ç”¨datediffå‡½æ•°æ¥å®Œæˆã€‚</p></blockquote><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>  NAME,DATEDIFF(CURDATE(),entrydata)  <span class="hljs-keyword">as</span> <span class="hljs-string">&#x27;entrydates&#x27;</span> <span class="hljs-keyword">FROM</span> emp  <span class="hljs-keyword">ORDER</span> <span class="hljs-keyword">BY</span>  entrydates <span class="hljs-keyword">desc</span>;<br></code></pre></td></tr></table></figure><h4 id="æµç¨‹å‡½æ•°"><a href="#æµç¨‹å‡½æ•°" class="headerlink" title="æµç¨‹å‡½æ•°"></a>æµç¨‹å‡½æ•°</h4><table><thead><tr><th>å‡½æ•°</th><th>åŠŸèƒ½</th></tr></thead><tbody><tr><td>IF(value , t , f)</td><td>å¦‚æœvalueä¸ºtrueï¼Œåˆ™è¿”å›tï¼Œå¦åˆ™è¿”å› f</td></tr><tr><td>IFNULL(value1 , value2)</td><td>å¦‚æœvalue1ä¸ä¸ºç©ºï¼Œè¿”å›value1ï¼Œå¦åˆ™ è¿”å›value2</td></tr><tr><td>CASE WHEN [ val1 ] THEN [res1] â€¦ ELSE [ default ] END</td><td>å¦‚æœval1ä¸ºtrueï¼Œè¿”å›res1ï¼Œâ€¦ å¦ åˆ™è¿”å›defaulté»˜è®¤å€¼</td></tr><tr><td>CASE [ expr ] WHEN [ val1 ] THEN [res1] â€¦ ELSE [ default ] END</td><td>å¦‚æœexprçš„å€¼ç­‰äºval1ï¼Œè¿”å› res1ï¼Œâ€¦ å¦åˆ™è¿”å›defaulté»˜è®¤å€¼</td></tr></tbody></table><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs SQL"><span class="hljs-keyword">select</span>  if(<span class="hljs-literal">true</span>,<span class="hljs-string">&#x27;ok&#x27;</span>,<span class="hljs-string">&#x27;Errot&#x27;</span>);<br><br><span class="hljs-keyword">select</span>  ifnull(<span class="hljs-string">&#x27;ok&#x27;</span>,<span class="hljs-string">&#x27;Default&#x27;</span>);<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢empè¡¨çš„å‘˜å·¥å§“åå’Œå·¥ä½œåœ°å€ (åŒ—äº¬&#x2F;ä¸Šæµ· â€”-&gt; ä¸€çº¿åŸå¸‚ , å…¶ä»– â€”-&gt; äºŒçº¿åŸå¸‚)  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span>  name,<br>       (<span class="hljs-keyword">case</span> workaddress <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;åŒ—äº¬&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;ä¸€çº¿åŸå¸‚&#x27;</span> <span class="hljs-keyword">when</span> <span class="hljs-string">&#x27;ä¸Šæµ·&#x27;</span> <span class="hljs-keyword">then</span> <span class="hljs-string">&#x27;ä¸€çº¿åŸå¸‚&#x27;</span>  <span class="hljs-keyword">else</span> <span class="hljs-string">&#x27;äºŒçº¿åŸå¸‚&#x27;</span> <span class="hljs-keyword">end</span> ) <span class="hljs-keyword">as</span> <span class="hljs-string">&#x27;å·¥ä½œåœ°å€&#x27;</span><br><span class="hljs-keyword">from</span> emp;<br><br></code></pre></td></tr></table></figure><p>æ¡ˆä¾‹ ç»Ÿè®¡å„ç­å„ä¸ªå­¦å‘˜çš„æˆç»©ï¼Œå±•ç¤ºè§„åˆ™å¦‚ä¸‹</p><p>â€“ &gt;&#x3D; 85 å±•ç¤ºä¼˜ç§€</p><p>â€“ &gt;&#x3D;60 å±•ç¤ºåˆæ ¼</p><p>â€“  å¦åˆ™å±•ç¤ºä¸åŠæ ¼</p><p>å‡†å¤‡æ•°æ®</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> score(<br>    id <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;ID&#x27;</span>,<br>    name <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>    math <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;æ•°å­¦&#x27;</span>,<br>    english <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;è‹±è¯­&#x27;</span>,<br>    chinese <span class="hljs-type">int</span> comment  <span class="hljs-string">&#x27;è¯­æ–‡&#x27;</span><br><br>) comment  <span class="hljs-string">&#x27;å­¦å‘˜æˆç»©è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> score(id, name, math, english, chinese)<br><span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>,<span class="hljs-string">&#x27;Tom&#x27;</span>,<span class="hljs-number">67</span>,<span class="hljs-number">88</span>,<span class="hljs-number">95</span>),(<span class="hljs-number">2</span>,<span class="hljs-string">&#x27;Rose&#x27;</span>,<span class="hljs-number">23</span>,<span class="hljs-number">66</span>,<span class="hljs-number">90</span>),(<span class="hljs-number">3</span>,<span class="hljs-string">&#x27;Jack&#x27;</span>,<span class="hljs-number">56</span>,<span class="hljs-number">98</span>,<span class="hljs-number">76</span>);<br><br><span class="hljs-comment">--</span><br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select<br>    id,<br>    name,<br>    (case when math&gt;=85 then  &#x27;ä¼˜ç§€&#x27; when math&gt;=60 then &#x27;åŠæ ¼&#x27; else &#x27;ä¸åŠæ ¼&#x27; end ) math,<br>    (case when english&gt;=85 then  &#x27;ä¼˜ç§€&#x27; when english&gt;=60 then &#x27;åŠæ ¼&#x27; else &#x27;ä¸åŠæ ¼&#x27; end ) english,<br>    (case when chinese&gt;=85 then  &#x27;ä¼˜ç§€&#x27; when chinese&gt;=60 then &#x27;åŠæ ¼&#x27; else &#x27;ä¸åŠæ ¼&#x27; end ) chinese<br><br>from score;<br><br></code></pre></td></tr></table></figure><h3 id="çº¦æŸ"><a href="#çº¦æŸ" class="headerlink" title="çº¦æŸ"></a>çº¦æŸ</h3><p>æ¦‚å¿µï¼šçº¦æŸæ˜¯ä½œç”¨äºè¡¨ä¸­å­—æ®µä¸Šçš„è§„åˆ™ï¼Œç”¨äºé™åˆ¶å­˜å‚¨åœ¨è¡¨ä¸­çš„æ•°æ®ã€‚</p><p>ç›®çš„ï¼šä¿è¯æ•°æ®åº“ä¸­æ•°æ®çš„æ­£ç¡®ã€æœ‰æ•ˆæ€§å’Œå®Œæ•´æ€§ã€‚</p><p>åˆ†ç±»:  </p><table><thead><tr><th>çº¦æŸ</th><th>æè¿°</th><th>å…³é”®å­—</th></tr></thead><tbody><tr><td>éç©ºçº¦æŸ</td><td>é™åˆ¶è¯¥å­—æ®µçš„æ•°æ®ä¸èƒ½ä¸ºnull</td><td>NOT NULL</td></tr><tr><td>å”¯ä¸€çº¦æŸ</td><td>ä¿è¯è¯¥å­—æ®µçš„æ‰€æœ‰æ•°æ®éƒ½æ˜¯å”¯ä¸€ã€ä¸é‡å¤çš„</td><td>UNIQUE</td></tr><tr><td>ä¸»é”®çº¦æŸ</td><td>ä¸»é”®æ˜¯ä¸€è¡Œæ•°æ®çš„å”¯ä¸€æ ‡è¯†ï¼Œè¦æ±‚éç©ºä¸”å”¯ä¸€</td><td>PRIMARY KEY</td></tr><tr><td>é»˜è®¤çº¦æŸ</td><td>ä¿å­˜æ•°æ®æ—¶ï¼Œå¦‚æœæœªæŒ‡å®šè¯¥å­—æ®µçš„å€¼ï¼Œåˆ™é‡‡ç”¨é»˜è®¤å€¼</td><td>DEFAULT</td></tr><tr><td>æ£€æŸ¥çº¦æŸ(8.0.16ç‰ˆæœ¬ ä¹‹å)</td><td>ä¿è¯å­—æ®µå€¼æ»¡è¶³æŸä¸€ä¸ªæ¡ä»¶</td><td>CHECK</td></tr><tr><td>å¤–é”®çº¦æŸ</td><td>ç”¨æ¥è®©ä¸¤å¼ è¡¨çš„æ•°æ®ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä¿è¯æ•°æ®çš„ä¸€è‡´ æ€§å’Œå®Œæ•´æ€§</td><td>FOREIGN KEY</td></tr></tbody></table><blockquote><p>æ³¨æ„ï¼šçº¦æŸæ˜¯ä½œç”¨äºè¡¨ä¸­å­—æ®µä¸Šçš„ï¼Œå¯ä»¥åœ¨åˆ›å»ºè¡¨&#x2F;ä¿®æ”¹è¡¨çš„æ—¶å€™æ·»åŠ çº¦æŸã€‚                </p></blockquote><h4 id="çº¦æŸæ¼”ç¤º"><a href="#çº¦æŸæ¼”ç¤º" class="headerlink" title="çº¦æŸæ¼”ç¤º"></a>çº¦æŸæ¼”ç¤º</h4><table><thead><tr><th>å­—æ®µå</th><th>å­—æ®µå« ä¹‰</th><th>å­—æ®µç±»å‹</th><th>çº¦æŸæ¡ä»¶</th><th>çº¦æŸå…³é”®å­—</th></tr></thead><tbody><tr><td>id</td><td>IDå”¯ä¸€ æ ‡è¯†</td><td>int</td><td>ä¸»é”®ï¼Œå¹¶ä¸”è‡ªåŠ¨å¢é•¿</td><td>PRIMARY KEY AUTO_INCREM</td></tr><tr><td>name</td><td>å§“å</td><td>varchar(10)</td><td>ä¸ä¸ºç©ºï¼Œå¹¶ä¸”å”¯ä¸€</td><td>NOT NULL ,</td></tr><tr><td>age</td><td>å¹´é¾„</td><td>int</td><td>å¤§äº0ï¼Œå¹¶ä¸”å°äºç­‰ äº120</td><td>CHECK</td></tr><tr><td>status</td><td>çŠ¶æ€</td><td>char(1)</td><td>å¦‚æœæ²¡æœ‰æŒ‡å®šè¯¥å€¼ï¼Œ é»˜è®¤ä¸º1</td><td>DEFAULT</td></tr><tr><td>gender</td><td>æ€§åˆ«</td><td>char(1)</td><td>æ— </td><td></td></tr></tbody></table><p>è¯­å¥</p><p>åˆ›å»ºè¡¨</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span>  <span class="hljs-keyword">table</span>  <span class="hljs-keyword">user</span>(<br>    id <span class="hljs-type">int</span> <span class="hljs-keyword">primary</span> key  auto_increment comment <span class="hljs-string">&#x27;ä¸»é”®&#x27;</span>,<br>    name <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>  <span class="hljs-keyword">unique</span>  comment  <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>    age <span class="hljs-type">int</span> <span class="hljs-keyword">check</span> ( age <span class="hljs-operator">&gt;</span> <span class="hljs-number">0</span>  <span class="hljs-operator">&amp;&amp;</span> age <span class="hljs-operator">&lt;=</span><span class="hljs-number">120</span> ) comment  <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>    status <span class="hljs-type">char</span>(<span class="hljs-number">1</span>)  <span class="hljs-keyword">default</span>  <span class="hljs-string">&#x27;1&#x27;</span> comment  <span class="hljs-string">&#x27;çŠ¶æ€&#x27;</span>,<br>    gender <span class="hljs-type">char</span>(<span class="hljs-number">1</span>)  comment  <span class="hljs-string">&#x27;æ€§åˆ«&#x27;</span><br>)  comment  <span class="hljs-string">&#x27;ç”¨æˆ·è¡¨&#x27;</span>;<br></code></pre></td></tr></table></figure><p>æ’å…¥æ•°æ®</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><br><span class="hljs-keyword">insert</span>  <span class="hljs-keyword">into</span> <span class="hljs-keyword">user</span>(name,age,status,gender) <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;Tome1&#x27;</span>,<span class="hljs-number">19</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>),(<span class="hljs-string">&#x27;Tome2&#x27;</span>,<span class="hljs-number">25</span>,<span class="hljs-string">&#x27;0&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>);<br><span class="hljs-keyword">insert</span>  <span class="hljs-keyword">into</span> <span class="hljs-keyword">user</span>(name,age,status,gender) <span class="hljs-keyword">values</span> (<span class="hljs-string">&#x27;Tome3&#x27;</span>,<span class="hljs-number">19</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;ç”·&#x27;</span>);<br></code></pre></td></tr></table></figure><h4 id="å¤–é”®çº¦æŸ"><a href="#å¤–é”®çº¦æŸ" class="headerlink" title="å¤–é”®çº¦æŸ"></a>å¤–é”®çº¦æŸ</h4><p>å¤–é”®ï¼šç”¨æ¥è®©ä¸¤å¼ è¡¨çš„æ•°æ®ä¹‹é—´å»ºç«‹è¿æ¥ï¼Œä»è€Œä¿è¯æ•°æ®çš„ä¸€è‡´æ€§å’Œå®Œæ•´æ€§  </p><p>è¯­æ³•<br>æ·»åŠ å¤–é”®  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> è¡¨å(<br>å­—æ®µå æ•°æ®ç±»å‹,<br>...<br>[<span class="hljs-keyword">CONSTRAINT</span>] [å¤–é”®åç§°] <span class="hljs-keyword">FOREIGN</span> KEY (å¤–é”®å­—æ®µå) <span class="hljs-keyword">REFERENCES</span> ä¸»è¡¨ (ä¸»è¡¨åˆ—å)<br>)<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> å¤–é”®åç§° <span class="hljs-keyword">FOREIGN</span> KEY (å¤–é”®å­—æ®µå)  <span class="hljs-keyword">REFERENCES</span> ä¸»è¡¨ (ä¸»è¡¨åˆ—å) ;<br></code></pre></td></tr></table></figure><p>æ•°æ®å‡†å¤‡ï¼š</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dept(<br>id <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;ID&#x27;</span> <span class="hljs-keyword">primary</span> key,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;éƒ¨é—¨åç§°&#x27;</span><br>)comment <span class="hljs-string">&#x27;éƒ¨é—¨è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dept (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;ç ”å‘éƒ¨&#x27;</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;å¸‚åœºéƒ¨&#x27;</span>),(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;è´¢åŠ¡éƒ¨&#x27;</span>), (<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;é”€å”®éƒ¨&#x27;</span>), (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;æ€»ç»åŠ&#x27;</span>);<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> emp(<br>id <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;ID&#x27;</span> <span class="hljs-keyword">primary</span> key,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>age <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>job <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) comment <span class="hljs-string">&#x27;èŒä½&#x27;</span>,<br>salary <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;è–ªèµ„&#x27;</span>,<br>entrydate <span class="hljs-type">date</span> comment <span class="hljs-string">&#x27;å…¥èŒæ—¶é—´&#x27;</span>,<br>managerid <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;ç›´å±é¢†å¯¼ID&#x27;</span>,<br>dept_id <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;éƒ¨é—¨ID&#x27;</span><br>)  comment <span class="hljs-string">&#x27;å‘˜å·¥è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> emp (id, name, age, job,salary, entrydate, managerid, dept_id) <br><span class="hljs-keyword">VALUES</span>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;é‡‘åº¸&#x27;</span>, <span class="hljs-number">66</span>, <span class="hljs-string">&#x27;æ€»è£&#x27;</span>,<span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;2000-01-01&#x27;</span>, <span class="hljs-keyword">null</span>,<span class="hljs-number">5</span>),<br>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;å¼ æ— å¿Œ&#x27;</span>, <span class="hljs-number">20</span>,<span class="hljs-string">&#x27;é¡¹ç›®ç»ç†&#x27;</span>,<span class="hljs-number">12500</span>, <span class="hljs-string">&#x27;2005-12-05&#x27;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;æ¨é€&#x27;</span>, <span class="hljs-number">33</span>, <span class="hljs-string">&#x27;å¼€å‘&#x27;</span>, <span class="hljs-number">8400</span>,<span class="hljs-string">&#x27;2000-11-03&#x27;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;éŸ¦ä¸€ç¬‘&#x27;</span>, <span class="hljs-number">48</span>, <span class="hljs-string">&#x27;å¼€å‘&#x27;</span>,<span class="hljs-number">11000</span>, <span class="hljs-string">&#x27;2002-02-05&#x27;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;å¸¸é‡æ˜¥&#x27;</span>, <span class="hljs-number">43</span>, <span class="hljs-string">&#x27;å¼€å‘&#x27;</span>,<span class="hljs-number">10500</span>, <span class="hljs-string">&#x27;2004-09-07&#x27;</span>, <span class="hljs-number">3</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;å°æ˜­&#x27;</span>, <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;ç¨‹åºå‘˜é¼“åŠ±å¸ˆ&#x27;</span>,<span class="hljs-number">6600</span>, <span class="hljs-string">&#x27;2004-10-12&#x27;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">1</span>);<br></code></pre></td></tr></table></figure><p>ä¸ºempè¡¨çš„dept_idå­—æ®µæ·»åŠ å¤–é”®çº¦æŸ,å…³è”deptè¡¨çš„ä¸»é”®idã€‚  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span>  fk_emp_dept_id <span class="hljs-keyword">foreign</span> key  (dept_id) <span class="hljs-keyword">references</span>  dept(id);<br></code></pre></td></tr></table></figure><p>åˆ é™¤å¤–é”®  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">DROP</span> <span class="hljs-keyword">FOREIGN</span> KEY å¤–é”®åç§°;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span>  emp <span class="hljs-keyword">drop</span> <span class="hljs-keyword">foreign</span> key  fk_emp_dept_id;<br></code></pre></td></tr></table></figure><p>åˆ é™¤&#x2F;æ›´æ–°è¡Œä¸º</p><p>æ·»åŠ äº†å¤–é”®ä¹‹åï¼Œå†åˆ é™¤çˆ¶è¡¨æ•°æ®æ—¶äº§ç”Ÿçš„çº¦æŸè¡Œä¸ºï¼Œæˆ‘ä»¬å°±ç§°ä¸ºåˆ é™¤&#x2F;æ›´æ–°è¡Œä¸ºã€‚å…·ä½“çš„åˆ é™¤&#x2F;æ›´æ–°è¡Œä¸ºæœ‰ä»¥ä¸‹å‡ ç§  </p><table><thead><tr><th>è¡Œä¸º</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>NO ACTION</td><td>å½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤&#x2F;æ›´æ–°å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰åˆ™ å…è®¸åˆ é™¤&#x2F;æ›´æ–°ã€‚ (ä¸ RESTRICT ä¸€è‡´) é»˜è®¤è¡Œä¸º</td></tr><tr><td>RESTRICT</td><td>å½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤&#x2F;æ›´æ–°å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰åˆ™ å…è®¸åˆ é™¤&#x2F;æ›´æ–°ã€‚ (ä¸ NO ACTION ä¸€è‡´) é»˜è®¤è¡Œä¸º</td></tr><tr><td>CASCADE</td><td>å½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤&#x2F;æ›´æ–°å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰ï¼Œ ä¹Ÿåˆ é™¤&#x2F;æ›´æ–°å¤–é”®åœ¨å­è¡¨ä¸­çš„è®°å½•ã€‚</td></tr><tr><td>SET NULL</td><td>å½“åœ¨çˆ¶è¡¨ä¸­åˆ é™¤å¯¹åº”è®°å½•æ—¶ï¼Œé¦–å…ˆæ£€æŸ¥è¯¥è®°å½•æ˜¯å¦æœ‰å¯¹åº”å¤–é”®ï¼Œå¦‚æœæœ‰åˆ™è®¾ç½®å­ ä¸­è¯¥å¤–é”®å€¼ä¸ºnullï¼ˆè¿™å°±è¦æ±‚è¯¥å¤–é”®å…è®¸å–nullï¼‰ã€‚</td></tr><tr><td>SET DEFAULT</td><td>çˆ¶è¡¨æœ‰å˜æ›´æ—¶ï¼Œå­è¡¨å°†å¤–é”®åˆ—è®¾ç½®æˆä¸€ä¸ªé»˜è®¤çš„å€¼ (Innodbä¸æ”¯æŒ)</td></tr></tbody></table><p><strong>CASCADE è¡Œä¸º</strong></p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ALTER</span> <span class="hljs-keyword">TABLE</span> è¡¨å <span class="hljs-keyword">ADD</span> <span class="hljs-keyword">CONSTRAINT</span> å¤–é”®åç§° <span class="hljs-keyword">FOREIGN</span> KEY (å¤–é”®å­—æ®µ) <span class="hljs-keyword">REFERENCES</span> ä¸»è¡¨å (ä¸»è¡¨å­—æ®µå) <span class="hljs-keyword">ON</span> <span class="hljs-keyword">UPDATE</span> CASCADE <span class="hljs-keyword">ON</span> <span class="hljs-keyword">DELETE</span> CASCADE;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span>  fk_emp_dept_id <span class="hljs-keyword">foreign</span> key  (dept_id) <span class="hljs-keyword">references</span>  dept(id) <span class="hljs-keyword">on</span> <span class="hljs-keyword">update</span>  cascade  <span class="hljs-keyword">on</span> <span class="hljs-keyword">delete</span> cascade ;<br><br></code></pre></td></tr></table></figure><p>SET NULLè¡Œä¸º</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> fk_emp_dept_id <span class="hljs-keyword">foreign</span> key (dept_id) <span class="hljs-keyword">references</span> dept(id) <span class="hljs-keyword">on</span> <span class="hljs-keyword">update</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">null</span> <span class="hljs-keyword">on</span> <span class="hljs-keyword">delete</span> <span class="hljs-keyword">set</span> <span class="hljs-keyword">null</span> ;<br></code></pre></td></tr></table></figure><h3 id="å¤šè¡¨æŸ¥è¯¢"><a href="#å¤šè¡¨æŸ¥è¯¢" class="headerlink" title="å¤šè¡¨æŸ¥è¯¢"></a>å¤šè¡¨æŸ¥è¯¢</h3><h4 id="å¤šè¡¨å…³ç³»"><a href="#å¤šè¡¨å…³ç³»" class="headerlink" title="å¤šè¡¨å…³ç³»"></a>å¤šè¡¨å…³ç³»</h4><p>é¡¹ç›®å¼€å‘ä¸­ï¼Œåœ¨è¿›è¡Œæ•°æ®åº“è¡¨ç»“æ„è®¾è®¡æ—¶ï¼Œä¼šæ ¹æ®ä¸šåŠ¡éœ€æ±‚åŠä¸šåŠ¡æ¨¡å—ä¹‹é—´çš„å…³ç³»ï¼Œåˆ†æå¹¶è®¾è®¡è¡¨ç»“æ„ï¼Œç”±äºä¸šåŠ¡ä¹‹é—´ç›¸äº’å…³è”ï¼Œæ‰€ä»¥å„ä¸ªè¡¨ç»“æ„ä¹‹é—´ä¹Ÿå­˜åœ¨ç€ç§è”ç³»ï¼ŒåŸºæœ¬ä¸Šåˆ†ä¸ºä¸‰ç§ï¼š</p><ul><li>ä¸€å¯¹å¤š(å¤šå¯¹ä¸€)</li><li>å¤šå¯¹å¤š</li><li>ä¸€å¯¹ä¸€</li></ul><h5 id="ä¸€å¯¹å¤šï¼ˆå¤šå¯¹ä¸€ï¼‰"><a href="#ä¸€å¯¹å¤šï¼ˆå¤šå¯¹ä¸€ï¼‰" class="headerlink" title="ä¸€å¯¹å¤šï¼ˆå¤šå¯¹ä¸€ï¼‰"></a>ä¸€å¯¹å¤šï¼ˆå¤šå¯¹ä¸€ï¼‰</h5><p>æ¡ˆä¾‹: éƒ¨é—¨ ä¸ å‘˜å·¥çš„å…³ç³»</p><p>å…³ç³»: ä¸€ä¸ªéƒ¨é—¨å¯¹åº”å¤šä¸ªå‘˜å·¥ï¼Œä¸€ä¸ªå‘˜å·¥å¯¹åº”ä¸€ä¸ªéƒ¨é—¨</p><p>å®ç°: åœ¨å¤šçš„ä¸€æ–¹å»ºç«‹å¤–é”®ï¼ŒæŒ‡å‘ä¸€çš„ä¸€æ–¹çš„ä¸»é”®  </p><h5 id="å¤šå¯¹å¤š"><a href="#å¤šå¯¹å¤š" class="headerlink" title="å¤šå¯¹å¤š"></a>å¤šå¯¹å¤š</h5><p>æ¡ˆä¾‹: å­¦ç”Ÿ ä¸ è¯¾ç¨‹çš„å…³ç³»</p><p>å…³ç³»: ä¸€ä¸ªå­¦ç”Ÿå¯ä»¥é€‰ä¿®å¤šé—¨è¯¾ç¨‹ï¼Œä¸€é—¨è¯¾ç¨‹ä¹Ÿå¯ä»¥ä¾›å¤šä¸ªå­¦ç”Ÿé€‰æ‹©</p><p>å®ç°: å»ºç«‹ç¬¬ä¸‰å¼ ä¸­é—´è¡¨ï¼Œä¸­é—´è¡¨è‡³å°‘åŒ…å«ä¸¤ä¸ªå¤–é”®ï¼Œåˆ†åˆ«å…³è”ä¸¤æ–¹ä¸»é”®  </p><p>æ•°æ®å‡†å¤‡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> student(<br>id <span class="hljs-type">int</span> auto_increment <span class="hljs-keyword">primary</span> key comment <span class="hljs-string">&#x27;ä¸»é”®ID&#x27;</span>,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br><span class="hljs-keyword">no</span> <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) comment <span class="hljs-string">&#x27;å­¦å·&#x27;</span><br>) comment <span class="hljs-string">&#x27;å­¦ç”Ÿè¡¨&#x27;</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> student <span class="hljs-keyword">values</span> (<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;é»›ç»®ä¸&#x27;</span>, <span class="hljs-string">&#x27;2000100101&#x27;</span>),<br>(<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;è°¢é€Š&#x27;</span>,<span class="hljs-string">&#x27;2000100102&#x27;</span>),<br>(<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;æ®·å¤©æ­£&#x27;</span>, <span class="hljs-string">&#x27;2000100103&#x27;</span>),<br>(<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;éŸ¦ä¸€ç¬‘&#x27;</span>, <span class="hljs-string">&#x27;2000100104&#x27;</span>);<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> course(<br>id <span class="hljs-type">int</span> auto_increment <span class="hljs-keyword">primary</span> key comment <span class="hljs-string">&#x27;ä¸»é”®ID&#x27;</span>,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) comment <span class="hljs-string">&#x27;è¯¾ç¨‹åç§°&#x27;</span><br>) comment <span class="hljs-string">&#x27;è¯¾ç¨‹è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> course <span class="hljs-keyword">values</span> (<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;Java&#x27;</span>),<br>(<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;PHP&#x27;</span>), <br>(<span class="hljs-keyword">null</span> , <span class="hljs-string">&#x27;MySQL&#x27;</span>) ,<br>(<span class="hljs-keyword">null</span>, <span class="hljs-string">&#x27;Hadoop&#x27;</span>);<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> student_course(<br>id <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;ä¸»é”®&#x27;</span> <span class="hljs-keyword">primary</span> key,<br>studentid <span class="hljs-type">int</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;å­¦ç”ŸID&#x27;</span>,<br>courseid <span class="hljs-type">int</span> <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;è¯¾ç¨‹ID&#x27;</span>,<br><span class="hljs-keyword">constraint</span> fk_courseid <span class="hljs-keyword">foreign</span> key (courseid) <span class="hljs-keyword">references</span> course (id),<br><span class="hljs-keyword">constraint</span> fk_studentid <span class="hljs-keyword">foreign</span> key (studentid) <span class="hljs-keyword">references</span> student (id)<br>)comment <span class="hljs-string">&#x27;å­¦ç”Ÿè¯¾ç¨‹ä¸­é—´è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> student_course <span class="hljs-keyword">values</span> (<span class="hljs-keyword">null</span>,<span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-number">1</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-number">1</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-number">2</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-number">2</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-number">3</span>,<span class="hljs-number">4</span>);<br></code></pre></td></tr></table></figure><h5 id="ä¸€å¯¹ä¸€"><a href="#ä¸€å¯¹ä¸€" class="headerlink" title="ä¸€å¯¹ä¸€"></a>ä¸€å¯¹ä¸€</h5><p>æ¡ˆä¾‹: ç”¨æˆ· ä¸ ç”¨æˆ·è¯¦æƒ…çš„å…³ç³»</p><p>å…³ç³»: ä¸€å¯¹ä¸€å…³ç³»ï¼Œå¤šç”¨äºå•è¡¨æ‹†åˆ†ï¼Œå°†ä¸€å¼ è¡¨çš„åŸºç¡€å­—æ®µæ”¾åœ¨ä¸€å¼ è¡¨ä¸­ï¼Œå…¶ä»–è¯¦æƒ…å­—æ®µæ”¾åœ¨ä¸€å¼ è¡¨ä¸­ï¼Œä»¥æå‡æ“ä½œæ•ˆç‡</p><p>å®ç°: åœ¨ä»»æ„ä¸€æ–¹åŠ å…¥å¤–é”®ï¼Œå…³è”å¦å¤–ä¸€æ–¹çš„ä¸»é”®ï¼Œå¹¶ä¸”è®¾ç½®å¤–é”®ä¸ºå”¯ä¸€çš„(UNIQUE)  </p><p>æ•°æ®å‡†å¤‡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_user(<br>id <span class="hljs-type">int</span> auto_increment <span class="hljs-keyword">primary</span> key comment <span class="hljs-string">&#x27;ä¸»é”®ID&#x27;</span>,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">10</span>) comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>age <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>gender <span class="hljs-type">char</span>(<span class="hljs-number">1</span>) comment <span class="hljs-string">&#x27;1: ç”· , 2: å¥³&#x27;</span>,<br>phone <span class="hljs-type">char</span>(<span class="hljs-number">11</span>) comment <span class="hljs-string">&#x27;æ‰‹æœºå·&#x27;</span><br>) comment <span class="hljs-string">&#x27;ç”¨æˆ·åŸºæœ¬ä¿¡æ¯è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> tb_user_edu(<br>id <span class="hljs-type">int</span> auto_increment <span class="hljs-keyword">primary</span> key comment <span class="hljs-string">&#x27;ä¸»é”®ID&#x27;</span>,<br>degree <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) comment <span class="hljs-string">&#x27;å­¦å†&#x27;</span>,<br>major <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) comment <span class="hljs-string">&#x27;ä¸“ä¸š&#x27;</span>,<br>primaryschool <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) comment <span class="hljs-string">&#x27;å°å­¦&#x27;</span>,<br>middleschool <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) comment <span class="hljs-string">&#x27;ä¸­å­¦&#x27;</span>,<br>university <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) comment <span class="hljs-string">&#x27;å¤§å­¦&#x27;</span>,<br>userid <span class="hljs-type">int</span> <span class="hljs-keyword">unique</span> comment <span class="hljs-string">&#x27;ç”¨æˆ·ID&#x27;</span>,<br><span class="hljs-keyword">constraint</span> fk_userid <span class="hljs-keyword">foreign</span> key (userid) <span class="hljs-keyword">references</span> tb_user(id)<br>) comment <span class="hljs-string">&#x27;ç”¨æˆ·æ•™è‚²ä¿¡æ¯è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> tb_user(id, name, age, gender, phone) <span class="hljs-keyword">values</span><br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;é»„æ¸¤&#x27;</span>,<span class="hljs-number">45</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;18800001111&#x27;</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;å†°å†°&#x27;</span>,<span class="hljs-number">35</span>,<span class="hljs-string">&#x27;2&#x27;</span>,<span class="hljs-string">&#x27;18800002222&#x27;</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;ç äº‘&#x27;</span>,<span class="hljs-number">55</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;18800008888&#x27;</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;æå½¦å®&#x27;</span>,<span class="hljs-number">50</span>,<span class="hljs-string">&#x27;1&#x27;</span>,<span class="hljs-string">&#x27;18800009999&#x27;</span>);<br><br><span class="hljs-keyword">insert</span> <span class="hljs-keyword">into</span> tb_user_edu(id, degree, major, primaryschool, middleschool,university, userid) <span class="hljs-keyword">values</span><br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;æœ¬ç§‘&#x27;</span>,<span class="hljs-string">&#x27;èˆè¹ˆ&#x27;</span>,<span class="hljs-string">&#x27;é™å®‰åŒºç¬¬ä¸€å°å­¦&#x27;</span>,<span class="hljs-string">&#x27;é™å®‰åŒºç¬¬ä¸€ä¸­å­¦&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬èˆè¹ˆå­¦é™¢&#x27;</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;ç¡•å£«&#x27;</span>,<span class="hljs-string">&#x27;è¡¨æ¼”&#x27;</span>,<span class="hljs-string">&#x27;æœé˜³åŒºç¬¬ä¸€å°å­¦&#x27;</span>,<span class="hljs-string">&#x27;æœé˜³åŒºç¬¬ä¸€ä¸­å­¦&#x27;</span>,<span class="hljs-string">&#x27;åŒ—äº¬ç”µå½±å­¦é™¢&#x27;</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;æœ¬ç§‘&#x27;</span>,<span class="hljs-string">&#x27;è‹±è¯­&#x27;</span>,<span class="hljs-string">&#x27;æ­å·å¸‚ç¬¬ä¸€å°å­¦&#x27;</span>,<span class="hljs-string">&#x27;æ­å·å¸‚ç¬¬ä¸€ä¸­å­¦&#x27;</span>,<span class="hljs-string">&#x27;æ­å·å¸ˆèŒƒå¤§å­¦&#x27;</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-keyword">null</span>,<span class="hljs-string">&#x27;æœ¬ç§‘&#x27;</span>,<span class="hljs-string">&#x27;åº”ç”¨æ•°å­¦&#x27;</span>,<span class="hljs-string">&#x27;é˜³æ³‰ç¬¬ä¸€å°å­¦&#x27;</span>,<span class="hljs-string">&#x27;é˜³æ³‰åŒºç¬¬ä¸€ä¸­å­¦&#x27;</span>,<span class="hljs-string">&#x27;æ¸…åå¤§å­¦&#x27;</span>,<span class="hljs-number">4</span>);    <br></code></pre></td></tr></table></figure><h4 id="å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°"><a href="#å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°" class="headerlink" title="å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°"></a>å¤šè¡¨æŸ¥è¯¢æ¦‚è¿°</h4><p>æ•°æ®å‡†å¤‡</p><blockquote><p> åˆ é™¤ä¹‹å‰ emp, deptè¡¨çš„æµ‹è¯•æ•°æ®</p><p> æ‰§è¡Œå¦‚ä¸‹è„šæœ¬ï¼Œåˆ›å»ºempè¡¨ä¸deptè¡¨å¹¶æ’å…¥æµ‹è¯•æ•°æ®  </p></blockquote><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- åˆ›å»ºdeptè¡¨ï¼Œå¹¶æ’å…¥æ•°æ®</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> dept(<br>id <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;ID&#x27;</span> <span class="hljs-keyword">primary</span> key,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;éƒ¨é—¨åç§°&#x27;</span><br>)comment <span class="hljs-string">&#x27;éƒ¨é—¨è¡¨&#x27;</span>;<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> dept (id, name) <span class="hljs-keyword">VALUES</span> (<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;ç ”å‘éƒ¨&#x27;</span>), (<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;å¸‚åœºéƒ¨&#x27;</span>),(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;è´¢åŠ¡éƒ¨&#x27;</span>), (<span class="hljs-number">4</span>,<span class="hljs-string">&#x27;é”€å”®éƒ¨&#x27;</span>), (<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;æ€»ç»åŠ&#x27;</span>), (<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;äººäº‹éƒ¨&#x27;</span>);<br><br><span class="hljs-comment">-- åˆ›å»ºempè¡¨ï¼Œå¹¶æ’å…¥æ•°æ®</span><br><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> emp(<br>id <span class="hljs-type">int</span> auto_increment comment <span class="hljs-string">&#x27;ID&#x27;</span> <span class="hljs-keyword">primary</span> key,<br>name <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;å§“å&#x27;</span>,<br>age <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;å¹´é¾„&#x27;</span>,<br>job <span class="hljs-type">varchar</span>(<span class="hljs-number">20</span>) comment <span class="hljs-string">&#x27;èŒä½&#x27;</span>,<br>salary <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;è–ªèµ„&#x27;</span>,<br>entrydate <span class="hljs-type">date</span> comment <span class="hljs-string">&#x27;å…¥èŒæ—¶é—´&#x27;</span>,<br>managerid <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;ç›´å±é¢†å¯¼ID&#x27;</span>,<br>dept_id <span class="hljs-type">int</span> comment <span class="hljs-string">&#x27;éƒ¨é—¨ID&#x27;</span><br>)comment <span class="hljs-string">&#x27;å‘˜å·¥è¡¨&#x27;</span>;<br><br><span class="hljs-comment">-- æ·»åŠ å¤–é”®</span><br><span class="hljs-keyword">alter</span> <span class="hljs-keyword">table</span> emp <span class="hljs-keyword">add</span> <span class="hljs-keyword">constraint</span> fk_emp_dept_id <span class="hljs-keyword">foreign</span> key (dept_id) <span class="hljs-keyword">references</span> dept(id);<br><br><span class="hljs-keyword">INSERT</span> <span class="hljs-keyword">INTO</span> emp (id, name, age, job,salary, entrydate, managerid, dept_id) <span class="hljs-keyword">VALUES</span><br>(<span class="hljs-number">1</span>, <span class="hljs-string">&#x27;é‡‘åº¸&#x27;</span>, <span class="hljs-number">66</span>, <span class="hljs-string">&#x27;æ€»è£&#x27;</span>,<span class="hljs-number">20000</span>, <span class="hljs-string">&#x27;2000-01-01&#x27;</span>, <span class="hljs-keyword">null</span>,<span class="hljs-number">5</span>),<br>(<span class="hljs-number">2</span>, <span class="hljs-string">&#x27;å¼ æ— å¿Œ&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;é¡¹ç›®ç»ç†&#x27;</span>,<span class="hljs-number">12500</span>, <span class="hljs-string">&#x27;2005-12-05&#x27;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">3</span>, <span class="hljs-string">&#x27;æ¨é€&#x27;</span>, <span class="hljs-number">33</span>, <span class="hljs-string">&#x27;å¼€å‘&#x27;</span>, <span class="hljs-number">8400</span>,<span class="hljs-string">&#x27;2000-11-03&#x27;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">4</span>, <span class="hljs-string">&#x27;éŸ¦ä¸€ç¬‘&#x27;</span>, <span class="hljs-number">48</span>, <span class="hljs-string">&#x27;å¼€å‘&#x27;</span>,<span class="hljs-number">11000</span>, <span class="hljs-string">&#x27;2002-02-05&#x27;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">5</span>, <span class="hljs-string">&#x27;å¸¸é‡æ˜¥&#x27;</span>, <span class="hljs-number">43</span>, <span class="hljs-string">&#x27;å¼€å‘&#x27;</span>,<span class="hljs-number">10500</span>, <span class="hljs-string">&#x27;2004-09-07&#x27;</span>, <span class="hljs-number">3</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">6</span>, <span class="hljs-string">&#x27;å°æ˜­&#x27;</span>, <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;ç¨‹åºå‘˜é¼“åŠ±å¸ˆ&#x27;</span>,<span class="hljs-number">6600</span>, <span class="hljs-string">&#x27;2004-10-12&#x27;</span>, <span class="hljs-number">2</span>,<span class="hljs-number">1</span>),<br>(<span class="hljs-number">7</span>, <span class="hljs-string">&#x27;ç­ç»&#x27;</span>, <span class="hljs-number">60</span>, <span class="hljs-string">&#x27;è´¢åŠ¡æ€»ç›‘&#x27;</span>,<span class="hljs-number">8500</span>, <span class="hljs-string">&#x27;2002-09-12&#x27;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-number">8</span>, <span class="hljs-string">&#x27;å‘¨èŠ·è‹¥&#x27;</span>, <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;ä¼šè®¡&#x27;</span>,<span class="hljs-number">48000</span>, <span class="hljs-string">&#x27;2006-06-02&#x27;</span>, <span class="hljs-number">7</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-number">9</span>, <span class="hljs-string">&#x27;ä¸æ•å›&#x27;</span>, <span class="hljs-number">23</span>, <span class="hljs-string">&#x27;å‡ºçº³&#x27;</span>,<span class="hljs-number">5250</span>, <span class="hljs-string">&#x27;2009-05-13&#x27;</span>, <span class="hljs-number">7</span>,<span class="hljs-number">3</span>),<br>(<span class="hljs-number">10</span>, <span class="hljs-string">&#x27;èµµæ•&#x27;</span>, <span class="hljs-number">20</span>, <span class="hljs-string">&#x27;å¸‚åœºéƒ¨æ€»ç›‘&#x27;</span>,<span class="hljs-number">12500</span>, <span class="hljs-string">&#x27;2004-10-12&#x27;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-number">11</span>, <span class="hljs-string">&#x27;é¹¿æ–å®¢&#x27;</span>, <span class="hljs-number">56</span>, <span class="hljs-string">&#x27;èŒå‘˜&#x27;</span>,<span class="hljs-number">3750</span>, <span class="hljs-string">&#x27;2006-10-03&#x27;</span>, <span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-number">12</span>, <span class="hljs-string">&#x27;é¹¤ç¬”ç¿&#x27;</span>, <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;èŒå‘˜&#x27;</span>,<span class="hljs-number">3750</span>, <span class="hljs-string">&#x27;2007-05-09&#x27;</span>, <span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-number">13</span>, <span class="hljs-string">&#x27;æ–¹ä¸œç™½&#x27;</span>, <span class="hljs-number">19</span>, <span class="hljs-string">&#x27;èŒå‘˜&#x27;</span>,<span class="hljs-number">5500</span>, <span class="hljs-string">&#x27;2009-02-12&#x27;</span>, <span class="hljs-number">10</span>,<span class="hljs-number">2</span>),<br>(<span class="hljs-number">14</span>, <span class="hljs-string">&#x27;å¼ ä¸‰ä¸°&#x27;</span>, <span class="hljs-number">88</span>, <span class="hljs-string">&#x27;é”€å”®æ€»ç›‘&#x27;</span>,<span class="hljs-number">14000</span>, <span class="hljs-string">&#x27;2004-10-12&#x27;</span>, <span class="hljs-number">1</span>,<span class="hljs-number">4</span>),<br>(<span class="hljs-number">15</span>, <span class="hljs-string">&#x27;ä¿è²èˆŸ&#x27;</span>, <span class="hljs-number">38</span>, <span class="hljs-string">&#x27;é”€å”®&#x27;</span>,<span class="hljs-number">4600</span>, <span class="hljs-string">&#x27;2004-10-12&#x27;</span>, <span class="hljs-number">14</span>,<span class="hljs-number">4</span>),<br>(<span class="hljs-number">16</span>, <span class="hljs-string">&#x27;å®‹è¿œæ¡¥&#x27;</span>, <span class="hljs-number">40</span>, <span class="hljs-string">&#x27;é”€å”®&#x27;</span>,<span class="hljs-number">4600</span>, <span class="hljs-string">&#x27;2004-10-12&#x27;</span>, <span class="hljs-number">14</span>,<span class="hljs-number">4</span>),<br>(<span class="hljs-number">17</span>, <span class="hljs-string">&#x27;é™ˆå‹è°…&#x27;</span>, <span class="hljs-number">42</span>, <span class="hljs-keyword">null</span>,<span class="hljs-number">2000</span>, <span class="hljs-string">&#x27;2011-10-12&#x27;</span>, <span class="hljs-number">1</span>,<span class="hljs-keyword">null</span>);<br></code></pre></td></tr></table></figure><p>å¤šè¡¨æŸ¥è¯¢å°±æ˜¯æŒ‡ä»å¤šå¼ è¡¨ä¸­æŸ¥è¯¢æ•°æ®ã€‚ </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp,dept <span class="hljs-keyword">where</span> emp.dept_id <span class="hljs-operator">=</span> dept.id;<br><br></code></pre></td></tr></table></figure><h5 id="å¤šè¡¨æŸ¥è¯¢åˆ†ç±»"><a href="#å¤šè¡¨æŸ¥è¯¢åˆ†ç±»" class="headerlink" title="å¤šè¡¨æŸ¥è¯¢åˆ†ç±»"></a>å¤šè¡¨æŸ¥è¯¢åˆ†ç±»</h5><p>è¿æ¥æŸ¥è¯¢<br>    å†…è¿æ¥ï¼šç›¸å½“äºæŸ¥è¯¢Aã€Bäº¤é›†éƒ¨åˆ†æ•°æ®</p><p>å¤–è¿æ¥ï¼š</p><p>â€‹å·¦å¤–è¿æ¥ï¼šæŸ¥è¯¢å·¦è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®</p><p>â€‹å³å¤–è¿æ¥ï¼šæŸ¥è¯¢å³è¡¨æ‰€æœ‰æ•°æ®ï¼Œä»¥åŠä¸¤å¼ è¡¨äº¤é›†éƒ¨åˆ†æ•°æ®</p><p>è‡ªè¿æ¥ï¼šå½“å‰è¡¨ä¸è‡ªèº«çš„è¿æ¥æŸ¥è¯¢ï¼Œè‡ªè¿æ¥å¿…é¡»ä½¿ç”¨è¡¨åˆ«å</p><p>å­æŸ¥è¯¢  </p><h5 id="å†…è¿æ¥"><a href="#å†…è¿æ¥" class="headerlink" title="å†…è¿æ¥"></a>å†…è¿æ¥</h5><p>éšå¼å†…è¿æ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨<span class="hljs-number">1</span> , è¡¨<span class="hljs-number">2</span> <span class="hljs-keyword">WHERE</span> æ¡ä»¶ ... ;<br></code></pre></td></tr></table></figure><p>æ˜¾å¼å†…è¿æ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨<span class="hljs-number">1</span> [ <span class="hljs-keyword">INNER</span> ] <span class="hljs-keyword">JOIN</span> è¡¨<span class="hljs-number">2</span> <span class="hljs-keyword">ON</span> è¿æ¥æ¡ä»¶ ... ;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢æ¯ä¸€ä¸ªå‘˜å·¥çš„å§“å , åŠå…³è”çš„éƒ¨é—¨çš„åç§° (éšå¼å†…è¿æ¥å®ç°)  </p><blockquote><p>è¡¨ç»“æ„: emp , dept<br>è¿æ¥æ¡ä»¶: emp.dept_id &#x3D; dept.id  </p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select  emp.name,dept.name  from emp,dept  where emp.dept_id = dept.id ;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢æ¯ä¸€ä¸ªå‘˜å·¥çš„å§“å , åŠå…³è”çš„éƒ¨é—¨çš„åç§° (æ˜¾å¼å†…è¿æ¥å®ç°)  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  e.name,d.name  <span class="hljs-keyword">from</span>  emp e <span class="hljs-keyword">inner</span> <span class="hljs-keyword">join</span>  dept d <span class="hljs-keyword">on</span> e.dept_id<span class="hljs-operator">=</span>d.id;<br></code></pre></td></tr></table></figure><h5 id="å¤–è¿æ¥"><a href="#å¤–è¿æ¥" class="headerlink" title="å¤–è¿æ¥"></a>å¤–è¿æ¥</h5><p>å¤–è¿æ¥åˆ†ä¸ºä¸¤ç§ï¼Œåˆ†åˆ«æ˜¯ï¼šå·¦å¤–è¿æ¥ å’Œ å³å¤–è¿æ¥ã€‚å…·ä½“çš„è¯­æ³•ç»“æ„ä¸ºï¼š  </p><p>å·¦å¤–è¿æ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨<span class="hljs-number">1</span> <span class="hljs-keyword">LEFT</span> [ <span class="hljs-keyword">OUTER</span> ] <span class="hljs-keyword">JOIN</span> è¡¨<span class="hljs-number">2</span> <span class="hljs-keyword">ON</span> æ¡ä»¶ ... ;<br></code></pre></td></tr></table></figure><p>å·¦å¤–è¿æ¥ç›¸å½“äºæŸ¥è¯¢è¡¨1(å·¦è¡¨)çš„æ‰€æœ‰æ•°æ®ï¼Œå½“ç„¶ä¹ŸåŒ…å«è¡¨1å’Œè¡¨2äº¤é›†éƒ¨åˆ†çš„æ•°æ®ã€‚  </p><p>å³å¤–è¿æ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨<span class="hljs-number">1</span> <span class="hljs-keyword">RIGHT</span> [ <span class="hljs-keyword">OUTER</span> ] <span class="hljs-keyword">JOIN</span> è¡¨<span class="hljs-number">2</span> <span class="hljs-keyword">ON</span> æ¡ä»¶ ... ;<br></code></pre></td></tr></table></figure><p>å³å¤–è¿æ¥ç›¸å½“äºæŸ¥è¯¢è¡¨2(å³è¡¨)çš„æ‰€æœ‰æ•°æ®ï¼Œå½“ç„¶ä¹ŸåŒ…å«è¡¨1å’Œè¡¨2äº¤é›†éƒ¨åˆ†çš„æ•°æ®ã€‚  </p><p>æŸ¥è¯¢empè¡¨çš„æ‰€æœ‰æ•°æ®, å’Œå¯¹åº”çš„éƒ¨é—¨ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> e.<span class="hljs-operator">*</span>,d.name  <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">left</span> <span class="hljs-keyword">outer</span> <span class="hljs-keyword">join</span>  dept d <span class="hljs-keyword">on</span> e.dept_id <span class="hljs-operator">=</span> d.id;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢deptè¡¨çš„æ‰€æœ‰æ•°æ®, å’Œå¯¹åº”çš„å‘˜å·¥ä¿¡æ¯(å³å¤–è¿æ¥)  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> d.<span class="hljs-operator">*</span>,e.<span class="hljs-operator">*</span>   <span class="hljs-keyword">from</span> emp e <span class="hljs-keyword">right</span>  <span class="hljs-keyword">outer</span> <span class="hljs-keyword">join</span>  dept d <span class="hljs-keyword">on</span> e.dept_id <span class="hljs-operator">=</span> d.id;<br></code></pre></td></tr></table></figure><h5 id="è‡ªè¿æ¥"><a href="#è‡ªè¿æ¥" class="headerlink" title="è‡ªè¿æ¥"></a>è‡ªè¿æ¥</h5><p>è‡ªè¿æ¥æŸ¥è¯¢ï¼Œé¡¾åæ€ä¹‰ï¼Œå°±æ˜¯è‡ªå·±è¿æ¥è‡ªå·±ï¼Œä¹Ÿå°±æ˜¯æŠŠä¸€å¼ è¡¨è¿æ¥æŸ¥è¯¢å¤šæ¬¡ã€‚æˆ‘ä»¬å…ˆæ¥å­¦ä¹ ä¸€ä¸‹è‡ªè¿æ¥</p><p>çš„æŸ¥è¯¢è¯­æ³•  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨A åˆ«åA <span class="hljs-keyword">JOIN</span> è¡¨A åˆ«åB <span class="hljs-keyword">ON</span> æ¡ä»¶ ... ;<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢å‘˜å·¥ åŠå…¶ æ‰€å±é¢†å¯¼çš„åå­—  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  a.name,b.name  <span class="hljs-keyword">from</span> emp  a,emp b <span class="hljs-keyword">where</span> a.managerid <span class="hljs-operator">=</span>b.id;<br><br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢æ‰€æœ‰å‘˜å·¥ emp åŠå…¶é¢†å¯¼çš„åå­— emp , å¦‚æœå‘˜å·¥æ²¡æœ‰é¢†å¯¼, ä¹Ÿéœ€è¦æŸ¥è¯¢å‡ºæ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  a.name <span class="hljs-string">&#x27;å‘˜å·¥&#x27;</span>,b.name <span class="hljs-string">&#x27;é¢†å¯¼&#x27;</span> <span class="hljs-keyword">from</span>  emp a <span class="hljs-keyword">left</span> <span class="hljs-keyword">join</span>  emp b <span class="hljs-keyword">on</span> a.managerid <span class="hljs-operator">=</span> b.id<br><br></code></pre></td></tr></table></figure><p>è”åˆæŸ¥è¯¢</p><p>å¯¹äºunionæŸ¥è¯¢ï¼Œå°±æ˜¯æŠŠå¤šæ¬¡æŸ¥è¯¢çš„ç»“æœåˆå¹¶èµ·æ¥ï¼Œå½¢æˆä¸€ä¸ªæ–°çš„æŸ¥è¯¢ç»“æœé›†  </p><blockquote><p>å¯¹äºè”åˆæŸ¥è¯¢çš„å¤šå¼ è¡¨çš„åˆ—æ•°å¿…é¡»ä¿æŒä¸€è‡´ï¼Œå­—æ®µç±»å‹ä¹Ÿéœ€è¦ä¿æŒä¸€è‡´ã€‚<br>union all ä¼šå°†å…¨éƒ¨çš„æ•°æ®ç›´æ¥åˆå¹¶åœ¨ä¸€èµ·ï¼Œunion ä¼šå¯¹åˆå¹¶ä¹‹åçš„æ•°æ®å»é‡ã€‚  </p></blockquote><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql">ELECT å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨A ...<br><span class="hljs-keyword">UNION</span> [ <span class="hljs-keyword">ALL</span> ]<br><span class="hljs-keyword">SELECT</span> å­—æ®µåˆ—è¡¨ <span class="hljs-keyword">FROM</span> è¡¨B ....;<br></code></pre></td></tr></table></figure><p>å°†è–ªèµ„ä½äº 5000 çš„å‘˜å·¥ , å’Œ å¹´é¾„å¤§äº 50 å²çš„å‘˜å·¥å…¨éƒ¨æŸ¥è¯¢å‡ºæ¥  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> salary <span class="hljs-operator">&lt;</span> <span class="hljs-number">5000</span><br><span class="hljs-keyword">union</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> age <span class="hljs-operator">&gt;</span> <span class="hljs-number">50</span>;<br></code></pre></td></tr></table></figure><h5 id="å­æŸ¥è¯¢"><a href="#å­æŸ¥è¯¢" class="headerlink" title="å­æŸ¥è¯¢"></a>å­æŸ¥è¯¢</h5><p>SQLè¯­å¥ä¸­åµŒå¥—SELECTè¯­å¥ï¼Œç§°ä¸ºåµŒå¥—æŸ¥è¯¢ï¼Œåˆç§°å­æŸ¥è¯¢  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SELECT * FROM t1 WHERE column1 = ( SELECT column1 FROM t2 );<br></code></pre></td></tr></table></figure><p>å­æŸ¥è¯¢å¤–éƒ¨çš„è¯­å¥å¯ä»¥æ˜¯INSERT &#x2F; UPDATE &#x2F; DELETE &#x2F; SELECT çš„ä»»ä½•ä¸€ä¸ªã€‚  </p><p>åˆ†ç±»</p><p>æ ¹æ®å­æŸ¥è¯¢ç»“æœä¸åŒï¼Œåˆ†ä¸ºï¼š</p><p>A. æ ‡é‡å­æŸ¥è¯¢ï¼ˆå­æŸ¥è¯¢ç»“æœä¸ºå•ä¸ªå€¼ï¼‰</p><p>B. åˆ—å­æŸ¥è¯¢(å­æŸ¥è¯¢ç»“æœä¸ºä¸€åˆ—)</p><p>C. è¡Œå­æŸ¥è¯¢(å­æŸ¥è¯¢ç»“æœä¸ºä¸€è¡Œ)</p><p>D. è¡¨å­æŸ¥è¯¢(å­æŸ¥è¯¢ç»“æœä¸ºå¤šè¡Œå¤šåˆ—)  </p><p>æ ¹æ®å­æŸ¥è¯¢ä½ç½®ï¼Œåˆ†ä¸ºï¼šã€</p><p>A. WHEREä¹‹å</p><p>B. FROMä¹‹å</p><p>C. SELECTä¹‹å  </p><h6 id="æ ‡é‡å­æŸ¥è¯¢"><a href="#æ ‡é‡å­æŸ¥è¯¢" class="headerlink" title="æ ‡é‡å­æŸ¥è¯¢"></a>æ ‡é‡å­æŸ¥è¯¢</h6><p>å­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯å•ä¸ªå€¼ï¼ˆæ•°å­—ã€å­—ç¬¦ä¸²ã€æ—¥æœŸç­‰ï¼‰ï¼Œæœ€ç®€å•çš„å½¢å¼ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºæ ‡é‡å­æŸ¥è¯¢ã€‚</p><p>å¸¸ç”¨çš„æ“ä½œç¬¦ï¼š&#x3D; &lt;&gt; &gt; &gt;&#x3D; &lt; &lt;&#x3D;  </p><p>æ¡ˆä¾‹:<br>A. æŸ¥è¯¢ â€œé”€å”®éƒ¨â€ çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯<br>å®Œæˆè¿™ä¸ªéœ€æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†éœ€æ±‚åˆ†è§£ä¸ºä¸¤æ­¥ï¼š<br>â‘ . æŸ¥è¯¢ â€œé”€å”®éƒ¨â€ éƒ¨é—¨ID<br>â‘¡. æ ¹æ® â€œé”€å”®éƒ¨â€ éƒ¨é—¨ID, æŸ¥è¯¢å‘˜å·¥ä¿¡æ¯</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;é”€å”®éƒ¨&#x27;</span>;<br></code></pre></td></tr></table></figure><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> dept_id <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;é”€å”®éƒ¨&#x27;</span>);  <br></code></pre></td></tr></table></figure><p>B. æŸ¥è¯¢åœ¨ â€œæ–¹ä¸œç™½â€ å…¥èŒä¹‹åçš„å‘˜å·¥ä¿¡æ¯<br>å®Œæˆè¿™ä¸ªéœ€æ±‚æ—¶ï¼Œæˆ‘ä»¬å¯ä»¥å°†éœ€æ±‚åˆ†è§£ä¸ºä¸¤æ­¥ï¼š<br>â‘ . æŸ¥è¯¢ æ–¹ä¸œç™½ çš„å…¥èŒæ—¥æœŸ  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> entrydate <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;æ–¹ä¸œç™½&#x27;</span>;<br></code></pre></td></tr></table></figure><p>â‘¡. æŸ¥è¯¢æŒ‡å®šå…¥èŒæ—¥æœŸä¹‹åå…¥èŒçš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> entrydate <span class="hljs-operator">&gt;</span> (<span class="hljs-keyword">select</span> entrydate <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;æ–¹ä¸œç™½&#x27;</span>);<br></code></pre></td></tr></table></figure><h6 id="åˆ—å­æŸ¥è¯¢"><a href="#åˆ—å­æŸ¥è¯¢" class="headerlink" title="åˆ—å­æŸ¥è¯¢"></a>åˆ—å­æŸ¥è¯¢</h6><p>å­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯ä¸€åˆ—ï¼ˆå¯ä»¥æ˜¯å¤šè¡Œï¼‰ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºåˆ—å­æŸ¥è¯¢ã€‚</p><p>å¸¸ç”¨çš„æ“ä½œç¬¦ï¼šIN ã€NOT IN ã€ ANY ã€SOME ã€ ALL  </p><table><thead><tr><th>æ“ä½œç¬¦</th><th>æè¿°</th></tr></thead><tbody><tr><td>IN</td><td>åœ¨æŒ‡å®šçš„é›†åˆèŒƒå›´ä¹‹å†…ï¼Œå¤šé€‰ä¸€</td></tr><tr><td>NOT IN</td><td>ä¸åœ¨æŒ‡å®šçš„é›†åˆèŒƒå›´ä¹‹å†…</td></tr><tr><td>ANY</td><td>å­æŸ¥è¯¢è¿”å›åˆ—è¡¨ä¸­ï¼Œæœ‰ä»»æ„ä¸€ä¸ªæ»¡è¶³å³å¯</td></tr><tr><td>SOME</td><td>ä¸ANYç­‰åŒï¼Œä½¿ç”¨SOMEçš„åœ°æ–¹éƒ½å¯ä»¥ä½¿ç”¨ANY</td></tr><tr><td>ALL</td><td>å­æŸ¥è¯¢è¿”å›åˆ—è¡¨çš„æ‰€æœ‰å€¼éƒ½å¿…é¡»æ»¡è¶³</td></tr></tbody></table><p>æ¡ˆä¾‹</p><p>æŸ¥è¯¢ â€œé”€å”®éƒ¨â€ å’Œ â€œå¸‚åœºéƒ¨â€ çš„æ‰€æœ‰å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;é”€å”®éƒ¨&#x27;</span> <span class="hljs-keyword">or</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¸‚åœºéƒ¨&#x27;</span>;<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> dept_id <span class="hljs-keyword">in</span>  (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;é”€å”®éƒ¨&#x27;</span> <span class="hljs-keyword">or</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¸‚åœºéƒ¨&#x27;</span>);<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢æ¯” è´¢åŠ¡éƒ¨ æ‰€æœ‰äººå·¥èµ„éƒ½é«˜çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;è´¢åŠ¡éƒ¨&#x27;</span>;<br><br><span class="hljs-keyword">select</span> salary <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> dept_id <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;è´¢åŠ¡éƒ¨&#x27;</span>)<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">all</span> ( <span class="hljs-keyword">select</span> salary <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> dept_id <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;è´¢åŠ¡éƒ¨&#x27;</span>) );<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢æ¯”ç ”å‘éƒ¨å…¶ä¸­ä»»æ„ä¸€äººå·¥èµ„é«˜çš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span> salary <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> dept_id <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;ç ”å‘éƒ¨&#x27;</span>)<br><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span> salary <span class="hljs-operator">&gt;</span> <span class="hljs-keyword">any</span> ( <span class="hljs-keyword">select</span> salary <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> dept_id <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span> id <span class="hljs-keyword">from</span> dept <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span><span class="hljs-string">&#x27;ç ”å‘éƒ¨&#x27;</span>) );<br></code></pre></td></tr></table></figure><h6 id="è¡Œå­æŸ¥è¯¢"><a href="#è¡Œå­æŸ¥è¯¢" class="headerlink" title="è¡Œå­æŸ¥è¯¢"></a>è¡Œå­æŸ¥è¯¢</h6><p>å­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯ä¸€è¡Œï¼ˆå¯ä»¥æ˜¯å¤šåˆ—ï¼‰ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºè¡Œå­æŸ¥è¯¢ã€‚</p><p>å¸¸ç”¨çš„æ“ä½œç¬¦ï¼š&#x3D; ã€&lt;&gt; ã€IN ã€NOT IN  </p><p>æ¡ˆä¾‹:</p><p>A. æŸ¥è¯¢ä¸ â€œå¼ æ— å¿Œâ€ çš„è–ªèµ„åŠç›´å±é¢†å¯¼ç›¸åŒçš„å‘˜å·¥ä¿¡æ¯ ;  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">select</span>  salary,managerid <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¼ æ— å¿Œ&#x27;</span>;<br><br><span class="hljs-keyword">select</span>  <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> emp <span class="hljs-keyword">where</span>  (salary,managerid) <span class="hljs-operator">=</span> (<span class="hljs-keyword">select</span>  salary,managerid <span class="hljs-keyword">from</span>  emp <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¼ æ— å¿Œ&#x27;</span>);<br></code></pre></td></tr></table></figure><h6 id="è¡¨å­æŸ¥è¯¢"><a href="#è¡¨å­æŸ¥è¯¢" class="headerlink" title="è¡¨å­æŸ¥è¯¢"></a>è¡¨å­æŸ¥è¯¢</h6><p>å­æŸ¥è¯¢è¿”å›çš„ç»“æœæ˜¯å¤šè¡Œå¤šåˆ—ï¼Œè¿™ç§å­æŸ¥è¯¢ç§°ä¸ºè¡¨å­æŸ¥è¯¢ã€‚</p><p>å¸¸ç”¨çš„æ“ä½œç¬¦ï¼šIN  </p><p>æ¡ˆä¾‹</p><p>æŸ¥è¯¢ä¸ â€œé¹¿æ–å®¢â€ , â€œå®‹è¿œæ¡¥â€ çš„èŒä½å’Œè–ªèµ„ç›¸åŒçš„å‘˜å·¥ä¿¡æ¯  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select  job,salary from emp where name = &#x27;é¹¿æ–å®¢&#x27; or  name = &#x27;å®‹è¿œæ¡¥&#x27;;<br><br>select  * from emp where (job,salary) in (select  job,salary from emp where name = &#x27;é¹¿æ–å®¢&#x27; or  name = &#x27;å®‹è¿œæ¡¥&#x27;);<br></code></pre></td></tr></table></figure><p>æŸ¥è¯¢å…¥èŒæ—¥æœŸæ˜¯ â€œ2006-01-01â€ ä¹‹åçš„å‘˜å·¥ä¿¡æ¯ , åŠå…¶éƒ¨é—¨ä¿¡æ¯  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">select * from emp where entrydate &gt; &#x27;2006-01-01&#x27;;<br><br>select e.*,d.* from (select * from emp where entrydate &gt; &#x27;2006-01-01&#x27;) e left join  dept d on e.dept_id=d.id;<br></code></pre></td></tr></table></figure><h5 id="å¤šè¡¨æŸ¥è¯¢-1"><a href="#å¤šè¡¨æŸ¥è¯¢-1" class="headerlink" title="å¤šè¡¨æŸ¥è¯¢"></a>å¤šè¡¨æŸ¥è¯¢</h5><p>æ•°æ®å‡†å¤‡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">create table salgrade(<br>grade int,<br>losal int,<br>hisal int<br>) comment &#x27;è–ªèµ„ç­‰çº§è¡¨&#x27;;<br>insert into salgrade values (1,0,3000);<br>insert into salgrade values (2,3001,5000);<br>insert into salgrade values (3,5001,8000);<br>insert into salgrade values (4,8001,10000);<br>insert into salgrade values (5,10001,15000);<br>insert into salgrade values (6,15001,20000);<br>insert into salgrade values (7,20001,25000);<br>insert into salgrade values (8,25001,30000);<br></code></pre></td></tr></table></figure><h4 id="äº‹åŠ¡"><a href="#äº‹åŠ¡" class="headerlink" title="äº‹åŠ¡"></a>äº‹åŠ¡</h4><p>äº‹åŠ¡ç®€ä»‹</p><p>äº‹åŠ¡ æ˜¯ä¸€ç»„æ“ä½œçš„é›†åˆï¼Œå®ƒæ˜¯ä¸€ä¸ªä¸å¯åˆ†å‰²çš„å·¥ä½œå•ä½ï¼Œäº‹åŠ¡ä¼šæŠŠæ‰€æœ‰çš„æ“ä½œä½œä¸ºä¸€ä¸ªæ•´ä½“ä¸€èµ·å‘ç³»</p><p>ç»Ÿæäº¤æˆ–æ’¤é”€æ“ä½œè¯·æ±‚ï¼Œå³è¿™äº›æ“ä½œè¦ä¹ˆåŒæ—¶æˆåŠŸï¼Œè¦ä¹ˆåŒæ—¶å¤±è´¥ã€‚  </p><blockquote><p>æ³¨æ„ï¼š é»˜è®¤MySQLçš„äº‹åŠ¡æ˜¯è‡ªåŠ¨æäº¤çš„ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œå½“æ‰§è¡Œå®Œä¸€æ¡DMLè¯­å¥æ—¶ï¼ŒMySQLä¼šç«‹å³éš<br>å¼çš„æäº¤äº‹åŠ¡ã€‚  </p></blockquote><h5 id="äº‹åŠ¡æ“ä½œ"><a href="#äº‹åŠ¡æ“ä½œ" class="headerlink" title="äº‹åŠ¡æ“ä½œ"></a>äº‹åŠ¡æ“ä½œ</h5><p>æ•°æ®å‡†å¤‡ï¼š  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">drop table if exists account;<br>create table account(<br>id int primary key AUTO_INCREMENT comment &#x27;ID&#x27;,<br>name varchar(10) comment &#x27;å§“å&#x27;,<br>money double(10,2) comment &#x27;ä½™é¢&#x27;<br>) comment &#x27;è´¦æˆ·è¡¨&#x27;;<br><br>insert into account(name, money) VALUES (&#x27;å¼ ä¸‰&#x27;,2000), (&#x27;æå››&#x27;,2000);<br></code></pre></td></tr></table></figure><p>æ§åˆ¶äº‹åŠ¡ä¸€</p><p>1). æŸ¥çœ‹&#x2F;è®¾ç½®äº‹åŠ¡æäº¤æ–¹å¼</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">SELECT</span> @<span class="hljs-variable">@autocommit</span> ;<br><span class="hljs-keyword">SET</span> @<span class="hljs-variable">@autocommit</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span> ;<br></code></pre></td></tr></table></figure><p>2). æäº¤äº‹åŠ¡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">COMMIT</span>;<br></code></pre></td></tr></table></figure><p>3). å›æ»šäº‹</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ROLLBACK</span>;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šä¸Šè¿°çš„è¿™ç§æ–¹å¼ï¼Œæˆ‘ä»¬æ˜¯ä¿®æ”¹äº†äº‹åŠ¡çš„è‡ªåŠ¨æäº¤è¡Œä¸º, æŠŠé»˜è®¤çš„è‡ªåŠ¨æäº¤ä¿®æ”¹ä¸ºäº†æ‰‹åŠ¨æäº¤, æ­¤æ—¶æˆ‘ä»¬æ‰§è¡Œçš„DMLè¯­å¥éƒ½ä¸ä¼šæäº¤, éœ€è¦æ‰‹åŠ¨çš„æ‰§è¡Œcommitè¿›è¡Œæäº¤ã€‚</p></blockquote><p>6.2.3 æ§åˆ¶äº‹åŠ¡äºŒ</p><p>1). å¼€å¯äº‹åŠ¡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">START</span> TRANSACTION æˆ– <span class="hljs-keyword">BEGIN</span> ;<br></code></pre></td></tr></table></figure><p>2). æäº¤äº‹åŠ¡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">COMMIT</span>;<br></code></pre></td></tr></table></figure><p>3). å›æ»šäº‹åŠ¡</p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">ROLLBACK</span>;<br></code></pre></td></tr></table></figure><p>è½¬è´¦æ¡ˆä¾‹ï¼š  </p><figure class="highlight sql"><table><tr><td class="code"><pre><code class="hljs sql"><span class="hljs-comment">-- å¼€å¯äº‹åŠ¡</span><br><span class="hljs-keyword">start</span> transaction<br><span class="hljs-comment">-- 1. æŸ¥è¯¢å¼ ä¸‰ä½™é¢</span><br><span class="hljs-keyword">select</span> <span class="hljs-operator">*</span> <span class="hljs-keyword">from</span> account <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¼ ä¸‰&#x27;</span>;<br><span class="hljs-comment">-- 2. å¼ ä¸‰çš„ä½™é¢å‡å°‘1000</span><br><span class="hljs-keyword">update</span> account <span class="hljs-keyword">set</span> money <span class="hljs-operator">=</span> money <span class="hljs-operator">-</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;å¼ ä¸‰&#x27;</span>;<br><span class="hljs-comment">-- 3. æå››çš„ä½™é¢å¢åŠ 1000</span><br><span class="hljs-keyword">update</span> account <span class="hljs-keyword">set</span> money <span class="hljs-operator">=</span> money <span class="hljs-operator">+</span> <span class="hljs-number">1000</span> <span class="hljs-keyword">where</span> name <span class="hljs-operator">=</span> <span class="hljs-string">&#x27;æå››&#x27;</span>;<br><span class="hljs-comment">-- å¦‚æœæ­£å¸¸æ‰§è¡Œå®Œæ¯•, åˆ™æäº¤äº‹åŠ¡</span><br><span class="hljs-keyword">commit</span>;<br><span class="hljs-comment">-- å¦‚æœæ‰§è¡Œè¿‡ç¨‹ä¸­æŠ¥é”™, åˆ™å›æ»šäº‹åŠ¡</span><br><span class="hljs-comment">-- rollback;</span><br></code></pre></td></tr></table></figure><h5 id="äº‹åŠ¡å››å¤§ç‰¹æ€§"><a href="#äº‹åŠ¡å››å¤§ç‰¹æ€§" class="headerlink" title="äº‹åŠ¡å››å¤§ç‰¹æ€§"></a>äº‹åŠ¡å››å¤§ç‰¹æ€§</h5><p>åŸå­æ€§ï¼ˆAtomicityï¼‰ï¼šäº‹åŠ¡æ˜¯ä¸å¯åˆ†å‰²çš„æœ€å°æ“ä½œå•å…ƒï¼Œè¦ä¹ˆå…¨éƒ¨æˆåŠŸï¼Œè¦ä¹ˆå…¨éƒ¨å¤±è´¥ã€‚</p><p>ä¸€è‡´æ€§ï¼ˆConsistencyï¼‰ï¼šäº‹åŠ¡å®Œæˆæ—¶ï¼Œå¿…é¡»ä½¿æ‰€æœ‰çš„æ•°æ®éƒ½ä¿æŒä¸€è‡´çŠ¶æ€ã€‚</p><p>éš”ç¦»æ€§ï¼ˆIsolationï¼‰ï¼šæ•°æ®åº“ç³»ç»Ÿæä¾›çš„éš”ç¦»æœºåˆ¶ï¼Œä¿è¯äº‹åŠ¡åœ¨ä¸å—å¤–éƒ¨å¹¶å‘æ“ä½œå½±å“çš„ç‹¬ç«‹ç¯å¢ƒä¸‹è¿è¡Œã€‚</p><p>æŒä¹…æ€§ï¼ˆDurabilityï¼‰ï¼šäº‹åŠ¡ä¸€æ—¦æäº¤æˆ–å›æ»šï¼Œå®ƒå¯¹æ•°æ®åº“ä¸­çš„æ•°æ®çš„æ”¹å˜å°±æ˜¯æ°¸ä¹…çš„ã€‚</p><p>ä¸Šè¿°å°±æ˜¯äº‹åŠ¡çš„å››å¤§ç‰¹æ€§ï¼Œç®€ç§°ACID  </p><h5 id="å¹¶å‘äº‹åŠ¡é—®é¢˜"><a href="#å¹¶å‘äº‹åŠ¡é—®é¢˜" class="headerlink" title="å¹¶å‘äº‹åŠ¡é—®é¢˜"></a>å¹¶å‘äº‹åŠ¡é—®é¢˜</h5><p>èµƒè¯»ï¼šä¸€ä¸ªäº‹åŠ¡è¯»åˆ°å¦å¤–ä¸€ä¸ªäº‹åŠ¡è¿˜æ²¡æœ‰æäº¤çš„æ•°æ®ã€‚  </p><p>ä¸å¯é‡å¤è¯»ï¼šä¸€ä¸ªäº‹åŠ¡å…ˆåè¯»å–åŒä¸€æ¡è®°å½•ï¼Œä½†ä¸¤æ¬¡è¯»å–çš„æ•°æ®ä¸åŒï¼Œç§°ä¹‹ä¸ºä¸å¯é‡å¤è¯»ã€‚  </p><p>å¹»è¯»ï¼šä¸€ä¸ªäº‹åŠ¡æŒ‰ç…§æ¡ä»¶æŸ¥è¯¢æ•°æ®æ—¶ï¼Œæ²¡æœ‰å¯¹åº”çš„æ•°æ®è¡Œï¼Œä½†æ˜¯åœ¨æ’å…¥æ•°æ®æ—¶ï¼Œåˆå‘ç°è¿™è¡Œæ•°æ®å·²ç»å­˜åœ¨ï¼Œå¥½åƒå‡ºç°äº† â€œå¹»å½±â€  </p><h5 id="äº‹åŠ¡éš”ç¦»çº§åˆ«"><a href="#äº‹åŠ¡éš”ç¦»çº§åˆ«" class="headerlink" title="äº‹åŠ¡éš”ç¦»çº§åˆ«"></a>äº‹åŠ¡éš”ç¦»çº§åˆ«</h5><p>ä¸ºäº†è§£å†³å¹¶å‘äº‹åŠ¡æ‰€å¼•å‘çš„é—®é¢˜ï¼Œåœ¨æ•°æ®åº“ä¸­å¼•å…¥äº†äº‹åŠ¡éš”ç¦»çº§åˆ«ã€‚ä¸»è¦æœ‰ä»¥ä¸‹å‡ ç§  </p><table><thead><tr><th>éš”ç¦»çº§åˆ«</th><th>è„è¯»</th><th>ä¸å¯é‡å¤è¯»</th><th>å¹»è¯»</th></tr></thead><tbody><tr><td>Read uncommitted</td><td>âˆš</td><td>âˆš</td><td>âˆš</td></tr><tr><td>Read committed</td><td>Ã—</td><td>âˆš</td><td>âˆš</td></tr><tr><td>Repeatable Read(é»˜è®¤)</td><td>Ã—</td><td>Ã—</td><td>âˆš</td></tr><tr><td>Serializable</td><td>Ã—</td><td>Ã—</td><td>Ã—</td></tr></tbody></table><p>æŸ¥çœ‹äº‹åŠ¡éš”ç¦»çº§åˆ«  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SELECT @@TRANSACTION_ISOLATION;<br></code></pre></td></tr></table></figure><p>è®¾ç½®äº‹åŠ¡éš”ç¦»çº§åˆ«  </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">SET [ SESSION | GLOBAL ] TRANSACTION ISOLATION LEVEL &#123; READ UNCOMMITTED | READ COMMITTED | REPEATABLE READ | SERIALIZABLE &#125;<br></code></pre></td></tr></table></figure><blockquote><p>æ³¨æ„ï¼šäº‹åŠ¡éš”ç¦»çº§åˆ«è¶Šé«˜ï¼Œæ•°æ®è¶Šå®‰å…¨ï¼Œä½†æ˜¯æ€§èƒ½è¶Šä½ã€‚  </p></blockquote>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå®‰è£…mysqlæ•°æ®åº“</title>
      <link href="/post/3b301983.html"/>
      <url>/post/3b301983.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linuxå®‰è£…MySQLæ•°æ®åº“"><a href="#Linuxå®‰è£…MySQLæ•°æ®åº“" class="headerlink" title="Linuxå®‰è£…MySQLæ•°æ®åº“"></a>Linuxå®‰è£…MySQLæ•°æ®åº“</h2><h3 id="1-ç¯å¢ƒå‡†å¤‡"><a href="#1-ç¯å¢ƒå‡†å¤‡" class="headerlink" title="1. ç¯å¢ƒå‡†å¤‡"></a>1. ç¯å¢ƒå‡†å¤‡</h3><ul><li><p>äº‘æœåŠ¡å™¨æˆ–è€…è™šæ‹Ÿæœº</p></li><li><p>Linuxçš„ç‰ˆæœ¬ä¸ºCentOS7æˆ–è€…Redhat;</p></li></ul><h3 id="2-ä¸‹è½½å®‰è£…åŒ…"><a href="#2-ä¸‹è½½å®‰è£…åŒ…" class="headerlink" title="2. ä¸‹è½½å®‰è£…åŒ…"></a>2. ä¸‹è½½å®‰è£…åŒ…</h3><p>â€‹        <a href="https://downloads.mysql.com/archives/community/">ä¸‹è½½åœ°å€</a></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303141045132.png" alt="image-20230314104539009"> </p><h3 id="3-ä¸Šä¼ å®‰è£…åŒ…"><a href="#3-ä¸Šä¼ å®‰è£…åŒ…" class="headerlink" title="3. ä¸Šä¼ å®‰è£…åŒ…"></a>3. ä¸Šä¼ å®‰è£…åŒ…</h3><h3 id="4-åˆ›å»ºç›®å½•-amp-å¹¶è§£å‹"><a href="#4-åˆ›å»ºç›®å½•-amp-å¹¶è§£å‹" class="headerlink" title="4. åˆ›å»ºç›®å½•&amp;å¹¶è§£å‹"></a>4. åˆ›å»ºç›®å½•&amp;å¹¶è§£å‹</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">mkdir</span> mysql<br><br>tar -xvf mysql-8.0.26-1.el7.x86_64.rpm-bundle.tar -C mysql<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202303141047704.png" alt="image-20230314104754614"></p><h3 id="5-å®‰è£…mysqlçš„å®‰è£…åŒ…"><a href="#5-å®‰è£…mysqlçš„å®‰è£…åŒ…" class="headerlink" title="5. å®‰è£…mysqlçš„å®‰è£…åŒ…"></a>5. å®‰è£…mysqlçš„å®‰è£…åŒ…</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cd</span> mysql<br><br>rpm -ivh mysql-community-common-8.0.26-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-client-plugins-8.0.26-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-libs-8.0.26-1.el7.x86_64.rpm <br>rpm -ivh mysql-community-libs-compat-8.0.26-1.el7.x86_64.rpm<br>yum install openssl-devel<br>rpm -ivh  mysql-community-devel-8.0.26-1.el7.x86_64.rpm<br>rpm -ivh mysql-community-client-8.0.26-1.el7.x86_64.rpm<br>rpm -ivh  mysql-community-server-8.0.26-1.el7.x86_64.rpm<br><br><span class="hljs-comment">#å®‰è£…æ—¶å€™ å¯èƒ½éœ€è¦æœ‰äº›ä¾èµ–å®‰è£…åŒ…ï¼Œå¯ä»¥ç›´æ¥æ‰§è¡Œå¦‚ä¸‹å‘½ä»¤</span><br>rpm -Uvh *.rpm --nodeps --force<br></code></pre></td></tr></table></figure><h3 id="6-å¯åŠ¨MySQLæœåŠ¡"><a href="#6-å¯åŠ¨MySQLæœåŠ¡" class="headerlink" title="6. å¯åŠ¨MySQLæœåŠ¡"></a>6. å¯åŠ¨MySQLæœåŠ¡</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-comment">#å¯åŠ¨</span><br>systemctl start mysqld<br><span class="hljs-comment">#é‡å¯</span><br>systemctl restart mysqld<br><span class="hljs-comment">#åœæœåŠ¡</span><br>systemctl stop mysqld<br><span class="hljs-comment">#æŸ¥è¯¢mysqlçŠ¶æ€</span><br>systemctl status mysqld<br><br></code></pre></td></tr></table></figure><h3 id="7-æŸ¥è¯¢è‡ªåŠ¨ç”Ÿæˆçš„rootç”¨æˆ·å¯†ç "><a href="#7-æŸ¥è¯¢è‡ªåŠ¨ç”Ÿæˆçš„rootç”¨æˆ·å¯†ç " class="headerlink" title="7. æŸ¥è¯¢è‡ªåŠ¨ç”Ÿæˆçš„rootç”¨æˆ·å¯†ç "></a>7. æŸ¥è¯¢è‡ªåŠ¨ç”Ÿæˆçš„rootç”¨æˆ·å¯†ç </h3><p>ä½¿ç”¨rpmå®‰è£…æ—¶å€™ï¼Œä¼šè‡ªåŠ¨ç»™rootç”Ÿæˆå¯†ç ï¼Œæˆ‘ä»¬å¯ä»¥é€šè¿‡æŸ¥è¯¢mysqlå¯åŠ¨æ—¥å¿—ï¼ŒæŸ¥çœ‹è‡ªåŠ¨ç”Ÿæˆçš„å¯†ç </p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">cat</span>  /var/log/mysqld.log  | grep -C 2 <span class="hljs-string">&#x27;temporary password&#x27;</span><br></code></pre></td></tr></table></figure><p>å‘½ä»¤è¡Œæ‰§è¡ŒæŒ‡ä»¤ :</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mysql -u root -p<br></code></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥ä¸Šè¿°æŸ¥è¯¢åˆ°çš„è‡ªåŠ¨ç”Ÿæˆçš„å¯†ç , å®Œæˆç™»å½• </p><h3 id="8-ä¿®æ”¹rootç”¨æˆ·å¯†ç "><a href="#8-ä¿®æ”¹rootç”¨æˆ·å¯†ç " class="headerlink" title="8. ä¿®æ”¹rootç”¨æˆ·å¯†ç "></a>8. ä¿®æ”¹rootç”¨æˆ·å¯†ç </h3><p>ç™»å½•åˆ°MySQLä¹‹åï¼Œéœ€è¦å°†è‡ªåŠ¨ç”Ÿæˆçš„ä¸ä¾¿è®°å¿†çš„å¯†ç ä¿®æ”¹äº†ï¼Œä¿®æ”¹æˆè‡ªå·±ç†Ÿæ‚‰çš„ä¾¿äºè®°å¿†çš„å¯†ç ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">ALTER  USER  <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;localhost&#x27;</span>  IDENTIFIED BY <span class="hljs-string">&#x27;1234&#x27;</span>;<br></code></pre></td></tr></table></figure><p>æ‰§è¡Œä¸Šè¿°çš„SQLä¼šæŠ¥é”™ï¼ŒåŸå› æ˜¯å› ä¸ºè®¾ç½®çš„å¯†ç å¤ªç®€å•ï¼Œå¯†ç å¤æ‚åº¦ä¸å¤Ÿã€‚æˆ‘ä»¬å¯ä»¥è®¾ç½®å¯†ç çš„å¤æ‚åº¦ä¸ºç®€å•ç±»å‹ï¼Œå¯†ç é•¿åº¦ä¸º4ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">set</span> global validate_password.policy = 0;<br><span class="hljs-built_in">set</span> global validate_password.length = 4;<br></code></pre></td></tr></table></figure><p>é™ä½å¯†ç çš„æ ¡éªŒè§„åˆ™ä¹‹åï¼Œå†æ¬¡æ‰§è¡Œä¸Šè¿°ä¿®æ”¹å¯†ç çš„æŒ‡ä»¤ã€‚</p><h3 id="9-åˆ›å»ºç”¨æˆ·"><a href="#9-åˆ›å»ºç”¨æˆ·" class="headerlink" title="9. åˆ›å»ºç”¨æˆ·"></a>9. åˆ›å»ºç”¨æˆ·</h3><p>é»˜è®¤çš„rootç”¨æˆ·åªèƒ½å½“å‰èŠ‚ç‚¹localhostè®¿é—®ï¼Œæ˜¯æ— æ³•è¿œç¨‹è®¿é—®çš„ï¼Œæˆ‘ä»¬è¿˜éœ€è¦åˆ›å»ºä¸€ä¸ªrootè´¦æˆ·ï¼Œç”¨æˆ·è¿œç¨‹è®¿é—®</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">create user <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span> IDENTIFIED WITH mysql_native_password BY <span class="hljs-string">&#x27;1234&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="10-å¹¶ç»™rootç”¨æˆ·åˆ†é…æƒé™"><a href="#10-å¹¶ç»™rootç”¨æˆ·åˆ†é…æƒé™" class="headerlink" title="10. å¹¶ç»™rootç”¨æˆ·åˆ†é…æƒé™"></a>10. å¹¶ç»™rootç”¨æˆ·åˆ†é…æƒé™</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">grant all on *.* to <span class="hljs-string">&#x27;root&#x27;</span>@<span class="hljs-string">&#x27;%&#x27;</span>;<br></code></pre></td></tr></table></figure><h3 id="11-é‡æ–°è¿æ¥MySQL"><a href="#11-é‡æ–°è¿æ¥MySQL" class="headerlink" title="11. é‡æ–°è¿æ¥MySQL"></a>11. é‡æ–°è¿æ¥MySQL</h3><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">mysql -u root -p<br></code></pre></td></tr></table></figure><p>ç„¶åè¾“å…¥å¯†ç </p>]]></content>
      
      
      <categories>
          
          <category> Mysql </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Mysql </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxåˆ›å»ºæŒ‡å®šå¤§å°æ–‡ä»¶</title>
      <link href="/post/6757b0f7.html"/>
      <url>/post/6757b0f7.html</url>
      
        <content type="html"><![CDATA[<p>åœ¨ä½¿ç”¨Linuxæ—¶å€™ï¼Œç»å¸¸ä½¿ç”¨ç”¨ touch å‘½ä»¤åˆ›å»ºä¸€ä¸ªç©ºæ–‡ä»¶ã€‚å½“æˆ‘ä»¬æ’é™¤æ•…éšœæˆ–æƒ³åœ¨æŸäº›ç‰¹å®šåœºæ™¯ä¸­è¿›è¡Œæµ‹è¯•æ—¶ï¼Œæˆ‘ä»¬å¯èƒ½éœ€è¦ç‰¹å®šå¤§å°çš„å¤§æ–‡ä»¶ï¼Œæ¯”å¦‚1024MB æˆ–5GBå¤§å°çš„æ–‡ä»¶ï¼Œä¸‹é¢ä»‹ç»å‡ ç§å¸¸ç”¨çš„æ–¹æ³•</p><h3 id="ä½¿ç”¨-dd-å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶"><a href="#ä½¿ç”¨-dd-å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨ dd å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶"></a>ä½¿ç”¨ dd å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶</h3><p>dd å‘½ä»¤ç”¨äºå¤åˆ¶å’Œè½¬æ¢æ–‡ä»¶</p><p>dd å‘½ä»¤æ˜¯å®é™…å†™å…¥ç¡¬ç›˜ï¼Œæ–‡ä»¶äº§ç”Ÿçš„é€Ÿåº¦å–å†³äºç¡¬ç›˜çš„è¯»å†™é€Ÿåº¦ï¼Œæ ¹æ®æ–‡ä»¶çš„å¤§å°ï¼Œè¯¥å‘½ä»¤å°†éœ€è¦ä¸€äº›æ—¶é—´æ‰èƒ½å®Œæˆã€‚</p><p>å‡è®¾æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ªåä¸ºtest.img çš„ 2 GB å¤§å°çš„æ–‡æœ¬æ–‡ä»¶ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">dd</span> <span class="hljs-keyword">if</span>=/dev/zero of=test1.txt bs=2G count=1<br></code></pre></td></tr></table></figure><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash">[root@chen tmp]<span class="hljs-comment"># dd if=/dev/zero of=text.img bs=2G count=1  #å‘½ä»¤</span><br>0+1 records <span class="hljs-keyword">in</span><br>0+1 records out<br>2147479552 bytes (2.1 GB) copied, 94.4318 s, 22.7 MB/s<br>[root@cjweichen tmp]<span class="hljs-comment"># ls -lh text.img        #æŸ¥çœ‹æ–‡ä»¶å¤§å°</span><br>-rw-r--r-- 1 root root 2.0G Dec  8 10:46 text.img<br></code></pre></td></tr></table></figure><p>æˆ‘ä»¬å¯ä»¥æ ¹æ®éœ€è¦æ¥æ›´æ”¹å—å¤§å°å’Œå—æ•°ã€‚ä¾‹å¦‚ï¼Œå¯ä»¥ä½¿ç”¨ bs&#x3D;1M å’Œ count&#x3D;1024 æ¥è·å¾— 1024 Mb çš„æ–‡ä»¶ã€‚</p><h3 id="ä½¿ç”¨-truncate-å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶"><a href="#ä½¿ç”¨-truncate-å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨ truncate å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶"></a>ä½¿ç”¨ truncate å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶</h3><p>truncate å‘½ä»¤å°†ä¸€ä¸ªæ–‡ä»¶ç¼©å°æˆ–è€…æ‰©å±•åˆ°æ‰€éœ€å¤§å°ã€‚ä½¿ç”¨ -s é€‰é¡¹æ¥æŒ‡å®šæ–‡ä»¶çš„å¤§å°ï¼Œæ‰§è¡Œé€Ÿåº¦ä¼šå¿«äº›</p><p>æˆ‘ä»¬ä½¿ç”¨ truncare å‘½ä»¤æ¥åˆ›å»ºä¸€ä¸ª 2GB å¤§å°çš„æ–‡ä»¶ã€‚</p><figure class="highlight bash"><table><tr><td class="code"><pre><code class="hljs bash"><span class="hljs-built_in">truncate</span> -s  2G test2.txt<br></code></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨<code>ls -lh test2.txt </code>å‘½ä»¤æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶ã€‚</p><p>é»˜è®¤æƒ…å†µä¸‹ï¼Œå¦‚æœè¯·æ±‚çš„è¾“å‡ºæ–‡ä»¶ä¸å­˜åœ¨ï¼Œtruncate å‘½ä»¤å°†åˆ›å»ºæ–°æ–‡ä»¶ã€‚æˆ‘ä»¬å¯ä»¥ä½¿ç”¨ -c é€‰é¡¹æ¥é¿å…åˆ›å»ºæ–°æ–‡ä»¶ã€‚</p><h3 id="ä½¿ç”¨-fallocate-å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶"><a href="#ä½¿ç”¨-fallocate-å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶" class="headerlink" title="ä½¿ç”¨ fallocate å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶"></a>ä½¿ç”¨ fallocate å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶</h3><p>fallocate å‘½ä»¤åˆ›å»ºå¤§æ–‡ä»¶çš„æ–¹æ³•ï¼Œåˆ›å»ºå¤§æ–‡ä»¶çš„é€Ÿåº¦æ˜¯ä¸‰ä¸ªä¸­æœ€å¿«çš„ã€‚</p><p>å‡è®¾æˆ‘ä»¬è¦åˆ›å»ºä¸€ä¸ª2 GB çš„æ–‡ä»¶ï¼Œå¯ä»¥æ‰§è¡Œä»¥ä¸‹æ“ä½œï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">fallocate -l 2G  test3.txt <br></code></pre></td></tr></table></figure><p>å¯ä»¥ä½¿ç”¨<code>ls -lh test3.txt </code>æŸ¥çœ‹ç”Ÿæˆçš„æ–‡ä»¶ã€‚</p><h3 id="ç»“è®º"><a href="#ç»“è®º" class="headerlink" title="ç»“è®º"></a>ç»“è®º</h3><p>dd å’Œ truncate åˆ›å»ºçš„æ–‡ä»¶æ˜¯ç¨€ç–æ–‡ä»¶ã€‚åœ¨è®¡ç®—æœºä¸–ç•Œä¸­ï¼Œç¨€ç–æ–‡ä»¶æ˜¯ä¸€ç§ç‰¹æ®Šæ–‡ä»¶ï¼Œå…·æœ‰ä¸åŒçš„è¡¨è§‚æ–‡ä»¶å¤§å°ï¼ˆå®ƒä»¬å¯ä»¥æ‰©å±•åˆ°çš„æœ€å¤§å¤§å°ï¼‰å’ŒçœŸå®æ–‡ä»¶å¤§å°ï¼ˆä¸ºç£ç›˜ä¸Šçš„æ•°æ®åˆ†é…äº†å¤šå°‘ç©ºé—´ï¼‰ã€‚</p><p>fallocate å‘½ä»¤åˆ™ä¸ä¼šåˆ›å»ºç¨€ç–æ–‡ä»¶ï¼Œè€Œä¸”å®ƒçš„é€Ÿåº¦æ›´å¿«ï¼Œè¿™ä¹Ÿæ˜¯æˆ‘æ¯”è¾ƒæ¨èä½¿ç”¨ fallocate åˆ›å»ºå¤§æ–‡ä»¶çš„åŸå› ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linuxå®‰è£…NodeJS</title>
      <link href="/post/fe4ed47c.html"/>
      <url>/post/fe4ed47c.html</url>
      
        <content type="html"><![CDATA[<h2 id="Linuxå®‰è£…NodeJS"><a href="#Linuxå®‰è£…NodeJS" class="headerlink" title="Linuxå®‰è£…NodeJS"></a>Linuxå®‰è£…NodeJS</h2><blockquote><p>Node.js  æ˜¯ä¸€ä¸ªåŸºäºChrome V8 å¼•æ“ JavaScript è¿è¡Œæ—¶ç¯å¢ƒï¼Œ <a href="https://nodejs.org/zh-cn/download/">nodejs å®˜ç½‘</a></p></blockquote><h3 id="ä¸‹è½½å®‰è£…åŒ…"><a href="#ä¸‹è½½å®‰è£…åŒ…" class="headerlink" title="ä¸‹è½½å®‰è£…åŒ…"></a>ä¸‹è½½å®‰è£…åŒ…</h3><p><strong>1ï¼Œå¯ä»¥åœ¨å®˜ç½‘æ§åˆ¶å°ä¸‹è½½ä¸Šä¼ è‡³æœåŠ¡å™¨</strong></p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/202209031802065.png" alt="image-20220409115051104"></p><p><strong>2ï¼Œæˆ–è€…ä½¿ç”¨å‘½ä»¤ç›´æ¥ä¸‹è½½</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@xxx ~/nodejs]# wget https://nodejs.org/dist/v16.14.2/node-v16.14.2-linux-x64.tar.xz   // ä¸‹è½½<br>[root@xxx ~/nodejs]# tar xf  node-v16.14.2-linux-x64.tar.xz        // è§£å‹<br>[root@xxx ~/nodejs]# cd nnode-v16.14.2-linux-x64/                  // è¿›å…¥è§£å‹ç›®å½•<br></code></pre></td></tr></table></figure><blockquote><p> <a href="https://nodejs.org/dist/">å†å²ç‰ˆæœ¬ä¸‹è½½</a>  </p></blockquote><h3 id="ä½¿ç”¨RZä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹"><a href="#ä½¿ç”¨RZä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹" class="headerlink" title="ä½¿ç”¨RZä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹"></a>ä½¿ç”¨RZä¸Šä¼ åˆ°æœåŠ¡å™¨å¹¶è§£å‹</h3><blockquote><p>Linuxçš„szå’Œrzå‘½ä»¤ï¼Œå¯ä½¿ç”¨yumå‘½ä»¤å®‰è£…ï¼šyum install -y lrzsz</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@xxx ~/nodejs]# pwd<br>/root/nodejs<br>[root@xxx ~/nodejs]# ls -lrt<br>total 21428<br>-rw-rw-rw- 1 root root 21941244 Apr  9 11:52 node-v16.14.2-linux-x64.tar.xz<br>[root@xxx ~/nodejs]# tar -xvf node-v16.14.2-linux-x64.tar.xz <br>[root@xxx ~/nodejs]# cd /usr/local/<br>[root@xxx /usr/local]# ls<br>bin  etc  games  include  lib  lib64  libexec  lost+found  qcloud  sa  sbin  share  src<br>[root@xxx /usr/local]# mv /root/nodejs/node-v16.14.2-linux-x64 .<br>[root@xxx /usr/local]# mv node-v16.14.2-linux-x64/ nodejs <br></code></pre></td></tr></table></figure><h3 id="é…ç½®ç¯å¢ƒå˜é‡"><a href="#é…ç½®ç¯å¢ƒå˜é‡" class="headerlink" title="é…ç½®ç¯å¢ƒå˜é‡"></a>é…ç½®ç¯å¢ƒå˜é‡</h3><p><strong>æ–¹å¼ä¸€ï¼šç¯å¢ƒå˜é‡</strong></p><p>ã€€1ï¼‰ã€åŠ å…¥ç¯å¢ƒå˜é‡ï¼Œåœ¨ &#x2F;etc&#x2F;profile æ–‡ä»¶æœ«å°¾å¢åŠ é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">vi /etc/profile<br>export PATH=$PATH:/usr/local/nodejs/bin<br></code></pre></td></tr></table></figure><p>ã€€2ï¼‰ã€æ‰§è¡Œå‘½ä»¤ä½¿é…ç½®æ–‡ä»¶ç”Ÿæ•ˆ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">source /etc/profile<br></code></pre></td></tr></table></figure><p><strong>æ–¹å¼äºŒï¼šè½¯é“¾æ¥æ–¹å¼</strong></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ln -s /usr/local/nodejs/bin/npm /usr/local/bin/<br>ln -s /usr/local/nodejs/bin/node /usr/local/bin/<br></code></pre></td></tr></table></figure><h3 id="éªŒè¯"><a href="#éªŒè¯" class="headerlink" title="éªŒè¯"></a>éªŒè¯</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">[root@xxx /usr/local]# node -v<br>v16.14.2<br>[root@xxx /usr/local]# npm -v<br>8.5.0<br></code></pre></td></tr></table></figure><h3 id="Npm-æ›´æ¢æ·˜å®é•œåƒ"><a href="#Npm-æ›´æ¢æ·˜å®é•œåƒ" class="headerlink" title="Npm æ›´æ¢æ·˜å®é•œåƒ"></a>Npm æ›´æ¢æ·˜å®é•œåƒ</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm config set registry https://registry.npm.taobao.org<br>npm install<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Linux </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Linux </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Front-matteråŸºæœ¬ä½¿ç”¨</title>
      <link href="/post/265fa930.html"/>
      <url>/post/265fa930.html</url>
      
        <content type="html"><![CDATA[<h2 id="Front-matter-è¯´æ˜"><a href="#Front-matter-è¯´æ˜" class="headerlink" title="Front-matter è¯´æ˜"></a>Front-matter è¯´æ˜</h2><p>Front-matter æ˜¯ markdown æ–‡ä»¶æœ€ä¸Šæ–¹ä»¥ â€”  åˆ†éš”çš„åŒºåŸŸï¼Œç”¨äºæŒ‡å®šä¸ªåˆ«æ–‡ä»¶çš„å˜é‡ã€‚</p><ul><li>Page Front-matter  ç”¨äºé¡µé¢é…ç½®</li><li>Post Front-matter  ç”¨äºæ–‡ç« é¡µé…ç½®</li></ul><p>Hexo æœ‰ä¸‰ç§é»˜è®¤å¸ƒå±€ï¼š<code>post</code>ã€<code>page</code> å’Œ <code>draft</code>åœ¨åˆ›å»ºè€…ä¸‰ç§ä¸åŒç±»å‹çš„æ–‡ä»¶æ—¶ï¼Œå®ƒä»¬å°†ä¼šè¢«ä¿å­˜åˆ°ä¸åŒçš„è·¯å¾„ï¼›è€Œæ‚¨è‡ªå®šä¹‰çš„å…¶ä»–å¸ƒå±€å’Œ <code>post</code> ç›¸åŒï¼Œéƒ½å°†å‚¨å­˜åˆ° <code>source/_posts</code> æ–‡ä»¶å¤¹ã€‚</p><table><thead><tr><th>å¸ƒå±€</th><th>è·¯å¾„</th></tr></thead><tbody><tr><td><code>post</code></td><td><code>source/_posts</code></td></tr><tr><td><code>page</code></td><td><code>source</code></td></tr><tr><td><code>draft</code></td><td><code>source/_drafts</code></td></tr></tbody></table><blockquote><p>å¦‚æœä½ ä¸æƒ³ä½ çš„æ–‡ç« è¢«å¤„ç†ï¼Œä½ å¯ä»¥å°† Front-Matter ä¸­çš„<code>layout:</code> è®¾ä¸º <code>false</code> ã€‚</p></blockquote><h2 id="Butterfly-Front-matter"><a href="#Butterfly-Front-matter" class="headerlink" title="Butterfly  Front-matter"></a>Butterfly  Front-matter</h2><h3 id="Post-Front-matter"><a href="#Post-Front-matter" class="headerlink" title="Post Front-matter"></a>Post Front-matter</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">---<br>title:<br>date:<br>updated:<br>tags:<br>categories:<br>keywords:<br>description:<br>top_img:<br>comments:<br>cover:<br>toc:<br>toc_number:<br>toc_style_simple:<br>copyright:<br>copyright_author:<br>copyright_author_href:<br>copyright_url:<br>copyright_info:<br>mathjax:<br>katex:<br>aplayer:<br>highlight_shrink:<br>aside:<br>---<br></code></pre></td></tr></table></figure><table><thead><tr><th>å†™æ³•</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>title</td><td>ã€å¿…éœ€ã€‘æ–‡ç« æ ‡é¢˜</td></tr><tr><td>date</td><td>ã€å¿…éœ€ã€‘æ–‡ç« åˆ›å»ºæ—¥æœŸ</td></tr><tr><td>updated</td><td>ã€å¯é€‰ã€‘æ–‡ç« æ›´æ–°æ—¥æœŸ</td></tr><tr><td>tags</td><td>ã€å¯é€‰ã€‘æ–‡ç« æ ‡ç±¤</td></tr><tr><td>categories</td><td>ã€å¯é€‰ã€‘æ–‡ç« åˆ†ç±»</td></tr><tr><td>keywords</td><td>ã€å¯é€‰ã€‘æ–‡ç« å…³é”®å­—</td></tr><tr><td>description</td><td>ã€å¯é€‰ã€‘æ–‡ç« æè¿°</td></tr><tr><td>top_img</td><td>ã€å¯é€‰ã€‘æ–‡ç« é¡¶éƒ¨å›¾ç‰‡</td></tr><tr><td>cover</td><td>ã€å¯é€‰ã€‘æ–‡ç« ç¼©ç•¥å›¾(å¦‚æœæ²¡æœ‰è®¾ç½®top_img,æ–‡ç« é¡µé¡¶éƒ¨å°†æ˜¾ç¤ºç¼©ç•¥å›¾ï¼Œå¯è®¾ä¸ºfalse&#x2F;å›¾ç‰‡åœ°å€&#x2F;ç•™ç©º)</td></tr><tr><td>comments</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºæ–‡ç« è¯„è®ºæ¨¡å—(é»˜è®¤ true)</td></tr><tr><td>toc</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºæ–‡ç« TOC(é»˜è®¤ä¸ºè®¾ç½®ä¸­tocçš„enableé…ç½®)</td></tr><tr><td>toc_number</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºtoc_number(é»˜è®¤ä¸ºè®¾ç½®ä¸­tocçš„numberé…ç½®)</td></tr><tr><td>toc_style_simple</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤º toc ç®€æ´æ¨¡å¼</td></tr><tr><td>copyright</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºæ–‡ç« ç‰ˆæƒæ¨¡å—(é»˜è®¤ä¸ºè®¾ç½®ä¸­post_copyrightçš„enableé…ç½®)</td></tr><tr><td>copyright_author</td><td>ã€å¯é€‰ã€‘æ–‡ç« ç‰ˆæƒæ¨¡å—çš„æ–‡ç« ä½œè€…</td></tr><tr><td>copyright_author_href</td><td>ã€å¯é€‰ã€‘æ–‡ç« ç‰ˆæƒæ¨¡å—çš„æ–‡ç« ä½œè€…é“¾æ¥</td></tr><tr><td>copyright_url</td><td>ã€å¯é€‰ã€‘æ–‡ç« ç‰ˆæƒæ¨¡å—çš„æ–‡ç« è¿ç»“é“¾æ¥</td></tr><tr><td>copyright_info</td><td>ã€å¯é€‰ã€‘æ–‡ç« ç‰ˆæƒæ¨¡å—çš„ç‰ˆæƒå£°æ˜æ–‡å­—</td></tr><tr><td>mathjax</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºmathjax(å½“è®¾ç½®mathjaxçš„per_page: falseæ—¶ï¼Œæ‰éœ€è¦é…ç½®ï¼Œé»˜è®¤ false)</td></tr><tr><td>katex</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºkatex(å½“è®¾ç½®katexçš„per_page:  falseæ—¶ï¼Œæ‰éœ€è¦é…ç½®ï¼Œé»˜è®¤ false)</td></tr><tr><td>aplayer</td><td>ã€å¯é€‰ã€‘åœ¨éœ€è¦çš„é¡µé¢åŠ è½½aplayerçš„jså’Œcss,è¯·å‚è€ƒæ–‡ç« ä¸‹é¢çš„éŸ³ä¹ é…ç½®</td></tr><tr><td>highlight_shrink</td><td>ã€å¯é€‰ã€‘é…ç½®ä»£ç æ¡†æ˜¯å¦å±•å¼€(true&#x2F;false)(é»˜è®¤ä¸ºè®¾ç½®ä¸­highlight_shrinkçš„é…ç½®)</td></tr><tr><td>aside</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºä¾§è¾¹æ  (é»˜è®¤ true)</td></tr></tbody></table><h3 id="Page-Front-matter"><a href="#Page-Front-matter" class="headerlink" title="Page Front-matter"></a>Page Front-matter</h3><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">---<br>title:<br>date:<br>updated:<br>type:<br>comments:<br>description:<br>keywords:<br>top_img:<br>mathjax:<br>katex:<br>aside:<br>aplayer:<br>highlight_shrink:<br>#############################################<br>---<br><br></code></pre></td></tr></table></figure><table><thead><tr><th>å†™æ³•</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>title</td><td>ã€å¿…éœ€ã€‘é¡µé¢æ ‡é¢˜</td></tr><tr><td>date</td><td>ã€å¿…éœ€ã€‘é¡µé¢åˆ›å»ºæ—¥æœŸ</td></tr><tr><td>type</td><td>ã€å¿…éœ€ã€‘æ ‡ç±¤ã€åˆ†ç±»å’Œå‹æƒ…é“¾æ¥ä¸‰ä¸ªé¡µé¢éœ€è¦é…ç½®</td></tr><tr><td>updated</td><td>ã€å¯é€‰ã€‘é¡µé¢æ›´æ–°æ—¥æœŸ</td></tr><tr><td>description</td><td>ã€å¯é€‰ã€‘é¡µé¢æè¿°</td></tr><tr><td>keywords</td><td>ã€å¯é€‰ã€‘é¡µé¢å…³é”®å­—</td></tr><tr><td>comments</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºé¡µé¢è¯„è®ºæ¨¡å—(é»˜è®¤ true)</td></tr><tr><td>top_img</td><td>ã€å¯é€‰ã€‘é¡µé¢é¡¶éƒ¨å›¾ç‰‡</td></tr><tr><td>mathjax</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºmathjax(å½“è®¾ç½®mathjaxçš„per_page: falseæ—¶ï¼Œæ‰éœ€è¦é…ç½®ï¼Œé»˜è®¤ false)</td></tr><tr><td>katex</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºkatex(å½“è®¾ç½®katexçš„per_page: falseæ—¶ï¼Œæ‰éœ€è¦é…ç½®ï¼Œé»˜è®¤ false)</td></tr><tr><td>aside</td><td>ã€å¯é€‰ã€‘æ˜¾ç¤ºä¾§è¾¹æ  (é»˜è®¤ true)</td></tr><tr><td>aplayer</td><td>ã€å¯é€‰ã€‘åœ¨éœ€è¦çš„é¡µé¢åŠ è½½aplayerçš„jså’Œcss,è¯·å‚è€ƒæ–‡ç« ä¸‹é¢çš„éŸ³ä¹ é…ç½®</td></tr><tr><td>highlight_shrink</td><td>ã€å¯é€‰ã€‘é…ç½®ä»£ç æ¡†æ˜¯å¦å±•å¼€(true&#x2F;false)(é»˜è®¤ä¸ºè®¾ç½®ä¸­highlight_shrinkçš„é…ç½®)</td></tr></tbody></table>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>hexo-butterflyä¸»é¢˜</title>
      <link href="/post/e56702c9.html"/>
      <url>/post/e56702c9.html</url>
      
        <content type="html"><![CDATA[<p><strong>å†™åœ¨å‰è¨€</strong></p><blockquote><p>æœ¬æ–‡ä¸»è¦è®°å½•ä¸‹Hexoä½¿ç”¨butterflyä¸»é¢˜ä¼˜åŒ–çš„ä¸€äº›æ“ä½œï¼Œä¾¿äºåç»­å¯å¯»å¯æŸ¥ï¼Œé¦–å…ˆæ„Ÿè°¢butterflyä¸»é¢˜å®˜æ–¹æä¾›è€…</p></blockquote><h2 id="butterflyä¸»é¢˜"><a href="#butterflyä¸»é¢˜" class="headerlink" title="butterflyä¸»é¢˜"></a>butterflyä¸»é¢˜</h2><blockquote><p><a href="https://github.com/jerryc127/hexo-theme-butterfly">hexo-theme-melodyå®˜æ–¹ä»‹ç» </a></p><p>If you are in Mainland China, you can download in <a href="https://gitee.com/immyw/hexo-theme-butterfly.git">Gitee</a></p></blockquote><h3 id="ä¸‹è½½å®‰è£…ä¸»é¢˜"><a href="#ä¸‹è½½å®‰è£…ä¸»é¢˜" class="headerlink" title="ä¸‹è½½å®‰è£…ä¸»é¢˜"></a>ä¸‹è½½å®‰è£…ä¸»é¢˜</h3><p>1ï¼Œåœ¨ä½ çš„ <strong>Hexo æ ¹ç›®</strong>ä½¿ç”¨gitå¯ä»¥ç›´æ¥ä¸‹è½½</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">git clone -b master https://github.com/jerryc127/hexo-theme-butterfly.git themes/butterfly<br></code></pre></td></tr></table></figure><p>æˆ–è€…NPMå®‰è£…</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm i hexo-theme-butterfly<br></code></pre></td></tr></table></figure><p>2ï¼Œåœ¨hexoå·¥ä½œæ–‡ä»¶å¤¹çš„æ ¹é…ç½®æ–‡ä»¶_config.ymlä¸­è®¾ç½®ä¸»é¢˜</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Extensions<br>## Plugins: https://hexo.io/plugins/<br>## Themes: https://hexo.io/themes/<br>theme: butterfly<br></code></pre></td></tr></table></figure><p>3ï¼Œæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤æµ‹è¯•çœ‹æ˜¯å¦å®‰è£…æˆåŠŸï¼ˆéœ€è¦åœ¨hexoä¸»é¢˜æ ¹ç›®å½•æ‰§è¡Œï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo clean<br>hexo d<br>hexo server<br></code></pre></td></tr></table></figure><h3 id="ä¸»é¢˜é¡µé¢è®¾ç½®"><a href="#ä¸»é¢˜é¡µé¢è®¾ç½®" class="headerlink" title="ä¸»é¢˜é¡µé¢è®¾ç½®"></a>ä¸»é¢˜é¡µé¢è®¾ç½®</h3><h4 id="æ ‡ç­¾é¡µ"><a href="#æ ‡ç­¾é¡µ" class="headerlink" title="æ ‡ç­¾é¡µ"></a>æ ‡ç­¾é¡µ</h4><ol><li>å‰å¾€ä½ çš„ Hexo åšå®¢çš„æ ¹ç›®å½•</li><li>è¾“å…¥ hexo new page tags</li><li>ä½ ä¼šæ‰¾åˆ°source&#x2F;tags&#x2F;index.mdè¿™ä¸ªæ–‡ä»¶</li><li>ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼š</li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo new page tags<br></code></pre></td></tr></table></figure><p>â€‹5. æ·»åŠ æ·»åŠ  type: â€œtagsâ€</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">---<br>title: æ ‡ç­¾<br>date: 2022-08-23 00:17:54<br>type: &quot;tags&quot;<br>---<br></code></pre></td></tr></table></figure><h4 id="åˆ†ç±»é¡µ"><a href="#åˆ†ç±»é¡µ" class="headerlink" title="åˆ†ç±»é¡µ"></a>åˆ†ç±»é¡µ</h4><ol><li><p>å‰å¾€ä½ çš„ Hexo åšå®¢çš„æ ¹ç›®å½•</p></li><li><p>è¾“å…¥hexo new page categories</p></li><li><p>ä½ ä¼šæ‰¾åˆ°source&#x2F;categories&#x2F;index.mdè¿™å€‹æ–‡ä»¶</p></li><li><p>ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼š</p></li><li><p>è®°å¾—æ·»åŠ  type: â€œcategoriesâ€</p></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#hexo new page categories<br>---<br>title: åˆ†ç±»<br>date: 2022-08-23 00:20:08<br>type: &quot;categories&quot;<br>---<br></code></pre></td></tr></table></figure><h4 id="å‹æƒ…é“¾æ¥"><a href="#å‹æƒ…é“¾æ¥" class="headerlink" title="å‹æƒ…é“¾æ¥"></a>å‹æƒ…é“¾æ¥</h4><ol><li><p>å‰å¾€ä½ çš„ Hexo åšå®¢çš„æ ¹ç›®éŒ„</p></li><li><p>è¾“å…¥ hexo new page link</p></li><li><p>ä½ ä¼šæ‰¾åˆ°source&#x2F;link&#x2F;index.mdé€™å€‹æ–‡ä»¶</p></li><li><p>ä¿®æ”¹è¿™ä¸ªæ–‡ä»¶ï¼š</p></li><li><p>è¨˜å¾—æ·»åŠ  type: â€œlinkâ€</p></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#hexo new page link<br>---<br>title: å‹æƒ…é“¾æ¥<br>date: 2022-08-23 00:23:12<br>type: &quot;link&quot;<br>---<br></code></pre></td></tr></table></figure><p>   6ï¼Œå‹æƒ…é“¾æ¥æ·»åŠ </p><p>åœ¨Hexoåšå®¢ç›®å½•ä¸­çš„source&#x2F;_dataï¼ˆå¦‚æœæ²’æœ‰ _data æ–‡ä»¶å¤¾ï¼Œè¯·è‡ªè¡Œåˆ›å»ºï¼‰ï¼Œåˆ›å»ºä¸€ä¸ªæ–‡ä»¶link.yml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">- class_name: å‹æƒ…é“¾æ¥<br>  class_desc: è®°å½•ç”Ÿæ´»ï¼Œå­¦ä¹ ç‚¹æ»´<br>  link_list:<br>    - name: Hexo<br>      link: https://hexo.io/zh-tw/<br>      avatar: https://d33wubrfki0l68.cloudfront.net/6657ba50e702d84afb32fe846bed54fba1a77add/827ae/logo.svg<br>      descr: å¿«é€Ÿã€ç®€å•ä¸”å¼ºè°ƒçš„åšå®¢æ¡†æ¶<br><br>- class_name: ç½‘ç«™<br>  class_desc: å€¼å¾—æ¨èçš„ç½‘ç«™<br>  link_list:<br>    - name: Youtube<br>      link: https://www.youtube.com/<br>      avatar: https://i.loli.net/2020/05/14/9ZkGg8v3azHJfM1.png<br>      descr: è§†é¢‘ç½‘ç«™<br>    - name: Weibo<br>      link: https://www.weibo.com/<br>      avatar: https://i.loli.net/2020/05/14/TLJBum386vcnI1P.png<br>      descr: ä¸­å›½æœ€å¤§ç¤¾äº¤åˆ†äº«å¹³å°<br>    - name: Twitter<br>      link: https://twitter.com/<br>      avatar: https://i.loli.net/2020/05/14/5VyHPQqR6LWF39a.png<br>      descr: ç¤¾äº¤åˆ†äº«å¹³å°<br></code></pre></td></tr></table></figure><p>class_name å’Œ class_desc æ”¯æŒ html æ ¼å¼ï¼Œå¦‚ä¸éœ€è¦ï¼Œä¹Ÿå¯ä»¥ç•™ç©ºã€‚</p><h4 id="ç›¸å†Œ"><a href="#ç›¸å†Œ" class="headerlink" title="ç›¸å†Œ"></a>ç›¸å†Œ</h4><p>å›¾åº“é¡µé¢æ˜¯ä¸€ä¸ªæ™®é€šçš„é¡µé¢æŒ‚åœ¨å›¾ç‰‡ä¿¡æ¯æ¦‚å¿µï¼Œå…·ä½“æ„å»ºå¦‚ä¸‹æ‰€ç¤º</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#hexo new page photos<br># åœ¨source/photos/index.mdæ–‡ä»¶ä¸­ï¼šä½¿ç”¨æ ‡ç­¾å¤–æŒ‚galleryGroup<br><br>&lt;div class=&quot;gallery-group-main&quot;&gt;<br>&#123;% galleryGroup &#x27;å£çº¸&#x27; &#x27;æ”¶è—çš„ä¸€äº›å£ç´™&#x27; &#x27;/photos/wallpaper&#x27; https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/3.jpg %&#125;<br>&#123;% galleryGroup &#x27;åŠ¨æ¼«&#x27; &#x27;å…³äºåŠ¨æ¼«çš„å›¾ç‰‡&#x27; &#x27;/photos/comic&#x27;    https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/timg3.jpg %&#125;<br>&lt;/div&gt;<br><br></code></pre></td></tr></table></figure><h5 id="å­é¡µé¢"><a href="#å­é¡µé¢" class="headerlink" title="å­é¡µé¢"></a>å­é¡µé¢</h5><p>å­ä¹Ÿé¢ä¹Ÿæ˜¯æ™®é€šçš„ä¹Ÿé¢ï¼Œä½ åªéœ€è¦hexo new  page xxxxx åˆ›å»ºä½ çš„ä¹Ÿé¢å°±è¡Œ</p><p>ç„¶åä½¿ç”¨æ ‡ç­¾å¤–æŒ‚ galleryï¼Œå…·ä½“ç”¨æ³•è¯·æŸ¥çœ‹å¯¹åº”çš„å…§å®¹ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># åˆ›å»ºå­é¡µé¢<br>hexo new page daily<br><br># åœ¨æŒ‡å®šsource/daily/index.mdæ–‡ä»¶ä¸­å¤–æŒ‚gallery<br>&#123;% gallery %&#125;<br>![](https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/timg.jpg)<br>![](https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220826125722620.png)<br>&#123;% endgallery %&#125;<br></code></pre></td></tr></table></figure><h4 id="404é¡µé¢"><a href="#404é¡µé¢" class="headerlink" title="404é¡µé¢"></a>404é¡µé¢</h4><p>ä¸»é¡Œå…§ç½®äº†ä¸€å€‹ç®€å•çš„404é¡µé¢ï¼Œå¯åœ¨è¨­ç½®ä¸­å¼€å¯</p><p>åœ¨ä¸»é¢˜_config.ymlé…ç½®æ–‡ä»¶ï¼ŒæŸ¥çœ‹404é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># A simple 404 page<br>error_404:<br>  enable: true<br>  subtitle: &#x27;Page Not Found&#x27;<br>  background: https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220823004052578.png<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220823004052578.png" alt="image-20220823004052578"></p><h4 id="å…¶ä»–é¡µé¢"><a href="#å…¶ä»–é¡µé¢" class="headerlink" title="å…¶ä»–é¡µé¢"></a>å…¶ä»–é¡µé¢</h4><p>åŒç†ï¼Œä½¿ç”¨ç›¸åŒçš„æ–¹å¼åˆ›å»ºï¼Œæˆ‘è¿™è¾¹åˆ›å»ºæœ‰å¦‚ä¸‹é¡µé¢</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo new page   archives  #å½’æ¡£<br>hexo new page   messageboard #ç•™è¨€æ¿<br>hexo new page   music     #éŸ³ä¹<br>hexo new page   movies    #ç”µå½±<br>hexo new page   game      #æ¸¸æˆ<br>hexo new page   book      #ä¹¦ç±<br>hexo new page   about     #å…³äºæˆ‘<br></code></pre></td></tr></table></figure><h3 id="ç«™ç‚¹ä¸»é¢˜è®¾ç½®"><a href="#ç«™ç‚¹ä¸»é¢˜è®¾ç½®" class="headerlink" title="ç«™ç‚¹ä¸»é¢˜è®¾ç½®"></a>ç«™ç‚¹ä¸»é¢˜è®¾ç½®</h3><h4 id="è¯­è¨€"><a href="#è¯­è¨€" class="headerlink" title="è¯­è¨€"></a>è¯­è¨€</h4><p>ä¿®æ”¹ç«™ç‚¹<strong>Hexoæ ¹ç›®å½•</strong>é…ç½®æ–‡ä»¶ _config.yml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">é»˜è®¤æ˜¯ en<br><br>ä¸»é¡Œæ”¯æŒä¸‰ç§è¯­éŸ³<br><br>default(en)<br>zh-CN (ç®€ä½“ä¸­æ–‡)<br>zh-TW (ç¹ä½“ä¸­æ–‡)<br></code></pre></td></tr></table></figure><h4 id="ç½‘ç«™èµ„æ–™"><a href="#ç½‘ç«™èµ„æ–™" class="headerlink" title="ç½‘ç«™èµ„æ–™"></a>ç½‘ç«™èµ„æ–™</h4><p>ä¿®æ”¹ç«™ç‚¹å„ç§èµ„æ–™ï¼Œä¾‹å¦‚æ ‡é¢˜ã€å‰¯æ ‡é¢˜å’Œé‚®ç®±ç­‰ä¸ªäººèµ„æ–™ï¼Œè¯·ä¿®æ”¹åšå®¢<strong>æ ¹ç›®å½•</strong>çš„_config.yml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Site<br>title: &#x27;JingWei Chen&#x27;<br>subtitle: &#x27;&#x27;<br>description: &#x27;æŠ¬å¤´ï¼Œå¾®ç¬‘ï¼Œä½ å¥½&#x27;<br>keywords: kubernetes<br>author: JingWei Chen<br>language: zh-CN<br>timezone: &#x27;Asia/Shanghai&#x27;<br></code></pre></td></tr></table></figure><h4 id="å¯¼èˆªèœå•"><a href="#å¯¼èˆªèœå•" class="headerlink" title="å¯¼èˆªèœå•"></a>å¯¼èˆªèœå•</h4><p>ä¿®æ”¹ä¸»é¢˜çš„é…ç½®æ–‡ä»¶ä½äºthemes&#x2F;butterfly&#x2F;_config.yaml</p><blockquote><p>å‰é¢åˆ— æ–‡å­—å¯è‡ªè¡Œæ›´æ”¹ï¼Œé»˜è®¤æ˜¯è‹±æ–‡çš„ï¼Œç”¨æˆ·å¯ä»¥æ ¹æ®éœ€æ±‚ä¿®æ”¹æˆä¸­æ–‡ ï¼Œç¤ºä¾‹å¦‚ä¸‹</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">menu:<br>   é¦–é¡µ: / || fas fa-home<br>   å½’æ¡£: /archives/ || fas fa-archive<br>   æ ‡ç­¾: /tags/ || fas fa-tags<br>   åˆ†ç±»: /categories/ || fas fa-folder-open<br>   ç•™è¨€æ¿: /messageboard/ || fa fa-paper-plane<br>   å‹é“¾: /link/ || fas fa-link<br>   å¨±ä¹ || fas fa-list||hide:<br>     éŸ³ä¹: /music/  || fas fa-music<br>     ç”µå½±: /movies/ || fas fa-video<br>     æ¸¸æˆ: /game/   || fas fa-gamepad<br>     ç›¸å†Œ: /photos/ || fa fa-camera-retro<br>     ç”µå­ä¹¦: /book/ ||  fa fa-book<br>   å…³äºæˆ‘: /about/ || fas fa-heart<br></code></pre></td></tr></table></figure><p>å¿…é¡»æ˜¯ &#x2F;xxx&#x2F;ï¼Œåé¢||åˆ†å¼€ï¼Œç„¶åå†™å›¾æ ‡åï¼Œå¦‚æœä¸å¸Œæœ›æ˜¾ç¤ºå›¾æ ‡ï¼Œå›¾æ ‡åå¯ä¸å†™ã€‚</p><p>é»˜è®¤å­ç›®å½•æ˜¯å±•å¼€ï¼Œå¦‚æœä½ æƒ³è¦éšè—ï¼Œåœ¨å­ç›®å½•é‡Œé¢æ·»åŠ  hide ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">List||fas fa-list||hide:<br>  Music: /music/ || fas fa-music<br>  Movie: /movies/ || fas fa-video<br></code></pre></td></tr></table></figure><h4 id="å‰¯ä¸»é¢˜è®¾ç½®"><a href="#å‰¯ä¸»é¢˜è®¾ç½®" class="headerlink" title="å‰¯ä¸»é¢˜è®¾ç½®"></a>å‰¯ä¸»é¢˜è®¾ç½®</h4><p>å¦‚æœæ²¡è®¾ç½®å‰¯æ ‡é¢˜ï¼Œä¸Šé¢çš„<code>descriptionï¼š</code>ç­¾åï¼Œå°±æ˜¯æ˜¾ç¤ºåœ¨ä¸»é¡µé¢ã€‚è€Œè®¾ç½®çš„è¯ï¼Œ<code>ç­¾å</code>è‡ªåŠ¨ä¸æ˜¾ç¤ºï¼Œ<code>å‰¯æ ‡é¢˜</code>å‡ºç°ã€‚</p><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># the subtitle on homepage (ä¸»é¡µsubtitle)<br>subtitle:<br>  enable: true<br>  # Typewriter Effect (æ‰“å­—æ•ˆæœ)<br>  effect: true<br>  # Effect Speed Options (æ‰“å­—æ•ˆæœé€Ÿåº¦åƒæ•¸)<br>  startDelay: 200 # time before typing starts in milliseconds<br>  typeSpeed: 100 # type speed in milliseconds<br>  backSpeed: 100 # backspacing speed in milliseconds<br>  # loop (å¾ªç¯å­—)<br>  loop: true<br>  # source èª¿ç”¨ç¬¬ä¸‰æ–¹æœå‹™<br>  # source: false é—œé–‰èª¿ç”¨<br>  # source: 1  èª¿ç”¨ä¸€è¨€ç¶²çš„ä¸€å¥è©±ï¼ˆç°¡é«”ï¼‰ https://hitokoto.cn/<br>  # source: 2  èª¿ç”¨ä¸€å¥ç¶²ï¼ˆç°¡é«”ï¼‰ http://yijuzhan.com/<br>  # source: 3  èª¿ç”¨ä»Šæ—¥è©©è©ï¼ˆç°¡é«”ï¼‰ https://www.jinrishici.com/<br>  # subtitle æœƒå…ˆé¡¯ç¤º source , å†é¡¯ç¤º sub çš„å…§å®¹<br>  source: false<br>  # å¦‚æœæ‰“å¼€æ‰“å­—æ•ˆæœï¼Œsubtitle åªæœƒé¡¯ç¤º sub çš„ç¬¬ä¸€è¡Œæ–‡å­—<br>  sub:<br>    - As long as willing to learn, it will be able to learn.<br>    - åªè¦æ„¿æ„å­¦ä¹ ï¼Œå°±ä¸€å®šèƒ½å¤Ÿå­¦ä¼š<br>    - Take learning as a kind of living habits.<br>    - æŠŠå­¦ä¹ å½“æˆä¸€ç§ç”Ÿæ´»ä¹ æƒ¯<br></code></pre></td></tr></table></figure><h5 id="å‰¯æ ‡é¢˜å­—ä½“å¤§å°é¢œè‰²"><a href="#å‰¯æ ‡é¢˜å­—ä½“å¤§å°é¢œè‰²" class="headerlink" title="å‰¯æ ‡é¢˜å­—ä½“å¤§å°é¢œè‰²"></a>å‰¯æ ‡é¢˜å­—ä½“å¤§å°é¢œè‰²</h5><p>åœ¨<code>\themes\butterfly\source\css\_layout</code>ä¸­çš„<code>head.styl</code>:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#site-subtitle<br>    color: var(--white)   #æ­¤å¤„ä¿®æ”¹ä¸ºç™½è‰²<br>    font-size: 1.05em     #å­—ä½“å¤§å°<br><br>    +minWidth768()<br>      font-size: 1.55em   #å­—ä½“å¤§å°<br></code></pre></td></tr></table></figure><h4 id="å›¾ç‰‡è®¾ç½®"><a href="#å›¾ç‰‡è®¾ç½®" class="headerlink" title="å›¾ç‰‡è®¾ç½®"></a>å›¾ç‰‡è®¾ç½®</h4><p>å›¾ç‰‡å¯ä»¥ä½¿ç”¨<code>ç½‘ä¸Šçš„å›¾ç‰‡</code>(å³ä½¿ç”¨è¯¥<code>å›¾ç‰‡é“¾æ¥</code>)ï¼Œä¹Ÿå¯ä»¥ä½¿ç”¨<code>\themes\butterfly\source\img</code>ä¸‹çš„å›¾ç‰‡ã€‚</p><h5 id="ç½‘ç«™å›¾æ ‡"><a href="#ç½‘ç«™å›¾æ ‡" class="headerlink" title="ç½‘ç«™å›¾æ ‡"></a>ç½‘ç«™å›¾æ ‡</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Faviconï¼ˆç½‘ç«™å›¾æ ‡ï¼‰<br>favicon: /img/favicon.png<br></code></pre></td></tr></table></figure><h5 id="ä¸ªäººèµ„æ–™å¤´åƒ"><a href="#ä¸ªäººèµ„æ–™å¤´åƒ" class="headerlink" title="ä¸ªäººèµ„æ–™å¤´åƒ"></a>ä¸ªäººèµ„æ–™å¤´åƒ</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Avatar (å¤´åƒ)<br>avatar:<br>  img: /img/avatar.png<br>  effect: false<br></code></pre></td></tr></table></figure><h5 id="é¦–é¡µé¢å›¾ç‰‡"><a href="#é¦–é¡µé¢å›¾ç‰‡" class="headerlink" title="é¦–é¡µé¢å›¾ç‰‡"></a>é¦–é¡µé¢å›¾ç‰‡</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># The banner image of home page (é¦–é¡µçš„æ¨ªå¹…å›¾åƒ)<br>index_img: /img/index_img.jpg<br></code></pre></td></tr></table></figure><h5 id="å­æ ‡ç­¾é¡µå›¾ç‰‡"><a href="#å­æ ‡ç­¾é¡µå›¾ç‰‡" class="headerlink" title="å­æ ‡ç­¾é¡µå›¾ç‰‡"></a>å­æ ‡ç­¾é¡µå›¾ç‰‡</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># The banner image of archive page<br>archive_img: /img/tag.jpg<br></code></pre></td></tr></table></figure><ol><li>ä¸»é¡µçš„é¡¶éƒ¨å›¾å¯ä»¥åœ¨<code>_config.yml</code>è®¾ç½®<code>index_img</code></li><li>&#96;&#96;archives<code>é¡µçš„é¡¶éƒ¨å›¾å¯ä»¥åœ¨</code>_config.yml<code>è®¾ç½®</code>archive_img&#96;</li><li>å…¶ä»–<code>pageé¡µ</code>çš„é¡¶éƒ¨å›¾å¯ä»¥åœ¨å„è‡ªçš„mdé¡µé¢è®¾ç½®<code>front-matter</code>ä¸­çš„<code>top_img</code></li></ol><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">favicon: /img/favicon.png<br>avatar:<br>  img: /img/tit.png<br>  effect: false<br>index_img: /img/index_img.jpg<br>default_top_img: /img/tag.jpg #è¿™ä¸ªæ¨èï¼šä¸åŠ å…¥å¯èƒ½éƒ¨åˆ†æ ‡ç­¾é¡µä¸å‡ºç°å›¾ç‰‡<br>archive_img: /img/tag.jpg<br>tag_img: /img/tag.jpg<br>category_img: /img/tag.jpg<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« åˆ—è¡¨å›¾ç‰‡"><a href="#æ–‡ç« åˆ—è¡¨å›¾ç‰‡" class="headerlink" title="æ–‡ç« åˆ—è¡¨å›¾ç‰‡"></a>æ–‡ç« åˆ—è¡¨å›¾ç‰‡</h5><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶ &#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cover:<br>  # display the cover or not (æ˜¯å¦æ˜¾ç¤ºæ–‡ç« å°é¢)<br>  index_enable: true<br>  aside_enable: true<br>  archives_enable: true<br>  # the position of cover in home page (å°é¢æ˜¾ç¤ºçš„ä½ç½®)<br>  # left/right/both<br>  position: both<br>  default_cover:<br>  <br>æ–‡ç« å°é¢è®¾ç½®ï¼š<br>ä¸€ä¸ª:<br> default_cover: https://xxxx.jpg<br>å¤šä¸ª:<br>æ­¤æ—¶ä¼šéšæœºé€‰æ‹©ä¸€å¼ <br>  default_cover:<br>     - https://i.loli.net/2020/05/01/xxxxxx.jpg<br>oræ–‡ç« å†…<br></code></pre></td></tr></table></figure><h5 id="å›¾ç‰‡æŸ¥çœ‹å¤§å›¾"><a href="#å›¾ç‰‡æŸ¥çœ‹å¤§å›¾" class="headerlink" title="å›¾ç‰‡æŸ¥çœ‹å¤§å›¾"></a>å›¾ç‰‡æŸ¥çœ‹å¤§å›¾</h5><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶ &#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><p>è¿™æ˜¯ä¸¤ç§<code>æ–¹å¼</code>ï¼Œ<code>åªèƒ½é€‰æ‹©ä¸€ä¸ª</code> æˆ–è€… <code>ä¸¤ä¸ªéƒ½ä¸é€‰</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># medium-zoom<br># https://github.com/francoischalifour/medium-zoom<br>medium_zoom: false<br><br># fancybox<br># http://fancyapps.com/fancybox/3/<br>fancybox: true<br></code></pre></td></tr></table></figure><h5 id="å›¾ç‰‡æ…¢åŠ è½½"><a href="#å›¾ç‰‡æ…¢åŠ è½½" class="headerlink" title="å›¾ç‰‡æ…¢åŠ è½½"></a>å›¾ç‰‡æ…¢åŠ è½½</h5><p>1.æ–°å¢<code>hexo-lazyload-image</code>æ¨¡å—</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install hexo-lazyload-image --save<br></code></pre></td></tr></table></figure><p>2.åœ¨ä¸»ç›®å½•é…ç½®æ–‡ä»¶<code>_config.yml</code>å¢åŠ é…ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">lazyload:<br>  enable: true<br>  loadingImg: /img/loading.gif<br></code></pre></td></tr></table></figure><p>è¿™ä¸ªå°±æ˜¯å›¾ç‰‡æ²¡åŠ è½½å‡ºæ¥çš„æ—¶å€™ï¼Œå‡ºç°ä¸€ä¸ªåŠ¨å›¾è½¬è½¬è½¬ã€‚</p><h5 id="å›¾ç‰‡æè¿°"><a href="#å›¾ç‰‡æè¿°" class="headerlink" title="å›¾ç‰‡æè¿°"></a>å›¾ç‰‡æè¿°</h5><p>å¯å¼€å¯å›¾ç‰‡Figcaptionæè¿°æ–‡å­—æ˜¾ç¤º</p><p>ä¼˜å…ˆæ˜¾ç¤ºçš„ title å±æ€§ï¼Œç„¶å¾Œæ˜¯ alt å±æ€§</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶ ï¼Œé»˜è®¤falseï¼Œè¿™é‡Œä¿æŒé»˜è®¤ä¸ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">photofigcaption: false<br></code></pre></td></tr></table></figure><h4 id="ä»£ç æ¡†"><a href="#ä»£ç æ¡†" class="headerlink" title="ä»£ç æ¡†"></a>ä»£ç æ¡†</h4><h5 id="1ï¼Œä»£ç é«˜äº®ä¸»é¢˜"><a href="#1ï¼Œä»£ç é«˜äº®ä¸»é¢˜" class="headerlink" title="1ï¼Œä»£ç é«˜äº®ä¸»é¢˜"></a>1ï¼Œä»£ç é«˜äº®ä¸»é¢˜</h5><blockquote><p>Butterfly æ”¯æŒ6ç§ä»£ç é«˜äº®æ ·å¼ï¼Œä¿®æ”¹ä¸»é¡Œé…ç½®æ–‡ä»¶</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">darker<br>pale night<br>light<br>ocean<br>mac<br>mac light<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">highlight_theme: light<br></code></pre></td></tr></table></figure><h5 id="2ï¼Œä»£ç å¤åˆ¶"><a href="#2ï¼Œä»£ç å¤åˆ¶" class="headerlink" title="2ï¼Œä»£ç å¤åˆ¶"></a>2ï¼Œä»£ç å¤åˆ¶</h5><blockquote><p>ä¸»é¡Œæ”¯æŒä»£ç å¤åˆ¶åŠŸèƒ½ï¼Œä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">highlight_copy: true<br></code></pre></td></tr></table></figure><h5 id="3ï¼Œ-ä»£ç å±•å¼€å’ŒæŠ˜å "><a href="#3ï¼Œ-ä»£ç å±•å¼€å’ŒæŠ˜å " class="headerlink" title="3ï¼Œ ä»£ç å±•å¼€å’ŒæŠ˜å "></a>3ï¼Œ ä»£ç å±•å¼€å’ŒæŠ˜å </h5><blockquote><p>åœ¨é»˜è®¤æƒ…æ³ä¸‹ï¼Œä»£ç æ¡†è‡ªåŠ¨å±•å¼€ï¼Œå¯è®¾ç½®æ˜¯å¦æ‰€æœ‰ä»£ç æ¡†éƒ½å…³é—­ä¸“é¢˜ï¼Œç‚¹å¼€&gt;å¯å±•å¼€ä»£ç ï¼Œä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶</p></blockquote><ul><li>true å…¨éƒ¨ä»£ç æ¡†ä¸å±•å¼€ï¼Œéœ€ç‚¹å‡»&gt;æ‰“å¼€</li><li>false ä»£ç æ¡†å±•å¼€ï¼Œæœ‰&gt;ç‚¹å‡»æŒ‰éˆ•</li><li>none ä¸æ˜¾ç¤º&gt;æŒ‰éˆ•</li></ul><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">highlight_shrink: true #ä»£ç æ¡†ä¸å±•å¼€ï¼Œéœ€ç‚¹å‡»&gt;æ‰“å¼€<br></code></pre></td></tr></table></figure><blockquote><p>ä½ ä¹Ÿå¯ä»¥åœ¨post&#x2F;pageä¹Ÿå¯¹åº”çš„markdownæ–‡ä»¶front-matteræ·»åŠ highlight_shrinkæ¥ç‹¬ç«‹é…ç½®ã€‚</p><p>å½“ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­çš„ highlight_shrink è®¾ä¸ºtrueæ—¶ï¼Œå¯åœ¨front-matteræ·»åŠ highlight_shrink: falseæ¥å•ç‹¬é…ç½®æ–‡ç« å±•å¼€ä»£ç æ¡†ã€‚</p><p>å½“ä¸»é¢˜é…ç½®æ–‡ä»¶ä¸­çš„ highlight_shrink è®¾ä¸ºfalseæ—¶ï¼Œå¯åœ¨front-matteræ·»åŠ highlight_shrink: trueæ¥å•ç‹¬é…ç½®æ–‡ç« æ”¶ç¸®ä»£ç æ¡†ã€‚</p></blockquote><h5 id="4ï¼Œä»£ç æ¢è¡Œ"><a href="#4ï¼Œä»£ç æ¢è¡Œ" class="headerlink" title="4ï¼Œä»£ç æ¢è¡Œ"></a>4ï¼Œä»£ç æ¢è¡Œ</h5><p>åœ¨é»˜è®¤æƒ…æ³ä¸‹ï¼ŒHexo åœ¨ç¼–è¯‘çš„æ™‚å€™ä¸ä¼šå®ç°ä»£ç è‡ªåŠ¨æ›è¡Œã€‚å¦‚æœä½ ä¸å¸Œæœ›åœ¨ä»£ç å—çš„åŒºåŸŸé‡Œæœ‰æ©«å‘æ»¾åŠ¨æ¢çš„è©±ï¼Œé‚£éº¼ä½ å¯ä»¥è€ƒæ…®å¼€å¯é€™å€‹åŠŸèƒ½ã€‚</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">code_word_wrap: true   #æˆ‘è¿™è¾¹è®¾ç½®çš„æ˜¯false<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ æ˜¯ä½¿ç”¨ highlight æ¸²æŸ“ï¼Œéœ€è¦æ‰¾åˆ°ä½ ç«™ç‚¹çš„ Hexo é…ç½®åšå®¢<strong>æ ¹ç›®å½•</strong>æ–‡ä»¶_config.ymlï¼Œå°‡line_numberæ”¹æˆfalse:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">highlight:<br>  enable: true<br>  line_number: false # &lt;- æ”¹è¿™é‡Œ<br>  auto_detect: false<br>  tab_replace:<br></code></pre></td></tr></table></figure><p>å¦‚æœä½ æ˜¯ä½¿ç”¨ prismjs æ¸²æŸ“ï¼Œéœ€è¦æ‰¾åˆ°ä½ ç«™ç‚¹çš„ Hexoåšå®¢<strong>æ ¹ç›®å½•</strong> é…ç½®æ–‡ä»¶_config.ymlï¼Œå°‡line_numberæ”¹æˆfalse:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">prismjs:<br>  enable: false<br>  preprocess: true<br>  line_number: false # &lt;- æ”¹è¿™é‡Œ<br>  tab_replace: &#x27;&#x27;<br></code></pre></td></tr></table></figure><h5 id="5ï¼Œä»£ç é«˜åº¦è®¾ç½®"><a href="#5ï¼Œä»£ç é«˜åº¦è®¾ç½®" class="headerlink" title="5ï¼Œä»£ç é«˜åº¦è®¾ç½®"></a>5ï¼Œä»£ç é«˜åº¦è®¾ç½®</h5><blockquote><p>3.7.0 åŠä»¥ä¸Šæ”¯æŒ</p><p>æ³¨æ„ï¼šå–®ä½æ˜¯ pxï¼Œç›´æ¥æ·»åŠ æ•¸å­—ï¼Œå¦‚ 200</p><p>å®é™…é™åˆ¶é«˜åº¦ä¸º highlight_height_limit + 30 px å¤šå¢åŠ  30px é™åˆ¶ï¼Œç›®çš„æ˜¯é¿å…ä»£ç é«˜åº¦åªè¶…å‡ºhighlight_height_limit ä¸€ç‚¹æ™‚ï¼Œå‡ºç¾å±•å¼€æŒ‰éˆ•ï¼Œå±•å¼€æ²’å…§å®¹ã€‚</p><p>ä¸é©ç”¨äºéšè—å¾Œçš„ä»£ç å—ï¼ˆ css è¨­ç½® display: noneï¼‰</p></blockquote><p>å¯é…ç½®ä»£ç é«˜åº¦é™åˆ¶ï¼Œè¶…å‡ºçš„éƒ¨åˆ†ä¼šéšè—ï¼Œä¸¦æ˜¾ç¤ºå±•å¼€æŒ‰éˆ•ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">highlight_height_limit: false # unit: px<br></code></pre></td></tr></table></figure><h4 id="ç¤¾äº¤ä¿¡æ¯è®¾ç½®"><a href="#ç¤¾äº¤ä¿¡æ¯è®¾ç½®" class="headerlink" title="ç¤¾äº¤ä¿¡æ¯è®¾ç½®"></a>ç¤¾äº¤ä¿¡æ¯è®¾ç½®</h4><p>Butterflyæ”¯æŒ font-awesome v6å›¾æ ‡.</p><p>ä¹¦å†™æ ¼å¼ å›¾æ ‡åï¼šurl || æè¿°æ€§æ–‡å­—(å¯ä»¥é€‰æ‹©ä½¿ç”¨<code>fa fa-xxx</code>å›¾æ ‡ï¼Œä¹Ÿå¯ä»¥é€‰æ‹©ä½¿ç”¨<code>é˜¿é‡Œiconfont</code>å›¾)</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># social settings (ç¤¾äº¤å›¾æ ‡è®¾ç½®)<br># formal:<br>#   icon: link || the description<br>social:<br>   fab fa-github: https://github.com/chen1900s || Github<br>   fas fa-envelope: chen1900s@163.com || Email<br>   fab fa-qq:  tencent://AddContact/?fromId=45&amp;fromSubId=1&amp;subcmd=all&amp;uin=728831102&amp;website=www.oicqzone.com || QQ<br>   <br></code></pre></td></tr></table></figure><h4 id="ä¸»é¡µæ–‡ç« èŠ‚é€‰"><a href="#ä¸»é¡µæ–‡ç« èŠ‚é€‰" class="headerlink" title="ä¸»é¡µæ–‡ç« èŠ‚é€‰"></a>ä¸»é¡µæ–‡ç« èŠ‚é€‰</h4><p>å› ä¸ºä¸»é¢˜UIçš„å…³ç³»ï¼Œä¸»é¡µæ–‡ç« ç¯€é¸åªæ”¯æŒè‡ªåŠ¨ç¯€é¸å’Œæ–‡ç« é¡µdescriptionã€‚</p><p>åœ¨butterflyé‡Œï¼Œæœ‰å››ç¨®å¯ä¾›é¸æ“‡</p><ol><li><p>descriptionï¼š åªæ˜¾ç¤ºdescription</p></li><li><p>bothï¼š å„ªå…ˆé¸æ“‡descriptionï¼Œå¦‚æœæ²’æœ‰é…ç½®descriptionï¼Œå‰‡æ˜¾ç¤ºè‡ªåŠ¨ç¯€é¸çš„å…§å®¹</p></li><li><p>auto_excerptï¼šåªæ˜¾ç¤ºè‡ªåŠ¨ç¯€é¸</p></li><li><p>falseï¼š ä¸æ˜¾ç¤ºæ–‡ç« å…§å®¹</p></li></ol><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">index_post_content:<br>  method: 2<br>  length: 500 # if you set method to 2 or 3, the length need to config<br></code></pre></td></tr></table></figure><h4 id="é¡¶éƒ¨å›¾"><a href="#é¡¶éƒ¨å›¾" class="headerlink" title="é¡¶éƒ¨å›¾"></a>é¡¶éƒ¨å›¾</h4><blockquote><p>å¦‚æœä¸è¦æ˜¾ç¤ºé¡¶éƒ¨å›¾ï¼Œå¯ç›´æ¥é…ç½® disable_top_img:  true<br>å…¶å®ƒé¡µé¢ ï¼ˆtags&#x2F;categories&#x2F;è‡ªå»ºé¡µé¢ï¼‰å’Œ æ–‡ç« é¡µ çš„ top_img ï¼Œè«‹åˆ°å°æ‡‰çš„ md é¡µé¢è¨­ç½®front-matterä¸­çš„top_img<br>ä»¥ä¸Šæ‰€æœ‰çš„ top_img å¯é…ç½®ä»¥ä¸‹å€¼</p></blockquote><table><thead><tr><th>é…ç½®</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>index_img</td><td>ä¸»é¡µçš„ top_img</td></tr><tr><td>default_top_img</td><td>é»˜è®¤çš„ top_imgï¼Œå½“ä¸»é¡µçš„ top_img  æ²’æœ‰é…ç½®æ—¶ï¼Œä¼šæ˜¾ç¤ºdefault_top_img</td></tr><tr><td>archive_img</td><td>å½’æ¡£é¡µé¢çš„ top_img</td></tr><tr><td>tag_img</td><td>tag    æ ‡ç­¾é¡µé¢çš„ é»˜è®¤ top_img</td></tr><tr><td>tag_per_img</td><td>tag  å­é¡µé¢çš„ top_imgï¼Œå¯é…ç½®æ¯å€‹ tag çš„  top_img</td></tr><tr><td>category_img</td><td>categoryå­é¡µé¢ çš„ é»˜è®¤ top_img</td></tr><tr><td>category_per_img</td><td>category å­é¡µé¢çš„ top_imgï¼Œå¯é…ç½®æ¯å€‹ category çš„ top_img</td></tr></tbody></table><h4 id="æ–‡ç« ç½®é¡¶"><a href="#æ–‡ç« ç½®é¡¶" class="headerlink" title="æ–‡ç« ç½®é¡¶"></a>æ–‡ç« ç½®é¡¶</h4><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">ã€æ¨èã€‘hexo-generator-indexä» 2.0.0 å¼€å§‹ï¼Œå·²ç¶“æ”¯æŒæ–‡ç« ç½®é ‚åŠŸèƒ½ã€‚ä½ å¯ä»¥ç›´æ¥åœ¨æ–‡ç« çš„front-matteråŒºåŸŸé‡Œæ·»åŠ sticky: 1å±æ€§æ¥æŠŠé€™ç¯‡æ–‡ç« ç½®é ‚ã€‚æ•¸å€¼è¶Šå¤§ï¼Œç½®é ‚çš„å„ªå…ˆç´šè¶Šå¤§ã€‚<br></code></pre></td></tr></table></figure><h4 id="æ–‡ç« å°é¢"><a href="#æ–‡ç« å°é¢" class="headerlink" title="æ–‡ç« å°é¢"></a>æ–‡ç« å°é¢</h4><p>æ–‡ç« çš„markdownæ–‡æ¡£ä¸Šï¼Œåœ¨Front-matteræ·»åŠ coverï¼Œå¹¶å¡«ä¸Šè¦æ˜¾ç¤ºçš„å›¾ç‰‡åœ°å€ã€‚å¦‚æœä¸é…ç½®coverï¼Œå¯ä»¥è¨­ç½®æ˜¾ç¤ºé»˜è®¤çš„coverï¼Œå¦‚æœä¸æƒ³åœ¨é¦–é¡µå¤´ç¤ºcover,å¯ä»¥è®¾ç½®ä¸ºfalseï¼Œ</p><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cover:<br>  # æ˜¯å¦æ˜¾ç¤ºæ–‡ç« å°é¢<br>  index_enable: true<br>  aside_enable: true<br>  archives_enable: true<br>  # å°é¢æ˜¾ç¤ºçš„ä½ç½®<br>  # ä¸‰ä¸ªå€¼å¯é…ç½® left , right , both<br>  position: both<br>  # å½“æ²’æœ‰è®¾ç½®coveræ™‚ï¼Œé»˜è®¤çš„å°é¢æ˜¾ç¤º<br>  default_cover: <br></code></pre></td></tr></table></figure><p>å½“é…ç½®å¤šå¼ å›¾ç‰‡æ—¶å€™  ä¼šéšæœºé€‰æ‹©ä¸€å¼ ä½œä¸ºcover.ï¼Œæ­¤æ—¶çš„å†™æ³•ä¸ºï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">default_cover:<br>  - https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg.png<br>  - https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg2.png<br>  - https://fastly.jsdelivr.net/gh/jerryc127/CDN@latest/cover/default_bg3.png<br></code></pre></td></tr></table></figure><h4 id="æ–‡ç« é¡µç›¸å…³é…ç½®"><a href="#æ–‡ç« é¡µç›¸å…³é…ç½®" class="headerlink" title="æ–‡ç« é¡µç›¸å…³é…ç½®"></a>æ–‡ç« é¡µç›¸å…³é…ç½®</h4><h5 id="ç”Ÿæˆæ–‡ç« å”¯ä¸€é“¾æ¥"><a href="#ç”Ÿæˆæ–‡ç« å”¯ä¸€é“¾æ¥" class="headerlink" title="ç”Ÿæˆæ–‡ç« å”¯ä¸€é“¾æ¥"></a>ç”Ÿæˆæ–‡ç« å”¯ä¸€é“¾æ¥</h5><p>Hexoçš„é»˜è®¤æ–‡ç« é“¾æ¥æ ¼å¼æ˜¯å¹´ï¼Œæœˆï¼Œæ—¥ï¼Œæ ‡é¢˜è¿™ç§æ ¼å¼æ¥ç”Ÿæˆçš„ã€‚å¦‚æœä½ çš„æ ‡é¢˜æ˜¯ä¸­æ–‡çš„è¯ï¼Œé‚£ä½ çš„URLé“¾æ¥å°±ä¼šåŒ…å«ä¸­æ–‡ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">permalink: :year/:month/:day/:title<br></code></pre></td></tr></table></figure><p>å‰å¾€ä½ çš„Hexoåšå®¢æ ¹ç›®å½•ï¼Œæ‰“å¼€cmdå‘½ä»¤çª—å£æ‰§è¡Œnpm install hexo-abbrlink â€“save</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install hexo-abbrlink --save<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹ç«™ç‚¹é…ç½®æ–‡ä»¶_config.ymlä¸­permalinkå±æ€§</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">permalink: :year/:month/:day/:title/<br>#ä¿®æ”¹ä¸º<br>permalink: post/:abbrlink.html # postä¸ºè‡ªå®šä¹‰å‰ç¼€<br>abbrlink:<br>  alg: crc32   #ç®—æ³•ï¼š crc16(default) and crc32<br>  rep: hex     #è¿›åˆ¶ï¼š dec(default) and hex<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« metaæ˜¾ç¤º"><a href="#æ–‡ç« metaæ˜¾ç¤º" class="headerlink" title="æ–‡ç« metaæ˜¾ç¤º"></a>æ–‡ç« metaæ˜¾ç¤º</h5><p>è¿™ä¸ªé€‰é¡¹æ˜¯ç”¨æ¥æ˜¾ç¤ºæ–‡ç« çš„ç›¸å…³ä¿¡æ¯çš„ã€‚</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">post_meta:<br>  page:<br>    date_type: both          # created or updated or both ä¸»é¡µæ–‡ç« æ—¥æœŸæ˜¯å‰µå»ºæ—¥æˆ–è€…æ›´æ–°æ—¥æˆ–éƒ½æ˜¾ç¤º<br>    date_format: relative    # date/relative æ˜¾ç¤ºæ—¥æœŸé‚„æ˜¯ç›¸å°æ—¥æœŸ<br>    categories: true         # true or false ä¸»é¡µæ˜¯å¦æ˜¾ç¤ºåˆ†ç±»<br>    tags: true               # true or false ä¸»é¡µæ˜¯å¦æ˜¾ç¤ºæ¨™ç±¤<br>    label: true              # true or false æ˜¾ç¤ºæè¿°æ€§æ–‡å­—<br>  post:<br>    date_type: both           # created or updated or both æ–‡ç« é¡µæ—¥æœŸæ˜¯å‰µå»ºæ—¥æˆ–è€…æ›´æ–°æ—¥æˆ–éƒ½æ˜¾ç¤º<br>    date_format: relative     # date/relative æ˜¾ç¤ºæ—¥æœŸé‚„æ˜¯ç›¸å°æ—¥æœŸ<br>    categories: true          # true or false æ–‡ç« é¡µæ˜¯å¦æ˜¾ç¤ºåˆ†é¡<br>    tags: true                # true or false æ–‡ç« é¡µæ˜¯å¦æ˜¾ç¤ºæ¨™ç±¤<br>    label: true               # true or false æ˜¾ç¤ºæè¿°æ€§æ–‡å­—<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« ç‰ˆæƒ"><a href="#æ–‡ç« ç‰ˆæƒ" class="headerlink" title="æ–‡ç« ç‰ˆæƒ"></a>æ–‡ç« ç‰ˆæƒ</h5><p>ç‚ºä½ çš„åšå®¢æ–‡ç« å±•ç¤ºæ–‡ç« ç‰ˆæƒå’Œè®¸å¯åè®®ã€‚</p><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">post_copyright:<br>  enable: true<br>  decode: false<br>  author_href:<br>  license: CC BY-NC-SA 4.0<br>  license_url: https://creativecommons.org/licenses/by-nc-sa/4.0/<br></code></pre></td></tr></table></figure><p>å¦‚æœæœ‰æ–‡ç« ï¼ˆä¾‹å¦‚ï¼šè½¬è½½æ–‡ç« ï¼‰ä¸éœ€è¦æ˜¾ç¤ºï¼Œå¯ä»¥åœ¨æ–‡ç« Front-matterå•ç‹¬è®¾ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">copyright: false<br></code></pre></td></tr></table></figure><p>ä»3.0.0å¼€å§‹ï¼Œæ”¯æŒå¯¹å•ç‹¬æ–‡ç« è®¾ç½®ç‰ˆæƒä¿¡æ¯ï¼Œå¯ä»¥åœ¨æ–‡ç« Front-matterå•ç‹¬è¨­ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">copyright_author: xxxx<br>copyright_author_href: https://xxxxxx.com<br>copyright_url: https://xxxxxx.com<br>copyright_info: æ­¤æ–‡ç« ç‰ˆç‰ˆæƒxxxxxæ‰€æœ‰ï¼Œå¦‚æœ‰è½¬è½½ï¼Œè¯·æ³¨æ˜æ¥è‡ªåŸä½œè€…<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« æ‰“èµ"><a href="#æ–‡ç« æ‰“èµ" class="headerlink" title="æ–‡ç« æ‰“èµ"></a>æ–‡ç« æ‰“èµ</h5><p>åœ¨ä½ æ¯ç¯‡æ–‡ç« çš„çµå°¾ï¼Œå¯ä»¥æ·»åŠ æ‰“è³æŒ‰éˆ•ã€‚ç›¸é—œäºŒç¶­ç å¯ä»¥è‡ªè¡Œé…ç½®ã€‚</p><p>å°äºæ²’æœ‰æä¾›äºŒç¶­ç çš„ï¼Œå¯é…ç½®ä¸€å¼µè»Ÿä»¶çš„iconåœ–ç‰‡ï¼Œç„¶å¾Œåœ¨linkä¸Šæ·»åŠ ç›¸æ‡‰çš„æ‰“è³éˆæ¥ã€‚ç”¨æˆ·ç‚¹æ“Šåœ–ç‰‡å°±ä¼šè·³è½‰åˆ°éˆæ¥å»ã€‚</p><p>linkå¯ä»¥ä¸å¯«ï¼Œä¼šé»˜è®¤ç‚ºåœ–ç‰‡çš„éˆæ¥ã€‚</p><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml  å»ºè®®æŠŠimgç›¸å…³äºŒç»´ç æ–‡ä»¶æ›¿æ¢æˆè‡ªå·±çš„äºŒç»´ç </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">reward:<br>  enable: true<br>  QR_code:<br>    - img: /img/wechat.jpg<br>      link:<br>      text: å¾®ä¿¡<br>    - img: /img/alipay.jpg<br>      link:<br>      text: æ”¯ä»˜å®<br></code></pre></td></tr></table></figure><h5 id="TOCæ˜¾ç¤º"><a href="#TOCæ˜¾ç¤º" class="headerlink" title="TOCæ˜¾ç¤º"></a>TOCæ˜¾ç¤º</h5><p>åœ¨æ–‡ç« é¡µï¼Œä¼šæœ‰ä¸€ä¸€ä¸ªç›®å½•ï¼Œç”¨äºæ˜¾ç¤ºTOCã€‚ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">toc:<br>  post: true<br>  page: false<br>  number: true<br>  expand: false<br>  style_simple: false # for post <br></code></pre></td></tr></table></figure><table><thead><tr><th>å±æ€§</th><th>è¯´æ˜</th></tr></thead><tbody><tr><td>post</td><td>æ–‡ç« é¡µæ˜¯å¦æ˜¾ç¤º TOC</td></tr><tr><td>page</td><td>æ™®é€šé¡µé¢æ˜¯å¦æ˜¾ç¤º TOC</td></tr><tr><td>number</td><td>æ˜¯å¦æ˜¾ç¤ºç« ç¯€æ•¸</td></tr><tr><td>expand</td><td>æ˜¯å¦å±•å¼€ TOC</td></tr><tr><td>style_simple</td><td>ç°¡æ½”æ¨¡å¼ï¼ˆå´é‚Šæ¬„åªæ˜¾ç¤º TOC, åªå°æ–‡ç« é¡µæœ‰æ•ˆ ï¼‰</td></tr></tbody></table><h6 id="ç‚ºç‰¹å®šçš„æ–‡ç« é…ç½®"><a href="#ç‚ºç‰¹å®šçš„æ–‡ç« é…ç½®" class="headerlink" title="ç‚ºç‰¹å®šçš„æ–‡ç« é…ç½®"></a>ç‚ºç‰¹å®šçš„æ–‡ç« é…ç½®</h6><p>åœ¨ä½ çš„æ–‡ç« mdæ–‡ä»¶çš„é ­éƒ¨ï¼ŒåŠ å…¥toc_numberå’Œtocï¼Œä¸¦é…ç½®trueæˆ–è€…falseå³å¯ã€‚</p><p>ä¸»é¡Œä¼šå„ªå…ˆåˆ¤æ–·æ–‡ç« Ma</p><h5 id="ç›¸å…³æ–‡ç« "><a href="#ç›¸å…³æ–‡ç« " class="headerlink" title="ç›¸å…³æ–‡ç« "></a>ç›¸å…³æ–‡ç« </h5><p>ç›¸å…³æ–‡ç« æ¨èçš„åŸç†æ˜¯æ ¹æ®æ–‡ç« tagsçš„æ¯”é‡æ¥æ¨è</p><p>ä¿®æ”¹ä¸»é¡Œé…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">related_post:<br>  enable: true<br>  limit: 6 # æ˜¾ç¤ºæ¨èæ–‡ç« æ•°ç›®<br>  date_type: created # or created or updated æ–‡ç« æ—¥æœŸæ˜¾ç¤ºå‰µå»ºæ—¥æˆ–è€…æ›´æ–°æ—¥<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« éŒ¨ç‚¹"><a href="#æ–‡ç« éŒ¨ç‚¹" class="headerlink" title="æ–‡ç« éŒ¨ç‚¹"></a>æ–‡ç« éŒ¨ç‚¹</h5><p>å¼€å¯æ–‡ç« éŒ¨ç‚¹å¾Œï¼Œç•¶ä½ åœ¨æ–‡ç« é¡µé€²è¡Œæ»¾åŠ¨æ™‚ï¼Œæ–‡ç« éˆæ¥ä¼šæ ¹æ“šæ¨™é¡ŒIDé€²è¡Œæ›¿æ›<br>(æ³¨æ„: æ¯æ›¿æ›ä¸€æ¬¡ï¼Œä¼šç•™ä¸‹ä¸€å€‹æ­·å²è¨˜éŒ„ã€‚æ‰€ä»¥å¦‚æœä¸€ç¯‡æ–‡ç« æœ‰å¾ˆå¤šéŒ¨ç‚¹çš„è©±ï¼Œç¶²é¡µçš„æ­·å²è¨˜éŒ„ä¼šå¾ˆå¤šã€‚)</p><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶&#x2F;themes&#x2F;butterfly&#x2F;_config.yaml</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># anchor<br># when you scroll in post , the url will update according to header id.<br>anchor: true<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« è¿‡æœŸæé†’"><a href="#æ–‡ç« è¿‡æœŸæé†’" class="headerlink" title="æ–‡ç« è¿‡æœŸæé†’"></a>æ–‡ç« è¿‡æœŸæé†’</h5><p>å¯è¨­ç½®æ˜¯å¦æ˜¾ç¤ºæ–‡ç« è¿‡æœŸæé†’ï¼Œä»¥æ›´æ–°æ—¶é—´ä¸ºåŸºå‡†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Displays outdated notice for a post (æ–‡ç« éæœŸæé†’)<br>noticeOutdate:<br>  enable: true<br>  style: flat # style: simple/flat<br>  limit_day: 365 # When will it be shown<br>  position: top # position: top/bottom<br>  message_prev: It has been<br>  message_next: days since the last update, the content of the article may be outdated.<br><br>limit_dayï¼š è·é›¢æ›´æ–°æ™‚é–“å¤šå°‘å¤©æ‰æ˜¾ç¤ºæ–‡ç« éæœŸæé†’<br>message_prev ï¼š å¤©æ•¸ä¹‹å‰çš„æ–‡å­—<br>message_nextï¼šå¤©æ•¸ä¹‹å¾Œçš„æ–‡å­—<br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« ç¼–è¾‘æŒ‰é’®"><a href="#æ–‡ç« ç¼–è¾‘æŒ‰é’®" class="headerlink" title="æ–‡ç« ç¼–è¾‘æŒ‰é’®"></a>æ–‡ç« ç¼–è¾‘æŒ‰é’®</h5><p>åœ¨æ–‡ç« æ¨™é¡Œæ—é‚Šæ˜¾ç¤ºä¸€å€‹ç·¨è¼¯æŒ‰éˆ•ï¼Œç‚¹æ“Šä¼šè·³è½‰åˆ°å°æ‡‰çš„éˆæ¥å»ï¼Œè¿™é‡Œä¿æŒé»˜è®¤é…ç½®ä¸è®¾ç½®</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Post edit<br># Easily browse and edit blog source code online.<br>post_edit:<br>  enable: false<br>  # url: https://github.com/user-name/repo-name/edit/branch-name/subdirectory-name/<br>  # For example: https://github.com/jerryc127/butterfly.js.org/edit/main/source/<br>  url:<br><br></code></pre></td></tr></table></figure><h5 id="æ–‡ç« åˆ†é¡µæŒ‰é’®"><a href="#æ–‡ç« åˆ†é¡µæŒ‰é’®" class="headerlink" title="æ–‡ç« åˆ†é¡µæŒ‰é’®"></a>æ–‡ç« åˆ†é¡µæŒ‰é’®</h5><p>å¯è®¾ç½®åˆ†é¡µçš„é€»è¾‘ï¼Œä¹Ÿå¯ä»¥å…³é—­åˆ†é¡µæ˜¾ç¤ºï¼Œæˆ‘è¿™é‡Œè®¾ç½®çš„æ˜¯1</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># post_pagination (åˆ†é¡µ)<br># value: 1 || 2 || false<br># 1: The &#x27;next post&#x27; will link to old post  ä¸‹ä¸€ç¯‡æ˜¾ç¤ºçš„æ˜¯èˆŠæ–‡ç« <br># 2: The &#x27;next post&#x27; will link to new post ä¸‹ä¸€ç¯‡æ˜¾ç¤ºçš„æ˜¯æ–°æ–‡ç« <br># false: disable pagination  å…³é—­åˆ†é¡µæŒ‰éˆ•<br>post_pagination: 1<br><br></code></pre></td></tr></table></figure><h5 id="éšè—éƒ¨åˆ†æ–‡ç« ä¸åœ¨é¦–é¡µæ˜¾ç¤º"><a href="#éšè—éƒ¨åˆ†æ–‡ç« ä¸åœ¨é¦–é¡µæ˜¾ç¤º" class="headerlink" title="éšè—éƒ¨åˆ†æ–‡ç« ä¸åœ¨é¦–é¡µæ˜¾ç¤º"></a>éšè—éƒ¨åˆ†æ–‡ç« ä¸åœ¨é¦–é¡µæ˜¾ç¤º</h5><p>å¦‚æœæœ‰äº›æ–‡ç« ä¸æƒ³åœ¨ä¸»é¡µæ˜¾ç¤ºï¼Œå¯ä»¥ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶ themes&#x2F;butterfly&#x2F;layout&#x2F;includes&#x2F;mixins&#x2F;post-ui.pug</p><p>æ·»åŠ äº†if article.hide !&#x3D;&#x3D; trueè¿™ä¸€è¡Œï¼Œç„¶åè¿™ä¸€è¡Œåå…¨éƒ¨éœ€è¦æŒ‰ä¸‹tabç¼©è¿›ä¸€å±‚ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">mixin postUI(posts)<br>  each article , index in page.posts.data<br>    if article.hide !== true<br>      .recent-post-item<br></code></pre></td></tr></table></figure><p>ä¿®æ”¹æ–‡ç« åœ¨mdæ–‡ä»¶çš„å¤´éƒ¨ä¿¡æ¯ä¸­æ·»åŠ hide: trueï¼Œç¤ºä¾‹å¦‚ä¸‹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">title: Hexoæ­å»ºä¸ªäººåšå®¢<br>tags: Hexo<br>categories: Hexo<br>keywords: hexo<br>hide: true  #æ·»åŠ è¿™ä¸ª<br></code></pre></td></tr></table></figure><h5 id="å¤åˆ¶ç›¸å…³é…ç½®"><a href="#å¤åˆ¶ç›¸å…³é…ç½®" class="headerlink" title="å¤åˆ¶ç›¸å…³é…ç½®"></a>å¤åˆ¶ç›¸å…³é…ç½®</h5><p>å¯é…ç½®ç½‘ç«™æ˜¯å¦å¯ä»¥å¤åˆ¶ã€å¤åˆ¶çš„å…§å®¹æ˜¯å¦æ·»åŠ ç‰ˆæƒä¿¡æ¯</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># copy settings<br># copyright: Add the copyright information after copied content (è¤‡è£½çš„å…§å®¹å¾Œé¢åŠ ä¸Šç‰ˆæ¬Šä¿¡æ¯)<br>copy:<br>  enable: true<br>  copyright:<br>    enable: true<br>    limit_count: 50<br><br>#enable æ˜¯å¦å¼€å¯ç¶²ç«™è¤‡è£½æ¬Šé™<br>#copyrightè¤‡è£½çš„å…§å®¹å¾Œé¢åŠ ä¸Šç‰ˆæ¬Šä¿¡æ¯<br>#enable     æ˜¯å¦å¼€å¯è¤‡è£½ç‰ˆæ¬Šä¿¡æ¯æ·»åŠ <br>#limit_countå­—æ•¸é™åˆ¶ï¼Œç•¶è¤‡è£½æ–‡å­—å¤§äºé€™å€‹å­—æ•¸é™åˆ¶æ™‚ï¼Œå°‡åœ¨è¤‡è£½çš„å…§å®¹å¾Œé¢åŠ ä¸Šç‰ˆæ¬Šä¿¡æ¯<br></code></pre></td></tr></table></figure><h5 id="Footeré¡µå°¾è®¾ç½®"><a href="#Footeré¡µå°¾è®¾ç½®" class="headerlink" title="Footeré¡µå°¾è®¾ç½®"></a>Footeré¡µå°¾è®¾ç½®</h5><h6 id="åšå®¢å¹´ä»½"><a href="#åšå®¢å¹´ä»½" class="headerlink" title="åšå®¢å¹´ä»½"></a>åšå®¢å¹´ä»½</h6><p>sinceæ˜¯ä¸€ä¸ªæ¥å±•ç¤ºä½ ç«™ç‚¹èµ·å§‹æ—¶é—´çš„é€‰é¡¹ã€‚å®ƒä½äºé¡µé¢çš„æœ€åº•éƒ¨ã€‚</p><p>ä¿®æ”¹ ä¸»é¡Œé…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">footer:<br>  owner:<br>    enable: true<br>    since: 2018<br></code></pre></td></tr></table></figure><h6 id="é¡µè„šè‡ªå®šä¹‰æ–‡æœ¬"><a href="#é¡µè„šè‡ªå®šä¹‰æ–‡æœ¬" class="headerlink" title="é¡µè„šè‡ªå®šä¹‰æ–‡æœ¬"></a>é¡µè„šè‡ªå®šä¹‰æ–‡æœ¬</h6><p>custom_textæ˜¯ä¸€å€‹çµ¦ä½ ç”¨æ¥åœ¨é¡µè…³è‡ªå®šä¹‰æ–‡æœ¬çš„é€‰é¡¹ã€‚é€šå¸¸ä½ å¯ä»¥åœ¨è¿™é‡Œå£°æ˜æ–‡æœ¬ç­‰ã€‚æ”¯æŒ HTMLã€‚</p><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">custom_text: Hi, welcome to my &lt;a href=&quot;https://butterfly.js.org/&quot;&gt;blog&lt;/a&gt;!<br></code></pre></td></tr></table></figure><h6 id="é¡µé¢åº•éƒ¨-footerè·³åŠ¨çš„å¿ƒ"><a href="#é¡µé¢åº•éƒ¨-footerè·³åŠ¨çš„å¿ƒ" class="headerlink" title="é¡µé¢åº•éƒ¨ footerè·³åŠ¨çš„å¿ƒ"></a>é¡µé¢åº•éƒ¨ footerè·³åŠ¨çš„å¿ƒ</h6><p>ç¼–è¾‘&#x2F;themes&#x2F;butterfly&#x2F;layout&#x2F;includes&#x2F;footer.pugæ–‡ä»¶</p><p>å°†ä»¥ä¸‹å†…å®¹ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&amp;copy;$&#123;theme.footer.owner.since&#125; - $&#123;nowYear&#125; By $&#123;config.author&#125;<br></code></pre></td></tr></table></figure><p>æ”¹ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&amp;copy;$&#123;theme.footer.owner.since&#125; - $&#123;nowYear + &#x27; &#x27;&#125; &lt;i id=&quot;heartbeat&quot; class=&quot;fa fas fa-heartbeat&quot;&gt;&lt;/i&gt; $&#123;config.author&#125;<br></code></pre></td></tr></table></figure><p>å°†ä»¥ä¸‹å†…å®¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&amp;copy;$&#123;nowYear&#125; By $&#123;config.author&#125; <br></code></pre></td></tr></table></figure><p>æ”¹ä¸º:</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&amp;copy;$&#123;nowYear + &#x27; &#x27;&#125; &lt;i id=&quot;heartbeat&quot; class=&quot;fa fas fa-heartbeat&quot;&gt;&lt;/i&gt; $&#123;config.author&#125;<br></code></pre></td></tr></table></figure><p>å°†ä»¥ä¸‹å†…å®¹æ·»åŠ åˆ° <head></head>æ ‡ç­¾å†…ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;link rel=&quot;stylesheet&quot; href=&quot;https://fastly.jsdelivr.net/gh/HCLonely/images@master/others/heartbeat.min.css&quot;&gt;<br></code></pre></td></tr></table></figure><h5 id="å³ä¸‹è§’æŒ‰é’®"><a href="#å³ä¸‹è§’æŒ‰é’®" class="headerlink" title="å³ä¸‹è§’æŒ‰é’®"></a>å³ä¸‹è§’æŒ‰é’®</h5><h6 id="ç®€ç¹è½¬æ¢"><a href="#ç®€ç¹è½¬æ¢" class="headerlink" title="ç®€ç¹è½¬æ¢"></a>ç®€ç¹è½¬æ¢</h6><p>ç®€ä½“ç¹ä½“äº’æ¢ï¼Œå³ä¸‹è§’ä¼šæœ‰ç®€ç¹è½¬æ¢æŒ‰éˆ•ã€‚</p><p>ä¿®æ”¹ä¸»é¢˜çš„é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Conversion between Traditional and Simplified Chinese (ç®€ç¹è½¬æ¢)<br>translate:<br>  enable: true    # 2022 é»˜è®¤false<br>  # The text of a button<br>  default: ç®€<br>  # the language of website (1 - Traditional Chinese/ 2 - Simplified Chineseï¼‰<br>  defaultEncoding: 1<br>  # Time delay<br>  translateDelay: 0<br>  # The text of the button when the language is Simplified Chinese<br>  msgToTraditionalChinese: &#x27;ç¹&#x27;<br>  # The text of the button when the language is Traditional Chinese<br>  msgToSimplifiedChinese: &#x27;ç®€&#x27;<br></code></pre></td></tr></table></figure><h6 id="å¤œé—´æ¨¡å¼"><a href="#å¤œé—´æ¨¡å¼" class="headerlink" title="å¤œé—´æ¨¡å¼"></a>å¤œé—´æ¨¡å¼</h6><p>å³ä¸‹è§’ä¼šæœ‰å¤œé—´æ¨¡å¼æŒ‰é’®ï¼Œä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># dark mode<br>darkmode:<br>  enable: true<br>  # dark modeå’Œ light modeåˆ‡æ¢æŒ‰é’®<br>  button: true<br>  autoChangeMode: false<br></code></pre></td></tr></table></figure><h6 id="é˜…è¯»æ¨¡å¼"><a href="#é˜…è¯»æ¨¡å¼" class="headerlink" title="é˜…è¯»æ¨¡å¼"></a>é˜…è¯»æ¨¡å¼</h6><p>é˜…è¯»æ¨¡å¼ä¸‹ä¼šå»æ‰é™¤æ–‡ç« å¤–çš„å†…å®¹ï¼Œé¿å…å¹²æ‰°é˜…è¯»ã€‚åªä¼šå‡ºç°åœ¨æ–‡ç« é¡µé¢ï¼Œå³ä¸‹è§’ä¼šæœ‰é˜…è¯»æ¨¡å¼æŒ‰é’®ã€‚</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Read Mode (é˜…è¯»æ¨¡å¼)<br>readmode: true<br></code></pre></td></tr></table></figure><h6 id="æŒ‰é’®æ’åº"><a href="#æŒ‰é’®æ’åº" class="headerlink" title="æŒ‰é’®æ’åº"></a>æŒ‰é’®æ’åº</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Don&#x27;t modify the following settings unless you know how they work (éå¿…è¦è¯·ä¸è¦ä¿®æ”¹ )<br># Choose: readmode,translate,darkmode,hideAside,toc,chat,comment<br># Don&#x27;t repeat ä¸è¦é‡å¤<br>rightside_item_order:<br>  enable: false<br>  hide: # readmode,translate,darkmode,hideAside<br>  show: # toc,chat,comment<br></code></pre></td></tr></table></figure><h5 id="ä¾§è¾¹æ è®¾ç½®"><a href="#ä¾§è¾¹æ è®¾ç½®" class="headerlink" title="ä¾§è¾¹æ è®¾ç½®"></a>ä¾§è¾¹æ è®¾ç½®</h5><h6 id="ä¾§è¾¹æ’ç‰ˆ"><a href="#ä¾§è¾¹æ’ç‰ˆ" class="headerlink" title="ä¾§è¾¹æ’ç‰ˆ"></a>ä¾§è¾¹æ’ç‰ˆ</h6><p>å¯è‡ªè¡Œå†³å®šå“ªä¸ªé¡¹ç›®éœ€è¦æ˜¾ç¤ºï¼Œå¯å†³å®šä½ç½®ï¼Œä¹Ÿå¯ä»¥è®¾ç½®ä¸æ˜¾ç¤ºä¾§è¾¹æ ã€‚</p><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">aside:<br>  enable: true<br>  hide: true<br>  button: true<br>  mobile: true # display on mobile<br>  position: right # left or right<br>  display:<br>    archive: true<br>    tag: true<br>    category: true<br>  card_author:<br>    enable: true<br>    description:<br>    button:<br>      enable: true<br>      icon: iconfont icon-CSDN           #fab fa-github<br>      text: My Blog<br>      link: https://blog.chen1900s.cn/<br>  card_announcement:<br>    enable: true<br>    content: åˆšå¼€å§‹å†™åšå®¢ï¼Œæ¬¢è¿å¤§å®¶æ¥åæ§½<br>  card_recent_post:<br>    enable: true<br>    limit: 5 # if set 0 will show all<br>    sort: date # date or updated<br>    sort_order: # Don&#x27;t modify the setting unless you know how it works<br>  card_categories:<br>    enable: true<br>    limit: 8 # if set 0 will show all<br>    expand: none # none/true/false<br>    sort_order: # Don&#x27;t modify the setting unless you know how it works<br>  card_tags:<br>    enable: true<br>    limit: 40 # if set 0 will show all<br>    color: false<br>    sort_order: # Don&#x27;t modify the setting unless you know how it works<br>  card_archives:<br>    enable: true<br>    type: monthly # yearly or monthly<br>    format: MMMM YYYY # eg: YYYYå¹´MMæœˆ<br>    order: -1 # Sort of order. 1, asc for ascending; -1, desc for descending<br>    limit: 8 # if set 0 will show all<br>    sort_order: # Don&#x27;t modify the setting unless you know how it works<br>  card_webinfo:<br>    enable: true<br>    post_count: true<br>    last_push_date: true<br>    sort_order: # Don&#x27;t modify the setting unless you know how it works<br></code></pre></td></tr></table></figure><h6 id="è®¿é—®äººæ•°-UV-å’Œ-PV"><a href="#è®¿é—®äººæ•°-UV-å’Œ-PV" class="headerlink" title="è®¿é—®äººæ•°(UV å’Œ PV)"></a>è®¿é—®äººæ•°(UV å’Œ PV)</h6><p>è®¿é—® busuanzi çš„å®˜æ–¹ç½‘ç«™æŸ¥çœ‹æ›´å¤šçš„ä»‹ç»ï¼Œä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">busuanzi:<br>  site_uv: true<br>  site_pv: true<br>  page_pv: true<br></code></pre></td></tr></table></figure><h6 id="è¿è¡Œæ—¶é—´"><a href="#è¿è¡Œæ—¶é—´" class="headerlink" title="è¿è¡Œæ—¶é—´"></a>è¿è¡Œæ—¶é—´</h6><p>ç½‘é¡µå·²è¿è¡Œæ—¶é—´</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">runtimeshow:<br>  enable: true   #é»˜è®¤false<br>  publish_date: 9/9/2018 00:00:00<br>  ##ç½‘é¡µå¼€é€šæ—¶é—´<br>  #æ ¼å¼: æœˆ/æ—¥/å¹´ æ—¶é—´<br>  #ä¹Ÿå¯ä»¥å†™æˆ å¹´/æœˆ/æ—¥ æ—¶é—´<br></code></pre></td></tr></table></figure><h6 id="æœ€æ–°è¯„è®º"><a href="#æœ€æ–°è¯„è®º" class="headerlink" title="æœ€æ–°è¯„è®º"></a>æœ€æ–°è¯„è®º</h6><blockquote><p>æœ€æ–°è¯„è®ºåªä¼šåœ¨åˆ·æ–°æ—¶æ‰ä¼šå»è¯»å–ï¼Œå¹¶ä¸ä¼šå®æ—¶å˜åŒ–</p><p>ç”±äº API æœ‰ è®¿é—®æ¬¡æ•°é™åˆ¶ï¼Œä¸ºäº†é¿å…è°ƒç”¨å¤ªå¤šï¼Œä¸»é¢˜é»˜è®¤å­˜å–æœŸé™ä¸º 10 åˆ†é˜ã€‚ä¹Ÿå°±æ˜¯èª¬ï¼Œè°ƒç”¨åèµ„æ–™ä¼šå­˜åœ¨ localStorage é‡Œï¼Œ10åˆ†é˜å†…åˆ·æ–°ç½‘ç«™åªä¼šå» localStorage è¯»å–èµ„æ–™ã€‚ 10 åˆ†é˜æœŸé™ä¸€è¿‡ï¼Œåˆ·æ–°é¡µé¢æ—¶æ‰ä¼šå»è°ƒå– API è¯»å–æ–°çš„æ•°æ®ã€‚ï¼ˆ 3.6.0 æ–°å¢äº† storage é…ç½®ï¼Œå¯è‡ªè¡Œé…ç½®ç¼“å­˜æ—¶é—´ï¼‰</p></blockquote><p>åœ¨ä¾§è¾¹æ æ˜¾ç¤ºæœ€æ–°è¯„è®ºæ¿å—</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Aside widget - Newest Comments<br>newest_comments:<br>  enable: true<br>  sort_order: # Don&#x27;t modify the setting unless you know how it works<br>  limit: 6<br>  storage: 10 # unit: mins, save data to localStorage<br>  avatar: true<br></code></pre></td></tr></table></figure><h6 id="è‡ªå®šä¹‰æ·»åŠ æ ç›®"><a href="#è‡ªå®šä¹‰æ·»åŠ æ ç›®" class="headerlink" title="è‡ªå®šä¹‰æ·»åŠ æ ç›®"></a>è‡ªå®šä¹‰æ·»åŠ æ ç›®</h6><p>æ ‡ç­¾å¤–æŒ‚ï¼ˆTag Pluginsï¼‰</p><blockquote><p>æ ‡ç­¾å¤–æŒ‚æ˜¯Hexoç‹¬æœ‰çš„åŠŸèƒ½ï¼Œå¹¶ä¸æ˜¯æ ‡æº–çš„Markdownæ ¼å¼ã€‚</p><p>ä»¥ä¸‹çš„å†™æ³•ï¼Œåªé€‚ç”¨äºButterflyä¸»é¢˜ï¼Œç”¨åœ¨å…¶å®ƒä¸»é¢˜ä¸Šä¸ä¼šæœ‰æ•ˆæœï¼Œç”šè‡³å¯èƒ½ä¼šæŠ¥é”™ã€‚ä½¿ç”¨å‰è¯·ç•™æ„</p></blockquote><h6 id="Follow-meä¿¡æ¯ä¿®æ”¹"><a href="#Follow-meä¿¡æ¯ä¿®æ”¹" class="headerlink" title="Follow meä¿¡æ¯ä¿®æ”¹"></a>Follow meä¿¡æ¯ä¿®æ”¹</h6><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">card_author:<br>  enable: true<br>  description:<br>  button:<br>    enable: true<br>    icon: fab fa-github<br>    text: my blog<br>    link: https://chen1900s.github.io/<br></code></pre></td></tr></table></figure><h6 id="å…¬å‘Šä¿¡æ¯"><a href="#å…¬å‘Šä¿¡æ¯" class="headerlink" title="å…¬å‘Šä¿¡æ¯"></a>å…¬å‘Šä¿¡æ¯</h6><p>åœ¨ä¸»é¢˜é…ç½®æ–‡ä»¶ä¿®æ”¹</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">card_announcement:<br>    enable: true<br>    content: This is my Blog  #ä¿®æ”¹æ­¤å¤„<br></code></pre></td></tr></table></figure><h5 id="åœ¨çº¿èŠå¤©"><a href="#åœ¨çº¿èŠå¤©" class="headerlink" title="åœ¨çº¿èŠå¤©"></a>åœ¨çº¿èŠå¤©</h5><p>ä»3.0å¼€å§‹ï¼ŒButterflyä¸»é¢˜å†…ç½®äº†å¤šç§åœ¨çº¿èŠå¤©å·¥å…·ã€‚ä½ å¯ä»¥é€‰æ‹©å¼€å¯ä¸€ç§ï¼Œæ–¹ä¾¿ä½ ä¸è®¿å®¢çš„äº¤æµã€‚è¿™äº›å·¥å…·éƒ½æä¾›äº†ä¸€ä¸ªæŒ‰é’®å¯ä»¥æ‰“å¼€&#x2F;å…³é—­èŠå¤©çª—å£ã€‚<br>ä¸»é¢˜ä¹Ÿæä¾›äº†ä¸€ä¸ªé›†åˆä¸»é¢˜ç‰¹è‰²çš„æŒ‰é’®æ¥æ›¿æ¢è¿™äº›å·¥å…·æœ¬èº«çš„æŒ‰é’®ï¼Œè¿™ä¸ªèŠå¤©æŒ‰é’®å°†ä¼šå‡ºç°åœ¨å³ä¸‹è§’é‡Œã€‚<br>ä½ åªéœ€è¦æŠŠchat_btnæ‰“å¼€å°±è¡Œã€‚</p><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Chat Button [recommend]<br># It will create a button in the bottom right corner of website, and hide the origin button<br>chat_btn: true  é»˜è®¤false<br></code></pre></td></tr></table></figure><p>ä¸ºäº†ä¸å½±å“è®¿å®¢çš„ä½“éªŒï¼Œä¸»é¢˜æä¾›ä¸€ä¸ªchat_hide_showé…ç½®ï¼Œè®¾ä¸ºtrueåï¼Œä½¿ç”¨å·¥å…·æä¾›çš„æŒ‰é’®æ—¶ï¼Œåªæœ‰å‘ä¸Šæ»šåŠ¨æ‰ä¼šæ˜¾ç¤ºèŠå¤©æŒ‰é’®ï¼Œå‘ä¸‹æ»šåŠ¨æ—¶ä¼šéšè—æŒ‰é’®ã€‚</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># The origin chat button is displayed when scrolling up, and the button is hidden when scrolling down<br>chat_hide_show: true<br></code></pre></td></tr></table></figure><h5 id="åˆ†äº«åŠŸèƒ½"><a href="#åˆ†äº«åŠŸèƒ½" class="headerlink" title="åˆ†äº«åŠŸèƒ½"></a>åˆ†äº«åŠŸèƒ½</h5><blockquote><p>åªèƒ½é€‰æ‹©ä¸€ä¸ªåˆ†äº«æœåŠ¡å•†</p></blockquote><p>å¯ä»¥åˆ°addtoanyæŸ¥çœ‹ä½¿ç”¨èª¬æ˜</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">sharejs:<br>  enable: true<br>  sites: facebook,twitter,wechat,weibo,qq  #æƒ³è¦æ˜¾ç¤ºçš„å†…å®¹<br></code></pre></td></tr></table></figure><h5 id="æœç´¢åŠŸèƒ½"><a href="#æœç´¢åŠŸèƒ½" class="headerlink" title="æœç´¢åŠŸèƒ½"></a>æœç´¢åŠŸèƒ½</h5><blockquote><p>è®°å¾—è¿è¡Œ hexo clean</p></blockquote><p>ä½ éœ€è¦å®‰è£… hexo-generator-searchï¼Œæ ¹æ®å®ƒçš„æ–‡æ¡£å»åšç›¸åº”é…ç½®</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install  hexo-generator-search  --save<br></code></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">local_search:<br>  enable: true<br>  labels:<br>    input_placeholder: Search for Posts<br>    hits_empty: &quot;We didn&#x27;t find any results for the search: $&#123;query&#125;&quot; # å¦‚æœæ²¡æœ‰æŸ¥åˆ°å†…å®¹ç›¸å…³å†…å®¹æ˜¾ç¤º<br></code></pre></td></tr></table></figure><p>ä½ éœ€è¦å®‰è£… hexo-algoliaæˆ– hexo-algoliasearch. æ ¹æ®å®ƒä»¬çš„èª¬æ˜æ–‡æ¡£å»åšç›¸åº”çš„é…ç½®ã€‚</p><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">algolia_search:<br>  enable: true <br>  hits:<br>    per_page: 6<br></code></pre></td></tr></table></figure><h6 id="åˆ†å‰²çº¿å›¾æ ‡æ›´æ¢"><a href="#åˆ†å‰²çº¿å›¾æ ‡æ›´æ¢" class="headerlink" title="åˆ†å‰²çº¿å›¾æ ‡æ›´æ¢"></a>åˆ†å‰²çº¿å›¾æ ‡æ›´æ¢</h6><p>å°†å›¾æ ‡æ›´æ¢ä¸ºâ€œå¤ªç©ºé£èˆ¹â€ã€‚</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hr_icon:<br>  enable: true<br>  icon: &#x27;\f197&#x27; # the unicode value of Font Awesome icon, such as &#x27;\3423&#x27;<br>  icon-top: -10px<br></code></pre></td></tr></table></figure><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220823130546940.png" alt="image-20220823130546940"></p><h5 id="å¹¿å‘Šè®¾ç½®"><a href="#å¹¿å‘Šè®¾ç½®" class="headerlink" title="å¹¿å‘Šè®¾ç½®"></a>å¹¿å‘Šè®¾ç½®</h5><p>ä¸»é¢˜å·²é›†æˆè°·æ­Œå¹¿å‘Šï¼ˆè‡ªåŠ¨å¹¿å‘Šï¼‰</p><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Google Adsense (è°·æ­Œå¹¿å‘Š)<br>google_adsense:<br>  enable: false<br>  auto_ads: true<br>  js: https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js<br>  client:<br>  enable_page_level_ads: true<br><br></code></pre></td></tr></table></figure><h5 id="ç¾åŒ–-x2F-ç‰¹æ•ˆ"><a href="#ç¾åŒ–-x2F-ç‰¹æ•ˆ" class="headerlink" title="ç¾åŒ–&#x2F;ç‰¹æ•ˆ"></a>ç¾åŒ–&#x2F;ç‰¹æ•ˆ</h5><h6 id="è‡ªå®šä¹‰ä¸»é¢˜è‰²"><a href="#è‡ªå®šä¹‰ä¸»é¢˜è‰²" class="headerlink" title="è‡ªå®šä¹‰ä¸»é¢˜è‰²"></a>è‡ªå®šä¹‰ä¸»é¢˜è‰²</h6><p>å¯ä»¥ä¿®æ”¹å¤§éƒ¨åˆ†UIé¢œè‰²</p><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶ï¼Œæ¯”å¦‚ï¼š</p><blockquote><p>é¢œè‰²å€¼å¿…é¡»è¢«åŒå¼•å·åŒ…è£¹ï¼Œå°±åƒâ€#000â€è€Œä¸æ˜¯#000ã€‚å¦åˆ™å°†ä¼šåœ¨æ„å»ºçš„æ—¶å€™æŠ¥é”™ï¼Œæˆ‘è¿™é‡Œä¿æŒé»˜è®¤é…ç½®ä¸åšä¿®æ”¹</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># theme_color:<br>#   enable: true<br>#   main: &quot;#49B1F5&quot;<br>#   paginator: &quot;#00c4b6&quot;<br>#   button_hover: &quot;#FF7242&quot;<br>#   text_selection: &quot;#00c4b6&quot;<br>#   link_color: &quot;#99a9bf&quot;<br>#   meta_color: &quot;#858585&quot;<br>#   hr_color: &quot;#A4D8FA&quot;<br>#   code_foreground: &quot;#F47466&quot;<br>#   code_background: &quot;rgba(27, 31, 35, .05)&quot;<br>#   toc_color: &quot;#00c4b6&quot;<br>#   blockquote_padding_color: &quot;#49b1f5&quot;<br>#   blockquote_background_color: &quot;#49b1f5&quot;<br>#   scrollbar_color: &quot;#49b1f5&quot;<br>#   meta_theme_color_light: &quot;ffffff&quot;<br>#   meta_theme_color_dark: &quot;#0d0d0d&quot;<br><br></code></pre></td></tr></table></figure><h6 id="é¡µé¢èƒŒæ™¯"><a href="#é¡µé¢èƒŒæ™¯" class="headerlink" title="é¡µé¢èƒŒæ™¯"></a>é¡µé¢èƒŒæ™¯</h6><p>é»˜è®¤æ˜¾ç¤ºç™½è‰²ï¼Œå¯è®¾ç½®å›¾ç‰‡æˆ–è€…é¢œè‰² ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶<code>_config.yml</code>ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># The formal of image: url(http://xxxxxx.com/xxx.jpg)<br>background: &#x27;#efefef&#x27;   #é»˜è®¤ç•™ç©ºçš„<br></code></pre></td></tr></table></figure><p>å¯ä»¥è‡ªå®šä¹‰</p><p>åœ¨<code>\Butterfly\source\css\</code>ç›®å½•ä¸‹åˆ›å»ºcssæ–‡ä»¶ <code>backgound.css</code></p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#web_bg &#123;<br>  background: -webkit-linear-gradient(<br>    0deg,<br>    rgba(247, 149, 51, 0.1) 0,<br>    rgba(243, 112, 85, 0.1) 15%,<br>    rgba(239, 78, 123, 0.1) 30%,<br>    rgba(161, 102, 171, 0.1) 44%,<br>    rgba(80, 115, 184, 0.1) 58%,<br>    rgba(16, 152, 173, 0.1) 72%,<br>    rgba(7, 179, 155, 0.1) 86%,<br>    rgba(109, 186, 130, 0.1) 100%<br>  );<br>  background: -moz-linear-gradient(<br>    0deg,<br>    rgba(247, 149, 51, 0.1) 0,<br>    rgba(243, 112, 85, 0.1) 15%,<br>    rgba(239, 78, 123, 0.1) 30%,<br>    rgba(161, 102, 171, 0.1) 44%,<br>    rgba(80, 115, 184, 0.1) 58%,<br>    rgba(16, 152, 173, 0.1) 72%,<br>    rgba(7, 179, 155, 0.1) 86%,<br>    rgba(109, 186, 130, 0.1) 100%<br>  );<br>  background: -o-linear-gradient(<br>    0deg,<br>    rgba(247, 149, 51, 0.1) 0,<br>    rgba(243, 112, 85, 0.1) 15%,<br>    rgba(239, 78, 123, 0.1) 30%,<br>    rgba(161, 102, 171, 0.1) 44%,<br>    rgba(80, 115, 184, 0.1) 58%,<br>    rgba(16, 152, 173, 0.1) 72%,<br>    rgba(7, 179, 155, 0.1) 86%,<br>    rgba(109, 186, 130, 0.1) 100%<br>  );<br>  background: -ms-linear-gradient(<br>    0deg,<br>    rgba(247, 149, 51, 0.1) 0,<br>    rgba(243, 112, 85, 0.1) 15%,<br>    rgba(239, 78, 123, 0.1) 30%,<br>    rgba(161, 102, 171, 0.1) 44%,<br>    rgba(80, 115, 184, 0.1) 58%,<br>    rgba(16, 152, 173, 0.1) 72%,<br>    rgba(7, 179, 155, 0.1) 86%,<br>    rgba(109, 186, 130, 0.1) 100%<br>  );<br>  background: linear-gradient(<br>    90deg,<br>    rgba(247, 149, 51, 0.1) 0,<br>    rgba(243, 112, 85, 0.1) 15%,<br>    rgba(239, 78, 123, 0.1) 30%,<br>    rgba(161, 102, 171, 0.1) 44%,<br>    rgba(80, 115, 184, 0.1) 58%,<br>    rgba(16, 152, 173, 0.1) 72%,<br>    rgba(7, 179, 155, 0.1) 86%,<br>    rgba(109, 186, 130, 0.1) 100%<br>  );<br>&#125;<br><br></code></pre></td></tr></table></figure><p>ä¿®æ”¹é…ç½®æ–‡ä»¶<code>_config.yml</code>çš„å¼•å…¥æ–¹å¼</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">inject:<br>  head:<br>     - &lt;link rel=&quot;stylesheet&quot; href=&quot;/css/background.css&quot;&gt;<br>  bottom:<br></code></pre></td></tr></table></figure><p>å¦‚æœèƒŒæ™¯è‰²ä¸ç”Ÿæ•ˆï¼Œè®¾ç½®<code>_config.yml</code>ï¼Œéœ€å°†background:è®¾ç½®æˆ#efefef</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># The formal of image: url(http://xxxxxx.com/xxx.jpg)<br>background: &#x27;#efefef&#x27;<br></code></pre></td></tr></table></figure><h6 id="é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ"><a href="#é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ" class="headerlink" title="é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ"></a>é¼ æ ‡ç‚¹å‡»ç‰¹æ•ˆ</h6><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Mouse click effects: fireworks (é¼ æ ‡ç‚¹å‡»æ•ˆæœ: ç…™ç«ç‰¹æ•ˆ)<br>fireworks:<br>  enable: false<br>  zIndex: 9999 # -1 or 9999<br>  mobile: false<br><br># Mouse click effects: Heart symbol (é¼ æ¨™é»æ“Šæ•ˆæœ: æ„›å¿ƒ)<br>click_heart:<br>  enable: false<br>  mobile: false<br><br># Mouse click effects: words (é¼ æ¨™é»æ“Šæ•ˆæœ: æ–‡å­—)<br>ClickShowText:<br>  enable: false<br>  text:<br>    # - I<br>    # - LOVE<br>    # - YOU<br>  fontSize: 15px<br>  random: false<br>  mobile: false<br></code></pre></td></tr></table></figure><h6 id="æ‰“å­—ç‰¹æ•ˆ"><a href="#æ‰“å­—ç‰¹æ•ˆ" class="headerlink" title="æ‰“å­—ç‰¹æ•ˆ"></a>æ‰“å­—ç‰¹æ•ˆ</h6><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Typewriter Effect (æ‰“å­—æ•ˆæœ)<br># https://github.com/disjukr/activate-power-mode<br>activate_power_mode:<br>  enable: false<br>  colorful: true # open particle animation (å†’å…‰ç‰¹æ•ˆ)<br>  shake: true #  open shake (æŠ–åŠ¨ç‰¹æ•ˆ)<br>  mobile: false<br></code></pre></td></tr></table></figure><h6 id="é¡µé¢èƒŒæ™¯ç‰¹æ•ˆ"><a href="#é¡µé¢èƒŒæ™¯ç‰¹æ•ˆ" class="headerlink" title="é¡µé¢èƒŒæ™¯ç‰¹æ•ˆ"></a>é¡µé¢èƒŒæ™¯ç‰¹æ•ˆ</h6><p>æœ‰ä¸‰ç§ï¼Œæ ¹æ®è‡ªå·±å–œå¥½é€‰æ‹©å¼€å¯ï¼Œå°†<code>enable</code>è®¾ç½®ä¸ºtrueå°±å¯ä»¥</p><blockquote><p>é™æ€å½©å¸¦</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># canvas_ribbon (éœæ­¢å½©å¸¶èƒŒæ™¯)<br># See: https://github.com/hustcc/ribbon.js<br>canvas_ribbon:<br>  enable: false<br>  size: 150<br>  alpha: 0.6<br>  zIndex: -1<br>  click_to_change: true<br>  mobile: true<br> #ç‚¹å‡»é¡µé¢ï¼Œå½©å¸¦ä¼šè¿›è¡Œå˜åŒ–ã€‚<br></code></pre></td></tr></table></figure><blockquote><p>åŠ¨æ€å½©å¸¦</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Fluttering Ribbon (åŠ¨æ…‹å½©å¸¶)<br>canvas_fluttering_ribbon:<br>  enable: true<br>  mobile: true<br>  <br>#è¿™ä¸ªå½©å¸¦å¯ä»¥åŠ¨æ€å˜æ¢<br></code></pre></td></tr></table></figure><blockquote><p>è‡ªåŠ¨å¸é™„</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># canvas_nest<br># https://github.com/hustcc/canvas-nest.js<br>canvas_nest:<br>  enable: false<br>  color: &#x27;0,0,255&#x27; #çº¿æ¡é¢œè‰², default: &#x27;0,0,0&#x27;; <br>  opacity: 0.7 # çº¿æ¡çš„ä¸é€æ˜åº¦ (0~1), default: 0.5.<br>  zIndex: -1 # z-index property of the background, default: -1.<br>  count: 99 # çº¿æ¡æ•°é‡, default: 99.<br>  mobile: false<br></code></pre></td></tr></table></figure><h6 id="Snackbar-å¼¹çª—"><a href="#Snackbar-å¼¹çª—" class="headerlink" title="Snackbar å¼¹çª—"></a>Snackbar å¼¹çª—</h6><p>ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Snackbar (Toast Notification å½ˆçª—)<br># position å½ˆçª—ä½ç½®<br># å¯é¸ top-left / top-center / top-right / bottom-left / bottom-center / bottom-right<br>snackbar:<br>  enable: false  #é»˜è®¤å°±æ˜¯false<br>  position: top-right<br>  bg_light: &#x27;#49b1f5&#x27; # light èƒŒæ™¯ä¸‹çš„æ ·å¼<br>  bg_dark: &#x27;#121212&#x27; # dark èƒŒæ™¯ä¸‹çš„æ ·å¼<br>  <br>#å¼€å¯åï¼Œåœ¨ä½ è®¾ç½®çš„ä½ç½®ä¼šæœ‰å¯çˆ±çš„å°å¼¹çª—å‡ºç°<br></code></pre></td></tr></table></figure><h6 id="åº•éƒ¨è®¾ç½®"><a href="#åº•éƒ¨è®¾ç½®" class="headerlink" title="åº•éƒ¨è®¾ç½®"></a>åº•éƒ¨è®¾ç½®</h6><p>ä¿®æ”¹ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Footer Settings<br># --------------------------------------<br>footer:<br>  owner:<br>    enable: true<br>    since: 2018<br>  custom_text: welcome to my &lt;a href=&quot;https://blog.chen1900s.cn&quot;&gt;blog&lt;/a&gt;!<br>  copyright: false # Copyright of theme and framework é»˜è®¤ä¸ºtrue<br>  ICP: # Chinese ICP License   #æœ€åä¸€å¥<br>    enable: true<br>    url: http://www.beian.gov.cn<br>    text: è±«ICPå¤‡20001029å·<br>    icon: /img/icp.png<br></code></pre></td></tr></table></figure><h5 id="è¯„è®ºåŠŸèƒ½"><a href="#è¯„è®ºåŠŸèƒ½" class="headerlink" title="è¯„è®ºåŠŸèƒ½"></a>è¯„è®ºåŠŸèƒ½</h5><p>å¼€å¯è¯„è®ºéœ€è¦åœ¨<code>butterfly.yml</code>â€”<code>comments</code>â€”<code>use</code>ä¸­å¡«å†™ä½ éœ€è¦çš„è¯„è®ºã€‚</p><p>æ”¯æŒ<code>åŒè¯„è®ºæ˜¾ç¤º</code>ï¼Œåªéœ€è¦é…ç½®ä¸¤ä¸ªè¯„è®ºï¼ˆç¬¬ä¸€ä¸ªä¸º<code>é»˜è®¤</code>æ˜¾ç¤ºï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">comments:<br>  use:<br>   - Valine<br>  # - Disqus    <br>  text: true <br>  lazyload: false<br>  count: false <br></code></pre></td></tr></table></figure><table><thead><tr><th>å‚æ•°</th><th>è§£é‡Š</th></tr></thead><tbody><tr><td>use</td><td>ä½¿ç”¨çš„è¯„è®ºï¼ˆå¡«å†™çš„è¯„è®ºé¦–å­—æ¯éœ€è¦å¤§å†™ã€‚æœ€å¤šæ”¯æŒä¸¤ä¸ªï¼Œä¸éœ€è¦å°±ç•™ç©ºï¼‰</td></tr><tr><td>text</td><td>æ˜¯å¦æ˜¾ç¤ºè¯„è®ºæœåŠ¡å•†çš„åå­—</td></tr><tr><td>lazyload</td><td>æ˜¯å¦ä¸ºè¯„è®ºå¼€å¯lazyloadï¼Œå¼€å¯åï¼Œåªæœ‰æ»šåŠ¨åˆ°è¯„è®ºä½ç½®æ—¶æ‰ä¼šåŠ è½½è¯„è®ºæ‰€éœ€è¦çš„èµ„æºï¼ˆå¼€å¯lazyloadåï¼Œè¯„è®ºæ•°å°†ä¸æ˜¾ç¤ºï¼‰</td></tr><tr><td>count</td><td>æ˜¯å¦åœ¨æ–‡ç« é¡¶éƒ¨æ˜¾ç¤ºè¯„è®ºæ•°</td></tr></tbody></table><p><code>æ³¨æ„</code>ï¼šåŒè¯„è®ºä¸èƒ½æ˜¯<code>Disqus</code> å’Œ<code>Disqusjs</code> ä¸€èµ·ï¼Œç”±äºå…¶å…±ç”¨åŒä¸€ä¸ª <code>ID</code>ï¼Œä¼šå‡ºé”™ã€‚</p><p>ä»¥ä¸‹æ˜¯ä¸¾ä¾‹çš„æˆ‘åœ¨ç”¨çš„ï¼š<code>Valine</code></p><p>1.åœ¨<a href="https://leancloud.cn/dashboard/login.html#/signin">LeanCloud</a>ä¸­æ³¨å†Œè´¦å·ï¼Œå¹¶è¿›å…¥ã€‚</p><p>2.åˆ›å»ºåº”ç”¨</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220823175230964.png" alt="image-20220823175230964"></p><p>3.åˆ›å»ºæˆåŠŸåï¼Œè¿›å…¥<code>è®¾ç½®</code></p><p>4.è¿›å…¥<code>åº”ç”¨Keys</code></p><p><code>åº”ç”¨Keys</code>ä¸­æœ‰<code>AppID</code>å’Œ<code>AppKey</code>ï¼Œè¿™ä¸¤ä¸ªéœ€è¦å¡«å†™åˆ°ä½ çš„<code>butterfly.yml</code>ä¸­</p><p>5.ä¿®æ”¹ ä¸»é¢˜é…ç½®æ–‡ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># valine<br># https://valine.js.org<br>valine:<br>  appId:              #  app id<br>  appKey:              # app key<br>  pageSize: 10<br>  avatar: monsterid <br>  lang: zh-CN <br>  placeholder: Please leave your footprints p<br>  guest_info: nick,mail,link <br>  recordIP: true <br>  serverURLs: <br>  bg: <br>  emojiCDN: <br>  enableQQ: true <br>  requiredFields: nick,mail<br></code></pre></td></tr></table></figure><h5 id="éŸ³ä¹Aplayer"><a href="#éŸ³ä¹Aplayer" class="headerlink" title="éŸ³ä¹Aplayer"></a>éŸ³ä¹Aplayer</h5><h6 id="å®‰è£…-hexo-tag-aplayer-æ’ä»¶"><a href="#å®‰è£…-hexo-tag-aplayer-æ’ä»¶" class="headerlink" title="å®‰è£… hexo-tag-aplayer æ’ä»¶"></a>å®‰è£… hexo-tag-aplayer æ’ä»¶</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install --save hexo-tag-aplayer<br></code></pre></td></tr></table></figure><p>å…³é—­ asset_inject</p><p>ç”±äºéœ€è¦å…¨å±€éƒ½æ’å…¥ aplayer å’Œ meting èµ„æºï¼Œä¸ºäº†é˜²æ­¢æ’å…¥é‡å¤çš„èµ„æºï¼Œéœ€è¦æŠŠ asset_inject è®¾ä¸º false</p><h6 id="åœ¨-Hexo-çš„é…ç½®æ–‡ä»¶ä¸­"><a href="#åœ¨-Hexo-çš„é…ç½®æ–‡ä»¶ä¸­" class="headerlink" title="åœ¨ Hexo çš„é…ç½®æ–‡ä»¶ä¸­"></a>åœ¨ Hexo çš„é…ç½®æ–‡ä»¶ä¸­</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">aplayer:<br>  meting: true<br>  asset_inject: false<br></code></pre></td></tr></table></figure><h6 id="å¼€å¯ä¸»é¢˜çš„-aplayerInject"><a href="#å¼€å¯ä¸»é¢˜çš„-aplayerInject" class="headerlink" title="å¼€å¯ä¸»é¢˜çš„ aplayerInject"></a>å¼€å¯ä¸»é¢˜çš„ aplayerInject</h6><p>åœ¨ä¸»é¢˜çš„é…ç½®æ–‡ä»¶ä¸­ï¼Œenable è®¾ä¸º true å’Œ per_page è®¾ä¸º true</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Inject the css and script (aplayer/meting)<br>aplayerInject:<br>  enable: true<br>  per_page: true<br></code></pre></td></tr></table></figure><p>æ’å…¥ Aplayer htmlä¸ºäº†é€‚é… hexo-tag-aplayerï¼Œä¸»é¢˜å†…ç½®çš„ Meting js ä»ä¸º 1.2 ç‰ˆæœ¬ï¼Œå¹¶éæœ€æ–°çš„ 2.x ç‰ˆæœ¬ã€‚</p><p>Aplayer html ä¾‹å­ï¼š</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">&lt;div class=&quot;aplayer no-destroy&quot; data-id=&quot;7607717868&quot; data-server=&quot;netease&quot; data-type=&quot;playlist&quot; data-fixed=&quot;true&quot; data-mini=&quot;true&quot; data-listFolded=&quot;false&quot; data-order=&quot;random&quot; data-lrctype=&quot;1&quot; data-preload=&quot;none&quot; data-autoplay=&quot;false&quot; muted&gt;&lt;/div&gt;<br></code></pre></td></tr></table></figure><p>æŠŠ aplayerä»£ç  æ’å…¥åˆ°ä¸»é¢˜é…ç½®æ–‡ä»¶çš„ inject.bottom å»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">inject:<br>  head:<br>  bottom:<br>       - &lt;div class=&quot;aplayer no-destroy&quot; data-id=&quot;7607717868&quot; data-server=&quot;netease&quot; data-type=&quot;playlist&quot; data-fixed=&quot;true&quot; data-mini=&quot;true&quot; data-listFolded=&quot;false&quot; data-order=&quot;random&quot; data-lrctype=&quot;1&quot; data-preload=&quot;none&quot; data-autoplay=&quot;false&quot; muted&gt;&lt;/div&gt;<br><br></code></pre></td></tr></table></figure><p>è¿è¡Œ Hexo å°±å¯ä»¥çœ‹åˆ°ç½‘é¡µå·¦ä¸‹è§’å‡ºç°äº† Aplayer</p><p>æœ€åï¼Œå¦‚æœä½ æƒ³åˆ‡æ¢é¡µé¢æ—¶ï¼ŒéŸ³ä¹ä¸ä¼šä¸­æ–­ã€‚è¯·æŠŠä¸»é¢˜é…ç½®æ–‡ä»¶çš„ pjax è®¾ä¸º true</p><p>éŸ³ä¹é¡µé¢ä¹Ÿæ˜¾ç¤ºæ’­æ”¾åˆ—è¡¨ï¼Œå¯ä»¥ç›´æ¥åœ¨&#x2F;source&#x2F;music&#x2F;ç›®å½•ä¸‹çš„index.md é‡Œé¢å¡«å…¥</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">---<br>title: éŸ³ä¹<br>date: 2018-08-24 11:06:40<br>type: music<br>---<br>&#123;% meting &quot;7607717868&quot; &quot;netease&quot; &quot;playlist&quot; &quot;theme:#ad7a86&quot; &quot;mutex:true&quot; &quot;listmaxheight:340px&quot; &quot;preload:auto&quot; %&#125;<br></code></pre></td></tr></table></figure><h5 id="ç”µå½±movies"><a href="#ç”µå½±movies" class="headerlink" title="ç”µå½±movies"></a>ç”µå½±movies</h5><p>ç”µå½±ç•Œé¢ä½¿ç”¨äº†æ’ä»¶ hexo-butterfly-doubanï¼Œä½¿ç”¨æ–¹æ³•è¯·å‚è€ƒæ’ä»¶çš„æ–‡æ¡£ã€‚</p><blockquote><p><a href="https://github.com/jerryc127/butterfly-plugins/tree/main/hexo-butterfly-douban">hexo-butterfly-doubanä»‹ç»</a>   </p></blockquote><h6 id="å®‰è£"><a href="#å®‰è£" class="headerlink" title="å®‰è£"></a>å®‰è£</h6><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install hexo-butterfly-douban --save<br></code></pre></td></tr></table></figure><h6 id="é…ç½®"><a href="#é…ç½®" class="headerlink" title="é…ç½®"></a>é…ç½®</h6><p>å°‡ä¸‹é¢çš„é…ç½®å¯«å…¥ç«™é»çš„é…ç½®æ–‡ä»¶ <code>_config.yml</code> é‡Œ(ä¸æ˜¯ä¸»é¡Œçš„é…ç½®æ–‡ä»¶).</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">##ç”µå½±<br>douban:<br>  user: 261805469<br>  builtin: true<br>  book:<br>    title: &#x27;ä¹¦ç±&#x27;<br>    quote: &#x27;è¯»ä¹¦ä¸æ˜¯ä¸ºäº†æ‹¿æ–‡å‡­æˆ–è€…å‘è´¢ï¼Œè€Œæ˜¯æˆä¸ºä¸€ä¸ªæ¸©åº¦ï¼Œæœ‰æƒ…è¶£ï¼Œä¼šæ€è€ƒçš„äººï¼&#x27;<br>    meta: true<br>    comments: true<br>    top_img: https://cccccc.png<br>    aside: true<br>    path: book<br>    limit:<br>  movie:<br>    title: &#x27;ç”µå½±&#x27;<br>    quote: &#x27;ä¸€æ¯å¥¶èŒ¶ï¼Œä¸€ä¸ªäººï¼Œä¸€å¼ ç¥¨ï¼Œä¸€åœºç”µå½±&#x27;<br>    meta: true<br>    comments: true<br>    top_img: https://cccccc.png<br>    aside: true<br>    path: movies<br>    limit:<br>  game:<br>    title: &#x27;æ¸¸æˆ&#x27;<br>    quote: &#x27;ä¸å¥½æ„æ€ï¼Œç›®å‰è¿˜æ²¡æœ‰æ‰¾åˆ°å¥½ç©çš„æ¸¸æˆï¼Œæœ‰æ¨èçš„å—&#x27;<br>    meta: true<br>    comments: true<br>    top_img: https://cccccc.png<br>    aside: true<br>    path: game<br>    limit:<br>  timeout: 10000<br></code></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Hexoæ­å»ºä¸ªäººåšå®¢</title>
      <link href="/post/ec7d7221.html"/>
      <url>/post/ec7d7221.html</url>
      
        <content type="html"><![CDATA[<p><strong>ç®€å•ä»‹ç»</strong></p><blockquote><p>ä¸€ç›´æƒ³æ‹¥æœ‰ä¸€ä¸ªå±äºè‡ªå·±çš„åšå®¢ä¸»ç«™ï¼Œä¾¿äºè®°å½•å¹³æ—¶å·¥ä½œä¸­é‡åˆ°ä¸€æŠ€æœ¯é—®é¢˜ æˆ–æ˜¯ç”Ÿæ´»çäº‹ï¼Œäºæ˜¯åœ¨ç½‘ä¸Šæœç´¢äº†å¦‚ä½•æ­å»ºåšå®¢ï¼Œäº†è§£åˆ°hexoä½¿ç”¨çš„äººè¿˜æŒºå¤šï¼Œé‚£å°±è¡ŒåŠ¨èµ·æ¥ï¼Œåœ¨ç½‘ä¸Šä¸€è¾¹æœæ•™ç¨‹ä¸€è¾¹æ­å»ºï¼Œæœ¬ç«™æ˜¯åŸºäºHexo+butterfly çš„ï¼Œæ„Ÿè°¢ç½‘ä¸Šå„ç§å‰è¾ˆçš„åˆ†äº«ï¼Œè®©æˆ‘å­¦ä¹ äº†å¾ˆå¤š</p></blockquote><h2 id="HexoåŸºæœ¬æ­å»º"><a href="#HexoåŸºæœ¬æ­å»º" class="headerlink" title="HexoåŸºæœ¬æ­å»º"></a>HexoåŸºæœ¬æ­å»º</h2><p>Hexo æ˜¯ä¸€ä¸ªå¿«é€Ÿã€ç®€æ´ä¸”é«˜æ•ˆçš„åšå®¢æ¡†æ¶ã€‚Hexo ä½¿ç”¨ <a href="http://daringfireball.net/projects/markdown/">Markdown</a>ï¼ˆæˆ–å…¶ä»–æ¸²æŸ“å¼•æ“ï¼‰è§£ææ–‡ç« ï¼Œåœ¨å‡ ç§’å†…ï¼Œå³å¯åˆ©ç”¨é“ä¸½çš„ä¸»é¢˜ç”Ÿæˆé™æ€ç½‘é¡µã€‚ä¸€ä¸ªå‘½ä»¤å³å¯éƒ¨ç½²åˆ° Githubé¡µé¢ã€ Giteeeã€ Herokuç­‰å¹³å°ï¼Œå¼ºå¤§çš„APl,å¯æ— é™æ‰©å±•,æ‹¥æœ‰æ•°ç™¾ä¸ªä¸»é¢˜å’Œæ’ä»¶ä¾›ç”¨æˆ·è‡ªä¸»å®‰è£… </p><blockquote><p><a href="https://hexo.io/zh-cn/docs/">hexoå®˜æ–¹æ–‡æ¡£</a></p></blockquote><h3 id="å®‰è£…å‰æ"><a href="#å®‰è£…å‰æ" class="headerlink" title="å®‰è£…å‰æ"></a>å®‰è£…å‰æ</h3><h4 id="å®‰è£…Node-js"><a href="#å®‰è£…Node-js" class="headerlink" title="å®‰è£…Node.js"></a>å®‰è£…Node.js</h4><blockquote><p>(Node.js ç‰ˆæœ¬éœ€ä¸ä½äº 10.13ï¼Œå»ºè®®ä½¿ç”¨ Node.js 12.0 åŠä»¥ä¸Šç‰ˆæœ¬</p></blockquote><p>Node.js ä¸ºå¤§å¤šæ•°å¹³å°æä¾›äº†å®˜æ–¹çš„ <a href="https://nodejs.org/en/download/">å®‰è£…ç¨‹åº</a>ã€‚å¯¹äºå›½å†…ç”¨æˆ·ï¼Œå¯ä»¥å‰å¾€ <a href="https://npm.taobao.org/mirrors/node">æ·˜å® Node.js é•œåƒ</a> ä¸‹è½½ </p><ul><li>Windowsï¼šé€šè¿‡ <a href="https://github.com/jasongin/nvs/">nvs</a>ï¼ˆæ¨èï¼‰æˆ–è€… <a href="https://github.com/nvm-sh/nvm">nvm</a> å®‰è£…ã€‚</li><li>Macï¼šä½¿ç”¨ <a href="https://brew.sh/">Homebrew</a> æˆ– <a href="http://www.macports.org/">MacPorts</a> å®‰è£…ã€‚</li><li>Linuxï¼ˆDEB&#x2F;RPM-basedï¼‰ï¼šä» <a href="https://github.com/nodesource/distributions">NodeSource</a> å®‰è£…ã€‚</li><li>å…¶å®ƒï¼šä½¿ç”¨ç›¸åº”çš„è½¯ä»¶åŒ…ç®¡ç†å™¨è¿›è¡Œå®‰è£…ï¼Œå¯ä»¥å‚è€ƒç”± Node.js æä¾›çš„ <a href="https://nodejs.org/en/download/package-manager/">æŒ‡å¯¼</a>ã€‚</li></ul><h4 id="å®‰è£…Git"><a href="#å®‰è£…Git" class="headerlink" title="å®‰è£…Git"></a>å®‰è£…Git</h4><ul><li>Windowsï¼šä¸‹è½½å¹¶å®‰è£… <a href="https://git-scm.com/download/win">git</a>.</li><li>Macï¼šä½¿ç”¨ <a href="http://mxcl.github.com/homebrew/">Homebrew</a>, <a href="http://www.macports.org/">MacPorts</a> æˆ–è€…ä¸‹è½½ <a href="http://sourceforge.net/projects/git-osx-installer/">å®‰è£…ç¨‹åº</a>ã€‚</li><li>Linux (Ubuntu, Debian)ï¼š<code>sudo apt-get install git-core</code></li><li>Linux (Fedora, Red Hat, CentOS)ï¼š<code>sudo yum install git-core</code></li></ul><p>ä¹Ÿå¯ä»¥ä½¿ç”¨cnpm</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install -g cnpm --registry=https://registry.npm.taobao.org<br></code></pre></td></tr></table></figure><h3 id="å®‰è£…Hexo"><a href="#å®‰è£…Hexo" class="headerlink" title="å®‰è£…Hexo"></a>å®‰è£…Hexo</h3><p>ä»¥ä¸Šå®‰è£…å‰æçš„åº”ç”¨ç¨‹åºå®‰è£…å®Œæˆåï¼Œå°±å¯ä»¥ä½¿ç”¨npmè¿›è¡Œå®‰è£…</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install -g hexo-cli  #æˆ–è€…ï¼š cnpm install -g hexo-cli<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹æ˜¯å¦å®‰è£…æˆåŠŸå’Œå¯¹åº”å®‰è£…çš„ç‰ˆæœ¬</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo -v<br>#è‹¥æœ‰æ­£å¸¸ç‰ˆæœ¬è¾“å‡ºè¡¨ç¤ºå®‰è£…æˆåŠŸ<br></code></pre></td></tr></table></figure><h3 id="æ­å»ºåšå®¢ä¸»ç«™"><a href="#æ­å»ºåšå®¢ä¸»ç«™" class="headerlink" title="æ­å»ºåšå®¢ä¸»ç«™"></a>æ­å»ºåšå®¢ä¸»ç«™</h3><p>å®‰è£… Hexo å®Œæˆåï¼Œè¯·æ‰§è¡Œä¸‹åˆ—å‘½ä»¤ï¼ŒHexo å°†ä¼šåœ¨æŒ‡å®šæ–‡ä»¶å¤¹ä¸­æ–°å»ºæ‰€éœ€è¦çš„æ–‡ä»¶ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo init myblog<br></code></pre></td></tr></table></figure><p>åˆå§‹åŒ–å®Œåï¼Œåˆ‡æ¢åˆ°åšå®¢ä¸»ç›®å½•</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">cd  myblog<br>npm install   #æˆ–è€…cnpm install<br></code></pre></td></tr></table></figure><p>æŸ¥çœ‹å½“å‰ç›®å½•æ–‡ä»¶</p><blockquote><p>_config.landscape.yml<br>themes                   #ä¸»é¢˜æ–‡ä»¶å¤¹ã€‚Hexo ä¼šæ ¹æ®ä¸»é¢˜æ¥ç”Ÿæˆé™æ€é¡µé¢ã€‚<br>scaffolds                #æ¨¡ç‰ˆ æ–‡ä»¶å¤¹ã€‚å½“æ‚¨æ–°å»ºæ–‡ç« æ—¶ï¼ŒHexo ä¼šæ ¹æ® scaffold æ¥å»ºç«‹æ–‡ä»¶ã€‚<br>source                   # èµ„æºæ–‡ä»¶å¤¹æ˜¯å­˜æ”¾ç”¨æˆ·èµ„æºçš„åœ°æ–¹<br>public<br>package-lock.json<br>package.json             #åº”ç”¨ç¨‹åºä¿¡æ¯<br>_config.yml               #ç½‘ç«™é…ç½®ä¿¡æ¯ï¼Œåç»­ä¸»ç«™é…ç½®éœ€è¦åœ¨è¿™ä¸ªé…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹<br>db.json<br>node_modules<br>.deploy_git<br>.github</p></blockquote><h3 id="å¯åŠ¨æœåŠ¡ç«™ç‚¹"><a href="#å¯åŠ¨æœåŠ¡ç«™ç‚¹" class="headerlink" title="å¯åŠ¨æœåŠ¡ç«™ç‚¹"></a>å¯åŠ¨æœåŠ¡ç«™ç‚¹</h3><p>hexo ä¸‰æ¿æ–§å‘½ä»¤ å¯åŠ¨æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo cl    #å®Œæ•´å‘½ä»¤æ˜¯hexo clean   æ¸…ç†ç¼“å­˜æ–‡ä»¶<br>hexo g     #hexo generate    ç”¨äºç”Ÿæˆé™æ€æ–‡ä»¶<br>hexo s     #hexo server     å‘½ä»¤ç”¨äºå¯åŠ¨æœ¬åœ°æœåŠ¡<br></code></pre></td></tr></table></figure><p>æ­£å¸¸è¾“å‡ºè¡¨ç¤ºå¯åŠ¨æˆåŠŸ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">INFO  Validating config<br>INFO <br>  ===================================================================<br><br>      #####  #    # ##### ##### ###### #####  ###### #      #   #<br>      #    # #    #   #     #   #      #    # #      #       # #<br>      #####  #    #   #     #   #####  #    # #####  #        #<br>      #    # #    #   #     #   #      #####  #      #        #<br>      #    # #    #   #     #   #      #   #  #      #        #<br>      #####   ####    #     #   ###### #    # #      ######   #<br><br>                            4.4.0<br>  ===================================================================<br>INFO  Start processing<br>INFO  Hexo is running at http://localhost:4000/ . Press Ctrl+C to stop.<br><br></code></pre></td></tr></table></figure><p>ç„¶åé€šè¿‡  <a href="http://localhost:4000/">http://localhost:4000/</a>   å¯ä»¥æ­£å¸¸è®¿é—®ï¼ˆä½¿ç”¨çš„æ˜¯é»˜è®¤ä¸»é¢˜ï¼‰</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/1660970724356.png" alt="1660970724356"></p><h3 id="GitHubä¸Šå»ºç«™è®¿é—®"><a href="#GitHubä¸Šå»ºç«™è®¿é—®" class="headerlink" title="GitHubä¸Šå»ºç«™è®¿é—®"></a>GitHubä¸Šå»ºç«™è®¿é—®</h3><p>å°† Hexo åšå®¢éƒ¨ç½²åˆ° GitHub Pages ä¸Šï¼Œå¦‚æœè¿˜æ²¡æœ‰githubè´¦å·çš„ï¼Œéœ€è¦å…ˆå»æ³¨å†Œè´¦å·ï¼Œå…·ä½“å¦‚ä½•æ³¨å†Œï¼Œè¿™é‡Œå°±ä¸åšä»‹ç»äº†ï¼Œ</p><h4 id="æ–°å»ºgithubä»“åº“"><a href="#æ–°å»ºgithubä»“åº“" class="headerlink" title="æ–°å»ºgithubä»“åº“"></a>æ–°å»ºgithubä»“åº“</h4><p>ä»“åº“åç§°é™åˆ¶äº†ä¸ºä½ çš„ï¼šç”¨æˆ·å+.github.ioã€‚æˆ‘è¿™é‡Œä½¿ç”¨çš„æ˜¯æˆ‘è‡ªå·±ç”¨æˆ·å chen1900s</p><p><img src="https://chen1900s-1257020962.cos.ap-chongqing.myqcloud.com/my-blog/image/image-20220831181326723.png" alt="image-20220831181326723"></p><blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">git init<br>git add README.md<br>git commit -m &quot;first commit&quot;<br>git branch -M main<br>git remote add origin https://github.com/chen1900s/chen1900s.github.io.git<br>git push -u origin main<br>#å·²æœ‰ä»“åº“<br>git remote add origin https://github.com/chen1900s/chen1900s.github.io.git<br>git branch -M main<br>git push -u origin main<br></code></pre></td></tr></table></figure></blockquote><h4 id="æ¨é€ç«™ç‚¹åˆ°github"><a href="#æ¨é€ç«™ç‚¹åˆ°github" class="headerlink" title="æ¨é€ç«™ç‚¹åˆ°github"></a>æ¨é€ç«™ç‚¹åˆ°github</h4><p>1ï¼Œå®‰è£…hexoä¸Šä¼ æ’ä»¶</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">npm install hexo-deployer-git --save<br>æˆ–è€…<br>cnpm install hexo-deployer-git --save<br></code></pre></td></tr></table></figure><p>2ï¼Œä¿®æ”¹hexoé…ç½®æ–‡ä»¶æŒ‡å®šä»“åº“è·¯å¾„</p><p>å¯åœ¨hexoåšå®¢ä¸»ç›®å½•æ–‡ä»¶å¤¹ä¸­ç›´æ¥æ‰“å¼€æ–‡ä»¶ï¼Œä¹Ÿå¯é€šè¿‡vimç›´æ¥ç¼–è¾‘</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">vim _config.yml <br>#æ‰¾åˆ°<br>deploy:<br>  type: git<br>  repo: https://github.com/chen1900s/chen1900s.github.io.git<br>  branch: master <br></code></pre></td></tr></table></figure><p>3ï¼Œè¿è¡Œå‘½ä»¤ï¼ˆæ‰§è¡Œå‘½ä»¤æ—¶å€™éœ€è¦åœ¨åšå®¢ä¸»ç›®å½•æ‰§è¡Œï¼‰</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo clean &amp;&amp; hexo g &amp;&amp; hexo deploy`<br></code></pre></td></tr></table></figure><blockquote><p>éœ€è¦é…ç½®github sshå…¬ç§é’¥è®¿é—® </p></blockquote><h4 id="ä¸»ç«™è®¿é—®"><a href="#ä¸»ç«™è®¿é—®" class="headerlink" title="ä¸»ç«™è®¿é—®"></a>ä¸»ç«™è®¿é—®</h4><p>è¾“å…¥ä½ çš„ä»“åº“åç§°,å³å¯è®¿é—®æˆåŠŸã€‚</p><p>https:&#x2F;&#x2F; username.github.io  </p><h3 id="å®‰è£…ä¸»é¢˜"><a href="#å®‰è£…ä¸»é¢˜" class="headerlink" title="å®‰è£…ä¸»é¢˜"></a>å®‰è£…ä¸»é¢˜</h3><p>åˆ›å»º Hexo ä¸»é¢˜éå¸¸å®¹æ˜“ï¼Œæ‚¨åªè¦åœ¨ <code>themes</code> æ–‡ä»¶å¤¹å†…ï¼Œæ–°å¢ä¸€ä¸ªä»»æ„åç§°çš„æ–‡ä»¶å¤¹ï¼Œå¹¶ä¿®æ”¹ <code>_config.yml</code> å†…çš„ <code>theme</code> è®¾å®šï¼Œå³å¯åˆ‡æ¢ä¸»é¢˜ã€‚</p><p>åˆ°GitHubä¸Šæœç´¢hexoä¸»é¢˜æˆ–è€…heroè‡ªå¸¦çš„ä¸»é¢˜<a href="https://hexo.io/themes/%E3%80%82">https://hexo.io/themes/ã€‚</a></p><p>è¿™é‡Œæˆ‘é€‰æ‹©butterfly ä¸»é¢˜è¿›è¡Œé…ç½®</p><blockquote><p><a href="https://butterfly.js.org/">butterfly å®˜æ–¹ä¸»é¢˜</a></p></blockquote><p>æŒ‰ç…§å„è‡ªçš„ä¸»é¢˜æ–‡æ¡£ä¸Šé¢ä¸€æ­¥æ­¥æ“ä½œå³å¯ã€‚</p><p> ä¸€èˆ¬æ­¥éª¤ï¼š </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">1ã€ä¸‹è½½è§£å‹ä¸»é¢˜ æˆ–è€…ä½¿ç”¨å‘½ä»¤è¡Œ<br>2ã€æ”¾åˆ°ä¸»é¢˜åŒ…themesæ–‡ä»¶å¤¹ä¸‹é¢<br>3ã€åœ¨heroé…ç½®æ–‡ä»¶_config.ymlä¸­ä¿®æ”¹ä¸ºå–œæ¬¢ä¸»é¢˜çš„åå­—<br>4ã€hero serverå¯åŠ¨å³å¯è®¿é—®<br></code></pre></td></tr></table></figure><h4 id="å®‰è£…"><a href="#å®‰è£…" class="headerlink" title="å®‰è£…"></a>å®‰è£…</h4><p>åœ¨ä½ çš„<strong>Hexo æ ¹ç›®</strong>å½•é‡Œæ‰§è¡Œ</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">git clone -b master https://github.com/jerryc127/hexo-theme-butterfly.git themes/butterfly<br></code></pre></td></tr></table></figure><p>æˆ–è€…æ‰‹åŠ¨ä¸‹è½½ä¸‹æ¥ ä¸Šä¼ åˆ°åšå®¢æ ¹ç›®å½•</p><h4 id="åº”ç”¨ä¸»é¢˜"><a href="#åº”ç”¨ä¸»é¢˜" class="headerlink" title="åº”ç”¨ä¸»é¢˜"></a>åº”ç”¨ä¸»é¢˜</h4><p>ä¿®æ”¹ <strong>Hexo æ ¹ç›®å½•</strong>ä¸‹çš„ _config.ymlï¼ŒæŠŠä¸»é¢˜æ”¹ä¸ºbutterfly</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext"># Extensions<br>## Plugins: https://hexo.io/plugins/<br>## Themes: https://hexo.io/themes/<br>theme: butterfly     <br></code></pre></td></tr></table></figure><p>ä¿®æ”¹å®Œæˆåï¼Œé‡å¯æœåŠ¡</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#1ï¼Œæ¸…ç†<br>hexo clean<br>#2 æ„å»ºé™æ€æ–‡ä»¶<br>hexo g<br>#3ï¼Œä¸Šä¼ è‡³ä»“åº“<br>hexo deploy<br></code></pre></td></tr></table></figure><h4 id="åˆ›å»ºåšå®¢æ–‡ç« "><a href="#åˆ›å»ºåšå®¢æ–‡ç« " class="headerlink" title="åˆ›å»ºåšå®¢æ–‡ç« "></a>åˆ›å»ºåšå®¢æ–‡ç« </h4><p>åœ¨<strong>Hexoæ ¹ç›®å½•</strong>æ–‡ä»¶å¤¹ä¸­æ‰“å¼€ç»ˆç«¯ ï¼Œè¾“å…¥å¦‚ä¸‹å‘½ä»¤åˆ›å»ºæ–‡ç« ï¼Œhexoä¼šåœ¨sourceæ–‡ä»¶å¤¹ä¸‹åˆ›å»ºä¸€ä¸ªmarkdowmçš„æ–‡ä»¶ã€‚è¿™å°±æ˜¯ä½ è¦ç¼–å†™çš„æ–‡ç« ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo new â€œè¿™é‡Œå¡«å…¥æ–‡ç« çš„æ ‡é¢˜â€<br></code></pre></td></tr></table></figure><p> ç”¨è½¯ä»¶typoraæ‰“å¼€ç›´æ¥ç¼–å†™æ–‡ç«  ï¼Œ åœ¨ä¸Šä¼ æ›´æ–°åˆ°githubä¸Šç«‹é©¬èƒ½å¤ŸæŸ¥çœ‹åˆ°ã€‚ </p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">#1ï¼Œæ¸…ç†<br>hexo clean<br>#2 æ„å»ºé™æ€æ–‡ä»¶<br>hexo g<br>#3ï¼Œä¸Šä¼ è‡³ä»“åº“<br>hexo deploy<br></code></pre></td></tr></table></figure><p>è‰ç¨¿ç®±</p><blockquote><p>æœ‰æ—¶å€™æˆ‘ä»¬éœ€è¦å…ˆå†™æˆè‰ç¨¿ï¼Œè€Œæš‚æ—¶ä¸å‘å¸ƒå‡ºå»ã€‚draft pageå°±å¯ä»¥æ»¡è¶³æˆ‘ä»¬çš„è¦æ±‚ï¼Œæˆ‘ä»¬çš„ç½‘ç«™ä¸Šæ˜¯çœ‹ä¸åˆ°è‰ç¨¿æ–‡ä»¶çš„</p></blockquote><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">//æ–°å»ºè‰ç¨¿æ–‡ä»¶<br>hexo new draft b<br><br>//é¢„è§ˆè‰ç¨¿æ–‡ä»¶<br>hexo server --draft<br><br>//å‘å¸ƒè‰ç¨¿hexo publish <br></code></pre></td></tr></table></figure><h4 id="æ–°å»ºé¡µé¢"><a href="#æ–°å»ºé¡µé¢" class="headerlink" title="æ–°å»ºé¡µé¢"></a>æ–°å»ºé¡µé¢</h4><p>æœ‰æ—¶æˆ‘ä»¬ä¸æ»¡è¶³ä¸»é¢˜è‡ªç”±çš„ä¸€äº›é¡µé¢ï¼Œå¸Œæœ›è‡ªå·±æ·»åŠ ä¸€äº›æ ‡é¢˜é¡µé¢ã€‚</p><p>æˆ‘ä»¬å¯ä»¥æ–°å»ºé¡µé¢ï¼Œæ–°å»ºé¡µé¢åˆ™ä¼šåœ¨hexoçš„sourceä¸­æ–°å»ºè¯¥é¡µé¢æ–‡ä»¶å¹¶ç”Ÿæˆmdæ–‡ä»¶ï¼Œè¿™å°±æ˜¯ä½ è¦ç¼–è¾‘çš„åšå®¢é¡µäº†ã€‚</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">hexo new page &quot;resouces&quot;<br></code></pre></td></tr></table></figure><p>ç„¶åæ‰“å¼€ä¸»é¢˜çš„é…ç½®æ–‡ä»¶<code>_config.yml</code>ï¼Œåœ¨èœå•å±æ€§<code>menu</code>ä¸­çš„æ·»åŠ å¦‚ä¸‹ï¼ˆæ³¨æ„ä¸æ˜¯Hexoçš„é…ç½®æ–‡ä»¶ï¼‰</p><p>å°†é¡µé¢è·¯å¾„è”æ¥åˆ°é¡µé¢ä¸Šå»</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><code class="hljs plaintext">èœå•è‡ªå®šä¹‰åç§°ï¼š/ç”Ÿæˆçš„é¡µé¢åç§°<br></code></pre></td></tr></table></figure><p>å…·ä½“è§æˆ‘ä¸‹ä¸€ç¯‡æ–‡ç« çš„<a href="https://blog.chen1900s.cn/post/e56702c9.html">butterflyä¸»é¢˜ä¼˜åŒ–</a></p><p><strong>å†™åœ¨æœ€å</strong></p><p>æ„Ÿè°¢å ç”¨æ‚¨çš„æ—¶é—´é˜…è¯»ï¼Œå¦‚æœæœ‰ä¸å¯¹çš„åœ°æ–¹éšæ—¶åæ§½</p>]]></content>
      
      
      <categories>
          
          <category> Hexo </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Hexo </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
